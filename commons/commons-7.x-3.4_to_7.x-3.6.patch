diff --git a/CHANGELOG.txt b/CHANGELOG.txt
index 464f5ef..4a6bde4 100644
--- a/CHANGELOG.txt
+++ b/CHANGELOG.txt
@@ -1,4 +1,8 @@
 
+Drupal 7.24, 2013-11-20
+----------------------
+- Fixed security issues (multiple vulnerabilities), see SA-CORE-2013-003.
+
 Drupal 7.23, 2013-08-07
 -----------------------
 - Fixed a fatal error on PostgreSQL databases when updating the Taxonomy module
diff --git a/LICENSE.txt b/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/PATCHES.txt b/PATCHES.txt
index 3246094..8b1dbde 100644
--- a/PATCHES.txt
+++ b/PATCHES.txt
@@ -1,6 +1,4 @@
 The following patches have been applied to this project:
-- http://drupal.org/files/spark-install-1780598-5.patch
-- http://drupal.org/files/1074108-skip-profile-16-7.x-do-not-test.patch
 - http://drupal.org/files/install_profile_requirements_on_install.patch
 - http://drupal.org/files/drupal-7.x-allow_profile_change_sys_req-1772316-21.patch
 - http://drupal.org/files/1664602-1.patch
diff --git a/includes/bootstrap.inc b/includes/bootstrap.inc
index d27f8d1..0bd4bcc 100644
--- a/includes/bootstrap.inc
+++ b/includes/bootstrap.inc
@@ -8,7 +8,7 @@
 /**
  * The current system version.
  */
-define('VERSION', '7.23');
+define('VERSION', '7.24');
 
 /**
  * Core API compatibility.
@@ -1933,6 +1933,33 @@ function drupal_block_denied($ip) {
 }
 
 /**
+ * Returns a URL-safe, base64 encoded string of highly randomized bytes (over the full 8-bit range).
+ *
+ * @param $byte_count
+ *   The number of random bytes to fetch and base64 encode.
+ *
+ * @return string
+ *   The base64 encoded result will have a length of up to 4 * $byte_count.
+ */
+function drupal_random_key($byte_count = 32) {
+  return drupal_base64_encode(drupal_random_bytes($byte_count));
+}
+
+/**
+ * Returns a URL-safe, base64 encoded version of the supplied string.
+ *
+ * @param $string
+ *   The string to convert to base64.
+ *
+ * @return string
+ */
+function drupal_base64_encode($string) {
+  $data = base64_encode($string);
+  // Modify the output so it's safe to use in URLs.
+  return strtr($data, array('+' => '-', '/' => '_', '=' => ''));
+}
+
+/**
  * Returns a string of highly randomized bytes (over the full 8-bit range).
  *
  * This function is better than simply calling mt_rand() or any other built-in
@@ -1945,38 +1972,34 @@ function drupal_block_denied($ip) {
  */
 function drupal_random_bytes($count)  {
   // $random_state does not use drupal_static as it stores random bytes.
-  static $random_state, $bytes, $php_compatible;
-  // Initialize on the first call. The contents of $_SERVER includes a mix of
-  // user-specific and system information that varies a little with each page.
-  if (!isset($random_state)) {
-    $random_state = print_r($_SERVER, TRUE);
-    if (function_exists('getmypid')) {
-      // Further initialize with the somewhat random PHP process ID.
-      $random_state .= getmypid();
-    }
-    $bytes = '';
-  }
-  if (strlen($bytes) < $count) {
+  static $random_state, $bytes, $has_openssl;
+
+  $missing_bytes = $count - strlen($bytes);
+
+  if ($missing_bytes > 0) {
     // PHP versions prior 5.3.4 experienced openssl_random_pseudo_bytes()
     // locking on Windows and rendered it unusable.
-    if (!isset($php_compatible)) {
-      $php_compatible = version_compare(PHP_VERSION, '5.3.4', '>=');
+    if (!isset($has_openssl)) {
+      $has_openssl = version_compare(PHP_VERSION, '5.3.4', '>=') && function_exists('openssl_random_pseudo_bytes');
     }
-    // /dev/urandom is available on many *nix systems and is considered the
-    // best commonly available pseudo-random source.
-    if ($fh = @fopen('/dev/urandom', 'rb')) {
+
+    // openssl_random_pseudo_bytes() will find entropy in a system-dependent
+    // way.
+    if ($has_openssl) {
+      $bytes .= openssl_random_pseudo_bytes($missing_bytes);
+    }
+
+    // Else, read directly from /dev/urandom, which is available on many *nix
+    // systems and is considered cryptographically secure.
+    elseif ($fh = @fopen('/dev/urandom', 'rb')) {
       // PHP only performs buffered reads, so in reality it will always read
       // at least 4096 bytes. Thus, it costs nothing extra to read and store
       // that much so as to speed any additional invocations.
-      $bytes .= fread($fh, max(4096, $count));
+      $bytes .= fread($fh, max(4096, $missing_bytes));
       fclose($fh);
     }
-    // openssl_random_pseudo_bytes() will find entropy in a system-dependent
-    // way.
-    elseif ($php_compatible && function_exists('openssl_random_pseudo_bytes')) {
-      $bytes .= openssl_random_pseudo_bytes($count - strlen($bytes));
-    }
-    // If /dev/urandom is not available or returns no bytes, this loop will
+
+    // If we couldn't get enough entropy, this simple hash-based PRNG will
     // generate a good set of pseudo-random bytes on any system.
     // Note that it may be important that our $random_state is passed
     // through hash() prior to being rolled into $output, that the two hash()
@@ -1984,9 +2007,23 @@ function drupal_random_bytes($count)  {
     // the microtime() - is prepended rather than appended. This is to avoid
     // directly leaking $random_state via the $output stream, which could
     // allow for trivial prediction of further "random" numbers.
-    while (strlen($bytes) < $count) {
-      $random_state = hash('sha256', microtime() . mt_rand() . $random_state);
-      $bytes .= hash('sha256', mt_rand() . $random_state, TRUE);
+    if (strlen($bytes) < $count) {
+      // Initialize on the first call. The contents of $_SERVER includes a mix of
+      // user-specific and system information that varies a little with each page.
+      if (!isset($random_state)) {
+        $random_state = print_r($_SERVER, TRUE);
+        if (function_exists('getmypid')) {
+          // Further initialize with the somewhat random PHP process ID.
+          $random_state .= getmypid();
+        }
+        $bytes = '';
+      }
+
+      do {
+        $random_state = hash('sha256', microtime() . mt_rand() . $random_state);
+        $bytes .= hash('sha256', mt_rand() . $random_state, TRUE);
+      }
+      while (strlen($bytes) < $count);
     }
   }
   $output = substr($bytes, 0, $count);
@@ -1997,17 +2034,21 @@ function drupal_random_bytes($count)  {
 /**
  * Calculates a base-64 encoded, URL-safe sha-256 hmac.
  *
- * @param $data
+ * @param string $data
  *   String to be validated with the hmac.
- * @param $key
+ * @param string $key
  *   A secret string key.
  *
- * @return
+ * @return string
  *   A base-64 encoded sha-256 hmac, with + replaced with -, / with _ and
  *   any = padding characters removed.
  */
 function drupal_hmac_base64($data, $key) {
-  $hmac = base64_encode(hash_hmac('sha256', $data, $key, TRUE));
+  // Casting $data and $key to strings here is necessary to avoid empty string
+  // results of the hash function if they are not scalar values. As this
+  // function is used in security-critical contexts like token validation it is
+  // important that it never returns an empty string.
+  $hmac = base64_encode(hash_hmac('sha256', (string) $data, (string) $key, TRUE));
   // Modify the hmac so it's safe to use in URLs.
   return strtr($hmac, array('+' => '-', '/' => '_', '=' => ''));
 }
diff --git a/includes/common.inc b/includes/common.inc
index 3d8ef4a..ae07202 100644
--- a/includes/common.inc
+++ b/includes/common.inc
@@ -5045,7 +5045,7 @@ function drupal_json_output($var = NULL) {
  */
 function drupal_get_private_key() {
   if (!($key = variable_get('drupal_private_key', 0))) {
-    $key = drupal_hash_base64(drupal_random_bytes(55));
+    $key = drupal_random_key();
     variable_set('drupal_private_key', $key);
   }
   return $key;
@@ -5084,7 +5084,7 @@ function drupal_get_token($value = '') {
  */
 function drupal_valid_token($token, $value = '', $skip_anonymous = FALSE) {
   global $user;
-  return (($skip_anonymous && $user->uid == 0) || ($token == drupal_get_token($value)));
+  return (($skip_anonymous && $user->uid == 0) || ($token === drupal_get_token($value)));
 }
 
 function _drupal_bootstrap_full() {
@@ -5117,6 +5117,10 @@ function _drupal_bootstrap_full() {
   module_load_all();
   // Make sure all stream wrappers are registered.
   file_get_stream_wrappers();
+  // Ensure mt_rand is reseeded, to prevent random values from one page load
+  // being exploited to predict random values in subsequent page loads.
+  $seed = unpack("L", drupal_random_bytes(4));
+  mt_srand($seed[1]);
 
   $test_info = &$GLOBALS['drupal_test_info'];
   if (!empty($test_info['in_child_site'])) {
diff --git a/includes/file.inc b/includes/file.inc
index 06657cf..d52d029 100644
--- a/includes/file.inc
+++ b/includes/file.inc
@@ -470,8 +470,11 @@ function file_ensure_htaccess() {
  * @param $private
  *   FALSE indicates that $directory should be an open and public directory.
  *   The default is TRUE which indicates a private and protected directory.
+ * @param $force_overwrite
+ *   Set to TRUE to attempt to overwrite the existing .htaccess file if one is
+ *   already present. Defaults to FALSE.
  */
-function file_create_htaccess($directory, $private = TRUE) {
+function file_create_htaccess($directory, $private = TRUE, $force_overwrite = FALSE) {
   if (file_uri_scheme($directory)) {
     $directory = file_stream_wrapper_uri_normalize($directory);
   }
@@ -480,19 +483,12 @@ function file_create_htaccess($directory, $private = TRUE) {
   }
   $htaccess_path =  $directory . '/.htaccess';
 
-  if (file_exists($htaccess_path)) {
+  if (file_exists($htaccess_path) && !$force_overwrite) {
     // Short circuit if the .htaccess file already exists.
     return;
   }
 
-  if ($private) {
-    // Private .htaccess file.
-    $htaccess_lines = "SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nDeny from all\nOptions None\nOptions +FollowSymLinks";
-  }
-  else {
-    // Public .htaccess file.
-    $htaccess_lines = "SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nOptions None\nOptions +FollowSymLinks";
-  }
+  $htaccess_lines = file_htaccess_lines($private);
 
   // Write the .htaccess file.
   if (file_put_contents($htaccess_path, $htaccess_lines)) {
@@ -505,6 +501,45 @@ function file_create_htaccess($directory, $private = TRUE) {
 }
 
 /**
+ * Returns the standard .htaccess lines that Drupal writes to file directories.
+ *
+ * @param $private
+ *   (Optional) Set to FALSE to return the .htaccess lines for an open and
+ *   public directory. The default is TRUE, which returns the .htaccess lines
+ *   for a private and protected directory.
+ *
+ * @return
+ *   A string representing the desired contents of the .htaccess file.
+ *
+ * @see file_create_htaccess()
+ */
+function file_htaccess_lines($private = TRUE) {
+  $lines = <<<EOF
+# Turn off all options we don't need.
+Options None
+Options +FollowSymLinks
+
+# Set the catch-all handler to prevent scripts from being executed.
+SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
+<Files *>
+  # Override the handler again if we're run later in the evaluation list.
+  SetHandler Drupal_Security_Do_Not_Remove_See_SA_2013_003
+</Files>
+
+# If we know how to do it safely, disable the PHP engine entirely.
+<IfModule mod_php5.c>
+  php_flag engine off
+</IfModule>
+EOF;
+
+  if ($private) {
+    $lines = "Deny from all\n\n" . $lines;
+  }
+
+  return $lines;
+}
+
+/**
  * Loads file objects from the database.
  *
  * @param $fids
diff --git a/includes/form.inc b/includes/form.inc
index 8ca048a..fcfc796 100644
--- a/includes/form.inc
+++ b/includes/form.inc
@@ -462,7 +462,7 @@ function drupal_rebuild_form($form_id, &$form_state, $old_form = NULL) {
     $form['#build_id'] = $old_form['#build_id'];
   }
   else {
-    $form['#build_id'] = 'form-' . drupal_hash_base64(uniqid(mt_rand(), TRUE) . mt_rand());
+    $form['#build_id'] = 'form-' . drupal_random_key();
   }
 
   // #action defaults to request_uri(), but in case of Ajax and other partial
@@ -977,7 +977,7 @@ function drupal_prepare_form($form_id, &$form, &$form_state) {
   // @see drupal_build_form()
   // @see drupal_rebuild_form()
   if (!isset($form['#build_id'])) {
-    $form['#build_id'] = 'form-' . drupal_hash_base64(uniqid(mt_rand(), TRUE) . mt_rand());
+    $form['#build_id'] = 'form-' . drupal_random_key();
   }
   $form['form_build_id'] = array(
     '#type' => 'hidden',
@@ -1129,6 +1129,12 @@ function drupal_validate_form($form_id, &$form, &$form_state) {
 
       // Setting this error will cause the form to fail validation.
       form_set_error('form_token', t('The form has become outdated. Copy any unsaved work in the form below and then <a href="@link">reload this page</a>.', array('@link' => $url)));
+
+      // Stop here and don't run any further validation handlers, because they
+      // could invoke non-safe operations which opens the door for CSRF
+      // vulnerabilities.
+      $validated_forms[$form_id] = TRUE;
+      return;
     }
   }
 
diff --git a/includes/install.core.inc b/includes/install.core.inc
index a469de4..83f1873 100644
--- a/includes/install.core.inc
+++ b/includes/install.core.inc
@@ -766,6 +766,15 @@ function install_system_module(&$install_state) {
   // Install system.module.
   drupal_install_system();
 
+  // Call file_ensure_htaccess() to ensure that all of Drupal's standard
+  // directories (e.g., the public and private files directories) have
+  // appropriate .htaccess files. These directories will have already been
+  // created by this point in the installer, since Drupal creates them during
+  // the install_verify_requirements() task. Note that we cannot call
+  // file_ensure_htaccess() any earlier than this, since it relies on
+  // system.module in order to work.
+  file_ensure_htaccess();
+
   // Enable the user module so that sessions can be recorded during the
   // upcoming bootstrap step.
   module_enable(array('user'), FALSE);
@@ -981,7 +990,7 @@ function install_settings_form_submit($form, &$form_state) {
     'required' => TRUE,
   );
   $settings['drupal_hash_salt'] = array(
-    'value'    => drupal_hash_base64(drupal_random_bytes(55)),
+    'value'    => drupal_random_key(),
     'required' => TRUE,
   );
   drupal_rewrite_settings($settings);
@@ -1017,20 +1026,7 @@ function install_select_profile(&$install_state) {
   $install_state['profiles'] += install_find_profiles();
   if (empty($install_state['parameters']['profile'])) {
     // Try to find a profile.
-    $profiles = $install_state['profiles'];
-    foreach ($profiles as $key => $profile) {
-      $details = install_profile_info($profile->name);
-      // Remove hidden profiles (such as the testing profile, which only exists
-      // to speed up test runs) from the list. This prevents them from being
-      // displayed in the user interface, and also means that if there is only
-      // one non-hidden profile, _install_select_profile() will choose it
-      // automatically.
-      if (!empty($details['hidden'])) {
-        unset($profiles[$key]);
-      }
-    }
-    $profile = _install_select_profile($profiles);
-    $install_state['profiles'] = $profiles;
+    $profile = _install_select_profile($install_state['profiles']);
     if (empty($profile)) {
       // We still don't have a profile, so display a form for selecting one.
       // Only do this in the case of interactive installations, since this is
@@ -1126,6 +1122,11 @@ function install_select_profile_form($form, &$form_state, $profile_files) {
     include_once DRUPAL_ROOT . '/' . $profile->uri;
 
     $details = install_profile_info($profile->name);
+    // Don't show hidden profiles. This is used by to hide the testing profile,
+    // which only exists to speed up test runs.
+    if ($details['hidden'] === TRUE) {
+      continue;
+    }
     $profiles[$profile->name] = $details;
 
     // Determine the name of the profile; default to file name if defined name
diff --git a/includes/session.inc b/includes/session.inc
index 16727df..9589e06 100644
--- a/includes/session.inc
+++ b/includes/session.inc
@@ -263,10 +263,10 @@ function drupal_session_initialize() {
     // Less random sessions (which are much faster to generate) are used for
     // anonymous users than are generated in drupal_session_regenerate() when
     // a user becomes authenticated.
-    session_id(drupal_hash_base64(uniqid(mt_rand(), TRUE)));
+    session_id(drupal_random_key());
     if ($is_https && variable_get('https', FALSE)) {
       $insecure_session_name = substr(session_name(), 1);
-      $session_id = drupal_hash_base64(uniqid(mt_rand(), TRUE));
+      $session_id = drupal_random_key();
       $_COOKIE[$insecure_session_name] = $session_id;
     }
   }
@@ -360,7 +360,7 @@ function drupal_session_regenerate() {
       $old_insecure_session_id = $_COOKIE[$insecure_session_name];
     }
     $params = session_get_cookie_params();
-    $session_id = drupal_hash_base64(uniqid(mt_rand(), TRUE) . drupal_random_bytes(55));
+    $session_id = drupal_random_key();
     // If a session cookie lifetime is set, the session will expire
     // $params['lifetime'] seconds from the current request. If it is not set,
     // it will expire when the browser is closed.
@@ -372,7 +372,7 @@ function drupal_session_regenerate() {
   if (drupal_session_started()) {
     $old_session_id = session_id();
   }
-  session_id(drupal_hash_base64(uniqid(mt_rand(), TRUE) . drupal_random_bytes(55)));
+  session_id(drupal_random_key());
 
   if (isset($old_session_id)) {
     $params = session_get_cookie_params();
diff --git a/modules/aggregator/aggregator.info b/modules/aggregator/aggregator.info
index 1bc261b..37a1e08 100644
--- a/modules/aggregator/aggregator.info
+++ b/modules/aggregator/aggregator.info
@@ -7,8 +7,8 @@ files[] = aggregator.test
 configure = admin/config/services/aggregator/settings
 stylesheets[all][] = aggregator.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/aggregator/tests/aggregator_test.info b/modules/aggregator/tests/aggregator_test.info
index 40a9703..4bad7dd 100644
--- a/modules/aggregator/tests/aggregator_test.info
+++ b/modules/aggregator/tests/aggregator_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/block/block.info b/modules/block/block.info
index 08f7165..bb1204d 100644
--- a/modules/block/block.info
+++ b/modules/block/block.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = block.test
 configure = admin/structure/block
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/block/tests/block_test.info b/modules/block/tests/block_test.info
index ec20b09..38faae4 100644
--- a/modules/block/tests/block_test.info
+++ b/modules/block/tests/block_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/block/tests/themes/block_test_theme/block_test_theme.info b/modules/block/tests/themes/block_test_theme/block_test_theme.info
index 3a75480..0cc6d00 100644
--- a/modules/block/tests/themes/block_test_theme/block_test_theme.info
+++ b/modules/block/tests/themes/block_test_theme/block_test_theme.info
@@ -13,8 +13,8 @@ regions[footer] = Footer
 regions[highlighted] = Highlighted
 regions[help] = Help
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/blog/blog.info b/modules/blog/blog.info
index 6ef427a..26f01e4 100644
--- a/modules/blog/blog.info
+++ b/modules/blog/blog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = blog.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/book/book.info b/modules/book/book.info
index 45e3b2a..22b82b3 100644
--- a/modules/book/book.info
+++ b/modules/book/book.info
@@ -7,8 +7,8 @@ files[] = book.test
 configure = admin/content/book/settings
 stylesheets[all][] = book.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/color/color.info b/modules/color/color.info
index 6b393ea..c6050c1 100644
--- a/modules/color/color.info
+++ b/modules/color/color.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = color.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/color/color.module b/modules/color/color.module
index 53c54fb..5b441aa 100644
--- a/modules/color/color.module
+++ b/modules/color/color.module
@@ -240,6 +240,7 @@ function color_scheme_form($complete_form, &$form_state, $theme) {
       $form['palette'][$name] = array(
         '#type' => 'textfield',
         '#title' => check_plain($names[$name]),
+        '#value_callback' => 'color_palette_color_value',
         '#default_value' => $value,
         '#size' => 8,
       );
@@ -295,6 +296,52 @@ function theme_color_scheme_form($variables) {
 }
 
 /**
+ * Determines the value for a palette color field.
+ *
+ * @param $element
+ *   The form element whose value is being populated.
+ * @param $input
+ *   The incoming input to populate the form element. If this is FALSE,
+ *   the element's default value should be returned.
+ * @param $form_state
+ *   A keyed array containing the current state of the form.
+ *
+ * @return
+ *   The data that will appear in the $form_state['values'] collection for this
+ *   element. Return nothing to use the default.
+ */
+function color_palette_color_value($element, $input = FALSE, $form_state = array()) {
+  // If we suspect a possible cross-site request forgery attack, only accept
+  // hexadecimal CSS color strings from user input, to avoid problems when this
+  // value is used in the JavaScript preview.
+  if ($input !== FALSE) {
+    // Start with the provided value for this textfield, and validate that if
+    // necessary, falling back on the default value.
+    $value = form_type_textfield_value($element, $input, $form_state);
+    if (!$value || !isset($form_state['complete form']['#token']) || color_valid_hexadecimal_string($value) || drupal_valid_token($form_state['values']['form_token'], $form_state['complete form']['#token'])) {
+      return $value;
+    }
+    else {
+      return $element['#default_value'];
+    }
+  }
+}
+
+/**
+ * Determines if a hexadecimal CSS color string is valid.
+ *
+ * @param $color
+ *   The string to check.
+ *
+ * @return
+ *   TRUE if the string is a valid hexadecimal CSS color string, or FALSE if it
+ *   isn't.
+ */
+function color_valid_hexadecimal_string($color) {
+  return preg_match('/^#([a-f0-9]{3}){1,2}$/iD', $color);
+}
+
+/**
  * Form validation handler for color_scheme_form().
  *
  * @see color_scheme_form_submit()
@@ -302,7 +349,7 @@ function theme_color_scheme_form($variables) {
 function color_scheme_form_validate($form, &$form_state) {
   // Only accept hexadecimal CSS color strings to avoid XSS upon use.
   foreach ($form_state['values']['palette'] as $key => $color) {
-    if (!preg_match('/^#([a-f0-9]{3}){1,2}$/iD', $color)) {
+    if (!color_valid_hexadecimal_string($color)) {
       form_set_error('palette][' . $key, t('%name must be a valid hexadecimal CSS color value.', array('%name' => $form['color']['palette'][$key]['#title'])));
     }
   }
diff --git a/modules/comment/comment.info b/modules/comment/comment.info
index 09aff8a..73e2777 100644
--- a/modules/comment/comment.info
+++ b/modules/comment/comment.info
@@ -9,8 +9,8 @@ files[] = comment.test
 configure = admin/content/comment
 stylesheets[all][] = comment.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/contact/contact.info b/modules/contact/contact.info
index 2f7b3db..fef2810 100644
--- a/modules/contact/contact.info
+++ b/modules/contact/contact.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = contact.test
 configure = admin/structure/contact
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/contextual/contextual.info b/modules/contextual/contextual.info
index e9cf706..2d5cdc6 100644
--- a/modules/contextual/contextual.info
+++ b/modules/contextual/contextual.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = contextual.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/dashboard/dashboard.info b/modules/dashboard/dashboard.info
index c2a04a7..7a38102 100644
--- a/modules/dashboard/dashboard.info
+++ b/modules/dashboard/dashboard.info
@@ -7,8 +7,8 @@ files[] = dashboard.test
 dependencies[] = block
 configure = admin/dashboard/customize
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/dblog/dblog.info b/modules/dblog/dblog.info
index 760af5b..8172624 100644
--- a/modules/dblog/dblog.info
+++ b/modules/dblog/dblog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = dblog.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/field.info b/modules/field/field.info
index fc9c319..97a6605 100644
--- a/modules/field/field.info
+++ b/modules/field/field.info
@@ -11,8 +11,8 @@ dependencies[] = field_sql_storage
 required = TRUE
 stylesheets[all][] = theme/field.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/field_sql_storage/field_sql_storage.info b/modules/field/modules/field_sql_storage/field_sql_storage.info
index 3f73a1b..31892cc 100644
--- a/modules/field/modules/field_sql_storage/field_sql_storage.info
+++ b/modules/field/modules/field_sql_storage/field_sql_storage.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = field_sql_storage.test
 required = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/list/list.info b/modules/field/modules/list/list.info
index 24dfc98..b42c6ff 100644
--- a/modules/field/modules/list/list.info
+++ b/modules/field/modules/list/list.info
@@ -7,8 +7,8 @@ dependencies[] = field
 dependencies[] = options
 files[] = tests/list.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/list/tests/list_test.info b/modules/field/modules/list/tests/list_test.info
index ff08ef9..ee71205 100644
--- a/modules/field/modules/list/tests/list_test.info
+++ b/modules/field/modules/list/tests/list_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/number/number.info b/modules/field/modules/number/number.info
index 69fd1ac..71ddf92 100644
--- a/modules/field/modules/number/number.info
+++ b/modules/field/modules/number/number.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = number.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/options/options.info b/modules/field/modules/options/options.info
index 5afe004..4d34455 100644
--- a/modules/field/modules/options/options.info
+++ b/modules/field/modules/options/options.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = options.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/modules/text/text.info b/modules/field/modules/text/text.info
index f3a6ae6..0e3fa80 100644
--- a/modules/field/modules/text/text.info
+++ b/modules/field/modules/text/text.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = text.test
 required = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field/tests/field_test.info b/modules/field/tests/field_test.info
index 385a053..c46994b 100644
--- a/modules/field/tests/field_test.info
+++ b/modules/field/tests/field_test.info
@@ -6,8 +6,8 @@ files[] = field_test.entity.inc
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/field_ui/field_ui.info b/modules/field_ui/field_ui.info
index 0b32314..524599d 100644
--- a/modules/field_ui/field_ui.info
+++ b/modules/field_ui/field_ui.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = field_ui.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/file/file.info b/modules/file/file.info
index 972c15d..e0ca202 100644
--- a/modules/file/file.info
+++ b/modules/file/file.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = tests/file.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/file/tests/file_module_test.info b/modules/file/tests/file_module_test.info
index a13b627..2c6b502 100644
--- a/modules/file/tests/file_module_test.info
+++ b/modules/file/tests/file_module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/filter/filter.info b/modules/filter/filter.info
index c939082..80fe66a 100644
--- a/modules/filter/filter.info
+++ b/modules/filter/filter.info
@@ -7,8 +7,8 @@ files[] = filter.test
 required = TRUE
 configure = admin/config/content/formats
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/forum/forum.info b/modules/forum/forum.info
index 57ea943..e6dc50a 100644
--- a/modules/forum/forum.info
+++ b/modules/forum/forum.info
@@ -9,8 +9,8 @@ files[] = forum.test
 configure = admin/structure/forum
 stylesheets[all][] = forum.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/help/help.info b/modules/help/help.info
index 2b51edc..cc3b8da 100644
--- a/modules/help/help.info
+++ b/modules/help/help.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = help.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/image/image.field.inc b/modules/image/image.field.inc
index 2354738..6d1867c 100644
--- a/modules/image/image.field.inc
+++ b/modules/image/image.field.inc
@@ -351,7 +351,7 @@ function image_field_widget_form(&$form, &$form_state, $field, $instance, $langc
   if ($field['cardinality'] == 1) {
     // If there's only one field, return it as delta 0.
     if (empty($elements[0]['#default_value']['fid'])) {
-      $elements[0]['#description'] = theme('file_upload_help', array('description' => $instance['description'], 'upload_validators' => $elements[0]['#upload_validators']));
+      $elements[0]['#description'] = theme('file_upload_help', array('description' => field_filter_xss($instance['description']), 'upload_validators' => $elements[0]['#upload_validators']));
     }
   }
   else {
diff --git a/modules/image/image.info b/modules/image/image.info
index 9a45ade..6ee725a 100644
--- a/modules/image/image.info
+++ b/modules/image/image.info
@@ -7,8 +7,8 @@ dependencies[] = file
 files[] = image.test
 configure = admin/config/media/image-styles
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/image/tests/image_module_test.info b/modules/image/tests/image_module_test.info
index 1616678..0f7c9f7 100644
--- a/modules/image/tests/image_module_test.info
+++ b/modules/image/tests/image_module_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = image_module_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/locale/locale.info b/modules/locale/locale.info
index bc59c28..451cf1f 100644
--- a/modules/locale/locale.info
+++ b/modules/locale/locale.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = locale.test
 configure = admin/config/regional/language
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/locale/tests/locale_test.info b/modules/locale/tests/locale_test.info
index 21ce383..e631931 100644
--- a/modules/locale/tests/locale_test.info
+++ b/modules/locale/tests/locale_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/menu/menu.info b/modules/menu/menu.info
index d85c5e5..69a1079 100644
--- a/modules/menu/menu.info
+++ b/modules/menu/menu.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = menu.test
 configure = admin/structure/menu
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/node/node.info b/modules/node/node.info
index fb92c29..157c80a 100644
--- a/modules/node/node.info
+++ b/modules/node/node.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/structure/types
 stylesheets[all][] = node.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/node/tests/node_access_test.info b/modules/node/tests/node_access_test.info
index 371cb9f..2e5247c 100644
--- a/modules/node/tests/node_access_test.info
+++ b/modules/node/tests/node_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/node/tests/node_test.info b/modules/node/tests/node_test.info
index 043e28a..861ba56 100644
--- a/modules/node/tests/node_test.info
+++ b/modules/node/tests/node_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/node/tests/node_test_exception.info b/modules/node/tests/node_test_exception.info
index 3d789ff..edaff90 100644
--- a/modules/node/tests/node_test_exception.info
+++ b/modules/node/tests/node_test_exception.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/openid/openid.inc b/modules/openid/openid.inc
index 74a08d5..d7ef663 100644
--- a/modules/openid/openid.inc
+++ b/modules/openid/openid.inc
@@ -380,6 +380,9 @@ function _openid_parse_message($message) {
 
 /**
  * Return a nonce value - formatted per OpenID spec.
+ *
+ * NOTE: This nonce is not cryptographically secure and only suitable for use
+ * by the test framework.
  */
 function _openid_nonce() {
   // YYYY-MM-DDThh:mm:ssZ, plus some optional extra unique characters.
@@ -549,7 +552,7 @@ function _openid_dh_rand($stop) {
   }
 
   do {
-    $bytes = "\x00" . _openid_get_bytes($nbytes);
+    $bytes = "\x00" . drupal_random_bytes($nbytes);
     $n = _openid_dh_binary_to_long($bytes);
     // Keep looping if this value is in the low duplicated range.
   } while (_openid_math_cmp($n, $duplicate) < 0);
@@ -558,23 +561,7 @@ function _openid_dh_rand($stop) {
 }
 
 function _openid_get_bytes($num_bytes) {
-  $f = &drupal_static(__FUNCTION__);
-  $bytes = '';
-  if (!isset($f)) {
-    $f = @fopen(OPENID_RAND_SOURCE, "r");
-  }
-  if (!$f) {
-    // pseudorandom used
-    $bytes = '';
-    for ($i = 0; $i < $num_bytes; $i += 4) {
-      $bytes .= pack('L', mt_rand());
-    }
-    $bytes = substr($bytes, 0, $num_bytes);
-  }
-  else {
-    $bytes = fread($f, $num_bytes);
-  }
-  return $bytes;
+  return drupal_random_bytes($num_bytes);
 }
 
 function _openid_response($str = NULL) {
diff --git a/modules/openid/openid.info b/modules/openid/openid.info
index a193e81..a755594 100644
--- a/modules/openid/openid.info
+++ b/modules/openid/openid.info
@@ -5,8 +5,8 @@ package = Core
 core = 7.x
 files[] = openid.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/openid/openid.test b/modules/openid/openid.test
index 292c531..41af3f8 100644
--- a/modules/openid/openid.test
+++ b/modules/openid/openid.test
@@ -695,13 +695,6 @@ class OpenIDTestCase extends DrupalWebTestCase {
   }
 
   /**
-   * Test _openid_get_bytes().
-   */
-  function testOpenidGetBytes() {
-    $this->assertEqual(strlen(_openid_get_bytes(20)), 20, '_openid_get_bytes() returned expected result.');
-  }
-
-  /**
    * Test _openid_signature().
    */
   function testOpenidSignature() {
diff --git a/modules/openid/tests/openid_test.info b/modules/openid/tests/openid_test.info
index a55e2b9..35e163c 100644
--- a/modules/openid/tests/openid_test.info
+++ b/modules/openid/tests/openid_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = openid
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/openid/tests/openid_test.install b/modules/openid/tests/openid_test.install
index 3bd4978..d30e2dc 100644
--- a/modules/openid/tests/openid_test.install
+++ b/modules/openid/tests/openid_test.install
@@ -13,5 +13,5 @@ function openid_test_install() {
   // Generate a MAC key (Message Authentication Code) used for signing messages.
   // The variable is base64-encoded, because variables cannot contain non-UTF-8
   // data.
-  variable_set('openid_test_mac_key', base64_encode(_openid_get_bytes(20)));
+  variable_set('openid_test_mac_key', drupal_random_key(20));
 }
diff --git a/modules/overlay/overlay.info b/modules/overlay/overlay.info
index e5459e7..19cd669 100644
--- a/modules/overlay/overlay.info
+++ b/modules/overlay/overlay.info
@@ -4,8 +4,8 @@ package = Core
 version = VERSION
 core = 7.x
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/overlay/overlay.module b/modules/overlay/overlay.module
index 7281986..7b2fc93 100644
--- a/modules/overlay/overlay.module
+++ b/modules/overlay/overlay.module
@@ -146,6 +146,10 @@ function overlay_init() {
       // If this page shouldn't be rendered inside the overlay, redirect to the
       // parent.
       elseif (!path_is_admin($current_path)) {
+        // Prevent open redirects by ensuring the current path is not an absolute URL.
+        if (url_is_external($current_path)) {
+          $current_path = '<front>';
+        }
         overlay_close_dialog($current_path, array('query' => drupal_get_query_parameters(NULL, array('q', 'render'))));
       }
 
diff --git a/modules/path/path.info b/modules/path/path.info
index 7007fdf..49b45c8 100644
--- a/modules/path/path.info
+++ b/modules/path/path.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = path.test
 configure = admin/config/search/path
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/php/php.info b/modules/php/php.info
index 39de081..ffe2350 100644
--- a/modules/php/php.info
+++ b/modules/php/php.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = php.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/poll/poll.info b/modules/poll/poll.info
index 2087de0..38e2fd2 100644
--- a/modules/poll/poll.info
+++ b/modules/poll/poll.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = poll.test
 stylesheets[all][] = poll.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/profile/profile.info b/modules/profile/profile.info
index 5ee4deb..c3a4a20 100644
--- a/modules/profile/profile.info
+++ b/modules/profile/profile.info
@@ -11,8 +11,8 @@ configure = admin/config/people/profile
 ; See user_system_info_alter().
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/rdf/rdf.info b/modules/rdf/rdf.info
index 595a622..71c782b 100644
--- a/modules/rdf/rdf.info
+++ b/modules/rdf/rdf.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = rdf.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/rdf/tests/rdf_test.info b/modules/rdf/tests/rdf_test.info
index 2595178..d95d995 100644
--- a/modules/rdf/tests/rdf_test.info
+++ b/modules/rdf/tests/rdf_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/search/search.info b/modules/search/search.info
index 8541286..72278b8 100644
--- a/modules/search/search.info
+++ b/modules/search/search.info
@@ -8,8 +8,8 @@ files[] = search.test
 configure = admin/config/search/settings
 stylesheets[all][] = search.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/search/tests/search_embedded_form.info b/modules/search/tests/search_embedded_form.info
index c74d152..dcbba02 100644
--- a/modules/search/tests/search_embedded_form.info
+++ b/modules/search/tests/search_embedded_form.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/search/tests/search_extra_type.info b/modules/search/tests/search_extra_type.info
index 84502ba..7687b6d 100644
--- a/modules/search/tests/search_extra_type.info
+++ b/modules/search/tests/search_extra_type.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/shortcut/shortcut.info b/modules/shortcut/shortcut.info
index bea4570..d0d7550 100644
--- a/modules/shortcut/shortcut.info
+++ b/modules/shortcut/shortcut.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = shortcut.test
 configure = admin/config/user-interface/shortcut
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/simpletest.info b/modules/simpletest/simpletest.info
index a57d47b..9f10c1b 100644
--- a/modules/simpletest/simpletest.info
+++ b/modules/simpletest/simpletest.info
@@ -55,8 +55,8 @@ files[] = tests/upgrade/update.trigger.test
 files[] = tests/upgrade/update.field.test
 files[] = tests/upgrade/update.user.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/actions_loop_test.info b/modules/simpletest/tests/actions_loop_test.info
index 7e5a14e..e587560 100644
--- a/modules/simpletest/tests/actions_loop_test.info
+++ b/modules/simpletest/tests/actions_loop_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/ajax_forms_test.info b/modules/simpletest/tests/ajax_forms_test.info
index 5c0dfcf..6c4f2ad 100644
--- a/modules/simpletest/tests/ajax_forms_test.info
+++ b/modules/simpletest/tests/ajax_forms_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/ajax_test.info b/modules/simpletest/tests/ajax_test.info
index 696fb20..ca1adfe 100644
--- a/modules/simpletest/tests/ajax_test.info
+++ b/modules/simpletest/tests/ajax_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/batch_test.info b/modules/simpletest/tests/batch_test.info
index 1e46847..bd3160c 100644
--- a/modules/simpletest/tests/batch_test.info
+++ b/modules/simpletest/tests/batch_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/common_test.info b/modules/simpletest/tests/common_test.info
index b851cf0..19e95e1 100644
--- a/modules/simpletest/tests/common_test.info
+++ b/modules/simpletest/tests/common_test.info
@@ -7,8 +7,8 @@ stylesheets[all][] = common_test.css
 stylesheets[print][] = common_test.print.css
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/common_test_cron_helper.info b/modules/simpletest/tests/common_test_cron_helper.info
index 231942a..43b56ea 100644
--- a/modules/simpletest/tests/common_test_cron_helper.info
+++ b/modules/simpletest/tests/common_test_cron_helper.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/database_test.info b/modules/simpletest/tests/database_test.info
index 1e94047..30fb696 100644
--- a/modules/simpletest/tests/database_test.info
+++ b/modules/simpletest/tests/database_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index b1073de..ddf6552 100644
--- a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index 918f4d7..8d24111 100644
--- a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/entity_cache_test.info b/modules/simpletest/tests/entity_cache_test.info
index baa9dda..2cc81a9 100644
--- a/modules/simpletest/tests/entity_cache_test.info
+++ b/modules/simpletest/tests/entity_cache_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = entity_cache_test_dependency
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/entity_cache_test_dependency.info b/modules/simpletest/tests/entity_cache_test_dependency.info
index fac49ea..dbb2de9 100644
--- a/modules/simpletest/tests/entity_cache_test_dependency.info
+++ b/modules/simpletest/tests/entity_cache_test_dependency.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/entity_crud_hook_test.info b/modules/simpletest/tests/entity_crud_hook_test.info
index f4aed27..1003e09 100644
--- a/modules/simpletest/tests/entity_crud_hook_test.info
+++ b/modules/simpletest/tests/entity_crud_hook_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/entity_query_access_test.info b/modules/simpletest/tests/entity_query_access_test.info
index 0e4316a..d9fd67f 100644
--- a/modules/simpletest/tests/entity_query_access_test.info
+++ b/modules/simpletest/tests/entity_query_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/error_test.info b/modules/simpletest/tests/error_test.info
index 86fb367..bd7f2ae 100644
--- a/modules/simpletest/tests/error_test.info
+++ b/modules/simpletest/tests/error_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/file.test b/modules/simpletest/tests/file.test
index 0f2cdb6..7802be3 100644
--- a/modules/simpletest/tests/file.test
+++ b/modules/simpletest/tests/file.test
@@ -952,7 +952,7 @@ class FileDirectoryTest extends FileTestCase {
     $this->assertTrue(is_file(file_default_scheme() . '://.htaccess'), 'Successfully re-created the .htaccess file in the files directory.', 'File');
     // Verify contents of .htaccess file.
     $file = file_get_contents(file_default_scheme() . '://.htaccess');
-    $this->assertEqual($file, "SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nOptions None\nOptions +FollowSymLinks", 'The .htaccess file contains the proper content.', 'File');
+    $this->assertEqual($file, file_htaccess_lines(FALSE), 'The .htaccess file contains the proper content.', 'File');
   }
 
   /**
diff --git a/modules/simpletest/tests/file_test.info b/modules/simpletest/tests/file_test.info
index 50bc9db..b3bceb8 100644
--- a/modules/simpletest/tests/file_test.info
+++ b/modules/simpletest/tests/file_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = file_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/filter_test.info b/modules/simpletest/tests/filter_test.info
index ff3aaaf..cece0c7 100644
--- a/modules/simpletest/tests/filter_test.info
+++ b/modules/simpletest/tests/filter_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/form.test b/modules/simpletest/tests/form.test
index a1506cc..8b63be4 100644
--- a/modules/simpletest/tests/form.test
+++ b/modules/simpletest/tests/form.test
@@ -82,6 +82,10 @@ class FormsTestCase extends DrupalWebTestCase {
           $form_state['input'][$element] = $empty;
           $form_state['input']['form_id'] = $form_id;
           $form_state['method'] = 'post';
+
+          // The form token CSRF protection should not interfere with this test,
+          // so we bypass it by marking this test form as programmed.
+          $form_state['programmed'] = TRUE;
           drupal_prepare_form($form_id, $form, $form_state);
           drupal_process_form($form_id, $form, $form_state);
           $errors = form_get_errors();
@@ -614,6 +618,18 @@ class FormValidationTestCase extends DrupalWebTestCase {
     $this->drupalPost(NULL, array(), 'Save');
     $this->assertNoFieldByName('name', 'Form element was hidden.');
     $this->assertText('Name value: element_validate_access', 'Value for inaccessible form element exists.');
+
+    // Verify that #validate handlers don't run if the CSRF token is invalid.
+    $this->drupalLogin($this->drupalCreateUser());
+    $this->drupalGet('form-test/validate');
+    $edit = array(
+      'name' => 'validate',
+      'form_token' => 'invalid token'
+    );
+    $this->drupalPost(NULL, $edit, 'Save');
+    $this->assertNoFieldByName('name', '#value changed by #validate', 'Form element #value was not altered.');
+    $this->assertNoText('Name value: value changed by form_set_value() in #validate', 'Form element value in $form_state was not altered.');
+    $this->assertText('The form has become outdated. Copy any unsaved work in the form below');
   }
 
   /**
@@ -941,6 +957,10 @@ class FormsElementsTableSelectFunctionalTest extends DrupalWebTestCase {
     $form_state['input'] = $edit;
     $form_state['input']['form_id'] = $form_id;
 
+    // The form token CSRF protection should not interfere with this test,
+    // so we bypass it by marking this test form as programmed.
+    $form_state['programmed'] = TRUE;
+
     drupal_prepare_form($form_id, $form, $form_state);
 
     drupal_process_form($form_id, $form, $form_state);
diff --git a/modules/simpletest/tests/form_test.info b/modules/simpletest/tests/form_test.info
index 2cc6036..1ea65cb 100644
--- a/modules/simpletest/tests/form_test.info
+++ b/modules/simpletest/tests/form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/image_test.info b/modules/simpletest/tests/image_test.info
index 0ad875b..c38235a 100644
--- a/modules/simpletest/tests/image_test.info
+++ b/modules/simpletest/tests/image_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/menu_test.info b/modules/simpletest/tests/menu_test.info
index 4ca24fa..e145bba 100644
--- a/modules/simpletest/tests/menu_test.info
+++ b/modules/simpletest/tests/menu_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/module_test.info b/modules/simpletest/tests/module_test.info
index e1f1657..0372bb9 100644
--- a/modules/simpletest/tests/module_test.info
+++ b/modules/simpletest/tests/module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/path_test.info b/modules/simpletest/tests/path_test.info
index 71d20c3..50839fd 100644
--- a/modules/simpletest/tests/path_test.info
+++ b/modules/simpletest/tests/path_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/psr_0_test/psr_0_test.info b/modules/simpletest/tests/psr_0_test/psr_0_test.info
index b9acbf3..a7a3e2f 100644
--- a/modules/simpletest/tests/psr_0_test/psr_0_test.info
+++ b/modules/simpletest/tests/psr_0_test/psr_0_test.info
@@ -5,8 +5,8 @@ core = 7.x
 hidden = TRUE
 package = Testing
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/requirements1_test.info b/modules/simpletest/tests/requirements1_test.info
index 9a8929a..9958a60 100644
--- a/modules/simpletest/tests/requirements1_test.info
+++ b/modules/simpletest/tests/requirements1_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/requirements2_test.info b/modules/simpletest/tests/requirements2_test.info
index 3b3ecdd..8edaeed 100644
--- a/modules/simpletest/tests/requirements2_test.info
+++ b/modules/simpletest/tests/requirements2_test.info
@@ -7,8 +7,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/session_test.info b/modules/simpletest/tests/session_test.info
index d1985f9..9f96fe0 100644
--- a/modules/simpletest/tests/session_test.info
+++ b/modules/simpletest/tests/session_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_dependencies_test.info b/modules/simpletest/tests/system_dependencies_test.info
index d50da29..d04a26f 100644
--- a/modules/simpletest/tests/system_dependencies_test.info
+++ b/modules/simpletest/tests/system_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = _missing_dependency
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
index 01d8b9d..61fb245 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = system_incompatible_core_version_test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_test.info b/modules/simpletest/tests/system_incompatible_core_version_test.info
index 2d6c558..cee9e0a 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 5.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
index 64cde55..e2d5eb6 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
@@ -7,8 +7,8 @@ hidden = TRUE
 ; system_incompatible_module_version_test declares version 1.0
 dependencies[] = system_incompatible_module_version_test (>2.0)
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_test.info b/modules/simpletest/tests/system_incompatible_module_version_test.info
index 785f7a2..1d8b313 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_test.info
@@ -5,8 +5,8 @@ version = 1.0
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/system_test.info b/modules/simpletest/tests/system_test.info
index 103c012..0cc868c 100644
--- a/modules/simpletest/tests/system_test.info
+++ b/modules/simpletest/tests/system_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = system_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/taxonomy_test.info b/modules/simpletest/tests/taxonomy_test.info
index 4e82d2e..1aafbbf 100644
--- a/modules/simpletest/tests/taxonomy_test.info
+++ b/modules/simpletest/tests/taxonomy_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = taxonomy
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/theme_test.info b/modules/simpletest/tests/theme_test.info
index cb2761f..e575926 100644
--- a/modules/simpletest/tests/theme_test.info
+++ b/modules/simpletest/tests/theme_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
index 34160a0..0c445c6 100644
--- a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
+++ b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 settings[basetheme_only] = base theme value
 settings[subtheme_override] = base theme value
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
index 307f546..b65bef6 100644
--- a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
+++ b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 
 settings[subtheme_override] = subtheme value
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/themes/test_theme/test_theme.info b/modules/simpletest/tests/themes/test_theme/test_theme.info
index 1a9cae4..2187c73 100644
--- a/modules/simpletest/tests/themes/test_theme/test_theme.info
+++ b/modules/simpletest/tests/themes/test_theme/test_theme.info
@@ -17,8 +17,8 @@ stylesheets[all][] = system.base.css
 
 settings[theme_test_setting] = default value
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/update_script_test.info b/modules/simpletest/tests/update_script_test.info
index 3ba2c70..09417dd 100644
--- a/modules/simpletest/tests/update_script_test.info
+++ b/modules/simpletest/tests/update_script_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/update_test_1.info b/modules/simpletest/tests/update_test_1.info
index 978a07a..2fd308b 100644
--- a/modules/simpletest/tests/update_test_1.info
+++ b/modules/simpletest/tests/update_test_1.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/update_test_2.info b/modules/simpletest/tests/update_test_2.info
index 978a07a..2fd308b 100644
--- a/modules/simpletest/tests/update_test_2.info
+++ b/modules/simpletest/tests/update_test_2.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/update_test_3.info b/modules/simpletest/tests/update_test_3.info
index 978a07a..2fd308b 100644
--- a/modules/simpletest/tests/update_test_3.info
+++ b/modules/simpletest/tests/update_test_3.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/url_alter_test.info b/modules/simpletest/tests/url_alter_test.info
index 78b12d6..4d8f9f9 100644
--- a/modules/simpletest/tests/url_alter_test.info
+++ b/modules/simpletest/tests/url_alter_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/simpletest/tests/xmlrpc_test.info b/modules/simpletest/tests/xmlrpc_test.info
index 5c749c7..50b5226 100644
--- a/modules/simpletest/tests/xmlrpc_test.info
+++ b/modules/simpletest/tests/xmlrpc_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/statistics/statistics.info b/modules/statistics/statistics.info
index b3ca7c0..b635b0c 100644
--- a/modules/statistics/statistics.info
+++ b/modules/statistics/statistics.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = statistics.test
 configure = admin/config/system/statistics
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/syslog/syslog.info b/modules/syslog/syslog.info
index 542ec71..db0ac60 100644
--- a/modules/syslog/syslog.info
+++ b/modules/syslog/syslog.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = syslog.test
 configure = admin/config/development/logging
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/system/system.info b/modules/system/system.info
index eb9b96c..572c610 100644
--- a/modules/system/system.info
+++ b/modules/system/system.info
@@ -12,8 +12,8 @@ files[] = system.test
 required = TRUE
 configure = admin/config/system
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/system/system.install b/modules/system/system.install
index 7dd605d..39ef5ed 100644
--- a/modules/system/system.install
+++ b/modules/system/system.install
@@ -267,6 +267,39 @@ function system_requirements($phase) {
     $requirements['settings.php']['title'] = $t('Configuration file');
   }
 
+  // Test the contents of the .htaccess files.
+  if ($phase == 'runtime') {
+    // Try to write the .htaccess files first, to prevent false alarms in case
+    // (for example) the /tmp directory was wiped.
+    file_ensure_htaccess();
+    $htaccess_files['public://.htaccess'] = array(
+      'title' => $t('Public files directory'),
+      'directory' => variable_get('file_public_path', conf_path() . '/files'),
+    );
+    if ($private_files_directory = variable_get('file_private_path')) {
+      $htaccess_files['private://.htaccess'] = array(
+        'title' => $t('Private files directory'),
+        'directory' => $private_files_directory,
+      );
+    }
+    $htaccess_files['temporary://.htaccess'] = array(
+      'title' => $t('Temporary files directory'),
+      'directory' => variable_get('file_temporary_path', file_directory_temp()),
+    );
+    foreach ($htaccess_files as $htaccess_file => $info) {
+      // Check for the string which was added to the recommended .htaccess file
+      // in the latest security update.
+      if (!file_exists($htaccess_file) || !($contents = @file_get_contents($htaccess_file)) || strpos($contents, 'Drupal_Security_Do_Not_Remove_See_SA_2013_003') === FALSE) {
+        $requirements[$htaccess_file] = array(
+          'title' => $info['title'],
+          'value' => $t('Not fully protected'),
+          'severity' => REQUIREMENT_ERROR,
+          'description' => $t('See <a href="@url">@url</a> for information about the recommended .htaccess file which should be added to the %directory directory to help protect against arbitrary code execution.', array('@url' => 'http://drupal.org/SA-CORE-2013-003', '%directory' => $info['directory'])),
+        );
+      }
+    }
+  }
+
   // Report cron status.
   if ($phase == 'runtime') {
     // Cron warning threshold defaults to two days.
@@ -525,7 +558,7 @@ function system_install() {
     ->execute();
 
   // Populate the cron key variable.
-  $cron_key = drupal_hash_base64(drupal_random_bytes(55));
+  $cron_key = drupal_random_key();
   variable_set('cron_key', $cron_key);
 }
 
@@ -1752,7 +1785,7 @@ function system_update_7000() {
  * Generate a cron key and save it in the variables table.
  */
 function system_update_7001() {
-  variable_set('cron_key', drupal_hash_base64(drupal_random_bytes(55)));
+  variable_set('cron_key', drupal_random_key());
 }
 
 /**
diff --git a/modules/system/system.test b/modules/system/system.test
index 99e0cbe..f4fb047 100644
--- a/modules/system/system.test
+++ b/modules/system/system.test
@@ -2712,3 +2712,50 @@ class TokenScanTest extends DrupalWebTestCase {
   }
 }
 
+/**
+ * Test case for drupal_valid_token().
+ */
+class SystemValidTokenTest extends DrupalUnitTestCase {
+
+  /**
+   * Flag to indicate whether PHP error reportings should be asserted.
+   *
+   * @var bool
+   */
+  protected $assertErrors = TRUE;
+
+  public static function getInfo() {
+    return array(
+      'name' => 'Token validation',
+      'description' => 'Test the security token validation.',
+      'group' => 'System',
+    );
+  }
+
+  /**
+   * Tests invalid invocations of drupal_valid_token() that must return FALSE.
+   */
+  public function testTokenValidation() {
+    // The following checks will throw PHP notices, so we disable error
+    // assertions.
+    $this->assertErrors = FALSE;
+    $this->assertFalse(drupal_valid_token(NULL, new stdClass()), 'Token NULL, value object returns FALSE.');
+    $this->assertFalse(drupal_valid_token(0, array()), 'Token 0, value array returns FALSE.');
+    $this->assertFalse(drupal_valid_token('', array()), "Token '', value array returns FALSE.");
+    $this->assertFalse('' === drupal_get_token(array()), 'Token generation does not return an empty string on invalid parameters.');
+    $this->assertErrors = TRUE;
+
+    $this->assertFalse(drupal_valid_token(TRUE, 'foo'), 'Token TRUE, value foo returns FALSE.');
+    $this->assertFalse(drupal_valid_token(0, 'foo'), 'Token 0, value foo returns FALSE.');
+  }
+
+  /**
+   * Overrides DrupalTestCase::errorHandler().
+   */
+  public function errorHandler($severity, $message, $file = NULL, $line = NULL) {
+    if ($this->assertErrors) {
+      return parent::errorHandler($severity, $message, $file, $line);
+    }
+    return TRUE;
+  }
+}
diff --git a/modules/taxonomy/taxonomy.info b/modules/taxonomy/taxonomy.info
index 98c00eb..f30b8aa 100644
--- a/modules/taxonomy/taxonomy.info
+++ b/modules/taxonomy/taxonomy.info
@@ -8,8 +8,8 @@ files[] = taxonomy.module
 files[] = taxonomy.test
 configure = admin/structure/taxonomy
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/toolbar/toolbar.info b/modules/toolbar/toolbar.info
index 19d4ab7..570cf29 100644
--- a/modules/toolbar/toolbar.info
+++ b/modules/toolbar/toolbar.info
@@ -4,8 +4,8 @@ core = 7.x
 package = Core
 version = VERSION
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/tracker/tracker.info b/modules/tracker/tracker.info
index 7ee7d6f..25c170a 100644
--- a/modules/tracker/tracker.info
+++ b/modules/tracker/tracker.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = tracker.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/translation/tests/translation_test.info b/modules/translation/tests/translation_test.info
index f6cf50b..5ed1f22 100644
--- a/modules/translation/tests/translation_test.info
+++ b/modules/translation/tests/translation_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/translation/translation.info b/modules/translation/translation.info
index f70c24f..d154926 100644
--- a/modules/translation/translation.info
+++ b/modules/translation/translation.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = translation.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/trigger/tests/trigger_test.info b/modules/trigger/tests/trigger_test.info
index b3a13d2..63b01ab 100644
--- a/modules/trigger/tests/trigger_test.info
+++ b/modules/trigger/tests/trigger_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/trigger/trigger.info b/modules/trigger/trigger.info
index de8150e..6625df2 100644
--- a/modules/trigger/trigger.info
+++ b/modules/trigger/trigger.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = trigger.test
 configure = admin/structure/trigger
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/aaa_update_test.info b/modules/update/tests/aaa_update_test.info
index 0b9171c..b65a6fa 100644
--- a/modules/update/tests/aaa_update_test.info
+++ b/modules/update/tests/aaa_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/bbb_update_test.info b/modules/update/tests/bbb_update_test.info
index 2adf08c..7eb887c 100644
--- a/modules/update/tests/bbb_update_test.info
+++ b/modules/update/tests/bbb_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/ccc_update_test.info b/modules/update/tests/ccc_update_test.info
index 810ac61..b0a73ff 100644
--- a/modules/update/tests/ccc_update_test.info
+++ b/modules/update/tests/ccc_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
index 0401560..2ecf1ec 100644
--- a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
+++ b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
@@ -3,8 +3,8 @@ description = Test theme which acts as a base theme for other test subthemes.
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
index d6520f7..d61b487 100644
--- a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
+++ b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
@@ -4,8 +4,8 @@ core = 7.x
 base theme = update_test_basetheme
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/tests/update_test.info b/modules/update/tests/update_test.info
index d1fea4d..9387f62 100644
--- a/modules/update/tests/update_test.info
+++ b/modules/update/tests/update_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/update/update.info b/modules/update/update.info
index 251e7cd..4f62f5e 100644
--- a/modules/update/update.info
+++ b/modules/update/update.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = update.test
 configure = admin/reports/updates/settings
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/user/tests/user_form_test.info b/modules/user/tests/user_form_test.info
index 87c91d0..396c9da 100644
--- a/modules/user/tests/user_form_test.info
+++ b/modules/user/tests/user_form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/user/user.info b/modules/user/user.info
index 806a44b..7bad7de 100644
--- a/modules/user/user.info
+++ b/modules/user/user.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/config/people
 stylesheets[all][] = user.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/modules/user/user.module b/modules/user/user.module
index 5124207..7227a1e 100644
--- a/modules/user/user.module
+++ b/modules/user/user.module
@@ -717,10 +717,14 @@ function user_password($length = 10) {
 
   // Loop the number of times specified by $length.
   for ($i = 0; $i < $length; $i++) {
+    do {
+      // Find a secure random number within the range needed.
+      $index = ord(drupal_random_bytes(1));
+    } while ($index > $len);
 
     // Each iteration, pick a random character from the
     // allowable string and append it to the password:
-    $pass .= $allowable_characters[mt_rand(0, $len)];
+    $pass .= $allowable_characters[$index];
   }
 
   return $pass;
diff --git a/modules/user/user.pages.inc b/modules/user/user.pages.inc
index 4cdbc40..c14548c 100644
--- a/modules/user/user.pages.inc
+++ b/modules/user/user.pages.inc
@@ -137,7 +137,7 @@ function user_pass_reset($form, &$form_state, $uid, $timestamp, $hashed_pass, $a
           watchdog('user', 'User %name used one-time login link at time %timestamp.', array('%name' => $account->name, '%timestamp' => $timestamp));
           drupal_set_message(t('You have just used your one-time login link. It is no longer necessary to use this link to log in. Please change your password.'));
           // Let the user's password be changed without the current password check.
-          $token = drupal_hash_base64(drupal_random_bytes(55));
+          $token = drupal_random_key();
           $_SESSION['pass_reset_' . $user->uid] = $token;
           drupal_goto('user/' . $user->uid . '/edit', array('query' => array('pass-reset-token' => $token)));
         }
diff --git a/profiles/commons/.travis.yml b/profiles/commons/.travis.yml
index 230ccfb..fb946e7 100644
--- a/profiles/commons/.travis.yml
+++ b/profiles/commons/.travis.yml
@@ -8,7 +8,7 @@ php:
 
 notifications:
   email:
-    - marc.seeger@acquia.com
+    - commons-bulk@acquia.com
 
 branches:
   only:
@@ -35,7 +35,7 @@ before_install:
   - curl http://localhost:4444/wd/hub
   # For uploading error screenshots
   - "wget http://imgur.com/tools/imgurbash.sh -O $TRAVIS_BUILD_DIR/imgurbash.sh && chmod +x $TRAVIS_BUILD_DIR/imgurbash.sh"
-  
+
 before_script:
   # Grab drush
   - pear channel-discover pear.drush.org
@@ -49,7 +49,7 @@ before_script:
   - sudo a2enmod actions
   - sudo service apache2 restart
   # Install the composer packages for behat / ...
-  - composer --working-dir=tests/ install  
+  - composer --working-dir=tests/ install
 script:
   # Build distro from makefile
   - drush make build-commons.make --no-cache -y packaged
@@ -64,7 +64,7 @@ script:
   # Start running the tests
   - cd tests
   - bin/behat
-  
+
 after_failure:
   - ls -lash $TRAVIS_BUILD_DIR/fail*.png
   - $TRAVIS_BUILD_DIR/imgurbash.sh $TRAVIS_BUILD_DIR/fail*.png
diff --git a/profiles/commons/LICENSE.txt b/profiles/commons/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/build-commons-dev.make b/profiles/commons/build-commons-dev.make
deleted file mode 100644
index f2ed0c5..0000000
--- a/profiles/commons/build-commons-dev.make
+++ /dev/null
@@ -1,14 +0,0 @@
-api = 2
-core = 7.x
-
-; Include the definition of how to build Drupal core directly, including patches.
-includes[] = "drupal-org-core.make"
-
-; Download the Commons install profile and recursively build all its dependencies.
-projects[commons][type] = "profile"
-projects[commons][download][type] = "git"
-projects[commons][download][url] = "http://git.drupal.org/project/commons.git"
-projects[commons][download][branch] = "7.x-3.x"
-; Provide a -dev version of the Commons make file, stopgap for nightly development snapshot
-; https://drupal.org/node/1908812
-projects[commons][patch][] = "http://drupal.org/files/1908812-commons-make-dev-59.patch"
\ No newline at end of file
diff --git a/profiles/commons/commons.info b/profiles/commons/commons.info
index a268343..513ae18 100644
--- a/profiles/commons/commons.info
+++ b/profiles/commons/commons.info
@@ -1,11 +1,10 @@
 name = Commons
-project = commons
-distribution_name = "Drupal Commons"
 description = Ready-to-use solution for building communities.
 core = 7.x
-php_memory_limit = 128M
+distribution_name = "Drupal Commons"
+exclusive = TRUE
 
-; Core modules.
+; Install required core modules.
 dependencies[] = block
 dependencies[] = comment
 dependencies[] = dblog
@@ -18,11 +17,15 @@ dependencies[] = menu
 dependencies[] = number
 dependencies[] = options
 dependencies[] = path
+dependencies[] = rdf
 dependencies[] = search
 dependencies[] = shortcut
 dependencies[] = taxonomy
 
-; Contributed modules.
+; Install required contributed modules.
+; For Commons 3.6, media is included, but left disabled by default.
+; Uncomment if you wish to enable on install. Alternatively, enabling the
+; commons_media module post install will enable all of the media modules.
 dependencies[] = addressfield
 dependencies[] = addressfield_tokens
 dependencies[] = breakpoints
@@ -35,8 +38,11 @@ dependencies[] = entityreference
 dependencies[] = entitycache
 dependencies[] = edit_profile
 dependencies[] = features
+;dependencies[] = file_entity
 dependencies[] = flag
 dependencies[] = http_client
+;dependencies[] = media
+;dependencies[] = media_internet
 dependencies[] = menu_attributes
 dependencies[] = message
 dependencies[] = message_notify
@@ -44,11 +50,12 @@ dependencies[] = message_subscribe
 dependencies[] = metatag
 dependencies[] = module_filter
 dependencies[] = navbar
+;dependencies[] = oembed
 dependencies[] = og
 dependencies[] = panels
 dependencies[] = paranoia
 dependencies[] = pathauto
-dependencies[] = placeholder
+dependencies[] = elements
 dependencies[] = privatemsg
 dependencies[] = privatemsg_realname
 dependencies[] = quicktabs
@@ -58,6 +65,7 @@ dependencies[] = radioactivity
 dependencies[] = realname
 dependencies[] = redirect
 dependencies[] = rules
+dependencies[] = schemaorg
 dependencies[] = sharethis
 dependencies[] = strongarm
 dependencies[] = token
@@ -67,6 +75,8 @@ dependencies[] = views_ui
 dependencies[] = votingapi
 dependencies[] = advancedqueue
 dependencies[] = ckeditor
+
+; Install commons specific modules
 dependencies[] = commons_activity_streams
 dependencies[] = commons_bw
 dependencies[] = commons_events
@@ -79,6 +89,7 @@ dependencies[] = commons_follow_term
 dependencies[] = commons_follow_user
 dependencies[] = commons_follow_ui
 dependencies[] = commons_like
+;dependencies[] = commons_media
 dependencies[] = commons_search
 dependencies[] = commons_search_core
 dependencies[] = commons_groups
@@ -105,9 +116,12 @@ dependencies[] = commons_wysiwyg
 dependencies[] = commons_social_sharing
 dependencies[] = commons_trusted_contacts
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; System Requirements.
+php_memory_limit = 128M
+
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/commons.install b/profiles/commons/commons.install
index d9e3efe..bdcbf57 100644
--- a/profiles/commons/commons.install
+++ b/profiles/commons/commons.install
@@ -14,6 +14,7 @@ function commons_requirements($phase) {
   // Ensure translations don't break during installation.
   $t = get_t();
   if($phase == 'install') {
+
     // Test PHP minimum execution time
     $requirements['php_max_execution_time'] = array(
       'title' => $t('PHP Max Execution Time'),
@@ -25,6 +26,25 @@ function commons_requirements($phase) {
       $requirements['php_max_execution_time']['description'] = $t('Your PHP execution time is too low, please set it greater than or equal to %time seconds.', array('%time' => DRUPAL_MINIMUM_MAX_EXECUTION_TIME));
       $requirements['php_max_execution_time']['severity'] = REQUIREMENT_ERROR;
     }
+
+    if(ini_get('apc.shm_size') != NULL) {
+      // Check for apc.shm_size = 96mb
+      $requirements['apc_shm_size'] = array(
+        'title' => $t('APC shim size'),
+        'value' => ini_get('apc.shm_size'),
+      );
+
+      $shm_size = preg_split('/[a-zA-Z]/', ini_get('apc.shm_size'));
+      $shm_size = $shm_size[0];
+
+      // only check if APC var is being set somewhere (usually apc.ini).
+      // throw error if there is less than 96MB available
+      if ($shm_size && $shm_size < COMMONS_MINIMUM_APC_CACHE) {
+        $requirements['apc_shm_size']['description'] = $t('APC is installed but %shm_size is not enough APC cache to successfully install Drupal Commons.
+           Find your <em>apc.ini</em> file and change the <em>apc.shm_size</em> value to at least <em>96M</em>.', array('%shm_size' => COMMONS_MINIMUM_APC_CACHE . 'M'));
+        $requirements['apc_shm_size']['severity'] = REQUIREMENT_ERROR;
+      }
+    }
   }
   return $requirements;
 }
@@ -220,4 +240,24 @@ function commons_update_3108() {
   );
   features_revert($revert);
   return array();
-}
\ No newline at end of file
+}
+
+/**
+ * Replace the Placeholder module with the Elements module.
+ */
+function commons_update_3109() {
+  if (module_exists('placeholder')) {
+    module_disable(array('placeholder'));
+  }
+  module_enable(array('elements'));
+  return array();
+}
+
+/**
+ * Enable the File Entity, Media, Media Internet, oEmbed and Commons: Media modules.
+ */
+function commons_update_3110() {
+  $module_list = array('file_entity', 'media', 'media_internet', 'oembed', 'commons_media');
+  module_enable($module_list);
+  return array();
+}
diff --git a/profiles/commons/commons.profile b/profiles/commons/commons.profile
index 4e3f4cf..922272c 100644
--- a/profiles/commons/commons.profile
+++ b/profiles/commons/commons.profile
@@ -9,6 +9,11 @@
  */
 define('DRUPAL_MINIMUM_MAX_EXECUTION_TIME', 120);
 
+/*
+ * Define commons minimum APC cache required to operate.
+ */
+define('COMMONS_MINIMUM_APC_CACHE', 96);
+
 /**
  * Implements hook_admin_paths_alter().
  */
diff --git a/profiles/commons/drupal-org-core.make b/profiles/commons/drupal-org-core.make
index 570df35..52ba0df 100644
--- a/profiles/commons/drupal-org-core.make
+++ b/profiles/commons/drupal-org-core.make
@@ -3,17 +3,7 @@ core = 7.x
 
 ; Download Drupal core and apply core patches if needed.
 projects[drupal][type] = "core"
-projects[drupal][version] = "7.23"
-
-; Hide the profiles under /profiles, so Commons is the only one. This allows
-; the installation to start at the Language selection screen, bypassing a
-; baffling and silly choice, especially for non-native speakers.
-; http://drupal.org/node/1780598#comment-6480088
-projects[drupal][patch][] = http://drupal.org/files/spark-install-1780598-5.patch
-; This requires a core bug fix to not show the profile selection page when only
-; one profile is visible.
-; http://drupal.org/node/1074108#comment-6463662
-projects[drupal][patch][] = http://drupal.org/files/1074108-skip-profile-16-7.x-do-not-test.patch
+projects[drupal][version] = 7.24
 
 ; This patch allows install profile to list requirements on the install page
 ; http://drupal.org/node/1971072
diff --git a/profiles/commons/drupal-org.make b/profiles/commons/drupal-org.make
index 1d5f311..450332e 100644
--- a/profiles/commons/drupal-org.make
+++ b/profiles/commons/drupal-org.make
@@ -3,6 +3,10 @@ core = 7.x
 
 ; Contributed modules.
 
+projects[acquia_connector][type] = "module"
+projects[acquia_connector][subdir] = "contrib"
+projects[acquia_connector][version] = "2.12"
+
 projects[addressfield][type] = "module"
 projects[addressfield][subdir] = "contrib"
 projects[addressfield][version] = "1.0-beta4"
@@ -11,9 +15,12 @@ projects[addressfield_tokens][type] = "module"
 projects[addressfield_tokens][subdir] = "contrib"
 projects[addressfield_tokens][version] = "1.3"
 
-projects[acquia_connector][type] = "module"
-projects[acquia_connector][subdir] = "contrib"
-projects[acquia_connector][version] = "2.12"
+projects[admin_icons][type] = "module"
+projects[admin_icons][subdir] = "contrib"
+projects[admin_icons][download][type] = "git"
+projects[admin_icons][download][url] = "http://git.drupal.org/project/admin_icons.git"
+projects[admin_icons][download][branch] = "7.x-1.x"
+projects[admin_icons][download][revision] = "60d9f28801533fecc92216a60d444d89d80e7611"
 
 projects[advancedqueue][type] = "module"
 projects[advancedqueue][subdir] = "contrib"
@@ -21,7 +28,7 @@ projects[advancedqueue][version] = "1.0-alpha2"
 
 projects[apachesolr][type] = "module"
 projects[apachesolr][subdir] = "contrib"
-projects[apachesolr][version] = "1.4"
+projects[apachesolr][version] = "1.6"
 
 projects[apachesolr_og][type] = "module"
 projects[apachesolr_og][subdir] = "contrib"
@@ -41,7 +48,7 @@ projects[apachesolr_user][download][url] = "http://git.drupal.org/project/apache
 projects[apachesolr_user][download][branch] = "7.x-1.x"
 projects[apachesolr_user][download]revision] = "a86c5aebfceaf4a3fc53544762a36ca1b70809d5"
 
-; Check the user object before trying to display a result
+; Check the user object before trying to display a result.
 ; https://drupal.org/node/2077281#comment-7807937
 projects[apachesolr_user][patch][] = "http://drupal.org/files/2077281-apache-solr-user-check-3.patch"
 
@@ -79,7 +86,6 @@ projects[custom_search][download][revision] = "20144e64494c83a448067d587e59df5d7
 ; https://drupal.org/node/2012210
 projects[custom_search][patch][] = "http://drupal.org/files/commons_search_js_encode.patch"
 
-
 projects[date][type] = "module"
 projects[date][subdir] = "contrib"
 projects[date][version] = "2.6"
@@ -97,6 +103,11 @@ projects[diff][type] = "module"
 projects[diff][subdir] = "contrib"
 projects[diff][version] = "3.2"
 
+; Profile has no recommended release.
+projects[edit_profile][type] = "module"
+projects[edit_profile][subdir] = "contrib"
+projects[edit_profile][version] = "1.0-beta2"
+
 projects[email_registration][type] = "module"
 projects[email_registration][subdir] = "contrib"
 projects[email_registration][version] = "1.1"
@@ -107,10 +118,7 @@ projects[entity][version] = "1.2"
 
 projects[entitycache][type] = "module"
 projects[entitycache][subdir] = "contrib"
-projects[entitycache][download][type] = "git"
-projects[entitycache][download][url] = "http://git.drupal.org/project/entitycache.git"
-projects[entitycache][download][branch] = "7.x-1.x"
-projects[entitycache][download][revision] = "7e390b5"
+projects[entitycache][version] = "1.2"
 
 ; Fix core translation support.
 ; http://drupal.org/node/1349566#comment-7781063
@@ -118,27 +126,27 @@ projects[entitycache][patch][] = "http://drupal.org/files/add-translation-inform
 
 projects[entityreference][type] = "module"
 projects[entityreference][subdir] = "contrib"
-projects[entityreference][download][type] = "git"
-projects[entityreference][download][url] = "http://git.drupal.org/project/entityreference.git"
-projects[entityreference][download][branch] = "7.x-1.x"
-projects[entityreference][download][revision] = "1c176daef3e7483389cbebeb34784b3af6521f7f"
+projects[entityreference][version] = "1.1"
+
+projects[entityreference_prepopulate][type] = "module"
+projects[entityreference_prepopulate][subdir] = "contrib"
+projects[entityreference_prepopulate][version] = "1.3"
 
 projects[entity_translation][type] = "module"
 projects[entity_translation][subdir] = "contrib"
 projects[entity_translation][version] = "1.0-beta3"
 
-; Profile has no recommended release
-projects[edit_profile][type] = "module"
-projects[edit_profile][subdir] = "contrib"
-projects[edit_profile][version] = "1.0-beta2"
-
-projects[entityreference_prepopulate][type] = "module"
-projects[entityreference_prepopulate][subdir] = "contrib"
-projects[entityreference_prepopulate][version] = "1.3"
+projects[facetapi][type] = "module"
+projects[facetapi][subdir] = "contrib"
+projects[facetapi][version] = "1.3"
 
 projects[features][type] = "module"
 projects[features][subdir] = "contrib"
-projects[features][version] = "2.0-rc5"
+projects[features][version] = "2.0"
+
+projects[file_entity][type] = "module"
+projects[file_entity][subdir] = "contrib"
+projects[file_entity][version] = "2.0-alpha3"
 
 projects[flag][type] = "module"
 projects[flag][subdir] = "contrib"
@@ -156,10 +164,6 @@ projects[flag_abuse][type] = "module"
 projects[flag_abuse][subdir] = "contrib"
 projects[flag_abuse][version] = "2.0-alpha1"
 
-projects[redirect][type] = "module"
-projects[redirect][subdir] = "contrib"
-projects[redirect][version] = "1.0-rc1"
-
 projects[http_client][type] = "module"
 projects[http_client][subdir] = "contrib"
 projects[http_client][version] = "2.4"
@@ -175,13 +179,6 @@ projects[i18nviews][download][url] = "http://git.drupal.org/project/i18nviews.gi
 projects[i18nviews][download][branch] = "7.x-3.x"
 projects[i18nviews][download][revision] = "26bd52c"
 
-projects[admin_icons][type] = "module"
-projects[admin_icons][subdir] = "contrib"
-projects[admin_icons][download][type] = "git"
-projects[admin_icons][download][url] = "http://git.drupal.org/project/admin_icons.git"
-projects[admin_icons][download][branch] = "7.x-1.x"
-projects[admin_icons][download][revision] = "60d9f28801533fecc92216a60d444d89d80e7611"
-
 projects[kissmetrics][type] = "module"
 projects[kissmetrics][subdir] = "contrib"
 projects[kissmetrics][version] = "1.0-rc3"
@@ -196,11 +193,22 @@ projects[libraries][version] = "2.1"
 
 projects[lingotek][type] = "module"
 projects[lingotek][subdir] = "contrib"
-projects[lingotek][version] = "4.06"
+projects[lingotek][version] = "4.10"
 
 projects[link][type] = "module"
 projects[link][subdir] = "contrib"
-projects[link][version] = "1.1"
+projects[link][version] = "1.2"
+
+projects[media][type] = "module"
+projects[media][subdir] = "contrib"
+projects[media][download][type] = "git"
+projects[media][download][url] = "http://git.drupal.org/project/media.git"
+projects[media][download][branch] = "7.x-2.x"
+projects[media][download][revision] = "7d12b8b"
+
+projects[memcache][type] = "module"
+projects[memcache][subdir] = "contrib"
+projects[memcache][version] = "1.0"
 
 projects[menu_attributes][type] = "module"
 projects[menu_attributes][subdir] = "contrib"
@@ -224,29 +232,19 @@ projects[message_notify][version] = "2.5"
 
 projects[message_subscribe][type] = "module"
 projects[message_subscribe][subdir] = "contrib"
-projects[message_subscribe][download][type] = "git"
-projects[message_subscribe][download][url] = "http://git.drupal.org/project/message_subscribe.git"
-projects[message_subscribe][download][branch] = "7.x-1.x"
-
-projects[memcache][type] = "module"
-projects[memcache][subdir] = "contrib"
-projects[memcache][version] = "1.0"
+projects[message_subscribe][version] = "1.0-rc1"
 
 projects[metatag][type] = "module"
 projects[metatag][subdir] = "contrib"
 projects[metatag][version] = "1.0-beta7"
 
-; Support for rel=author link in head.
-; http://drupal.org/node/1865228#comment-6839604
-projects[metatag][patch][] = "http://drupal.org/files/metatag-n1865228-3.patch"
-
 projects[module_filter][type] = "module"
 projects[module_filter][subdir] = "contrib"
 projects[module_filter][version] = "1.8"
 
 projects[mollom][type] = "module"
 projects[mollom][subdir] = "contrib"
-projects[mollom][version] = "2.7"
+projects[mollom][version] = "2.8"
 
 projects[navbar][type] = "module"
 projects[navbar][subdir] = "contrib"
@@ -266,58 +264,73 @@ projects[oauthconnector][download][url] = "http://git.drupal.org/project/oauthco
 projects[oauthconnector][download][branch] = "7.x-1.x"
 projects[oauthconnector][download][revision] = "0ce7ac9614710c0f68d0a58cb4ae4667f8bd6fa7"
 
+projects[oembed][type] = "module"
+projects[oembed][subdir] = "contrib"
+projects[oembed][download][type] = "git"
+projects[oembed][download][url] = "http://git.drupal.org/project/oembed.git"
+projects[oembed][download][branch] = "7.x-1.x"
+projects[oembed][download][revision] = "63898e1"
+
+; Add oEmbed plugins to list of supported media providers
+; https://drupal.org/comment/8287243#comment-8287243
+projects[oembed][patch][] = "https://drupal.org/files/issues/list-enabled-plugins-2159335-1.patch"
+
+; Remove WYSIWYG special casing
+; https://drupal.org/comment/8287861#comment-8287861
+projects[oembed][patch][] = "https://drupal.org/files/issues/remove-wysiwyg-special-casing-2159303-2.patch"
+
+; Provided a default display configuration
+; https://drupal.org/comment/8286995#comment-8286995
+projects[oembed][patch][] = "https://drupal.org/files/issues/provide-default-display-configuration-2128389-3.patch"
+
+; Add supported file and MIME type information to file formatters
+; https://drupal.org/comment/8286935#comment-8286935
+projects[oembed][patch][] = "https://drupal.org/files/issues/add-file-and-mime-type-information-to-formatters-2159275-1.patch"
+
+; Themed images ignore width, height, alt and title attributes
+; https://drupal.org/comment/8286915#comment-8286915
+projects[oembed][patch][] = "https://drupal.org/files/issues/prefer-element-attributes-2159269-1.patch"
+
 projects[og][type] = "module"
 projects[og][subdir] = "contrib"
-projects[og][version] = "2.3"
+projects[og][version] = "2.4"
 
 ; Auto-assign role to group manager broken on groups with overridden roles.
 ; https://drupal.org/node/2005800#comment-7684873
-projects[og][patch][] = "http://drupal.org/files/og-default-role-member-2005800-21.patch"
+projects[og][patch][] = "http://drupal.org/files/issues/og-default-role-member-2005800-25.patch"
 
-; og_ui should give users the theme, not admin ui when creating groups
+; og_ui should give users the theme, not admin ui when creating groups.
 ; http://drupal.org/node/1800208
 projects[og][patch][] = "http://drupal.org/files/og_ui-group_node_add_theme-1800208-5.patch"
 
-; _og_access_verify_access_field_existence() assumes node group type, throws an exception rebuilding node access.
-projects[og][patch][] = "http://drupal.org/files/og-access-rebuild-exception-group-type.patch"
-
 projects[panelizer][type] = "module"
 projects[panelizer][subdir] = "contrib"
 projects[panelizer][version] = "3.1"
 
 projects[panels][type] = "module"
 projects[panels][subdir] = "contrib"
-projects[panels][version] = "3.3"
-
-; Fatal error: Call to undefined function panels_get_layouts()
-; http://drupal.org/node/1828684#comment-6694732
-projects[panels][patch][] = "http://drupal.org/files/1828684-layout-fix-6.patch"
-
-; PHP 5.3.9 Strict Warning on Panels Empty Value
-; http://drupal.org/node/1632898#comment-6412840
-projects[panels][patch][] = "http://drupal.org/files/panels-n1632898-15.patch"
-
-; Add internationalization support.
-; http://drupal.org/node/1179034#comment-7216342
-projects[panels][patch][] = "http://drupal.org/files/panels-1179034-41_____panels-uuids-127790-100__-80.patch"
+projects[panels][download][type] = "git"
+projects[panels][download][url] = "http://git.drupal.org/project/panels.git"
+projects[panels][download][branch] = "7.x-3.x-i18n"
+projects[panels][download][revision] = "43a3810e8b0d2ef435ef2bb190039391c8e1712f"
 
 projects[paranoia][type] = "module"
 projects[paranoia][subdir] = "contrib"
-projects[paranoia][version] = "1.2"
+projects[paranoia][version] = "1.3"
 
 projects[pathauto][type] = "module"
 projects[pathauto][subdir] = "contrib"
 projects[pathauto][version] = "1.2"
 
-projects[placeholder][type] = "module"
-projects[placeholder][subdir] = "contrib"
-projects[placeholder][version] = "1.0"
+projects[elements][type] = "module"
+projects[elements][subdir] = "contrib"
+projects[elements][version] = "1.4"
 
 projects[pm_existing_pages][type] = "module"
 projects[pm_existing_pages][subdir] = "contrib"
 projects[pm_existing_pages][version] = "1.4"
 
-projects[potx][type] = "module" 
+projects[potx][type] = "module"
 projects[potx][subdir] = "contrib"
 projects[potx][version] = "1.0"
 
@@ -325,11 +338,11 @@ projects[privatemsg][type] = "module"
 projects[privatemsg][subdir] = "contrib"
 projects[privatemsg][version] = "1.4"
 
-; Add preliminary Views integration
+; Add preliminary Views integration.
 ; http://drupal.org/node/1573000
 projects[privatemsg][patch][] = "http://drupal.org/files/privatemsg-1573000-64.patch"
 
-; Enable privatemsg_realname when realname is enabled
+; Enable privatemsg_realname when realname is enabled.
 ; https://drupal.org/node/2070719
 projects[privatemsg][patch][] = "http://drupal.org/files/2077223-privatemsg-realname-enabled-1.patch"
 
@@ -338,6 +351,10 @@ projects[quicktabs][subdir] = "contrib"
 projects[quicktabs][version] = "3.6"
 projects[quicktabs][patch][] = "http://drupal.org/files/2104643-revert-qt-487518-5.patch"
 
+projects[r4032login][type] = "module"
+projects[r4032login][subdir] = "contrib"
+projects[r4032login][version] = "1.7"
+
 projects[radioactivity][type] = "module"
 projects[radioactivity][subdir] = "contrib"
 projects[radioactivity][download][type] = "git"
@@ -345,19 +362,15 @@ projects[radioactivity][download][url] = "http://git.drupal.org/project/radioact
 projects[radioactivity][download][branch] = "7.x-2.x"
 projects[radioactivity][download][revision] = "aee21dbed4f54d0e626e3c19ecc550bf1ec656f6"
 
-; Radioactivity not compatible with Memcache module
+; Radioactivity not compatible with Memcache module.
 ; http://drupal.org/node/1860216
 projects[radioactivity][patch][] = "http://drupal.org/files/radioactivity-memcache.patch"
 
-projects[r4032login][type] = "module"
-projects[r4032login][subdir] = "contrib"
-projects[r4032login][version] = "1.6"
-
 projects[rate][type] = "module"
 projects[rate][subdir] = "contrib"
 projects[rate][version] = "1.6"
 
-; Add widget to node/comment $links
+; Add widget to node/comment $links.
 ; http://drupal.org/node/947516#comment-6979780
 projects[rate][patch][] = "http://drupal.org/files/947516-rate-node-links-15.patch"
 
@@ -365,16 +378,25 @@ projects[realname][type] = "module"
 projects[realname][subdir] = "contrib"
 projects[realname][version] = "1.1"
 
+projects[redirect][type] = "module"
+projects[redirect][subdir] = "contrib"
+projects[redirect][version] = "1.0-rc1"
+
 projects[registration][subdir] = "contrib"
 projects[registration][type] = "module"
 projects[registration][version] = "1.2"
 
+projects[rich_snippets][type] = "module"
+projects[rich_snippets][subdir] = "contrib"
+projects[rich_snippets][version] = "1.0-beta3"
+
 projects[rules][type] = "module"
 projects[rules][subdir] = "contrib"
-projects[rules][download][type] = "git"
-projects[rules][download][url] = "http://git.drupal.org/project/rules.git"
-projects[rules][download][branch] = "7.x-2.x"
-projects[rules][download][revision] = "8db91e5"
+projects[rules][version] = "2.6"
+
+projects[schemaorg][type] = "module"
+projects[schemaorg][subdir] = "contrib"
+projects[schemaorg][version] = "1.0-beta4"
 
 projects[search_facetapi][type] = "module"
 projects[search_facetapi][subdir] = "contrib"
@@ -384,22 +406,6 @@ projects[sharethis][type] = "module"
 projects[sharethis][subdir] = "contrib"
 projects[sharethis][version] = "2.5"
 
-projects[facetapi][type] = "module"
-projects[facetapi][subdir] = "contrib"
-projects[facetapi][version] = "1.3"
-
-projects[rich_snippets][type] = "module"
-projects[rich_snippets][subdir] = "contrib"
-projects[rich_snippets][version] = "1.0-beta3"
-
-; Remove snippets from non-node type searches:
-; http://drupal.org/node/1923904#comment-7094488
-projects[rich_snippets][patch][] = "http://drupal.org/files/1923904-search-nodes-only.patch"
-
-projects[schemaorg][type] = "module"
-projects[schemaorg][subdir] = "contrib"
-projects[schemaorg][version] = "1.0-beta3"
-
 projects[strongarm][type] = "module"
 projects[strongarm][subdir] = "contrib"
 projects[strongarm][download][type] = "git"
@@ -411,7 +417,7 @@ projects[timeago][type] = "module"
 projects[timeago][subdir] = "contrib"
 projects[timeago][version] = "2.2"
 
-; Provide a dedicated date type:
+; Provide a dedicated date type.
 ; http://drupal.org/node/1427226#comment-6638836
 projects[timeago][patch][] = "http://drupal.org/files/1427226-timeago-date-type.patch"
 
@@ -419,14 +425,14 @@ projects[title][type] = "module"
 projects[title][subdir] = "contrib"
 projects[title][version] = "1.0-alpha7"
 
-projects[translation_helpers][type] = "module"
-projects[translation_helpers][subdir] = "contrib"
-projects[translation_helpers][version] = "1.0"
-
 projects[token][type] = "module"
 projects[token][subdir] = "contrib"
 projects[token][version] = "1.5"
 
+projects[translation_helpers][type] = "module"
+projects[translation_helpers][subdir] = "contrib"
+projects[translation_helpers][version] = "1.0"
+
 projects[variable][type] = "module"
 projects[variable][subdir] = "contrib"
 projects[variable][version] = "2.3"
@@ -435,38 +441,30 @@ projects[views][type] = "module"
 projects[views][subdir] = "contrib"
 projects[views][version] = "3.7"
 
-projects[views_field_view][type] = "module"
-projects[views_field_view][subdir] = "contrib"
-projects[views_field_view][version] = "1.1"
-
-projects[views_load_more][type] = "module"
-projects[views_load_more][subdir] = "contrib"
-projects[views_load_more][version] = "1.1"
-
 projects[views_bulk_operations][type] = "module"
 projects[views_bulk_operations][subdir] = "contrib"
 projects[views_bulk_operations][version] = "3.1"
 
+projects[views_field_view][type] = "module"
+projects[views_field_view][subdir] = "contrib"
+projects[views_field_view][version] = "1.1"
+
 projects[views_litepager][type] = "module"
 projects[views_litepager][subdir] = "contrib"
 projects[views_litepager][version] = "3.0"
 
-; We have the version of voting api at the top so it doesn't get included in our dev make patch.
-projects[votingapi][version] = "2.11"
+projects[views_load_more][type] = "module"
+projects[views_load_more][subdir] = "contrib"
+projects[views_load_more][version] = "1.2"
+
 projects[votingapi][type] = "module"
 projects[votingapi][subdir] = "contrib"
+projects[votingapi][version] = "2.11"
 
 projects[voting_rules][type] = "module"
 projects[voting_rules][subdir] = "contrib"
 projects[voting_rules][version] = "1.0-alpha1"
 
-; Registry Rebuild
-; We can probably remove this later, but for now keep it included
-; See https://drupal.org/node/1983606#comment-7788313 for more information.
-projects[registry_rebuild][version] = "1.10"
-projects[registry_rebuild][type] = "module"
-projects[registry_rebuild][subdir] = "contrib"
-
 ; Contributed themes.
 
 projects[adaptivetheme][type] = "theme"
@@ -480,28 +478,33 @@ projects[adaptivetheme][download][revision] = "b4b38c3c01d066e733c2942020c51962c
 ; http://drupal.org/node/1427226#comment-6638836
 projects[adaptivetheme][patch][] = "http://drupal.org/files/remove-comment-creation-link-2018081-1.patch"
 
+; Add styling for link buttons.
+; https://drupal.org/comment/8289329#comment-8289329
+projects[adaptivetheme][patch][] = "https://drupal.org/files/issues/add-link-button-styling-2159783-1.patch"
+
 projects[sky][type] = "theme"
 projects[sky][subdir] = "contrib"
 projects[sky][version] = "3.0-rc1"
 
 ; Libraries.
 ; NOTE: These need to be listed in http://drupal.org/packaging-whitelist.
-libraries[underscore][download][type] = "get"
-libraries[underscore][type] = "libraries"
-libraries[underscore][download][url] = "https://github.com/jashkenas/underscore/archive/1.4.4.zip"
 
 libraries[backbone][download][type] = "get"
 libraries[backbone][type] = "libraries"
-libraries[backbone][download][url] = "https://github.com/jashkenas/backbone/archive/1.0.0.tar.gz"
+libraries[backbone][download][url] = "https://github.com/jashkenas/backbone/archive/1.1.0.tar.gz"
 
 libraries[ckeditor][download][type] = "get"
 libraries[ckeditor][download][url] = "http://download.cksource.com/CKEditor/CKEditor/CKEditor%204.0/ckeditor_4.0_full.tar.gz"
 libraries[ckeditor][type] = "libraries"
 
-libraries[placeholder][download][type] = "get"
-libraries[placeholder][type] = "libraries"
-libraries[placeholder][download][url] = "https://github.com/mathiasbynens/jquery-placeholder/archive/v2.0.7.tar.gz"
+libraries[modernizr][download][type] = "get"
+libraries[modernizr][type] = "libraries"
+libraries[modernizr][download][url] = "https://github.com/Modernizr/Modernizr/archive/v2.7.0.tar.gz"
 
 libraries[timeago][download][type] = "get"
 libraries[timeago][type] = "libraries"
 libraries[timeago][download][url] = "https://raw.github.com/rmm5t/jquery-timeago/v1.3.0/jquery.timeago.js"
+
+libraries[underscore][download][type] = "get"
+libraries[underscore][type] = "libraries"
+libraries[underscore][download][url] = "https://github.com/jashkenas/underscore/archive/1.4.4.zip"
diff --git a/profiles/commons/libraries/backbone/CONTRIBUTING.md b/profiles/commons/libraries/backbone/CONTRIBUTING.md
index 5f4ff1a..5540361 100644
--- a/profiles/commons/libraries/backbone/CONTRIBUTING.md
+++ b/profiles/commons/libraries/backbone/CONTRIBUTING.md
@@ -1,15 +1,20 @@
-## How to contribute to Backbone.js
+## How to Open a Backbone.js Ticket
+
+* Do not use tickets to ask for help with (debugging) your application. Ask on
+the [mailing list](https://groups.google.com/forum/#!forum/backbonejs), 
+in the IRC channel (`#documentcloud` on Freenode), or if you understand your 
+specific problem, on [StackOverflow](http://stackoverflow.com/questions/tagged/backbone.js).
 
 * Before you open a ticket or send a pull request,
-[search](https://github.com/documentcloud/backbone/issues) for previous
+[search](https://github.com/jashkenas/backbone/issues) for previous
 discussions about the same feature or issue. Add to the earlier ticket if you
 find one.
 
 * Before sending a pull request for a feature or bug fix, be sure to have
-[tests](http://backbonejs.org/test/test.html).
+[tests](http://backbonejs.org/test/).
 
 * Use the same coding style as the rest of the
-[codebase](https://github.com/documentcloud/backbone/blob/master/backbone.js).
+[codebase](https://github.com/jashkenas/backbone/blob/master/backbone.js).
 
 * In your pull request, do not add documentation or rebuild the minified
 `backbone-min.js` file. We'll do that before cutting a new release.
diff --git a/profiles/commons/libraries/backbone/README.md b/profiles/commons/libraries/backbone/README.md
index 75aa078..7b0482d 100644
--- a/profiles/commons/libraries/backbone/README.md
+++ b/profiles/commons/libraries/backbone/README.md
@@ -1,26 +1,29 @@
-     ____                     __      __                                                 
-    /\  _`\                  /\ \    /\ \                                   __           
-    \ \ \ \ \     __      ___\ \ \/'\\ \ \____    ___     ___      __      /\_\    ____  
-     \ \  _ <'  /'__`\   /'___\ \ , < \ \ '__`\  / __`\ /' _ `\  /'__`\    \/\ \  /',__\ 
+     ____                     __      __
+    /\  _`\                  /\ \    /\ \                                   __
+    \ \ \ \ \     __      ___\ \ \/'\\ \ \____    ___     ___      __      /\_\    ____
+     \ \  _ <'  /'__`\   /'___\ \ , < \ \ '__`\  / __`\ /' _ `\  /'__`\    \/\ \  /',__\
       \ \ \ \ \/\ \ \.\_/\ \__/\ \ \\`\\ \ \ \ \/\ \ \ \/\ \/\ \/\  __/  __ \ \ \/\__, `\
        \ \____/\ \__/.\_\ \____\\ \_\ \_\ \_,__/\ \____/\ \_\ \_\ \____\/\_\_\ \ \/\____/
-        \/___/  \/__/\/_/\/____/ \/_/\/_/\/___/  \/___/  \/_/\/_/\/____/\/_/\ \_\ \/___/ 
-                                                                           \ \____/      
-                                                                            \/___/       
+        \/___/  \/__/\/_/\/____/ \/_/\/_/\/___/  \/___/  \/_/\/_/\/____/\/_/\ \_\ \/___/
+                                                                           \ \____/
+                                                                            \/___/
     (_'_______________________________________________________________________________'_)
     (_.._)
-                                               
-                                              
+
+
 Backbone supplies structure to JavaScript-heavy applications by providing models key-value binding and custom events, collections with a rich API of enumerable functions, views with declarative event handling, and connects it all to your existing application over a RESTful JSON interface.
 
 For Docs, License, Tests, pre-packed downloads, and everything else, really, see:
 http://backbonejs.org
 
 To suggest a feature, report a bug, or general discussion:
-http://github.com/documentcloud/backbone/issues/
+http://github.com/jashkenas/backbone/issues
+
+Backbone is an open-sourced component of DocumentCloud:
+https://github.com/documentcloud
 
-All contributors are listed here:
-http://github.com/documentcloud/backbone/contributors
+Many thanks to our contributors:
+http://github.com/jashkenas/backbone/contributors
 
-Special thanks to Robert Kieffer for the original philosophy behind Backbone. 
+Special thanks to Robert Kieffer for the original philosophy behind Backbone.
 http://github.com/broofa
diff --git a/profiles/commons/libraries/backbone/Rakefile b/profiles/commons/libraries/backbone/Rakefile
deleted file mode 100644
index e972364..0000000
--- a/profiles/commons/libraries/backbone/Rakefile
+++ /dev/null
@@ -1,24 +0,0 @@
-desc "rebuild the backbone-min.js files for distribution"
-task :build do
-  check 'uglifyjs', 'UglifyJS', 'https://github.com/mishoo/UglifyJS2'
-  system 'uglifyjs backbone.js --source-map backbone-min.map -o backbone-min.js'
-end
-
-desc "build the docco documentation"
-task :doc do
-  check 'docco', 'docco', 'https://github.com/jashkenas/docco'
-  system 'docco backbone.js && docco examples/todos/todos.js examples/backbone.localstorage.js'
-end
-
-desc "run JavaScriptLint on the source"
-task :lint do
-  check 'jsl', 'JavaScript Lint', 'http://www.javascriptlint.com/'
-  system "jsl -nofilelisting -nologo -conf docs/jsl.conf -process backbone.js"
-end
-
-# Check for the existence of an executable.
-def check(exec, name, url)
-  return unless `which #{exec}`.empty?
-  puts "#{name} not found.\nInstall it from #{url}"
-  exit
-end
diff --git a/profiles/commons/libraries/backbone/backbone-min.js b/profiles/commons/libraries/backbone/backbone-min.js
index 7243e5f..3b2593d 100644
--- a/profiles/commons/libraries/backbone/backbone-min.js
+++ b/profiles/commons/libraries/backbone/backbone-min.js
@@ -1,4 +1,2 @@
-(function(){var root=this;var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;var Backbone;if(typeof exports!=="undefined"){Backbone=exports}else{Backbone=root.Backbone={}}Backbone.VERSION="1.0.0";var _=root._;if(!_&&typeof require!=="undefined")_=require("underscore");Backbone.$=root.jQuery||root.Zepto||root.ender||root.$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments)});once._callback=callback;return this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context){this._events={};return this}names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context){retain.push(ev)}}}if(!retain.length)delete this._events[name]}}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this},stopListening:function(obj,name,callback){var listeners=this._listeners;if(!listeners)return this;var deleteListener=!name&&!callback;if(typeof name==="object")callback=this;if(obj)(listeners={})[obj._listenerId]=obj;for(var id in listeners){listeners[id].off(name,callback,this);if(deleteListener)delete this._listeners[id]}return this}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==="object"){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest))}return false}if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest))}return false}return true};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args)}};var listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeners=this._listeners||(this._listeners={});var id=obj._listenerId||(obj._listenerId=_.uniqueId("l"));listeners[id]=obj;if(typeof name==="object")callback=this;obj[implementation](name,callback,this);return this}});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var defaults;var attrs=attributes||{};options||(options={});this.cid=_.uniqueId("c");this.attributes={};_.extend(this,_.pick(options,modelOptions));if(options.parse)attrs=this.parse(attrs,options)||{};if(defaults=_.result(this,"defaults")){attrs=_.defaults({},attrs,defaults)}this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments)};var modelOptions=["url","urlRoot","collection"];_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return this.get(attr)!=null},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={}}current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val}else{delete this.changed[attr]}unset?delete current[attr]:current[attr]=val}if(!silent){if(changes.length)this._pending=true;for(var i=0,l=changes.length;i<l;i++){this.trigger("change:"+changes[i],this,current[changes[i]],options)}}if(changing)return this;if(!silent){while(this._pending){this._pending=false;this.trigger("change",this,options)}}this._pending=false;this._changing=false;return this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}))},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],val=diff[attr]))continue;(changed||(changed={}))[attr]=val}return changed},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr]},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);return this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}if(attrs&&(!options||!options.wait)&&!this.set(attrs,options))return false;options=_.extend({validate:true},options);if(!this._validate(attrs,options))return false;if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs)}if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false}if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);method=this.isNew()?"create":options.patch?"patch":"update";if(method==="patch")options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger("destroy",model,model.collection,options)};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger("sync",model,resp,options)};if(this.isNew()){options.success();return false}wrapError(this,options);var xhr=this.sync("delete",this,options);if(!options.wait)destroy();return xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return base;return base+(base.charAt(base.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger("invalid",this,error,_.extend(options||{},{validationError:error}));return false}});var modelMethods=["keys","values","pairs","invert","pick","omit"];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.url)this.url=options.url;if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options))};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,merge:false,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.defaults(options||{},addOptions))},remove:function(models,options){models=_.isArray(models)?models.slice():[models];options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger("remove",model,this,options)}this._removeReference(model)}return this},set:function(models,options){options=_.defaults(options||{},setOptions);if(options.parse)models=this.parse(models,options);if(!_.isArray(models))models=models?[models]:[];var i,l,model,attrs,existing,sort;var at=options.at;var sortable=this.comparator&&at==null&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};for(i=0,l=models.length;i<l;i++){if(!(model=this._prepareModel(models[i],options)))continue;if(existing=this.get(model)){if(options.remove)modelMap[existing.cid]=true;if(options.merge){existing.set(model.attributes,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true}}else if(options.add){toAdd.push(model);model.on("all",this._onModelEvent,this);this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model}}if(options.remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model)}if(toRemove.length)this.remove(toRemove,options)}if(toAdd.length){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){splice.apply(this.models,[at,0].concat(toAdd))}else{push.apply(this.models,toAdd)}}if(sort)this.sort({silent:true});if(options.silent)return this;for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger("add",model,this,options)}if(sort)this.trigger("sort",this,options);return this},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i])}options.previousModels=this.models;this._reset();this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger("reset",this,options);return this},push:function(model,options){model=this._prepareModel(model,options);this.add(model,_.extend({at:this.length},options));return model},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model},unshift:function(model,options){model=this._prepareModel(model,options);this.add(model,_.extend({at:0},options));return model},shift:function(options){var model=this.at(0);this.remove(model,options);return model},slice:function(begin,end){return this.models.slice(begin,end)},get:function(obj){if(obj==null)return void 0;return this._byId[obj.id!=null?obj.id:obj.cid||obj]},at:function(index){return this.models[index]},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?"find":"filter"](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false}return true})},findWhere:function(attrs){return this.where(attrs,true)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(_.bind(this.comparator,this))}if(!options.silent)this.trigger("sort",this,options);return this},sortedIndex:function(model,value,context){value||(value=this.comparator);var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _.sortedIndex(this.models,model,iterator,context)},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger("sync",collection,resp,options)};wrapError(this,options);return this.sync("read",this,options)},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(resp){if(options.wait)collection.add(model,options);if(success)success(model,resp,options)};model.save(null,options);return model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model){if(!attrs.collection)attrs.collection=this;return attrs}options||(options={});options.collection=this;var model=new this.model(attrs,options);if(!model._validate(attrs,options)){this.trigger("invalid",this,attrs,options);return false}return model},_removeReference:function(model){if(this===model.collection)delete model.collection;model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){if((event==="add"||event==="remove")&&collection!==this)return;if(event==="destroy")this.remove(model,options);if(model&&event==="change:"+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model}this.trigger.apply(this,arguments)}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args)}});var attributeMethods=["groupBy","countBy","sortBy"];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}});var View=Backbone.View=function(options){this.cid=_.uniqueId("view");this._configure(options||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this},delegateEvents:function(events){if(!(events||(events=_.result(this,"events"))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+=".delegateEvents"+this.cid;if(selector===""){this.$el.on(eventName,method)}else{this.$el.on(eventName,selector,method)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_configure:function(options){if(this.options)options=_.extend({},_.result(this,"options"),options);_.extend(this,_.pick(options,viewOptions));this.options=options},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,"attributes"));if(this.id)attrs.id=_.result(this,"id");if(this.className)attrs["class"]=_.result(this,"className");var $el=Backbone.$("<"+_.result(this,"tagName")+">").attr(attrs);this.setElement($el,false)}else{this.setElement(_.result(this,"el"),false)}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(!options.url){params.url=_.result(model,"url")||urlError()}if(options.data==null&&model&&(method==="create"||method==="update"||method==="patch")){params.contentType="application/json";params.data=JSON.stringify(options.attrs||model.toJSON(options))}if(options.emulateJSON){params.contentType="application/x-www-form-urlencoded";params.data=params.data?{model:params.data}:{}}if(options.emulateHTTP&&(type==="PUT"||type==="DELETE"||type==="PATCH")){params.type="POST";if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader("X-HTTP-Method-Override",type);if(beforeSend)return beforeSend.apply(this,arguments)}}if(params.type!=="GET"&&!options.emulateJSON){params.processData=false}if(params.type==="PATCH"&&window.ActiveXObject&&!(window.external&&window.external.msActiveXFilteringEnabled)){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger("request",model,xhr,options);return xhr};var methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name=""}if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args);router.trigger.apply(router,["route:"+name].concat(args));router.trigger("route",name,args);Backbone.history.trigger("route",router,name,args)});return this},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,"routes");var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route])}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/]+)"}).replace(splatParam,"(.*?)");return new RegExp("^"+route+"$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;History.started=false;_.extend(History.prototype,Events,{interval:50,getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,"");if(!fragment.indexOf(root))fragment=fragment.substr(root.length)}else{fragment=this.getHash()}}return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({},{root:"/"},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);this.root=("/"+this.root+"/").replace(rootStripper,"/");if(oldIE&&this._wantsHashChange){this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(fragment)}if(this._hasPushState){Backbone.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!oldIE){Backbone.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=fragment;var loc=this.location;var atRoot=loc.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!atRoot){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else if(this._wantsPushState&&this._hasPushState&&atRoot&&loc.hash){this.fragment=this.getHash().replace(routeStripper,"");this.history.replaceState({},document.title,this.root+this.fragment+loc.search)}if(!this.options.silent)return this.loadUrl()},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);History.started=false},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe))}if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(fragmentOverride){var fragment=this.fragment=this.getFragment(fragmentOverride);var matched=_.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true}});return matched},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:options};fragment=this.getFragment(fragment||"");if(this.fragment===fragment)return;this.fragment=fragment;var url=this.root+fragment;if(this._hasPushState){this.history[options.replace?"replaceState":"pushState"]({},document.title,url)}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace)}}else{return this.location.assign(url)}if(options.trigger)this.loadUrl(fragment)},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else{location.hash="#"+fragment}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,"constructor")){child=protoProps.constructor}else{child=function(){return parent.apply(this,arguments)}}_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified')};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger("error",model,resp,options)}}}).call(this);
-/*
-//@ sourceMappingURL=backbone-min.map
-*/
\ No newline at end of file
+(function(){var t=this;var e=t.Backbone;var i=[];var r=i.push;var s=i.slice;var n=i.splice;var a;if(typeof exports!=="undefined"){a=exports}else{a=t.Backbone={}}a.VERSION="1.1.0";var h=t._;if(!h&&typeof require!=="undefined")h=require("underscore");a.$=t.jQuery||t.Zepto||t.ender||t.$;a.noConflict=function(){t.Backbone=e;return this};a.emulateHTTP=false;a.emulateJSON=false;var o=a.Events={on:function(t,e,i){if(!l(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,i){if(!l(this,"once",t,[e,i])||!e)return this;var r=this;var s=h.once(function(){r.off(t,s);e.apply(this,arguments)});s._callback=e;return this.on(t,s,i)},off:function(t,e,i){var r,s,n,a,o,u,c,f;if(!this._events||!l(this,"off",t,[e,i]))return this;if(!t&&!e&&!i){this._events={};return this}a=t?[t]:h.keys(this._events);for(o=0,u=a.length;o<u;o++){t=a[o];if(n=this._events[t]){this._events[t]=r=[];if(e||i){for(c=0,f=n.length;c<f;c++){s=n[c];if(e&&e!==s.callback&&e!==s.callback._callback||i&&i!==s.context){r.push(s)}}}if(!r.length)delete this._events[t]}}return this},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1);if(!l(this,"trigger",t,e))return this;var i=this._events[t];var r=this._events.all;if(i)c(i,e);if(r)c(r,arguments);return this},stopListening:function(t,e,i){var r=this._listeningTo;if(!r)return this;var s=!e&&!i;if(!i&&typeof e==="object")i=this;if(t)(r={})[t._listenId]=t;for(var n in r){t=r[n];t.off(e,i,this);if(s||h.isEmpty(t._events))delete this._listeningTo[n]}return this}};var u=/\s+/;var l=function(t,e,i,r){if(!i)return true;if(typeof i==="object"){for(var s in i){t[e].apply(t,[s,i[s]].concat(r))}return false}if(u.test(i)){var n=i.split(u);for(var a=0,h=n.length;a<h;a++){t[e].apply(t,[n[a]].concat(r))}return false}return true};var c=function(t,e){var i,r=-1,s=t.length,n=e[0],a=e[1],h=e[2];switch(e.length){case 0:while(++r<s)(i=t[r]).callback.call(i.ctx);return;case 1:while(++r<s)(i=t[r]).callback.call(i.ctx,n);return;case 2:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a);return;case 3:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a,h);return;default:while(++r<s)(i=t[r]).callback.apply(i.ctx,e)}};var f={listenTo:"on",listenToOnce:"once"};h.each(f,function(t,e){o[e]=function(e,i,r){var s=this._listeningTo||(this._listeningTo={});var n=e._listenId||(e._listenId=h.uniqueId("l"));s[n]=e;if(!r&&typeof i==="object")r=this;e[t](i,r,this);return this}});o.bind=o.on;o.unbind=o.off;h.extend(a,o);var d=a.Model=function(t,e){var i=t||{};e||(e={});this.cid=h.uniqueId("c");this.attributes={};if(e.collection)this.collection=e.collection;if(e.parse)i=this.parse(i,e)||{};i=h.defaults({},i,h.result(this,"defaults"));this.set(i,e);this.changed={};this.initialize.apply(this,arguments)};h.extend(d.prototype,o,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return h.clone(this.attributes)},sync:function(){return a.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return h.escape(this.get(t))},has:function(t){return this.get(t)!=null},set:function(t,e,i){var r,s,n,a,o,u,l,c;if(t==null)return this;if(typeof t==="object"){s=t;i=e}else{(s={})[t]=e}i||(i={});if(!this._validate(s,i))return false;n=i.unset;o=i.silent;a=[];u=this._changing;this._changing=true;if(!u){this._previousAttributes=h.clone(this.attributes);this.changed={}}c=this.attributes,l=this._previousAttributes;if(this.idAttribute in s)this.id=s[this.idAttribute];for(r in s){e=s[r];if(!h.isEqual(c[r],e))a.push(r);if(!h.isEqual(l[r],e)){this.changed[r]=e}else{delete this.changed[r]}n?delete c[r]:c[r]=e}if(!o){if(a.length)this._pending=true;for(var f=0,d=a.length;f<d;f++){this.trigger("change:"+a[f],this,c[a[f]],i)}}if(u)return this;if(!o){while(this._pending){this._pending=false;this.trigger("change",this,i)}}this._pending=false;this._changing=false;return this},unset:function(t,e){return this.set(t,void 0,h.extend({},e,{unset:true}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,h.extend({},t,{unset:true}))},hasChanged:function(t){if(t==null)return!h.isEmpty(this.changed);return h.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?h.clone(this.changed):false;var e,i=false;var r=this._changing?this._previousAttributes:this.attributes;for(var s in t){if(h.isEqual(r[s],e=t[s]))continue;(i||(i={}))[s]=e}return i},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return h.clone(this._previousAttributes)},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=this;var i=t.success;t.success=function(r){if(!e.set(e.parse(r,t),t))return false;if(i)i(e,r,t);e.trigger("sync",e,r,t)};M(this,t);return this.sync("read",this,t)},save:function(t,e,i){var r,s,n,a=this.attributes;if(t==null||typeof t==="object"){r=t;i=e}else{(r={})[t]=e}i=h.extend({validate:true},i);if(r&&!i.wait){if(!this.set(r,i))return false}else{if(!this._validate(r,i))return false}if(r&&i.wait){this.attributes=h.extend({},a,r)}if(i.parse===void 0)i.parse=true;var o=this;var u=i.success;i.success=function(t){o.attributes=a;var e=o.parse(t,i);if(i.wait)e=h.extend(r||{},e);if(h.isObject(e)&&!o.set(e,i)){return false}if(u)u(o,t,i);o.trigger("sync",o,t,i)};M(this,i);s=this.isNew()?"create":i.patch?"patch":"update";if(s==="patch")i.attrs=r;n=this.sync(s,this,i);if(r&&i.wait)this.attributes=a;return n},destroy:function(t){t=t?h.clone(t):{};var e=this;var i=t.success;var r=function(){e.trigger("destroy",e,e.collection,t)};t.success=function(s){if(t.wait||e.isNew())r();if(i)i(e,s,t);if(!e.isNew())e.trigger("sync",e,s,t)};if(this.isNew()){t.success();return false}M(this,t);var s=this.sync("delete",this,t);if(!t.wait)r();return s},url:function(){var t=h.result(this,"urlRoot")||h.result(this.collection,"url")||U();if(this.isNew())return t;return t+(t.charAt(t.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(t){return this._validate({},h.extend(t||{},{validate:true}))},_validate:function(t,e){if(!e.validate||!this.validate)return true;t=h.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;if(!i)return true;this.trigger("invalid",this,i,h.extend(e,{validationError:i}));return false}});var p=["keys","values","pairs","invert","pick","omit"];h.each(p,function(t){d.prototype[t]=function(){var e=s.call(arguments);e.unshift(this.attributes);return h[t].apply(h,e)}});var v=a.Collection=function(t,e){e||(e={});if(e.model)this.model=e.model;if(e.comparator!==void 0)this.comparator=e.comparator;this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,h.extend({silent:true},e))};var g={add:true,remove:true,merge:true};var m={add:true,remove:false};h.extend(v.prototype,o,{model:d,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return a.sync.apply(this,arguments)},add:function(t,e){return this.set(t,h.extend({merge:false},e,m))},remove:function(t,e){var i=!h.isArray(t);t=i?[t]:h.clone(t);e||(e={});var r,s,n,a;for(r=0,s=t.length;r<s;r++){a=t[r]=this.get(t[r]);if(!a)continue;delete this._byId[a.id];delete this._byId[a.cid];n=this.indexOf(a);this.models.splice(n,1);this.length--;if(!e.silent){e.index=n;a.trigger("remove",a,this,e)}this._removeReference(a)}return i?t[0]:t},set:function(t,e){e=h.defaults({},e,g);if(e.parse)t=this.parse(t,e);var i=!h.isArray(t);t=i?t?[t]:[]:h.clone(t);var r,s,n,a,o,u,l;var c=e.at;var f=this.model;var p=this.comparator&&c==null&&e.sort!==false;var v=h.isString(this.comparator)?this.comparator:null;var m=[],y=[],_={};var w=e.add,b=e.merge,x=e.remove;var E=!p&&w&&x?[]:false;for(r=0,s=t.length;r<s;r++){o=t[r];if(o instanceof d){n=a=o}else{n=o[f.prototype.idAttribute]}if(u=this.get(n)){if(x)_[u.cid]=true;if(b){o=o===a?a.attributes:o;if(e.parse)o=u.parse(o,e);u.set(o,e);if(p&&!l&&u.hasChanged(v))l=true}t[r]=u}else if(w){a=t[r]=this._prepareModel(o,e);if(!a)continue;m.push(a);a.on("all",this._onModelEvent,this);this._byId[a.cid]=a;if(a.id!=null)this._byId[a.id]=a}if(E)E.push(u||a)}if(x){for(r=0,s=this.length;r<s;++r){if(!_[(a=this.models[r]).cid])y.push(a)}if(y.length)this.remove(y,e)}if(m.length||E&&E.length){if(p)l=true;this.length+=m.length;if(c!=null){for(r=0,s=m.length;r<s;r++){this.models.splice(c+r,0,m[r])}}else{if(E)this.models.length=0;var T=E||m;for(r=0,s=T.length;r<s;r++){this.models.push(T[r])}}}if(l)this.sort({silent:true});if(!e.silent){for(r=0,s=m.length;r<s;r++){(a=m[r]).trigger("add",a,this,e)}if(l||E&&E.length)this.trigger("sort",this,e)}return i?t[0]:t},reset:function(t,e){e||(e={});for(var i=0,r=this.models.length;i<r;i++){this._removeReference(this.models[i])}e.previousModels=this.models;this._reset();t=this.add(t,h.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return t},push:function(t,e){return this.add(t,h.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){return this.add(t,h.extend({at:0},e))},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(){return s.apply(this.models,arguments)},get:function(t){if(t==null)return void 0;return this._byId[t.id]||this._byId[t.cid]||this._byId[t]},at:function(t){return this.models[t]},where:function(t,e){if(h.isEmpty(t))return e?void 0:[];return this[e?"find":"filter"](function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},findWhere:function(t){return this.where(t,true)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");t||(t={});if(h.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(h.bind(this.comparator,this))}if(!t.silent)this.trigger("sort",this,t);return this},pluck:function(t){return h.invoke(this.models,"get",t)},fetch:function(t){t=t?h.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;var i=this;t.success=function(r){var s=t.reset?"reset":"set";i[s](r,t);if(e)e(i,r,t);i.trigger("sync",i,r,t)};M(this,t);return this.sync("read",this,t)},create:function(t,e){e=e?h.clone(e):{};if(!(t=this._prepareModel(t,e)))return false;if(!e.wait)this.add(t,e);var i=this;var r=e.success;e.success=function(t,e,s){if(s.wait)i.add(t,s);if(r)r(t,e,s)};t.save(null,e);return t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(t,e){if(t instanceof d){if(!t.collection)t.collection=this;return t}e=e?h.clone(e):{};e.collection=this;var i=new this.model(t,e);if(!i.validationError)return i;this.trigger("invalid",this,i.validationError,e);return false},_removeReference:function(t){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,r);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)}});var y=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"];h.each(y,function(t){v.prototype[t]=function(){var e=s.call(arguments);e.unshift(this.models);return h[t].apply(h,e)}});var _=["groupBy","countBy","sortBy"];h.each(_,function(t){v.prototype[t]=function(e,i){var r=h.isFunction(e)?e:function(t){return t.get(e)};return h[t](this.models,r,i)}});var w=a.View=function(t){this.cid=h.uniqueId("view");t||(t={});h.extend(this,h.pick(t,x));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var b=/^(\S+)\s*(.*)$/;var x=["model","collection","el","id","attributes","className","tagName","events"];h.extend(w.prototype,o,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(t,e){if(this.$el)this.undelegateEvents();this.$el=t instanceof a.$?t:a.$(t);this.el=this.$el[0];if(e!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=h.result(this,"events"))))return this;this.undelegateEvents();for(var e in t){var i=t[e];if(!h.isFunction(i))i=this[t[e]];if(!i)continue;var r=e.match(b);var s=r[1],n=r[2];i=h.bind(i,this);s+=".delegateEvents"+this.cid;if(n===""){this.$el.on(s,i)}else{this.$el.on(s,n,i)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(!this.el){var t=h.extend({},h.result(this,"attributes"));if(this.id)t.id=h.result(this,"id");if(this.className)t["class"]=h.result(this,"className");var e=a.$("<"+h.result(this,"tagName")+">").attr(t);this.setElement(e,false)}else{this.setElement(h.result(this,"el"),false)}}});a.sync=function(t,e,i){var r=T[t];h.defaults(i||(i={}),{emulateHTTP:a.emulateHTTP,emulateJSON:a.emulateJSON});var s={type:r,dataType:"json"};if(!i.url){s.url=h.result(e,"url")||U()}if(i.data==null&&e&&(t==="create"||t==="update"||t==="patch")){s.contentType="application/json";s.data=JSON.stringify(i.attrs||e.toJSON(i))}if(i.emulateJSON){s.contentType="application/x-www-form-urlencoded";s.data=s.data?{model:s.data}:{}}if(i.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){s.type="POST";if(i.emulateJSON)s.data._method=r;var n=i.beforeSend;i.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",r);if(n)return n.apply(this,arguments)}}if(s.type!=="GET"&&!i.emulateJSON){s.processData=false}if(s.type==="PATCH"&&E){s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var o=i.xhr=a.ajax(h.extend(s,i));e.trigger("request",e,o,i);return o};var E=typeof window!=="undefined"&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};a.ajax=function(){return a.$.ajax.apply(a.$,arguments)};var k=a.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var S=/\((.*?)\)/g;var $=/(\(\?)?:\w+/g;var H=/\*\w+/g;var A=/[\-{}\[\]+?.,\\\^$|#\s]/g;h.extend(k.prototype,o,{initialize:function(){},route:function(t,e,i){if(!h.isRegExp(t))t=this._routeToRegExp(t);if(h.isFunction(e)){i=e;e=""}if(!i)i=this[e];var r=this;a.history.route(t,function(s){var n=r._extractParameters(t,s);i&&i.apply(r,n);r.trigger.apply(r,["route:"+e].concat(n));r.trigger("route",e,n);a.history.trigger("route",r,e,n)});return this},navigate:function(t,e){a.history.navigate(t,e);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=h.result(this,"routes");var t,e=h.keys(this.routes);while((t=e.pop())!=null){this.route(t,this.routes[t])}},_routeToRegExp:function(t){t=t.replace(A,"\\$&").replace(S,"(?:$1)?").replace($,function(t,e){return e?t:"([^/]+)"}).replace(H,"(.*?)");return new RegExp("^"+t+"$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1);return h.map(i,function(t){return t?decodeURIComponent(t):null})}});var I=a.History=function(){this.handlers=[];h.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var N=/^[#\/]|\s+$/g;var O=/^\/+|\/+$/g;var P=/msie [\w.]+/;var C=/\/$/;var j=/[?#].*$/;I.started=false;h.extend(I.prototype,o,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var i=this.root.replace(C,"");if(!t.indexOf(i))t=t.slice(i.length)}else{t=this.getHash()}}return t.replace(N,"")},start:function(t){if(I.started)throw new Error("Backbone.history has already been started");I.started=true;this.options=h.extend({root:"/"},this.options,t);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment();var i=document.documentMode;var r=P.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);this.root=("/"+this.root+"/").replace(O,"/");if(r&&this._wantsHashChange){this.iframe=a.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(e)}if(this._hasPushState){a.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!r){a.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=e;var s=this.location;var n=s.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!n){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else if(this._hasPushState&&n&&s.hash){this.fragment=this.getHash().replace(N,"");this.history.replaceState({},document.title,this.root+this.fragment+s.search)}}if(!this.options.silent)return this.loadUrl()},stop:function(){a.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);I.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe){e=this.getFragment(this.getHash(this.iframe))}if(e===this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()},loadUrl:function(t){t=this.fragment=this.getFragment(t);return h.any(this.handlers,function(e){if(e.route.test(t)){e.callback(t);return true}})},navigate:function(t,e){if(!I.started)return false;if(!e||e===true)e={trigger:!!e};var i=this.root+(t=this.getFragment(t||""));t=t.replace(j,"");if(this.fragment===t)return;this.fragment=t;if(t===""&&i!=="/")i=i.slice(0,-1);if(this._hasPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace);if(this.iframe&&t!==this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,t,e.replace)}}else{return this.location.assign(i)}if(e.trigger)return this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else{t.hash="#"+e}}});a.history=new I;var R=function(t,e){var i=this;var r;if(t&&h.has(t,"constructor")){r=t.constructor}else{r=function(){return i.apply(this,arguments)}}h.extend(r,i,e);var s=function(){this.constructor=r};s.prototype=i.prototype;r.prototype=new s;if(t)h.extend(r.prototype,t);r.__super__=i.prototype;return r};d.extend=v.extend=k.extend=w.extend=I.extend=R;var U=function(){throw new Error('A "url" property or function must be specified')};var M=function(t,e){var i=e.error;e.error=function(r){if(i)i(t,r,e);t.trigger("error",t,r,e)}}}).call(this);
+//# sourceMappingURL=backbone-min.map
\ No newline at end of file
diff --git a/profiles/commons/libraries/backbone/backbone-min.map b/profiles/commons/libraries/backbone/backbone-min.map
index 5d6ad35..b346c29 100644
--- a/profiles/commons/libraries/backbone/backbone-min.map
+++ b/profiles/commons/libraries/backbone/backbone-min.map
@@ -1 +1 @@
-{"version":3,"file":"backbone-min.js","sources":["backbone.js"],"names":["root","this","previousBackbone","Backbone","array","push","slice","splice","exports","VERSION","_","require","$","jQuery","Zepto","ender","noConflict","emulateHTTP","emulateJSON","Events","on","name","callback","context","eventsApi","_events","events","ctx","once","self","off","apply","arguments","_callback","retain","ev","names","i","l","j","k","keys","length","trigger","args","call","allEvents","all","triggerEvents","stopListening","obj","listeners","_listeners","deleteListener","_listenerId","id","eventSplitter","action","rest","key","concat","test","split","a1","a2","a3","listenMethods","listenTo","listenToOnce","each","implementation","method","uniqueId","bind","unbind","extend","Model","attributes","options","defaults","attrs","cid","pick","modelOptions","parse","result","set","changed","initialize","prototype","validationError","idAttribute","toJSON","clone","sync","get","attr","escape","has","val","unset","changes","silent","changing","prev","current","_validate","_changing","_previousAttributes","isEqual","_pending","clear","hasChanged","isEmpty","changedAttributes","diff","old","previous","previousAttributes","fetch","model","success","resp","wrapError","save","xhr","wait","validate","serverAttrs","isObject","isNew","patch","destroy","collection","url","base","urlError","charAt","encodeURIComponent","constructor","isValid","error","modelMethods","unshift","Collection","models","comparator","_reset","reset","setOptions","add","remove","merge","addOptions","map","isArray","index","_byId","indexOf","_removeReference","existing","sort","at","sortable","sortAttr","isString","toAdd","toRemove","modelMap","_prepareModel","_onModelEvent","previousModels","pop","shift","begin","end","where","first","findWhere","Error","sortBy","sortedIndex","value","iterator","isFunction","pluck","invoke","create","event","methods","attributeMethods","View","_configure","_ensureElement","delegateEvents","delegateEventSplitter","viewOptions","tagName","selector","$el","find","render","setElement","element","delegate","undelegateEvents","el","match","eventName","className","type","methodMap","params","dataType","data","contentType","JSON","stringify","_method","beforeSend","setRequestHeader","processData","window","ActiveXObject","external","msActiveXFilteringEnabled","ajax","update","delete","read","Router","routes","_bindRoutes","optionalParam","namedParam","splatParam","escapeRegExp","route","isRegExp","_routeToRegExp","router","history","fragment","_extractParameters","navigate","replace","optional","RegExp","exec","param","decodeURIComponent","History","handlers","bindAll","location","routeStripper","rootStripper","isExplorer","trailingSlash","started","interval","getHash","href","getFragment","forcePushState","_hasPushState","_wantsHashChange","pathname","substr","start","hashChange","_wantsPushState","pushState","docMode","document","documentMode","oldIE","navigator","userAgent","toLowerCase","iframe","hide","appendTo","contentWindow","checkUrl","_checkUrlInterval","setInterval","loc","atRoot","search","hash","replaceState","title","loadUrl","stop","clearInterval","e","fragmentOverride","matched","any","handler","_updateHash","open","close","assign","protoProps","staticProps","parent","child","Surrogate","__super__"],"mappings":"CAOA,WAOE,GAAIA,MAAOC,IAIX,IAAIC,kBAAmBF,KAAKG,QAG5B,IAAIC,SACJ,IAAIC,MAAOD,MAAMC,IACjB,IAAIC,OAAQF,MAAME,KAClB,IAAIC,QAASH,MAAMG,MAInB,IAAIJ,SACJ,UAAWK,WAAY,YAAa,CAClCL,SAAWK,YACN,CACLL,SAAWH,KAAKG,YAIlBA,SAASM,QAAU,OAGnB,IAAIC,GAAIV,KAAKU,CACb,KAAKA,SAAaC,WAAY,YAAcD,EAAIC,QAAQ,aAIxDR,UAASS,EAAIZ,KAAKa,QAAUb,KAAKc,OAASd,KAAKe,OAASf,KAAKY,CAI7DT,UAASa,WAAa,WACpBhB,KAAKG,SAAWD,gBAChB,OAAOD,MAMTE,UAASc,YAAc,KAMvBd,UAASe,YAAc,KAevB,IAAIC,QAAShB,SAASgB,QAIpBC,GAAI,SAASC,KAAMC,SAAUC,SAC3B,IAAKC,UAAUvB,KAAM,KAAMoB,MAAOC,SAAUC,YAAcD,SAAU,MAAOrB,KAC3EA,MAAKwB,UAAYxB,KAAKwB,WACtB,IAAIC,QAASzB,KAAKwB,QAAQJ,QAAUpB,KAAKwB,QAAQJ,SACjDK,QAAOrB,MAAMiB,SAAUA,SAAUC,QAASA,QAASI,IAAKJ,SAAWtB,MACnE,OAAOA,OAKT2B,KAAM,SAASP,KAAMC,SAAUC,SAC7B,IAAKC,UAAUvB,KAAM,OAAQoB,MAAOC,SAAUC,YAAcD,SAAU,MAAOrB,KAC7E,IAAI4B,MAAO5B,IACX,IAAI2B,MAAOlB,EAAEkB,KAAK,WAChBC,KAAKC,IAAIT,KAAMO,KACfN,UAASS,MAAM9B,KAAM+B,YAEvBJ,MAAKK,UAAYX,QACjB,OAAOrB,MAAKmB,GAAGC,KAAMO,KAAML,UAO7BO,IAAK,SAAST,KAAMC,SAAUC,SAC5B,GAAIW,QAAQC,GAAIT,OAAQU,MAAOC,EAAGC,EAAGC,EAAGC,CACxC,KAAKvC,KAAKwB,UAAYD,UAAUvB,KAAM,MAAOoB,MAAOC,SAAUC,UAAW,MAAOtB,KAChF,KAAKoB,OAASC,WAAaC,QAAS,CAClCtB,KAAKwB,UACL,OAAOxB,MAGTmC,MAAQf,MAAQA,MAAQX,EAAE+B,KAAKxC,KAAKwB,QACpC,KAAKY,EAAI,EAAGC,EAAIF,MAAMM,OAAQL,EAAIC,EAAGD,IAAK,CACxChB,KAAOe,MAAMC,EACb,IAAIX,OAASzB,KAAKwB,QAAQJ,MAAO,CAC/BpB,KAAKwB,QAAQJ,MAAQa,SACrB,IAAIZ,UAAYC,QAAS,CACvB,IAAKgB,EAAI,EAAGC,EAAId,OAAOgB,OAAQH,EAAIC,EAAGD,IAAK,CACzCJ,GAAKT,OAAOa,EACZ,IAAKjB,UAAYA,WAAaa,GAAGb,UAAYA,WAAaa,GAAGb,SAASW,WACjEV,SAAWA,UAAYY,GAAGZ,QAAU,CACvCW,OAAO7B,KAAK8B,MAIlB,IAAKD,OAAOQ,aAAezC,MAAKwB,QAAQJ,OAI5C,MAAOpB,OAOT0C,QAAS,SAAStB,MAChB,IAAKpB,KAAKwB,QAAS,MAAOxB,KAC1B,IAAI2C,MAAOtC,MAAMuC,KAAKb,UAAW,EACjC,KAAKR,UAAUvB,KAAM,UAAWoB,KAAMuB,MAAO,MAAO3C,KACpD,IAAIyB,QAASzB,KAAKwB,QAAQJ,KAC1B,IAAIyB,WAAY7C,KAAKwB,QAAQsB,GAC7B,IAAIrB,OAAQsB,cAActB,OAAQkB,KAClC,IAAIE,UAAWE,cAAcF,UAAWd,UACxC,OAAO/B,OAKTgD,cAAe,SAASC,IAAK7B,KAAMC,UACjC,GAAI6B,WAAYlD,KAAKmD,UACrB,KAAKD,UAAW,MAAOlD,KACvB,IAAIoD,iBAAkBhC,OAASC,QAC/B,UAAWD,QAAS,SAAUC,SAAWrB,IACzC,IAAIiD,KAAMC,cAAgBD,IAAII,aAAeJ,GAC7C,KAAK,GAAIK,MAAMJ,WAAW,CACxBA,UAAUI,IAAIzB,IAAIT,KAAMC,SAAUrB,KAClC,IAAIoD,qBAAuBpD,MAAKmD,WAAWG,IAE7C,MAAOtD,OAMX,IAAIuD,eAAgB,KAKpB,IAAIhC,WAAY,SAAS0B,IAAKO,OAAQpC,KAAMqC,MAC1C,IAAKrC,KAAM,MAAO,KAGlB,UAAWA,QAAS,SAAU,CAC5B,IAAK,GAAIsC,OAAOtC,MAAM,CACpB6B,IAAIO,QAAQ1B,MAAMmB,KAAMS,IAAKtC,KAAKsC,MAAMC,OAAOF,OAEjD,MAAO,OAIT,GAAIF,cAAcK,KAAKxC,MAAO,CAC5B,GAAIe,OAAQf,KAAKyC,MAAMN,cACvB,KAAK,GAAInB,GAAI,EAAGC,EAAIF,MAAMM,OAAQL,EAAIC,EAAGD,IAAK,CAC5Ca,IAAIO,QAAQ1B,MAAMmB,KAAMd,MAAMC,IAAIuB,OAAOF,OAE3C,MAAO,OAGT,MAAO,MAMT,IAAIV,eAAgB,SAAStB,OAAQkB,MACnC,GAAIT,IAAIE,GAAK,EAAGC,EAAIZ,OAAOgB,OAAQqB,GAAKnB,KAAK,GAAIoB,GAAKpB,KAAK,GAAIqB,GAAKrB,KAAK,EACzE,QAAQA,KAAKF,QACX,IAAK,GAAG,QAASL,EAAIC,GAAIH,GAAKT,OAAOW,IAAIf,SAASuB,KAAKV,GAAGR,IAAM,OAChE,KAAK,GAAG,QAASU,EAAIC,GAAIH,GAAKT,OAAOW,IAAIf,SAASuB,KAAKV,GAAGR,IAAKoC,GAAK,OACpE,KAAK,GAAG,QAAS1B,EAAIC,GAAIH,GAAKT,OAAOW,IAAIf,SAASuB,KAAKV,GAAGR,IAAKoC,GAAIC,GAAK,OACxE,KAAK,GAAG,QAAS3B,EAAIC,GAAIH,GAAKT,OAAOW,IAAIf,SAASuB,KAAKV,GAAGR,IAAKoC,GAAIC,GAAIC,GAAK,OAC5E,SAAS,QAAS5B,EAAIC,GAAIH,GAAKT,OAAOW,IAAIf,SAASS,MAAMI,GAAGR,IAAKiB,OAIrE,IAAIsB,gBAAiBC,SAAU,KAAMC,aAAc,OAKnD1D,GAAE2D,KAAKH,cAAe,SAASI,eAAgBC,QAC7CpD,OAAOoD,QAAU,SAASrB,IAAK7B,KAAMC,UACnC,GAAI6B,WAAYlD,KAAKmD,aAAenD,KAAKmD,cACzC,IAAIG,IAAKL,IAAII,cAAgBJ,IAAII,YAAc5C,EAAE8D,SAAS,KAC1DrB,WAAUI,IAAML,GAChB,UAAW7B,QAAS,SAAUC,SAAWrB,IACzCiD,KAAIoB,gBAAgBjD,KAAMC,SAAUrB,KACpC,OAAOA,QAKXkB,QAAOsD,KAAStD,OAAOC,EACvBD,QAAOuD,OAASvD,OAAOW,GAIvBpB,GAAEiE,OAAOxE,SAAUgB,OAYnB,IAAIyD,OAAQzE,SAASyE,MAAQ,SAASC,WAAYC,SAChD,GAAIC,SACJ,IAAIC,OAAQH,cACZC,WAAYA,WACZ7E,MAAKgF,IAAMvE,EAAE8D,SAAS,IACtBvE,MAAK4E,aACLnE,GAAEiE,OAAO1E,KAAMS,EAAEwE,KAAKJ,QAASK,cAC/B,IAAIL,QAAQM,MAAOJ,MAAQ/E,KAAKmF,MAAMJ,MAAOF,YAC7C,IAAIC,SAAWrE,EAAE2E,OAAOpF,KAAM,YAAa,CACzC+E,MAAQtE,EAAEqE,YAAaC,MAAOD,UAEhC9E,KAAKqF,IAAIN,MAAOF,QAChB7E,MAAKsF,UACLtF,MAAKuF,WAAWzD,MAAM9B,KAAM+B,WAI9B,IAAImD,eAAgB,MAAO,UAAW,aAGtCzE,GAAEiE,OAAOC,MAAMa,UAAWtE,QAGxBoE,QAAS,KAGTG,gBAAiB,KAIjBC,YAAa,KAIbH,WAAY,aAGZI,OAAQ,SAASd,SACf,MAAOpE,GAAEmF,MAAM5F,KAAK4E,aAKtBiB,KAAM,WACJ,MAAO3F,UAAS2F,KAAK/D,MAAM9B,KAAM+B,YAInC+D,IAAK,SAASC,MACZ,MAAO/F,MAAK4E,WAAWmB,OAIzBC,OAAQ,SAASD,MACf,MAAOtF,GAAEuF,OAAOhG,KAAK8F,IAAIC,QAK3BE,IAAK,SAASF,MACZ,MAAO/F,MAAK8F,IAAIC,OAAS,MAM3BV,IAAK,SAAS3B,IAAKwC,IAAKrB,SACtB,GAAIkB,MAAMhB,MAAOoB,MAAOC,QAASC,OAAQC,SAAUC,KAAMC,OACzD,IAAI9C,KAAO,KAAM,MAAO1D,KAGxB,UAAW0D,OAAQ,SAAU,CAC3BqB,MAAQrB,GACRmB,SAAUqB,QACL,EACJnB,UAAYrB,KAAOwC,IAGtBrB,UAAYA,WAGZ,KAAK7E,KAAKyG,UAAU1B,MAAOF,SAAU,MAAO,MAG5CsB,OAAkBtB,QAAQsB,KAC1BE,QAAkBxB,QAAQwB,MAC1BD,WACAE,UAAkBtG,KAAK0G,SACvB1G,MAAK0G,UAAa,IAElB,KAAKJ,SAAU,CACbtG,KAAK2G,oBAAsBlG,EAAEmF,MAAM5F,KAAK4E,WACxC5E,MAAKsF,WAEPkB,QAAUxG,KAAK4E,WAAY2B,KAAOvG,KAAK2G,mBAGvC,IAAI3G,KAAK0F,cAAeX,OAAO/E,KAAKsD,GAAKyB,MAAM/E,KAAK0F,YAGpD,KAAKK,OAAQhB,OAAO,CAClBmB,IAAMnB,MAAMgB,KACZ,KAAKtF,EAAEmG,QAAQJ,QAAQT,MAAOG,KAAME,QAAQhG,KAAK2F,KACjD,KAAKtF,EAAEmG,QAAQL,KAAKR,MAAOG,KAAM,CAC/BlG,KAAKsF,QAAQS,MAAQG,QAChB,OACElG,MAAKsF,QAAQS,MAEtBI,YAAeK,SAAQT,MAAQS,QAAQT,MAAQG,IAIjD,IAAKG,OAAQ,CACX,GAAID,QAAQ3D,OAAQzC,KAAK6G,SAAW,IACpC,KAAK,GAAIzE,GAAI,EAAGC,EAAI+D,QAAQ3D,OAAQL,EAAIC,EAAGD,IAAK,CAC9CpC,KAAK0C,QAAQ,UAAY0D,QAAQhE,GAAIpC,KAAMwG,QAAQJ,QAAQhE,IAAKyC,UAMpE,GAAIyB,SAAU,MAAOtG,KACrB,KAAKqG,OAAQ,CACX,MAAOrG,KAAK6G,SAAU,CACpB7G,KAAK6G,SAAW,KAChB7G,MAAK0C,QAAQ,SAAU1C,KAAM6E,UAGjC7E,KAAK6G,SAAW,KAChB7G,MAAK0G,UAAY,KACjB,OAAO1G,OAKTmG,MAAO,SAASJ,KAAMlB,SACpB,MAAO7E,MAAKqF,IAAIU,SAAW,GAAGtF,EAAEiE,UAAWG,SAAUsB,MAAO,SAI9DW,MAAO,SAASjC,SACd,GAAIE,SACJ,KAAK,GAAIrB,OAAO1D,MAAK4E,WAAYG,MAAMrB,SAAY,EACnD,OAAO1D,MAAKqF,IAAIN,MAAOtE,EAAEiE,UAAWG,SAAUsB,MAAO,SAKvDY,WAAY,SAAShB,MACnB,GAAIA,MAAQ,KAAM,OAAQtF,EAAEuG,QAAQhH,KAAKsF,QACzC,OAAO7E,GAAEwF,IAAIjG,KAAKsF,QAASS,OAS7BkB,kBAAmB,SAASC,MAC1B,IAAKA,KAAM,MAAOlH,MAAK+G,aAAetG,EAAEmF,MAAM5F,KAAKsF,SAAW,KAC9D,IAAIY,KAAKZ,QAAU,KACnB,IAAI6B,KAAMnH,KAAK0G,UAAY1G,KAAK2G,oBAAsB3G,KAAK4E,UAC3D,KAAK,GAAImB,QAAQmB,MAAM,CACrB,GAAIzG,EAAEmG,QAAQO,IAAIpB,MAAQG,IAAMgB,KAAKnB,OAAS,UAC7CT,UAAYA,aAAeS,MAAQG,IAEtC,MAAOZ,UAKT8B,SAAU,SAASrB,MACjB,GAAIA,MAAQ,OAAS/F,KAAK2G,oBAAqB,MAAO,KACtD,OAAO3G,MAAK2G,oBAAoBZ,OAKlCsB,mBAAoB,WAClB,MAAO5G,GAAEmF,MAAM5F,KAAK2G,sBAMtBW,MAAO,SAASzC,SACdA,QAAUA,QAAUpE,EAAEmF,MAAMf,WAC5B,IAAIA,QAAQM,YAAe,GAAGN,QAAQM,MAAQ,IAC9C,IAAIoC,OAAQvH,IACZ,IAAIwH,SAAU3C,QAAQ2C,OACtB3C,SAAQ2C,QAAU,SAASC,MACzB,IAAKF,MAAMlC,IAAIkC,MAAMpC,MAAMsC,KAAM5C,SAAUA,SAAU,MAAO,MAC5D,IAAI2C,QAASA,QAAQD,MAAOE,KAAM5C,QAClC0C,OAAM7E,QAAQ,OAAQ6E,MAAOE,KAAM5C,SAErC6C,WAAU1H,KAAM6E,QAChB,OAAO7E,MAAK6F,KAAK,OAAQ7F,KAAM6E,UAMjC8C,KAAM,SAASjE,IAAKwC,IAAKrB,SACvB,GAAIE,OAAOT,OAAQsD,IAAKhD,WAAa5E,KAAK4E,UAG1C,IAAIlB,KAAO,YAAeA,OAAQ,SAAU,CAC1CqB,MAAQrB,GACRmB,SAAUqB,QACL,EACJnB,UAAYrB,KAAOwC,IAItB,GAAInB,SAAWF,UAAYA,QAAQgD,QAAU7H,KAAKqF,IAAIN,MAAOF,SAAU,MAAO,MAE9EA,SAAUpE,EAAEiE,QAAQoD,SAAU,MAAOjD,QAGrC,KAAK7E,KAAKyG,UAAU1B,MAAOF,SAAU,MAAO,MAG5C,IAAIE,OAASF,QAAQgD,KAAM,CACzB7H,KAAK4E,WAAanE,EAAEiE,UAAWE,WAAYG,OAK7C,GAAIF,QAAQM,YAAe,GAAGN,QAAQM,MAAQ,IAC9C,IAAIoC,OAAQvH,IACZ,IAAIwH,SAAU3C,QAAQ2C,OACtB3C,SAAQ2C,QAAU,SAASC,MAEzBF,MAAM3C,WAAaA,UACnB,IAAImD,aAAcR,MAAMpC,MAAMsC,KAAM5C,QACpC,IAAIA,QAAQgD,KAAME,YAActH,EAAEiE,OAAOK,UAAagD,YACtD,IAAItH,EAAEuH,SAASD,eAAiBR,MAAMlC,IAAI0C,YAAalD,SAAU,CAC/D,MAAO,OAET,GAAI2C,QAASA,QAAQD,MAAOE,KAAM5C,QAClC0C,OAAM7E,QAAQ,OAAQ6E,MAAOE,KAAM5C,SAErC6C,WAAU1H,KAAM6E,QAEhBP,QAAStE,KAAKiI,QAAU,SAAYpD,QAAQqD,MAAQ,QAAU,QAC9D,IAAI5D,SAAW,QAASO,QAAQE,MAAQA,KACxC6C,KAAM5H,KAAK6F,KAAKvB,OAAQtE,KAAM6E,QAG9B,IAAIE,OAASF,QAAQgD,KAAM7H,KAAK4E,WAAaA,UAE7C,OAAOgD,MAMTO,QAAS,SAAStD,SAChBA,QAAUA,QAAUpE,EAAEmF,MAAMf,WAC5B,IAAI0C,OAAQvH,IACZ,IAAIwH,SAAU3C,QAAQ2C,OAEtB,IAAIW,SAAU,WACZZ,MAAM7E,QAAQ,UAAW6E,MAAOA,MAAMa,WAAYvD,SAGpDA,SAAQ2C,QAAU,SAASC,MACzB,GAAI5C,QAAQgD,MAAQN,MAAMU,QAASE,SACnC,IAAIX,QAASA,QAAQD,MAAOE,KAAM5C,QAClC,KAAK0C,MAAMU,QAASV,MAAM7E,QAAQ,OAAQ6E,MAAOE,KAAM5C,SAGzD,IAAI7E,KAAKiI,QAAS,CAChBpD,QAAQ2C,SACR,OAAO,OAETE,UAAU1H,KAAM6E,QAEhB,IAAI+C,KAAM5H,KAAK6F,KAAK,SAAU7F,KAAM6E,QACpC,KAAKA,QAAQgD,KAAMM,SACnB,OAAOP,MAMTS,IAAK,WACH,GAAIC,MAAO7H,EAAE2E,OAAOpF,KAAM,YAAcS,EAAE2E,OAAOpF,KAAKoI,WAAY,QAAUG,UAC5E,IAAIvI,KAAKiI,QAAS,MAAOK,KACzB,OAAOA,OAAQA,KAAKE,OAAOF,KAAK7F,OAAS,KAAO,IAAM,GAAK,KAAOgG,mBAAmBzI,KAAKsD,KAK5F6B,MAAO,SAASsC,KAAM5C,SACpB,MAAO4C,OAIT7B,MAAO,WACL,MAAO,IAAI5F,MAAK0I,YAAY1I,KAAK4E,aAInCqD,MAAO,WACL,MAAOjI,MAAKsD,IAAM,MAIpBqF,QAAS,SAAS9D,SAChB,MAAO7E,MAAKyG,aAAchG,EAAEiE,OAAOG,aAAiBiD,SAAU,SAKhErB,UAAW,SAAS1B,MAAOF,SACzB,IAAKA,QAAQiD,WAAa9H,KAAK8H,SAAU,MAAO,KAChD/C,OAAQtE,EAAEiE,UAAW1E,KAAK4E,WAAYG,MACtC,IAAI6D,OAAQ5I,KAAKyF,gBAAkBzF,KAAK8H,SAAS/C,MAAOF,UAAY,IACpE,KAAK+D,MAAO,MAAO,KACnB5I,MAAK0C,QAAQ,UAAW1C,KAAM4I,MAAOnI,EAAEiE,OAAOG,aAAgBY,gBAAiBmD,QAC/E,OAAO,SAMX,IAAIC,eAAgB,OAAQ,SAAU,QAAS,SAAU,OAAQ,OAGjEpI,GAAE2D,KAAKyE,aAAc,SAASvE,QAC5BK,MAAMa,UAAUlB,QAAU,WACxB,GAAI3B,MAAOtC,MAAMuC,KAAKb,UACtBY,MAAKmG,QAAQ9I,KAAK4E,WAClB,OAAOnE,GAAE6D,QAAQxC,MAAMrB,EAAGkC,QAiB9B,IAAIoG,YAAa7I,SAAS6I,WAAa,SAASC,OAAQnE,SACtDA,UAAYA,WACZ,IAAIA,QAAQwD,IAAKrI,KAAKqI,IAAMxD,QAAQwD,GACpC,IAAIxD,QAAQ0C,MAAOvH,KAAKuH,MAAQ1C,QAAQ0C,KACxC,IAAI1C,QAAQoE,iBAAoB,GAAGjJ,KAAKiJ,WAAapE,QAAQoE,UAC7DjJ,MAAKkJ,QACLlJ,MAAKuF,WAAWzD,MAAM9B,KAAM+B,UAC5B,IAAIiH,OAAQhJ,KAAKmJ,MAAMH,OAAQvI,EAAEiE,QAAQ2B,OAAQ,MAAOxB,UAI1D,IAAIuE,aAAcC,IAAK,KAAMC,OAAQ,KAAMC,MAAO,KAClD,IAAIC,aAAcH,IAAK,KAAME,MAAO,MAAOD,OAAQ,MAGnD7I,GAAEiE,OAAOqE,WAAWvD,UAAWtE,QAI7BqG,MAAO5C,MAIPY,WAAY,aAIZI,OAAQ,SAASd,SACf,MAAO7E,MAAKyJ,IAAI,SAASlC,OAAQ,MAAOA,OAAM5B,OAAOd,YAIvDgB,KAAM,WACJ,MAAO3F,UAAS2F,KAAK/D,MAAM9B,KAAM+B,YAInCsH,IAAK,SAASL,OAAQnE,SACpB,MAAO7E,MAAKqF,IAAI2D,OAAQvI,EAAEqE,SAASD,YAAe2E,cAIpDF,OAAQ,SAASN,OAAQnE,SACvBmE,OAASvI,EAAEiJ,QAAQV,QAAUA,OAAO3I,SAAW2I,OAC/CnE,WAAYA,WACZ,IAAIzC,GAAGC,EAAGsH,MAAOpC,KACjB,KAAKnF,EAAI,EAAGC,EAAI2G,OAAOvG,OAAQL,EAAIC,EAAGD,IAAK,CACzCmF,MAAQvH,KAAK8F,IAAIkD,OAAO5G,GACxB,KAAKmF,MAAO,eACLvH,MAAK4J,MAAMrC,MAAMjE,UACjBtD,MAAK4J,MAAMrC,MAAMvC,IACxB2E,OAAQ3J,KAAK6J,QAAQtC,MACrBvH,MAAKgJ,OAAO1I,OAAOqJ,MAAO,EAC1B3J,MAAKyC,QACL,KAAKoC,QAAQwB,OAAQ,CACnBxB,QAAQ8E,MAAQA,KAChBpC,OAAM7E,QAAQ,SAAU6E,MAAOvH,KAAM6E,SAEvC7E,KAAK8J,iBAAiBvC,OAExB,MAAOvH,OAOTqF,IAAK,SAAS2D,OAAQnE,SACpBA,QAAUpE,EAAEqE,SAASD,YAAeuE,WACpC,IAAIvE,QAAQM,MAAO6D,OAAShJ,KAAKmF,MAAM6D,OAAQnE,QAC/C,KAAKpE,EAAEiJ,QAAQV,QAASA,OAASA,QAAUA,UAC3C,IAAI5G,GAAGC,EAAGkF,MAAOxC,MAAOgF,SAAUC,IAClC,IAAIC,IAAKpF,QAAQoF,EACjB,IAAIC,UAAWlK,KAAKiJ,YAAegB,IAAM,MAASpF,QAAQmF,OAAS,KACnE,IAAIG,UAAW1J,EAAE2J,SAASpK,KAAKiJ,YAAcjJ,KAAKiJ,WAAa,IAC/D,IAAIoB,UAAYC,YAAeC,WAI/B,KAAKnI,EAAI,EAAGC,EAAI2G,OAAOvG,OAAQL,EAAIC,EAAGD,IAAK,CACzC,KAAMmF,MAAQvH,KAAKwK,cAAcxB,OAAO5G,GAAIyC,UAAW,QAIvD,IAAIkF,SAAW/J,KAAK8F,IAAIyB,OAAQ,CAC9B,GAAI1C,QAAQyE,OAAQiB,SAASR,SAAS/E,KAAO,IAC7C,IAAIH,QAAQ0E,MAAO,CACjBQ,SAAS1E,IAAIkC,MAAM3C,WAAYC,QAC/B,IAAIqF,WAAaF,MAAQD,SAAShD,WAAWoD,UAAWH,KAAO,UAI5D,IAAInF,QAAQwE,IAAK,CACtBgB,MAAMjK,KAAKmH,MAIXA,OAAMpG,GAAG,MAAOnB,KAAKyK,cAAezK,KACpCA,MAAK4J,MAAMrC,MAAMvC,KAAOuC,KACxB,IAAIA,MAAMjE,IAAM,KAAMtD,KAAK4J,MAAMrC,MAAMjE,IAAMiE,OAKjD,GAAI1C,QAAQyE,OAAQ,CAClB,IAAKlH,EAAI,EAAGC,EAAIrC,KAAKyC,OAAQL,EAAIC,IAAKD,EAAG,CACvC,IAAKmI,UAAUhD,MAAQvH,KAAKgJ,OAAO5G,IAAI4C,KAAMsF,SAASlK,KAAKmH,OAE7D,GAAI+C,SAAS7H,OAAQzC,KAAKsJ,OAAOgB,SAAUzF,SAI7C,GAAIwF,MAAM5H,OAAQ,CAChB,GAAIyH,SAAUF,KAAO,IACrBhK,MAAKyC,QAAU4H,MAAM5H,MACrB,IAAIwH,IAAM,KAAM,CACd3J,OAAOwB,MAAM9B,KAAKgJ,QAASiB,GAAI,GAAGtG,OAAO0G,YACpC,CACLjK,KAAK0B,MAAM9B,KAAKgJ,OAAQqB,QAK5B,GAAIL,KAAMhK,KAAKgK,MAAM3D,OAAQ,MAE7B,IAAIxB,QAAQwB,OAAQ,MAAOrG,KAG3B,KAAKoC,EAAI,EAAGC,EAAIgI,MAAM5H,OAAQL,EAAIC,EAAGD,IAAK,EACvCmF,MAAQ8C,MAAMjI,IAAIM,QAAQ,MAAO6E,MAAOvH,KAAM6E,SAIjD,GAAImF,KAAMhK,KAAK0C,QAAQ,OAAQ1C,KAAM6E,QACrC,OAAO7E,OAOTmJ,MAAO,SAASH,OAAQnE,SACtBA,UAAYA,WACZ,KAAK,GAAIzC,GAAI,EAAGC,EAAIrC,KAAKgJ,OAAOvG,OAAQL,EAAIC,EAAGD,IAAK,CAClDpC,KAAK8J,iBAAiB9J,KAAKgJ,OAAO5G,IAEpCyC,QAAQ6F,eAAiB1K,KAAKgJ,MAC9BhJ,MAAKkJ,QACLlJ,MAAKqJ,IAAIL,OAAQvI,EAAEiE,QAAQ2B,OAAQ,MAAOxB,SAC1C,KAAKA,QAAQwB,OAAQrG,KAAK0C,QAAQ,QAAS1C,KAAM6E,QACjD,OAAO7E,OAITI,KAAM,SAASmH,MAAO1C,SACpB0C,MAAQvH,KAAKwK,cAAcjD,MAAO1C,QAClC7E,MAAKqJ,IAAI9B,MAAO9G,EAAEiE,QAAQuF,GAAIjK,KAAKyC,QAASoC,SAC5C,OAAO0C,QAIToD,IAAK,SAAS9F,SACZ,GAAI0C,OAAQvH,KAAKiK,GAAGjK,KAAKyC,OAAS,EAClCzC,MAAKsJ,OAAO/B,MAAO1C,QACnB,OAAO0C,QAITuB,QAAS,SAASvB,MAAO1C,SACvB0C,MAAQvH,KAAKwK,cAAcjD,MAAO1C,QAClC7E,MAAKqJ,IAAI9B,MAAO9G,EAAEiE,QAAQuF,GAAI,GAAIpF,SAClC,OAAO0C,QAITqD,MAAO,SAAS/F,SACd,GAAI0C,OAAQvH,KAAKiK,GAAG,EACpBjK,MAAKsJ,OAAO/B,MAAO1C,QACnB,OAAO0C,QAITlH,MAAO,SAASwK,MAAOC,KACrB,MAAO9K,MAAKgJ,OAAO3I,MAAMwK,MAAOC,MAIlChF,IAAK,SAAS7C,KACZ,GAAIA,KAAO,KAAM,WAAY,EAC7B,OAAOjD,MAAK4J,MAAM3G,IAAIK,IAAM,KAAOL,IAAIK,GAAKL,IAAI+B,KAAO/B,MAIzDgH,GAAI,SAASN,OACX,MAAO3J,MAAKgJ,OAAOW,QAKrBoB,MAAO,SAAShG,MAAOiG,OACrB,GAAIvK,EAAEuG,QAAQjC,OAAQ,MAAOiG,WAAa,KAC1C,OAAOhL,MAAKgL,MAAQ,OAAS,UAAU,SAASzD,OAC9C,IAAK,GAAI7D,OAAOqB,OAAO,CACrB,GAAIA,MAAMrB,OAAS6D,MAAMzB,IAAIpC,KAAM,MAAO,OAE5C,MAAO,SAMXuH,UAAW,SAASlG,OAClB,MAAO/E,MAAK+K,MAAMhG,MAAO,OAM3BiF,KAAM,SAASnF,SACb,IAAK7E,KAAKiJ,WAAY,KAAM,IAAIiC,OAAM,yCACtCrG,WAAYA,WAGZ,IAAIpE,EAAE2J,SAASpK,KAAKiJ,aAAejJ,KAAKiJ,WAAWxG,SAAW,EAAG,CAC/DzC,KAAKgJ,OAAShJ,KAAKmL,OAAOnL,KAAKiJ,WAAYjJ,UACtC,CACLA,KAAKgJ,OAAOgB,KAAKvJ,EAAE+D,KAAKxE,KAAKiJ,WAAYjJ,OAG3C,IAAK6E,QAAQwB,OAAQrG,KAAK0C,QAAQ,OAAQ1C,KAAM6E,QAChD,OAAO7E,OAKToL,YAAa,SAAS7D,MAAO8D,MAAO/J,SAClC+J,QAAUA,MAAQrL,KAAKiJ,WACvB,IAAIqC,UAAW7K,EAAE8K,WAAWF,OAASA,MAAQ,SAAS9D,OACpD,MAAOA,OAAMzB,IAAIuF,OAEnB,OAAO5K,GAAE2K,YAAYpL,KAAKgJ,OAAQzB,MAAO+D,SAAUhK,UAIrDkK,MAAO,SAASzF,MACd,MAAOtF,GAAEgL,OAAOzL,KAAKgJ,OAAQ,MAAOjD,OAMtCuB,MAAO,SAASzC,SACdA,QAAUA,QAAUpE,EAAEmF,MAAMf,WAC5B,IAAIA,QAAQM,YAAe,GAAGN,QAAQM,MAAQ,IAC9C,IAAIqC,SAAU3C,QAAQ2C,OACtB,IAAIY,YAAapI,IACjB6E,SAAQ2C,QAAU,SAASC,MACzB,GAAInD,QAASO,QAAQsE,MAAQ,QAAU,KACvCf,YAAW9D,QAAQmD,KAAM5C,QACzB,IAAI2C,QAASA,QAAQY,WAAYX,KAAM5C,QACvCuD,YAAW1F,QAAQ,OAAQ0F,WAAYX,KAAM5C,SAE/C6C,WAAU1H,KAAM6E,QAChB,OAAO7E,MAAK6F,KAAK,OAAQ7F,KAAM6E,UAMjC6G,OAAQ,SAASnE,MAAO1C,SACtBA,QAAUA,QAAUpE,EAAEmF,MAAMf,WAC5B,MAAM0C,MAAQvH,KAAKwK,cAAcjD,MAAO1C,UAAW,MAAO,MAC1D,KAAKA,QAAQgD,KAAM7H,KAAKqJ,IAAI9B,MAAO1C,QACnC,IAAIuD,YAAapI,IACjB,IAAIwH,SAAU3C,QAAQ2C,OACtB3C,SAAQ2C,QAAU,SAASC,MACzB,GAAI5C,QAAQgD,KAAMO,WAAWiB,IAAI9B,MAAO1C,QACxC,IAAI2C,QAASA,QAAQD,MAAOE,KAAM5C,SAEpC0C,OAAMI,KAAK,KAAM9C,QACjB,OAAO0C,QAKTpC,MAAO,SAASsC,KAAM5C,SACpB,MAAO4C,OAIT7B,MAAO,WACL,MAAO,IAAI5F,MAAK0I,YAAY1I,KAAKgJ,SAKnCE,OAAQ,WACNlJ,KAAKyC,OAAS,CACdzC,MAAKgJ,SACLhJ,MAAK4J,UAKPY,cAAe,SAASzF,MAAOF,SAC7B,GAAIE,gBAAiBJ,OAAO,CAC1B,IAAKI,MAAMqD,WAAYrD,MAAMqD,WAAapI,IAC1C,OAAO+E,OAETF,UAAYA,WACZA,SAAQuD,WAAapI,IACrB,IAAIuH,OAAQ,GAAIvH,MAAKuH,MAAMxC,MAAOF,QAClC,KAAK0C,MAAMd,UAAU1B,MAAOF,SAAU,CACpC7E,KAAK0C,QAAQ,UAAW1C,KAAM+E,MAAOF,QACrC,OAAO,OAET,MAAO0C,QAITuC,iBAAkB,SAASvC,OACzB,GAAIvH,OAASuH,MAAMa,iBAAmBb,OAAMa,UAC5Cb,OAAM1F,IAAI,MAAO7B,KAAKyK,cAAezK,OAOvCyK,cAAe,SAASkB,MAAOpE,MAAOa,WAAYvD,SAChD,IAAK8G,QAAU,OAASA,QAAU,WAAavD,aAAepI,KAAM,MACpE,IAAI2L,QAAU,UAAW3L,KAAKsJ,OAAO/B,MAAO1C,QAC5C,IAAI0C,OAASoE,QAAU,UAAYpE,MAAM7B,YAAa,OAC7C1F,MAAK4J,MAAMrC,MAAMH,SAASG,MAAM7B,aACvC,IAAI6B,MAAMjE,IAAM,KAAMtD,KAAK4J,MAAMrC,MAAMjE,IAAMiE,MAE/CvH,KAAK0C,QAAQZ,MAAM9B,KAAM+B,aAQ7B,IAAI6J,UAAW,UAAW,OAAQ,MAAO,UAAW,SAAU,QAC5D,SAAU,cAAe,QAAS,OAAQ,SAAU,SAAU,SAC9D,SAAU,QAAS,MAAO,OAAQ,MAAO,UAAW,WAAY,SAChE,MAAO,MAAO,UAAW,OAAQ,QAAS,OAAQ,OAAQ,UAAW,OACrE,OAAQ,OAAQ,OAAQ,UAAW,UAAW,UAAW,cACzD,UAAW,QAGbnL,GAAE2D,KAAKwH,QAAS,SAAStH,QACvByE,WAAWvD,UAAUlB,QAAU,WAC7B,GAAI3B,MAAOtC,MAAMuC,KAAKb,UACtBY,MAAKmG,QAAQ9I,KAAKgJ,OAClB,OAAOvI,GAAE6D,QAAQxC,MAAMrB,EAAGkC,QAK9B,IAAIkJ,mBAAoB,UAAW,UAAW,SAG9CpL,GAAE2D,KAAKyH,iBAAkB,SAASvH,QAChCyE,WAAWvD,UAAUlB,QAAU,SAAS+G,MAAO/J,SAC7C,GAAIgK,UAAW7K,EAAE8K,WAAWF,OAASA,MAAQ,SAAS9D,OACpD,MAAOA,OAAMzB,IAAIuF,OAEnB,OAAO5K,GAAE6D,QAAQtE,KAAKgJ,OAAQsC,SAAUhK,WAiB5C,IAAIwK,MAAO5L,SAAS4L,KAAO,SAASjH,SAClC7E,KAAKgF,IAAMvE,EAAE8D,SAAS,OACtBvE,MAAK+L,WAAWlH,YAChB7E,MAAKgM,gBACLhM,MAAKuF,WAAWzD,MAAM9B,KAAM+B,UAC5B/B,MAAKiM,iBAIP,IAAIC,uBAAwB,gBAG5B,IAAIC,cAAe,QAAS,aAAc,KAAM,KAAM,aAAc,YAAa,UAAW,SAG5F1L,GAAEiE,OAAOoH,KAAKtG,UAAWtE,QAGvBkL,QAAS,MAITzL,EAAG,SAAS0L,UACV,MAAOrM,MAAKsM,IAAIC,KAAKF,WAKvB9G,WAAY,aAKZiH,OAAQ,WACN,MAAOxM,OAKTsJ,OAAQ,WACNtJ,KAAKsM,IAAIhD,QACTtJ,MAAKgD,eACL,OAAOhD,OAKTyM,WAAY,SAASC,QAASC,UAC5B,GAAI3M,KAAKsM,IAAKtM,KAAK4M,kBACnB5M,MAAKsM,IAAMI,kBAAmBxM,UAASS,EAAI+L,QAAUxM,SAASS,EAAE+L,QAChE1M,MAAK6M,GAAK7M,KAAKsM,IAAI,EACnB,IAAIK,WAAa,MAAO3M,KAAKiM,gBAC7B,OAAOjM,OAkBTiM,eAAgB,SAASxK,QACvB,KAAMA,SAAWA,OAAShB,EAAE2E,OAAOpF,KAAM,YAAa,MAAOA,KAC7DA,MAAK4M,kBACL,KAAK,GAAIlJ,OAAOjC,QAAQ,CACtB,GAAI6C,QAAS7C,OAAOiC,IACpB,KAAKjD,EAAE8K,WAAWjH,QAASA,OAAStE,KAAKyB,OAAOiC,KAChD,KAAKY,OAAQ,QAEb,IAAIwI,OAAQpJ,IAAIoJ,MAAMZ,sBACtB,IAAIa,WAAYD,MAAM,GAAIT,SAAWS,MAAM,EAC3CxI,QAAS7D,EAAE+D,KAAKF,OAAQtE,KACxB+M,YAAa,kBAAoB/M,KAAKgF,GACtC,IAAIqH,WAAa,GAAI,CACnBrM,KAAKsM,IAAInL,GAAG4L,UAAWzI,YAClB,CACLtE,KAAKsM,IAAInL,GAAG4L,UAAWV,SAAU/H,SAGrC,MAAOtE,OAMT4M,iBAAkB,WAChB5M,KAAKsM,IAAIzK,IAAI,kBAAoB7B,KAAKgF,IACtC,OAAOhF,OAOT+L,WAAY,SAASlH,SACnB,GAAI7E,KAAK6E,QAASA,QAAUpE,EAAEiE,UAAWjE,EAAE2E,OAAOpF,KAAM,WAAY6E,QACpEpE,GAAEiE,OAAO1E,KAAMS,EAAEwE,KAAKJ,QAASsH,aAC/BnM,MAAK6E,QAAUA,SAOjBmH,eAAgB,WACd,IAAKhM,KAAK6M,GAAI,CACZ,GAAI9H,OAAQtE,EAAEiE,UAAWjE,EAAE2E,OAAOpF,KAAM,cACxC,IAAIA,KAAKsD,GAAIyB,MAAMzB,GAAK7C,EAAE2E,OAAOpF,KAAM,KACvC,IAAIA,KAAKgN,UAAWjI,MAAM,SAAWtE,EAAE2E,OAAOpF,KAAM,YACpD,IAAIsM,KAAMpM,SAASS,EAAE,IAAMF,EAAE2E,OAAOpF,KAAM,WAAa,KAAK+F,KAAKhB,MACjE/E,MAAKyM,WAAWH,IAAK,WAChB,CACLtM,KAAKyM,WAAWhM,EAAE2E,OAAOpF,KAAM,MAAO,UAwB5CE,UAAS2F,KAAO,SAASvB,OAAQiD,MAAO1C,SACtC,GAAIoI,MAAOC,UAAU5I,OAGrB7D,GAAEqE,SAASD,UAAYA,aACrB7D,YAAad,SAASc,YACtBC,YAAaf,SAASe,aAIxB,IAAIkM,SAAUF,KAAMA,KAAMG,SAAU,OAGpC,KAAKvI,QAAQwD,IAAK,CAChB8E,OAAO9E,IAAM5H,EAAE2E,OAAOmC,MAAO,QAAUgB,WAIzC,GAAI1D,QAAQwI,MAAQ,MAAQ9F,QAAUjD,SAAW,UAAYA,SAAW,UAAYA,SAAW,SAAU,CACvG6I,OAAOG,YAAc,kBACrBH,QAAOE,KAAOE,KAAKC,UAAU3I,QAAQE,OAASwC,MAAM5B,OAAOd,UAI7D,GAAIA,QAAQ5D,YAAa,CACvBkM,OAAOG,YAAc,mCACrBH,QAAOE,KAAOF,OAAOE,MAAQ9F,MAAO4F,OAAOE,SAK7C,GAAIxI,QAAQ7D,cAAgBiM,OAAS,OAASA,OAAS,UAAYA,OAAS,SAAU,CACpFE,OAAOF,KAAO,MACd,IAAIpI,QAAQ5D,YAAakM,OAAOE,KAAKI,QAAUR,IAC/C,IAAIS,YAAa7I,QAAQ6I,UACzB7I,SAAQ6I,WAAa,SAAS9F,KAC5BA,IAAI+F,iBAAiB,yBAA0BV,KAC/C,IAAIS,WAAY,MAAOA,YAAW5L,MAAM9B,KAAM+B,YAKlD,GAAIoL,OAAOF,OAAS,QAAUpI,QAAQ5D,YAAa,CACjDkM,OAAOS,YAAc,MAMvB,GAAIT,OAAOF,OAAS,SAAWY,OAAOC,iBAC9BD,OAAOE,UAAYF,OAAOE,SAASC,2BAA4B,CACrEb,OAAOvF,IAAM,WACX,MAAO,IAAIkG,eAAc,sBAK7B,GAAIlG,KAAM/C,QAAQ+C,IAAM1H,SAAS+N,KAAKxN,EAAEiE,OAAOyI,OAAQtI,SACvD0C,OAAM7E,QAAQ,UAAW6E,MAAOK,IAAK/C,QACrC,OAAO+C,KAIT,IAAIsF,YACFxB,OAAU,OACVwC,OAAU,MACVhG,MAAU,QACViG,SAAU,SACVC,KAAU,MAKZlO,UAAS+N,KAAO,WACd,MAAO/N,UAASS,EAAEsN,KAAKnM,MAAM5B,SAASS,EAAGoB,WAQ3C,IAAIsM,QAASnO,SAASmO,OAAS,SAASxJ,SACtCA,UAAYA,WACZ,IAAIA,QAAQyJ,OAAQtO,KAAKsO,OAASzJ,QAAQyJ,MAC1CtO,MAAKuO,aACLvO,MAAKuF,WAAWzD,MAAM9B,KAAM+B,WAK9B,IAAIyM,eAAgB,YACpB,IAAIC,YAAgB,cACpB,IAAIC,YAAgB,QACpB,IAAIC,cAAgB,0BAGpBlO,GAAEiE,OAAO2J,OAAO7I,UAAWtE,QAIzBqE,WAAY,aAQZqJ,MAAO,SAASA,MAAOxN,KAAMC,UAC3B,IAAKZ,EAAEoO,SAASD,OAAQA,MAAQ5O,KAAK8O,eAAeF,MACpD,IAAInO,EAAE8K,WAAWnK,MAAO,CACtBC,SAAWD,IACXA,MAAO,GAET,IAAKC,SAAUA,SAAWrB,KAAKoB,KAC/B,IAAI2N,QAAS/O,IACbE,UAAS8O,QAAQJ,MAAMA,MAAO,SAASK,UACrC,GAAItM,MAAOoM,OAAOG,mBAAmBN,MAAOK,SAC5C5N,WAAYA,SAASS,MAAMiN,OAAQpM,KACnCoM,QAAOrM,QAAQZ,MAAMiN,QAAS,SAAW3N,MAAMuC,OAAOhB,MACtDoM,QAAOrM,QAAQ,QAAStB,KAAMuB,KAC9BzC,UAAS8O,QAAQtM,QAAQ,QAASqM,OAAQ3N,KAAMuB,OAElD,OAAO3C,OAITmP,SAAU,SAASF,SAAUpK,SAC3B3E,SAAS8O,QAAQG,SAASF,SAAUpK,QACpC,OAAO7E,OAMTuO,YAAa,WACX,IAAKvO,KAAKsO,OAAQ,MAClBtO,MAAKsO,OAAS7N,EAAE2E,OAAOpF,KAAM,SAC7B,IAAI4O,OAAON,OAAS7N,EAAE+B,KAAKxC,KAAKsO,OAChC,QAAQM,MAAQN,OAAO3D,QAAU,KAAM,CACrC3K,KAAK4O,MAAMA,MAAO5O,KAAKsO,OAAOM,UAMlCE,eAAgB,SAASF,OACvBA,MAAQA,MAAMQ,QAAQT,aAAc,QACtBS,QAAQZ,cAAe,WACvBY,QAAQX,WAAY,SAAS3B,MAAOuC,UACnC,MAAOA,UAAWvC,MAAQ,YAE3BsC,QAAQV,WAAY,QAClC,OAAO,IAAIY,QAAO,IAAMV,MAAQ,MAMlCM,mBAAoB,SAASN,MAAOK,UAClC,GAAI9B,QAASyB,MAAMW,KAAKN,UAAU5O,MAAM,EACxC,OAAOI,GAAEgJ,IAAI0D,OAAQ,SAASqC,OAC5B,MAAOA,OAAQC,mBAAmBD,OAAS,SAcjD,IAAIE,SAAUxP,SAASwP,QAAU,WAC/B1P,KAAK2P,WACLlP,GAAEmP,QAAQ5P,KAAM,WAGhB,UAAW6N,UAAW,YAAa,CACjC7N,KAAK6P,SAAWhC,OAAOgC,QACvB7P,MAAKgP,QAAUnB,OAAOmB,SAK1B,IAAIc,eAAgB,cAGpB,IAAIC,cAAe,YAGnB,IAAIC,YAAa,aAGjB,IAAIC,eAAgB,KAGpBP,SAAQQ,QAAU,KAGlBzP,GAAEiE,OAAOgL,QAAQlK,UAAWtE,QAI1BiP,SAAU,GAIVC,QAAS,SAASvC,QAChB,GAAIf,QAASe,QAAU7N,MAAM6P,SAASQ,KAAKvD,MAAM,SACjD,OAAOA,OAAQA,MAAM,GAAK,IAK5BwD,YAAa,SAASrB,SAAUsB,gBAC9B,GAAItB,UAAY,KAAM,CACpB,GAAIjP,KAAKwQ,gBAAkBxQ,KAAKyQ,kBAAoBF,eAAgB,CAClEtB,SAAWjP,KAAK6P,SAASa,QACzB,IAAI3Q,MAAOC,KAAKD,KAAKqP,QAAQa,cAAe,GAC5C,KAAKhB,SAASpF,QAAQ9J,MAAOkP,SAAWA,SAAS0B,OAAO5Q,KAAK0C,YACxD,CACLwM,SAAWjP,KAAKoQ,WAGpB,MAAOnB,UAASG,QAAQU,cAAe,KAKzCc,MAAO,SAAS/L,SACd,GAAI6K,QAAQQ,QAAS,KAAM,IAAIhF,OAAM,4CACrCwE,SAAQQ,QAAU,IAIlBlQ,MAAK6E,QAAmBpE,EAAEiE,WAAY3E,KAAM,KAAMC,KAAK6E,QAASA,QAChE7E,MAAKD,KAAmBC,KAAK6E,QAAQ9E,IACrCC,MAAKyQ,iBAAmBzQ,KAAK6E,QAAQgM,aAAe,KACpD7Q,MAAK8Q,kBAAqB9Q,KAAK6E,QAAQkM,SACvC/Q,MAAKwQ,iBAAsBxQ,KAAK6E,QAAQkM,WAAa/Q,KAAKgP,SAAWhP,KAAKgP,QAAQ+B,UAClF,IAAI9B,UAAoBjP,KAAKsQ,aAC7B,IAAIU,SAAoBC,SAASC,YACjC,IAAIC,OAAqBnB,WAAWT,KAAK6B,UAAUC,UAAUC,kBAAoBN,SAAWA,SAAW,EAGvGhR,MAAKD,MAAQ,IAAMC,KAAKD,KAAO,KAAKqP,QAAQW,aAAc,IAE1D,IAAIoB,OAASnR,KAAKyQ,iBAAkB,CAClCzQ,KAAKuR,OAASrR,SAASS,EAAE,+CAA+C6Q,OAAOC,SAAS,QAAQ,GAAGC,aACnG1R,MAAKmP,SAASF,UAKhB,GAAIjP,KAAKwQ,cAAe,CACtBtQ,SAASS,EAAEkN,QAAQ1M,GAAG,WAAYnB,KAAK2R,cAClC,IAAI3R,KAAKyQ,kBAAqB,gBAAkB5C,UAAYsD,MAAO,CACxEjR,SAASS,EAAEkN,QAAQ1M,GAAG,aAAcnB,KAAK2R,cACpC,IAAI3R,KAAKyQ,iBAAkB,CAChCzQ,KAAK4R,kBAAoBC,YAAY7R,KAAK2R,SAAU3R,KAAKmQ,UAK3DnQ,KAAKiP,SAAWA,QAChB,IAAI6C,KAAM9R,KAAK6P,QACf,IAAIkC,QAASD,IAAIpB,SAAStB,QAAQ,SAAU,SAAWpP,KAAKD,IAI5D,IAAIC,KAAKyQ,kBAAoBzQ,KAAK8Q,kBAAoB9Q,KAAKwQ,gBAAkBuB,OAAQ,CACnF/R,KAAKiP,SAAWjP,KAAKsQ,YAAY,KAAM,KACvCtQ,MAAK6P,SAAST,QAAQpP,KAAKD,KAAOC,KAAK6P,SAASmC,OAAS,IAAMhS,KAAKiP,SAEpE,OAAO,UAIF,IAAIjP,KAAK8Q,iBAAmB9Q,KAAKwQ,eAAiBuB,QAAUD,IAAIG,KAAM,CAC3EjS,KAAKiP,SAAWjP,KAAKoQ,UAAUhB,QAAQU,cAAe,GACtD9P,MAAKgP,QAAQkD,gBAAiBjB,SAASkB,MAAOnS,KAAKD,KAAOC,KAAKiP,SAAW6C,IAAIE,QAGhF,IAAKhS,KAAK6E,QAAQwB,OAAQ,MAAOrG,MAAKoS,WAKxCC,KAAM,WACJnS,SAASS,EAAEkN,QAAQhM,IAAI,WAAY7B,KAAK2R,UAAU9P,IAAI,aAAc7B,KAAK2R,SACzEW,eAActS,KAAK4R,kBACnBlC,SAAQQ,QAAU,OAKpBtB,MAAO,SAASA,MAAOvN,UACrBrB,KAAK2P,SAAS7G,SAAS8F,MAAOA,MAAOvN,SAAUA,YAKjDsQ,SAAU,SAASY,GACjB,GAAI/L,SAAUxG,KAAKsQ,aACnB,IAAI9J,UAAYxG,KAAKiP,UAAYjP,KAAKuR,OAAQ,CAC5C/K,QAAUxG,KAAKsQ,YAAYtQ,KAAKoQ,QAAQpQ,KAAKuR,SAE/C,GAAI/K,UAAYxG,KAAKiP,SAAU,MAAO,MACtC,IAAIjP,KAAKuR,OAAQvR,KAAKmP,SAAS3I,QAC/BxG,MAAKoS,WAAapS,KAAKoS,QAAQpS,KAAKoQ,YAMtCgC,QAAS,SAASI,kBAChB,GAAIvD,UAAWjP,KAAKiP,SAAWjP,KAAKsQ,YAAYkC,iBAChD,IAAIC,SAAUhS,EAAEiS,IAAI1S,KAAK2P,SAAU,SAASgD,SAC1C,GAAIA,QAAQ/D,MAAMhL,KAAKqL,UAAW,CAChC0D,QAAQtR,SAAS4N,SACjB,OAAO,QAGX,OAAOwD,UAUTtD,SAAU,SAASF,SAAUpK,SAC3B,IAAK6K,QAAQQ,QAAS,MAAO,MAC7B,KAAKrL,SAAWA,UAAY,KAAMA,SAAWnC,QAASmC,QACtDoK,UAAWjP,KAAKsQ,YAAYrB,UAAY,GACxC,IAAIjP,KAAKiP,WAAaA,SAAU,MAChCjP,MAAKiP,SAAWA,QAChB,IAAI5G,KAAMrI,KAAKD,KAAOkP,QAGtB,IAAIjP,KAAKwQ,cAAe,CACtBxQ,KAAKgP,QAAQnK,QAAQuK,QAAU,eAAiB,gBAAiB6B,SAASkB,MAAO9J,SAI5E,IAAIrI,KAAKyQ,iBAAkB,CAChCzQ,KAAK4S,YAAY5S,KAAK6P,SAAUZ,SAAUpK,QAAQuK,QAClD,IAAIpP,KAAKuR,QAAWtC,WAAajP,KAAKsQ,YAAYtQ,KAAKoQ,QAAQpQ,KAAKuR,SAAW,CAI7E,IAAI1M,QAAQuK,QAASpP,KAAKuR,OAAON,SAAS4B,OAAOC,OACjD9S,MAAK4S,YAAY5S,KAAKuR,OAAO1B,SAAUZ,SAAUpK,QAAQuK,cAKtD,CACL,MAAOpP,MAAK6P,SAASkD,OAAO1K,KAE9B,GAAIxD,QAAQnC,QAAS1C,KAAKoS,QAAQnD,WAKpC2D,YAAa,SAAS/C,SAAUZ,SAAUG,SACxC,GAAIA,QAAS,CACX,GAAIiB,MAAOR,SAASQ,KAAKjB,QAAQ,qBAAsB,GACvDS,UAAST,QAAQiB,KAAO,IAAMpB,cACzB,CAELY,SAASoC,KAAO,IAAMhD,YAO5B/O,UAAS8O,QAAU,GAAIU,QAQvB,IAAIhL,QAAS,SAASsO,WAAYC,aAChC,GAAIC,QAASlT,IACb,IAAImT,MAKJ,IAAIH,YAAcvS,EAAEwF,IAAI+M,WAAY,eAAgB,CAClDG,MAAQH,WAAWtK,gBACd,CACLyK,MAAQ,WAAY,MAAOD,QAAOpR,MAAM9B,KAAM+B,YAIhDtB,EAAEiE,OAAOyO,MAAOD,OAAQD,YAIxB,IAAIG,WAAY,WAAYpT,KAAK0I,YAAcyK,MAC/CC,WAAU5N,UAAY0N,OAAO1N,SAC7B2N,OAAM3N,UAAY,GAAI4N,UAItB,IAAIJ,WAAYvS,EAAEiE,OAAOyO,MAAM3N,UAAWwN,WAI1CG,OAAME,UAAYH,OAAO1N,SAEzB,OAAO2N,OAITxO,OAAMD,OAASqE,WAAWrE,OAAS2J,OAAO3J,OAASoH,KAAKpH,OAASgL,QAAQhL,OAASA,MAGlF,IAAI6D,UAAW,WACb,KAAM,IAAI2C,OAAM,kDAIlB,IAAIxD,WAAY,SAAUH,MAAO1C,SAC/B,GAAI+D,OAAQ/D,QAAQ+D,KACpB/D,SAAQ+D,MAAQ,SAASnB,MACvB,GAAImB,MAAOA,MAAMrB,MAAOE,KAAM5C,QAC9B0C,OAAM7E,QAAQ,QAAS6E,MAAOE,KAAM5C,aAIvCjC,KAAK5C"}
\ No newline at end of file
+{"version":3,"file":"backbone-min.js","sources":["backbone.js"],"names":["root","this","previousBackbone","Backbone","array","push","slice","splice","exports","VERSION","_","require","$","jQuery","Zepto","ender","noConflict","emulateHTTP","emulateJSON","Events","on","name","callback","context","eventsApi","_events","events","ctx","once","self","off","apply","arguments","_callback","retain","ev","names","i","l","j","k","keys","length","trigger","args","call","allEvents","all","triggerEvents","stopListening","obj","listeningTo","_listeningTo","remove","_listenId","id","isEmpty","eventSplitter","action","rest","key","concat","test","split","a1","a2","a3","listenMethods","listenTo","listenToOnce","each","implementation","method","uniqueId","bind","unbind","extend","Model","attributes","options","attrs","cid","collection","parse","defaults","result","set","changed","initialize","prototype","validationError","idAttribute","toJSON","clone","sync","get","attr","escape","has","val","unset","changes","silent","changing","prev","current","_validate","_changing","_previousAttributes","isEqual","_pending","clear","hasChanged","changedAttributes","diff","old","previous","previousAttributes","fetch","model","success","resp","wrapError","save","xhr","validate","wait","serverAttrs","isObject","isNew","patch","destroy","url","base","urlError","charAt","encodeURIComponent","constructor","isValid","error","modelMethods","unshift","Collection","models","comparator","_reset","reset","setOptions","add","merge","addOptions","map","singular","isArray","index","_byId","indexOf","_removeReference","existing","sort","at","targetModel","sortable","sortAttr","isString","toAdd","toRemove","modelMap","order","_prepareModel","_onModelEvent","orderedModels","previousModels","pop","shift","where","first","findWhere","Error","sortBy","pluck","invoke","create","event","methods","attributeMethods","value","iterator","isFunction","View","pick","viewOptions","_ensureElement","delegateEvents","delegateEventSplitter","tagName","selector","$el","find","render","setElement","element","delegate","undelegateEvents","el","match","eventName","className","type","methodMap","params","dataType","data","contentType","JSON","stringify","_method","beforeSend","setRequestHeader","processData","noXhrPatch","ActiveXObject","ajax","window","XMLHttpRequest","dispatchEvent","update","delete","read","Router","routes","_bindRoutes","optionalParam","namedParam","splatParam","escapeRegExp","route","isRegExp","_routeToRegExp","router","history","fragment","_extractParameters","navigate","replace","optional","RegExp","exec","param","decodeURIComponent","History","handlers","bindAll","location","routeStripper","rootStripper","isExplorer","trailingSlash","pathStripper","started","interval","getHash","href","getFragment","forcePushState","_hasPushState","_wantsHashChange","pathname","start","hashChange","_wantsPushState","pushState","docMode","document","documentMode","oldIE","navigator","userAgent","toLowerCase","iframe","hide","appendTo","contentWindow","checkUrl","_checkUrlInterval","setInterval","loc","atRoot","search","hash","replaceState","title","loadUrl","stop","clearInterval","e","any","handler","_updateHash","open","close","assign","protoProps","staticProps","parent","child","Surrogate","__super__"],"mappings":"CAQA,WAOE,GAAIA,GAAOC,IAIX,IAAIC,GAAmBF,EAAKG,QAG5B,IAAIC,KACJ,IAAIC,GAAOD,EAAMC,IACjB,IAAIC,GAAQF,EAAME,KAClB,IAAIC,GAASH,EAAMG,MAInB,IAAIJ,EACJ,UAAWK,WAAY,YAAa,CAClCL,EAAWK,YACN,CACLL,EAAWH,EAAKG,YAIlBA,EAASM,QAAU,OAGnB,IAAIC,GAAIV,EAAKU,CACb,KAAKA,SAAaC,WAAY,YAAcD,EAAIC,QAAQ,aAIxDR,GAASS,EAAIZ,EAAKa,QAAUb,EAAKc,OAASd,EAAKe,OAASf,EAAKY,CAI7DT,GAASa,WAAa,WACpBhB,EAAKG,SAAWD,CAChB,OAAOD,MAMTE,GAASc,YAAc,KAMvBd,GAASe,YAAc,KAevB,IAAIC,GAAShB,EAASgB,QAIpBC,GAAI,SAASC,EAAMC,EAAUC,GAC3B,IAAKC,EAAUvB,KAAM,KAAMoB,GAAOC,EAAUC,MAAcD,EAAU,MAAOrB,KAC3EA,MAAKwB,UAAYxB,KAAKwB,WACtB,IAAIC,GAASzB,KAAKwB,QAAQJ,KAAUpB,KAAKwB,QAAQJ,MACjDK,GAAOrB,MAAMiB,SAAUA,EAAUC,QAASA,EAASI,IAAKJ,GAAWtB,MACnE,OAAOA,OAKT2B,KAAM,SAASP,EAAMC,EAAUC,GAC7B,IAAKC,EAAUvB,KAAM,OAAQoB,GAAOC,EAAUC,MAAcD,EAAU,MAAOrB,KAC7E,IAAI4B,GAAO5B,IACX,IAAI2B,GAAOlB,EAAEkB,KAAK,WAChBC,EAAKC,IAAIT,EAAMO,EACfN,GAASS,MAAM9B,KAAM+B,YAEvBJ,GAAKK,UAAYX,CACjB,OAAOrB,MAAKmB,GAAGC,EAAMO,EAAML,IAO7BO,IAAK,SAAST,EAAMC,EAAUC,GAC5B,GAAIW,GAAQC,EAAIT,EAAQU,EAAOC,EAAGC,EAAGC,EAAGC,CACxC,KAAKvC,KAAKwB,UAAYD,EAAUvB,KAAM,MAAOoB,GAAOC,EAAUC,IAAW,MAAOtB,KAChF,KAAKoB,IAASC,IAAaC,EAAS,CAClCtB,KAAKwB,UACL,OAAOxB,MAETmC,EAAQf,GAAQA,GAAQX,EAAE+B,KAAKxC,KAAKwB,QACpC,KAAKY,EAAI,EAAGC,EAAIF,EAAMM,OAAQL,EAAIC,EAAGD,IAAK,CACxChB,EAAOe,EAAMC,EACb,IAAIX,EAASzB,KAAKwB,QAAQJ,GAAO,CAC/BpB,KAAKwB,QAAQJ,GAAQa,IACrB,IAAIZ,GAAYC,EAAS,CACvB,IAAKgB,EAAI,EAAGC,EAAId,EAAOgB,OAAQH,EAAIC,EAAGD,IAAK,CACzCJ,EAAKT,EAAOa,EACZ,IAAKjB,GAAYA,IAAaa,EAAGb,UAAYA,IAAaa,EAAGb,SAASW,WACjEV,GAAWA,IAAYY,EAAGZ,QAAU,CACvCW,EAAO7B,KAAK8B,KAIlB,IAAKD,EAAOQ,aAAezC,MAAKwB,QAAQJ,IAI5C,MAAOpB,OAOT0C,QAAS,SAAStB,GAChB,IAAKpB,KAAKwB,QAAS,MAAOxB,KAC1B,IAAI2C,GAAOtC,EAAMuC,KAAKb,UAAW,EACjC,KAAKR,EAAUvB,KAAM,UAAWoB,EAAMuB,GAAO,MAAO3C,KACpD,IAAIyB,GAASzB,KAAKwB,QAAQJ,EAC1B,IAAIyB,GAAY7C,KAAKwB,QAAQsB,GAC7B,IAAIrB,EAAQsB,EAActB,EAAQkB,EAClC,IAAIE,EAAWE,EAAcF,EAAWd,UACxC,OAAO/B,OAKTgD,cAAe,SAASC,EAAK7B,EAAMC,GACjC,GAAI6B,GAAclD,KAAKmD,YACvB,KAAKD,EAAa,MAAOlD,KACzB,IAAIoD,IAAUhC,IAASC,CACvB,KAAKA,SAAmBD,KAAS,SAAUC,EAAWrB,IACtD,IAAIiD,GAAMC,MAAkBD,EAAII,WAAaJ,CAC7C,KAAK,GAAIK,KAAMJ,GAAa,CAC1BD,EAAMC,EAAYI,EAClBL,GAAIpB,IAAIT,EAAMC,EAAUrB,KACxB,IAAIoD,GAAU3C,EAAE8C,QAAQN,EAAIzB,eAAiBxB,MAAKmD,aAAaG,GAEjE,MAAOtD,OAMX,IAAIwD,GAAgB,KAKpB,IAAIjC,GAAY,SAAS0B,EAAKQ,EAAQrC,EAAMsC,GAC1C,IAAKtC,EAAM,MAAO,KAGlB,UAAWA,KAAS,SAAU,CAC5B,IAAK,GAAIuC,KAAOvC,GAAM,CACpB6B,EAAIQ,GAAQ3B,MAAMmB,GAAMU,EAAKvC,EAAKuC,IAAMC,OAAOF,IAEjD,MAAO,OAIT,GAAIF,EAAcK,KAAKzC,GAAO,CAC5B,GAAIe,GAAQf,EAAK0C,MAAMN,EACvB,KAAK,GAAIpB,GAAI,EAAGC,EAAIF,EAAMM,OAAQL,EAAIC,EAAGD,IAAK,CAC5Ca,EAAIQ,GAAQ3B,MAAMmB,GAAMd,EAAMC,IAAIwB,OAAOF,IAE3C,MAAO,OAGT,MAAO,MAMT,IAAIX,GAAgB,SAAStB,EAAQkB,GACnC,GAAIT,GAAIE,GAAK,EAAGC,EAAIZ,EAAOgB,OAAQsB,EAAKpB,EAAK,GAAIqB,EAAKrB,EAAK,GAAIsB,EAAKtB,EAAK,EACzE,QAAQA,EAAKF,QACX,IAAK,GAAG,QAASL,EAAIC,GAAIH,EAAKT,EAAOW,IAAIf,SAASuB,KAAKV,EAAGR,IAAM,OAChE,KAAK,GAAG,QAASU,EAAIC,GAAIH,EAAKT,EAAOW,IAAIf,SAASuB,KAAKV,EAAGR,IAAKqC,EAAK,OACpE,KAAK,GAAG,QAAS3B,EAAIC,GAAIH,EAAKT,EAAOW,IAAIf,SAASuB,KAAKV,EAAGR,IAAKqC,EAAIC,EAAK,OACxE,KAAK,GAAG,QAAS5B,EAAIC,GAAIH,EAAKT,EAAOW,IAAIf,SAASuB,KAAKV,EAAGR,IAAKqC,EAAIC,EAAIC,EAAK,OAC5E,SAAS,QAAS7B,EAAIC,GAAIH,EAAKT,EAAOW,IAAIf,SAASS,MAAMI,EAAGR,IAAKiB,IAIrE,IAAIuB,IAAiBC,SAAU,KAAMC,aAAc,OAKnD3D,GAAE4D,KAAKH,EAAe,SAASI,EAAgBC,GAC7CrD,EAAOqD,GAAU,SAAStB,EAAK7B,EAAMC,GACnC,GAAI6B,GAAclD,KAAKmD,eAAiBnD,KAAKmD,gBAC7C,IAAIG,GAAKL,EAAII,YAAcJ,EAAII,UAAY5C,EAAE+D,SAAS,KACtDtB,GAAYI,GAAML,CAClB,KAAK5B,SAAmBD,KAAS,SAAUC,EAAWrB,IACtDiD,GAAIqB,GAAgBlD,EAAMC,EAAUrB,KACpC,OAAOA,QAKXkB,GAAOuD,KAASvD,EAAOC,EACvBD,GAAOwD,OAASxD,EAAOW,GAIvBpB,GAAEkE,OAAOzE,EAAUgB,EAYnB,IAAI0D,GAAQ1E,EAAS0E,MAAQ,SAASC,EAAYC,GAChD,GAAIC,GAAQF,KACZC,KAAYA,KACZ9E,MAAKgF,IAAMvE,EAAE+D,SAAS,IACtBxE,MAAK6E,aACL,IAAIC,EAAQG,WAAYjF,KAAKiF,WAAaH,EAAQG,UAClD,IAAIH,EAAQI,MAAOH,EAAQ/E,KAAKkF,MAAMH,EAAOD,MAC7CC,GAAQtE,EAAE0E,YAAaJ,EAAOtE,EAAE2E,OAAOpF,KAAM,YAC7CA,MAAKqF,IAAIN,EAAOD,EAChB9E,MAAKsF,UACLtF,MAAKuF,WAAWzD,MAAM9B,KAAM+B,WAI9BtB,GAAEkE,OAAOC,EAAMY,UAAWtE,GAGxBoE,QAAS,KAGTG,gBAAiB,KAIjBC,YAAa,KAIbH,WAAY,aAGZI,OAAQ,SAASb,GACf,MAAOrE,GAAEmF,MAAM5F,KAAK6E,aAKtBgB,KAAM,WACJ,MAAO3F,GAAS2F,KAAK/D,MAAM9B,KAAM+B,YAInC+D,IAAK,SAASC,GACZ,MAAO/F,MAAK6E,WAAWkB,IAIzBC,OAAQ,SAASD,GACf,MAAOtF,GAAEuF,OAAOhG,KAAK8F,IAAIC,KAK3BE,IAAK,SAASF,GACZ,MAAO/F,MAAK8F,IAAIC,IAAS,MAM3BV,IAAK,SAAS1B,EAAKuC,EAAKpB,GACtB,GAAIiB,GAAMhB,EAAOoB,EAAOC,EAASC,EAAQC,EAAUC,EAAMC,CACzD,IAAI7C,GAAO,KAAM,MAAO3D,KAGxB,UAAW2D,KAAQ,SAAU,CAC3BoB,EAAQpB,CACRmB,GAAUoB,MACL,EACJnB,MAAYpB,GAAOuC,EAGtBpB,IAAYA,KAGZ,KAAK9E,KAAKyG,UAAU1B,EAAOD,GAAU,MAAO,MAG5CqB,GAAkBrB,EAAQqB,KAC1BE,GAAkBvB,EAAQuB,MAC1BD,KACAE,GAAkBtG,KAAK0G,SACvB1G,MAAK0G,UAAa,IAElB,KAAKJ,EAAU,CACbtG,KAAK2G,oBAAsBlG,EAAEmF,MAAM5F,KAAK6E,WACxC7E,MAAKsF,WAEPkB,EAAUxG,KAAK6E,WAAY0B,EAAOvG,KAAK2G,mBAGvC,IAAI3G,KAAK0F,cAAeX,GAAO/E,KAAKsD,GAAKyB,EAAM/E,KAAK0F,YAGpD,KAAKK,IAAQhB,GAAO,CAClBmB,EAAMnB,EAAMgB,EACZ,KAAKtF,EAAEmG,QAAQJ,EAAQT,GAAOG,GAAME,EAAQhG,KAAK2F,EACjD,KAAKtF,EAAEmG,QAAQL,EAAKR,GAAOG,GAAM,CAC/BlG,KAAKsF,QAAQS,GAAQG,MAChB,OACElG,MAAKsF,QAAQS,GAEtBI,QAAeK,GAAQT,GAAQS,EAAQT,GAAQG,EAIjD,IAAKG,EAAQ,CACX,GAAID,EAAQ3D,OAAQzC,KAAK6G,SAAW,IACpC,KAAK,GAAIzE,GAAI,EAAGC,EAAI+D,EAAQ3D,OAAQL,EAAIC,EAAGD,IAAK,CAC9CpC,KAAK0C,QAAQ,UAAY0D,EAAQhE,GAAIpC,KAAMwG,EAAQJ,EAAQhE,IAAK0C,IAMpE,GAAIwB,EAAU,MAAOtG,KACrB,KAAKqG,EAAQ,CACX,MAAOrG,KAAK6G,SAAU,CACpB7G,KAAK6G,SAAW,KAChB7G,MAAK0C,QAAQ,SAAU1C,KAAM8E,IAGjC9E,KAAK6G,SAAW,KAChB7G,MAAK0G,UAAY,KACjB,OAAO1G,OAKTmG,MAAO,SAASJ,EAAMjB,GACpB,MAAO9E,MAAKqF,IAAIU,MAAW,GAAGtF,EAAEkE,UAAWG,GAAUqB,MAAO,SAI9DW,MAAO,SAAShC,GACd,GAAIC,KACJ,KAAK,GAAIpB,KAAO3D,MAAK6E,WAAYE,EAAMpB,OAAY,EACnD,OAAO3D,MAAKqF,IAAIN,EAAOtE,EAAEkE,UAAWG,GAAUqB,MAAO,SAKvDY,WAAY,SAAShB,GACnB,GAAIA,GAAQ,KAAM,OAAQtF,EAAE8C,QAAQvD,KAAKsF,QACzC,OAAO7E,GAAEwF,IAAIjG,KAAKsF,QAASS,IAS7BiB,kBAAmB,SAASC,GAC1B,IAAKA,EAAM,MAAOjH,MAAK+G,aAAetG,EAAEmF,MAAM5F,KAAKsF,SAAW,KAC9D,IAAIY,GAAKZ,EAAU,KACnB,IAAI4B,GAAMlH,KAAK0G,UAAY1G,KAAK2G,oBAAsB3G,KAAK6E,UAC3D,KAAK,GAAIkB,KAAQkB,GAAM,CACrB,GAAIxG,EAAEmG,QAAQM,EAAInB,GAAQG,EAAMe,EAAKlB,IAAS,UAC7CT,IAAYA,OAAeS,GAAQG,EAEtC,MAAOZ,IAKT6B,SAAU,SAASpB,GACjB,GAAIA,GAAQ,OAAS/F,KAAK2G,oBAAqB,MAAO,KACtD,OAAO3G,MAAK2G,oBAAoBZ,IAKlCqB,mBAAoB,WAClB,MAAO3G,GAAEmF,MAAM5F,KAAK2G,sBAMtBU,MAAO,SAASvC,GACdA,EAAUA,EAAUrE,EAAEmF,MAAMd,KAC5B,IAAIA,EAAQI,YAAe,GAAGJ,EAAQI,MAAQ,IAC9C,IAAIoC,GAAQtH,IACZ,IAAIuH,GAAUzC,EAAQyC,OACtBzC,GAAQyC,QAAU,SAASC,GACzB,IAAKF,EAAMjC,IAAIiC,EAAMpC,MAAMsC,EAAM1C,GAAUA,GAAU,MAAO,MAC5D,IAAIyC,EAASA,EAAQD,EAAOE,EAAM1C,EAClCwC,GAAM5E,QAAQ,OAAQ4E,EAAOE,EAAM1C,GAErC2C,GAAUzH,KAAM8E,EAChB,OAAO9E,MAAK6F,KAAK,OAAQ7F,KAAM8E,IAMjC4C,KAAM,SAAS/D,EAAKuC,EAAKpB,GACvB,GAAIC,GAAOR,EAAQoD,EAAK9C,EAAa7E,KAAK6E,UAG1C,IAAIlB,GAAO,YAAeA,KAAQ,SAAU,CAC1CoB,EAAQpB,CACRmB,GAAUoB,MACL,EACJnB,MAAYpB,GAAOuC,EAGtBpB,EAAUrE,EAAEkE,QAAQiD,SAAU,MAAO9C,EAKrC,IAAIC,IAAUD,EAAQ+C,KAAM,CAC1B,IAAK7H,KAAKqF,IAAIN,EAAOD,GAAU,MAAO,WACjC,CACL,IAAK9E,KAAKyG,UAAU1B,EAAOD,GAAU,MAAO,OAI9C,GAAIC,GAASD,EAAQ+C,KAAM,CACzB7H,KAAK6E,WAAapE,EAAEkE,UAAWE,EAAYE,GAK7C,GAAID,EAAQI,YAAe,GAAGJ,EAAQI,MAAQ,IAC9C,IAAIoC,GAAQtH,IACZ,IAAIuH,GAAUzC,EAAQyC,OACtBzC,GAAQyC,QAAU,SAASC,GAEzBF,EAAMzC,WAAaA,CACnB,IAAIiD,GAAcR,EAAMpC,MAAMsC,EAAM1C,EACpC,IAAIA,EAAQ+C,KAAMC,EAAcrH,EAAEkE,OAAOI,MAAa+C,EACtD,IAAIrH,EAAEsH,SAASD,KAAiBR,EAAMjC,IAAIyC,EAAahD,GAAU,CAC/D,MAAO,OAET,GAAIyC,EAASA,EAAQD,EAAOE,EAAM1C,EAClCwC,GAAM5E,QAAQ,OAAQ4E,EAAOE,EAAM1C,GAErC2C,GAAUzH,KAAM8E,EAEhBP,GAASvE,KAAKgI,QAAU,SAAYlD,EAAQmD,MAAQ,QAAU,QAC9D,IAAI1D,IAAW,QAASO,EAAQC,MAAQA,CACxC4C,GAAM3H,KAAK6F,KAAKtB,EAAQvE,KAAM8E,EAG9B,IAAIC,GAASD,EAAQ+C,KAAM7H,KAAK6E,WAAaA,CAE7C,OAAO8C,IAMTO,QAAS,SAASpD,GAChBA,EAAUA,EAAUrE,EAAEmF,MAAMd,KAC5B,IAAIwC,GAAQtH,IACZ,IAAIuH,GAAUzC,EAAQyC,OAEtB,IAAIW,GAAU,WACZZ,EAAM5E,QAAQ,UAAW4E,EAAOA,EAAMrC,WAAYH,GAGpDA,GAAQyC,QAAU,SAASC,GACzB,GAAI1C,EAAQ+C,MAAQP,EAAMU,QAASE,GACnC,IAAIX,EAASA,EAAQD,EAAOE,EAAM1C,EAClC,KAAKwC,EAAMU,QAASV,EAAM5E,QAAQ,OAAQ4E,EAAOE,EAAM1C,GAGzD,IAAI9E,KAAKgI,QAAS,CAChBlD,EAAQyC,SACR,OAAO,OAETE,EAAUzH,KAAM8E,EAEhB,IAAI6C,GAAM3H,KAAK6F,KAAK,SAAU7F,KAAM8E,EACpC,KAAKA,EAAQ+C,KAAMK,GACnB,OAAOP,IAMTQ,IAAK,WACH,GAAIC,GAAO3H,EAAE2E,OAAOpF,KAAM,YAAcS,EAAE2E,OAAOpF,KAAKiF,WAAY,QAAUoD,GAC5E,IAAIrI,KAAKgI,QAAS,MAAOI,EACzB,OAAOA,IAAQA,EAAKE,OAAOF,EAAK3F,OAAS,KAAO,IAAM,GAAK,KAAO8F,mBAAmBvI,KAAKsD,KAK5F4B,MAAO,SAASsC,EAAM1C,GACpB,MAAO0C,IAIT5B,MAAO,WACL,MAAO,IAAI5F,MAAKwI,YAAYxI,KAAK6E,aAInCmD,MAAO,WACL,MAAOhI,MAAKsD,IAAM,MAIpBmF,QAAS,SAAS3D,GAChB,MAAO9E,MAAKyG,aAAchG,EAAEkE,OAAOG,OAAiB8C,SAAU,SAKhEnB,UAAW,SAAS1B,EAAOD,GACzB,IAAKA,EAAQ8C,WAAa5H,KAAK4H,SAAU,MAAO,KAChD7C,GAAQtE,EAAEkE,UAAW3E,KAAK6E,WAAYE,EACtC,IAAI2D,GAAQ1I,KAAKyF,gBAAkBzF,KAAK4H,SAAS7C,EAAOD,IAAY,IACpE,KAAK4D,EAAO,MAAO,KACnB1I,MAAK0C,QAAQ,UAAW1C,KAAM0I,EAAOjI,EAAEkE,OAAOG,GAAUW,gBAAiBiD,IACzE,OAAO,SAMX,IAAIC,IAAgB,OAAQ,SAAU,QAAS,SAAU,OAAQ,OAGjElI,GAAE4D,KAAKsE,EAAc,SAASpE,GAC5BK,EAAMY,UAAUjB,GAAU,WACxB,GAAI5B,GAAOtC,EAAMuC,KAAKb,UACtBY,GAAKiG,QAAQ5I,KAAK6E,WAClB,OAAOpE,GAAE8D,GAAQzC,MAAMrB,EAAGkC,KAiB9B,IAAIkG,GAAa3I,EAAS2I,WAAa,SAASC,EAAQhE,GACtDA,IAAYA,KACZ,IAAIA,EAAQwC,MAAOtH,KAAKsH,MAAQxC,EAAQwC,KACxC,IAAIxC,EAAQiE,iBAAoB,GAAG/I,KAAK+I,WAAajE,EAAQiE,UAC7D/I,MAAKgJ,QACLhJ,MAAKuF,WAAWzD,MAAM9B,KAAM+B,UAC5B,IAAI+G,EAAQ9I,KAAKiJ,MAAMH,EAAQrI,EAAEkE,QAAQ0B,OAAQ,MAAOvB,IAI1D,IAAIoE,IAAcC,IAAK,KAAM/F,OAAQ,KAAMgG,MAAO,KAClD,IAAIC,IAAcF,IAAK,KAAM/F,OAAQ,MAGrC3C,GAAEkE,OAAOkE,EAAWrD,UAAWtE,GAI7BoG,MAAO1C,EAIPW,WAAY,aAIZI,OAAQ,SAASb,GACf,MAAO9E,MAAKsJ,IAAI,SAAShC,GAAQ,MAAOA,GAAM3B,OAAOb,MAIvDe,KAAM,WACJ,MAAO3F,GAAS2F,KAAK/D,MAAM9B,KAAM+B,YAInCoH,IAAK,SAASL,EAAQhE,GACpB,MAAO9E,MAAKqF,IAAIyD,EAAQrI,EAAEkE,QAAQyE,MAAO,OAAQtE,EAASuE,KAI5DjG,OAAQ,SAAS0F,EAAQhE,GACvB,GAAIyE,IAAY9I,EAAE+I,QAAQV,EAC1BA,GAASS,GAAYT,GAAUrI,EAAEmF,MAAMkD,EACvChE,KAAYA,KACZ,IAAI1C,GAAGC,EAAGoH,EAAOnC,CACjB,KAAKlF,EAAI,EAAGC,EAAIyG,EAAOrG,OAAQL,EAAIC,EAAGD,IAAK,CACzCkF,EAAQwB,EAAO1G,GAAKpC,KAAK8F,IAAIgD,EAAO1G,GACpC,KAAKkF,EAAO,eACLtH,MAAK0J,MAAMpC,EAAMhE,UACjBtD,MAAK0J,MAAMpC,EAAMtC,IACxByE,GAAQzJ,KAAK2J,QAAQrC,EACrBtH,MAAK8I,OAAOxI,OAAOmJ,EAAO,EAC1BzJ,MAAKyC,QACL,KAAKqC,EAAQuB,OAAQ,CACnBvB,EAAQ2E,MAAQA,CAChBnC,GAAM5E,QAAQ,SAAU4E,EAAOtH,KAAM8E,GAEvC9E,KAAK4J,iBAAiBtC,GAExB,MAAOiC,GAAWT,EAAO,GAAKA,GAOhCzD,IAAK,SAASyD,EAAQhE,GACpBA,EAAUrE,EAAE0E,YAAaL,EAASoE,EAClC,IAAIpE,EAAQI,MAAO4D,EAAS9I,KAAKkF,MAAM4D,EAAQhE,EAC/C,IAAIyE,IAAY9I,EAAE+I,QAAQV,EAC1BA,GAASS,EAAYT,GAAUA,MAAgBrI,EAAEmF,MAAMkD,EACvD,IAAI1G,GAAGC,EAAGiB,EAAIgE,EAAOvC,EAAO8E,EAAUC,CACtC,IAAIC,GAAKjF,EAAQiF,EACjB,IAAIC,GAAchK,KAAKsH,KACvB,IAAI2C,GAAWjK,KAAK+I,YAAegB,GAAM,MAASjF,EAAQgF,OAAS,KACnE,IAAII,GAAWzJ,EAAE0J,SAASnK,KAAK+I,YAAc/I,KAAK+I,WAAa,IAC/D,IAAIqB,MAAYC,KAAeC,IAC/B,IAAInB,GAAMrE,EAAQqE,IAAKC,EAAQtE,EAAQsE,MAAOhG,EAAS0B,EAAQ1B,MAC/D,IAAImH,IAASN,GAAYd,GAAO/F,KAAc,KAI9C,KAAKhB,EAAI,EAAGC,EAAIyG,EAAOrG,OAAQL,EAAIC,EAAGD,IAAK,CACzC2C,EAAQ+D,EAAO1G,EACf,IAAI2C,YAAiBH,GAAO,CAC1BtB,EAAKgE,EAAQvC,MACR,CACLzB,EAAKyB,EAAMiF,EAAYxE,UAAUE,aAKnC,GAAImE,EAAW7J,KAAK8F,IAAIxC,GAAK,CAC3B,GAAIF,EAAQkH,EAAST,EAAS7E,KAAO,IACrC,IAAIoE,EAAO,CACTrE,EAAQA,IAAUuC,EAAQA,EAAMzC,WAAaE,CAC7C,IAAID,EAAQI,MAAOH,EAAQ8E,EAAS3E,MAAMH,EAAOD,EACjD+E,GAASxE,IAAIN,EAAOD,EACpB,IAAImF,IAAaH,GAAQD,EAAS9C,WAAWmD,GAAWJ,EAAO,KAEjEhB,EAAO1G,GAAKyH,MAGP,IAAIV,EAAK,CACd7B,EAAQwB,EAAO1G,GAAKpC,KAAKwK,cAAczF,EAAOD,EAC9C,KAAKwC,EAAO,QACZ8C,GAAMhK,KAAKkH,EAIXA,GAAMnG,GAAG,MAAOnB,KAAKyK,cAAezK,KACpCA,MAAK0J,MAAMpC,EAAMtC,KAAOsC,CACxB,IAAIA,EAAMhE,IAAM,KAAMtD,KAAK0J,MAAMpC,EAAMhE,IAAMgE,EAE/C,GAAIiD,EAAOA,EAAMnK,KAAKyJ,GAAYvC,GAIpC,GAAIlE,EAAQ,CACV,IAAKhB,EAAI,EAAGC,EAAIrC,KAAKyC,OAAQL,EAAIC,IAAKD,EAAG,CACvC,IAAKkI,GAAUhD,EAAQtH,KAAK8I,OAAO1G,IAAI4C,KAAMqF,EAASjK,KAAKkH,GAE7D,GAAI+C,EAAS5H,OAAQzC,KAAKoD,OAAOiH,EAAUvF,GAI7C,GAAIsF,EAAM3H,QAAW8H,GAASA,EAAM9H,OAAS,CAC3C,GAAIwH,EAAUH,EAAO,IACrB9J,MAAKyC,QAAU2H,EAAM3H,MACrB,IAAIsH,GAAM,KAAM,CACd,IAAK3H,EAAI,EAAGC,EAAI+H,EAAM3H,OAAQL,EAAIC,EAAGD,IAAK,CACxCpC,KAAK8I,OAAOxI,OAAOyJ,EAAK3H,EAAG,EAAGgI,EAAMhI,SAEjC,CACL,GAAImI,EAAOvK,KAAK8I,OAAOrG,OAAS,CAChC,IAAIiI,GAAgBH,GAASH,CAC7B,KAAKhI,EAAI,EAAGC,EAAIqI,EAAcjI,OAAQL,EAAIC,EAAGD,IAAK,CAChDpC,KAAK8I,OAAO1I,KAAKsK,EAActI,MAMrC,GAAI0H,EAAM9J,KAAK8J,MAAMzD,OAAQ,MAG7B,KAAKvB,EAAQuB,OAAQ,CACnB,IAAKjE,EAAI,EAAGC,EAAI+H,EAAM3H,OAAQL,EAAIC,EAAGD,IAAK,EACvCkF,EAAQ8C,EAAMhI,IAAIM,QAAQ,MAAO4E,EAAOtH,KAAM8E,GAEjD,GAAIgF,GAASS,GAASA,EAAM9H,OAASzC,KAAK0C,QAAQ,OAAQ1C,KAAM8E,GAIlE,MAAOyE,GAAWT,EAAO,GAAKA,GAOhCG,MAAO,SAASH,EAAQhE,GACtBA,IAAYA,KACZ,KAAK,GAAI1C,GAAI,EAAGC,EAAIrC,KAAK8I,OAAOrG,OAAQL,EAAIC,EAAGD,IAAK,CAClDpC,KAAK4J,iBAAiB5J,KAAK8I,OAAO1G,IAEpC0C,EAAQ6F,eAAiB3K,KAAK8I,MAC9B9I,MAAKgJ,QACLF,GAAS9I,KAAKmJ,IAAIL,EAAQrI,EAAEkE,QAAQ0B,OAAQ,MAAOvB,GACnD,KAAKA,EAAQuB,OAAQrG,KAAK0C,QAAQ,QAAS1C,KAAM8E,EACjD,OAAOgE,IAIT1I,KAAM,SAASkH,EAAOxC,GACpB,MAAO9E,MAAKmJ,IAAI7B,EAAO7G,EAAEkE,QAAQoF,GAAI/J,KAAKyC,QAASqC,KAIrD8F,IAAK,SAAS9F,GACZ,GAAIwC,GAAQtH,KAAK+J,GAAG/J,KAAKyC,OAAS,EAClCzC,MAAKoD,OAAOkE,EAAOxC,EACnB,OAAOwC,IAITsB,QAAS,SAAStB,EAAOxC,GACvB,MAAO9E,MAAKmJ,IAAI7B,EAAO7G,EAAEkE,QAAQoF,GAAI,GAAIjF,KAI3C+F,MAAO,SAAS/F,GACd,GAAIwC,GAAQtH,KAAK+J,GAAG,EACpB/J,MAAKoD,OAAOkE,EAAOxC,EACnB,OAAOwC,IAITjH,MAAO,WACL,MAAOA,GAAMyB,MAAM9B,KAAK8I,OAAQ/G,YAIlC+D,IAAK,SAAS7C,GACZ,GAAIA,GAAO,KAAM,WAAY,EAC7B,OAAOjD,MAAK0J,MAAMzG,EAAIK,KAAOtD,KAAK0J,MAAMzG,EAAI+B,MAAQhF,KAAK0J,MAAMzG,IAIjE8G,GAAI,SAASN,GACX,MAAOzJ,MAAK8I,OAAOW,IAKrBqB,MAAO,SAAS/F,EAAOgG,GACrB,GAAItK,EAAE8C,QAAQwB,GAAQ,MAAOgG,OAAa,KAC1C,OAAO/K,MAAK+K,EAAQ,OAAS,UAAU,SAASzD,GAC9C,IAAK,GAAI3D,KAAOoB,GAAO,CACrB,GAAIA,EAAMpB,KAAS2D,EAAMxB,IAAInC,GAAM,MAAO,OAE5C,MAAO,SAMXqH,UAAW,SAASjG,GAClB,MAAO/E,MAAK8K,MAAM/F,EAAO,OAM3B+E,KAAM,SAAShF,GACb,IAAK9E,KAAK+I,WAAY,KAAM,IAAIkC,OAAM,yCACtCnG,KAAYA,KAGZ,IAAIrE,EAAE0J,SAASnK,KAAK+I,aAAe/I,KAAK+I,WAAWtG,SAAW,EAAG,CAC/DzC,KAAK8I,OAAS9I,KAAKkL,OAAOlL,KAAK+I,WAAY/I,UACtC,CACLA,KAAK8I,OAAOgB,KAAKrJ,EAAEgE,KAAKzE,KAAK+I,WAAY/I,OAG3C,IAAK8E,EAAQuB,OAAQrG,KAAK0C,QAAQ,OAAQ1C,KAAM8E,EAChD,OAAO9E,OAITmL,MAAO,SAASpF,GACd,MAAOtF,GAAE2K,OAAOpL,KAAK8I,OAAQ,MAAO/C,IAMtCsB,MAAO,SAASvC,GACdA,EAAUA,EAAUrE,EAAEmF,MAAMd,KAC5B,IAAIA,EAAQI,YAAe,GAAGJ,EAAQI,MAAQ,IAC9C,IAAIqC,GAAUzC,EAAQyC,OACtB,IAAItC,GAAajF,IACjB8E,GAAQyC,QAAU,SAASC,GACzB,GAAIjD,GAASO,EAAQmE,MAAQ,QAAU,KACvChE,GAAWV,GAAQiD,EAAM1C,EACzB,IAAIyC,EAASA,EAAQtC,EAAYuC,EAAM1C,EACvCG,GAAWvC,QAAQ,OAAQuC,EAAYuC,EAAM1C,GAE/C2C,GAAUzH,KAAM8E,EAChB,OAAO9E,MAAK6F,KAAK,OAAQ7F,KAAM8E,IAMjCuG,OAAQ,SAAS/D,EAAOxC,GACtBA,EAAUA,EAAUrE,EAAEmF,MAAMd,KAC5B,MAAMwC,EAAQtH,KAAKwK,cAAclD,EAAOxC,IAAW,MAAO,MAC1D,KAAKA,EAAQ+C,KAAM7H,KAAKmJ,IAAI7B,EAAOxC,EACnC,IAAIG,GAAajF,IACjB,IAAIuH,GAAUzC,EAAQyC,OACtBzC,GAAQyC,QAAU,SAASD,EAAOE,EAAM1C,GACtC,GAAIA,EAAQ+C,KAAM5C,EAAWkE,IAAI7B,EAAOxC,EACxC,IAAIyC,EAASA,EAAQD,EAAOE,EAAM1C,GAEpCwC,GAAMI,KAAK,KAAM5C,EACjB,OAAOwC,IAKTpC,MAAO,SAASsC,EAAM1C,GACpB,MAAO0C,IAIT5B,MAAO,WACL,MAAO,IAAI5F,MAAKwI,YAAYxI,KAAK8I,SAKnCE,OAAQ,WACNhJ,KAAKyC,OAAS,CACdzC,MAAK8I,SACL9I,MAAK0J,UAKPc,cAAe,SAASzF,EAAOD,GAC7B,GAAIC,YAAiBH,GAAO,CAC1B,IAAKG,EAAME,WAAYF,EAAME,WAAajF,IAC1C,OAAO+E,GAETD,EAAUA,EAAUrE,EAAEmF,MAAMd,KAC5BA,GAAQG,WAAajF,IACrB,IAAIsH,GAAQ,GAAItH,MAAKsH,MAAMvC,EAAOD,EAClC,KAAKwC,EAAM7B,gBAAiB,MAAO6B,EACnCtH,MAAK0C,QAAQ,UAAW1C,KAAMsH,EAAM7B,gBAAiBX,EACrD,OAAO,QAIT8E,iBAAkB,SAAStC,GACzB,GAAItH,OAASsH,EAAMrC,iBAAmBqC,GAAMrC,UAC5CqC,GAAMzF,IAAI,MAAO7B,KAAKyK,cAAezK,OAOvCyK,cAAe,SAASa,EAAOhE,EAAOrC,EAAYH,GAChD,IAAKwG,IAAU,OAASA,IAAU,WAAarG,IAAejF,KAAM,MACpE,IAAIsL,IAAU,UAAWtL,KAAKoD,OAAOkE,EAAOxC,EAC5C,IAAIwC,GAASgE,IAAU,UAAYhE,EAAM5B,YAAa,OAC7C1F,MAAK0J,MAAMpC,EAAMH,SAASG,EAAM5B,aACvC,IAAI4B,EAAMhE,IAAM,KAAMtD,KAAK0J,MAAMpC,EAAMhE,IAAMgE,EAE/CtH,KAAK0C,QAAQZ,MAAM9B,KAAM+B,aAQ7B,IAAIwJ,IAAW,UAAW,OAAQ,MAAO,UAAW,SAAU,QAC5D,SAAU,cAAe,QAAS,OAAQ,SAAU,SAAU,SAC9D,SAAU,QAAS,MAAO,OAAQ,MAAO,UAAW,WAAY,SAChE,MAAO,MAAO,UAAW,OAAQ,QAAS,OAAQ,OAAQ,UAAW,OACrE,OAAQ,OAAQ,OAAQ,UAAW,aAAc,UAAW,UAC5D,cAAe,UAAW,QAG5B9K,GAAE4D,KAAKkH,EAAS,SAAShH,GACvBsE,EAAWrD,UAAUjB,GAAU,WAC7B,GAAI5B,GAAOtC,EAAMuC,KAAKb,UACtBY,GAAKiG,QAAQ5I,KAAK8I,OAClB,OAAOrI,GAAE8D,GAAQzC,MAAMrB,EAAGkC,KAK9B,IAAI6I,IAAoB,UAAW,UAAW,SAG9C/K,GAAE4D,KAAKmH,EAAkB,SAASjH,GAChCsE,EAAWrD,UAAUjB,GAAU,SAASkH,EAAOnK,GAC7C,GAAIoK,GAAWjL,EAAEkL,WAAWF,GAASA,EAAQ,SAASnE,GACpD,MAAOA,GAAMxB,IAAI2F,GAEnB,OAAOhL,GAAE8D,GAAQvE,KAAK8I,OAAQ4C,EAAUpK,KAiB5C,IAAIsK,GAAO1L,EAAS0L,KAAO,SAAS9G,GAClC9E,KAAKgF,IAAMvE,EAAE+D,SAAS,OACtBM,KAAYA,KACZrE,GAAEkE,OAAO3E,KAAMS,EAAEoL,KAAK/G,EAASgH,GAC/B9L,MAAK+L,gBACL/L,MAAKuF,WAAWzD,MAAM9B,KAAM+B,UAC5B/B,MAAKgM,iBAIP,IAAIC,GAAwB,gBAG5B,IAAIH,IAAe,QAAS,aAAc,KAAM,KAAM,aAAc,YAAa,UAAW,SAG5FrL,GAAEkE,OAAOiH,EAAKpG,UAAWtE,GAGvBgL,QAAS,MAITvL,EAAG,SAASwL,GACV,MAAOnM,MAAKoM,IAAIC,KAAKF,IAKvB5G,WAAY,aAKZ+G,OAAQ,WACN,MAAOtM,OAKToD,OAAQ,WACNpD,KAAKoM,IAAIhJ,QACTpD,MAAKgD,eACL,OAAOhD,OAKTuM,WAAY,SAASC,EAASC,GAC5B,GAAIzM,KAAKoM,IAAKpM,KAAK0M,kBACnB1M,MAAKoM,IAAMI,YAAmBtM,GAASS,EAAI6L,EAAUtM,EAASS,EAAE6L,EAChExM,MAAK2M,GAAK3M,KAAKoM,IAAI,EACnB,IAAIK,IAAa,MAAOzM,KAAKgM,gBAC7B,OAAOhM,OAkBTgM,eAAgB,SAASvK,GACvB,KAAMA,IAAWA,EAAShB,EAAE2E,OAAOpF,KAAM,YAAa,MAAOA,KAC7DA,MAAK0M,kBACL,KAAK,GAAI/I,KAAOlC,GAAQ,CACtB,GAAI8C,GAAS9C,EAAOkC,EACpB,KAAKlD,EAAEkL,WAAWpH,GAASA,EAASvE,KAAKyB,EAAOkC,GAChD,KAAKY,EAAQ,QAEb,IAAIqI,GAAQjJ,EAAIiJ,MAAMX,EACtB,IAAIY,GAAYD,EAAM,GAAIT,EAAWS,EAAM,EAC3CrI,GAAS9D,EAAEgE,KAAKF,EAAQvE,KACxB6M,IAAa,kBAAoB7M,KAAKgF,GACtC,IAAImH,IAAa,GAAI,CACnBnM,KAAKoM,IAAIjL,GAAG0L,EAAWtI,OAClB,CACLvE,KAAKoM,IAAIjL,GAAG0L,EAAWV,EAAU5H,IAGrC,MAAOvE,OAMT0M,iBAAkB,WAChB1M,KAAKoM,IAAIvK,IAAI,kBAAoB7B,KAAKgF,IACtC,OAAOhF,OAOT+L,eAAgB,WACd,IAAK/L,KAAK2M,GAAI,CACZ,GAAI5H,GAAQtE,EAAEkE,UAAWlE,EAAE2E,OAAOpF,KAAM,cACxC,IAAIA,KAAKsD,GAAIyB,EAAMzB,GAAK7C,EAAE2E,OAAOpF,KAAM,KACvC,IAAIA,KAAK8M,UAAW/H,EAAM,SAAWtE,EAAE2E,OAAOpF,KAAM,YACpD,IAAIoM,GAAMlM,EAASS,EAAE,IAAMF,EAAE2E,OAAOpF,KAAM,WAAa,KAAK+F,KAAKhB,EACjE/E,MAAKuM,WAAWH,EAAK,WAChB,CACLpM,KAAKuM,WAAW9L,EAAE2E,OAAOpF,KAAM,MAAO,UAwB5CE,GAAS2F,KAAO,SAAStB,EAAQ+C,EAAOxC,GACtC,GAAIiI,GAAOC,EAAUzI,EAGrB9D,GAAE0E,SAASL,IAAYA,OACrB9D,YAAad,EAASc,YACtBC,YAAaf,EAASe,aAIxB,IAAIgM,IAAUF,KAAMA,EAAMG,SAAU,OAGpC,KAAKpI,EAAQqD,IAAK,CAChB8E,EAAO9E,IAAM1H,EAAE2E,OAAOkC,EAAO,QAAUe,IAIzC,GAAIvD,EAAQqI,MAAQ,MAAQ7F,IAAU/C,IAAW,UAAYA,IAAW,UAAYA,IAAW,SAAU,CACvG0I,EAAOG,YAAc,kBACrBH,GAAOE,KAAOE,KAAKC,UAAUxI,EAAQC,OAASuC,EAAM3B,OAAOb,IAI7D,GAAIA,EAAQ7D,YAAa,CACvBgM,EAAOG,YAAc,mCACrBH,GAAOE,KAAOF,EAAOE,MAAQ7F,MAAO2F,EAAOE,SAK7C,GAAIrI,EAAQ9D,cAAgB+L,IAAS,OAASA,IAAS,UAAYA,IAAS,SAAU,CACpFE,EAAOF,KAAO,MACd,IAAIjI,EAAQ7D,YAAagM,EAAOE,KAAKI,QAAUR,CAC/C,IAAIS,GAAa1I,EAAQ0I,UACzB1I,GAAQ0I,WAAa,SAAS7F,GAC5BA,EAAI8F,iBAAiB,yBAA0BV,EAC/C,IAAIS,EAAY,MAAOA,GAAW1L,MAAM9B,KAAM+B,YAKlD,GAAIkL,EAAOF,OAAS,QAAUjI,EAAQ7D,YAAa,CACjDgM,EAAOS,YAAc,MAMvB,GAAIT,EAAOF,OAAS,SAAWY,EAAY,CACzCV,EAAOtF,IAAM,WACX,MAAO,IAAIiG,eAAc,sBAK7B,GAAIjG,GAAM7C,EAAQ6C,IAAMzH,EAAS2N,KAAKpN,EAAEkE,OAAOsI,EAAQnI,GACvDwC,GAAM5E,QAAQ,UAAW4E,EAAOK,EAAK7C,EACrC,OAAO6C,GAGT,IAAIgG,SAAoBG,UAAW,eAAiBA,OAAOF,iBAAmBE,OAAOC,iBAAkB,GAAKA,iBAAgBC,cAG5H,IAAIhB,IACF3B,OAAU,OACV4C,OAAU,MACVhG,MAAU,QACViG,SAAU,SACVC,KAAU,MAKZjO,GAAS2N,KAAO,WACd,MAAO3N,GAASS,EAAEkN,KAAK/L,MAAM5B,EAASS,EAAGoB,WAQ3C,IAAIqM,GAASlO,EAASkO,OAAS,SAAStJ,GACtCA,IAAYA,KACZ,IAAIA,EAAQuJ,OAAQrO,KAAKqO,OAASvJ,EAAQuJ,MAC1CrO,MAAKsO,aACLtO,MAAKuF,WAAWzD,MAAM9B,KAAM+B,WAK9B,IAAIwM,GAAgB,YACpB,IAAIC,GAAgB,cACpB,IAAIC,GAAgB,QACpB,IAAIC,GAAgB,0BAGpBjO,GAAEkE,OAAOyJ,EAAO5I,UAAWtE,GAIzBqE,WAAY,aAQZoJ,MAAO,SAASA,EAAOvN,EAAMC,GAC3B,IAAKZ,EAAEmO,SAASD,GAAQA,EAAQ3O,KAAK6O,eAAeF,EACpD,IAAIlO,EAAEkL,WAAWvK,GAAO,CACtBC,EAAWD,CACXA,GAAO,GAET,IAAKC,EAAUA,EAAWrB,KAAKoB,EAC/B,IAAI0N,GAAS9O,IACbE,GAAS6O,QAAQJ,MAAMA,EAAO,SAASK,GACrC,GAAIrM,GAAOmM,EAAOG,mBAAmBN,EAAOK,EAC5C3N,IAAYA,EAASS,MAAMgN,EAAQnM,EACnCmM,GAAOpM,QAAQZ,MAAMgN,GAAS,SAAW1N,GAAMwC,OAAOjB,GACtDmM,GAAOpM,QAAQ,QAAStB,EAAMuB,EAC9BzC,GAAS6O,QAAQrM,QAAQ,QAASoM,EAAQ1N,EAAMuB,IAElD,OAAO3C,OAITkP,SAAU,SAASF,EAAUlK,GAC3B5E,EAAS6O,QAAQG,SAASF,EAAUlK,EACpC,OAAO9E,OAMTsO,YAAa,WACX,IAAKtO,KAAKqO,OAAQ,MAClBrO,MAAKqO,OAAS5N,EAAE2E,OAAOpF,KAAM,SAC7B,IAAI2O,GAAON,EAAS5N,EAAE+B,KAAKxC,KAAKqO,OAChC,QAAQM,EAAQN,EAAOzD,QAAU,KAAM,CACrC5K,KAAK2O,MAAMA,EAAO3O,KAAKqO,OAAOM,MAMlCE,eAAgB,SAASF,GACvBA,EAAQA,EAAMQ,QAAQT,EAAc,QACtBS,QAAQZ,EAAe,WACvBY,QAAQX,EAAY,SAAS5B,EAAOwC,GACnC,MAAOA,GAAWxC,EAAQ,YAE3BuC,QAAQV,EAAY,QAClC,OAAO,IAAIY,QAAO,IAAMV,EAAQ,MAMlCM,mBAAoB,SAASN,EAAOK,GAClC,GAAI/B,GAAS0B,EAAMW,KAAKN,GAAU3O,MAAM,EACxC,OAAOI,GAAE6I,IAAI2D,EAAQ,SAASsC,GAC5B,MAAOA,GAAQC,mBAAmBD,GAAS,SAcjD,IAAIE,GAAUvP,EAASuP,QAAU,WAC/BzP,KAAK0P,WACLjP,GAAEkP,QAAQ3P,KAAM,WAGhB,UAAW8N,UAAW,YAAa,CACjC9N,KAAK4P,SAAW9B,OAAO8B,QACvB5P,MAAK+O,QAAUjB,OAAOiB,SAK1B,IAAIc,GAAgB,cAGpB,IAAIC,GAAe,YAGnB,IAAIC,GAAa,aAGjB,IAAIC,GAAgB,KAGpB,IAAIC,GAAe,SAGnBR,GAAQS,QAAU,KAGlBzP,GAAEkE,OAAO8K,EAAQjK,UAAWtE,GAI1BiP,SAAU,GAIVC,QAAS,SAAStC,GAChB,GAAIlB,IAASkB,GAAU9N,MAAM4P,SAASS,KAAKzD,MAAM,SACjD,OAAOA,GAAQA,EAAM,GAAK,IAK5B0D,YAAa,SAAStB,EAAUuB,GAC9B,GAAIvB,GAAY,KAAM,CACpB,GAAIhP,KAAKwQ,gBAAkBxQ,KAAKyQ,kBAAoBF,EAAgB,CAClEvB,EAAWhP,KAAK4P,SAASc,QACzB,IAAI3Q,GAAOC,KAAKD,KAAKoP,QAAQa,EAAe,GAC5C,KAAKhB,EAASrF,QAAQ5J,GAAOiP,EAAWA,EAAS3O,MAAMN,EAAK0C,YACvD,CACLuM,EAAWhP,KAAKoQ,WAGpB,MAAOpB,GAASG,QAAQU,EAAe,KAKzCc,MAAO,SAAS7L,GACd,GAAI2K,EAAQS,QAAS,KAAM,IAAIjF,OAAM,4CACrCwE,GAAQS,QAAU,IAIlBlQ,MAAK8E,QAAmBrE,EAAEkE,QAAQ5E,KAAM,KAAMC,KAAK8E,QAASA,EAC5D9E,MAAKD,KAAmBC,KAAK8E,QAAQ/E,IACrCC,MAAKyQ,iBAAmBzQ,KAAK8E,QAAQ8L,aAAe,KACpD5Q,MAAK6Q,kBAAqB7Q,KAAK8E,QAAQgM,SACvC9Q,MAAKwQ,iBAAsBxQ,KAAK8E,QAAQgM,WAAa9Q,KAAK+O,SAAW/O,KAAK+O,QAAQ+B,UAClF,IAAI9B,GAAoBhP,KAAKsQ,aAC7B,IAAIS,GAAoBC,SAASC,YACjC,IAAIC,GAAqBnB,EAAWT,KAAK6B,UAAUC,UAAUC,kBAAoBN,GAAWA,GAAW,EAGvG/Q,MAAKD,MAAQ,IAAMC,KAAKD,KAAO,KAAKoP,QAAQW,EAAc,IAE1D,IAAIoB,GAASlR,KAAKyQ,iBAAkB,CAClCzQ,KAAKsR,OAASpR,EAASS,EAAE,+CAA+C4Q,OAAOC,SAAS,QAAQ,GAAGC,aACnGzR,MAAKkP,SAASF,GAKhB,GAAIhP,KAAKwQ,cAAe,CACtBtQ,EAASS,EAAEmN,QAAQ3M,GAAG,WAAYnB,KAAK0R,cAClC,IAAI1R,KAAKyQ,kBAAqB,gBAAkB3C,UAAYoD,EAAO,CACxEhR,EAASS,EAAEmN,QAAQ3M,GAAG,aAAcnB,KAAK0R,cACpC,IAAI1R,KAAKyQ,iBAAkB,CAChCzQ,KAAK2R,kBAAoBC,YAAY5R,KAAK0R,SAAU1R,KAAKmQ,UAK3DnQ,KAAKgP,SAAWA,CAChB,IAAI6C,GAAM7R,KAAK4P,QACf,IAAIkC,GAASD,EAAInB,SAASvB,QAAQ,SAAU,SAAWnP,KAAKD,IAI5D,IAAIC,KAAKyQ,kBAAoBzQ,KAAK6Q,gBAAiB,CAIjD,IAAK7Q,KAAKwQ,gBAAkBsB,EAAQ,CAClC9R,KAAKgP,SAAWhP,KAAKsQ,YAAY,KAAM,KACvCtQ,MAAK4P,SAAST,QAAQnP,KAAKD,KAAOC,KAAK4P,SAASmC,OAAS,IAAM/R,KAAKgP,SAEpE,OAAO,UAIF,IAAIhP,KAAKwQ,eAAiBsB,GAAUD,EAAIG,KAAM,CACnDhS,KAAKgP,SAAWhP,KAAKoQ,UAAUjB,QAAQU,EAAe,GACtD7P,MAAK+O,QAAQkD,gBAAiBjB,SAASkB,MAAOlS,KAAKD,KAAOC,KAAKgP,SAAW6C,EAAIE,SAKlF,IAAK/R,KAAK8E,QAAQuB,OAAQ,MAAOrG,MAAKmS,WAKxCC,KAAM,WACJlS,EAASS,EAAEmN,QAAQjM,IAAI,WAAY7B,KAAK0R,UAAU7P,IAAI,aAAc7B,KAAK0R,SACzEW,eAAcrS,KAAK2R,kBACnBlC,GAAQS,QAAU,OAKpBvB,MAAO,SAASA,EAAOtN,GACrBrB,KAAK0P,SAAS9G,SAAS+F,MAAOA,EAAOtN,SAAUA,KAKjDqQ,SAAU,SAASY,GACjB,GAAI9L,GAAUxG,KAAKsQ,aACnB,IAAI9J,IAAYxG,KAAKgP,UAAYhP,KAAKsR,OAAQ,CAC5C9K,EAAUxG,KAAKsQ,YAAYtQ,KAAKoQ,QAAQpQ,KAAKsR,SAE/C,GAAI9K,IAAYxG,KAAKgP,SAAU,MAAO,MACtC,IAAIhP,KAAKsR,OAAQtR,KAAKkP,SAAS1I,EAC/BxG,MAAKmS,WAMPA,QAAS,SAASnD,GAChBA,EAAWhP,KAAKgP,SAAWhP,KAAKsQ,YAAYtB,EAC5C,OAAOvO,GAAE8R,IAAIvS,KAAK0P,SAAU,SAAS8C,GACnC,GAAIA,EAAQ7D,MAAM9K,KAAKmL,GAAW,CAChCwD,EAAQnR,SAAS2N,EACjB,OAAO,UAYbE,SAAU,SAASF,EAAUlK,GAC3B,IAAK2K,EAAQS,QAAS,MAAO,MAC7B,KAAKpL,GAAWA,IAAY,KAAMA,GAAWpC,UAAWoC,EAExD,IAAIqD,GAAMnI,KAAKD,MAAQiP,EAAWhP,KAAKsQ,YAAYtB,GAAY,IAG/DA,GAAWA,EAASG,QAAQc,EAAc,GAE1C,IAAIjQ,KAAKgP,WAAaA,EAAU,MAChChP,MAAKgP,SAAWA,CAGhB,IAAIA,IAAa,IAAM7G,IAAQ,IAAKA,EAAMA,EAAI9H,MAAM,GAAI,EAGxD,IAAIL,KAAKwQ,cAAe,CACtBxQ,KAAK+O,QAAQjK,EAAQqK,QAAU,eAAiB,gBAAiB6B,SAASkB,MAAO/J,OAI5E,IAAInI,KAAKyQ,iBAAkB,CAChCzQ,KAAKyS,YAAYzS,KAAK4P,SAAUZ,EAAUlK,EAAQqK,QAClD,IAAInP,KAAKsR,QAAWtC,IAAahP,KAAKsQ,YAAYtQ,KAAKoQ,QAAQpQ,KAAKsR,SAAW,CAI7E,IAAIxM,EAAQqK,QAASnP,KAAKsR,OAAON,SAAS0B,OAAOC,OACjD3S,MAAKyS,YAAYzS,KAAKsR,OAAO1B,SAAUZ,EAAUlK,EAAQqK,cAKtD,CACL,MAAOnP,MAAK4P,SAASgD,OAAOzK,GAE9B,GAAIrD,EAAQpC,QAAS,MAAO1C,MAAKmS,QAAQnD,IAK3CyD,YAAa,SAAS7C,EAAUZ,EAAUG,GACxC,GAAIA,EAAS,CACX,GAAIkB,GAAOT,EAASS,KAAKlB,QAAQ,qBAAsB,GACvDS,GAAST,QAAQkB,EAAO,IAAMrB,OACzB,CAELY,EAASoC,KAAO,IAAMhD,KAO5B9O,GAAS6O,QAAU,GAAIU,EAQvB,IAAI9K,GAAS,SAASkO,EAAYC,GAChC,GAAIC,GAAS/S,IACb,IAAIgT,EAKJ,IAAIH,GAAcpS,EAAEwF,IAAI4M,EAAY,eAAgB,CAClDG,EAAQH,EAAWrK,gBACd,CACLwK,EAAQ,WAAY,MAAOD,GAAOjR,MAAM9B,KAAM+B,YAIhDtB,EAAEkE,OAAOqO,EAAOD,EAAQD,EAIxB,IAAIG,GAAY,WAAYjT,KAAKwI,YAAcwK,EAC/CC,GAAUzN,UAAYuN,EAAOvN,SAC7BwN,GAAMxN,UAAY,GAAIyN,EAItB,IAAIJ,EAAYpS,EAAEkE,OAAOqO,EAAMxN,UAAWqN,EAI1CG,GAAME,UAAYH,EAAOvN,SAEzB,OAAOwN,GAITpO,GAAMD,OAASkE,EAAWlE,OAASyJ,EAAOzJ,OAASiH,EAAKjH,OAAS8K,EAAQ9K,OAASA,CAGlF,IAAI0D,GAAW,WACb,KAAM,IAAI4C,OAAM,kDAIlB,IAAIxD,GAAY,SAASH,EAAOxC,GAC9B,GAAI4D,GAAQ5D,EAAQ4D,KACpB5D,GAAQ4D,MAAQ,SAASlB,GACvB,GAAIkB,EAAOA,EAAMpB,EAAOE,EAAM1C,EAC9BwC,GAAM5E,QAAQ,QAAS4E,EAAOE,EAAM1C,OAIvClC,KAAK5C"}
\ No newline at end of file
diff --git a/profiles/commons/libraries/backbone/backbone.js b/profiles/commons/libraries/backbone/backbone.js
index 3512d42..f7783c2 100644
--- a/profiles/commons/libraries/backbone/backbone.js
+++ b/profiles/commons/libraries/backbone/backbone.js
@@ -1,6 +1,7 @@
-//     Backbone.js 1.0.0
+//     Backbone.js 1.1.0
 
-//     (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
+//     (c) 2010-2011 Jeremy Ashkenas, DocumentCloud Inc.
+//     (c) 2011-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 //     Backbone may be freely distributed under the MIT license.
 //     For all details and documentation:
 //     http://backbonejs.org
@@ -34,7 +35,7 @@
   }
 
   // Current version of the library. Keep in sync with `package.json`.
-  Backbone.VERSION = '1.0.0';
+  Backbone.VERSION = '1.1.0';
 
   // Require Underscore, if we're on the server, and it's not already present.
   var _ = root._;
@@ -52,7 +53,7 @@
   };
 
   // Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option
-  // will fake `"PUT"` and `"DELETE"` requests via the `_method` parameter and
+  // will fake `"PATCH"`, `"PUT"` and `"DELETE"` requests via the `_method` parameter and
   // set a `X-Http-Method-Override` header.
   Backbone.emulateHTTP = false;
 
@@ -111,7 +112,6 @@
         this._events = {};
         return this;
       }
-
       names = name ? [name] : _.keys(this._events);
       for (i = 0, l = names.length; i < l; i++) {
         name = names[i];
@@ -151,14 +151,15 @@
     // Tell this object to stop listening to either specific events ... or
     // to every object it's currently listening to.
     stopListening: function(obj, name, callback) {
-      var listeners = this._listeners;
-      if (!listeners) return this;
-      var deleteListener = !name && !callback;
-      if (typeof name === 'object') callback = this;
-      if (obj) (listeners = {})[obj._listenerId] = obj;
-      for (var id in listeners) {
-        listeners[id].off(name, callback, this);
-        if (deleteListener) delete this._listeners[id];
+      var listeningTo = this._listeningTo;
+      if (!listeningTo) return this;
+      var remove = !name && !callback;
+      if (!callback && typeof name === 'object') callback = this;
+      if (obj) (listeningTo = {})[obj._listenId] = obj;
+      for (var id in listeningTo) {
+        obj = listeningTo[id];
+        obj.off(name, callback, this);
+        if (remove || _.isEmpty(obj._events)) delete this._listeningTo[id];
       }
       return this;
     }
@@ -215,10 +216,10 @@
   // listening to.
   _.each(listenMethods, function(implementation, method) {
     Events[method] = function(obj, name, callback) {
-      var listeners = this._listeners || (this._listeners = {});
-      var id = obj._listenerId || (obj._listenerId = _.uniqueId('l'));
-      listeners[id] = obj;
-      if (typeof name === 'object') callback = this;
+      var listeningTo = this._listeningTo || (this._listeningTo = {});
+      var id = obj._listenId || (obj._listenId = _.uniqueId('l'));
+      listeningTo[id] = obj;
+      if (!callback && typeof name === 'object') callback = this;
       obj[implementation](name, callback, this);
       return this;
     };
@@ -243,24 +244,18 @@
   // Create a new model with the specified attributes. A client id (`cid`)
   // is automatically generated and assigned for you.
   var Model = Backbone.Model = function(attributes, options) {
-    var defaults;
     var attrs = attributes || {};
     options || (options = {});
     this.cid = _.uniqueId('c');
     this.attributes = {};
-    _.extend(this, _.pick(options, modelOptions));
+    if (options.collection) this.collection = options.collection;
     if (options.parse) attrs = this.parse(attrs, options) || {};
-    if (defaults = _.result(this, 'defaults')) {
-      attrs = _.defaults({}, attrs, defaults);
-    }
+    attrs = _.defaults({}, attrs, _.result(this, 'defaults'));
     this.set(attrs, options);
     this.changed = {};
     this.initialize.apply(this, arguments);
   };
 
-  // A list of options to be attached directly to the model, if provided.
-  var modelOptions = ['url', 'urlRoot', 'collection'];
-
   // Attach all inheritable methods to the Model prototype.
   _.extend(Model.prototype, Events, {
 
@@ -456,13 +451,16 @@
         (attrs = {})[key] = val;
       }
 
-      // If we're not waiting and attributes exist, save acts as `set(attr).save(null, opts)`.
-      if (attrs && (!options || !options.wait) && !this.set(attrs, options)) return false;
-
       options = _.extend({validate: true}, options);
 
-      // Do not persist invalid models.
-      if (!this._validate(attrs, options)) return false;
+      // If we're not waiting and attributes exist, save acts as
+      // `set(attr).save(null, opts)` with validation. Otherwise, check if
+      // the model will be valid when the attributes, if any, are set.
+      if (attrs && !options.wait) {
+        if (!this.set(attrs, options)) return false;
+      } else {
+        if (!this._validate(attrs, options)) return false;
+      }
 
       // Set temporary attributes if `{wait: true}`.
       if (attrs && options.wait) {
@@ -563,7 +561,7 @@
       attrs = _.extend({}, this.attributes, attrs);
       var error = this.validationError = this.validate(attrs, options) || null;
       if (!error) return true;
-      this.trigger('invalid', this, error, _.extend(options || {}, {validationError: error}));
+      this.trigger('invalid', this, error, _.extend(options, {validationError: error}));
       return false;
     }
 
@@ -596,7 +594,6 @@
   // its models in sort order, as they're added and removed.
   var Collection = Backbone.Collection = function(models, options) {
     options || (options = {});
-    if (options.url) this.url = options.url;
     if (options.model) this.model = options.model;
     if (options.comparator !== void 0) this.comparator = options.comparator;
     this._reset();
@@ -606,7 +603,7 @@
 
   // Default options for `Collection#set`.
   var setOptions = {add: true, remove: true, merge: true};
-  var addOptions = {add: true, merge: false, remove: false};
+  var addOptions = {add: true, remove: false};
 
   // Define the Collection's inheritable methods.
   _.extend(Collection.prototype, Events, {
@@ -632,16 +629,17 @@
 
     // Add a model, or list of models to the set.
     add: function(models, options) {
-      return this.set(models, _.defaults(options || {}, addOptions));
+      return this.set(models, _.extend({merge: false}, options, addOptions));
     },
 
     // Remove a model, or a list of models from the set.
     remove: function(models, options) {
-      models = _.isArray(models) ? models.slice() : [models];
+      var singular = !_.isArray(models);
+      models = singular ? [models] : _.clone(models);
       options || (options = {});
       var i, l, index, model;
       for (i = 0, l = models.length; i < l; i++) {
-        model = this.get(models[i]);
+        model = models[i] = this.get(models[i]);
         if (!model) continue;
         delete this._byId[model.id];
         delete this._byId[model.cid];
@@ -654,7 +652,7 @@
         }
         this._removeReference(model);
       }
-      return this;
+      return singular ? models[0] : models;
     },
 
     // Update a collection by `set`-ing a new list of models, adding new ones,
@@ -662,31 +660,45 @@
     // already exist in the collection, as necessary. Similar to **Model#set**,
     // the core operation for updating the data contained by the collection.
     set: function(models, options) {
-      options = _.defaults(options || {}, setOptions);
+      options = _.defaults({}, options, setOptions);
       if (options.parse) models = this.parse(models, options);
-      if (!_.isArray(models)) models = models ? [models] : [];
-      var i, l, model, attrs, existing, sort;
+      var singular = !_.isArray(models);
+      models = singular ? (models ? [models] : []) : _.clone(models);
+      var i, l, id, model, attrs, existing, sort;
       var at = options.at;
+      var targetModel = this.model;
       var sortable = this.comparator && (at == null) && options.sort !== false;
       var sortAttr = _.isString(this.comparator) ? this.comparator : null;
       var toAdd = [], toRemove = [], modelMap = {};
+      var add = options.add, merge = options.merge, remove = options.remove;
+      var order = !sortable && add && remove ? [] : false;
 
       // Turn bare objects into model references, and prevent invalid models
       // from being added.
       for (i = 0, l = models.length; i < l; i++) {
-        if (!(model = this._prepareModel(models[i], options))) continue;
+        attrs = models[i];
+        if (attrs instanceof Model) {
+          id = model = attrs;
+        } else {
+          id = attrs[targetModel.prototype.idAttribute];
+        }
 
         // If a duplicate is found, prevent it from being added and
         // optionally merge it into the existing model.
-        if (existing = this.get(model)) {
-          if (options.remove) modelMap[existing.cid] = true;
-          if (options.merge) {
-            existing.set(model.attributes, options);
+        if (existing = this.get(id)) {
+          if (remove) modelMap[existing.cid] = true;
+          if (merge) {
+            attrs = attrs === model ? model.attributes : attrs;
+            if (options.parse) attrs = existing.parse(attrs, options);
+            existing.set(attrs, options);
             if (sortable && !sort && existing.hasChanged(sortAttr)) sort = true;
           }
+          models[i] = existing;
 
-        // This is a new model, push it to the `toAdd` list.
-        } else if (options.add) {
+        // If this is a new, valid model, push it to the `toAdd` list.
+        } else if (add) {
+          model = models[i] = this._prepareModel(attrs, options);
+          if (!model) continue;
           toAdd.push(model);
 
           // Listen to added models' events, and index models for lookup by
@@ -695,10 +707,11 @@
           this._byId[model.cid] = model;
           if (model.id != null) this._byId[model.id] = model;
         }
+        if (order) order.push(existing || model);
       }
 
       // Remove nonexistent models if appropriate.
-      if (options.remove) {
+      if (remove) {
         for (i = 0, l = this.length; i < l; ++i) {
           if (!modelMap[(model = this.models[i]).cid]) toRemove.push(model);
         }
@@ -706,29 +719,35 @@
       }
 
       // See if sorting is needed, update `length` and splice in new models.
-      if (toAdd.length) {
+      if (toAdd.length || (order && order.length)) {
         if (sortable) sort = true;
         this.length += toAdd.length;
         if (at != null) {
-          splice.apply(this.models, [at, 0].concat(toAdd));
+          for (i = 0, l = toAdd.length; i < l; i++) {
+            this.models.splice(at + i, 0, toAdd[i]);
+          }
         } else {
-          push.apply(this.models, toAdd);
+          if (order) this.models.length = 0;
+          var orderedModels = order || toAdd;
+          for (i = 0, l = orderedModels.length; i < l; i++) {
+            this.models.push(orderedModels[i]);
+          }
         }
       }
 
       // Silently sort the collection if appropriate.
       if (sort) this.sort({silent: true});
 
-      if (options.silent) return this;
-
-      // Trigger `add` events.
-      for (i = 0, l = toAdd.length; i < l; i++) {
-        (model = toAdd[i]).trigger('add', model, this, options);
+      // Unless silenced, it's time to fire all appropriate add/sort events.
+      if (!options.silent) {
+        for (i = 0, l = toAdd.length; i < l; i++) {
+          (model = toAdd[i]).trigger('add', model, this, options);
+        }
+        if (sort || (order && order.length)) this.trigger('sort', this, options);
       }
-
-      // Trigger `sort` if the collection was sorted.
-      if (sort) this.trigger('sort', this, options);
-      return this;
+      
+      // Return the added (or merged) model (or models).
+      return singular ? models[0] : models;
     },
 
     // When you have more items than you want to add or remove individually,
@@ -742,16 +761,14 @@
       }
       options.previousModels = this.models;
       this._reset();
-      this.add(models, _.extend({silent: true}, options));
+      models = this.add(models, _.extend({silent: true}, options));
       if (!options.silent) this.trigger('reset', this, options);
-      return this;
+      return models;
     },
 
     // Add a model to the end of the collection.
     push: function(model, options) {
-      model = this._prepareModel(model, options);
-      this.add(model, _.extend({at: this.length}, options));
-      return model;
+      return this.add(model, _.extend({at: this.length}, options));
     },
 
     // Remove a model from the end of the collection.
@@ -763,9 +780,7 @@
 
     // Add a model to the beginning of the collection.
     unshift: function(model, options) {
-      model = this._prepareModel(model, options);
-      this.add(model, _.extend({at: 0}, options));
-      return model;
+      return this.add(model, _.extend({at: 0}, options));
     },
 
     // Remove a model from the beginning of the collection.
@@ -776,14 +791,14 @@
     },
 
     // Slice out a sub-array of models from the collection.
-    slice: function(begin, end) {
-      return this.models.slice(begin, end);
+    slice: function() {
+      return slice.apply(this.models, arguments);
     },
 
     // Get a model from the set by id.
     get: function(obj) {
       if (obj == null) return void 0;
-      return this._byId[obj.id != null ? obj.id : obj.cid || obj];
+      return this._byId[obj.id] || this._byId[obj.cid] || this._byId[obj];
     },
 
     // Get the model at the given index.
@@ -827,16 +842,6 @@
       return this;
     },
 
-    // Figure out the smallest index at which a model should be inserted so as
-    // to maintain order.
-    sortedIndex: function(model, value, context) {
-      value || (value = this.comparator);
-      var iterator = _.isFunction(value) ? value : function(model) {
-        return model.get(value);
-      };
-      return _.sortedIndex(this.models, model, iterator, context);
-    },
-
     // Pluck an attribute from each model in the collection.
     pluck: function(attr) {
       return _.invoke(this.models, 'get', attr);
@@ -869,7 +874,7 @@
       if (!options.wait) this.add(model, options);
       var collection = this;
       var success = options.success;
-      options.success = function(resp) {
+      options.success = function(model, resp, options) {
         if (options.wait) collection.add(model, options);
         if (success) success(model, resp, options);
       };
@@ -903,14 +908,12 @@
         if (!attrs.collection) attrs.collection = this;
         return attrs;
       }
-      options || (options = {});
+      options = options ? _.clone(options) : {};
       options.collection = this;
       var model = new this.model(attrs, options);
-      if (!model._validate(attrs, options)) {
-        this.trigger('invalid', this, attrs, options);
-        return false;
-      }
-      return model;
+      if (!model.validationError) return model;
+      this.trigger('invalid', this, model.validationError, options);
+      return false;
     },
 
     // Internal method to sever a model's ties to a collection.
@@ -942,8 +945,8 @@
     'inject', 'reduceRight', 'foldr', 'find', 'detect', 'filter', 'select',
     'reject', 'every', 'all', 'some', 'any', 'include', 'contains', 'invoke',
     'max', 'min', 'toArray', 'size', 'first', 'head', 'take', 'initial', 'rest',
-    'tail', 'drop', 'last', 'without', 'indexOf', 'shuffle', 'lastIndexOf',
-    'isEmpty', 'chain'];
+    'tail', 'drop', 'last', 'without', 'difference', 'indexOf', 'shuffle',
+    'lastIndexOf', 'isEmpty', 'chain'];
 
   // Mix in each Underscore method as a proxy to `Collection#models`.
   _.each(methods, function(method) {
@@ -982,7 +985,8 @@
   // if an existing element is not provided...
   var View = Backbone.View = function(options) {
     this.cid = _.uniqueId('view');
-    this._configure(options || {});
+    options || (options = {});
+    _.extend(this, _.pick(options, viewOptions));
     this._ensureElement();
     this.initialize.apply(this, arguments);
     this.delegateEvents();
@@ -1001,7 +1005,7 @@
     tagName: 'div',
 
     // jQuery delegate for element lookup, scoped to DOM elements within the
-    // current view. This should be prefered to global lookups where possible.
+    // current view. This should be preferred to global lookups where possible.
     $: function(selector) {
       return this.$el.find(selector);
     },
@@ -1041,7 +1045,7 @@
     //
     //     {
     //       'mousedown .title':  'edit',
-    //       'click .button':     'save'
+    //       'click .button':     'save',
     //       'click .open':       function(e) { ... }
     //     }
     //
@@ -1079,16 +1083,6 @@
       return this;
     },
 
-    // Performs the initial configuration of a View with a set of options.
-    // Keys with special meaning *(e.g. model, collection, id, className)* are
-    // attached directly to the view.  See `viewOptions` for an exhaustive
-    // list.
-    _configure: function(options) {
-      if (this.options) options = _.extend({}, _.result(this, 'options'), options);
-      _.extend(this, _.pick(options, viewOptions));
-      this.options = options;
-    },
-
     // Ensure that the View has a DOM element to render into.
     // If `this.el` is a string, pass it through `$()`, take the first
     // matching element, and re-assign it to `el`. Otherwise, create
@@ -1174,8 +1168,7 @@
     // If we're sending a `PATCH` request, and we're in an old Internet Explorer
     // that still has ActiveX enabled by default, override jQuery to use that
     // for XHR instead. Remove this line when jQuery supports `PATCH` on IE8.
-    if (params.type === 'PATCH' && window.ActiveXObject &&
-          !(window.external && window.external.msActiveXFilteringEnabled)) {
+    if (params.type === 'PATCH' && noXhrPatch) {
       params.xhr = function() {
         return new ActiveXObject("Microsoft.XMLHTTP");
       };
@@ -1187,6 +1180,8 @@
     return xhr;
   };
 
+  var noXhrPatch = typeof window !== 'undefined' && !!window.ActiveXObject && !(window.XMLHttpRequest && (new XMLHttpRequest).dispatchEvent);
+
   // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
   var methodMap = {
     'create': 'POST',
@@ -1275,7 +1270,7 @@
     _routeToRegExp: function(route) {
       route = route.replace(escapeRegExp, '\\$&')
                    .replace(optionalParam, '(?:$1)?')
-                   .replace(namedParam, function(match, optional){
+                   .replace(namedParam, function(match, optional) {
                      return optional ? match : '([^\/]+)';
                    })
                    .replace(splatParam, '(.*?)');
@@ -1325,6 +1320,9 @@
   // Cached regex for removing a trailing slash.
   var trailingSlash = /\/$/;
 
+  // Cached regex for stripping urls of hash and query.
+  var pathStripper = /[?#].*$/;
+
   // Has the history handling already been started?
   History.started = false;
 
@@ -1349,7 +1347,7 @@
         if (this._hasPushState || !this._wantsHashChange || forcePushState) {
           fragment = this.location.pathname;
           var root = this.root.replace(trailingSlash, '');
-          if (!fragment.indexOf(root)) fragment = fragment.substr(root.length);
+          if (!fragment.indexOf(root)) fragment = fragment.slice(root.length);
         } else {
           fragment = this.getHash();
         }
@@ -1365,7 +1363,7 @@
 
       // Figure out the initial configuration. Do we need an iframe?
       // Is pushState desired ... is it available?
-      this.options          = _.extend({}, {root: '/'}, this.options, options);
+      this.options          = _.extend({root: '/'}, this.options, options);
       this.root             = this.options.root;
       this._wantsHashChange = this.options.hashChange !== false;
       this._wantsPushState  = !!this.options.pushState;
@@ -1398,19 +1396,25 @@
       var loc = this.location;
       var atRoot = loc.pathname.replace(/[^\/]$/, '$&/') === this.root;
 
-      // If we've started off with a route from a `pushState`-enabled browser,
-      // but we're currently in a browser that doesn't support it...
-      if (this._wantsHashChange && this._wantsPushState && !this._hasPushState && !atRoot) {
-        this.fragment = this.getFragment(null, true);
-        this.location.replace(this.root + this.location.search + '#' + this.fragment);
-        // Return immediately as browser will do redirect to new url
-        return true;
+      // Transition from hashChange to pushState or vice versa if both are
+      // requested.
+      if (this._wantsHashChange && this._wantsPushState) {
+
+        // If we've started off with a route from a `pushState`-enabled
+        // browser, but we're currently in a browser that doesn't support it...
+        if (!this._hasPushState && !atRoot) {
+          this.fragment = this.getFragment(null, true);
+          this.location.replace(this.root + this.location.search + '#' + this.fragment);
+          // Return immediately as browser will do redirect to new url
+          return true;
+
+        // Or if we've started out with a hash-based route, but we're currently
+        // in a browser where it could be `pushState`-based instead...
+        } else if (this._hasPushState && atRoot && loc.hash) {
+          this.fragment = this.getHash().replace(routeStripper, '');
+          this.history.replaceState({}, document.title, this.root + this.fragment + loc.search);
+        }
 
-      // Or if we've started out with a hash-based route, but we're currently
-      // in a browser where it could be `pushState`-based instead...
-      } else if (this._wantsPushState && this._hasPushState && atRoot && loc.hash) {
-        this.fragment = this.getHash().replace(routeStripper, '');
-        this.history.replaceState({}, document.title, this.root + this.fragment + loc.search);
       }
 
       if (!this.options.silent) return this.loadUrl();
@@ -1439,21 +1443,20 @@
       }
       if (current === this.fragment) return false;
       if (this.iframe) this.navigate(current);
-      this.loadUrl() || this.loadUrl(this.getHash());
+      this.loadUrl();
     },
 
     // Attempt to load the current URL fragment. If a route succeeds with a
     // match, returns `true`. If no defined routes matches the fragment,
     // returns `false`.
-    loadUrl: function(fragmentOverride) {
-      var fragment = this.fragment = this.getFragment(fragmentOverride);
-      var matched = _.any(this.handlers, function(handler) {
+    loadUrl: function(fragment) {
+      fragment = this.fragment = this.getFragment(fragment);
+      return _.any(this.handlers, function(handler) {
         if (handler.route.test(fragment)) {
           handler.callback(fragment);
           return true;
         }
       });
-      return matched;
     },
 
     // Save a fragment into the hash history, or replace the URL state if the
@@ -1465,11 +1468,18 @@
     // you wish to modify the current URL without adding an entry to the history.
     navigate: function(fragment, options) {
       if (!History.started) return false;
-      if (!options || options === true) options = {trigger: options};
-      fragment = this.getFragment(fragment || '');
+      if (!options || options === true) options = {trigger: !!options};
+
+      var url = this.root + (fragment = this.getFragment(fragment || ''));
+
+      // Strip the fragment of the query and hash for matching.
+      fragment = fragment.replace(pathStripper, '');
+
       if (this.fragment === fragment) return;
       this.fragment = fragment;
-      var url = this.root + fragment;
+
+      // Don't include a trailing slash on the root.
+      if (fragment === '' && url !== '/') url = url.slice(0, -1);
 
       // If pushState is available, we use it to set the fragment as a real URL.
       if (this._hasPushState) {
@@ -1492,7 +1502,7 @@
       } else {
         return this.location.assign(url);
       }
-      if (options.trigger) this.loadUrl(fragment);
+      if (options.trigger) return this.loadUrl(fragment);
     },
 
     // Update the hash location, either replacing the current entry, or adding
@@ -1560,7 +1570,7 @@
   };
 
   // Wrap an optional error callback with a fallback error event.
-  var wrapError = function (model, options) {
+  var wrapError = function(model, options) {
     var error = options.error;
     options.error = function(resp) {
       if (error) error(model, resp, options);
diff --git a/profiles/commons/libraries/backbone/docs/backbone.html b/profiles/commons/libraries/backbone/docs/backbone.html
index 7c38648..b971c5d 100644
--- a/profiles/commons/libraries/backbone/docs/backbone.html
+++ b/profiles/commons/libraries/backbone/docs/backbone.html
@@ -27,9 +27,10 @@
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-1">&#182;</a>
               </div>
-              <pre><code>Backbone.js 1.0.0
+              <pre><code>Backbone.js 1.1.0
 
-(c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
+(c) 2010-2011 Jeremy Ashkenas, DocumentCloud Inc.
+(c) 2011-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters &amp; Editors
 Backbone may be freely distributed under the MIT license.
 For all details and documentation:
 http://backbonejs.org</code></pre>
@@ -61,8 +62,7 @@ http://backbonejs.org</code></pre>
                 <a class="pilcrow" href="#section-3">&#182;</a>
               </div>
               <p>Save a reference to the global object (<code>window</code> in the browser, <code>exports</code>
-on the server).
-</p>
+on the server).</p>
 
             </div>
             
@@ -78,8 +78,7 @@ on the server).
                 <a class="pilcrow" href="#section-4">&#182;</a>
               </div>
               <p>Save the previous value of the <code>Backbone</code> variable, so that it can be
-restored later on, if <code>noConflict</code> is used.
-</p>
+restored later on, if <code>noConflict</code> is used.</p>
 
             </div>
             
@@ -94,8 +93,7 @@ restored later on, if <code>noConflict</code> is used.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-5">&#182;</a>
               </div>
-              <p>Create local references to array methods we&#39;ll want to use later.
-</p>
+              <p>Create local references to array methods we&#39;ll want to use later.</p>
 
             </div>
             
@@ -114,8 +112,7 @@ restored later on, if <code>noConflict</code> is used.
                 <a class="pilcrow" href="#section-6">&#182;</a>
               </div>
               <p>The top-level namespace. All public Backbone classes and modules will
-be attached to this. Exported for both the browser and the server.
-</p>
+be attached to this. Exported for both the browser and the server.</p>
 
             </div>
             
@@ -135,12 +132,11 @@ be attached to this. Exported for both the browser and the server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-7">&#182;</a>
               </div>
-              <p>Current version of the library. Keep in sync with <code>package.json</code>.
-</p>
+              <p>Current version of the library. Keep in sync with <code>package.json</code>.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>  Backbone.VERSION = <span class="string">'1.0.0'</span>;</pre></div></div>
+            <div class="content"><div class='highlight'><pre>  Backbone.VERSION = <span class="string">'1.1.0'</span>;</pre></div></div>
             
         </li>
         
@@ -151,8 +147,7 @@ be attached to this. Exported for both the browser and the server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-8">&#182;</a>
               </div>
-              <p>Require Underscore, if we&#39;re on the server, and it&#39;s not already present.
-</p>
+              <p>Require Underscore, if we&#39;re on the server, and it&#39;s not already present.</p>
 
             </div>
             
@@ -169,8 +164,7 @@ be attached to this. Exported for both the browser and the server.
                 <a class="pilcrow" href="#section-9">&#182;</a>
               </div>
               <p>For Backbone&#39;s purposes, jQuery, Zepto, Ender, or My Library (kidding) owns
-the <code>$</code> variable.
-</p>
+the <code>$</code> variable.</p>
 
             </div>
             
@@ -186,8 +180,7 @@ the <code>$</code> variable.
                 <a class="pilcrow" href="#section-10">&#182;</a>
               </div>
               <p>Runs Backbone.js in <em>noConflict</em> mode, returning the <code>Backbone</code> variable
-to its previous owner. Returns a reference to this Backbone object.
-</p>
+to its previous owner. Returns a reference to this Backbone object.</p>
 
             </div>
             
@@ -206,9 +199,8 @@ to its previous owner. Returns a reference to this Backbone object.
                 <a class="pilcrow" href="#section-11">&#182;</a>
               </div>
               <p>Turn on <code>emulateHTTP</code> to support legacy HTTP servers. Setting this option
-will fake <code>&quot;PUT&quot;</code> and <code>&quot;DELETE&quot;</code> requests via the <code>_method</code> parameter and
-set a <code>X-Http-Method-Override</code> header.
-</p>
+will fake <code>&quot;PATCH&quot;</code>, <code>&quot;PUT&quot;</code> and <code>&quot;DELETE&quot;</code> requests via the <code>_method</code> parameter and
+set a <code>X-Http-Method-Override</code> header.</p>
 
             </div>
             
@@ -226,8 +218,7 @@ set a <code>X-Http-Method-Override</code> header.
               <p>Turn on <code>emulateJSON</code> to support legacy servers that can&#39;t deal with direct
 <code>application/json</code> requests ... will encode the body as
 <code>application/x-www-form-urlencoded</code> instead and will send the model in a
-form param named <code>model</code>.
-</p>
+form param named <code>model</code>.</p>
 
             </div>
             
@@ -258,9 +249,7 @@ form param named <code>model</code>.
               <p>A module that can be mixed in to <em>any object</em> in order to provide it with
 custom events. You may bind with <code>on</code> or remove with <code>off</code> callback
 functions to an event; <code>trigger</code>-ing an event fires all callbacks in
-succession.
-
-</p>
+succession.</p>
 <pre><code>var object = {};
 _.extend(object, Backbone.Events);
 object.on(&#39;expand&#39;, function(){ alert(&#39;expanded&#39;); });
@@ -280,8 +269,7 @@ object.trigger(&#39;expand&#39;);</code></pre>
                 <a class="pilcrow" href="#section-15">&#182;</a>
               </div>
               <p>Bind an event to a <code>callback</code> function. Passing <code>&quot;all&quot;</code> will bind
-the callback to all events fired.
-</p>
+the callback to all events fired.</p>
 
             </div>
             
@@ -303,8 +291,7 @@ the callback to all events fired.
                 <a class="pilcrow" href="#section-16">&#182;</a>
               </div>
               <p>Bind an event to only be triggered a single time. After the first time
-the callback is invoked, it will be removed.
-</p>
+the callback is invoked, it will be removed.</p>
 
             </div>
             
@@ -331,8 +318,7 @@ the callback is invoked, it will be removed.
               <p>Remove one or many callbacks. If <code>context</code> is null, removes all
 callbacks with that function. If <code>callback</code> is null, removes all
 callbacks for the event. If <code>name</code> is null, removes all bound
-callbacks for all events.
-</p>
+callbacks for all events.</p>
 
             </div>
             
@@ -343,7 +329,6 @@ callbacks for all events.
         <span class="keyword">this</span>._events = {};
         <span class="keyword">return</span> <span class="keyword">this</span>;
       }
-
       names = name ? [name] : _.keys(<span class="keyword">this</span>._events);
       <span class="keyword">for</span> (i = <span class="number">0</span>, l = names.length; i &lt; l; i++) {
         name = names[i];
@@ -377,8 +362,7 @@ callbacks for all events.
               <p>Trigger one or many events, firing all bound callbacks. Callbacks are
 passed the same arguments as <code>trigger</code> is, apart from the event name
 (unless you&#39;re listening on <code>&quot;all&quot;</code>, which will cause your callback to
-receive the true name of the event as the first argument).
-</p>
+receive the true name of the event as the first argument).</p>
 
             </div>
             
@@ -403,20 +387,20 @@ receive the true name of the event as the first argument).
                 <a class="pilcrow" href="#section-19">&#182;</a>
               </div>
               <p>Tell this object to stop listening to either specific events ... or
-to every object it&#39;s currently listening to.
-</p>
+to every object it&#39;s currently listening to.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    stopListening: <span class="keyword">function</span>(obj, name, callback) {
-      <span class="keyword">var</span> listeners = <span class="keyword">this</span>._listeners;
-      <span class="keyword">if</span> (!listeners) <span class="keyword">return</span> <span class="keyword">this</span>;
-      <span class="keyword">var</span> deleteListener = !name &amp;&amp; !callback;
-      <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">'object'</span>) callback = <span class="keyword">this</span>;
-      <span class="keyword">if</span> (obj) (listeners = {})[obj._listenerId] = obj;
-      <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> listeners) {
-        listeners[id].off(name, callback, <span class="keyword">this</span>);
-        <span class="keyword">if</span> (deleteListener) <span class="keyword">delete</span> <span class="keyword">this</span>._listeners[id];
+      <span class="keyword">var</span> listeningTo = <span class="keyword">this</span>._listeningTo;
+      <span class="keyword">if</span> (!listeningTo) <span class="keyword">return</span> <span class="keyword">this</span>;
+      <span class="keyword">var</span> remove = !name &amp;&amp; !callback;
+      <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> name === <span class="string">'object'</span>) callback = <span class="keyword">this</span>;
+      <span class="keyword">if</span> (obj) (listeningTo = {})[obj._listenId] = obj;
+      <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> listeningTo) {
+        obj = listeningTo[id];
+        obj.off(name, callback, <span class="keyword">this</span>);
+        <span class="keyword">if</span> (remove || _.isEmpty(obj._events)) <span class="keyword">delete</span> <span class="keyword">this</span>._listeningTo[id];
       }
       <span class="keyword">return</span> <span class="keyword">this</span>;
     }
@@ -432,8 +416,7 @@ to every object it&#39;s currently listening to.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-20">&#182;</a>
               </div>
-              <p>Regular expression used to split event strings.
-</p>
+              <p>Regular expression used to split event strings.</p>
 
             </div>
             
@@ -450,8 +433,7 @@ to every object it&#39;s currently listening to.
               </div>
               <p>Implement fancy features of the Events API such as multiple event
 names <code>&quot;change blur&quot;</code> and jQuery-style event maps <code>{change: action}</code>
-in terms of the existing API.
-</p>
+in terms of the existing API.</p>
 
             </div>
             
@@ -467,8 +449,7 @@ in terms of the existing API.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-22">&#182;</a>
               </div>
-              <p>Handle event maps.
-</p>
+              <p>Handle event maps.</p>
 
             </div>
             
@@ -488,8 +469,7 @@ in terms of the existing API.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-23">&#182;</a>
               </div>
-              <p>Handle space separated event names.
-</p>
+              <p>Handle space separated event names.</p>
 
             </div>
             
@@ -515,8 +495,7 @@ in terms of the existing API.
               </div>
               <p>A difficult-to-believe, but optimized internal dispatch function for
 triggering events. Tries to keep the usual cases speedy (most internal
-Backbone events have 3 arguments).
-</p>
+Backbone events have 3 arguments).</p>
 
             </div>
             
@@ -544,17 +523,16 @@ Backbone events have 3 arguments).
               </div>
               <p>Inversion-of-control versions of <code>on</code> and <code>once</code>. Tell <em>this</em> object to
 listen to an event in another object ... keeping track of what it&#39;s
-listening to.
-</p>
+listening to.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>  _.each(listenMethods, <span class="keyword">function</span>(implementation, method) {
     Events[method] = <span class="keyword">function</span>(obj, name, callback) {
-      <span class="keyword">var</span> listeners = <span class="keyword">this</span>._listeners || (<span class="keyword">this</span>._listeners = {});
-      <span class="keyword">var</span> id = obj._listenerId || (obj._listenerId = _.uniqueId(<span class="string">'l'</span>));
-      listeners[id] = obj;
-      <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">'object'</span>) callback = <span class="keyword">this</span>;
+      <span class="keyword">var</span> listeningTo = <span class="keyword">this</span>._listeningTo || (<span class="keyword">this</span>._listeningTo = {});
+      <span class="keyword">var</span> id = obj._listenId || (obj._listenId = _.uniqueId(<span class="string">'l'</span>));
+      listeningTo[id] = obj;
+      <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> name === <span class="string">'object'</span>) callback = <span class="keyword">this</span>;
       obj[implementation](name, callback, <span class="keyword">this</span>);
       <span class="keyword">return</span> <span class="keyword">this</span>;
     };
@@ -569,8 +547,7 @@ listening to.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-26">&#182;</a>
               </div>
-              <p>Aliases for backwards compatibility.
-</p>
+              <p>Aliases for backwards compatibility.</p>
 
             </div>
             
@@ -587,8 +564,7 @@ listening to.
                 <a class="pilcrow" href="#section-27">&#182;</a>
               </div>
               <p>Allow the <code>Backbone</code> object to serve as a global event bus, for folks who
-want global &quot;pubsub&quot; in a convenient place.
-</p>
+want global &quot;pubsub&quot; in a convenient place.</p>
 
             </div>
             
@@ -619,26 +595,20 @@ want global &quot;pubsub&quot; in a convenient place.
               <p>Backbone <strong>Models</strong> are the basic data object in the framework --
 frequently representing a row in a table in a database on your server.
 A discrete chunk of data and a bunch of useful, related methods for
-performing computations and transformations on that data.
-
-</p>
+performing computations and transformations on that data.</p>
 <p>Create a new model with the specified attributes. A client id (<code>cid</code>)
-is automatically generated and assigned for you.
-</p>
+is automatically generated and assigned for you.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Model = Backbone.Model = <span class="keyword">function</span>(attributes, options) {
-    <span class="keyword">var</span> defaults;
     <span class="keyword">var</span> attrs = attributes || {};
     options || (options = {});
     <span class="keyword">this</span>.cid = _.uniqueId(<span class="string">'c'</span>);
     <span class="keyword">this</span>.attributes = {};
-    _.extend(<span class="keyword">this</span>, _.pick(options, modelOptions));
+    <span class="keyword">if</span> (options.collection) <span class="keyword">this</span>.collection = options.collection;
     <span class="keyword">if</span> (options.parse) attrs = <span class="keyword">this</span>.parse(attrs, options) || {};
-    <span class="keyword">if</span> (defaults = _.result(<span class="keyword">this</span>, <span class="string">'defaults'</span>)) {
-      attrs = _.defaults({}, attrs, defaults);
-    }
+    attrs = _.defaults({}, attrs, _.result(<span class="keyword">this</span>, <span class="string">'defaults'</span>));
     <span class="keyword">this</span>.set(attrs, options);
     <span class="keyword">this</span>.changed = {};
     <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
@@ -653,12 +623,11 @@ is automatically generated and assigned for you.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-30">&#182;</a>
               </div>
-              <p>A list of options to be attached directly to the model, if provided.
-</p>
+              <p>Attach all inheritable methods to the Model prototype.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> modelOptions = [<span class="string">'url'</span>, <span class="string">'urlRoot'</span>, <span class="string">'collection'</span>];</pre></div></div>
+            <div class="content"><div class='highlight'><pre>  _.extend(Model.prototype, Events, {</pre></div></div>
             
         </li>
         
@@ -669,12 +638,11 @@ is automatically generated and assigned for you.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-31">&#182;</a>
               </div>
-              <p>Attach all inheritable methods to the Model prototype.
-</p>
+              <p>A hash of attributes whose current and previous value differ.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>  _.extend(Model.prototype, Events, {</pre></div></div>
+            <div class="content"><div class='highlight'><pre>    changed: <span class="literal">null</span>,</pre></div></div>
             
         </li>
         
@@ -685,12 +653,11 @@ is automatically generated and assigned for you.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-32">&#182;</a>
               </div>
-              <p>A hash of attributes whose current and previous value differ.
-</p>
+              <p>The value returned during the last failed validation.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>    changed: <span class="literal">null</span>,</pre></div></div>
+            <div class="content"><div class='highlight'><pre>    validationError: <span class="literal">null</span>,</pre></div></div>
             
         </li>
         
@@ -701,25 +668,8 @@ is automatically generated and assigned for you.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-33">&#182;</a>
               </div>
-              <p>The value returned during the last failed validation.
-</p>
-
-            </div>
-            
-            <div class="content"><div class='highlight'><pre>    validationError: <span class="literal">null</span>,</pre></div></div>
-            
-        </li>
-        
-        
-        <li id="section-34">
-            <div class="annotation">
-              
-              <div class="pilwrap ">
-                <a class="pilcrow" href="#section-34">&#182;</a>
-              </div>
               <p>The default name for the JSON <code>id</code> attribute is <code>&quot;id&quot;</code>. MongoDB and
-CouchDB users may want to set this to <code>&quot;_id&quot;</code>.
-</p>
+CouchDB users may want to set this to <code>&quot;_id&quot;</code>.</p>
 
             </div>
             
@@ -728,15 +678,14 @@ CouchDB users may want to set this to <code>&quot;_id&quot;</code>.
         </li>
         
         
-        <li id="section-35">
+        <li id="section-34">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-35">&#182;</a>
+                <a class="pilcrow" href="#section-34">&#182;</a>
               </div>
               <p>Initialize is an empty function by default. Override it with your own
-initialization logic.
-</p>
+initialization logic.</p>
 
             </div>
             
@@ -745,14 +694,13 @@ initialization logic.
         </li>
         
         
-        <li id="section-36">
+        <li id="section-35">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-36">&#182;</a>
+                <a class="pilcrow" href="#section-35">&#182;</a>
               </div>
-              <p>Return a copy of the model&#39;s <code>attributes</code> object.
-</p>
+              <p>Return a copy of the model&#39;s <code>attributes</code> object.</p>
 
             </div>
             
@@ -763,15 +711,14 @@ initialization logic.
         </li>
         
         
-        <li id="section-37">
+        <li id="section-36">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-37">&#182;</a>
+                <a class="pilcrow" href="#section-36">&#182;</a>
               </div>
               <p>Proxy <code>Backbone.sync</code> by default -- but override this if you need
-custom syncing semantics for <em>this</em> particular model.
-</p>
+custom syncing semantics for <em>this</em> particular model.</p>
 
             </div>
             
@@ -782,14 +729,13 @@ custom syncing semantics for <em>this</em> particular model.
         </li>
         
         
-        <li id="section-38">
+        <li id="section-37">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-38">&#182;</a>
+                <a class="pilcrow" href="#section-37">&#182;</a>
               </div>
-              <p>Get the value of an attribute.
-</p>
+              <p>Get the value of an attribute.</p>
 
             </div>
             
@@ -800,14 +746,13 @@ custom syncing semantics for <em>this</em> particular model.
         </li>
         
         
-        <li id="section-39">
+        <li id="section-38">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-39">&#182;</a>
+                <a class="pilcrow" href="#section-38">&#182;</a>
               </div>
-              <p>Get the HTML-escaped value of an attribute.
-</p>
+              <p>Get the HTML-escaped value of an attribute.</p>
 
             </div>
             
@@ -818,15 +763,14 @@ custom syncing semantics for <em>this</em> particular model.
         </li>
         
         
-        <li id="section-40">
+        <li id="section-39">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-40">&#182;</a>
+                <a class="pilcrow" href="#section-39">&#182;</a>
               </div>
               <p>Returns <code>true</code> if the attribute contains a value that is not null
-or undefined.
-</p>
+or undefined.</p>
 
             </div>
             
@@ -837,16 +781,15 @@ or undefined.
         </li>
         
         
-        <li id="section-41">
+        <li id="section-40">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-41">&#182;</a>
+                <a class="pilcrow" href="#section-40">&#182;</a>
               </div>
               <p>Set a hash of model attributes on the object, firing <code>&quot;change&quot;</code>. This is
 the core primitive operation of a model, updating the data and notifying
-anyone who needs to know about the change in state. The heart of the beast.
-</p>
+anyone who needs to know about the change in state. The heart of the beast.</p>
 
             </div>
             
@@ -857,14 +800,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-42">
+        <li id="section-41">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-42">&#182;</a>
+                <a class="pilcrow" href="#section-41">&#182;</a>
               </div>
-              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.
-</p>
+              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>
 
             </div>
             
@@ -880,14 +822,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-43">
+        <li id="section-42">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-43">&#182;</a>
+                <a class="pilcrow" href="#section-42">&#182;</a>
               </div>
-              <p>Run validation.
-</p>
+              <p>Run validation.</p>
 
             </div>
             
@@ -896,14 +837,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-44">
+        <li id="section-43">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-44">&#182;</a>
+                <a class="pilcrow" href="#section-43">&#182;</a>
               </div>
-              <p>Extract attributes and options.
-</p>
+              <p>Extract attributes and options.</p>
 
             </div>
             
@@ -922,14 +862,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-45">
+        <li id="section-44">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-45">&#182;</a>
+                <a class="pilcrow" href="#section-44">&#182;</a>
               </div>
-              <p>Check for changes of <code>id</code>.
-</p>
+              <p>Check for changes of <code>id</code>.</p>
 
             </div>
             
@@ -938,14 +877,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-46">
+        <li id="section-45">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-46">&#182;</a>
+                <a class="pilcrow" href="#section-45">&#182;</a>
               </div>
-              <p>For each <code>set</code> attribute, update or delete the current value.
-</p>
+              <p>For each <code>set</code> attribute, update or delete the current value.</p>
 
             </div>
             
@@ -963,14 +901,13 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-47">
+        <li id="section-46">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-47">&#182;</a>
+                <a class="pilcrow" href="#section-46">&#182;</a>
               </div>
-              <p>Trigger all relevant attribute changes.
-</p>
+              <p>Trigger all relevant attribute changes.</p>
 
             </div>
             
@@ -984,15 +921,14 @@ anyone who needs to know about the change in state. The heart of the beast.
         </li>
         
         
-        <li id="section-48">
+        <li id="section-47">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-48">&#182;</a>
+                <a class="pilcrow" href="#section-47">&#182;</a>
               </div>
               <p>You might be wondering why there&#39;s a <code>while</code> loop here. Changes can
-be recursively nested within <code>&quot;change&quot;</code> events.
-</p>
+be recursively nested within <code>&quot;change&quot;</code> events.</p>
 
             </div>
             
@@ -1011,15 +947,14 @@ be recursively nested within <code>&quot;change&quot;</code> events.
         </li>
         
         
-        <li id="section-49">
+        <li id="section-48">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-49">&#182;</a>
+                <a class="pilcrow" href="#section-48">&#182;</a>
               </div>
               <p>Remove an attribute from the model, firing <code>&quot;change&quot;</code>. <code>unset</code> is a noop
-if the attribute doesn&#39;t exist.
-</p>
+if the attribute doesn&#39;t exist.</p>
 
             </div>
             
@@ -1030,14 +965,13 @@ if the attribute doesn&#39;t exist.
         </li>
         
         
-        <li id="section-50">
+        <li id="section-49">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-50">&#182;</a>
+                <a class="pilcrow" href="#section-49">&#182;</a>
               </div>
-              <p>Clear all attributes on the model, firing <code>&quot;change&quot;</code>.
-</p>
+              <p>Clear all attributes on the model, firing <code>&quot;change&quot;</code>.</p>
 
             </div>
             
@@ -1050,15 +984,14 @@ if the attribute doesn&#39;t exist.
         </li>
         
         
-        <li id="section-51">
+        <li id="section-50">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-51">&#182;</a>
+                <a class="pilcrow" href="#section-50">&#182;</a>
               </div>
               <p>Determine if the model has changed since the last <code>&quot;change&quot;</code> event.
-If you specify an attribute name, determine if that attribute has changed.
-</p>
+If you specify an attribute name, determine if that attribute has changed.</p>
 
             </div>
             
@@ -1070,19 +1003,18 @@ If you specify an attribute name, determine if that attribute has changed.
         </li>
         
         
-        <li id="section-52">
+        <li id="section-51">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-52">&#182;</a>
+                <a class="pilcrow" href="#section-51">&#182;</a>
               </div>
               <p>Return an object containing all the attributes that have changed, or
 false if there are no changed attributes. Useful for determining what
 parts of a view need to be updated and/or what attributes need to be
 persisted to the server. Unset attributes will be set to undefined.
 You can also pass an attributes object to diff against the model,
-determining if there <em>would be</em> a change.
-</p>
+determining if there <em>would be</em> a change.</p>
 
             </div>
             
@@ -1100,15 +1032,14 @@ determining if there <em>would be</em> a change.
         </li>
         
         
-        <li id="section-53">
+        <li id="section-52">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-53">&#182;</a>
+                <a class="pilcrow" href="#section-52">&#182;</a>
               </div>
               <p>Get the previous value of an attribute, recorded at the time the last
-<code>&quot;change&quot;</code> event was fired.
-</p>
+<code>&quot;change&quot;</code> event was fired.</p>
 
             </div>
             
@@ -1120,15 +1051,14 @@ determining if there <em>would be</em> a change.
         </li>
         
         
-        <li id="section-54">
+        <li id="section-53">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-54">&#182;</a>
+                <a class="pilcrow" href="#section-53">&#182;</a>
               </div>
               <p>Get all of the attributes of the model at the time of the previous
-<code>&quot;change&quot;</code> event.
-</p>
+<code>&quot;change&quot;</code> event.</p>
 
             </div>
             
@@ -1139,16 +1069,15 @@ determining if there <em>would be</em> a change.
         </li>
         
         
-        <li id="section-55">
+        <li id="section-54">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-55">&#182;</a>
+                <a class="pilcrow" href="#section-54">&#182;</a>
               </div>
               <p>Fetch the model from the server. If the server&#39;s representation of the
 model differs from its current attributes, they will be overridden,
-triggering a <code>&quot;change&quot;</code> event.
-</p>
+triggering a <code>&quot;change&quot;</code> event.</p>
 
             </div>
             
@@ -1169,16 +1098,15 @@ triggering a <code>&quot;change&quot;</code> event.
         </li>
         
         
-        <li id="section-56">
+        <li id="section-55">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-56">&#182;</a>
+                <a class="pilcrow" href="#section-55">&#182;</a>
               </div>
               <p>Set a hash of model attributes, and sync the model to the server.
 If the server returns an attributes hash that differs, the model&#39;s
-state will be <code>set</code> again.
-</p>
+state will be <code>set</code> again.</p>
 
             </div>
             
@@ -1188,14 +1116,13 @@ state will be <code>set</code> again.
         </li>
         
         
-        <li id="section-57">
+        <li id="section-56">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-57">&#182;</a>
+                <a class="pilcrow" href="#section-56">&#182;</a>
               </div>
-              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.
-</p>
+              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>
 
             </div>
             
@@ -1204,53 +1131,41 @@ state will be <code>set</code> again.
         options = val;
       } <span class="keyword">else</span> {
         (attrs = {})[key] = val;
-      }</pre></div></div>
-            
-        </li>
-        
-        
-        <li id="section-58">
-            <div class="annotation">
-              
-              <div class="pilwrap ">
-                <a class="pilcrow" href="#section-58">&#182;</a>
-              </div>
-              <p>If we&#39;re not waiting and attributes exist, save acts as <code>set(attr).save(null, opts)</code>.
-</p>
-
-            </div>
-            
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (attrs &amp;&amp; (!options || !options.wait) &amp;&amp; !<span class="keyword">this</span>.set(attrs, options)) <span class="keyword">return</span> <span class="literal">false</span>;
+      }
 
       options = _.extend({validate: <span class="literal">true</span>}, options);</pre></div></div>
             
         </li>
         
         
-        <li id="section-59">
+        <li id="section-57">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-59">&#182;</a>
+                <a class="pilcrow" href="#section-57">&#182;</a>
               </div>
-              <p>Do not persist invalid models.
-</p>
+              <p>If we&#39;re not waiting and attributes exist, save acts as
+<code>set(attr).save(null, opts)</code> with validation. Otherwise, check if
+the model will be valid when the attributes, if any, are set.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!<span class="keyword">this</span>._validate(attrs, options)) <span class="keyword">return</span> <span class="literal">false</span>;</pre></div></div>
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (attrs &amp;&amp; !options.wait) {
+        <span class="keyword">if</span> (!<span class="keyword">this</span>.set(attrs, options)) <span class="keyword">return</span> <span class="literal">false</span>;
+      } <span class="keyword">else</span> {
+        <span class="keyword">if</span> (!<span class="keyword">this</span>._validate(attrs, options)) <span class="keyword">return</span> <span class="literal">false</span>;
+      }</pre></div></div>
             
         </li>
         
         
-        <li id="section-60">
+        <li id="section-58">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-60">&#182;</a>
+                <a class="pilcrow" href="#section-58">&#182;</a>
               </div>
-              <p>Set temporary attributes if <code>{wait: true}</code>.
-</p>
+              <p>Set temporary attributes if <code>{wait: true}</code>.</p>
 
             </div>
             
@@ -1261,15 +1176,14 @@ state will be <code>set</code> again.
         </li>
         
         
-        <li id="section-61">
+        <li id="section-59">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-61">&#182;</a>
+                <a class="pilcrow" href="#section-59">&#182;</a>
               </div>
               <p>After a successful server-side save, the client is (optionally)
-updated with the server-side state.
-</p>
+updated with the server-side state.</p>
 
             </div>
             
@@ -1281,14 +1195,13 @@ updated with the server-side state.
         </li>
         
         
-        <li id="section-62">
+        <li id="section-60">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-62">&#182;</a>
+                <a class="pilcrow" href="#section-60">&#182;</a>
               </div>
-              <p>Ensure attributes are restored during synchronous saves.
-</p>
+              <p>Ensure attributes are restored during synchronous saves.</p>
 
             </div>
             
@@ -1310,14 +1223,13 @@ updated with the server-side state.
         </li>
         
         
-        <li id="section-63">
+        <li id="section-61">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-63">&#182;</a>
+                <a class="pilcrow" href="#section-61">&#182;</a>
               </div>
-              <p>Restore attributes.
-</p>
+              <p>Restore attributes.</p>
 
             </div>
             
@@ -1329,16 +1241,15 @@ updated with the server-side state.
         </li>
         
         
-        <li id="section-64">
+        <li id="section-62">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-64">&#182;</a>
+                <a class="pilcrow" href="#section-62">&#182;</a>
               </div>
               <p>Destroy this model on the server if it was already persisted.
 Optimistically removes the model from its collection, if it has one.
-If <code>wait: true</code> is passed, waits for the server to respond before removal.
-</p>
+If <code>wait: true</code> is passed, waits for the server to respond before removal.</p>
 
             </div>
             
@@ -1371,16 +1282,15 @@ If <code>wait: true</code> is passed, waits for the server to respond before rem
         </li>
         
         
-        <li id="section-65">
+        <li id="section-63">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-65">&#182;</a>
+                <a class="pilcrow" href="#section-63">&#182;</a>
               </div>
               <p>Default URL for the model&#39;s representation on the server -- if you&#39;re
 using Backbone&#39;s restful methods, override this to change the endpoint
-that will be called.
-</p>
+that will be called.</p>
 
             </div>
             
@@ -1393,15 +1303,14 @@ that will be called.
         </li>
         
         
-        <li id="section-66">
+        <li id="section-64">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-66">&#182;</a>
+                <a class="pilcrow" href="#section-64">&#182;</a>
               </div>
               <p><strong>parse</strong> converts a response into the hash of attributes to be <code>set</code> on
-the model. The default implementation is just to pass the response along.
-</p>
+the model. The default implementation is just to pass the response along.</p>
 
             </div>
             
@@ -1412,14 +1321,13 @@ the model. The default implementation is just to pass the response along.
         </li>
         
         
-        <li id="section-67">
+        <li id="section-65">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-67">&#182;</a>
+                <a class="pilcrow" href="#section-65">&#182;</a>
               </div>
-              <p>Create a new model with identical attributes to this one.
-</p>
+              <p>Create a new model with identical attributes to this one.</p>
 
             </div>
             
@@ -1430,14 +1338,13 @@ the model. The default implementation is just to pass the response along.
         </li>
         
         
-        <li id="section-68">
+        <li id="section-66">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-68">&#182;</a>
+                <a class="pilcrow" href="#section-66">&#182;</a>
               </div>
-              <p>A model is new if it has never been saved to the server, and lacks an id.
-</p>
+              <p>A model is new if it has never been saved to the server, and lacks an id.</p>
 
             </div>
             
@@ -1448,14 +1355,13 @@ the model. The default implementation is just to pass the response along.
         </li>
         
         
-        <li id="section-69">
+        <li id="section-67">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-69">&#182;</a>
+                <a class="pilcrow" href="#section-67">&#182;</a>
               </div>
-              <p>Check if the model is currently in a valid state.
-</p>
+              <p>Check if the model is currently in a valid state.</p>
 
             </div>
             
@@ -1466,15 +1372,14 @@ the model. The default implementation is just to pass the response along.
         </li>
         
         
-        <li id="section-70">
+        <li id="section-68">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-70">&#182;</a>
+                <a class="pilcrow" href="#section-68">&#182;</a>
               </div>
               <p>Run validation against the next complete set of model attributes,
-returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;invalid&quot;</code> event.
-</p>
+returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;invalid&quot;</code> event.</p>
 
             </div>
             
@@ -1483,7 +1388,7 @@ returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;inval
       attrs = _.extend({}, <span class="keyword">this</span>.attributes, attrs);
       <span class="keyword">var</span> error = <span class="keyword">this</span>.validationError = <span class="keyword">this</span>.validate(attrs, options) || <span class="literal">null</span>;
       <span class="keyword">if</span> (!error) <span class="keyword">return</span> <span class="literal">true</span>;
-      <span class="keyword">this</span>.trigger(<span class="string">'invalid'</span>, <span class="keyword">this</span>, error, _.extend(options || {}, {validationError: error}));
+      <span class="keyword">this</span>.trigger(<span class="string">'invalid'</span>, <span class="keyword">this</span>, error, _.extend(options, {validationError: error}));
       <span class="keyword">return</span> <span class="literal">false</span>;
     }
 
@@ -1492,14 +1397,13 @@ returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;inval
         </li>
         
         
-        <li id="section-71">
+        <li id="section-69">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-71">&#182;</a>
+                <a class="pilcrow" href="#section-69">&#182;</a>
               </div>
-              <p>Underscore methods that we want to implement on the Model.
-</p>
+              <p>Underscore methods that we want to implement on the Model.</p>
 
             </div>
             
@@ -1508,14 +1412,13 @@ returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;inval
         </li>
         
         
-        <li id="section-72">
+        <li id="section-70">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-72">&#182;</a>
+                <a class="pilcrow" href="#section-70">&#182;</a>
               </div>
-              <p>Mix in each Underscore method as a proxy to <code>Model#attributes</code>.
-</p>
+              <p>Mix in each Underscore method as a proxy to <code>Model#attributes</code>.</p>
 
             </div>
             
@@ -1530,11 +1433,11 @@ returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;inval
         </li>
         
         
-        <li id="section-73">
+        <li id="section-71">
             <div class="annotation">
               
               <div class="pilwrap for-h2">
-                <a class="pilcrow" href="#section-73">&#182;</a>
+                <a class="pilcrow" href="#section-71">&#182;</a>
               </div>
               <h2>Backbone.Collection</h2>
 
@@ -1543,30 +1446,26 @@ returning <code>true</code> if all is well. Otherwise, fire an <code>&quot;inval
         </li>
         
         
-        <li id="section-74">
+        <li id="section-72">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-74">&#182;</a>
+                <a class="pilcrow" href="#section-72">&#182;</a>
               </div>
               <p>If models tend to represent a single row of data, a Backbone Collection is
 more analagous to a table full of data ... or a small slice or page of that
 table, or a collection of rows that belong together for a particular reason
 -- all of the messages in this particular folder, all of the documents
 belonging to this particular author, and so on. Collections maintain
-indexes of their models, both in order, and for lookup by <code>id</code>.
-
-</p>
+indexes of their models, both in order, and for lookup by <code>id</code>.</p>
 <p>Create a new <strong>Collection</strong>, perhaps to contain a specific type of <code>model</code>.
 If a <code>comparator</code> is specified, the Collection will maintain
-its models in sort order, as they&#39;re added and removed.
-</p>
+its models in sort order, as they&#39;re added and removed.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Collection = Backbone.Collection = <span class="keyword">function</span>(models, options) {
     options || (options = {});
-    <span class="keyword">if</span> (options.url) <span class="keyword">this</span>.url = options.url;
     <span class="keyword">if</span> (options.model) <span class="keyword">this</span>.model = options.model;
     <span class="keyword">if</span> (options.comparator !== <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">this</span>.comparator = options.comparator;
     <span class="keyword">this</span>._reset();
@@ -1577,31 +1476,29 @@ its models in sort order, as they&#39;re added and removed.
         </li>
         
         
-        <li id="section-75">
+        <li id="section-73">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-75">&#182;</a>
+                <a class="pilcrow" href="#section-73">&#182;</a>
               </div>
-              <p>Default options for <code>Collection#set</code>.
-</p>
+              <p>Default options for <code>Collection#set</code>.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> setOptions = {add: <span class="literal">true</span>, remove: <span class="literal">true</span>, merge: <span class="literal">true</span>};
-  <span class="keyword">var</span> addOptions = {add: <span class="literal">true</span>, merge: <span class="literal">false</span>, remove: <span class="literal">false</span>};</pre></div></div>
+  <span class="keyword">var</span> addOptions = {add: <span class="literal">true</span>, remove: <span class="literal">false</span>};</pre></div></div>
             
         </li>
         
         
-        <li id="section-76">
+        <li id="section-74">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-76">&#182;</a>
+                <a class="pilcrow" href="#section-74">&#182;</a>
               </div>
-              <p>Define the Collection&#39;s inheritable methods.
-</p>
+              <p>Define the Collection&#39;s inheritable methods.</p>
 
             </div>
             
@@ -1610,15 +1507,14 @@ its models in sort order, as they&#39;re added and removed.
         </li>
         
         
-        <li id="section-77">
+        <li id="section-75">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-77">&#182;</a>
+                <a class="pilcrow" href="#section-75">&#182;</a>
               </div>
               <p>The default model for a collection is just a <strong>Backbone.Model</strong>.
-This should be overridden in most cases.
-</p>
+This should be overridden in most cases.</p>
 
             </div>
             
@@ -1627,15 +1523,14 @@ This should be overridden in most cases.
         </li>
         
         
-        <li id="section-78">
+        <li id="section-76">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-78">&#182;</a>
+                <a class="pilcrow" href="#section-76">&#182;</a>
               </div>
               <p>Initialize is an empty function by default. Override it with your own
-initialization logic.
-</p>
+initialization logic.</p>
 
             </div>
             
@@ -1644,15 +1539,14 @@ initialization logic.
         </li>
         
         
-        <li id="section-79">
+        <li id="section-77">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-79">&#182;</a>
+                <a class="pilcrow" href="#section-77">&#182;</a>
               </div>
               <p>The JSON representation of a Collection is an array of the
-models&#39; attributes.
-</p>
+models&#39; attributes.</p>
 
             </div>
             
@@ -1663,14 +1557,13 @@ models&#39; attributes.
         </li>
         
         
-        <li id="section-80">
+        <li id="section-78">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-80">&#182;</a>
+                <a class="pilcrow" href="#section-78">&#182;</a>
               </div>
-              <p>Proxy <code>Backbone.sync</code> by default.
-</p>
+              <p>Proxy <code>Backbone.sync</code> by default.</p>
 
             </div>
             
@@ -1681,41 +1574,40 @@ models&#39; attributes.
         </li>
         
         
-        <li id="section-81">
+        <li id="section-79">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-81">&#182;</a>
+                <a class="pilcrow" href="#section-79">&#182;</a>
               </div>
-              <p>Add a model, or list of models to the set.
-</p>
+              <p>Add a model, or list of models to the set.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    add: <span class="keyword">function</span>(models, options) {
-      <span class="keyword">return</span> <span class="keyword">this</span>.set(models, _.defaults(options || {}, addOptions));
+      <span class="keyword">return</span> <span class="keyword">this</span>.set(models, _.extend({merge: <span class="literal">false</span>}, options, addOptions));
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-82">
+        <li id="section-80">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-82">&#182;</a>
+                <a class="pilcrow" href="#section-80">&#182;</a>
               </div>
-              <p>Remove a model, or a list of models from the set.
-</p>
+              <p>Remove a model, or a list of models from the set.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    remove: <span class="keyword">function</span>(models, options) {
-      models = _.isArray(models) ? models.slice() : [models];
+      <span class="keyword">var</span> singular = !_.isArray(models);
+      models = singular ? [models] : _.clone(models);
       options || (options = {});
       <span class="keyword">var</span> i, l, index, model;
       <span class="keyword">for</span> (i = <span class="number">0</span>, l = models.length; i &lt; l; i++) {
-        model = <span class="keyword">this</span>.get(models[i]);
+        model = models[i] = <span class="keyword">this</span>.get(models[i]);
         <span class="keyword">if</span> (!model) <span class="keyword">continue</span>;
         <span class="keyword">delete</span> <span class="keyword">this</span>._byId[model.id];
         <span class="keyword">delete</span> <span class="keyword">this</span>._byId[model.cid];
@@ -1728,105 +1620,114 @@ models&#39; attributes.
         }
         <span class="keyword">this</span>._removeReference(model);
       }
-      <span class="keyword">return</span> <span class="keyword">this</span>;
+      <span class="keyword">return</span> singular ? models[<span class="number">0</span>] : models;
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-83">
+        <li id="section-81">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-83">&#182;</a>
+                <a class="pilcrow" href="#section-81">&#182;</a>
               </div>
               <p>Update a collection by <code>set</code>-ing a new list of models, adding new ones,
 removing models that are no longer present, and merging models that
 already exist in the collection, as necessary. Similar to <strong>Model#set</strong>,
-the core operation for updating the data contained by the collection.
-</p>
+the core operation for updating the data contained by the collection.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    set: <span class="keyword">function</span>(models, options) {
-      options = _.defaults(options || {}, setOptions);
+      options = _.defaults({}, options, setOptions);
       <span class="keyword">if</span> (options.parse) models = <span class="keyword">this</span>.parse(models, options);
-      <span class="keyword">if</span> (!_.isArray(models)) models = models ? [models] : [];
-      <span class="keyword">var</span> i, l, model, attrs, existing, sort;
+      <span class="keyword">var</span> singular = !_.isArray(models);
+      models = singular ? (models ? [models] : []) : _.clone(models);
+      <span class="keyword">var</span> i, l, id, model, attrs, existing, sort;
       <span class="keyword">var</span> at = options.at;
+      <span class="keyword">var</span> targetModel = <span class="keyword">this</span>.model;
       <span class="keyword">var</span> sortable = <span class="keyword">this</span>.comparator &amp;&amp; (at == <span class="literal">null</span>) &amp;&amp; options.sort !== <span class="literal">false</span>;
       <span class="keyword">var</span> sortAttr = _.isString(<span class="keyword">this</span>.comparator) ? <span class="keyword">this</span>.comparator : <span class="literal">null</span>;
-      <span class="keyword">var</span> toAdd = [], toRemove = [], modelMap = {};</pre></div></div>
+      <span class="keyword">var</span> toAdd = [], toRemove = [], modelMap = {};
+      <span class="keyword">var</span> add = options.add, merge = options.merge, remove = options.remove;
+      <span class="keyword">var</span> order = !sortable &amp;&amp; add &amp;&amp; remove ? [] : <span class="literal">false</span>;</pre></div></div>
             
         </li>
         
         
-        <li id="section-84">
+        <li id="section-82">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-84">&#182;</a>
+                <a class="pilcrow" href="#section-82">&#182;</a>
               </div>
               <p>Turn bare objects into model references, and prevent invalid models
-from being added.
-</p>
+from being added.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> (i = <span class="number">0</span>, l = models.length; i &lt; l; i++) {
-        <span class="keyword">if</span> (!(model = <span class="keyword">this</span>._prepareModel(models[i], options))) <span class="keyword">continue</span>;</pre></div></div>
+        attrs = models[i];
+        <span class="keyword">if</span> (attrs <span class="keyword">instanceof</span> Model) {
+          id = model = attrs;
+        } <span class="keyword">else</span> {
+          id = attrs[targetModel.prototype.idAttribute];
+        }</pre></div></div>
             
         </li>
         
         
-        <li id="section-85">
+        <li id="section-83">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-85">&#182;</a>
+                <a class="pilcrow" href="#section-83">&#182;</a>
               </div>
               <p>If a duplicate is found, prevent it from being added and
-optionally merge it into the existing model.
-</p>
+optionally merge it into the existing model.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (existing = <span class="keyword">this</span>.get(model)) {
-          <span class="keyword">if</span> (options.remove) modelMap[existing.cid] = <span class="literal">true</span>;
-          <span class="keyword">if</span> (options.merge) {
-            existing.set(model.attributes, options);
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (existing = <span class="keyword">this</span>.get(id)) {
+          <span class="keyword">if</span> (remove) modelMap[existing.cid] = <span class="literal">true</span>;
+          <span class="keyword">if</span> (merge) {
+            attrs = attrs === model ? model.attributes : attrs;
+            <span class="keyword">if</span> (options.parse) attrs = existing.parse(attrs, options);
+            existing.set(attrs, options);
             <span class="keyword">if</span> (sortable &amp;&amp; !sort &amp;&amp; existing.hasChanged(sortAttr)) sort = <span class="literal">true</span>;
-          }</pre></div></div>
+          }
+          models[i] = existing;</pre></div></div>
             
         </li>
         
         
-        <li id="section-86">
+        <li id="section-84">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-86">&#182;</a>
+                <a class="pilcrow" href="#section-84">&#182;</a>
               </div>
-              <p>This is a new model, push it to the <code>toAdd</code> list.
-</p>
+              <p>If this is a new, valid model, push it to the <code>toAdd</code> list.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>        } <span class="keyword">else</span> <span class="keyword">if</span> (options.add) {
+            <div class="content"><div class='highlight'><pre>        } <span class="keyword">else</span> <span class="keyword">if</span> (add) {
+          model = models[i] = <span class="keyword">this</span>._prepareModel(attrs, options);
+          <span class="keyword">if</span> (!model) <span class="keyword">continue</span>;
           toAdd.push(model);</pre></div></div>
             
         </li>
         
         
-        <li id="section-87">
+        <li id="section-85">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-87">&#182;</a>
+                <a class="pilcrow" href="#section-85">&#182;</a>
               </div>
               <p>Listen to added models&#39; events, and index models for lookup by
-<code>id</code> and by <code>cid</code>.
-</p>
+<code>id</code> and by <code>cid</code>.</p>
 
             </div>
             
@@ -1834,23 +1735,23 @@ optionally merge it into the existing model.
           <span class="keyword">this</span>._byId[model.cid] = model;
           <span class="keyword">if</span> (model.id != <span class="literal">null</span>) <span class="keyword">this</span>._byId[model.id] = model;
         }
+        <span class="keyword">if</span> (order) order.push(existing || model);
       }</pre></div></div>
             
         </li>
         
         
-        <li id="section-88">
+        <li id="section-86">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-88">&#182;</a>
+                <a class="pilcrow" href="#section-86">&#182;</a>
               </div>
-              <p>Remove nonexistent models if appropriate.
-</p>
+              <p>Remove nonexistent models if appropriate.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (options.remove) {
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (remove) {
         <span class="keyword">for</span> (i = <span class="number">0</span>, l = <span class="keyword">this</span>.length; i &lt; l; ++i) {
           <span class="keyword">if</span> (!modelMap[(model = <span class="keyword">this</span>.models[i]).cid]) toRemove.push(model);
         }
@@ -1860,95 +1761,96 @@ optionally merge it into the existing model.
         </li>
         
         
-        <li id="section-89">
+        <li id="section-87">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-89">&#182;</a>
+                <a class="pilcrow" href="#section-87">&#182;</a>
               </div>
-              <p>See if sorting is needed, update <code>length</code> and splice in new models.
-</p>
+              <p>See if sorting is needed, update <code>length</code> and splice in new models.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (toAdd.length) {
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (toAdd.length || (order &amp;&amp; order.length)) {
         <span class="keyword">if</span> (sortable) sort = <span class="literal">true</span>;
         <span class="keyword">this</span>.length += toAdd.length;
         <span class="keyword">if</span> (at != <span class="literal">null</span>) {
-          splice.apply(<span class="keyword">this</span>.models, [at, <span class="number">0</span>].concat(toAdd));
+          <span class="keyword">for</span> (i = <span class="number">0</span>, l = toAdd.length; i &lt; l; i++) {
+            <span class="keyword">this</span>.models.splice(at + i, <span class="number">0</span>, toAdd[i]);
+          }
         } <span class="keyword">else</span> {
-          push.apply(<span class="keyword">this</span>.models, toAdd);
+          <span class="keyword">if</span> (order) <span class="keyword">this</span>.models.length = <span class="number">0</span>;
+          <span class="keyword">var</span> orderedModels = order || toAdd;
+          <span class="keyword">for</span> (i = <span class="number">0</span>, l = orderedModels.length; i &lt; l; i++) {
+            <span class="keyword">this</span>.models.push(orderedModels[i]);
+          }
         }
       }</pre></div></div>
             
         </li>
         
         
-        <li id="section-90">
+        <li id="section-88">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-90">&#182;</a>
+                <a class="pilcrow" href="#section-88">&#182;</a>
               </div>
-              <p>Silently sort the collection if appropriate.
-</p>
+              <p>Silently sort the collection if appropriate.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (sort) <span class="keyword">this</span>.sort({silent: <span class="literal">true</span>});
-
-      <span class="keyword">if</span> (options.silent) <span class="keyword">return</span> <span class="keyword">this</span>;</pre></div></div>
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (sort) <span class="keyword">this</span>.sort({silent: <span class="literal">true</span>});</pre></div></div>
             
         </li>
         
         
-        <li id="section-91">
+        <li id="section-89">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-91">&#182;</a>
+                <a class="pilcrow" href="#section-89">&#182;</a>
               </div>
-              <p>Trigger <code>add</code> events.
-</p>
+              <p>Unless silenced, it&#39;s time to fire all appropriate add/sort events.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> (i = <span class="number">0</span>, l = toAdd.length; i &lt; l; i++) {
-        (model = toAdd[i]).trigger(<span class="string">'add'</span>, model, <span class="keyword">this</span>, options);
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!options.silent) {
+        <span class="keyword">for</span> (i = <span class="number">0</span>, l = toAdd.length; i &lt; l; i++) {
+          (model = toAdd[i]).trigger(<span class="string">'add'</span>, model, <span class="keyword">this</span>, options);
+        }
+        <span class="keyword">if</span> (sort || (order &amp;&amp; order.length)) <span class="keyword">this</span>.trigger(<span class="string">'sort'</span>, <span class="keyword">this</span>, options);
       }</pre></div></div>
             
         </li>
         
         
-        <li id="section-92">
+        <li id="section-90">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-92">&#182;</a>
+                <a class="pilcrow" href="#section-90">&#182;</a>
               </div>
-              <p>Trigger <code>sort</code> if the collection was sorted.
-</p>
+              <p>Return the added (or merged) model (or models).</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (sort) <span class="keyword">this</span>.trigger(<span class="string">'sort'</span>, <span class="keyword">this</span>, options);
-      <span class="keyword">return</span> <span class="keyword">this</span>;
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> singular ? models[<span class="number">0</span>] : models;
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-93">
+        <li id="section-91">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-93">&#182;</a>
+                <a class="pilcrow" href="#section-91">&#182;</a>
               </div>
               <p>When you have more items than you want to add or remove individually,
 you can reset the entire set with a new list of models, without firing
 any granular <code>add</code> or <code>remove</code> events. Fires <code>reset</code> when finished.
-Useful for bulk operations and optimizations.
-</p>
+Useful for bulk operations and optimizations.</p>
 
             </div>
             
@@ -1959,42 +1861,38 @@ Useful for bulk operations and optimizations.
       }
       options.previousModels = <span class="keyword">this</span>.models;
       <span class="keyword">this</span>._reset();
-      <span class="keyword">this</span>.add(models, _.extend({silent: <span class="literal">true</span>}, options));
+      models = <span class="keyword">this</span>.add(models, _.extend({silent: <span class="literal">true</span>}, options));
       <span class="keyword">if</span> (!options.silent) <span class="keyword">this</span>.trigger(<span class="string">'reset'</span>, <span class="keyword">this</span>, options);
-      <span class="keyword">return</span> <span class="keyword">this</span>;
+      <span class="keyword">return</span> models;
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-94">
+        <li id="section-92">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-94">&#182;</a>
+                <a class="pilcrow" href="#section-92">&#182;</a>
               </div>
-              <p>Add a model to the end of the collection.
-</p>
+              <p>Add a model to the end of the collection.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    push: <span class="keyword">function</span>(model, options) {
-      model = <span class="keyword">this</span>._prepareModel(model, options);
-      <span class="keyword">this</span>.add(model, _.extend({at: <span class="keyword">this</span>.length}, options));
-      <span class="keyword">return</span> model;
+      <span class="keyword">return</span> <span class="keyword">this</span>.add(model, _.extend({at: <span class="keyword">this</span>.length}, options));
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-95">
+        <li id="section-93">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-95">&#182;</a>
+                <a class="pilcrow" href="#section-93">&#182;</a>
               </div>
-              <p>Remove a model from the end of the collection.
-</p>
+              <p>Remove a model from the end of the collection.</p>
 
             </div>
             
@@ -2007,34 +1905,30 @@ Useful for bulk operations and optimizations.
         </li>
         
         
-        <li id="section-96">
+        <li id="section-94">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-96">&#182;</a>
+                <a class="pilcrow" href="#section-94">&#182;</a>
               </div>
-              <p>Add a model to the beginning of the collection.
-</p>
+              <p>Add a model to the beginning of the collection.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    unshift: <span class="keyword">function</span>(model, options) {
-      model = <span class="keyword">this</span>._prepareModel(model, options);
-      <span class="keyword">this</span>.add(model, _.extend({at: <span class="number">0</span>}, options));
-      <span class="keyword">return</span> model;
+      <span class="keyword">return</span> <span class="keyword">this</span>.add(model, _.extend({at: <span class="number">0</span>}, options));
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-97">
+        <li id="section-95">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-97">&#182;</a>
+                <a class="pilcrow" href="#section-95">&#182;</a>
               </div>
-              <p>Remove a model from the beginning of the collection.
-</p>
+              <p>Remove a model from the beginning of the collection.</p>
 
             </div>
             
@@ -2047,51 +1941,48 @@ Useful for bulk operations and optimizations.
         </li>
         
         
-        <li id="section-98">
+        <li id="section-96">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-98">&#182;</a>
+                <a class="pilcrow" href="#section-96">&#182;</a>
               </div>
-              <p>Slice out a sub-array of models from the collection.
-</p>
+              <p>Slice out a sub-array of models from the collection.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>    slice: <span class="keyword">function</span>(begin, end) {
-      <span class="keyword">return</span> <span class="keyword">this</span>.models.slice(begin, end);
+            <div class="content"><div class='highlight'><pre>    slice: <span class="keyword">function</span>() {
+      <span class="keyword">return</span> slice.apply(<span class="keyword">this</span>.models, arguments);
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-99">
+        <li id="section-97">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-99">&#182;</a>
+                <a class="pilcrow" href="#section-97">&#182;</a>
               </div>
-              <p>Get a model from the set by id.
-</p>
+              <p>Get a model from the set by id.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    get: <span class="keyword">function</span>(obj) {
       <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
-      <span class="keyword">return</span> <span class="keyword">this</span>._byId[obj.id != <span class="literal">null</span> ? obj.id : obj.cid || obj];
+      <span class="keyword">return</span> <span class="keyword">this</span>._byId[obj.id] || <span class="keyword">this</span>._byId[obj.cid] || <span class="keyword">this</span>._byId[obj];
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-100">
+        <li id="section-98">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-100">&#182;</a>
+                <a class="pilcrow" href="#section-98">&#182;</a>
               </div>
-              <p>Get the model at the given index.
-</p>
+              <p>Get the model at the given index.</p>
 
             </div>
             
@@ -2102,15 +1993,14 @@ Useful for bulk operations and optimizations.
         </li>
         
         
-        <li id="section-101">
+        <li id="section-99">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-101">&#182;</a>
+                <a class="pilcrow" href="#section-99">&#182;</a>
               </div>
               <p>Return models with matching attributes. Useful for simple cases of
-<code>filter</code>.
-</p>
+<code>filter</code>.</p>
 
             </div>
             
@@ -2127,15 +2017,14 @@ Useful for bulk operations and optimizations.
         </li>
         
         
-        <li id="section-102">
+        <li id="section-100">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-102">&#182;</a>
+                <a class="pilcrow" href="#section-100">&#182;</a>
               </div>
               <p>Return the first model with matching attributes. Useful for simple cases
-of <code>find</code>.
-</p>
+of <code>find</code>.</p>
 
             </div>
             
@@ -2146,16 +2035,15 @@ of <code>find</code>.
         </li>
         
         
-        <li id="section-103">
+        <li id="section-101">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-103">&#182;</a>
+                <a class="pilcrow" href="#section-101">&#182;</a>
               </div>
               <p>Force the collection to re-sort itself. You don&#39;t need to call this under
 normal circumstances, as the set will maintain sort order as each item
-is added.
-</p>
+is added.</p>
 
             </div>
             
@@ -2166,14 +2054,13 @@ is added.
         </li>
         
         
-        <li id="section-104">
+        <li id="section-102">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-104">&#182;</a>
+                <a class="pilcrow" href="#section-102">&#182;</a>
               </div>
-              <p>Run sort based on type of <code>comparator</code>.
-</p>
+              <p>Run sort based on type of <code>comparator</code>.</p>
 
             </div>
             
@@ -2190,37 +2077,13 @@ is added.
         </li>
         
         
-        <li id="section-105">
-            <div class="annotation">
-              
-              <div class="pilwrap ">
-                <a class="pilcrow" href="#section-105">&#182;</a>
-              </div>
-              <p>Figure out the smallest index at which a model should be inserted so as
-to maintain order.
-</p>
-
-            </div>
-            
-            <div class="content"><div class='highlight'><pre>    sortedIndex: <span class="keyword">function</span>(model, value, context) {
-      value || (value = <span class="keyword">this</span>.comparator);
-      <span class="keyword">var</span> iterator = _.isFunction(value) ? value : <span class="keyword">function</span>(model) {
-        <span class="keyword">return</span> model.get(value);
-      };
-      <span class="keyword">return</span> _.sortedIndex(<span class="keyword">this</span>.models, model, iterator, context);
-    },</pre></div></div>
-            
-        </li>
-        
-        
-        <li id="section-106">
+        <li id="section-103">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-106">&#182;</a>
+                <a class="pilcrow" href="#section-103">&#182;</a>
               </div>
-              <p>Pluck an attribute from each model in the collection.
-</p>
+              <p>Pluck an attribute from each model in the collection.</p>
 
             </div>
             
@@ -2231,16 +2094,15 @@ to maintain order.
         </li>
         
         
-        <li id="section-107">
+        <li id="section-104">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-107">&#182;</a>
+                <a class="pilcrow" href="#section-104">&#182;</a>
               </div>
               <p>Fetch the default set of models for this collection, resetting the
 collection when they arrive. If <code>reset: true</code> is passed, the response
-data will be passed through the <code>reset</code> method instead of <code>set</code>.
-</p>
+data will be passed through the <code>reset</code> method instead of <code>set</code>.</p>
 
             </div>
             
@@ -2262,16 +2124,15 @@ data will be passed through the <code>reset</code> method instead of <code>set</
         </li>
         
         
-        <li id="section-108">
+        <li id="section-105">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-108">&#182;</a>
+                <a class="pilcrow" href="#section-105">&#182;</a>
               </div>
               <p>Create a new instance of a model in this collection. Add the model to the
 collection immediately, unless <code>wait: true</code> is passed, in which case we
-wait for the server to agree.
-</p>
+wait for the server to agree.</p>
 
             </div>
             
@@ -2281,7 +2142,7 @@ wait for the server to agree.
       <span class="keyword">if</span> (!options.wait) <span class="keyword">this</span>.add(model, options);
       <span class="keyword">var</span> collection = <span class="keyword">this</span>;
       <span class="keyword">var</span> success = options.success;
-      options.success = <span class="keyword">function</span>(resp) {
+      options.success = <span class="keyword">function</span>(model, resp, options) {
         <span class="keyword">if</span> (options.wait) collection.add(model, options);
         <span class="keyword">if</span> (success) success(model, resp, options);
       };
@@ -2292,15 +2153,14 @@ wait for the server to agree.
         </li>
         
         
-        <li id="section-109">
+        <li id="section-106">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-109">&#182;</a>
+                <a class="pilcrow" href="#section-106">&#182;</a>
               </div>
               <p><strong>parse</strong> converts a response into a list of models to be added to the
-collection. The default implementation is just to pass it through.
-</p>
+collection. The default implementation is just to pass it through.</p>
 
             </div>
             
@@ -2311,14 +2171,13 @@ collection. The default implementation is just to pass it through.
         </li>
         
         
-        <li id="section-110">
+        <li id="section-107">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-110">&#182;</a>
+                <a class="pilcrow" href="#section-107">&#182;</a>
               </div>
-              <p>Create a new collection with an identical list of models as this one.
-</p>
+              <p>Create a new collection with an identical list of models as this one.</p>
 
             </div>
             
@@ -2329,15 +2188,14 @@ collection. The default implementation is just to pass it through.
         </li>
         
         
-        <li id="section-111">
+        <li id="section-108">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-111">&#182;</a>
+                <a class="pilcrow" href="#section-108">&#182;</a>
               </div>
               <p>Private method to reset all internal state. Called when the collection
-is first initialized or reset.
-</p>
+is first initialized or reset.</p>
 
             </div>
             
@@ -2350,15 +2208,14 @@ is first initialized or reset.
         </li>
         
         
-        <li id="section-112">
+        <li id="section-109">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-112">&#182;</a>
+                <a class="pilcrow" href="#section-109">&#182;</a>
               </div>
               <p>Prepare a hash of attributes (or other model) to be added to this
-collection.
-</p>
+collection.</p>
 
             </div>
             
@@ -2367,27 +2224,24 @@ collection.
         <span class="keyword">if</span> (!attrs.collection) attrs.collection = <span class="keyword">this</span>;
         <span class="keyword">return</span> attrs;
       }
-      options || (options = {});
+      options = options ? _.clone(options) : {};
       options.collection = <span class="keyword">this</span>;
       <span class="keyword">var</span> model = <span class="keyword">new</span> <span class="keyword">this</span>.model(attrs, options);
-      <span class="keyword">if</span> (!model._validate(attrs, options)) {
-        <span class="keyword">this</span>.trigger(<span class="string">'invalid'</span>, <span class="keyword">this</span>, attrs, options);
-        <span class="keyword">return</span> <span class="literal">false</span>;
-      }
-      <span class="keyword">return</span> model;
+      <span class="keyword">if</span> (!model.validationError) <span class="keyword">return</span> model;
+      <span class="keyword">this</span>.trigger(<span class="string">'invalid'</span>, <span class="keyword">this</span>, model.validationError, options);
+      <span class="keyword">return</span> <span class="literal">false</span>;
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-113">
+        <li id="section-110">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-113">&#182;</a>
+                <a class="pilcrow" href="#section-110">&#182;</a>
               </div>
-              <p>Internal method to sever a model&#39;s ties to a collection.
-</p>
+              <p>Internal method to sever a model&#39;s ties to a collection.</p>
 
             </div>
             
@@ -2399,17 +2253,16 @@ collection.
         </li>
         
         
-        <li id="section-114">
+        <li id="section-111">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-114">&#182;</a>
+                <a class="pilcrow" href="#section-111">&#182;</a>
               </div>
               <p>Internal method called every time a model in the set fires an event.
 Sets need to update their indexes when models change ids. All other
 events simply proxy through. &quot;add&quot; and &quot;remove&quot; events that originate
-in other collections are ignored.
-</p>
+in other collections are ignored.</p>
 
             </div>
             
@@ -2428,16 +2281,15 @@ in other collections are ignored.
         </li>
         
         
-        <li id="section-115">
+        <li id="section-112">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-115">&#182;</a>
+                <a class="pilcrow" href="#section-112">&#182;</a>
               </div>
               <p>Underscore methods that we want to implement on the Collection.
 90% of the core usefulness of Backbone Collections is actually implemented
-right here:
-</p>
+right here:</p>
 
             </div>
             
@@ -2445,20 +2297,19 @@ right here:
     <span class="string">'inject'</span>, <span class="string">'reduceRight'</span>, <span class="string">'foldr'</span>, <span class="string">'find'</span>, <span class="string">'detect'</span>, <span class="string">'filter'</span>, <span class="string">'select'</span>,
     <span class="string">'reject'</span>, <span class="string">'every'</span>, <span class="string">'all'</span>, <span class="string">'some'</span>, <span class="string">'any'</span>, <span class="string">'include'</span>, <span class="string">'contains'</span>, <span class="string">'invoke'</span>,
     <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'toArray'</span>, <span class="string">'size'</span>, <span class="string">'first'</span>, <span class="string">'head'</span>, <span class="string">'take'</span>, <span class="string">'initial'</span>, <span class="string">'rest'</span>,
-    <span class="string">'tail'</span>, <span class="string">'drop'</span>, <span class="string">'last'</span>, <span class="string">'without'</span>, <span class="string">'indexOf'</span>, <span class="string">'shuffle'</span>, <span class="string">'lastIndexOf'</span>,
-    <span class="string">'isEmpty'</span>, <span class="string">'chain'</span>];</pre></div></div>
+    <span class="string">'tail'</span>, <span class="string">'drop'</span>, <span class="string">'last'</span>, <span class="string">'without'</span>, <span class="string">'difference'</span>, <span class="string">'indexOf'</span>, <span class="string">'shuffle'</span>,
+    <span class="string">'lastIndexOf'</span>, <span class="string">'isEmpty'</span>, <span class="string">'chain'</span>];</pre></div></div>
             
         </li>
         
         
-        <li id="section-116">
+        <li id="section-113">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-116">&#182;</a>
+                <a class="pilcrow" href="#section-113">&#182;</a>
               </div>
-              <p>Mix in each Underscore method as a proxy to <code>Collection#models</code>.
-</p>
+              <p>Mix in each Underscore method as a proxy to <code>Collection#models</code>.</p>
 
             </div>
             
@@ -2473,14 +2324,13 @@ right here:
         </li>
         
         
-        <li id="section-117">
+        <li id="section-114">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-117">&#182;</a>
+                <a class="pilcrow" href="#section-114">&#182;</a>
               </div>
-              <p>Underscore methods that take a property name as an argument.
-</p>
+              <p>Underscore methods that take a property name as an argument.</p>
 
             </div>
             
@@ -2489,14 +2339,13 @@ right here:
         </li>
         
         
-        <li id="section-118">
+        <li id="section-115">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-118">&#182;</a>
+                <a class="pilcrow" href="#section-115">&#182;</a>
               </div>
-              <p>Use attributes instead of properties.
-</p>
+              <p>Use attributes instead of properties.</p>
 
             </div>
             
@@ -2512,11 +2361,11 @@ right here:
         </li>
         
         
-        <li id="section-119">
+        <li id="section-116">
             <div class="annotation">
               
               <div class="pilwrap for-h2">
-                <a class="pilcrow" href="#section-119">&#182;</a>
+                <a class="pilcrow" href="#section-116">&#182;</a>
               </div>
               <h2>Backbone.View</h2>
 
@@ -2525,11 +2374,11 @@ right here:
         </li>
         
         
-        <li id="section-120">
+        <li id="section-117">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-120">&#182;</a>
+                <a class="pilcrow" href="#section-117">&#182;</a>
               </div>
               <p>Backbone Views are almost more convention than they are actual code. A View
 is simply a JavaScript object that represents a logical chunk of UI in the
@@ -2537,18 +2386,16 @@ DOM. This might be a single item, an entire list, a sidebar or panel, or
 even the surrounding frame which wraps your whole app. Defining a chunk of
 UI as a <strong>View</strong> allows you to define your DOM events declaratively, without
 having to worry about render order ... and makes it easy for the view to
-react to specific changes in the state of your models.
-
-</p>
+react to specific changes in the state of your models.</p>
 <p>Creating a Backbone.View creates its initial element outside of the DOM,
-if an existing element is not provided...
-</p>
+if an existing element is not provided...</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> View = Backbone.View = <span class="keyword">function</span>(options) {
     <span class="keyword">this</span>.cid = _.uniqueId(<span class="string">'view'</span>);
-    <span class="keyword">this</span>._configure(options || {});
+    options || (options = {});
+    _.extend(<span class="keyword">this</span>, _.pick(options, viewOptions));
     <span class="keyword">this</span>._ensureElement();
     <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
     <span class="keyword">this</span>.delegateEvents();
@@ -2557,14 +2404,13 @@ if an existing element is not provided...
         </li>
         
         
-        <li id="section-121">
+        <li id="section-118">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-121">&#182;</a>
+                <a class="pilcrow" href="#section-118">&#182;</a>
               </div>
-              <p>Cached regex to split keys for <code>delegate</code>.
-</p>
+              <p>Cached regex to split keys for <code>delegate</code>.</p>
 
             </div>
             
@@ -2573,14 +2419,13 @@ if an existing element is not provided...
         </li>
         
         
-        <li id="section-122">
+        <li id="section-119">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-122">&#182;</a>
+                <a class="pilcrow" href="#section-119">&#182;</a>
               </div>
-              <p>List of view options to be merged as properties.
-</p>
+              <p>List of view options to be merged as properties.</p>
 
             </div>
             
@@ -2589,14 +2434,13 @@ if an existing element is not provided...
         </li>
         
         
-        <li id="section-123">
+        <li id="section-120">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-123">&#182;</a>
+                <a class="pilcrow" href="#section-120">&#182;</a>
               </div>
-              <p>Set up all inheritable <strong>Backbone.View</strong> properties and methods.
-</p>
+              <p>Set up all inheritable <strong>Backbone.View</strong> properties and methods.</p>
 
             </div>
             
@@ -2605,14 +2449,13 @@ if an existing element is not provided...
         </li>
         
         
-        <li id="section-124">
+        <li id="section-121">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-124">&#182;</a>
+                <a class="pilcrow" href="#section-121">&#182;</a>
               </div>
-              <p>The default <code>tagName</code> of a View&#39;s element is <code>&quot;div&quot;</code>.
-</p>
+              <p>The default <code>tagName</code> of a View&#39;s element is <code>&quot;div&quot;</code>.</p>
 
             </div>
             
@@ -2621,15 +2464,14 @@ if an existing element is not provided...
         </li>
         
         
-        <li id="section-125">
+        <li id="section-122">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-125">&#182;</a>
+                <a class="pilcrow" href="#section-122">&#182;</a>
               </div>
               <p>jQuery delegate for element lookup, scoped to DOM elements within the
-current view. This should be prefered to global lookups where possible.
-</p>
+current view. This should be preferred to global lookups where possible.</p>
 
             </div>
             
@@ -2640,15 +2482,14 @@ current view. This should be prefered to global lookups where possible.
         </li>
         
         
-        <li id="section-126">
+        <li id="section-123">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-126">&#182;</a>
+                <a class="pilcrow" href="#section-123">&#182;</a>
               </div>
               <p>Initialize is an empty function by default. Override it with your own
-initialization logic.
-</p>
+initialization logic.</p>
 
             </div>
             
@@ -2657,16 +2498,15 @@ initialization logic.
         </li>
         
         
-        <li id="section-127">
+        <li id="section-124">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-127">&#182;</a>
+                <a class="pilcrow" href="#section-124">&#182;</a>
               </div>
               <p><strong>render</strong> is the core function that your view should override, in order
 to populate its element (<code>this.el</code>), with the appropriate HTML. The
-convention is for <strong>render</strong> to always return <code>this</code>.
-</p>
+convention is for <strong>render</strong> to always return <code>this</code>.</p>
 
             </div>
             
@@ -2677,15 +2517,14 @@ convention is for <strong>render</strong> to always return <code>this</code>.
         </li>
         
         
-        <li id="section-128">
+        <li id="section-125">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-128">&#182;</a>
+                <a class="pilcrow" href="#section-125">&#182;</a>
               </div>
               <p>Remove this view by taking the element out of the DOM, and removing any
-applicable Backbone.Events listeners.
-</p>
+applicable Backbone.Events listeners.</p>
 
             </div>
             
@@ -2698,15 +2537,14 @@ applicable Backbone.Events listeners.
         </li>
         
         
-        <li id="section-129">
+        <li id="section-126">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-129">&#182;</a>
+                <a class="pilcrow" href="#section-126">&#182;</a>
               </div>
               <p>Change the view&#39;s element (<code>this.el</code> property), including event
-re-delegation.
-</p>
+re-delegation.</p>
 
             </div>
             
@@ -2721,29 +2559,24 @@ re-delegation.
         </li>
         
         
-        <li id="section-130">
+        <li id="section-127">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-130">&#182;</a>
+                <a class="pilcrow" href="#section-127">&#182;</a>
               </div>
-              <p>Set callbacks, where <code>this.events</code> is a hash of
-
-</p>
-<p><em>{&quot;event selector&quot;: &quot;callback&quot;}</em>
-
-</p>
+              <p>Set callbacks, where <code>this.events</code> is a hash of</p>
+<p><em>{&quot;event selector&quot;: &quot;callback&quot;}</em></p>
 <pre><code>{
   &#39;mousedown .title&#39;:  &#39;edit&#39;,
-  &#39;click .button&#39;:     &#39;save&#39;
+  &#39;click .button&#39;:     &#39;save&#39;,
   &#39;click .open&#39;:       function(e) { ... }
 }</code></pre>
 <p>pairs. Callbacks will be bound to the view, with <code>this</code> set properly.
 Uses event delegation for efficiency.
 Omitting the selector binds the event to <code>this.el</code>.
 This only works for delegate-able events: not <code>focus</code>, <code>blur</code>, and
-not <code>change</code>, <code>submit</code>, and <code>reset</code> in Internet Explorer.
-</p>
+not <code>change</code>, <code>submit</code>, and <code>reset</code> in Internet Explorer.</p>
 
             </div>
             
@@ -2771,16 +2604,15 @@ not <code>change</code>, <code>submit</code>, and <code>reset</code> in Internet
         </li>
         
         
-        <li id="section-131">
+        <li id="section-128">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-131">&#182;</a>
+                <a class="pilcrow" href="#section-128">&#182;</a>
               </div>
               <p>Clears all callbacks previously bound to the view with <code>delegateEvents</code>.
 You usually don&#39;t need to use this, but may wish to if you have multiple
-Backbone views attached to the same DOM element.
-</p>
+Backbone views attached to the same DOM element.</p>
 
             </div>
             
@@ -2792,40 +2624,16 @@ Backbone views attached to the same DOM element.
         </li>
         
         
-        <li id="section-132">
-            <div class="annotation">
-              
-              <div class="pilwrap ">
-                <a class="pilcrow" href="#section-132">&#182;</a>
-              </div>
-              <p>Performs the initial configuration of a View with a set of options.
-Keys with special meaning <em>(e.g. model, collection, id, className)</em> are
-attached directly to the view.  See <code>viewOptions</code> for an exhaustive
-list.
-</p>
-
-            </div>
-            
-            <div class="content"><div class='highlight'><pre>    _configure: <span class="keyword">function</span>(options) {
-      <span class="keyword">if</span> (<span class="keyword">this</span>.options) options = _.extend({}, _.result(<span class="keyword">this</span>, <span class="string">'options'</span>), options);
-      _.extend(<span class="keyword">this</span>, _.pick(options, viewOptions));
-      <span class="keyword">this</span>.options = options;
-    },</pre></div></div>
-            
-        </li>
-        
-        
-        <li id="section-133">
+        <li id="section-129">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-133">&#182;</a>
+                <a class="pilcrow" href="#section-129">&#182;</a>
               </div>
               <p>Ensure that the View has a DOM element to render into.
 If <code>this.el</code> is a string, pass it through <code>$()</code>, take the first
 matching element, and re-assign it to <code>el</code>. Otherwise, create
-an element from the <code>id</code>, <code>className</code> and <code>tagName</code> properties.
-</p>
+an element from the <code>id</code>, <code>className</code> and <code>tagName</code> properties.</p>
 
             </div>
             
@@ -2846,11 +2654,11 @@ an element from the <code>id</code>, <code>className</code> and <code>tagName</c
         </li>
         
         
-        <li id="section-134">
+        <li id="section-130">
             <div class="annotation">
               
               <div class="pilwrap for-h2">
-                <a class="pilcrow" href="#section-134">&#182;</a>
+                <a class="pilcrow" href="#section-130">&#182;</a>
               </div>
               <h2>Backbone.sync</h2>
 
@@ -2859,18 +2667,16 @@ an element from the <code>id</code>, <code>className</code> and <code>tagName</c
         </li>
         
         
-        <li id="section-135">
+        <li id="section-131">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-135">&#182;</a>
+                <a class="pilcrow" href="#section-131">&#182;</a>
               </div>
               <p>Override this function to change the manner in which Backbone persists
 models to the server. You will be passed the type of request, and the
 model in question. By default, makes a RESTful Ajax request
-to the model&#39;s <code>url()</code>. Some possible customizations could be:
-
-</p>
+to the model&#39;s <code>url()</code>. Some possible customizations could be:</p>
 <ul>
 <li>Use <code>setTimeout</code> to batch rapid-fire updates into a single request.</li>
 <li>Send up the models as XML instead of JSON.</li>
@@ -2881,8 +2687,7 @@ as <code>POST</code>, with a <code>_method</code> parameter containing the true
 as well as all requests with the body as <code>application/x-www-form-urlencoded</code>
 instead of <code>application/json</code> with the model in a param named <code>model</code>.
 Useful when interfacing with server-side languages like <strong>PHP</strong> that make
-it difficult to read the body of <code>PUT</code> requests.
-</p>
+it difficult to read the body of <code>PUT</code> requests.</p>
 
             </div>
             
@@ -2892,14 +2697,13 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-136">
+        <li id="section-132">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-136">&#182;</a>
+                <a class="pilcrow" href="#section-132">&#182;</a>
               </div>
-              <p>Default options, unless specified.
-</p>
+              <p>Default options, unless specified.</p>
 
             </div>
             
@@ -2911,14 +2715,13 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-137">
+        <li id="section-133">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-137">&#182;</a>
+                <a class="pilcrow" href="#section-133">&#182;</a>
               </div>
-              <p>Default JSON-request options.
-</p>
+              <p>Default JSON-request options.</p>
 
             </div>
             
@@ -2927,14 +2730,13 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-138">
+        <li id="section-134">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-138">&#182;</a>
+                <a class="pilcrow" href="#section-134">&#182;</a>
               </div>
-              <p>Ensure that we have a URL.
-</p>
+              <p>Ensure that we have a URL.</p>
 
             </div>
             
@@ -2945,14 +2747,13 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-139">
+        <li id="section-135">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-139">&#182;</a>
+                <a class="pilcrow" href="#section-135">&#182;</a>
               </div>
-              <p>Ensure that we have the appropriate request data.
-</p>
+              <p>Ensure that we have the appropriate request data.</p>
 
             </div>
             
@@ -2964,14 +2765,13 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-140">
+        <li id="section-136">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-140">&#182;</a>
+                <a class="pilcrow" href="#section-136">&#182;</a>
               </div>
-              <p>For older servers, emulate JSON by encoding the request into an HTML-form.
-</p>
+              <p>For older servers, emulate JSON by encoding the request into an HTML-form.</p>
 
             </div>
             
@@ -2983,15 +2783,14 @@ it difficult to read the body of <code>PUT</code> requests.
         </li>
         
         
-        <li id="section-141">
+        <li id="section-137">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-141">&#182;</a>
+                <a class="pilcrow" href="#section-137">&#182;</a>
               </div>
               <p>For older servers, emulate HTTP by mimicking the HTTP method with <code>_method</code>
-And an <code>X-HTTP-Method-Override</code> header.
-</p>
+And an <code>X-HTTP-Method-Override</code> header.</p>
 
             </div>
             
@@ -3008,14 +2807,13 @@ And an <code>X-HTTP-Method-Override</code> header.
         </li>
         
         
-        <li id="section-142">
+        <li id="section-138">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-142">&#182;</a>
+                <a class="pilcrow" href="#section-138">&#182;</a>
               </div>
-              <p>Don&#39;t process data on a non-GET request.
-</p>
+              <p>Don&#39;t process data on a non-GET request.</p>
 
             </div>
             
@@ -3026,21 +2824,19 @@ And an <code>X-HTTP-Method-Override</code> header.
         </li>
         
         
-        <li id="section-143">
+        <li id="section-139">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-143">&#182;</a>
+                <a class="pilcrow" href="#section-139">&#182;</a>
               </div>
               <p>If we&#39;re sending a <code>PATCH</code> request, and we&#39;re in an old Internet Explorer
 that still has ActiveX enabled by default, override jQuery to use that
-for XHR instead. Remove this line when jQuery supports <code>PATCH</code> on IE8.
-</p>
+for XHR instead. Remove this line when jQuery supports <code>PATCH</code> on IE8.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (params.type === <span class="string">'PATCH'</span> &amp;&amp; window.ActiveXObject &amp;&amp;
-          !(window.external &amp;&amp; window.external.msActiveXFilteringEnabled)) {
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (params.type === <span class="string">'PATCH'</span> &amp;&amp; noXhrPatch) {
       params.xhr = <span class="keyword">function</span>() {
         <span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);
       };
@@ -3049,33 +2845,33 @@ for XHR instead. Remove this line when jQuery supports <code>PATCH</code> on IE8
         </li>
         
         
-        <li id="section-144">
+        <li id="section-140">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-144">&#182;</a>
+                <a class="pilcrow" href="#section-140">&#182;</a>
               </div>
-              <p>Make the request, allowing the user to override any Ajax options.
-</p>
+              <p>Make the request, allowing the user to override any Ajax options.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> xhr = options.xhr = Backbone.ajax(_.extend(params, options));
     model.trigger(<span class="string">'request'</span>, model, xhr, options);
     <span class="keyword">return</span> xhr;
-  };</pre></div></div>
+  };
+
+  <span class="keyword">var</span> noXhrPatch = <span class="keyword">typeof</span> window !== <span class="string">'undefined'</span> &amp;&amp; !!window.ActiveXObject &amp;&amp; !(window.XMLHttpRequest &amp;&amp; (<span class="keyword">new</span> XMLHttpRequest).dispatchEvent);</pre></div></div>
             
         </li>
         
         
-        <li id="section-145">
+        <li id="section-141">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-145">&#182;</a>
+                <a class="pilcrow" href="#section-141">&#182;</a>
               </div>
-              <p>Map from CRUD to HTTP for our default <code>Backbone.sync</code> implementation.
-</p>
+              <p>Map from CRUD to HTTP for our default <code>Backbone.sync</code> implementation.</p>
 
             </div>
             
@@ -3090,15 +2886,14 @@ for XHR instead. Remove this line when jQuery supports <code>PATCH</code> on IE8
         </li>
         
         
-        <li id="section-146">
+        <li id="section-142">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-146">&#182;</a>
+                <a class="pilcrow" href="#section-142">&#182;</a>
               </div>
               <p>Set the default implementation of <code>Backbone.ajax</code> to proxy through to <code>$</code>.
-Override this if you&#39;d like to use a different library.
-</p>
+Override this if you&#39;d like to use a different library.</p>
 
             </div>
             
@@ -3109,11 +2904,11 @@ Override this if you&#39;d like to use a different library.
         </li>
         
         
-        <li id="section-147">
+        <li id="section-143">
             <div class="annotation">
               
               <div class="pilwrap for-h2">
-                <a class="pilcrow" href="#section-147">&#182;</a>
+                <a class="pilcrow" href="#section-143">&#182;</a>
               </div>
               <h2>Backbone.Router</h2>
 
@@ -3122,15 +2917,14 @@ Override this if you&#39;d like to use a different library.
         </li>
         
         
-        <li id="section-148">
+        <li id="section-144">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-148">&#182;</a>
+                <a class="pilcrow" href="#section-144">&#182;</a>
               </div>
               <p>Routers map faux-URLs to actions, and fire events when routes are
-matched. Creating a new one sets its <code>routes</code> hash, if not set statically.
-</p>
+matched. Creating a new one sets its <code>routes</code> hash, if not set statically.</p>
 
             </div>
             
@@ -3144,15 +2938,14 @@ matched. Creating a new one sets its <code>routes</code> hash, if not set static
         </li>
         
         
-        <li id="section-149">
+        <li id="section-145">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-149">&#182;</a>
+                <a class="pilcrow" href="#section-145">&#182;</a>
               </div>
               <p>Cached regular expressions for matching named param parts and splatted
-parts of route strings.
-</p>
+parts of route strings.</p>
 
             </div>
             
@@ -3164,14 +2957,13 @@ parts of route strings.
         </li>
         
         
-        <li id="section-150">
+        <li id="section-146">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-150">&#182;</a>
+                <a class="pilcrow" href="#section-146">&#182;</a>
               </div>
-              <p>Set up all inheritable <strong>Backbone.Router</strong> properties and methods.
-</p>
+              <p>Set up all inheritable <strong>Backbone.Router</strong> properties and methods.</p>
 
             </div>
             
@@ -3180,15 +2972,14 @@ parts of route strings.
         </li>
         
         
-        <li id="section-151">
+        <li id="section-147">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-151">&#182;</a>
+                <a class="pilcrow" href="#section-147">&#182;</a>
               </div>
               <p>Initialize is an empty function by default. Override it with your own
-initialization logic.
-</p>
+initialization logic.</p>
 
             </div>
             
@@ -3197,15 +2988,13 @@ initialization logic.
         </li>
         
         
-        <li id="section-152">
+        <li id="section-148">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-152">&#182;</a>
+                <a class="pilcrow" href="#section-148">&#182;</a>
               </div>
-              <p>Manually bind a single named route to a callback. For example:
-
-</p>
+              <p>Manually bind a single named route to a callback. For example:</p>
 <pre><code>this.route(&#39;search/:query/p:num&#39;, &#39;search&#39;, function(query, num) {
   ...
 });</code></pre>
@@ -3233,14 +3022,13 @@ initialization logic.
         </li>
         
         
-        <li id="section-153">
+        <li id="section-149">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-153">&#182;</a>
+                <a class="pilcrow" href="#section-149">&#182;</a>
               </div>
-              <p>Simple proxy to <code>Backbone.history</code> to save a fragment into the history.
-</p>
+              <p>Simple proxy to <code>Backbone.history</code> to save a fragment into the history.</p>
 
             </div>
             
@@ -3252,16 +3040,15 @@ initialization logic.
         </li>
         
         
-        <li id="section-154">
+        <li id="section-150">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-154">&#182;</a>
+                <a class="pilcrow" href="#section-150">&#182;</a>
               </div>
               <p>Bind all defined routes to <code>Backbone.history</code>. We have to reverse the
 order of the routes here to support behavior where the most general
-routes can be defined at the bottom of the route map.
-</p>
+routes can be defined at the bottom of the route map.</p>
 
             </div>
             
@@ -3277,22 +3064,21 @@ routes can be defined at the bottom of the route map.
         </li>
         
         
-        <li id="section-155">
+        <li id="section-151">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-155">&#182;</a>
+                <a class="pilcrow" href="#section-151">&#182;</a>
               </div>
               <p>Convert a route string into a regular expression, suitable for matching
-against the current location hash.
-</p>
+against the current location hash.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    _routeToRegExp: <span class="keyword">function</span>(route) {
       route = route.replace(escapeRegExp, <span class="string">'\\$&amp;'</span>)
                    .replace(optionalParam, <span class="string">'(?:$1)?'</span>)
-                   .replace(namedParam, <span class="keyword">function</span>(match, optional){
+                   .replace(namedParam, <span class="keyword">function</span>(match, optional) {
                      <span class="keyword">return</span> optional ? match : <span class="string">'([^\/]+)'</span>;
                    })
                    .replace(splatParam, <span class="string">'(.*?)'</span>);
@@ -3302,16 +3088,15 @@ against the current location hash.
         </li>
         
         
-        <li id="section-156">
+        <li id="section-152">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-156">&#182;</a>
+                <a class="pilcrow" href="#section-152">&#182;</a>
               </div>
               <p>Given a route, and a URL fragment that it matches, return the array of
 extracted decoded parameters. Empty or unmatched parameters will be
-treated as <code>null</code> to normalize cross-browser behavior.
-</p>
+treated as <code>null</code> to normalize cross-browser behavior.</p>
 
             </div>
             
@@ -3327,11 +3112,11 @@ treated as <code>null</code> to normalize cross-browser behavior.
         </li>
         
         
-        <li id="section-157">
+        <li id="section-153">
             <div class="annotation">
               
               <div class="pilwrap for-h2">
-                <a class="pilcrow" href="#section-157">&#182;</a>
+                <a class="pilcrow" href="#section-153">&#182;</a>
               </div>
               <h2>Backbone.History</h2>
 
@@ -3340,18 +3125,17 @@ treated as <code>null</code> to normalize cross-browser behavior.
         </li>
         
         
-        <li id="section-158">
+        <li id="section-154">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-158">&#182;</a>
+                <a class="pilcrow" href="#section-154">&#182;</a>
               </div>
               <p>Handles cross-browser history management, based on either
 <a href="http://diveintohtml5.info/history.html">pushState</a> and real URLs, or
 <a href="https://developer.mozilla.org/en-US/docs/DOM/window.onhashchange">onhashchange</a>
 and URL fragments. If the browser supports neither (old IE, natch),
-falls back to polling.
-</p>
+falls back to polling.</p>
 
             </div>
             
@@ -3362,14 +3146,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-159">
+        <li id="section-155">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-159">&#182;</a>
+                <a class="pilcrow" href="#section-155">&#182;</a>
               </div>
-              <p>Ensure that <code>History</code> can be used outside of the browser.
-</p>
+              <p>Ensure that <code>History</code> can be used outside of the browser.</p>
 
             </div>
             
@@ -3382,14 +3165,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-160">
+        <li id="section-156">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-160">&#182;</a>
+                <a class="pilcrow" href="#section-156">&#182;</a>
               </div>
-              <p>Cached regex for stripping a leading hash/slash and trailing space.
-</p>
+              <p>Cached regex for stripping a leading hash/slash and trailing space.</p>
 
             </div>
             
@@ -3398,14 +3180,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-161">
+        <li id="section-157">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-161">&#182;</a>
+                <a class="pilcrow" href="#section-157">&#182;</a>
               </div>
-              <p>Cached regex for stripping leading and trailing slashes.
-</p>
+              <p>Cached regex for stripping leading and trailing slashes.</p>
 
             </div>
             
@@ -3414,14 +3195,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-162">
+        <li id="section-158">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-162">&#182;</a>
+                <a class="pilcrow" href="#section-158">&#182;</a>
               </div>
-              <p>Cached regex for detecting MSIE.
-</p>
+              <p>Cached regex for detecting MSIE.</p>
 
             </div>
             
@@ -3430,14 +3210,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-163">
+        <li id="section-159">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-163">&#182;</a>
+                <a class="pilcrow" href="#section-159">&#182;</a>
               </div>
-              <p>Cached regex for removing a trailing slash.
-</p>
+              <p>Cached regex for removing a trailing slash.</p>
 
             </div>
             
@@ -3446,14 +3225,28 @@ falls back to polling.
         </li>
         
         
-        <li id="section-164">
+        <li id="section-160">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-164">&#182;</a>
+                <a class="pilcrow" href="#section-160">&#182;</a>
               </div>
-              <p>Has the history handling already been started?
-</p>
+              <p>Cached regex for stripping urls of hash and query.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> pathStripper = <span class="regexp">/[?#].*$/</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-161">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-161">&#182;</a>
+              </div>
+              <p>Has the history handling already been started?</p>
 
             </div>
             
@@ -3462,14 +3255,13 @@ falls back to polling.
         </li>
         
         
-        <li id="section-165">
+        <li id="section-162">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-165">&#182;</a>
+                <a class="pilcrow" href="#section-162">&#182;</a>
               </div>
-              <p>Set up all inheritable <strong>Backbone.History</strong> properties and methods.
-</p>
+              <p>Set up all inheritable <strong>Backbone.History</strong> properties and methods.</p>
 
             </div>
             
@@ -3478,15 +3270,14 @@ falls back to polling.
         </li>
         
         
-        <li id="section-166">
+        <li id="section-163">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-166">&#182;</a>
+                <a class="pilcrow" href="#section-163">&#182;</a>
               </div>
               <p>The default interval to poll for hash changes, if necessary, is
-twenty times a second.
-</p>
+twenty times a second.</p>
 
             </div>
             
@@ -3495,15 +3286,14 @@ twenty times a second.
         </li>
         
         
-        <li id="section-167">
+        <li id="section-164">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-167">&#182;</a>
+                <a class="pilcrow" href="#section-164">&#182;</a>
               </div>
               <p>Gets the true hash value. Cannot use location.hash directly due to bug
-in Firefox where location.hash will always be decoded.
-</p>
+in Firefox where location.hash will always be decoded.</p>
 
             </div>
             
@@ -3515,15 +3305,14 @@ in Firefox where location.hash will always be decoded.
         </li>
         
         
-        <li id="section-168">
+        <li id="section-165">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-168">&#182;</a>
+                <a class="pilcrow" href="#section-165">&#182;</a>
               </div>
               <p>Get the cross-browser normalized URL fragment, either from the URL,
-the hash, or the override.
-</p>
+the hash, or the override.</p>
 
             </div>
             
@@ -3532,7 +3321,7 @@ the hash, or the override.
         <span class="keyword">if</span> (<span class="keyword">this</span>._hasPushState || !<span class="keyword">this</span>._wantsHashChange || forcePushState) {
           fragment = <span class="keyword">this</span>.location.pathname;
           <span class="keyword">var</span> root = <span class="keyword">this</span>.root.replace(trailingSlash, <span class="string">''</span>);
-          <span class="keyword">if</span> (!fragment.indexOf(root)) fragment = fragment.substr(root.length);
+          <span class="keyword">if</span> (!fragment.indexOf(root)) fragment = fragment.slice(root.length);
         } <span class="keyword">else</span> {
           fragment = <span class="keyword">this</span>.getHash();
         }
@@ -3543,15 +3332,14 @@ the hash, or the override.
         </li>
         
         
-        <li id="section-169">
+        <li id="section-166">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-169">&#182;</a>
+                <a class="pilcrow" href="#section-166">&#182;</a>
               </div>
               <p>Start the hash change handling, returning <code>true</code> if the current URL matches
-an existing route, and <code>false</code> otherwise.
-</p>
+an existing route, and <code>false</code> otherwise.</p>
 
             </div>
             
@@ -3562,19 +3350,18 @@ an existing route, and <code>false</code> otherwise.
         </li>
         
         
-        <li id="section-170">
+        <li id="section-167">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-170">&#182;</a>
+                <a class="pilcrow" href="#section-167">&#182;</a>
               </div>
               <p>Figure out the initial configuration. Do we need an iframe?
-Is pushState desired ... is it available?
-</p>
+Is pushState desired ... is it available?</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.options          = _.extend({}, {root: <span class="string">'/'</span>}, <span class="keyword">this</span>.options, options);
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.options          = _.extend({root: <span class="string">'/'</span>}, <span class="keyword">this</span>.options, options);
       <span class="keyword">this</span>.root             = <span class="keyword">this</span>.options.root;
       <span class="keyword">this</span>._wantsHashChange = <span class="keyword">this</span>.options.hashChange !== <span class="literal">false</span>;
       <span class="keyword">this</span>._wantsPushState  = !!<span class="keyword">this</span>.options.pushState;
@@ -3586,14 +3373,13 @@ Is pushState desired ... is it available?
         </li>
         
         
-        <li id="section-171">
+        <li id="section-168">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-171">&#182;</a>
+                <a class="pilcrow" href="#section-168">&#182;</a>
               </div>
-              <p>Normalize root to always include a leading and trailing slash.
-</p>
+              <p>Normalize root to always include a leading and trailing slash.</p>
 
             </div>
             
@@ -3607,15 +3393,14 @@ Is pushState desired ... is it available?
         </li>
         
         
-        <li id="section-172">
+        <li id="section-169">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-172">&#182;</a>
+                <a class="pilcrow" href="#section-169">&#182;</a>
               </div>
               <p>Depending on whether we&#39;re using pushState or hashes, and whether
-&#39;onhashchange&#39; is supported, determine how we check the URL state.
-</p>
+&#39;onhashchange&#39; is supported, determine how we check the URL state.</p>
 
             </div>
             
@@ -3630,15 +3415,14 @@ Is pushState desired ... is it available?
         </li>
         
         
-        <li id="section-173">
+        <li id="section-170">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-173">&#182;</a>
+                <a class="pilcrow" href="#section-170">&#182;</a>
               </div>
               <p>Determine if we need to change the base url, for a pushState link
-opened by a non-pushState browser.
-</p>
+opened by a non-pushState browser.</p>
 
             </div>
             
@@ -3649,56 +3433,71 @@ opened by a non-pushState browser.
         </li>
         
         
-        <li id="section-174">
+        <li id="section-171">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-174">&#182;</a>
+                <a class="pilcrow" href="#section-171">&#182;</a>
               </div>
-              <p>If we&#39;ve started off with a route from a <code>pushState</code>-enabled browser,
-but we&#39;re currently in a browser that doesn&#39;t support it...
-</p>
+              <p>Transition from hashChange to pushState or vice versa if both are
+requested.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>._wantsHashChange &amp;&amp; <span class="keyword">this</span>._wantsPushState &amp;&amp; !<span class="keyword">this</span>._hasPushState &amp;&amp; !atRoot) {
-        <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getFragment(<span class="literal">null</span>, <span class="literal">true</span>);
-        <span class="keyword">this</span>.location.replace(<span class="keyword">this</span>.root + <span class="keyword">this</span>.location.search + <span class="string">'#'</span> + <span class="keyword">this</span>.fragment);</pre></div></div>
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>._wantsHashChange &amp;&amp; <span class="keyword">this</span>._wantsPushState) {</pre></div></div>
             
         </li>
         
         
-        <li id="section-175">
+        <li id="section-172">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-175">&#182;</a>
+                <a class="pilcrow" href="#section-172">&#182;</a>
               </div>
-              <p>Return immediately as browser will do redirect to new url
-</p>
+              <p>If we&#39;ve started off with a route from a <code>pushState</code>-enabled
+browser, but we&#39;re currently in a browser that doesn&#39;t support it...</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">true</span>;</pre></div></div>
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!<span class="keyword">this</span>._hasPushState &amp;&amp; !atRoot) {
+          <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getFragment(<span class="literal">null</span>, <span class="literal">true</span>);
+          <span class="keyword">this</span>.location.replace(<span class="keyword">this</span>.root + <span class="keyword">this</span>.location.search + <span class="string">'#'</span> + <span class="keyword">this</span>.fragment);</pre></div></div>
             
         </li>
         
         
-        <li id="section-176">
+        <li id="section-173">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-176">&#182;</a>
+                <a class="pilcrow" href="#section-173">&#182;</a>
+              </div>
+              <p>Return immediately as browser will do redirect to new url</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> <span class="literal">true</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-174">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-174">&#182;</a>
               </div>
               <p>Or if we&#39;ve started out with a hash-based route, but we&#39;re currently
-in a browser where it could be <code>pushState</code>-based instead...
-</p>
+in a browser where it could be <code>pushState</code>-based instead...</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>      } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._wantsPushState &amp;&amp; <span class="keyword">this</span>._hasPushState &amp;&amp; atRoot &amp;&amp; loc.hash) {
-        <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getHash().replace(routeStripper, <span class="string">''</span>);
-        <span class="keyword">this</span>.history.replaceState({}, document.title, <span class="keyword">this</span>.root + <span class="keyword">this</span>.fragment + loc.search);
+            <div class="content"><div class='highlight'><pre>        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._hasPushState &amp;&amp; atRoot &amp;&amp; loc.hash) {
+          <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getHash().replace(routeStripper, <span class="string">''</span>);
+          <span class="keyword">this</span>.history.replaceState({}, document.title, <span class="keyword">this</span>.root + <span class="keyword">this</span>.fragment + loc.search);
+        }
+
       }
 
       <span class="keyword">if</span> (!<span class="keyword">this</span>.options.silent) <span class="keyword">return</span> <span class="keyword">this</span>.loadUrl();
@@ -3707,15 +3506,14 @@ in a browser where it could be <code>pushState</code>-based instead...
         </li>
         
         
-        <li id="section-177">
+        <li id="section-175">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-177">&#182;</a>
+                <a class="pilcrow" href="#section-175">&#182;</a>
               </div>
               <p>Disable Backbone.history, perhaps temporarily. Not useful in a real app,
-but possibly useful for unit testing Routers.
-</p>
+but possibly useful for unit testing Routers.</p>
 
             </div>
             
@@ -3728,15 +3526,14 @@ but possibly useful for unit testing Routers.
         </li>
         
         
-        <li id="section-178">
+        <li id="section-176">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-178">&#182;</a>
+                <a class="pilcrow" href="#section-176">&#182;</a>
               </div>
               <p>Add a route to be tested when the fragment changes. Routes added later
-may override previous routes.
-</p>
+may override previous routes.</p>
 
             </div>
             
@@ -3747,15 +3544,14 @@ may override previous routes.
         </li>
         
         
-        <li id="section-179">
+        <li id="section-177">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-179">&#182;</a>
+                <a class="pilcrow" href="#section-177">&#182;</a>
               </div>
               <p>Checks the current URL to see if it has changed, and if it has,
-calls <code>loadUrl</code>, normalizing across the hidden iframe.
-</p>
+calls <code>loadUrl</code>, normalizing across the hidden iframe.</p>
 
             </div>
             
@@ -3766,64 +3562,90 @@ calls <code>loadUrl</code>, normalizing across the hidden iframe.
       }
       <span class="keyword">if</span> (current === <span class="keyword">this</span>.fragment) <span class="keyword">return</span> <span class="literal">false</span>;
       <span class="keyword">if</span> (<span class="keyword">this</span>.iframe) <span class="keyword">this</span>.navigate(current);
-      <span class="keyword">this</span>.loadUrl() || <span class="keyword">this</span>.loadUrl(<span class="keyword">this</span>.getHash());
+      <span class="keyword">this</span>.loadUrl();
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-180">
+        <li id="section-178">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-180">&#182;</a>
+                <a class="pilcrow" href="#section-178">&#182;</a>
               </div>
               <p>Attempt to load the current URL fragment. If a route succeeds with a
 match, returns <code>true</code>. If no defined routes matches the fragment,
-returns <code>false</code>.
-</p>
+returns <code>false</code>.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>    loadUrl: <span class="keyword">function</span>(fragmentOverride) {
-      <span class="keyword">var</span> fragment = <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getFragment(fragmentOverride);
-      <span class="keyword">var</span> matched = _.any(<span class="keyword">this</span>.handlers, <span class="keyword">function</span>(handler) {
+            <div class="content"><div class='highlight'><pre>    loadUrl: <span class="keyword">function</span>(fragment) {
+      fragment = <span class="keyword">this</span>.fragment = <span class="keyword">this</span>.getFragment(fragment);
+      <span class="keyword">return</span> _.any(<span class="keyword">this</span>.handlers, <span class="keyword">function</span>(handler) {
         <span class="keyword">if</span> (handler.route.test(fragment)) {
           handler.callback(fragment);
           <span class="keyword">return</span> <span class="literal">true</span>;
         }
       });
-      <span class="keyword">return</span> matched;
     },</pre></div></div>
             
         </li>
         
         
-        <li id="section-181">
+        <li id="section-179">
             <div class="annotation">
               
               <div class="pilwrap ">
-                <a class="pilcrow" href="#section-181">&#182;</a>
+                <a class="pilcrow" href="#section-179">&#182;</a>
               </div>
               <p>Save a fragment into the hash history, or replace the URL state if the
 &#39;replace&#39; option is passed. You are responsible for properly URL-encoding
-the fragment in advance.
-
-</p>
+the fragment in advance.</p>
 <p>The options object can contain <code>trigger: true</code> if you wish to have the
 route callback be fired (not usually desirable), or <code>replace: true</code>, if
-you wish to modify the current URL without adding an entry to the history.
-</p>
+you wish to modify the current URL without adding an entry to the history.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    navigate: <span class="keyword">function</span>(fragment, options) {
       <span class="keyword">if</span> (!History.started) <span class="keyword">return</span> <span class="literal">false</span>;
-      <span class="keyword">if</span> (!options || options === <span class="literal">true</span>) options = {trigger: options};
-      fragment = <span class="keyword">this</span>.getFragment(fragment || <span class="string">''</span>);
+      <span class="keyword">if</span> (!options || options === <span class="literal">true</span>) options = {trigger: !!options};
+
+      <span class="keyword">var</span> url = <span class="keyword">this</span>.root + (fragment = <span class="keyword">this</span>.getFragment(fragment || <span class="string">''</span>));</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-180">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-180">&#182;</a>
+              </div>
+              <p>Strip the fragment of the query and hash for matching.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      fragment = fragment.replace(pathStripper, <span class="string">''</span>);
+
       <span class="keyword">if</span> (<span class="keyword">this</span>.fragment === fragment) <span class="keyword">return</span>;
-      <span class="keyword">this</span>.fragment = fragment;
-      <span class="keyword">var</span> url = <span class="keyword">this</span>.root + fragment;</pre></div></div>
+      <span class="keyword">this</span>.fragment = fragment;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-181">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-181">&#182;</a>
+              </div>
+              <p>Don&#39;t include a trailing slash on the root.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (fragment === <span class="string">''</span> &amp;&amp; url !== <span class="string">'/'</span>) url = url.slice(<span class="number">0</span>, -<span class="number">1</span>);</pre></div></div>
             
         </li>
         
@@ -3834,8 +3656,7 @@ you wish to modify the current URL without adding an entry to the history.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-182">&#182;</a>
               </div>
-              <p>If pushState is available, we use it to set the fragment as a real URL.
-</p>
+              <p>If pushState is available, we use it to set the fragment as a real URL.</p>
 
             </div>
             
@@ -3852,8 +3673,7 @@ you wish to modify the current URL without adding an entry to the history.
                 <a class="pilcrow" href="#section-183">&#182;</a>
               </div>
               <p>If hash changes haven&#39;t been explicitly disabled, update the hash
-fragment to store history.
-</p>
+fragment to store history.</p>
 
             </div>
             
@@ -3872,8 +3692,7 @@ fragment to store history.
               </div>
               <p>Opening and closing the iframe tricks IE7 and earlier to push a
 history entry on hash-tag change.  When replace is true, we don&#39;t
-want this.
-</p>
+want this.</p>
 
             </div>
             
@@ -3891,15 +3710,14 @@ want this.
                 <a class="pilcrow" href="#section-185">&#182;</a>
               </div>
               <p>If you&#39;ve told us that you explicitly don&#39;t want fallback hashchange-
-based history, then <code>navigate</code> becomes a page refresh.
-</p>
+based history, then <code>navigate</code> becomes a page refresh.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>      } <span class="keyword">else</span> {
         <span class="keyword">return</span> <span class="keyword">this</span>.location.assign(url);
       }
-      <span class="keyword">if</span> (options.trigger) <span class="keyword">this</span>.loadUrl(fragment);
+      <span class="keyword">if</span> (options.trigger) <span class="keyword">return</span> <span class="keyword">this</span>.loadUrl(fragment);
     },</pre></div></div>
             
         </li>
@@ -3912,8 +3730,7 @@ based history, then <code>navigate</code> becomes a page refresh.
                 <a class="pilcrow" href="#section-186">&#182;</a>
               </div>
               <p>Update the hash location, either replacing the current entry, or adding
-a new one to the browser history.
-</p>
+a new one to the browser history.</p>
 
             </div>
             
@@ -3932,8 +3749,7 @@ a new one to the browser history.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-187">&#182;</a>
               </div>
-              <p>Some browsers require that <code>hash</code> contains a leading #.
-</p>
+              <p>Some browsers require that <code>hash</code> contains a leading #.</p>
 
             </div>
             
@@ -3952,8 +3768,7 @@ a new one to the browser history.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-188">&#182;</a>
               </div>
-              <p>Create the default Backbone.history.
-</p>
+              <p>Create the default Backbone.history.</p>
 
             </div>
             
@@ -3983,8 +3798,7 @@ a new one to the browser history.
               </div>
               <p>Helper function to correctly set up the prototype chain, for subclasses.
 Similar to <code>goog.inherits</code>, but uses a hash of prototype properties and
-class properties to be extended.
-</p>
+class properties to be extended.</p>
 
             </div>
             
@@ -4003,8 +3817,7 @@ class properties to be extended.
               </div>
               <p>The constructor function for the new subclass is either defined by you
 (the &quot;constructor&quot; property in your <code>extend</code> definition), or defaulted
-by us to simply call the parent&#39;s constructor.
-</p>
+by us to simply call the parent&#39;s constructor.</p>
 
             </div>
             
@@ -4023,8 +3836,7 @@ by us to simply call the parent&#39;s constructor.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-192">&#182;</a>
               </div>
-              <p>Add static properties to the constructor function, if supplied.
-</p>
+              <p>Add static properties to the constructor function, if supplied.</p>
 
             </div>
             
@@ -4040,8 +3852,7 @@ by us to simply call the parent&#39;s constructor.
                 <a class="pilcrow" href="#section-193">&#182;</a>
               </div>
               <p>Set the prototype chain to inherit from <code>parent</code>, without calling
-<code>parent</code>&#39;s constructor function.
-</p>
+<code>parent</code>&#39;s constructor function.</p>
 
             </div>
             
@@ -4059,8 +3870,7 @@ by us to simply call the parent&#39;s constructor.
                 <a class="pilcrow" href="#section-194">&#182;</a>
               </div>
               <p>Add prototype properties (instance properties) to the subclass,
-if supplied.
-</p>
+if supplied.</p>
 
             </div>
             
@@ -4076,8 +3886,7 @@ if supplied.
                 <a class="pilcrow" href="#section-195">&#182;</a>
               </div>
               <p>Set a convenience property in case the parent&#39;s prototype is needed
-later.
-</p>
+later.</p>
 
             </div>
             
@@ -4095,8 +3904,7 @@ later.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-196">&#182;</a>
               </div>
-              <p>Set up inheritance for the model, collection, router, view and history.
-</p>
+              <p>Set up inheritance for the model, collection, router, view and history.</p>
 
             </div>
             
@@ -4111,8 +3919,7 @@ later.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-197">&#182;</a>
               </div>
-              <p>Throw an error when a URL is needed, and none is supplied.
-</p>
+              <p>Throw an error when a URL is needed, and none is supplied.</p>
 
             </div>
             
@@ -4129,12 +3936,11 @@ later.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-198">&#182;</a>
               </div>
-              <p>Wrap an optional error callback with a fallback error event.
-</p>
+              <p>Wrap an optional error callback with a fallback error event.</p>
 
             </div>
             
-            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> wrapError = <span class="function"><span class="keyword">function</span> <span class="params">(model, options)</span> {</span>
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> wrapError = <span class="keyword">function</span>(model, options) {
     <span class="keyword">var</span> error = options.error;
     options.error = <span class="keyword">function</span>(resp) {
       <span class="keyword">if</span> (error) error(model, resp, options);
diff --git a/profiles/commons/libraries/backbone/docs/backbone.localstorage.html b/profiles/commons/libraries/backbone/docs/backbone.localstorage.html
index ed34b79..214d61b 100644
--- a/profiles/commons/libraries/backbone/docs/backbone.localstorage.html
+++ b/profiles/commons/libraries/backbone/docs/backbone.localstorage.html
@@ -69,8 +69,7 @@
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-2">&#182;</a>
               </div>
-              <p>AMD. Register as an anonymous module.
-</p>
+              <p>AMD. Register as an anonymous module.</p>
 
             </div>
             
@@ -85,8 +84,7 @@
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-3">&#182;</a>
               </div>
-              <p>Use global variables if the locals are undefined.
-</p>
+              <p>Use global variables if the locals are undefined.</p>
 
             </div>
             
@@ -103,8 +101,7 @@
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-4">&#182;</a>
               </div>
-              <p>RequireJS isn&#39;t being used. Assume underscore and backbone are loaded in <script> tags
-</p>
+              <p>RequireJS isn&#39;t being used. Assume underscore and backbone are loaded in <script> tags</p>
 
             </div>
             
@@ -123,15 +120,10 @@
               </div>
               <p>A simple module to replace <code>Backbone.sync</code> with <em>localStorage</em>-based
 persistence. Models are given GUIDS, and saved into a JSON object. Simple
-as that.
-
-</p>
+as that.</p>
 <p>Hold reference to Underscore.js and Backbone.js in the closure in order
-to make things work even if they are removed from the global namespace
-
-</p>
-<p>Generate four random hex digits.
-</p>
+to make things work even if they are removed from the global namespace</p>
+<p>Generate four random hex digits.</p>
 
             </div>
             
@@ -148,8 +140,7 @@ to make things work even if they are removed from the global namespace
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-6">&#182;</a>
               </div>
-              <p>Generate a pseudo-GUID by concatenating random hexadecimal.
-</p>
+              <p>Generate a pseudo-GUID by concatenating random hexadecimal.</p>
 
             </div>
             
@@ -168,8 +159,7 @@ to make things work even if they are removed from the global namespace
               </div>
               <p>Our Store is represented by a single JS object in <em>localStorage</em>. Create it
 with a meaningful name, like the name you&#39;d give a table.
-window.Store is deprectated, use Backbone.LocalStorage instead
-</p>
+window.Store is deprectated, use Backbone.LocalStorage instead</p>
 
             </div>
             
@@ -190,8 +180,7 @@ _.extend(Backbone.LocalStorage.prototype, {</pre></div></div>
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-8">&#182;</a>
               </div>
-              <p>Save the current state of the <strong>Store</strong> to <em>localStorage</em>.
-</p>
+              <p>Save the current state of the <strong>Store</strong> to <em>localStorage</em>.</p>
 
             </div>
             
@@ -209,8 +198,7 @@ _.extend(Backbone.LocalStorage.prototype, {</pre></div></div>
                 <a class="pilcrow" href="#section-9">&#182;</a>
               </div>
               <p>Add a model, giving it a (hopefully)-unique GUID, if it doesn&#39;t already
-have an id of it&#39;s own.
-</p>
+have an id of it&#39;s own.</p>
 
             </div>
             
@@ -234,8 +222,7 @@ have an id of it&#39;s own.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-10">&#182;</a>
               </div>
-              <p>Update a model by replacing its copy in <code>this.data</code>.
-</p>
+              <p>Update a model by replacing its copy in <code>this.data</code>.</p>
 
             </div>
             
@@ -255,8 +242,7 @@ have an id of it&#39;s own.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-11">&#182;</a>
               </div>
-              <p>Retrieve a model from <code>this.data</code> by id.
-</p>
+              <p>Retrieve a model from <code>this.data</code> by id.</p>
 
             </div>
             
@@ -273,8 +259,7 @@ have an id of it&#39;s own.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-12">&#182;</a>
               </div>
-              <p>Return the array of all models currently in storage.
-</p>
+              <p>Return the array of all models currently in storage.</p>
 
             </div>
             
@@ -296,8 +281,7 @@ have an id of it&#39;s own.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-13">&#182;</a>
               </div>
-              <p>Delete a model from <code>this.data</code>, returning it.
-</p>
+              <p>Delete a model from <code>this.data</code>, returning it.</p>
 
             </div>
             
@@ -325,8 +309,7 @@ have an id of it&#39;s own.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-14">&#182;</a>
               </div>
-              <p>fix for &quot;illegal access&quot; error on Android when JSON.parse is passed null
-</p>
+              <p>fix for &quot;illegal access&quot; error on Android when JSON.parse is passed null</p>
 
             </div>
             
@@ -347,8 +330,7 @@ have an id of it&#39;s own.
               </div>
               <p>localSync delegate to the model or collection&#39;s
 <em>localStorage</em> property, which should be an instance of <code>Store</code>.
-window.Store.sync and Backbone.localSync is deprectated, use Backbone.LocalStorage.sync instead
-</p>
+window.Store.sync and Backbone.localSync is deprectated, use Backbone.LocalStorage.sync instead</p>
 
             </div>
             
@@ -408,8 +390,7 @@ window.Store.sync and Backbone.localSync is deprectated, use Backbone.LocalStora
                 <a class="pilcrow" href="#section-16">&#182;</a>
               </div>
               <p>add compatibility with $.ajax
-always execute callback for success and error
-</p>
+always execute callback for success and error</p>
 
             </div>
             
@@ -438,8 +419,7 @@ Backbone.getSyncMethod = <span class="keyword">function</span>(model) {
                 <a class="pilcrow" href="#section-17">&#182;</a>
               </div>
               <p>Override &#39;Backbone.sync&#39; to default to localSync,
-the original &#39;Backbone.sync&#39; is still available in &#39;Backbone.ajaxSync&#39;
-</p>
+the original &#39;Backbone.sync&#39; is still available in &#39;Backbone.ajaxSync&#39;</p>
 
             </div>
             
diff --git a/profiles/commons/libraries/backbone/docs/docco.css b/profiles/commons/libraries/backbone/docs/docco.css
index 6eedee3..f690a07 100644
--- a/profiles/commons/libraries/backbone/docs/docco.css
+++ b/profiles/commons/libraries/backbone/docs/docco.css
@@ -51,17 +51,9 @@ b, strong {
   font-family: "aller-bold";
 }
 
-p {
+p, ul, ol {
   margin: 15px 0 0px;
 }
-  .annotation ul, .annotation ol {
-    margin: 25px 0;
-  }
-    .annotation ul li, .annotation ol li {
-      font-size: 14px;
-      line-height: 18px;
-      margin: 10px 0;
-    }
 
 h1, h2, h3, h4, h5, h6 {
   color: #112233;
diff --git a/profiles/commons/libraries/backbone/docs/images/battlefield.png b/profiles/commons/libraries/backbone/docs/images/battlefield.png
deleted file mode 100644
index dd649d4..0000000
Binary files a/profiles/commons/libraries/backbone/docs/images/battlefield.png and /dev/null differ
diff --git a/profiles/commons/libraries/backbone/docs/images/favicon.ico b/profiles/commons/libraries/backbone/docs/images/favicon.ico
index 2624a64..7f7d950 100644
Binary files a/profiles/commons/libraries/backbone/docs/images/favicon.ico and b/profiles/commons/libraries/backbone/docs/images/favicon.ico differ
diff --git a/profiles/commons/libraries/backbone/docs/images/gawker.png b/profiles/commons/libraries/backbone/docs/images/gawker.png
new file mode 100644
index 0000000..84f6e08
Binary files /dev/null and b/profiles/commons/libraries/backbone/docs/images/gawker.png differ
diff --git a/profiles/commons/libraries/backbone/docs/images/lens.png b/profiles/commons/libraries/backbone/docs/images/lens.png
new file mode 100644
index 0000000..63a9c9e
Binary files /dev/null and b/profiles/commons/libraries/backbone/docs/images/lens.png differ
diff --git a/profiles/commons/libraries/backbone/docs/images/linkedin-mobile.png b/profiles/commons/libraries/backbone/docs/images/linkedin-mobile.png
deleted file mode 100644
index d6bb054..0000000
Binary files a/profiles/commons/libraries/backbone/docs/images/linkedin-mobile.png and /dev/null differ
diff --git a/profiles/commons/libraries/backbone/docs/images/prose.png b/profiles/commons/libraries/backbone/docs/images/prose.png
deleted file mode 100644
index c979d6f..0000000
Binary files a/profiles/commons/libraries/backbone/docs/images/prose.png and /dev/null differ
diff --git a/profiles/commons/libraries/backbone/docs/images/zocdoc.jpg b/profiles/commons/libraries/backbone/docs/images/zocdoc.jpg
new file mode 100644
index 0000000..3783d19
Binary files /dev/null and b/profiles/commons/libraries/backbone/docs/images/zocdoc.jpg differ
diff --git a/profiles/commons/libraries/backbone/docs/todos.html b/profiles/commons/libraries/backbone/docs/todos.html
index 931a8ca..b18c891 100644
--- a/profiles/commons/libraries/backbone/docs/todos.html
+++ b/profiles/commons/libraries/backbone/docs/todos.html
@@ -51,11 +51,8 @@
               <p>An example Backbone application contributed by
 <a href="http://jgn.me/">Jrme Gravel-Niquet</a>. This demo uses a simple
 <a href="backbone-localstorage.html">LocalStorage adapter</a>
-to persist Backbone models within your browser.
-
-</p>
-<p>Load the application once the DOM is ready, using <code>jQuery.ready</code>:
-</p>
+to persist Backbone models within your browser.</p>
+<p>Load the application once the DOM is ready, using <code>jQuery.ready</code>:</p>
 
             </div>
             
@@ -83,8 +80,7 @@ to persist Backbone models within your browser.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-3">&#182;</a>
               </div>
-              <p>Our basic <strong>Todo</strong> model has <code>title</code>, <code>order</code>, and <code>done</code> attributes.
-</p>
+              <p>Our basic <strong>Todo</strong> model has <code>title</code>, <code>order</code>, and <code>done</code> attributes.</p>
 
             </div>
             
@@ -99,8 +95,7 @@ to persist Backbone models within your browser.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-4">&#182;</a>
               </div>
-              <p>Default attributes for the todo item.
-</p>
+              <p>Default attributes for the todo item.</p>
 
             </div>
             
@@ -121,8 +116,7 @@ to persist Backbone models within your browser.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-5">&#182;</a>
               </div>
-              <p>Toggle the <code>done</code> state of this todo item.
-</p>
+              <p>Toggle the <code>done</code> state of this todo item.</p>
 
             </div>
             
@@ -155,8 +149,7 @@ to persist Backbone models within your browser.
                 <a class="pilcrow" href="#section-7">&#182;</a>
               </div>
               <p>The collection of todos is backed by <em>localStorage</em> instead of a remote
-server.
-</p>
+server.</p>
 
             </div>
             
@@ -171,8 +164,7 @@ server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-8">&#182;</a>
               </div>
-              <p>Reference to this collection&#39;s model.
-</p>
+              <p>Reference to this collection&#39;s model.</p>
 
             </div>
             
@@ -187,8 +179,7 @@ server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-9">&#182;</a>
               </div>
-              <p>Save all of the todo items under the <code>&quot;todos-backbone&quot;</code> namespace.
-</p>
+              <p>Save all of the todo items under the <code>&quot;todos-backbone&quot;</code> namespace.</p>
 
             </div>
             
@@ -203,8 +194,7 @@ server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-10">&#182;</a>
               </div>
-              <p>Filter down the list of all todo items that are finished.
-</p>
+              <p>Filter down the list of all todo items that are finished.</p>
 
             </div>
             
@@ -221,13 +211,12 @@ server.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-11">&#182;</a>
               </div>
-              <p>Filter down the list to only todo items that are still not finished.
-</p>
+              <p>Filter down the list to only todo items that are still not finished.</p>
 
             </div>
             
             <div class="content"><div class='highlight'><pre>    remaining: <span class="keyword">function</span>() {
-      <span class="keyword">return</span> <span class="keyword">this</span>.without.apply(<span class="keyword">this</span>, <span class="keyword">this</span>.done());
+      <span class="keyword">return</span> <span class="keyword">this</span>.where({done: <span class="literal">false</span>});
     },</pre></div></div>
             
         </li>
@@ -240,8 +229,7 @@ server.
                 <a class="pilcrow" href="#section-12">&#182;</a>
               </div>
               <p>We keep the Todos in sequential order, despite being saved by unordered
-GUID in the database. This generates the next order number for new items.
-</p>
+GUID in the database. This generates the next order number for new items.</p>
 
             </div>
             
@@ -259,8 +247,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-13">&#182;</a>
               </div>
-              <p>Todos are sorted by their original insertion order.
-</p>
+              <p>Todos are sorted by their original insertion order.</p>
 
             </div>
             
@@ -277,8 +264,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-14">&#182;</a>
               </div>
-              <p>Create our global collection of <strong>Todos</strong>.
-</p>
+              <p>Create our global collection of <strong>Todos</strong>.</p>
 
             </div>
             
@@ -306,8 +292,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-16">&#182;</a>
               </div>
-              <p>The DOM element for a todo item...
-</p>
+              <p>The DOM element for a todo item...</p>
 
             </div>
             
@@ -322,8 +307,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-17">&#182;</a>
               </div>
-              <p>... is a list tag.
-</p>
+              <p>... is a list tag.</p>
 
             </div>
             
@@ -338,8 +322,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-18">&#182;</a>
               </div>
-              <p>Cache the template function for a single item.
-</p>
+              <p>Cache the template function for a single item.</p>
 
             </div>
             
@@ -354,8 +337,7 @@ GUID in the database. This generates the next order number for new items.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-19">&#182;</a>
               </div>
-              <p>The DOM events specific to an item.
-</p>
+              <p>The DOM events specific to an item.</p>
 
             </div>
             
@@ -378,8 +360,7 @@ GUID in the database. This generates the next order number for new items.
               </div>
               <p>The TodoView listens for changes to its model, re-rendering. Since there&#39;s
 a one-to-one correspondence between a <strong>Todo</strong> and a <strong>TodoView</strong> in this
-app, we set a direct reference on the model for convenience.
-</p>
+app, we set a direct reference on the model for convenience.</p>
 
             </div>
             
@@ -397,8 +378,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-21">&#182;</a>
               </div>
-              <p>Re-render the titles of the todo item.
-</p>
+              <p>Re-render the titles of the todo item.</p>
 
             </div>
             
@@ -418,8 +398,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-22">&#182;</a>
               </div>
-              <p>Toggle the <code>&quot;done&quot;</code> state of the model.
-</p>
+              <p>Toggle the <code>&quot;done&quot;</code> state of the model.</p>
 
             </div>
             
@@ -436,8 +415,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-23">&#182;</a>
               </div>
-              <p>Switch this view into <code>&quot;editing&quot;</code> mode, displaying the input field.
-</p>
+              <p>Switch this view into <code>&quot;editing&quot;</code> mode, displaying the input field.</p>
 
             </div>
             
@@ -455,8 +433,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-24">&#182;</a>
               </div>
-              <p>Close the <code>&quot;editing&quot;</code> mode, saving changes to the todo.
-</p>
+              <p>Close the <code>&quot;editing&quot;</code> mode, saving changes to the todo.</p>
 
             </div>
             
@@ -479,8 +456,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-25">&#182;</a>
               </div>
-              <p>If you hit <code>enter</code>, we&#39;re through editing the item.
-</p>
+              <p>If you hit <code>enter</code>, we&#39;re through editing the item.</p>
 
             </div>
             
@@ -497,8 +473,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-26">&#182;</a>
               </div>
-              <p>Remove the item, destroy the model.
-</p>
+              <p>Remove the item, destroy the model.</p>
 
             </div>
             
@@ -530,8 +505,7 @@ app, we set a direct reference on the model for convenience.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-28">&#182;</a>
               </div>
-              <p>Our overall <strong>AppView</strong> is the top-level piece of UI.
-</p>
+              <p>Our overall <strong>AppView</strong> is the top-level piece of UI.</p>
 
             </div>
             
@@ -547,8 +521,7 @@ app, we set a direct reference on the model for convenience.
                 <a class="pilcrow" href="#section-29">&#182;</a>
               </div>
               <p>Instead of generating a new element, bind to the existing skeleton of
-the App already present in the HTML.
-</p>
+the App already present in the HTML.</p>
 
             </div>
             
@@ -563,8 +536,7 @@ the App already present in the HTML.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-30">&#182;</a>
               </div>
-              <p>Our template for the line of statistics at the bottom of the app.
-</p>
+              <p>Our template for the line of statistics at the bottom of the app.</p>
 
             </div>
             
@@ -579,8 +551,7 @@ the App already present in the HTML.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-31">&#182;</a>
               </div>
-              <p>Delegated events for creating new items, and clearing completed ones.
-</p>
+              <p>Delegated events for creating new items, and clearing completed ones.</p>
 
             </div>
             
@@ -601,8 +572,7 @@ the App already present in the HTML.
               </div>
               <p>At initialization we bind to the relevant events on the <code>Todos</code>
 collection, when items are added or changed. Kick things off by
-loading any preexisting todos that might be saved in <em>localStorage</em>.
-</p>
+loading any preexisting todos that might be saved in <em>localStorage</em>.</p>
 
             </div>
             
@@ -631,8 +601,7 @@ loading any preexisting todos that might be saved in <em>localStorage</em>.
                 <a class="pilcrow" href="#section-33">&#182;</a>
               </div>
               <p>Re-rendering the App just means refreshing the statistics -- the rest
-of the app doesn&#39;t change.
-</p>
+of the app doesn&#39;t change.</p>
 
             </div>
             
@@ -662,8 +631,7 @@ of the app doesn&#39;t change.
                 <a class="pilcrow" href="#section-34">&#182;</a>
               </div>
               <p>Add a single todo item to the list by creating a view for it, and
-appending its element to the <code>&lt;ul&gt;</code>.
-</p>
+appending its element to the <code>&lt;ul&gt;</code>.</p>
 
             </div>
             
@@ -681,8 +649,7 @@ appending its element to the <code>&lt;ul&gt;</code>.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-35">&#182;</a>
               </div>
-              <p>Add all items in the <strong>Todos</strong> collection at once.
-</p>
+              <p>Add all items in the <strong>Todos</strong> collection at once.</p>
 
             </div>
             
@@ -700,8 +667,7 @@ appending its element to the <code>&lt;ul&gt;</code>.
                 <a class="pilcrow" href="#section-36">&#182;</a>
               </div>
               <p>If you hit return in the main input field, create new <strong>Todo</strong> model,
-persisting it to <em>localStorage</em>.
-</p>
+persisting it to <em>localStorage</em>.</p>
 
             </div>
             
@@ -722,8 +688,7 @@ persisting it to <em>localStorage</em>.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-37">&#182;</a>
               </div>
-              <p>Clear all done todo items, destroying their models.
-</p>
+              <p>Clear all done todo items, destroying their models.</p>
 
             </div>
             
@@ -748,8 +713,7 @@ persisting it to <em>localStorage</em>.
               <div class="pilwrap ">
                 <a class="pilcrow" href="#section-38">&#182;</a>
               </div>
-              <p>Finally, we kick things off by creating the <strong>App</strong>.
-</p>
+              <p>Finally, we kick things off by creating the <strong>App</strong>.</p>
 
             </div>
             
diff --git a/profiles/commons/libraries/backbone/examples/todos/todos.js b/profiles/commons/libraries/backbone/examples/todos/todos.js
index fc07c28..66d6282 100644
--- a/profiles/commons/libraries/backbone/examples/todos/todos.js
+++ b/profiles/commons/libraries/backbone/examples/todos/todos.js
@@ -48,7 +48,7 @@ $(function(){
 
     // Filter down the list to only todo items that are still not finished.
     remaining: function() {
-      return this.without.apply(this, this.done());
+      return this.where({done: false});
     },
 
     // We keep the Todos in sequential order, despite being saved by unordered
diff --git a/profiles/commons/libraries/backbone/index.html b/profiles/commons/libraries/backbone/index.html
index 086792b..252de59 100644
--- a/profiles/commons/libraries/backbone/index.html
+++ b/profiles/commons/libraries/backbone/index.html
@@ -286,10 +286,10 @@
   <div id="sidebar" class="interface">
 
     <a class="toc_title" href="#">
-      Backbone.js <span class="version">(1.0.0)</span>
+      Backbone.js <span class="version">(1.1.0)</span>
     </a>
     <ul class="toc_section">
-      <li>&raquo; <a href="http://github.com/documentcloud/backbone">GitHub Repository</a></li>
+      <li>&raquo; <a href="http://github.com/jashkenas/backbone">GitHub Repository</a></li>
       <li>&raquo; <a href="docs/backbone.html">Annotated Source</a></li>
     </ul>
 
@@ -427,6 +427,7 @@
       <li> <a href="#View-setElement">setElement</a></li>
       <li> <a href="#View-attributes">attributes</a></li>
       <li> <a href="#View-dollar">$ (jQuery)</a></li>
+      <li> <a href="#View-template">template</a></li>
       <li> <a href="#View-render">render</a></li>
       <li> <a href="#View-remove">remove</a></li>
       <li> <a href="#View-delegateEvents">delegateEvents</a></li>
@@ -449,9 +450,9 @@
       <li> <a href="#examples-documentcloud">DocumentCloud</a></li>
       <li> <a href="#examples-usa-today">USA Today</a></li>
       <li> <a href="#examples-rdio">Rdio</a></li>
-      <li> <a href="#examples-linkedin">LinkedIn Mobile</a></li>
       <li> <a href="#examples-hulu">Hulu</a></li>
       <li> <a href="#examples-quartz">Quartz</a></li>
+      <li> <a href="#examples-gawker">Gawker Media</a></li>
       <li> <a href="#examples-flow">Flow</a></li>
       <li> <a href="#examples-gilt">Gilt Groupe</a></li>
       <li> <a href="#examples-newsblur">NewsBlur</a></li>
@@ -460,10 +461,12 @@
       <li> <a href="#examples-bitbucket">Bitbucket</a></li>
       <li> <a href="#examples-disqus">Disqus</a></li>
       <li> <a href="#examples-khan-academy">Khan Academy</a></li>
+      <li> <a href="#examples-elife-lens">eLife Lens</a></li>
       <li> <a href="#examples-do">Do</a></li>
       <li> <a href="#examples-irccloud">IRCCloud</a></li>
       <li> <a href="#examples-pitchfork">Pitchfork</a></li>
       <li> <a href="#examples-spin">Spin</a></li>
+      <li> <a href="#examples-zocdoc">ZocDoc</a></li>
       <li> <a href="#examples-walmart">Walmart Mobile</a></li>
       <li> <a href="#examples-groupon">Groupon Now!</a></li>
       <li> <a href="#examples-basecamp">Basecamp</a></li>
@@ -479,9 +482,7 @@
       <li> <a href="#examples-cloudapp">CloudApp</a></li>
       <li> <a href="#examples-seatgeek">SeatGeek</a></li>
       <li> <a href="#examples-easel">Easel</a></li>
-      <li> <a href="#examples-prose">Prose</a></li>
       <li>- <a href="#examples-jolicloud">Jolicloud</a></li>
-      <li> <a href="#examples-battlefield">Battlefield Play4Free</a></li>
       <li> <a href="#examples-syllabus">Syllabus</a></li>
       <li> <a href="#examples-salon">Salon.io</a></li>
       <li> <a href="#examples-tilemill">TileMill</a></li>
@@ -525,21 +526,21 @@
     </p>
 
     <p>
-      The project is <a href="http://github.com/documentcloud/backbone/">hosted on GitHub</a>,
+      The project is <a href="http://github.com/jashkenas/backbone/">hosted on GitHub</a>,
       and the <a href="docs/backbone.html">annotated source code</a> is available,
       as well as an online <a href="test/">test suite</a>,
       an <a href="examples/todos/index.html">example application</a>,
-      a <a href="https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites">list of tutorials</a>
+      a <a href="https://github.com/jashkenas/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites">list of tutorials</a>
       and a <a href="#examples">long list of real-world projects</a> that use Backbone.
-      Backbone is available for use under the <a href="http://github.com/documentcloud/backbone/blob/master/LICENSE">MIT software license</a>.
+      Backbone is available for use under the <a href="http://github.com/jashkenas/backbone/blob/master/LICENSE">MIT software license</a>.
     </p>
 
     <p>
       You can report bugs and discuss features on the
-      <a href="http://github.com/documentcloud/backbone/issues">GitHub issues page</a>,
+      <a href="http://github.com/jashkenas/backbone/issues">GitHub issues page</a>,
       on Freenode IRC in the <tt>#documentcloud</tt> channel, post questions to the
       <a href="https://groups.google.com/forum/#!forum/backbonejs">Google Group</a>,
-      add pages to the <a href="https://github.com/documentcloud/backbone/wiki">wiki</a>
+      add pages to the <a href="https://github.com/jashkenas/backbone/wiki">wiki</a>
       or send tweets to <a href="http://twitter.com/documentcloud">@documentcloud</a>.
     </p>
 
@@ -557,22 +558,22 @@
 
     <table>
       <tr>
-        <td><a class="punch" href="backbone.js">Development Version (1.0.0)</a></td>
-        <td class="text"><i>58kb, Full source, tons of comments</i></td>
+        <td><a class="punch" href="backbone.js">Development Version (1.1.0)</a></td>
+        <td class="text"><i>59kb, Full source, tons of comments</i></td>
       </tr>
       <tr>
-        <td><a class="punch" href="backbone-min.js">Production Version (1.0.0)</a></td>
+        <td><a class="punch" href="backbone-min.js">Production Version (1.1.0)</a></td>
         <td class="text" style="line-height: 16px;">
-          <i>7.1kb, Packed and gzipped</i><br />
+          <i>6.4kb, Packed and gzipped</i><br />
           <small>(<a href="backbone-min.map">Source Map</a>)</small>
         </td>
       </tr>
       <tr>
-        <td><a class="punch" href="https://raw.github.com/documentcloud/backbone/master/backbone.js">Edge Version (master)</a></td>
+        <td><a class="punch" href="https://raw.github.com/jashkenas/backbone/master/backbone.js">Edge Version (master)</a></td>
         <td>
           <i>Unreleased, use at your own risk</i>
-          <a class="travis-badge" href="https://travis-ci.org/documentcloud/backbone">
-            <img src="https://travis-ci.org/documentcloud/backbone.png" />
+          <a class="travis-badge" href="https://travis-ci.org/jashkenas/backbone">
+            <img src="https://travis-ci.org/jashkenas/backbone.png" />
           </a>
         </td>
       </tr>
@@ -580,12 +581,16 @@
 
     <p>
       Backbone's only hard dependency is
-      <a href="http://underscorejs.org/">Underscore.js</a> <small>( >= 1.4.3)</small>.
+      <b><a href="http://underscorejs.org/">Underscore.js</a></b>.
       For RESTful persistence, history support via <a href="#Router">Backbone.Router</a>
       and DOM manipulation with <a href="#View">Backbone.View</a>, include
-      <a href="https://github.com/douglascrockford/JSON-js">json2.js</a>, and either
-      <a href="http://jquery.com">jQuery</a> <small>( >= 1.7.0)</small> or
-      <a href="http://zeptojs.com/">Zepto</a>.
+      <b><a href="http://jquery.com">jQuery</a></b>, and
+      <b><a href="https://github.com/douglascrockford/JSON-js">json2.js</a></b> for older
+      Internet Explorer support.
+      <i>(Mimics of the Underscore and jQuery APIs, such as
+      <a href="http://lodash.com">Lo-Dash</a> and
+      <a href="http://zeptojs.com">Zepto</a>, will
+      also tend to work, with varying degrees of compatibility.)</i>
     </p>
 
     <h2 id="introduction">Introduction</h2>
@@ -614,6 +619,17 @@
     </p>
 
     <p>
+      Philosophically, Backbone is an attempt to discover the minimal set
+      of data-structuring (models and collections) and user interface (views
+      and URLs) primitives that are generally useful when building web applications with
+      JavaScript. In an ecosystem where overarching, decides-everything-for-you
+      frameworks are commonplace, and many libraries require your site to be 
+      reorganized to suit their look, feel, and default behavior  Backbone should
+      continue to be a tool that gives you the <i>freedom</i> to design the full
+      experience of your web application.
+    </p>
+
+    <p>
       If you're new here, and aren't yet quite sure what Backbone is for, start by
       browsing the <a href="#examples">list of Backbone-based projects</a>.
     </p>
@@ -784,10 +800,12 @@ object.off();
     <p id="Events-listenTo">
       <b class="header">listenTo</b><code>object.listenTo(other, event, callback)</code>
       <br />
-      Tell an <b>object</b> to listen to a particular event on an <b>other</b> object.
-      The advantage of using this form, instead of <tt>other.on(event, callback)</tt>,
-      is that <b>listenTo</b> allows the <b>object</b> to keep track of the events,
-      and they can be removed all at once later on.
+      Tell an <b>object</b> to listen to a particular event on an <b>other</b>
+      object.  The advantage of using this form, instead of <tt>other.on(event,
+      callback, object)</tt>, is that <b>listenTo</b> allows the <b>object</b>
+      to keep track of the events, and they can be removed all at once later
+      on.  The <b>callback</b> will always be called with <b>object</b> as
+      context.
     </p>
 
 <pre>
@@ -839,10 +857,21 @@ view.stopListening(model);
       <li><b>"error"</b> (model, xhr, options) &mdash; when a model's <a href="#Model-save">save</a> call fails on the server. </li>
       <li><b>"invalid"</b> (model, error, options) &mdash; when a model's <a href="#Model-validate">validation</a> fails on the client. </li>
       <li><b>"route:[name]"</b> (params) &mdash; Fired by the router when a specific route is matched.</li>
-      <li><b>"route"</b> (router, route, params) &mdash; Fired by history (or router) when <i>any</i> route has been matched.</li>
+      <li><b>"route"</b> (route, params) &mdash; Fired by the router when <i>any</i> route has been matched.</li>
+      <li><b>"route"</b> (router, route, params) &mdash; Fired by history when <i>any</i> route has been matched.</li>
       <li><b>"all"</b> &mdash; this special event fires for <i>any</i> triggered event, passing the event name as the first argument. </li>
     </ul>
 
+    <p>
+      Generally speaking, when calling a function that emits an event
+      (<tt>model.set()</tt>, <tt>collection.add</tt>, and so on...),
+      if you'd like to prevent the event from being triggered, you may pass
+      <tt>{silent: true}</tt> as an option. Note that this is <i>rarely</i>,
+      perhaps even never, a good idea. Passing through a specific flag
+      in the options for your event callback to look at, and choose to ignore,
+      will usually work out better.
+    </p>
+
     <h2 id="Model">Backbone.Model</h2>
 
     <p>
@@ -974,7 +1003,9 @@ var Library = Backbone.Model.extend({
       gains a <tt>collection</tt> property that will be used to indicate which
       collection the model belongs to, and is used to help compute the model's
       <a href="#Model-url">url</a>. The <tt>model.collection</tt> property is
-      otherwise added automatically when you first add a model to a collection.
+      normally created automatically when you first add a model to a collection.
+      Note that the reverse is not true, as passing this option to the constructor 
+      will not automatically add the model to the collection. Useful, sometimes.
     </p>
 
     <p>
@@ -994,11 +1025,10 @@ var Library = Backbone.Model.extend({
       <b class="header">set</b><code>model.set(attributes, [options])</code>
       <br />
       Set a hash of attributes (one or many) on the model. If any of the attributes
-      change the model's state, a <tt>"change"</tt> event will be triggered, unless
-      <tt>{silent: true}</tt> is passed as an option. Change events for specific
-      attributes are also triggered, and you can bind to those as well, for example:
-      <tt>change:title</tt>, and <tt>change:content</tt>. You may also pass
-      individual keys and values.
+      change the model's state, a <tt>"change"</tt> event will be triggered on the model.
+      Change events for specific attributes are also triggered, and you can bind
+      to those as well, for example: <tt>change:title</tt>, and <tt>change:content</tt>.
+      You may also pass individual keys and values.
     </p>
 
 <pre>
@@ -1114,7 +1144,7 @@ alert("Cake id: " + cake.id);
       <b class="header">changed</b><code>model.changed</code>
       <br />
       The <b>changed</b> property is the internal hash containing all the attributes
-      that have changed since the last <tt>"change"</tt> event was triggered.
+      that have changed since the last <a href="Model#set">set</a>.
       Please do not update <b>changed</b> directly since its state is internally maintained
       by <a href="#Model-set">set</a>.  A copy of <b>changed</b> can be acquired from
       <a href="#Model-changedAttributes">changedAttributes</a>.
@@ -1147,9 +1177,9 @@ alert("Dessert will be " + (new Meal).get('dessert'));
     </p>
 
     <p id="Model-toJSON">
-      <b class="header">toJSON</b><code>model.toJSON()</code>
+      <b class="header">toJSON</b><code>model.toJSON([options])</code>
       <br />
-      Return a copy of the model's <a href="#Model-attributes">attributes</a>
+      Return a shallow copy of the model's <a href="#Model-attributes">attributes</a>
       for JSON stringification.  This can be used for persistence,
       serialization, or for augmentation before being sent to the server. The
       name of this method is a bit confusing, as it doesn't actually return a
@@ -1187,8 +1217,7 @@ alert(JSON.stringify(artist));
       latest server state. A <tt>"change"</tt> event will be triggered if the
       server's state differs from the current attributes. Accepts
       <tt>success</tt> and <tt>error</tt> callbacks in the options hash, which
-      are passed <tt>(model, response, options)</tt>
-      and <tt>(model, xhr, options)</tt> as arguments, respectively.
+      are both passed <tt>(model, response, options)</tt> as arguments.
     </p>
 
 <pre>
@@ -1472,7 +1501,7 @@ ActiveRecord::Base.include_root_in_json = false
     <p id="Model-hasChanged">
       <b class="header">hasChanged</b><code>model.hasChanged([attribute])</code>
       <br />
-      Has the model changed since the last <tt>"change"</tt> event? If an <b>attribute</b>
+      Has the model changed since the last <a href="#Model-set">set</a>? If an <b>attribute</b>
       is passed, returns <tt>true</tt> if that specific attribute has changed.
     </p>
 
@@ -1492,8 +1521,8 @@ book.on("change", function() {
     <p id="Model-changedAttributes">
       <b class="header">changedAttributes</b><code>model.changedAttributes([attributes])</code>
       <br />
-      Retrieve a hash of only the model's attributes that have changed, or
-      <tt>false</tt> if there are none. Optionally, an external
+      Retrieve a hash of only the model's attributes that have changed since the last
+      <a href="#Model-set">set</a>, or <tt>false</tt> if there are none. Optionally, an external
       <b>attributes</b> hash can be passed in, returning the attributes in that
       hash which differ from the model. This can be used to figure out which
       portions of a view should be updated, or what calls
@@ -1542,7 +1571,7 @@ bill.set({name : "Bill Jones"});
       triggered on the collection directly, for convenience.
       This allows you to listen for changes to specific attributes in any
       model in a collection, for example:
-      <tt>Documents.on("change:selected", ...)</tt>
+      <tt>documents.on("change:selected", ...)</tt>
     </p>
 
     <p id="Collection-extend">
@@ -1571,7 +1600,7 @@ var Library = Backbone.Collection.extend({
 
     <p>
       A collection can also contain polymorphic models by overriding this property
-      with a function that returns a model.
+      with a constructor that returns a model.
     </p>
 
 <pre>
@@ -1589,22 +1618,21 @@ var Library = Backbone.Collection.extend({
 </pre>
 
     <p id="Collection-constructor">
-      <b class="header">constructor / initialize</b><code>new Collection([models], [options])</code>
+      <b class="header">constructor / initialize</b><code>new Backbone.Collection([models], [options])</code>
       <br />
       When creating a Collection, you may choose to pass in the initial array
       of <b>models</b>.  The collection's <a href="#Collection-comparator">comparator</a>
       may be included as an option. Passing <tt>false</tt> as the
       comparator option will prevent sorting. If you define an
       <b>initialize</b> function, it will be invoked when the collection is
-      created. There are several options that, if provided, are attached to the
-      collection directly: <tt>url</tt>, <tt>model</tt> and <tt>comparator</tt>.
+      created. There are a couple of options that, if provided, are attached to
+      the collection directly: <tt>model</tt> and <tt>comparator</tt>.
     </p>
 
 <pre>
 var tabs = new TabSet([tab1, tab2, tab3]);
 var spaces = new Backbone.Collection([], {
-  model: Space,
-  url: '/spaces'
+  model: Space
 });
 </pre>
 
@@ -1618,9 +1646,10 @@ var spaces = new Backbone.Collection([], {
     </p>
 
     <p id="Collection-toJSON">
-      <b class="header">toJSON</b><code>collection.toJSON()</code>
+      <b class="header">toJSON</b><code>collection.toJSON([options])</code>
       <br />
-      Return an array containing the attributes hash of each model in the
+      Return an array containing the attributes hash of each model
+      (via <a href="#Model-toJSON">toJSON</a>) in the
       collection. This can be used to serialize and persist the
       collection as a whole. The name of this method is a bit confusing, because
       it conforms to
@@ -1668,7 +1697,6 @@ alert(JSON.stringify(collection));
       <li><a href="http://underscorejs.org/#min">min</a></li>
       <li><a href="http://underscorejs.org/#sortBy">sortBy</a></li>
       <li><a href="http://underscorejs.org/#groupBy">groupBy</a></li>
-      <li><a href="http://underscorejs.org/#sortedIndex">sortedIndex</a></li>
       <li><a href="http://underscorejs.org/#shuffle">shuffle</a></li>
       <li><a href="http://underscorejs.org/#toArray">toArray</a></li>
       <li><a href="http://underscorejs.org/#size">size</a></li>
@@ -1704,10 +1732,10 @@ var alphabetical = books.sortBy(function(book) {
     <p id="Collection-add">
       <b class="header">add</b><code>collection.add(models, [options])</code>
       <br />
-      Add a model (or an array of models) to the collection. Fires an <tt>"add"</tt>
-      event, which you can pass <tt>{silent: true}</tt> to suppress. If a
-      <a href="#Collection-model">model</a> property is defined, you may also pass
+      Add a model (or an array of models) to the collection, firing an <tt>"add"</tt>
+      event. If a <a href="#Collection-model">model</a> property is defined, you may also pass
       raw attributes objects, and have them be vivified as instances of the model.
+      Returns the added (or preexisting, if duplicate) models.
       Pass <tt>{at: index}</tt> to splice the model into the collection at the
       specified <tt>index</tt>. If you're adding models to the collection that are
       <i>already</i> in the collection, they'll be ignored, unless you pass
@@ -1736,8 +1764,8 @@ ships.add([
     <p id="Collection-remove">
       <b class="header">remove</b><code>collection.remove(models, [options])</code>
       <br />
-      Remove a model (or an array of models) from the collection. Fires a
-      <tt>"remove"</tt> event, which you can use <tt>silent</tt> to suppress.
+      Remove a model (or an array of models) from the collection, and returns them. 
+      Fires a <tt>"remove"</tt> event, which you can use <tt>silent</tt> to suppress.
       The model's index before removal is available to listeners as
       <tt>options.index</tt>.
     </p>
@@ -1749,9 +1777,9 @@ ships.add([
       you have so many models to change that you'd rather just update the collection
       in bulk. Use <b>reset</b> to replace a collection with a new list
       of models (or attribute hashes), triggering a single <tt>"reset"</tt> event
-      at the end. Pass <tt>{silent: true}</tt> to suppress the <tt>"reset"</tt> event.
-      For convenience, within a <tt>"reset"</tt> event, the list of any previous
-      models is available as <tt>options.previousModels</tt>.
+      at the end. Returns the newly-set models.
+      For convenience, within a <tt>"reset"</tt> event, the list of any
+      previous models is available as <tt>options.previousModels</tt>.
     </p>
 
     <p>
@@ -1774,20 +1802,21 @@ ships.add([
     <p id="Collection-set">
       <b class="header">set</b><code>collection.set(models, [options])</code>
       <br />
-      The <b>set</b> method tries to peform a "smart" update of the collection
+      The <b>set</b> method performs a "smart" update of the collection
       with the passed list of models. If a model in the list isn't yet in the
       collection it will be added; if the model is already in the collection
       its attributes will be merged; and if the collection contains any models that
       <i>aren't</i> present in the list, they'll be removed. All of the appropriate
       <tt>"add"</tt>, <tt>"remove"</tt>, and <tt>"change"</tt> events are fired
-      as this happens. If you'd like to customize the behavior, you can disable
+      as this happens. Returns the touched models in the collection.
+      If you'd like to customize the behavior, you can disable
       it with options: <tt>{add: false}</tt>, <tt>{remove: false}</tt>, or <tt>{merge: false}</tt>.
     </p>
 
 <pre>
-var vanHalen = new Collection([eddie, alex, stone, roth]);
+var vanHalen = new Backbone.Collection([eddie, alex, stone, roth]);
 
-vanHalen.update([eddie, alex, stone, hagar]);
+vanHalen.set([eddie, alex, stone, hagar]);
 
 // Fires a "remove" event for roth, and an "add" event for "hagar".
 // Updates any of stone, alex, and eddie's attributes that may have
@@ -1802,7 +1831,7 @@ vanHalen.update([eddie, alex, stone, hagar]);
     </p>
 
 <pre>
-var book = Library.get(110);
+var book = library.get(110);
 </pre>
 
     <p id="Collection-at">
@@ -1889,9 +1918,7 @@ var book = Library.get(110);
 var Chapter  = Backbone.Model;
 var chapters = new Backbone.Collection;
 
-chapters.comparator = function(chapter) {
-  return chapter.get("page");
-};
+chapters.comparator = 'page';
 
 chapters.add(new Chapter({page: 9, title: "The End"}));
 chapters.add(new Chapter({page: 5, title: "The Middle"}));
@@ -1913,16 +1940,14 @@ alert(chapters.pluck('title'));
       normal circumstances, as a collection with a <a href="#Collection-comparator">comparator</a>
       will sort itself whenever a model is added. To disable sorting when adding
       a model, pass <tt>{sort: false}</tt> to <tt>add</tt>. Calling <b>sort</b>
-      triggers a <tt>"sort"</tt> event on the collection, unless silenced by
-      passing
-      <tt>{silent: true}</tt>.
+      triggers a <tt>"sort"</tt> event on the collection.
     </p>
 
     <p id="Collection-pluck">
       <b class="header">pluck</b><code>collection.pluck(attribute)</code>
       <br />
       Pluck an attribute from each model in the collection. Equivalent to calling
-      <tt>map</tt>, and returning a single attribute from the iterator.
+      <tt>map</tt> and returning a single attribute from the iterator.
     </p>
 
 <pre class="runnable">
@@ -2017,14 +2042,12 @@ var Tweets = Backbone.Collection.extend({
       <b class="header">fetch</b><code>collection.fetch([options])</code>
       <br />
       Fetch the default set of models for this collection from the server,
-      resetting the collection when they arrive. The <b>options</b> hash takes
-      <tt>success</tt> and <tt>error</tt>
-      callbacks which will be passed <tt>(collection, response, options)</tt>
-      and <tt>(collection, xhr, options)</tt> as arguments, respectively.
-      When the model data returns from the server, the collection will be (efficiently)
-      <a href="#Collection-reset">reset</a>, unless you pass <tt>{update: true}</tt>,
-      in which case it will use <a href="#Collection-update">update</a> to (intelligently)
-      merge the fetched models.
+      <a href="#Collection-set">setting</a> them on the collection when they arrive.
+      The <b>options</b> hash takes <tt>success</tt> and <tt>error</tt> callbacks
+      which will both be passed <tt>(collection, response, options)</tt> as arguments.
+      When the model data returns from the server, it uses <a href="#Collection-set">set</a>
+      to (intelligently) merge the fetched models, unless you pass <tt>{reset: true}</tt>,
+      in which case the collection will be (efficiently) <a href="#Collection-reset">reset</a>.
       Delegates to <a href="#Sync">Backbone.sync</a>
       under the covers for custom persistence strategies and returns a
       <a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHR</a>.
@@ -2045,10 +2068,10 @@ accounts.fetch();
 
     <p>
       The behavior of <b>fetch</b> can be customized by using the available
-      <a href="#Collection-update">update</a> options. For example, to fetch a
+      <a href="#Collection-set">set</a> options. For example, to fetch a
       collection, getting an <tt>"add"</tt> event for every new model, and
       a <tt>"change"</tt> event for every changed existing model, without
-      removing anything: <tt>collection.fetch({update: true, remove: false})</tt>
+      removing anything: <tt>collection.fetch({remove: false})</tt>
     </p>
 
     <p>
@@ -2182,6 +2205,13 @@ var Workspace = Backbone.Router.extend({
     </p>
 
     <p>
+      Trailing slashes are treated as part of the URL, and (correctly) treated
+      as a unique route when accessed. <tt>docs</tt> and <tt>docs/</tt> will fire
+      different callbacks. If you can't avoid generating both types of URLs, you
+      can define a <tt>"docs(/)"</tt> matcher to capture both cases.
+    </p>
+
+    <p>
       When the visitor presses the back button, or enters a URL, and a particular
       route is matched, the name of the action will be fired as an
       <a href="#Events">event</a>, so that other objects can listen to the router,
@@ -2222,7 +2252,7 @@ router.on("route:help", function(page) {
       an argument to the callback. The <tt>name</tt> argument will be triggered as
       a <tt>"route:name"</tt> event whenever the route is matched.  If the
       <tt>callback</tt> argument is omitted <tt>router[name]</tt> will be used
-      instead.
+      instead. Routes added later may override previously declared routes.
     </p>
 
 <pre>
@@ -2363,7 +2393,7 @@ $(function(){
       with content-type <tt>application/json</tt>. When returning a JSON response,
       send down the attributes of the  model that have been changed by the server, and need
       to be updated on the client. When responding to a <tt>"read"</tt> request from a collection
-      (<a href="#Collection#fetch">Collection#fetch</a>), send down an array
+      (<a href="#Collection-fetch">Collection#fetch</a>), send down an array
       of model attribute objects.
     </p>
 
@@ -2443,7 +2473,7 @@ model.save();  // POST to "/collection/id", with "_method=PUT" + header.
       encoded as <tt>application/json</tt>, setting <tt>Backbone.emulateJSON = true;</tt>
       will cause the JSON to be serialized under a <tt>model</tt> parameter, and
       the request to be made with a <tt>application/x-www-form-urlencoded</tt>
-      mime type, as if from an HTML form.
+      MIME type, as if from an HTML form.
     </p>
 
     <h2 id="View">Backbone.View</h2>
@@ -2486,7 +2516,7 @@ var DocumentRow = Backbone.View.extend({
 
   initialize: function() {
     this.listenTo(this.model, "change", this.render);
-  }
+  },
 
   render: function() {
     ...
@@ -2518,7 +2548,7 @@ var DocumentRow = Backbone.View.extend({
     </p>
 
 <pre>
-var doc = Documents.first();
+var doc = documents.first();
 
 new DocumentRow({
   model: doc,
@@ -2604,6 +2634,22 @@ ui.Chapter = Backbone.View.extend({
 });
 </pre>
 
+    <p id="View-template">
+      <b class="header">template</b><code>view.template([data])</code>
+      <br />
+      While templating for a view isn't a function provided directly by Backbone,
+      it's often a nice convention to define a <b>template</b> function on your 
+      views. In this way, when rendering your view, you have convenient access to
+      instance data (<tt>this.model</tt>, <tt>options</tt>, and so on). 
+      For example, using Underscore templates:
+    </p>
+
+<pre>
+var LibraryView = Backbone.View.extend({
+  template: _.template(...)
+});
+</pre>
+
     <p id="View-render">
       <b class="header">render</b><code>view.render()</code>
       <br />
@@ -2616,7 +2662,7 @@ ui.Chapter = Backbone.View.extend({
 
 <pre>
 var Bookmark = Backbone.View.extend({
-  template: _.template(),
+  template: _.template(...),
   render: function() {
     this.$el.html(this.template(this.model.attributes));
     return this;
@@ -2757,7 +2803,7 @@ var model = localBackbone.Model.extend(...);
     <p>
       The list of examples that follows, while long, is not exhaustive. If you've
       worked on an app that uses Backbone, please add it to the
-      <a href="https://github.com/documentcloud/backbone/wiki/Projects-and-Companies-using-Backbone">wiki page of Backbone apps</a>.
+      <a href="https://github.com/jashkenas/backbone/wiki/Projects-and-Companies-using-Backbone">wiki page of Backbone apps</a>.
     </p>
 
     <p id="examples-todos">
@@ -2835,27 +2881,6 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
-    <h2 id="examples-linkedin">LinkedIn Mobile</h2>
-
-    <p>
-      <a href="http://www.linkedin.com/">LinkedIn</a> used Backbone.js to create
-      its <a href="http://www.linkedin.com/static?key=mobile">next-generation HTML5 mobile web app</a>.
-      Backbone made it easy to keep the app modular, organized and extensible so
-      that it was possible to program the complexities of LinkedIn's user experience.
-      The app also uses <a href="http://zeptojs.com/">Zepto</a>,
-      <a href="http://underscorejs.org/">Underscore.js</a>,
-      <a href="http://sass-lang.com/">SASS</a>, <a href="http://cubiq.org/iscroll">iScroll</a>,
-      HTML5 LocalStorage and Canvas. The tech team blogged about
-      <a href="http://engineering.linkedin.com/mobile/linkedin-ipad-using-local-storage-snappy-mobile-apps">their experiences using LocalStorage</a>
-      to improve mobile performance.
-    </p>
-
-    <div style="text-align: center;">
-      <a href="http://www.linkedin.com/static?key=mobile">
-        <img width="550" height"454" data-original="docs/images/linkedin-mobile.png" alt="LinkedIn Mobile" class="example_image" />
-      </a>
-    </div>
-
     <h2 id="examples-hulu">Hulu</h2>
 
     <p>
@@ -2894,6 +2919,41 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
+    <h2 id="examples-gawker">Gawker Media</h2>
+
+    <p>
+      <a href="http://kinja.com">Kinja</a> is Gawker Media's publishing platform designed
+      to create great stories by breaking down the lines between the traditional
+      roles of content creators and consumers. Everyone  editors, readers,
+      marketers  have access to the same tools to engage in passionate discussion
+      and pursue the truth of the story. Sharing, recommending, and following within the
+      Kinja ecosystem allows for improved information discovery across all the sites.
+    </p>
+    <p>
+      Kinja is the platform behind
+      <a href="http://gawker.com/">Gawker</a>,
+      <a href="http://gizmodo.com/">Gizmodo</a>,
+      <a href="http://lifehacker.com/">Lifehacker</a>,
+      <a href="http://io9.com/">io9</a> and other Gawker Media
+      blogs. Backbone.js underlies the front-end application code that powers
+      everything from user authentication to post authoring, commenting, and even serving
+      ads. The JavaScript stack includes
+      <a href="http://underscorejs.org/">Underscore.js</a> and
+      <a href="http://jquery.com/">jQuery</a>, with some plugins,
+      all loaded with
+      <a href="http://requirejs.org/">RequireJS</a>. Closure templates are shared between the
+      <a href="http://www.playframework.com/">Play! Framework</a> based Scala application and Backbone views, and the responsive layout
+      is done with the
+      <a href="http://foundation.zurb.com/">Foundation</a> framework using
+      <a href="http://sass-lang.com/">SASS</a>.
+    </p>
+
+    <div style="text-align: center;">
+      <a href="http://gawker.com">
+        <img width="558" height="473" data-original="docs/images/gawker.png" alt="Gawker" class="example_image" />
+      </a>
+    </div>
+
     <h2 id="examples-flow">Flow</h2>
 
     <p>
@@ -2947,23 +3007,23 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
-  	<h2 id="examples-wordpress">WordPress.com</h2>
+    <h2 id="examples-wordpress">WordPress.com</h2>
 
-  	<p>
-  		<a href="http://wordpress.com/">WordPress.com</a> is the software-as-a-service
-  		version of <a href="http://wordpress.org">WordPress</a>. It uses Backbone.js
-  		Models, Collections, and Views in its
-  		<a href="http://en.blog.wordpress.com/2012/05/25/notifications-refreshed/">Notifications system</a>.  Backbone.js was selected
-  		because it was easy to fit into the structure of the application, not the
-  		other way around. <a href="http://automattic.com">Automattic</a>
-  		(the company behind WordPress.com) is integrating Backbone.js into the
-  		Stats tab and other features throughout the homepage.
-  	</p>
+    <p>
+      <a href="http://wordpress.com/">WordPress.com</a> is the software-as-a-service
+      version of <a href="http://wordpress.org">WordPress</a>. It uses Backbone.js
+      Models, Collections, and Views in its
+      <a href="http://en.blog.wordpress.com/2012/05/25/notifications-refreshed/">Notifications system</a>.  Backbone.js was selected
+      because it was easy to fit into the structure of the application, not the
+      other way around. <a href="http://automattic.com">Automattic</a>
+      (the company behind WordPress.com) is integrating Backbone.js into the
+      Stats tab and other features throughout the homepage.
+    </p>
 
     <div style="text-align: center;">
       <a href="http://wordpress.com/">
         <img width="550" height="387" data-original="docs/images/wpcom-notifications.png" alt="WordPress.com Notifications"
-  	title="WordPress.com Notifications" class="example_image" />
+    title="WordPress.com Notifications" class="example_image" />
       </a>
     </div>
 
@@ -3039,6 +3099,29 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
+    <h2 id="examples-elife-lens">eLife Lens</h2>
+
+    <p>
+      <a href="http://elifesciences.github.io/lens/#about/figures/all/video_video1">eLife Lens</a>
+      is a novel system for writing on the web. Instead of tying the content to a
+      presentation focused format, Lens treats
+      <a href="http://blog.okfn.org/2013/01/15/content-as-data-towards-open-digital-publishing-with-substance/">content as data</a>
+      and makes the links that exist within a document easy to navigate. Backbone.js
+      is used to structure the views,
+      <a href="http://interior.substance.io/modules/document.html">Substance Document</a>
+      for representing content and
+      <a href="http://ken.quasipartikel.at/">Ken</a>
+      for faceted filtering. Read more in the official
+      <a href="http://www.elifesciences.org/lens/">introduction post</a>
+      or dig into the <a href="http://github.com/elifesciences/lens">source code</a>.
+    </p>
+
+    <div style="text-align: center;">
+      <a href="http://elifesciences.github.io/lens/#about/figures/all/video_video1">
+        <img width="510" height="383" data-original="docs/images/lens.png" alt="eLife Lens" class="example_retina" />
+      </a>
+    </div>
+
     <h2 id="examples-do">Do</h2>
 
     <p>
@@ -3110,6 +3193,30 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
+    <h2 id="examples-zocdoc">ZocDoc</h2>
+
+    <p>
+      <a href="http://www.zocdoc.com">ZocDoc</a> helps patients
+      find local, in-network doctors and dentists, see their real-time 
+      availability, and instantly book appointments.
+      On the public side, the webapp uses Backbone.js to handle client-side state and rendering in 
+      <a href="http://www.zocdoc.com/primary-care-doctors/los-angeles-13122pm">search pages</a>
+      and <a href="http://www.zocdoc.com/doctor/nathan-hashimoto-md-58078">doctor profiles</a>. 
+      In addition, the new version of the doctor-facing part of the website is a 
+      large single-page application that 
+      benefits from Backbone's structure and modularity. ZocDoc's Backbone 
+      classes are tested with 
+      <a href="http://pivotal.github.io/jasmine/">Jasmine</a>, and delivered 
+      to the end user with 
+      <a href="http://getcassette.net/">Cassette</a>.
+    </p>
+
+    <div style="text-align: center;">
+      <a href="http://www.zocdoc.com">
+        <img width="510" height="464" data-original="docs/images/zocdoc.jpg" alt="ZocDoc" class="example_retina" />
+      </a>
+    </div>
+
     <h2 id="examples-walmart">Walmart Mobile</h2>
 
     <p>
@@ -3197,7 +3304,7 @@ var model = localBackbone.Model.extend(...);
       <a href="https://stripe.com">Stripe</a> provides an API for accepting
       credit cards on the web. Stripe's
       <a href="https://manage.stripe.com">management interface</a> was recently
-      rewritten from scratch in Coffeescript using Backbone.js as the primary
+      rewritten from scratch in CoffeeScript using Backbone.js as the primary
       framework, <a href="https://github.com/sstephenson/eco">Eco</a> for templates, <a href="http://sass-lang.com/">Sass</a> for stylesheets, and <a href="https://github.com/sstephenson/stitch">Stitch</a> to package
       everything together as <a href="http://commonjs.org/">CommonJS</a> modules. The new app uses
       <a href="https://stripe.com/docs/api">Stripe's API</a> directly for the
@@ -3279,7 +3386,7 @@ var model = localBackbone.Model.extend(...);
       love. Art.sy is built on Rails, using
       <a href="https://github.com/intridea/grape">Grape</a> to serve a robust
       <a href="http://artsy.net/api">JSON API</a>. The main site is a single page
-      app written in Coffeescript and uses Backbone to provide structure around
+      app written in CoffeeScript and uses Backbone to provide structure around
       this API. An admin panel and partner CMS have also been extracted into
       their own API-consuming Backbone projects.
     </p>
@@ -3342,7 +3449,7 @@ var model = localBackbone.Model.extend(...);
       everything it has to offer: the router, collections, models, and complex
       event handling. Before, the page was a mess of <a href="http://jquery.com/">jQuery</a> DOM manipulation
       and manual Ajax calls. Backbone.js helped introduce a new way to
-      think about developing an organized front-end application in Javascript.
+      think about developing an organized front-end application in JavaScript.
     </p>
 
     <div style="text-align: center;">
@@ -3404,26 +3511,6 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
-    <h2 id="examples-prose">Prose</h2>
-
-    <p>
-      <a href="http://prose.io">Prose</a> is a content editor for GitHub,
-      optimized for managing websites built with
-      <a href="http://jekyllrb.com/">Jekyll</a> and Github Pages. Prose is
-      itself implemented as a static Jekyll site, using Backbone.js to render
-      the views and handle the routes, as well as
-      <a href="http://github.com/michael/github">Github.js</a>, a small data
-      abstraction layer for manipulating files directly on Github. Read more in the
-      <a href="http://developmentseed.org/blog/2012/june/25/prose-a-content-editor-for-github/">official introduction post</a>,
-      or <a href="https://github.com/prose/prose">take a look at the source code</a>.
-    </p>
-
-    <div style="text-align: center;">
-      <a href="http://prose.io">
-        <img width="550" height="447" data-original="docs/images/prose.png" alt="Prose" class="example_image" />
-      </a>
-    </div>
-
     <h2 id="examples-jolicloud">Jolicloud</h2>
 
     <p>
@@ -3445,22 +3532,6 @@ var model = localBackbone.Model.extend(...);
       </a>
     </div>
 
-    <h2 id="examples-battlefield">Battlefield Play4Free</h2>
-
-    <p>
-      <a href="http://battlefield.play4free.com/">Battlefield Play4Free</a> is
-      the latest free-to-play first person shooter from the same team that
-      created Battlefield Heroes. The in-game HTML5 front-end for makes heavy use of
-      Backbone's views, models and collections to help keep the code modular
-      and structured.
-    </p>
-
-    <div style="text-align: center;">
-      <a href="http://battlefield.play4free.com/">
-        <img width="550" height="435" data-original="docs/images/battlefield.png" alt="Battlefield Play4Free" class="example_image" />
-      </a>
-    </div>
-
     <h2 id="examples-syllabus">Syllabus</h2>
 
     <p>
@@ -3582,7 +3653,7 @@ var model = localBackbone.Model.extend(...);
     <p id="FAQ-why-backbone">
       <b class="header">Why use Backbone, not [other framework X]?</b>
       <br />
-      If your eye hasn't already been caught by the adaptibility and elan on display
+      If your eye hasn't already been caught by the adaptability and elan on display
       in the above <a href="#examples">list of examples</a>, we can get more specific:
       Backbone.js aims to provide the common foundation that data-rich web applications
       with ambitious interfaces require &mdash; while very deliberately avoiding
@@ -3605,7 +3676,7 @@ var model = localBackbone.Model.extend(...);
         <a href="http://mustache.github.com">way</a>.
       </li>
       <li>
-        It's smaller. There's fewer kilobytes for your browser or phone to download,
+        It's smaller. There are fewer kilobytes for your browser or phone to download,
         and less <i>conceptual</i> surface area. You can read and understand
         the source in an afternoon.
       </li>
@@ -3618,7 +3689,7 @@ var model = localBackbone.Model.extend(...);
         <a href="#Events">Synchronous events</a> are used as the fundamental
         building block, not a difficult-to-reason-about run loop, or by constantly
         polling and traversing your data structures to hunt for changes. And if
-        you want a specific event to be aynchronous and aggregated,
+        you want a specific event to be asynchronous and aggregated,
         <a href="http://underscorejs.org/#debounce">no problem</a>.
       </li>
       <li>
@@ -3644,7 +3715,7 @@ var model = localBackbone.Model.extend(...);
       <li>
         There's no built-in performance penalty for choosing to structure your
         code with Backbone. And if you do want to optimize further, thin models and
-        templates with flexible granularity make it easy squeeze every last
+        templates with flexible granularity make it easy to squeeze every last
         drop of potential performance out of, say, IE8.
       </li>
     </ul>
@@ -3731,13 +3802,13 @@ var inbox = new Mailbox;
 
 // And then, when the Inbox is opened:
 
-inbox.messages.fetch();
+inbox.messages.fetch({reset: true});
 </pre>
 
     <p>
       If you're looking for something more opinionated, there are a number of
       Backbone plugins that add sophisticated associations among models,
-      <a href="https://github.com/documentcloud/backbone/wiki/Extensions%2C-Plugins%2C-Resources">available on the wiki</a>.
+      <a href="https://github.com/jashkenas/backbone/wiki/Extensions%2C-Plugins%2C-Resources">available on the wiki</a>.
     </p>
 
     <p>
@@ -3922,7 +3993,38 @@ ActiveRecord::Base.include_root_in_json = false
 
     <h2 id="changelog">Change Log</h2>
 
-    <b class="header">1.0.0</b> &mdash; <small><i>March 20, 2013</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.9.10...1.0.0">Diff</a><br />
+    <b class="header">1.1.0</b> &mdash; <small><i>Oct. 10, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/1.0.0...1.1.0">Diff</a><br />
+    <ul style="margin-top: 5px;">
+      <li>
+        Made the return values of Collection's <tt>set</tt>, <tt>add</tt>, 
+        <tt>remove</tt>, and <tt>reset</tt> more useful. Instead of returning
+        <tt>this</tt>, they now return the changed (added, removed or updated) 
+        model or list of models.
+      </li>
+      <li>
+        Backbone Views no longer attach "special" options as direct properties
+        on the view (<tt>model</tt>, <tt>attributes</tt>, <tt>className</tt>, and so on).
+      </li>
+      <li>
+        All <tt>"invalid"</tt> events now pass consistent arguments. First the
+        model in question, then the error object, then options.
+      </li>
+      <li>
+        You are no longer permitted to change the <b>id</b> of your model during
+        <tt>parse</tt>. Use <tt>idAttribute</tt> instead.
+      </li>
+      <li>
+        On the other hand, <tt>parse</tt> is now an excellent place to extract
+        and vivify incoming nested JSON into associated submodels.
+      </li>
+      <li>
+        Many tweaks, optimizations and bugfixes relating to Backbone 1.0, 
+        including URL overrides, mutation of options, bulk ordering, trailing
+        slashes, edge-case listener leaks, nested model parsing...
+      </li>
+    </ul>
+
+    <b class="header">1.0.0</b> &mdash; <small><i>March 20, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.9.10...1.0.0">Diff</a><br />
     <ul style="margin-top: 5px;">
       <li>
         Renamed Collection's "update" to <a href="#Collection-set">set</a>, for
@@ -3956,7 +4058,7 @@ ActiveRecord::Base.include_root_in_json = false
       </li>
     </ul>
 
-    <b class="header">0.9.10</b> &mdash; <small><i>Jan. 15, 2013</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.9.9...0.9.10">Diff</a><br />
+    <b class="header">0.9.10</b> &mdash; <small><i>Jan. 15, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.9.9...0.9.10">Diff</a><br />
     <ul style="margin-top: 5px;">
       <li>
         A <tt>"route"</tt> event is triggered on the router in addition
@@ -3997,7 +4099,7 @@ ActiveRecord::Base.include_root_in_json = false
       </li>
     </ul>
 
-    <b class="header">0.9.9</b> &mdash; <small><i>Dec. 13, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.9.2...0.9.9">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.9.9/index.html">Docs</a><br />
+    <b class="header">0.9.9</b> &mdash; <small><i>Dec. 13, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.9.2...0.9.9">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.9.9/index.html">Docs</a><br />
     <ul style="margin-top: 5px;">
       <li>
         Added <a href="#Events-listenTo">listenTo</a>
@@ -4113,9 +4215,13 @@ ActiveRecord::Base.include_root_in_json = false
         parameters.  Routes like <tt>search?query=&amp;page=3</tt> should become
         <tt>search//3</tt>.
       </li>
+      <li>
+        <tt>Model#set</tt> no longer accepts another model as an argument.  This leads
+        to subtle problems and is easily replaced with <tt>model.set(other.attributes)</tt>.
+      </li>
     </ul>
 
-    <b class="header">0.9.2</b> &mdash; <small><i>March 21, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.9.1...0.9.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.9.2/index.html">Docs</a><br />
+    <b class="header">0.9.2</b> &mdash; <small><i>March 21, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.9.1...0.9.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.9.2/index.html">Docs</a><br />
     <ul style="margin-top: 5px;">
       <li>
         Instead of throwing an error when adding duplicate models to a collection,
@@ -4157,7 +4263,7 @@ ActiveRecord::Base.include_root_in_json = false
       </li>
     </ul>
 
-    <b class="header">0.9.1</b> &mdash; <small><i>Feb. 2, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.9.0...0.9.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.9.1/index.html">Docs</a><br />
+    <b class="header">0.9.1</b> &mdash; <small><i>Feb. 2, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.9.0...0.9.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.9.1/index.html">Docs</a><br />
     <ul style="margin-top: 5px;">
       <li>
         Reverted to 0.5.3-esque behavior for validating models. Silent changes
@@ -4175,7 +4281,7 @@ ActiveRecord::Base.include_root_in_json = false
       </li>
     </ul>
 
-    <b class="header">0.9.0</b> &mdash; <small><i>Jan. 30, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.5.3...0.9.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.9.0/index.html">Docs</a><br />
+    <b class="header">0.9.0</b> &mdash; <small><i>Jan. 30, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.5.3...0.9.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.9.0/index.html">Docs</a><br />
     <ul style="margin-top: 5px;">
       <li>
         Creating and destroying models with <tt>create</tt> and <tt>destroy</tt>
@@ -4273,7 +4379,7 @@ ActiveRecord::Base.include_root_in_json = false
     </ul>
 
     <p>
-      <b class="header">0.5.3</b> &mdash; <small><i>August 9, 2011</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.5.2...0.5.3">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.5.3/index.html">Docs</a><br />
+      <b class="header">0.5.3</b> &mdash; <small><i>August 9, 2011</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.5.2...0.5.3">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.5.3/index.html">Docs</a><br />
       A View's <tt>events</tt> property may now be defined as a function, as well
       as an object literal, making it easier to programmatically define and inherit
       events. <tt>groupBy</tt> is now proxied from Underscore as a method on Collections.
@@ -4283,7 +4389,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.5.2</b> &mdash; <small><i>July 26, 2011</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.5.1...0.5.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.5.2/index.html">Docs</a><br />
+      <b class="header">0.5.2</b> &mdash; <small><i>July 26, 2011</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.5.1...0.5.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.5.2/index.html">Docs</a><br />
       The <tt>bind</tt> function, can now take an optional third argument, to specify
       the <tt>this</tt> of the callback function.
       Multiple models with the same <tt>id</tt> are now allowed in a collection.
@@ -4294,7 +4400,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.5.1</b> &mdash; <small><i>July 5, 2011</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.5.0...0.5.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.5.1/index.html">Docs</a><br />
+      <b class="header">0.5.1</b> &mdash; <small><i>July 5, 2011</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.5.0...0.5.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.5.1/index.html">Docs</a><br />
       Cleanups from the 0.5.0 release, to wit: improved transparent upgrades from
       hash-based URLs to pushState, and vice-versa. Fixed inconsistency with
       non-modified attributes being passed to <tt>Model#initialize</tt>. Reverted
@@ -4303,9 +4409,9 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.5.0</b> &mdash; <small><i>July 1, 2011</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.3.3...0.5.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.5.0/index.html">Docs</a><br />
+      <b class="header">0.5.0</b> &mdash; <small><i>July 1, 2011</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.3.3...0.5.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.5.0/index.html">Docs</a><br />
       A large number of tiny tweaks and micro bugfixes, best viewed by looking
-      at <a href="https://github.com/documentcloud/backbone/compare/0.3.3...0.5.0">the commit diff</a>.
+      at <a href="https://github.com/jashkenas/backbone/compare/0.3.3...0.5.0">the commit diff</a>.
       HTML5 <tt>pushState</tt> support, enabled by opting-in with:
       <tt>Backbone.history.start({pushState: true})</tt>.
       <tt>Controller</tt> was renamed to <tt>Router</tt>, for clarity.
@@ -4327,7 +4433,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.3.3</b> &mdash; <small><i>Dec 1, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.3.2...0.3.3">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.3.3/index.html">Docs</a><br />
+      <b class="header">0.3.3</b> &mdash; <small><i>Dec 1, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.3.2...0.3.3">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.3.3/index.html">Docs</a><br />
       Backbone.js now supports <a href="http://zeptojs.com">Zepto</a>, alongside
       jQuery, as a framework for DOM manipulation and Ajax support.
       Implemented <a href="#Model-escape">Model#escape</a>, to efficiently handle
@@ -4338,7 +4444,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.3.2</b> &mdash; <small><i>Nov 23, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.3.1...0.3.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.3.2/index.html">Docs</a><br />
+      <b class="header">0.3.2</b> &mdash; <small><i>Nov 23, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.3.1...0.3.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.3.2/index.html">Docs</a><br />
       Bugfix for IE7 + iframe-based "hashchange" events. <tt>sync</tt> may now be
       overridden on a per-model, or per-collection basis. Fixed recursion error
       when calling <tt>save</tt> with no changed attributes, within a
@@ -4346,7 +4452,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.3.1</b> &mdash; <small><i>Nov 15, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.3.0...0.3.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.3.1/index.html">Docs</a><br />
+      <b class="header">0.3.1</b> &mdash; <small><i>Nov 15, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.3.0...0.3.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.3.1/index.html">Docs</a><br />
       All <tt>"add"</tt> and <tt>"remove"</tt> events are now sent through the
       model, so that views can listen for them without having to know about the
       collection. Added a <tt>remove</tt> method to <a href="#View">Backbone.View</a>.
@@ -4355,7 +4461,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.3.0</b> &mdash; <small><i>Nov 9, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.2.0...0.3.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.3.0/index.html">Docs</a><br />
+      <b class="header">0.3.0</b> &mdash; <small><i>Nov 9, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.2.0...0.3.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.3.0/index.html">Docs</a><br />
       Backbone now has <a href="#Controller">Controllers</a> and
       <a href="#History">History</a>, for doing client-side routing based on
       URL fragments.
@@ -4369,7 +4475,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.2.0</b> &mdash; <small><i>Oct 25, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.1.2...0.2.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.2.0/index.html">Docs</a><br />
+      <b class="header">0.2.0</b> &mdash; <small><i>Oct 25, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.1.2...0.2.0">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.2.0/index.html">Docs</a><br />
       Instead of requiring server responses to be namespaced under a <tt>model</tt>
       key, now you can define your own <a href="#Model-parse">parse</a> method
       to convert responses into attributes for Models and Collections.
@@ -4381,7 +4487,7 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.1.2</b> &mdash; <small><i>Oct 19, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.1.1...0.1.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.1.2/index.html">Docs</a><br />
+      <b class="header">0.1.2</b> &mdash; <small><i>Oct 19, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.1.1...0.1.2">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.1.2/index.html">Docs</a><br />
       Added a <a href="#Model-fetch">Model#fetch</a> method for refreshing the
       attributes of single model from the server.
       An <tt>error</tt> callback may now be passed to <tt>set</tt> and <tt>save</tt>
@@ -4395,13 +4501,13 @@ ActiveRecord::Base.include_root_in_json = false
     </p>
 
     <p>
-      <b class="header">0.1.1</b> &mdash; <small><i>Oct 14, 2010</i></small> &mdash; <a href="https://github.com/documentcloud/backbone/compare/0.1.0...0.1.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.1.1/index.html">Docs</a><br />
+      <b class="header">0.1.1</b> &mdash; <small><i>Oct 14, 2010</i></small> &mdash; <a href="https://github.com/jashkenas/backbone/compare/0.1.0...0.1.1">Diff</a> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.1.1/index.html">Docs</a><br />
       Added a convention for <tt>initialize</tt> functions to be called
       upon instance construction, if defined. Documentation tweaks.
     </p>
 
     <p>
-      <b class="header">0.1.0</b> &mdash; <small><i>Oct 13, 2010</i></small> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/documentcloud/backbone/0.1.0/index.html">Docs</a><br />
+      <b class="header">0.1.0</b> &mdash; <small><i>Oct 13, 2010</i></small> &mdash; <a href="http://htmlpreview.github.com/?https://raw.github.com/jashkenas/backbone/0.1.0/index.html">Docs</a><br />
       Initial Backbone release.
     </p>
 
diff --git a/profiles/commons/libraries/backbone/package.json b/profiles/commons/libraries/backbone/package.json
index c379cd3..79e5a2d 100644
--- a/profiles/commons/libraries/backbone/package.json
+++ b/profiles/commons/libraries/backbone/package.json
@@ -8,13 +8,21 @@
     "underscore"  : ">=1.4.3"
   },
   "devDependencies": {
-    "phantomjs": "1.8.1-3",
+    "phantomjs": "1.9.0-1",
     "docco": "0.6.1",
     "coffee-script": "1.6.1"
   },
   "scripts": {
-    "test": "phantomjs test/vendor/runner.js test/index.html?noglobals=true && coffee test/model.coffee"
+    "test": "phantomjs test/vendor/runner.js test/index.html?noglobals=true && coffee test/model.coffee",
+    "build": "uglifyjs backbone.js --mangle --source-map backbone-min.map -o backbone-min.js",
+    "doc": "docco backbone.js && docco examples/todos/todos.js examples/backbone.localstorage.js",
+    "lint": "jsl -nofilelisting -nologo -conf docs/jsl.conf -process backbone.js"
   },
   "main"          : "backbone.js",
-  "version"       : "1.0.0"
+  "version"       : "1.1.0",
+  "license"       : "MIT",
+  "repository": {
+    "type": "git",
+    "url": "https://github.com/jashkenas/backbone.git"
+  }
 }
diff --git a/profiles/commons/libraries/backbone/test/collection.js b/profiles/commons/libraries/backbone/test/collection.js
index d068b39..748d7bb 100644
--- a/profiles/commons/libraries/backbone/test/collection.js
+++ b/profiles/commons/libraries/backbone/test/collection.js
@@ -1,12 +1,10 @@
-$(document).ready(function() {
+(function() {
 
   var a, b, c, d, e, col, otherCol;
 
-  module("Backbone.Collection", _.extend(new Environment, {
+  module("Backbone.Collection", {
 
     setup: function() {
-      Environment.prototype.setup.apply(this, arguments);
-
       a         = new Backbone.Model({id: 3, label: 'a'});
       b         = new Backbone.Model({id: 2, label: 'b'});
       c         = new Backbone.Model({id: 1, label: 'c'});
@@ -16,7 +14,7 @@ $(document).ready(function() {
       otherCol  = new Backbone.Collection();
     }
 
-  }));
+  });
 
   test("new and sort", 9, function() {
     var counter = 0;
@@ -87,7 +85,7 @@ $(document).ready(function() {
     equal(col2.get(model.clone()), col2.first());
   });
 
-  test("update index when id changes", 3, function() {
+  test("update index when id changes", 4, function() {
     var col = new Backbone.Collection();
     col.add([
       {id : 0, name : 'one'},
@@ -95,9 +93,10 @@ $(document).ready(function() {
     ]);
     var one = col.get(0);
     equal(one.get('name'), 'one');
-    one.set({id : 101});
+    col.on('change:name', function (model) { ok(this.get(model)); });
+    one.set({name: 'dalmatians', id : 101});
     equal(col.get(0), null);
-    equal(col.get(101).get('name'), 'one');
+    equal(col.get(101).get('name'), 'dalmatians');
   });
 
   test("at", 1, function() {
@@ -226,13 +225,13 @@ $(document).ready(function() {
   });
 
   test("add with parse and merge", function() {
-    var Model = Backbone.Model.extend({
-      parse: function (data) {
-        return data.model;
-      }
-    });
     var collection = new Backbone.Collection();
-    collection.model = Model;
+    collection.parse = function(attrs) {
+      return _.map(attrs, function(model) {
+        if (model.model) return model.model;
+        return model;
+      });
+    };
     collection.add({id: 1});
     collection.add({model: {id: 1, name: 'Alf'}}, {parse: true, merge: true});
     equal(collection.first().get('name'), 'Alf');
@@ -288,6 +287,39 @@ $(document).ready(function() {
     equal(otherRemoved, null);
   });
 
+  test("add and remove return values", 13, function() {
+    var Even = Backbone.Model.extend({
+      validate: function(attrs) {
+        if (attrs.id % 2 !== 0) return "odd";
+      }
+    });
+    var col = new Backbone.Collection;
+    col.model = Even;
+
+    var list = col.add([{id: 2}, {id: 4}], {validate: true});
+    equal(list.length, 2);
+    ok(list[0] instanceof Backbone.Model);
+    equal(list[1], col.last());
+    equal(list[1].get('id'), 4);
+
+    list = col.add([{id: 3}, {id: 6}], {validate: true});
+    equal(col.length, 3);
+    equal(list[0], false);
+    equal(list[1].get('id'), 6);
+
+    var result = col.add({id: 6});
+    equal(result.cid, list[1].cid);
+
+    result = col.remove({id: 6});
+    equal(col.length, 2);
+    equal(result.id, 6);
+
+    list = col.remove([{id: 2}, {id: 8}]);
+    equal(col.length, 1);
+    equal(list[0].get('id'), 2);
+    equal(list[1], null);
+  });
+
   test("shift and pop", 2, function() {
     var col = new Backbone.Collection([{a: 'a'}, {b: 'b'}, {c: 'c'}]);
     equal(col.shift().get('a'), 'a');
@@ -438,7 +470,7 @@ $(document).ready(function() {
     equal(model.collection, collection);
   });
 
-  test("create with validate:true enforces validation", 2, function() {
+  test("create with validate:true enforces validation", 3, function() {
     var ValidatingModel = Backbone.Model.extend({
       validate: function(attrs) {
         return "fail";
@@ -448,7 +480,8 @@ $(document).ready(function() {
       model: ValidatingModel
     });
     var col = new ValidatingCollection();
-    col.on('invalid', function (collection, attrs, options) {
+    col.on('invalid', function (collection, error, options) {
+      equal(error, "fail");
       equal(options.validationError, 'fail');
     });
     equal(col.create({"foo":"bar"}, {validate:true}), false);
@@ -502,7 +535,7 @@ $(document).ready(function() {
     equal(coll.findWhere({a: 4}), void 0);
   });
 
-  test("Underscore methods", 13, function() {
+  test("Underscore methods", 14, function() {
     equal(col.map(function(model){ return model.get('label'); }).join(' '), 'a b c d');
     equal(col.any(function(model){ return model.id === 100; }), false);
     equal(col.any(function(model){ return model.id === 0; }), true);
@@ -520,18 +553,7 @@ $(document).ready(function() {
             .map(function(o){ return o.id * 2; })
             .value(),
          [4, 0]);
-  });
-
-  test("sortedIndex", function () {
-    var model = new Backbone.Model({key: 2});
-    var collection = new (Backbone.Collection.extend({
-      comparator: 'key'
-    }))([model, {key: 1}]);
-    equal(collection.sortedIndex(model), 1);
-    equal(collection.sortedIndex(model, 'key'), 1);
-    equal(collection.sortedIndex(model, function (model) {
-      return model.get('key');
-    }), 1);
+    deepEqual(col.difference([c, d]), [a, b]);
   });
 
   test("reset", 12, function() {
@@ -920,6 +942,20 @@ $(document).ready(function() {
     strictEqual(c.length, 0);
   });
 
+  test("set with many models does not overflow the stack", function() {
+    var n = 150000;
+    var collection = new Backbone.Collection();
+    var models = [];
+    for (var i = 0; i < n; i++) {
+      models.push({id: i});
+    }
+    collection.set(models);
+    equal(collection.length, n);
+    collection.reset();
+    collection.set(models, {at: 0});
+    equal(collection.length, n);
+  });
+
   test("set with only cids", 3, function() {
     var m1 = new Backbone.Model;
     var m2 = new Backbone.Model;
@@ -963,17 +999,33 @@ $(document).ready(function() {
     equal(col.first().get('key'), 'other');
 
     col.set({id: 1, other: 'value'});
-    equal(col.first().get('key'), 'value');
+    equal(col.first().get('key'), 'other');
     equal(col.length, 1);
   });
 
-  test("`set` and model level `parse`", function() {
+  test('merge without mutation', function () {
     var Model = Backbone.Model.extend({
-      parse: function (res) { return res.model; }
+      initialize: function (attrs, options) {
+        if (attrs.child) {
+          this.set('child', new Model(attrs.child, options), options);
+        }
+      }
     });
+    var Collection = Backbone.Collection.extend({model: Model});
+    var data = [{id: 1, child: {id: 2}}];
+    var collection = new Collection(data);
+    equal(collection.first().id, 1);
+    collection.set(data);
+    equal(collection.first().id, 1);
+    collection.set([{id: 2, child: {id: 2}}].concat(data));
+    deepEqual(collection.pluck('id'), [2, 1]);
+  });
+
+  test("`set` and model level `parse`", function() {
+    var Model = Backbone.Model.extend({});
     var Collection = Backbone.Collection.extend({
       model: Model,
-      parse: function (res) { return res.models; }
+      parse: function (res) { return _.pluck(res.models, 'model'); }
     });
     var model = new Model({id: 1});
     var collection = new Collection(model);
@@ -996,6 +1048,25 @@ $(document).ready(function() {
     collection.set({}, {parse: true});
   });
 
+  test('`set` matches input order in the absence of a comparator', function () {
+    var one = new Backbone.Model({id: 1});
+    var two = new Backbone.Model({id: 2});
+    var three = new Backbone.Model({id: 3});
+    var collection = new Backbone.Collection([one, two, three]);
+    collection.set([{id: 3}, {id: 2}, {id: 1}]);
+    deepEqual(collection.models, [three, two, one]);
+    collection.set([{id: 1}, {id: 2}]);
+    deepEqual(collection.models, [one, two]);
+    collection.set([two, three, one]);
+    deepEqual(collection.models, [two, three, one]);
+    collection.set([{id: 1}, {id: 2}], {remove: false});
+    deepEqual(collection.models, [two, three, one]);
+    collection.set([{id: 1}, {id: 2}, {id: 3}], {merge: false});
+    deepEqual(collection.models, [one, two, three]);
+    collection.set([three, two, one, {id: 4}], {add: false});
+    deepEqual(collection.models, [one, two, three]);
+  });
+
   test("#1894 - Push should not trigger a sort", 0, function() {
     var Collection = Backbone.Collection.extend({
       comparator: 'id',
@@ -1006,6 +1077,13 @@ $(document).ready(function() {
     new Collection().push({id: 1});
   });
 
+  test("#2428 - push duplicate models, return the correct one", 1, function() {
+    var col = new Backbone.Collection;
+    var model1 = col.push({id: 101});
+    var model2 = col.push({id: 101})
+    ok(model2.cid == model1.cid);
+  });
+
   test("`set` with non-normal id", function() {
     var Collection = Backbone.Collection.extend({
       model: Backbone.Model.extend({idAttribute: '_id'})
@@ -1081,20 +1159,119 @@ $(document).ready(function() {
     collection.add(collection.models, {merge: true}); // don't sort
   });
 
-  test("Attach options to collection.", 3, function() {
-      var url = '/somewhere';
-      var model = new Backbone.Model;
-      var comparator = function(){};
+  test("Attach options to collection.", 2, function() {
+    var model = new Backbone.Model;
+    var comparator = function(){};
 
-      var collection = new Backbone.Collection([], {
-        url: url,
-        model: model,
-        comparator: comparator
-      });
+    var collection = new Backbone.Collection([], {
+      model: model,
+      comparator: comparator
+    });
 
-      strictEqual(collection.url, url);
-      ok(collection.model === model);
-      ok(collection.comparator === comparator);
+    ok(collection.model === model);
+    ok(collection.comparator === comparator);
   });
 
-});
+  test("`add` overrides `set` flags", function () {
+    var collection = new Backbone.Collection();
+    collection.once('add', function (model, collection, options) {
+      collection.add({id: 2}, options);
+    });
+    collection.set({id: 1});
+    equal(collection.length, 2);
+  });
+
+  test("#2606 - Collection#create, success arguments", 1, function() {
+    var collection = new Backbone.Collection;
+    collection.url = 'test';
+    collection.create({}, {
+      success: function(model, resp, options) {
+        strictEqual(resp, 'response');
+      }
+    });
+    this.ajaxSettings.success('response');
+  });
+
+  test("#2612 - nested `parse` works with `Collection#set`", function() {
+
+    var Job = Backbone.Model.extend({
+      constructor: function() {
+        this.items = new Items();
+        Backbone.Model.apply(this, arguments);
+      },
+      parse: function(attrs) {
+        this.items.set(attrs.items, {parse: true});
+        return _.omit(attrs, 'items');
+      }
+    });
+
+    var Item = Backbone.Model.extend({
+      constructor: function() {
+        this.subItems = new Backbone.Collection();
+        Backbone.Model.apply(this, arguments);
+      },
+      parse: function(attrs) {
+        this.subItems.set(attrs.subItems, {parse: true});
+        return _.omit(attrs, 'subItems');
+      }
+    });
+
+    var Items = Backbone.Collection.extend({
+      model: Item
+    });
+
+    var data = {
+      name: 'JobName',
+      id: 1,
+      items: [{
+        id: 1,
+        name: 'Sub1',
+        subItems: [
+          {id: 1, subName: 'One'},
+          {id: 2, subName: 'Two'}
+        ]
+      }, {
+        id: 2,
+        name: 'Sub2',
+        subItems: [
+          {id: 3, subName: 'Three'},
+          {id: 4, subName: 'Four'}
+        ]
+      }]
+    };
+
+    var newData = {
+      name: 'NewJobName',
+      id: 1,
+      items: [{
+        id: 1,
+        name: 'NewSub1',
+        subItems: [
+          {id: 1,subName: 'NewOne'},
+          {id: 2,subName: 'NewTwo'}
+        ]
+      }, {
+        id: 2,
+        name: 'NewSub2',
+        subItems: [
+          {id: 3,subName: 'NewThree'},
+          {id: 4,subName: 'NewFour'}
+        ]
+      }]
+    };
+
+    var job = new Job(data, {parse: true});
+    equal(job.get('name'), 'JobName');
+    equal(job.items.at(0).get('name'), 'Sub1');
+    equal(job.items.length, 2);
+    equal(job.items.get(1).subItems.get(1).get('subName'), 'One');
+    equal(job.items.get(2).subItems.get(3).get('subName'), 'Three');
+    job.set(job.parse(newData, {parse: true}));
+    equal(job.get('name'), 'NewJobName');
+    equal(job.items.at(0).get('name'), 'NewSub1');
+    equal(job.items.length, 2);
+    equal(job.items.get(1).subItems.get(1).get('subName'), 'NewOne');
+    equal(job.items.get(2).subItems.get(3).get('subName'), 'NewThree');
+  });
+
+})();
diff --git a/profiles/commons/libraries/backbone/test/environment.js b/profiles/commons/libraries/backbone/test/environment.js
index 54aa2c4..996884b 100644
--- a/profiles/commons/libraries/backbone/test/environment.js
+++ b/profiles/commons/libraries/backbone/test/environment.js
@@ -1,45 +1,35 @@
 (function() {
 
-  var Environment = this.Environment = function(){};
-
-  _.extend(Environment.prototype, {
-
-    ajax: Backbone.ajax,
-
-    sync: Backbone.sync,
-
-    emulateHTTP: Backbone.emulateHTTP,
-
-    emulateJSON: Backbone.emulateJSON,
-
-    setup: function() {
-      var env = this;
-
-      // Capture ajax settings for comparison.
-      Backbone.ajax = function(settings) {
-        env.ajaxSettings = settings;
+  var sync = Backbone.sync;
+  var ajax = Backbone.ajax;
+  var emulateHTTP = Backbone.emulateHTTP;
+  var emulateJSON = Backbone.emulateJSON;
+
+  QUnit.testStart(function() {
+    var env = this.config.current.testEnvironment;
+
+    // Capture ajax settings for comparison.
+    Backbone.ajax = function(settings) {
+      env.ajaxSettings = settings;
+    };
+
+    // Capture the arguments to Backbone.sync for comparison.
+    Backbone.sync = function(method, model, options) {
+      env.syncArgs = {
+        method: method,
+        model: model,
+        options: options
       };
+      sync.apply(this, arguments);
+    };
 
-      // Capture the arguments to Backbone.sync for comparison.
-      Backbone.sync = function(method, model, options) {
-        env.syncArgs = {
-          method: method,
-          model: model,
-          options: options
-        };
-        env.sync.apply(this, arguments);
-      };
-    },
-
-    teardown: function() {
-      this.syncArgs = null;
-      this.ajaxSettings = null;
-      Backbone.sync = this.sync;
-      Backbone.ajax = this.ajax;
-      Backbone.emulateHTTP = this.emulateHTTP;
-      Backbone.emulateJSON = this.emulateJSON;
-    }
+  });
 
+  QUnit.testDone(function() {
+    Backbone.sync = sync;
+    Backbone.ajax = ajax;
+    Backbone.emulateHTTP = emulateHTTP;
+    Backbone.emulateJSON = emulateJSON;
   });
 
 })();
diff --git a/profiles/commons/libraries/backbone/test/events.js b/profiles/commons/libraries/backbone/test/events.js
index 1aa746c..9f6878e 100644
--- a/profiles/commons/libraries/backbone/test/events.js
+++ b/profiles/commons/libraries/backbone/test/events.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   module("Backbone.Events");
 
@@ -152,6 +152,31 @@ $(document).ready(function() {
     e.trigger("foo");
   });
 
+  test("stopListening cleans up references", 4, function() {
+    var a = _.extend({}, Backbone.Events);
+    var b = _.extend({}, Backbone.Events);
+    var fn = function() {};
+    a.listenTo(b, 'all', fn).stopListening();
+    equal(_.size(a._listeningTo), 0);
+    a.listenTo(b, 'all', fn).stopListening(b);
+    equal(_.size(a._listeningTo), 0);
+    a.listenTo(b, 'all', fn).stopListening(null, 'all');
+    equal(_.size(a._listeningTo), 0);
+    a.listenTo(b, 'all', fn).stopListening(null, null, fn);
+    equal(_.size(a._listeningTo), 0);
+  });
+
+  test("listenTo and stopListening cleaning up references", 2, function() {
+    var a = _.extend({}, Backbone.Events);
+    var b = _.extend({}, Backbone.Events);
+    a.listenTo(b, 'all', function(){ ok(true); });
+    b.trigger('anything');
+    a.listenTo(b, 'other', function(){ ok(false); });
+    a.stopListening(b, 'other');
+    a.stopListening(b, 'all');
+    equal(_.keys(a._listeningTo).length, 0);
+  });
+
   test("listenTo with empty callback doesn't throw an error", 1, function(){
     var e = _.extend({}, Backbone.Events);
     e.listenTo(e, "foo", null);
@@ -449,4 +474,4 @@ $(document).ready(function() {
     equal(obj, obj.stopListening());
   });
 
-});
+})();
diff --git a/profiles/commons/libraries/backbone/test/index.html b/profiles/commons/libraries/backbone/test/index.html
index 1f57708..46f28f6 100644
--- a/profiles/commons/libraries/backbone/test/index.html
+++ b/profiles/commons/libraries/backbone/test/index.html
@@ -4,6 +4,15 @@
   <meta charset='utf8'>
   <title>Backbone Test Suite</title>
   <link rel="stylesheet" href="vendor/qunit.css" type="text/css" media="screen">
+  <link rel="icon" href="../docs/images/favicon.ico">
+</head>
+<body>
+  <div id="qunit"></div>
+  <div id="qunit-fixture">
+    <div id='testElement'>
+      <h1>Test</h1>
+    </div>
+  </div>
   <script src="vendor/json2.js"></script>
   <script src="vendor/jquery.js"></script>
   <script src="vendor/qunit.js"></script>
@@ -17,13 +26,5 @@
   <script src="router.js"></script>
   <script src="view.js"></script>
   <script src="sync.js"></script>
-</head>
-<body>
-  <div id="qunit"></div>
-  <div id="qunit-fixture">
-    <div id='testElement'>
-      <h1>Test</h1>
-    </div>
-  </div>
 </body>
 </html>
diff --git a/profiles/commons/libraries/backbone/test/model.js b/profiles/commons/libraries/backbone/test/model.js
index 3b196c4..ec1ba54 100644
--- a/profiles/commons/libraries/backbone/test/model.js
+++ b/profiles/commons/libraries/backbone/test/model.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   var proxy = Backbone.Model.extend();
   var klass = Backbone.Collection.extend({
@@ -6,10 +6,9 @@ $(document).ready(function() {
   });
   var doc, collection;
 
-  module("Backbone.Model", _.extend(new Environment, {
+  module("Backbone.Model", {
 
     setup: function() {
-      Environment.prototype.setup.apply(this, arguments);
       doc = new proxy({
         id     : '1-the-tempest',
         title  : "The Tempest",
@@ -20,7 +19,7 @@ $(document).ready(function() {
       collection.add(doc);
     }
 
-  }));
+  });
 
   test("initialize", 3, function() {
     var Model = Backbone.Model.extend({
@@ -111,13 +110,6 @@ $(document).ready(function() {
     equal(model.url(), '/nested/1/collection/2');
   });
 
-  test('url and urlRoot are directly attached if passed in the options', 2, function () {
-    var model = new Backbone.Model({a: 1}, {url: '/test'});
-    var model2 = new Backbone.Model({a: 2}, {urlRoot: '/test2'});
-    equal(model.url, '/test');
-    equal(model2.urlRoot, '/test2');
-  });
-
   test("underscore methods", 5, function() {
     var model = new Backbone.Model({ 'foo': 'a', 'bar': 'b', 'baz': 'c' });
     var model2 = model.clone();
@@ -712,6 +704,22 @@ $(document).ready(function() {
     ok(this.syncArgs.model === model);
   });
 
+  test("save without `wait` doesn't set invalid attributes", function () {
+    var model = new Backbone.Model();
+    model.validate = function () { return 1; }
+    model.save({a: 1});
+    equal(model.get('a'), void 0);
+  });
+
+  test("save doesn't validate twice", function () {
+    var model = new Backbone.Model();
+    var times = 0;
+    model.sync = function () {};
+    model.validate = function () { ++times; }
+    model.save({});
+    equal(times, 1);
+  });
+
   test("`hasChanged` for falsey keys", 2, function() {
     var model = new Backbone.Model();
     model.set({x: true}, {silent: true});
@@ -1099,4 +1107,4 @@ $(document).ready(function() {
     model.set({a: true});
   });
 
-});
+})();
diff --git a/profiles/commons/libraries/backbone/test/noconflict.js b/profiles/commons/libraries/backbone/test/noconflict.js
index a0e55ca..ac4324d 100644
--- a/profiles/commons/libraries/backbone/test/noconflict.js
+++ b/profiles/commons/libraries/backbone/test/noconflict.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   module("Backbone.noConflict");
 
@@ -9,4 +9,4 @@ $(document).ready(function() {
     equal(window.Backbone, noconflictBackbone, 'Backbone is still pointing to the original Backbone');
   });
 
-});
+})();
diff --git a/profiles/commons/libraries/backbone/test/router.js b/profiles/commons/libraries/backbone/test/router.js
index e6e1b3d..296546e 100644
--- a/profiles/commons/libraries/backbone/test/router.js
+++ b/profiles/commons/libraries/backbone/test/router.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   var router = null;
   var location = null;
@@ -75,6 +75,8 @@ $(document).ready(function() {
       "counter":                    "counter",
       "search/:query":              "search",
       "search/:query/p:page":       "search",
+      "char":                      "charUTF",
+      "char%C3%B1":                 "charEscaped",
       "contacts":                   "contacts",
       "contacts/new":               "newContact",
       "contacts/:id":               "loadContact",
@@ -103,11 +105,19 @@ $(document).ready(function() {
       this.count++;
     },
 
-    search : function(query, page) {
+    search: function(query, page) {
       this.query = query;
       this.page = page;
     },
 
+    charUTF: function() {
+      this.charType = 'UTF';
+    },
+
+    charEscaped: function() {
+      this.charType = 'escaped';
+    },
+
     contacts: function(){
       this.contact = 'index';
     },
@@ -204,6 +214,10 @@ $(document).ready(function() {
     equal(router.page, '20');
   });
 
+  test("reports matched route via nagivate", 1, function() {
+    ok(Backbone.history.navigate('search/manhattan/p20', true));
+  });
+
   test("route precedence via navigate", 6, function(){
     // check both 0.9.x and backwards-compatibility options
     _.each([ { trigger: true }, true ], function( options ){
@@ -349,6 +363,13 @@ $(document).ready(function() {
     equal(lastRoute, 'search');
   });
 
+  test("#2666 - Hashes with UTF8 in them.", 2, function() {
+    Backbone.history.navigate('char', {trigger: true});
+    equal(router.charType, 'UTF');
+    Backbone.history.navigate('char%C3%B1', {trigger: true});
+    equal(router.charType, 'escaped');
+  });
+
   test("#1185 - Use pathname when hashChange is not wanted.", 1, function() {
     Backbone.history.stop();
     location.replace('http://example.com/path/name#hash');
@@ -609,4 +630,100 @@ $(document).ready(function() {
     deepEqual({home: "root", index: "index.html", show: "show", search: "search"}, router.routes);
   });
 
-});
+  test("#2538 - hashChange to pushState only if both requested.", 0, function() {
+    Backbone.history.stop();
+    location.replace('http://example.com/root?a=b#x/y');
+    Backbone.history = _.extend(new Backbone.History, {
+      location: location,
+      history: {
+        pushState: function(){},
+        replaceState: function(){ ok(false); }
+      }
+    });
+    Backbone.history.start({
+      root: 'root',
+      pushState: true,
+      hashChange: false
+    });
+  });
+
+  test('No hash fallback.', 0, function() {
+    Backbone.history.stop();
+    Backbone.history = _.extend(new Backbone.History, {
+      location: location,
+      history: {
+        pushState: function(){},
+        replaceState: function(){}
+      }
+    });
+
+    var Router = Backbone.Router.extend({
+      routes: {
+        hash: function() { ok(false); }
+      }
+    });
+    var router = new Router;
+
+    location.replace('http://example.com/');
+    Backbone.history.start({
+      pushState: true,
+      hashChange: false
+    });
+    location.replace('http://example.com/nomatch#hash');
+    Backbone.history.checkUrl();
+  });
+
+  test('#2656 - No trailing slash on root.', 1, function() {
+    Backbone.history.stop();
+    Backbone.history = _.extend(new Backbone.History, {
+      location: location,
+      history: {
+        pushState: function(state, title, url){
+          strictEqual(url, '/root');
+        }
+      }
+    });
+    location.replace('http://example.com/root/path');
+    Backbone.history.start({pushState: true, root: 'root'});
+    Backbone.history.navigate('');
+  });
+
+  test('#2656 - No trailing slash on root.', 1, function() {
+    Backbone.history.stop();
+    Backbone.history = _.extend(new Backbone.History, {
+      location: location,
+      history: {
+        pushState: function(state, title, url) {
+          strictEqual(url, '/');
+        }
+      }
+    });
+    location.replace('http://example.com/path');
+    Backbone.history.start({pushState: true});
+    Backbone.history.navigate('');
+  });
+
+  test('#2765 - Fragment matching sans query/hash.', 2, function() {
+    Backbone.history.stop();
+    Backbone.history = _.extend(new Backbone.History, {
+      location: location,
+      history: {
+        pushState: function(state, title, url) {
+          strictEqual(url, '/path?query#hash');
+        }
+      }
+    });
+
+    var Router = Backbone.Router.extend({
+      routes: {
+        path: function() { ok(true); }
+      }
+    });
+    var router = new Router;
+
+    location.replace('http://example.com/');
+    Backbone.history.start({pushState: true});
+    Backbone.history.navigate('path?query#hash', true);
+  });
+
+})();
diff --git a/profiles/commons/libraries/backbone/test/sync.js b/profiles/commons/libraries/backbone/test/sync.js
index 8fddb47..d54a796 100644
--- a/profiles/commons/libraries/backbone/test/sync.js
+++ b/profiles/commons/libraries/backbone/test/sync.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   var Library = Backbone.Collection.extend({
     url : function() { return '/library'; }
@@ -11,20 +11,18 @@ $(document).ready(function() {
     length : 123
   };
 
-  module("Backbone.sync", _.extend(new Environment, {
+  module("Backbone.sync", {
 
     setup : function() {
-      Environment.prototype.setup.apply(this, arguments);
       library = new Library;
       library.create(attrs, {wait: false});
     },
 
     teardown: function() {
-      Environment.prototype.teardown.apply(this, arguments);
       Backbone.emulateHTTP = false;
     }
 
-  }));
+  });
 
   test("read", 4, function() {
     library.fetch();
@@ -209,4 +207,4 @@ $(document).ready(function() {
     strictEqual(this.ajaxSettings.beforeSend(xhr), false);
   });
 
-});
+})();
diff --git a/profiles/commons/libraries/backbone/test/vendor/qunit.css b/profiles/commons/libraries/backbone/test/vendor/qunit.css
index d7fc0c8..7ba3f9a 100755
--- a/profiles/commons/libraries/backbone/test/vendor/qunit.css
+++ b/profiles/commons/libraries/backbone/test/vendor/qunit.css
@@ -1,5 +1,5 @@
 /**
- * QUnit v1.11.0 - A JavaScript Unit Testing Framework
+ * QUnit v1.12.0 - A JavaScript Unit Testing Framework
  *
  * http://qunitjs.com
  *
diff --git a/profiles/commons/libraries/backbone/test/vendor/qunit.js b/profiles/commons/libraries/backbone/test/vendor/qunit.js
index 302545f..84c7390 100755
--- a/profiles/commons/libraries/backbone/test/vendor/qunit.js
+++ b/profiles/commons/libraries/backbone/test/vendor/qunit.js
@@ -1,11 +1,11 @@
 /**
- * QUnit v1.11.0 - A JavaScript Unit Testing Framework
+ * QUnit v1.12.0 - A JavaScript Unit Testing Framework
  *
  * http://qunitjs.com
  *
- * Copyright 2012 jQuery Foundation and other contributors
+ * Copyright 2013 jQuery Foundation and other contributors
  * Released under the MIT license.
- * http://jquery.org/license
+ * https://jquery.org/license/
  */
 
 (function( window ) {
@@ -20,6 +20,7 @@ var QUnit,
 	hasOwn = Object.prototype.hasOwnProperty,
 	// Keep a local reference to Date (GH-283)
 	Date = window.Date,
+	setTimeout = window.setTimeout,
 	defined = {
 		setTimeout: typeof window.setTimeout !== "undefined",
 		sessionStorage: (function() {
@@ -115,8 +116,16 @@ Test.prototype = {
 		}
 	},
 	setup: function() {
-		if ( this.module !== config.previousModule ) {
-			if ( config.previousModule ) {
+		if (
+			// Emit moduleStart when we're switching from one module to another
+			this.module !== config.previousModule ||
+				// They could be equal (both undefined) but if the previousModule property doesn't
+				// yet exist it means this is the first test in a suite that isn't wrapped in a
+				// module, in which case we'll just emit a moduleStart event for 'undefined'.
+				// Without this, reporters can get testStart before moduleStart  which is a problem.
+				!hasOwn.call( config, "previousModule" )
+		) {
+			if ( hasOwn.call( config, "previousModule" ) ) {
 				runLoggingCallbacks( "moduleDone", QUnit, {
 					name: config.previousModule,
 					failed: config.moduleStats.bad,
@@ -129,10 +138,6 @@ Test.prototype = {
 			runLoggingCallbacks( "moduleStart", QUnit, {
 				name: this.module
 			});
-		} else if ( config.autorun ) {
-			runLoggingCallbacks( "moduleStart", QUnit, {
-				name: this.module
-			});
 		}
 
 		config.current = this;
@@ -148,19 +153,27 @@ Test.prototype = {
 			module: this.module
 		});
 
-		// allow utility functions to access the current test environment
-		// TODO why??
+		/*jshint camelcase:false */
+
+
+		/**
+		 * Expose the current test environment.
+		 *
+		 * @deprecated since 1.12.0: Use QUnit.config.current.testEnvironment instead.
+		 */
 		QUnit.current_testEnvironment = this.testEnvironment;
 
+		/*jshint camelcase:true */
+
 		if ( !config.pollution ) {
 			saveGlobal();
 		}
 		if ( config.notrycatch ) {
-			this.testEnvironment.setup.call( this.testEnvironment );
+			this.testEnvironment.setup.call( this.testEnvironment, QUnit.assert );
 			return;
 		}
 		try {
-			this.testEnvironment.setup.call( this.testEnvironment );
+			this.testEnvironment.setup.call( this.testEnvironment, QUnit.assert );
 		} catch( e ) {
 			QUnit.pushFailure( "Setup failed on " + this.testName + ": " + ( e.message || e ), extractStacktrace( e, 1 ) );
 		}
@@ -208,11 +221,11 @@ Test.prototype = {
 			if ( typeof this.callbackRuntime === "undefined" ) {
 				this.callbackRuntime = +new Date() - this.callbackStarted;
 			}
-			this.testEnvironment.teardown.call( this.testEnvironment );
+			this.testEnvironment.teardown.call( this.testEnvironment, QUnit.assert );
 			return;
 		} else {
 			try {
-				this.testEnvironment.teardown.call( this.testEnvironment );
+				this.testEnvironment.teardown.call( this.testEnvironment, QUnit.assert );
 			} catch( e ) {
 				QUnit.pushFailure( "Teardown failed on " + this.testName + ": " + ( e.message || e ), extractStacktrace( e, 1 ) );
 			}
@@ -419,7 +432,7 @@ QUnit = {
 		test.queue();
 	},
 
-	// Specify the number of expected assertions to gurantee that failed test (no assertions are run at all) don't slip through.
+	// Specify the number of expected assertions to guarantee that failed test (no assertions are run at all) don't slip through.
 	expect: function( asserts ) {
 		if (arguments.length === 1) {
 			config.current.expected = asserts;
@@ -454,7 +467,7 @@ QUnit = {
 		}
 		// A slight delay, to avoid any current callbacks
 		if ( defined.setTimeout ) {
-			window.setTimeout(function() {
+			setTimeout(function() {
 				if ( config.semaphore > 0 ) {
 					return;
 				}
@@ -477,7 +490,7 @@ QUnit = {
 
 		if ( config.testTimeout && defined.setTimeout ) {
 			clearTimeout( config.timeout );
-			config.timeout = window.setTimeout(function() {
+			config.timeout = setTimeout(function() {
 				QUnit.ok( false, "Test timed out" );
 				config.semaphore = 1;
 				QUnit.start();
@@ -487,7 +500,7 @@ QUnit = {
 };
 
 // `assert` initialized at top of scope
-// Asssert helpers
+// Assert helpers
 // All of these must either call QUnit.push() or manually do:
 // - runLoggingCallbacks( "log", .. );
 // - config.current.assertions.push({ .. });
@@ -505,6 +518,7 @@ assert = {
 			throw new Error( "ok() assertion outside test context, was " + sourceFromStacktrace(2) );
 		}
 		result = !!result;
+		msg = msg || (result ? "okay" : "failed" );
 
 		var source,
 			details = {
@@ -514,8 +528,7 @@ assert = {
 				message: msg
 			};
 
-		msg = escapeText( msg || (result ? "okay" : "failed" ) );
-		msg = "<span class='test-message'>" + msg + "</span>";
+		msg = "<span class='test-message'>" + escapeText( msg ) + "</span>";
 
 		if ( !result ) {
 			source = sourceFromStacktrace( 2 );
@@ -642,13 +655,13 @@ assert = {
 
 			QUnit.push( ok, actual, expectedOutput, message );
 		} else {
-			QUnit.pushFailure( message, null, 'No exception was thrown.' );
+			QUnit.pushFailure( message, null, "No exception was thrown." );
 		}
 	}
 };
 
 /**
- * @deprecate since 1.8.0
+ * @deprecated since 1.8.0
  * Kept assertion helpers in root for backwards compatibility.
  */
 extend( QUnit, assert );
@@ -737,7 +750,7 @@ config = {
 // Export global variables, unless an 'exports' object exists,
 // in that case we assume we're in CommonJS (dealt with on the bottom of the script)
 if ( typeof exports === "undefined" ) {
-	extend( window, QUnit );
+	extend( window, QUnit.constructor.prototype );
 
 	// Expose QUnit object
 	window.QUnit = QUnit;
@@ -836,6 +849,11 @@ extend( QUnit, {
 	},
 
 	// Resets the test setup. Useful for tests that modify the DOM.
+	/*
+	DEPRECATED: Use multiple tests instead of resetting inside a test.
+	Use testStart or testDone for custom cleanup.
+	This method will throw an error in 2.0, and will be removed in 2.1
+	*/
 	reset: function() {
 		var fixture = id( "qunit-fixture" );
 		if ( fixture ) {
@@ -985,11 +1003,10 @@ extend( QUnit, {
 			querystring = "?";
 
 		for ( key in params ) {
-			if ( !hasOwn.call( params, key ) ) {
-				continue;
+			if ( hasOwn.call( params, key ) ) {
+				querystring += encodeURIComponent( key ) + "=" +
+					encodeURIComponent( params[ key ] ) + "&";
 			}
-			querystring += encodeURIComponent( key ) + "=" +
-				encodeURIComponent( params[ key ] ) + "&";
 		}
 		return window.location.protocol + "//" + window.location.host +
 			window.location.pathname + querystring.slice( 0, -1 );
@@ -997,7 +1014,10 @@ extend( QUnit, {
 
 	extend: extend,
 	id: id,
-	addEvent: addEvent
+	addEvent: addEvent,
+	addClass: addClass,
+	hasClass: hasClass,
+	removeClass: removeClass
 	// load, equiv, jsDump, diff: Attached later
 });
 
@@ -1044,6 +1064,7 @@ QUnit.load = function() {
 	var banner, filter, i, label, len, main, ol, toolbar, userAgent, val,
 		urlConfigCheckboxesContainer, urlConfigCheckboxes, moduleFilter,
 		numModules = 0,
+		moduleNames = [],
 		moduleFilterHtml = "",
 		urlConfigHtml = "",
 		oldconfig = extend( {}, config );
@@ -1072,18 +1093,24 @@ QUnit.load = function() {
 			"'><label for='qunit-urlconfig-" + escapeText( val.id ) +
 			"' title='" + escapeText( val.tooltip ) + "'>" + val.label + "</label>";
 	}
-
+	for ( i in config.modules ) {
+		if ( config.modules.hasOwnProperty( i ) ) {
+			moduleNames.push(i);
+		}
+	}
+	numModules = moduleNames.length;
+	moduleNames.sort( function( a, b ) {
+		return a.localeCompare( b );
+	});
 	moduleFilterHtml += "<label for='qunit-modulefilter'>Module: </label><select id='qunit-modulefilter' name='modulefilter'><option value='' " +
 		( config.module === undefined  ? "selected='selected'" : "" ) +
 		">< All Modules ></option>";
 
-	for ( i in config.modules ) {
-		if ( config.modules.hasOwnProperty( i ) ) {
-			numModules += 1;
-			moduleFilterHtml += "<option value='" + escapeText( encodeURIComponent(i) ) + "' " +
-				( config.module === i ? "selected='selected'" : "" ) +
-				">" + escapeText(i) + "</option>";
-		}
+
+	for ( i = 0; i < numModules; i++) {
+			moduleFilterHtml += "<option value='" + escapeText( encodeURIComponent(moduleNames[i]) ) + "' " +
+				( config.module === moduleNames[i] ? "selected='selected'" : "" ) +
+				">" + escapeText(moduleNames[i]) + "</option>";
 	}
 	moduleFilterHtml += "</select>";
 
@@ -1137,7 +1164,7 @@ QUnit.load = function() {
 		// `label` initialized at top of scope
 		label = document.createElement( "label" );
 		label.setAttribute( "for", "qunit-filter-pass" );
-		label.setAttribute( "title", "Only show tests and assertons that fail. Stored in sessionStorage." );
+		label.setAttribute( "title", "Only show tests and assertions that fail. Stored in sessionStorage." );
 		label.innerHTML = "Hide passed tests";
 		toolbar.appendChild( label );
 
@@ -1157,14 +1184,19 @@ QUnit.load = function() {
 		toolbar.appendChild( urlConfigCheckboxesContainer );
 
 		if (numModules > 1) {
-			moduleFilter = document.createElement( 'span' );
-			moduleFilter.setAttribute( 'id', 'qunit-modulefilter-container' );
+			moduleFilter = document.createElement( "span" );
+			moduleFilter.setAttribute( "id", "qunit-modulefilter-container" );
 			moduleFilter.innerHTML = moduleFilterHtml;
 			addEvent( moduleFilter.lastChild, "change", function() {
 				var selectBox = moduleFilter.getElementsByTagName("select")[0],
 					selectedModule = decodeURIComponent(selectBox.options[selectBox.selectedIndex].value);
 
-				window.location = QUnit.url( { module: ( selectedModule === "" ) ? undefined : selectedModule } );
+				window.location = QUnit.url({
+					module: ( selectedModule === "" ) ? undefined : selectedModule,
+					// Remove any existing filters
+					filter: undefined,
+					testNumber: undefined
+				});
 			});
 			toolbar.appendChild(moduleFilter);
 		}
@@ -1188,7 +1220,7 @@ addEvent( window, "load", QUnit.load );
 onErrorFnPrev = window.onerror;
 
 // Cover uncaught exceptions
-// Returning true will surpress the default browser handler,
+// Returning true will suppress the default browser handler,
 // returning false will let it run.
 window.onerror = function ( error, filePath, linerNr ) {
 	var ret = false;
@@ -1197,7 +1229,7 @@ window.onerror = function ( error, filePath, linerNr ) {
 	}
 
 	// Treat return value as window.onerror itself does,
-	// Only do our handling if not surpressed.
+	// Only do our handling if not suppressed.
 	if ( ret !== true ) {
 		if ( QUnit.config.current ) {
 			if ( QUnit.config.current.ignoreGlobalErrors ) {
@@ -1227,6 +1259,7 @@ function done() {
 			total: config.moduleStats.all
 		});
 	}
+	delete config.previousModule;
 
 	var i, key,
 		banner = id( "qunit-banner" ),
@@ -1386,16 +1419,16 @@ function escapeText( s ) {
 	// Both single quotes and double quotes (for attributes)
 	return s.replace( /['"<>&]/g, function( s ) {
 		switch( s ) {
-			case '\'':
-				return '&#039;';
-			case '"':
-				return '&quot;';
-			case '<':
-				return '&lt;';
-			case '>':
-				return '&gt;';
-			case '&':
-				return '&amp;';
+			case "'":
+				return "&#039;";
+			case "\"":
+				return "&quot;";
+			case "<":
+				return "&lt;";
+			case ">":
+				return "&gt;";
+			case "&":
+				return "&amp;";
 		}
 	});
 }
@@ -1419,7 +1452,7 @@ function process( last ) {
 		if ( !defined.setTimeout || config.updateRate <= 0 || ( ( new Date().getTime() - start ) < config.updateRate ) ) {
 			config.queue.shift()();
 		} else {
-			window.setTimeout( next, 13 );
+			setTimeout( next, 13 );
 			break;
 		}
 	}
@@ -1434,11 +1467,13 @@ function saveGlobal() {
 
 	if ( config.noglobals ) {
 		for ( var key in window ) {
-			// in Opera sometimes DOM element ids show up here, ignore them
-			if ( !hasOwn.call( window, key ) || /^qunit-test-output/.test( key ) ) {
-				continue;
+			if ( hasOwn.call( window, key ) ) {
+				// in Opera sometimes DOM element ids show up here, ignore them
+				if ( /^qunit-test-output/.test( key ) ) {
+					continue;
+				}
+				config.pollution.push( key );
 			}
-			config.pollution.push( key );
 		}
 	}
 }
@@ -1480,12 +1515,15 @@ function diff( a, b ) {
 
 function extend( a, b ) {
 	for ( var prop in b ) {
-		if ( b[ prop ] === undefined ) {
-			delete a[ prop ];
-
-		// Avoid "Member not found" error in IE8 caused by setting window.constructor
-		} else if ( prop !== "constructor" || a !== window ) {
-			a[ prop ] = b[ prop ];
+		if ( hasOwn.call( b, prop ) ) {
+			// Avoid "Member not found" error in IE8 caused by messing with window.constructor
+			if ( !( prop === "constructor" && a === window ) ) {
+				if ( b[ prop ] === undefined ) {
+					delete a[ prop ];
+				} else {
+					a[ prop ] = b[ prop ];
+				}
+			}
 		}
 	}
 
@@ -1535,8 +1573,8 @@ function removeClass( elem, name ) {
 	while ( set.indexOf(" " + name + " ") > -1 ) {
 		set = set.replace(" " + name + " " , " ");
 	}
-	// If possible, trim it for prettiness, but not neccecarily
-	elem.className = window.jQuery ? jQuery.trim( set ) : ( set.trim ? set.trim() : set );
+	// If possible, trim it for prettiness, but not necessarily
+	elem.className = typeof set.trim === "function" ? set.trim() : set.replace(/^\s+|\s+$/g, "");
 }
 
 function id( name ) {
@@ -1585,8 +1623,10 @@ QUnit.equiv = (function() {
 		callers = [],
 		// stack to avoiding loops from circular referencing
 		parents = [],
+		parentsB = [],
 
 		getProto = Object.getPrototypeOf || function ( obj ) {
+			/*jshint camelcase:false */
 			return obj.__proto__;
 		},
 		callbacks = (function () {
@@ -1595,7 +1635,7 @@ QUnit.equiv = (function() {
 			function useStrictEquality( b, a ) {
 				/*jshint eqeqeq:false */
 				if ( b instanceof a.constructor || a instanceof b.constructor ) {
-					// to catch short annotaion VS 'new' annotation of a
+					// to catch short annotation VS 'new' annotation of a
 					// declaration
 					// e.g. var i = 1;
 					// var j = new Number(1);
@@ -1624,7 +1664,7 @@ QUnit.equiv = (function() {
 					return QUnit.objectType( b ) === "regexp" &&
 						// the regex itself
 						a.source === b.source &&
-						// and its modifers
+						// and its modifiers
 						a.global === b.global &&
 						// (gmi) ...
 						a.ignoreCase === b.ignoreCase &&
@@ -1641,7 +1681,7 @@ QUnit.equiv = (function() {
 				},
 
 				"array": function( b, a ) {
-					var i, j, len, loop;
+					var i, j, len, loop, aCircular, bCircular;
 
 					// b could be an object literal here
 					if ( QUnit.objectType( b ) !== "array" ) {
@@ -1656,24 +1696,36 @@ QUnit.equiv = (function() {
 
 					// track reference to avoid circular references
 					parents.push( a );
+					parentsB.push( b );
 					for ( i = 0; i < len; i++ ) {
 						loop = false;
 						for ( j = 0; j < parents.length; j++ ) {
-							if ( parents[j] === a[i] ) {
-								loop = true;// dont rewalk array
+							aCircular = parents[j] === a[i];
+							bCircular = parentsB[j] === b[i];
+							if ( aCircular || bCircular ) {
+								if ( a[i] === b[i] || aCircular && bCircular ) {
+									loop = true;
+								} else {
+									parents.pop();
+									parentsB.pop();
+									return false;
+								}
 							}
 						}
 						if ( !loop && !innerEquiv(a[i], b[i]) ) {
 							parents.pop();
+							parentsB.pop();
 							return false;
 						}
 					}
 					parents.pop();
+					parentsB.pop();
 					return true;
 				},
 
 				"object": function( b, a ) {
-					var i, j, loop,
+					/*jshint forin:false */
+					var i, j, loop, aCircular, bCircular,
 						// Default to true
 						eq = true,
 						aProperties = [],
@@ -1692,28 +1744,36 @@ QUnit.equiv = (function() {
 
 					// stack constructor before traversing properties
 					callers.push( a.constructor );
+
 					// track reference to avoid circular references
 					parents.push( a );
+					parentsB.push( b );
 
-					for ( i in a ) { // be strict: don't ensures hasOwnProperty
-									// and go deep
+					// be strict: don't ensure hasOwnProperty and go deep
+					for ( i in a ) {
 						loop = false;
 						for ( j = 0; j < parents.length; j++ ) {
-							if ( parents[j] === a[i] ) {
-								// don't go down the same path twice
-								loop = true;
+							aCircular = parents[j] === a[i];
+							bCircular = parentsB[j] === b[i];
+							if ( aCircular || bCircular ) {
+								if ( a[i] === b[i] || aCircular && bCircular ) {
+									loop = true;
+								} else {
+									eq = false;
+									break;
+								}
 							}
 						}
-						aProperties.push(i); // collect a's properties
-
-						if (!loop && !innerEquiv( a[i], b[i] ) ) {
+						aProperties.push(i);
+						if ( !loop && !innerEquiv(a[i], b[i]) ) {
 							eq = false;
 							break;
 						}
 					}
 
-					callers.pop(); // unstack, we are done
 					parents.pop();
+					parentsB.pop();
+					callers.pop(); // unstack, we are done
 
 					for ( i in b ) {
 						bProperties.push( i ); // collect b's properties
@@ -1743,7 +1803,7 @@ QUnit.equiv = (function() {
 			}
 
 			// apply transition with (1..n) arguments
-		}( args[0], args[1] ) && arguments.callee.apply( this, args.splice(1, args.length - 1 )) );
+		}( args[0], args[1] ) && innerEquiv.apply( this, args.splice(1, args.length - 1 )) );
 	};
 
 	return innerEquiv;
@@ -1761,7 +1821,7 @@ QUnit.equiv = (function() {
  */
 QUnit.jsDump = (function() {
 	function quote( str ) {
-		return '"' + str.toString().replace( /"/g, '\\"' ) + '"';
+		return "\"" + str.toString().replace( /"/g, "\\\"" ) + "\"";
 	}
 	function literal( o ) {
 		return o + "";
@@ -1854,13 +1914,13 @@ QUnit.jsDump = (function() {
 				if ( this.HTML ) {
 					chr = chr.replace( /\t/g, "   " ).replace( / /g, "&nbsp;" );
 				}
-				return new Array( this._depth_ + (extra||0) ).join(chr);
+				return new Array( this.depth + ( extra || 0 ) ).join(chr);
 			},
 			up: function( a ) {
-				this._depth_ += a || 1;
+				this.depth += a || 1;
 			},
 			down: function( a ) {
-				this._depth_ -= a || 1;
+				this.depth -= a || 1;
 			},
 			setParser: function( name, parser ) {
 				this.parsers[name] = parser;
@@ -1870,7 +1930,7 @@ QUnit.jsDump = (function() {
 			literal: literal,
 			join: join,
 			//
-			_depth_: 1,
+			depth: 1,
 			// This is the list of parsers, to modify them, use jsDump.setParser
 			parsers: {
 				window: "[Window]",
@@ -1898,6 +1958,7 @@ QUnit.jsDump = (function() {
 				nodelist: array,
 				"arguments": array,
 				object: function( map, stack ) {
+					/*jshint forin:false */
 					var ret = [ ], keys, key, val, i;
 					QUnit.jsDump.up();
 					keys = [];
@@ -2036,18 +2097,17 @@ QUnit.diff = (function() {
 		}
 
 		for ( i in ns ) {
-			if ( !hasOwn.call( ns, i ) ) {
-				continue;
-			}
-			if ( ns[i].rows.length === 1 && hasOwn.call( os, i ) && os[i].rows.length === 1 ) {
-				n[ ns[i].rows[0] ] = {
-					text: n[ ns[i].rows[0] ],
-					row: os[i].rows[0]
-				};
-				o[ os[i].rows[0] ] = {
-					text: o[ os[i].rows[0] ],
-					row: ns[i].rows[0]
-				};
+			if ( hasOwn.call( ns, i ) ) {
+				if ( ns[i].rows.length === 1 && hasOwn.call( os, i ) && os[i].rows.length === 1 ) {
+					n[ ns[i].rows[0] ] = {
+						text: n[ ns[i].rows[0] ],
+						row: os[i].rows[0]
+					};
+					o[ os[i].rows[0] ] = {
+						text: o[ os[i].rows[0] ],
+						row: ns[i].rows[0]
+					};
+				}
 			}
 		}
 
@@ -2143,9 +2203,9 @@ QUnit.diff = (function() {
 	};
 }());
 
-// for CommonJS enviroments, export everything
+// for CommonJS environments, export everything
 if ( typeof exports !== "undefined" ) {
-	extend( exports, QUnit );
+	extend( exports, QUnit.constructor.prototype );
 }
 
 // get at whatever the global object is, like window in browsers
diff --git a/profiles/commons/libraries/backbone/test/view.js b/profiles/commons/libraries/backbone/test/view.js
index 58a8771..65eee25 100644
--- a/profiles/commons/libraries/backbone/test/view.js
+++ b/profiles/commons/libraries/backbone/test/view.js
@@ -1,4 +1,4 @@
-$(document).ready(function() {
+(function() {
 
   var view;
 
@@ -14,13 +14,10 @@ $(document).ready(function() {
 
   });
 
-  test("constructor", 6, function() {
+  test("constructor", 3, function() {
     equal(view.el.id, 'test-view');
     equal(view.el.className, 'test-view');
     equal(view.el.other, void 0);
-    equal(view.options.id, 'test-view');
-    equal(view.options.className, 'test-view');
-    equal(view.options.other, 'non-special-option');
   });
 
   test("jQuery", 1, function() {
@@ -156,30 +153,6 @@ $(document).ready(function() {
     strictEqual(new View().el.id, 'id');
   });
 
-  test("with options function", 3, function() {
-    var View1 = Backbone.View.extend({
-      options: function() {
-        return {
-          title: 'title1',
-          acceptText: 'confirm'
-        };
-      }
-    });
-
-    var View2 = View1.extend({
-      options: function() {
-        return _.extend(View1.prototype.options.call(this), {
-          title: 'title2',
-          fixed: true
-        });
-      }
-    });
-
-    strictEqual(new View2().options.title, 'title2');
-    strictEqual(new View2().options.acceptText, 'confirm');
-    strictEqual(new View2().options.fixed, true);
-  });
-
   test("with attributes", 2, function() {
     var View = Backbone.View.extend({
       attributes: {
@@ -319,7 +292,7 @@ $(document).ready(function() {
     view.collection.trigger('x');
   });
 
-  test("Provide function for el.", 1, function() {
+  test("Provide function for el.", 2, function() {
     var View = Backbone.View.extend({
       el: function() {
         return "<p><a></a></p>";
@@ -327,7 +300,8 @@ $(document).ready(function() {
     });
 
     var view = new View;
-    ok(view.$el.is('p:has(a)'));
+    ok(view.$el.is('p'));
+    ok(view.$el.has('a'));
   });
 
   test("events passed in options", 2, function() {
@@ -354,4 +328,4 @@ $(document).ready(function() {
     equal(counter, 4);
   });
 
-});
+})();
diff --git a/profiles/commons/libraries/modernizr/.editorconfig b/profiles/commons/libraries/modernizr/.editorconfig
new file mode 100644
index 0000000..0f09989
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/.editorconfig
@@ -0,0 +1,10 @@
+# editorconfig.org
+root = true
+
+[*]
+indent_style = space
+indent_size = 2
+end_of_line = lf
+charset = utf-8
+trim_trailing_whitespace = true
+insert_final_newline = true
diff --git a/profiles/commons/libraries/modernizr/.gitignore b/profiles/commons/libraries/modernizr/.gitignore
new file mode 100644
index 0000000..9c4d3b4
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/.gitignore
@@ -0,0 +1,2 @@
+modernizr.min.js
+.DS_Store
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/.travis.yml b/profiles/commons/libraries/modernizr/.travis.yml
new file mode 100644
index 0000000..1a0d9c0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/.travis.yml
@@ -0,0 +1,6 @@
+language: node_js
+node_js:
+  - 0.8
+before_script:
+  - npm install grunt
+script: grunt travis --verbose
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/a-download.js b/profiles/commons/libraries/modernizr/feature-detects/a-download.js
new file mode 100644
index 0000000..559fadd
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/a-download.js
@@ -0,0 +1,8 @@
+
+// a[download] attribute
+// When used on an <a>, this attribute signifies that the resource it
+// points to should be downloaded by the browser rather than navigating to it.
+// http://developers.whatwg.org/links.html#downloading-resources
+// By Addy Osmani
+
+Modernizr.addTest('adownload', 'download' in document.createElement('a'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/audio-audiodata-api.js b/profiles/commons/libraries/modernizr/feature-detects/audio-audiodata-api.js
new file mode 100644
index 0000000..bfcd9fe
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/audio-audiodata-api.js
@@ -0,0 +1,4 @@
+// Mozilla Audio Data API
+// https://wiki.mozilla.org/Audio_Data_API
+// by Addy Osmani
+Modernizr.addTest('audiodata', !!(window.Audio));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/audio-webaudio-api.js b/profiles/commons/libraries/modernizr/feature-detects/audio-webaudio-api.js
new file mode 100644
index 0000000..46d3c63
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/audio-webaudio-api.js
@@ -0,0 +1,4 @@
+// Web Audio API
+// https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html
+// By Addy Osmani
+Modernizr.addTest('webaudio', !!(window.webkitAudioContext || window.AudioContext));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/battery-api.js b/profiles/commons/libraries/modernizr/feature-detects/battery-api.js
new file mode 100644
index 0000000..4177e8f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/battery-api.js
@@ -0,0 +1,8 @@
+
+// Battery API
+// https://developer.mozilla.org/en/DOM/window.navigator.mozBattery
+// By: Paul Sayre
+
+Modernizr.addTest('battery',
+	!!Modernizr.prefixed('battery', navigator)
+);
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/battery-level.js b/profiles/commons/libraries/modernizr/feature-detects/battery-level.js
new file mode 100644
index 0000000..07f9575
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/battery-level.js
@@ -0,0 +1,11 @@
+
+// Low Battery Level
+// Enable a developer to remove CPU intensive CSS/JS when battery is low
+// developer.mozilla.org/en/DOM/window.navigator.mozBattery
+// By: Paul Sayre
+
+Modernizr.addTest('lowbattery', function () {
+	var minLevel = 0.20,
+		battery = Modernizr.prefixed('battery', navigator);
+	return !!(battery && !battery.charging && battery.level <= minLevel);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/blob-constructor.js b/profiles/commons/libraries/modernizr/feature-detects/blob-constructor.js
new file mode 100644
index 0000000..f10bd7b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/blob-constructor.js
@@ -0,0 +1,10 @@
+// Blob constructor
+// http://dev.w3.org/2006/webapi/FileAPI/#constructorBlob
+
+Modernizr.addTest('blobconstructor', function () {
+    try {
+        return !!new Blob();
+    } catch (e) {
+        return false;
+    }
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/canvas-todataurl-type.js b/profiles/commons/libraries/modernizr/feature-detects/canvas-todataurl-type.js
new file mode 100644
index 0000000..bf8f2e3
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/canvas-todataurl-type.js
@@ -0,0 +1,28 @@
+// canvas.toDataURL type support
+// http://www.w3.org/TR/html5/the-canvas-element.html#dom-canvas-todataurl
+
+// This test is asynchronous. Watch out.
+
+(function () {
+
+    if (!Modernizr.canvas) {
+        return false;
+    }
+
+    var image = new Image(),
+        canvas = document.createElement('canvas'),
+        ctx = canvas.getContext('2d');
+
+    image.onload = function() {
+        ctx.drawImage(image, 0, 0);
+
+        Modernizr.addTest('todataurljpeg', function() {
+            return canvas.toDataURL('image/jpeg').indexOf('data:image/jpeg') === 0;
+        });
+        Modernizr.addTest('todataurlwebp', function() {
+            return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
+        });
+    };
+
+    image.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==';
+}());
diff --git a/profiles/commons/libraries/modernizr/feature-detects/contenteditable.js b/profiles/commons/libraries/modernizr/feature-detects/contenteditable.js
new file mode 100644
index 0000000..6543666
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/contenteditable.js
@@ -0,0 +1,9 @@
+// contentEditable
+// http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#contenteditable
+
+// this is known to false positive in some mobile browsers
+// here is a whitelist of verified working browsers:
+// https://github.com/NielsLeenheer/html5test/blob/549f6eac866aa861d9649a0707ff2c0157895706/scripts/engine.js#L2083
+
+Modernizr.addTest('contenteditable',
+        'contentEditable' in document.documentElement);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js b/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js
new file mode 100644
index 0000000..ee1ddb8
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js
@@ -0,0 +1,10 @@
+// Test for (experimental) Content Security Policy 1.1 support.
+//
+// This feature is still quite experimental, but is available now in Chrome 22.
+// If the `SecurityPolicy` property is available, you can be sure the browser
+// supports CSP. If it's not available, the browser still might support an
+// earlier version of the CSP spec.
+//
+// Editor's Draft: https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html
+
+Modernizr.addTest('contentsecuritypolicy', 'SecurityPolicy' in document);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/contextmenu.js b/profiles/commons/libraries/modernizr/feature-detects/contextmenu.js
new file mode 100644
index 0000000..dd8182f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/contextmenu.js
@@ -0,0 +1,11 @@
+// http://www.w3.org/TR/html5/interactive-elements.html#context-menus
+// Demo at http://thewebrocks.com/demos/context-menu/
+Modernizr.addTest(
+  'contextmenu', 
+  ('contextMenu' in document.documentElement && 'HTMLMenuItemElement' in window) 
+);
+
+
+
+
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/cookies.js b/profiles/commons/libraries/modernizr/feature-detects/cookies.js
new file mode 100644
index 0000000..6a2f9d4
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/cookies.js
@@ -0,0 +1,15 @@
+
+// by tauren
+// https://github.com/Modernizr/Modernizr/issues/191
+
+Modernizr.addTest('cookies', function () {
+  // Quick test if browser has cookieEnabled host property
+  if (navigator.cookieEnabled) return true;
+  // Create cookie
+  document.cookie = "cookietest=1";
+  var ret = document.cookie.indexOf("cookietest=") != -1;
+  // Delete cookie
+  document.cookie = "cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT";
+  return ret;
+});
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/cors.js b/profiles/commons/libraries/modernizr/feature-detects/cors.js
new file mode 100644
index 0000000..286d717
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/cors.js
@@ -0,0 +1,3 @@
+// cors
+// By Theodoor van Donge
+Modernizr.addTest('cors', !!(window.XMLHttpRequest && 'withCredentials' in new XMLHttpRequest()));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-shorthand.js b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-shorthand.js
new file mode 100644
index 0000000..ce016e1
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-shorthand.js
@@ -0,0 +1,19 @@
+/*
+    https://developer.mozilla.org/en/CSS/background-position
+    http://www.w3.org/TR/css3-background/#background-position
+
+    Example: http://jsfiddle.net/Blink/bBXvt/
+*/
+
+(function() {
+
+    var elem = document.createElement('a'),
+        eStyle = elem.style,
+        val = "right 10px bottom 10px";
+
+    Modernizr.addTest('bgpositionshorthand', function(){
+        eStyle.cssText = "background-position: " + val + ";";
+        return (eStyle.backgroundPosition === val);
+    });
+
+}());
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-xy.js b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-xy.js
new file mode 100644
index 0000000..d52d600
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundposition-xy.js
@@ -0,0 +1,15 @@
+/*
+	Allan Lei https://github.com/allanlei
+	
+	Check adapted from https://github.com/brandonaaron/jquery-cssHooks/blob/master/bgpos.js
+	
+	Test: http://jsfiddle.net/allanlei/R8AYS/
+*/
+Modernizr.addTest('bgpositionxy', function() {
+    return Modernizr.testStyles('#modernizr {background-position: 3px 5px;}', function(elem) {
+        var cssStyleDeclaration = window.getComputedStyle ? getComputedStyle(elem, null) : elem.currentStyle;
+        var xSupport = (cssStyleDeclaration.backgroundPositionX == '3px') || (cssStyleDeclaration['background-position-x'] == '3px');
+        var ySupport = (cssStyleDeclaration.backgroundPositionY == '5px') || (cssStyleDeclaration['background-position-y'] == '5px');
+        return xSupport && ySupport;
+    });
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-backgroundrepeat.js b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundrepeat.js
new file mode 100644
index 0000000..365447c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundrepeat.js
@@ -0,0 +1,31 @@
+// developer.mozilla.org/en/CSS/background-repeat
+
+// test page: jsbin.com/uzesun/
+// http://jsfiddle.net/ryanseddon/yMLTQ/6/    
+
+(function(){
+
+
+function getBgRepeatValue(elem){
+    return (window.getComputedStyle ?
+             getComputedStyle(elem, null).getPropertyValue('background') :
+             elem.currentStyle['background']);
+}
+  
+
+Modernizr.testStyles(' #modernizr { background-repeat: round; } ', function(elem, rule){ 
+
+  Modernizr.addTest('bgrepeatround', getBgRepeatValue(elem) == 'round');
+
+});
+
+
+
+Modernizr.testStyles(' #modernizr { background-repeat: space; } ', function(elem, rule){ 
+
+  Modernizr.addTest('bgrepeatspace', getBgRepeatValue(elem) == 'space');
+
+});
+
+
+})();
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-backgroundsizecover.js b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundsizecover.js
new file mode 100644
index 0000000..dd7e51b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-backgroundsizecover.js
@@ -0,0 +1,10 @@
+
+// developer.mozilla.org/en/CSS/background-size
+
+Modernizr.testStyles( '#modernizr{background-size:cover}', function( elem ) {
+	var style = window.getComputedStyle ?
+		window.getComputedStyle( elem, null )
+		: elem.currentStyle;
+		
+	Modernizr.addTest( 'bgsizecover', style.backgroundSize == 'cover' );
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-boxsizing.js b/profiles/commons/libraries/modernizr/feature-detects/css-boxsizing.js
new file mode 100644
index 0000000..ab90913
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-boxsizing.js
@@ -0,0 +1,9 @@
+
+// developer.mozilla.org/en/CSS/box-sizing
+// github.com/Modernizr/Modernizr/issues/248
+
+Modernizr.addTest("boxsizing",function(){
+    return Modernizr.testAllProps("boxSizing") && (document.documentMode === undefined || document.documentMode > 7);
+});
+
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-calc.js b/profiles/commons/libraries/modernizr/feature-detects/css-calc.js
new file mode 100644
index 0000000..bb5b7e9
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-calc.js
@@ -0,0 +1,12 @@
+// Method of allowing calculated values for length units, i.e. width: calc(100%-3em) http://caniuse.com/#search=calc
+// By @calvein
+
+Modernizr.addTest('csscalc', function() {
+    var prop = 'width:';
+    var value = 'calc(10px);';
+    var el = document.createElement('div');
+
+    el.style.cssText = prop + Modernizr._prefixes.join(value + prop);
+
+    return !!el.style.length;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-cubicbezierrange.js b/profiles/commons/libraries/modernizr/feature-detects/css-cubicbezierrange.js
new file mode 100644
index 0000000..28e72aa
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-cubicbezierrange.js
@@ -0,0 +1,8 @@
+// cubic-bezier values can't be > 1 for Webkit until bug #45761 (https://bugs.webkit.org/show_bug.cgi?id=45761) is fixed
+// By @calvein
+
+Modernizr.addTest('cubicbezierrange', function() {
+    var el = document.createElement('div');
+    el.style.cssText = Modernizr._prefixes.join('transition-timing-function' + ':cubic-bezier(1,0,0,1.1); ');
+    return !!el.style.length;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-displayrunin.js b/profiles/commons/libraries/modernizr/feature-detects/css-displayrunin.js
new file mode 100644
index 0000000..01eddb7
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-displayrunin.js
@@ -0,0 +1,18 @@
+
+// by alanhogan
+
+// https://github.com/Modernizr/Modernizr/issues/198
+// http://css-tricks.com/596-run-in/
+
+
+
+Modernizr.testStyles(' #modernizr { display: run-in; } ', function(elem, rule){ 
+
+  var ret = (window.getComputedStyle ?
+         getComputedStyle(elem, null).getPropertyValue('display') :
+         elem.currentStyle['display']);
+
+  Modernizr.addTest('display-runin', ret == 'run-in');
+
+});
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-displaytable.js b/profiles/commons/libraries/modernizr/feature-detects/css-displaytable.js
new file mode 100644
index 0000000..bc0a67c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-displaytable.js
@@ -0,0 +1,27 @@
+// display: table and table-cell test. (both are tested under one name "table-cell" )
+// By @scottjehl
+
+// all additional table display values are here: http://pastebin.com/Gk9PeVaQ though Scott has seen some IE false positives with that sort of weak detection.
+// more testing neccessary perhaps.
+
+Modernizr.addTest( "display-table",function(){
+  
+  var doc   = window.document,
+      docElem = doc.documentElement,   
+      parent  = doc.createElement( "div" ),
+      child = doc.createElement( "div" ),
+      childb  = doc.createElement( "div" ),
+      ret;
+  
+  parent.style.cssText = "display: table";
+  child.style.cssText = childb.style.cssText = "display: table-cell; padding: 10px";    
+          
+  parent.appendChild( child );
+  parent.appendChild( childb );
+  docElem.insertBefore( parent, docElem.firstChild );
+  
+  ret = child.offsetLeft < childb.offsetLeft;
+  docElem.removeChild(parent);
+  return ret; 
+});
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-filters.js b/profiles/commons/libraries/modernizr/feature-detects/css-filters.js
new file mode 100644
index 0000000..aec4fad
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-filters.js
@@ -0,0 +1,7 @@
+// https://github.com/Modernizr/Modernizr/issues/615
+// documentMode is needed for false positives in oldIE, please see issue above
+Modernizr.addTest('cssfilters', function() {
+    var el = document.createElement('div');
+    el.style.cssText = Modernizr._prefixes.join('filter' + ':blur(2px); ');
+    return !!el.style.length && ((document.documentMode === undefined || document.documentMode > 9));
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-hyphens.js b/profiles/commons/libraries/modernizr/feature-detects/css-hyphens.js
new file mode 100644
index 0000000..8215dd5
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-hyphens.js
@@ -0,0 +1,205 @@
+/* see http://davidnewton.ca/the-current-state-of-hyphenation-on-the-web
+   http://davidnewton.ca/demos/hyphenation/test.html
+
+
+There are three tests:
+   1. csshyphens      - tests hyphens:auto actually adds hyphens to text
+   2. softhyphens     - tests that &shy; does its job
+   3. softhyphensfind - tests that in-browser Find functionality still works correctly with &shy;
+
+These tests currently require document.body to be present
+
+Hyphenation is language specific, sometimes.
+  See for more details: http://code.google.com/p/hyphenator/source/diff?spec=svn975&r=975&format=side&path=/trunk/Hyphenator.js#sc_svn975_313
+
+If loading Hyphenator.js via Modernizr.load, be cautious of issue 158: http://code.google.com/p/hyphenator/issues/detail?id=158
+
+More details at https://github.com/Modernizr/Modernizr/issues/312
+
+*/
+
+(function() {
+
+	if (!document.body){
+		window.console && console.warn('document.body doesn\'t exist. Modernizr hyphens test needs it.');
+		return;
+	}
+
+	// functional test of adding hyphens:auto
+	function test_hyphens_css() {
+		try {
+			/* create a div container and a span within that
+			 * these have to be appended to document.body, otherwise some browsers can give false negative */
+			var div = document.createElement('div'),
+				span = document.createElement('span'),
+				divStyle = div.style,
+				spanHeight = 0,
+				spanWidth = 0,
+				result = false,
+				firstChild = document.body.firstElementChild || document.body.firstChild;
+
+			div.appendChild(span);
+			span.innerHTML = 'Bacon ipsum dolor sit amet jerky velit in culpa hamburger et. Laborum dolor proident, enim dolore duis commodo et strip steak. Salami anim et, veniam consectetur dolore qui tenderloin jowl velit sirloin. Et ad culpa, fatback cillum jowl ball tip ham hock nulla short ribs pariatur aute. Pig pancetta ham bresaola, ut boudin nostrud commodo flank esse cow tongue culpa. Pork belly bresaola enim pig, ea consectetur nisi. Fugiat officia turkey, ea cow jowl pariatur ullamco proident do laborum velit sausage. Magna biltong sint tri-tip commodo sed bacon, esse proident aliquip. Ullamco ham sint fugiat, velit in enim sed mollit nulla cow ut adipisicing nostrud consectetur. Proident dolore beef ribs, laborum nostrud meatball ea laboris rump cupidatat labore culpa. Shankle minim beef, velit sint cupidatat fugiat tenderloin pig et ball tip. Ut cow fatback salami, bacon ball tip et in shank strip steak bresaola. In ut pork belly sed mollit tri-tip magna culpa veniam, short ribs qui in andouille ham consequat. Dolore bacon t-bone, velit short ribs enim strip steak nulla. Voluptate labore ut, biltong swine irure jerky. Cupidatat excepteur aliquip salami dolore. Ball tip strip steak in pork dolor. Ad in esse biltong. Dolore tenderloin exercitation ad pork loin t-bone, dolore in chicken ball tip qui pig. Ut culpa tongue, sint ribeye dolore ex shank voluptate hamburger. Jowl et tempor, boudin pork chop labore ham hock drumstick consectetur tri-tip elit swine meatball chicken ground round. Proident shankle mollit dolore. Shoulder ut duis t-bone quis reprehenderit. Meatloaf dolore minim strip steak, laboris ea aute bacon beef ribs elit shank in veniam drumstick qui. Ex laboris meatball cow tongue pork belly. Ea ball tip reprehenderit pig, sed fatback boudin dolore flank aliquip laboris eu quis. Beef ribs duis beef, cow corned beef adipisicing commodo nisi deserunt exercitation. Cillum dolor t-bone spare ribs, ham hock est sirloin. Brisket irure meatloaf in, boudin pork belly sirloin ball tip. Sirloin sint irure nisi nostrud aliqua. Nostrud nulla aute, enim officia culpa ham hock. Aliqua reprehenderit dolore sunt nostrud sausage, ea boudin pork loin ut t-bone ham tempor. Tri-tip et pancetta drumstick laborum. Ham hock magna do nostrud in proident. Ex ground round fatback, venison non ribeye in.';
+
+			document.body.insertBefore(div, firstChild);
+
+			/* get size of unhyphenated text */
+			divStyle.cssText = 'position:absolute;top:0;left:0;width:5em;text-align:justify;text-justification:newspaper;';
+			spanHeight = span.offsetHeight;
+			spanWidth = span.offsetWidth;
+
+			/* compare size with hyphenated text */
+			divStyle.cssText = 'position:absolute;top:0;left:0;width:5em;text-align:justify;'+
+												 'text-justification:newspaper;'+
+												 Modernizr._prefixes.join('hyphens:auto; ');
+
+			result = (span.offsetHeight != spanHeight || span.offsetWidth != spanWidth);
+
+			/* results and cleanup */
+			document.body.removeChild(div);
+			div.removeChild(span);
+
+			return result;
+		} catch(e) {
+			return false;
+		}
+	}
+
+	// for the softhyphens test
+	function test_hyphens(delimiter, testWidth) {
+		try {
+			/* create a div container and a span within that
+			 * these have to be appended to document.body, otherwise some browsers can give false negative */
+			var div = document.createElement('div'),
+				span = document.createElement('span'),
+				divStyle = div.style,
+				spanSize = 0,
+				result = false,
+				result1 = false,
+				result2 = false,
+				firstChild = document.body.firstElementChild || document.body.firstChild;
+
+			divStyle.cssText = 'position:absolute;top:0;left:0;overflow:visible;width:1.25em;';
+			div.appendChild(span);
+			document.body.insertBefore(div, firstChild);
+
+
+			/* get height of unwrapped text */
+			span.innerHTML = 'mm';
+			spanSize = span.offsetHeight;
+
+			/* compare height w/ delimiter, to see if it wraps to new line */
+			span.innerHTML = 'm' + delimiter + 'm';
+			result1 = (span.offsetHeight > spanSize);
+
+			/* if we're testing the width too (i.e. for soft-hyphen, not zws),
+			 * this is because tested Blackberry devices will wrap the text but not display the hyphen */
+			if (testWidth) {
+				/* get width of wrapped, non-hyphenated text */
+				span.innerHTML = 'm<br />m';
+				spanSize = span.offsetWidth;
+
+				/* compare width w/ wrapped w/ delimiter to see if hyphen is present */
+				span.innerHTML = 'm' + delimiter + 'm';
+				result2 = (span.offsetWidth > spanSize);
+			} else {
+				result2 = true;
+			}
+
+			/* results and cleanup */
+			if (result1 === true && result2 === true) { result = true; }
+			document.body.removeChild(div);
+			div.removeChild(span);
+
+			return result;
+		} catch(e) {
+			return false;
+		}
+	}
+
+	// testing if in-browser Find functionality will work on hyphenated text
+	function test_hyphens_find(delimiter) {
+		try {
+			/* create a dummy input for resetting selection location, and a div container
+			 * these have to be appended to document.body, otherwise some browsers can give false negative
+			 * div container gets the doubled testword, separated by the delimiter
+			 * Note: giving a width to div gives false positive in iOS Safari */
+			var dummy = document.createElement('input'),
+				div = document.createElement('div'),
+				testword = 'lebowski',
+				result = false,
+				textrange,
+				firstChild = document.body.firstElementChild || document.body.firstChild;
+
+			div.innerHTML = testword + delimiter + testword;
+
+			document.body.insertBefore(div, firstChild);
+			document.body.insertBefore(dummy, div);
+
+
+			/* reset the selection to the dummy input element, i.e. BEFORE the div container
+			 *   stackoverflow.com/questions/499126/jquery-set-cursor-position-in-text-area */
+			if (dummy.setSelectionRange) {
+				dummy.focus();
+				dummy.setSelectionRange(0,0);
+			} else if (dummy.createTextRange) {
+				textrange = dummy.createTextRange();
+				textrange.collapse(true);
+				textrange.moveEnd('character', 0);
+				textrange.moveStart('character', 0);
+				textrange.select();
+			}
+
+			/* try to find the doubled testword, without the delimiter */
+			if (window.find) {
+				result = window.find(testword + testword);
+			} else {
+				try {
+					textrange = window.self.document.body.createTextRange();
+					result = textrange.findText(testword + testword);
+				} catch(e) {
+					result = false;
+				}
+			}
+
+			document.body.removeChild(div);
+			document.body.removeChild(dummy);
+
+			return result;
+		} catch(e) {
+			return false;
+		}
+	}
+
+	Modernizr.addTest("csshyphens", function() {
+
+		if (!Modernizr.testAllProps('hyphens')) return false;
+
+		/* Chrome lies about its hyphens support so we need a more robust test
+				crbug.com/107111
+		*/
+		try {
+			return test_hyphens_css();
+		} catch(e) {
+			return false;
+		}
+	});
+
+	Modernizr.addTest("softhyphens", function() {
+		try {
+			// use numeric entity instead of &shy; in case it's XHTML
+			return test_hyphens('&#173;', true) && test_hyphens('&#8203;', false);
+		} catch(e) {
+			return false;
+		}
+	});
+
+	Modernizr.addTest("softhyphensfind", function() {
+		try {
+			return test_hyphens_find('&#173;') && test_hyphens_find('&#8203;');
+		} catch(e) {
+			return false;
+		}
+	});
+
+})();
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-lastchild.js b/profiles/commons/libraries/modernizr/feature-detects/css-lastchild.js
new file mode 100644
index 0000000..3e51516
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-lastchild.js
@@ -0,0 +1,11 @@
+// last-child pseudo selector
+// https://github.com/Modernizr/Modernizr/pull/304
+
+
+Modernizr.addTest('lastchild', function(){
+
+  return Modernizr.testStyles("#modernizr div {width:100px} #modernizr :last-child{width:200px;display:block}", function (elem) {
+    return elem.lastChild.offsetWidth > elem.firstChild.offsetWidth;
+  }, 2);
+
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-mask.js b/profiles/commons/libraries/modernizr/feature-detects/css-mask.js
new file mode 100644
index 0000000..2f6f28a
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-mask.js
@@ -0,0 +1,12 @@
+// this tests passes for webkit's proprietary `-webkit-mask` feature
+//   www.webkit.org/blog/181/css-masks/
+//   developer.apple.com/library/safari/#documentation/InternetWeb/Conceptual/SafariVisualEffectsProgGuide/Masks/Masks.html
+
+// it does not pass mozilla's implementation of `mask` for SVG
+
+//   developer.mozilla.org/en/CSS/mask
+//   developer.mozilla.org/En/Applying_SVG_effects_to_HTML_content
+
+// Can combine with clippaths for awesomeness: http://generic.cx/for/webkit/test.html
+
+Modernizr.addTest('cssmask', Modernizr.testAllProps('maskRepeat'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-mediaqueries.js b/profiles/commons/libraries/modernizr/feature-detects/css-mediaqueries.js
new file mode 100644
index 0000000..e0e2c50
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-mediaqueries.js
@@ -0,0 +1,3 @@
+
+
+Modernizr.addTest('mediaqueries', Modernizr.mq('only all'));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-objectfit.js b/profiles/commons/libraries/modernizr/feature-detects/css-objectfit.js
new file mode 100644
index 0000000..3daecde
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-objectfit.js
@@ -0,0 +1,6 @@
+
+// dev.opera.com/articles/view/css3-object-fit-object-position/
+
+Modernizr.addTest('object-fit',
+	!!Modernizr.prefixed('objectFit')
+);
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-overflow-scrolling.js b/profiles/commons/libraries/modernizr/feature-detects/css-overflow-scrolling.js
new file mode 100644
index 0000000..364e71d
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-overflow-scrolling.js
@@ -0,0 +1,9 @@
+
+// johanbrook.com/browsers/native-momentum-scrolling-ios-5/
+// introduced in iOS5b2. Possible API may change...
+
+Modernizr.addTest("overflowscrolling",function(){
+    return Modernizr.testAllProps("overflowScrolling");
+});
+
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-pointerevents.js b/profiles/commons/libraries/modernizr/feature-detects/css-pointerevents.js
new file mode 100644
index 0000000..f18a5c1
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-pointerevents.js
@@ -0,0 +1,25 @@
+
+// developer.mozilla.org/en/CSS/pointer-events
+
+// Test and project pages:
+// ausi.github.com/Feature-detection-technique-for-pointer-events/
+// github.com/ausi/Feature-detection-technique-for-pointer-events/wiki
+// github.com/Modernizr/Modernizr/issues/80
+
+
+Modernizr.addTest('pointerevents', function(){
+    var element = document.createElement('x'),
+        documentElement = document.documentElement,
+        getComputedStyle = window.getComputedStyle,
+        supports;
+    if(!('pointerEvents' in element.style)){
+        return false;
+    }
+    element.style.pointerEvents = 'auto';
+    element.style.pointerEvents = 'x';
+    documentElement.appendChild(element);
+    supports = getComputedStyle &&
+        getComputedStyle(element, '').pointerEvents === 'auto';
+    documentElement.removeChild(element);
+    return !!supports;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-positionsticky.js b/profiles/commons/libraries/modernizr/feature-detects/css-positionsticky.js
new file mode 100644
index 0000000..43a19ec
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-positionsticky.js
@@ -0,0 +1,13 @@
+// Sticky positioning - constrains an element to be positioned inside the
+// intersection of its container box, and the viewport.
+Modernizr.addTest('csspositionsticky', function () {
+
+    var prop = 'position:';
+    var value = 'sticky';
+    var el = document.createElement('modernizr');
+    var mStyle = el.style;
+
+    mStyle.cssText = prop + Modernizr._prefixes.join(value + ';' + prop).slice(0, -prop.length);
+
+    return mStyle.position.indexOf(value) !== -1;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-regions.js b/profiles/commons/libraries/modernizr/feature-detects/css-regions.js
new file mode 100644
index 0000000..c8995c3
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-regions.js
@@ -0,0 +1,55 @@
+// CSS Regions
+// http://www.w3.org/TR/css3-regions/
+// By: Mihai Balan
+
+// We start with a CSS parser test then we check page geometry to see if it's affected by regions
+// Later we might be able to retire the second part, as WebKit builds with the false positives die out
+
+Modernizr.addTest('regions', function() {
+
+	/* Get the 'flowFrom' property name available in the browser. Either default or vendor prefixed.
+	If the property name can't be found we'll get Boolean 'false' and fail quickly */
+	var flowFromProperty = Modernizr.prefixed("flowFrom"),
+		flowIntoProperty = Modernizr.prefixed("flowInto");
+
+	if (!flowFromProperty || !flowIntoProperty){
+		return false;
+	}
+
+	/* If CSS parsing is there, try to determine if regions actually work. */
+	var container		= document.createElement('div'),
+		content			= document.createElement('div'),
+		region			= document.createElement('div'),
+
+	/* we create a random, unlikely to be generated flow number to make sure we don't
+	clash with anything more vanilla, like 'flow', or 'article', or 'f1' */
+	flowName = 'modernizr_flow_for_regions_check';
+
+	/* First create a div with two adjacent divs inside it. The first will be the
+	content, the second will be the region. To be able to distinguish between the two,
+	we'll give the region a particular padding */
+	content.innerText		= 'M';
+	container.style.cssText	= 'top: 150px; left: 150px; padding: 0px;';
+	region.style.cssText	= 'width: 50px; height: 50px; padding: 42px;';
+
+	region.style[flowFromProperty] = flowName;
+	container.appendChild(content);
+	container.appendChild(region);
+	document.documentElement.appendChild(container);
+
+	/* Now compute the bounding client rect, before and after attempting to flow the
+	content div in the region div. If regions are enabled, the after bounding rect
+	should reflect the padding of the region div.*/
+	var flowedRect, delta,
+		plainRect = content.getBoundingClientRect();
+
+
+	content.style[flowIntoProperty] = flowName;
+	flowedRect = content.getBoundingClientRect();
+
+	delta = flowedRect.left - plainRect.left;
+	document.documentElement.removeChild(container);
+	content = region = container = undefined;
+
+	return (delta == 42);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-remunit.js b/profiles/commons/libraries/modernizr/feature-detects/css-remunit.js
new file mode 100644
index 0000000..38e15b8
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-remunit.js
@@ -0,0 +1,19 @@
+
+// test by github.com/nsfmc
+
+// "The 'rem' unit ('root em') is relative to the computed
+// value of the 'font-size' value of the root element."
+// http://www.w3.org/TR/css3-values/#relative0
+// you can test by checking if the prop was ditched
+
+// http://snook.ca/archives/html_and_css/font-size-with-rem
+
+Modernizr.addTest('cssremunit', function(){
+
+  var div = document.createElement('div');
+  try {
+    div.style.fontSize = '3rem';
+  } catch(er){}
+  return (/rem/).test(div.style.fontSize);
+
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-resize.js b/profiles/commons/libraries/modernizr/feature-detects/css-resize.js
new file mode 100644
index 0000000..fff99ba
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-resize.js
@@ -0,0 +1,8 @@
+
+// Test for CSS 3 UI "resize" property
+// http://www.w3.org/TR/css3-ui/#resize
+// https://developer.mozilla.org/en/CSS/resize
+
+Modernizr.addTest('cssresize', Modernizr.testAllProps('resize'));
+
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-scrollbars.js b/profiles/commons/libraries/modernizr/feature-detects/css-scrollbars.js
new file mode 100644
index 0000000..f26de9f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-scrollbars.js
@@ -0,0 +1,19 @@
+// Stylable scrollbars detection
+Modernizr.addTest('cssscrollbar', function() {
+
+	var bool,
+
+		styles = "#modernizr{overflow: scroll; width: 40px }#" +
+			Modernizr._prefixes
+				.join("scrollbar{width:0px}"+' #modernizr::')
+				.split('#')
+				.slice(1)
+				.join('#') + "scrollbar{width:0px}";
+
+	Modernizr.testStyles(styles, function(node) {
+		bool = 'scrollWidth' in node && node.scrollWidth == 40;
+	});
+
+	return bool;
+
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-subpixelfont.js b/profiles/commons/libraries/modernizr/feature-detects/css-subpixelfont.js
new file mode 100644
index 0000000..57a11b0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-subpixelfont.js
@@ -0,0 +1,23 @@
+/*
+ * Test for SubPixel Font Rendering
+ * (to infer if GDI or DirectWrite is used on Windows)
+ * Authors: @derSchepp, @gerritvanaaken, @rodneyrehm, @yatil, @ryanseddon
+ * Web: https://github.com/gerritvanaaken/subpixeldetect
+ */
+Modernizr.addTest('subpixelfont', function() {
+    var bool,
+        styles = "#modernizr{position: absolute; top: -10em; visibility:hidden; font: normal 10px arial;}#subpixel{float: left; font-size: 33.3333%;}";
+    
+    // see https://github.com/Modernizr/Modernizr/blob/master/modernizr.js#L97
+    Modernizr.testStyles(styles, function(elem) {
+        var subpixel = elem.firstChild;
+
+        subpixel.innerHTML = 'This is a text written in Arial';
+
+        bool = window.getComputedStyle ?
+            window.getComputedStyle(subpixel, null).getPropertyValue("width") !== '44px'
+            : false;
+    }, 1, ['subpixel']);
+
+    return bool;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-supports.js b/profiles/commons/libraries/modernizr/feature-detects/css-supports.js
new file mode 100644
index 0000000..24d26d4
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-supports.js
@@ -0,0 +1,6 @@
+// http://dev.w3.org/csswg/css3-conditional/#at-supports
+// github.com/Modernizr/Modernizr/issues/648
+// Relies on the fact that a browser vendor should expose the CSSSupportsRule interface
+// http://dev.w3.org/csswg/css3-conditional/#the-csssupportsrule-interface
+
+Modernizr.addTest("supports","CSSSupportsRule" in window);
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-userselect.js b/profiles/commons/libraries/modernizr/feature-detects/css-userselect.js
new file mode 100644
index 0000000..062ee90
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-userselect.js
@@ -0,0 +1,10 @@
+// -moz-user-select:none test.
+
+// by ryan seddon
+//https://github.com/Modernizr/Modernizr/issues/250
+
+
+Modernizr.addTest("userselect",function(){
+    return Modernizr.testAllProps("user-select");
+});
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-vhunit.js b/profiles/commons/libraries/modernizr/feature-detects/css-vhunit.js
new file mode 100644
index 0000000..9de2b64
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-vhunit.js
@@ -0,0 +1,14 @@
+// https://github.com/Modernizr/Modernizr/issues/572
+// Similar to http://jsfiddle.net/FWeinb/etnYC/
+Modernizr.addTest('cssvhunit', function() {
+    var bool;
+    Modernizr.testStyles("#modernizr { height: 50vh; }", function(elem, rule) {   
+        var height = parseInt(window.innerHeight/2,10),
+            compStyle = parseInt((window.getComputedStyle ?
+                      getComputedStyle(elem, null) :
+                      elem.currentStyle)["height"],10);
+        
+        bool= (compStyle == height);
+    });
+    return bool;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-vmaxunit.js b/profiles/commons/libraries/modernizr/feature-detects/css-vmaxunit.js
new file mode 100644
index 0000000..142346b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-vmaxunit.js
@@ -0,0 +1,14 @@
+// https://github.com/Modernizr/Modernizr/issues/572
+// http://jsfiddle.net/glsee/JDsWQ/4/
+Modernizr.addTest('cssvmaxunit', function(){
+    var bool;
+    Modernizr.testStyles("#modernizr { width: 50vmax; }", function(elem, rule) {
+        var one_vw = window.innerWidth/100,
+            one_vh = window.innerHeight/100,
+            compWidth = parseInt((window.getComputedStyle ?
+                                  getComputedStyle(elem, null) :
+                                  elem.currentStyle)['width'],10);
+        bool = ( parseInt(Math.max(one_vw, one_vh)*50,10) == compWidth );
+    });
+    return bool;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-vminunit.js b/profiles/commons/libraries/modernizr/feature-detects/css-vminunit.js
new file mode 100644
index 0000000..e6b9881
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-vminunit.js
@@ -0,0 +1,14 @@
+// https://github.com/Modernizr/Modernizr/issues/572
+// http://jsfiddle.net/glsee/JRmdq/8/
+Modernizr.addTest('cssvminunit', function(){
+    var bool;
+    Modernizr.testStyles("#modernizr { width: 50vmin; }", function(elem, rule) {
+        var one_vw = window.innerWidth/100,
+            one_vh = window.innerHeight/100,
+            compWidth = parseInt((window.getComputedStyle ?
+                                  getComputedStyle(elem, null) :
+                                  elem.currentStyle)['width'],10);
+        bool = ( parseInt(Math.min(one_vw, one_vh)*50,10) == compWidth );
+    });
+    return bool;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/css-vwunit.js b/profiles/commons/libraries/modernizr/feature-detects/css-vwunit.js
new file mode 100644
index 0000000..28f8ca2
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/css-vwunit.js
@@ -0,0 +1,14 @@
+// https://github.com/Modernizr/Modernizr/issues/572
+// http://jsfiddle.net/FWeinb/etnYC/
+Modernizr.addTest('cssvwunit', function(){
+    var bool;
+    Modernizr.testStyles("#modernizr { width: 50vw; }", function(elem, rule) {
+        var width = parseInt(window.innerWidth/2,10),
+            compStyle = parseInt((window.getComputedStyle ?
+                      getComputedStyle(elem, null) :
+                      elem.currentStyle)["width"],10);
+        
+        bool= (compStyle == width);
+    });
+    return bool;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/custom-protocol-handler.js b/profiles/commons/libraries/modernizr/feature-detects/custom-protocol-handler.js
new file mode 100644
index 0000000..2534189
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/custom-protocol-handler.js
@@ -0,0 +1,10 @@
+/*
+	Custom protocol handler support
+	http://developers.whatwg.org/timers.html#custom-handlers
+	
+	Added by @benschwarz
+*/
+
+Modernizr.addTest('customprotocolhandler', function () {
+    return !!navigator.registerProtocolHandler;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dart.js b/profiles/commons/libraries/modernizr/feature-detects/dart.js
new file mode 100644
index 0000000..9a8bc82
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dart.js
@@ -0,0 +1,6 @@
+// Dart
+// By Theodoor van Donge
+
+// https://chromiumcodereview.appspot.com/9232049/
+
+Modernizr.addTest('dart', !!Modernizr.prefixed('startDart', navigator));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dataview-api.js b/profiles/commons/libraries/modernizr/feature-detects/dataview-api.js
new file mode 100644
index 0000000..249bfff
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dataview-api.js
@@ -0,0 +1,4 @@
+// DataView 
+// https://developer.mozilla.org/en/JavaScript_typed_arrays/DataView
+// By Addy Osmani
+Modernizr.addTest('dataview', (typeof DataView !== 'undefined' && 'getFloat64' in DataView.prototype));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dom-classlist.js b/profiles/commons/libraries/modernizr/feature-detects/dom-classlist.js
new file mode 100644
index 0000000..c227057
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dom-classlist.js
@@ -0,0 +1,4 @@
+// classList
+// https://developer.mozilla.org/en/DOM/element.classList
+// By Addy Osmani
+Modernizr.addTest('classlist', 'classList' in document.documentElement);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dom-createElement-attrs.js b/profiles/commons/libraries/modernizr/feature-detects/dom-createElement-attrs.js
new file mode 100644
index 0000000..d9a3b11
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dom-createElement-attrs.js
@@ -0,0 +1,11 @@
+// by james a rosen.
+// https://github.com/Modernizr/Modernizr/issues/258
+
+Modernizr.addTest('createelement-attrs', function() {
+  try {
+    return document.createElement("<input name='test' />").getAttribute('name') == 'test';
+  } catch(e) {
+    return false;
+  }
+});
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dom-dataset.js b/profiles/commons/libraries/modernizr/feature-detects/dom-dataset.js
new file mode 100644
index 0000000..810ff50
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dom-dataset.js
@@ -0,0 +1,9 @@
+
+// dataset API for data-* attributes
+// test by @phiggins42
+
+Modernizr.addTest('dataset', function(){
+  var n = document.createElement("div");
+  n.setAttribute("data-a-b", "c");
+  return !!(n.dataset && n.dataset.aB === "c");
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/dom-microdata.js b/profiles/commons/libraries/modernizr/feature-detects/dom-microdata.js
new file mode 100644
index 0000000..ab0a5d6
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/dom-microdata.js
@@ -0,0 +1,4 @@
+// Microdata support
+// http://www.w3.org/TR/html5/microdata.html
+// By Addy Osmani
+Modernizr.addTest('microdata', !!(document['getItems']));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-datalist.js b/profiles/commons/libraries/modernizr/feature-detects/elem-datalist.js
new file mode 100644
index 0000000..4bcdc1f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-datalist.js
@@ -0,0 +1,12 @@
+
+
+// lol. we already have a test for datalist built in! silly you.
+
+
+// Helpful links while you're here, though..
+
+// http://css-tricks.com/15346-relevant-dropdowns-polyfill-for-datalist/
+// http://miketaylr.com/test/datalist.html
+// http://miketaylr.com/code/datalist.html
+
+Modernizr.addTest('datalistelem', Modernizr.input.list );
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-details.js b/profiles/commons/libraries/modernizr/feature-detects/elem-details.js
new file mode 100644
index 0000000..90501f1
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-details.js
@@ -0,0 +1,25 @@
+// By @mathias, based on http://mths.be/axh
+Modernizr.addTest('details', function() {
+    var doc = document,
+        el = doc.createElement('details'),
+        fake,
+        root,
+        diff;
+    if (!('open' in el)) { // return early if possible; thanks @aFarkas!
+        return false;
+    }
+    root = doc.body || (function() {
+        var de = doc.documentElement;
+        fake = true;
+        return de.insertBefore(doc.createElement('body'), de.firstElementChild || de.firstChild);
+    }());
+    el.innerHTML = '<summary>a</summary>b';
+    el.style.display = 'block';
+    root.appendChild(el);
+    diff = el.offsetHeight;
+    el.open = true;
+    diff = diff != el.offsetHeight;
+    root.removeChild(el);
+    fake && root.parentNode.removeChild(root);
+    return diff;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-output.js b/profiles/commons/libraries/modernizr/feature-detects/elem-output.js
new file mode 100644
index 0000000..54276b2
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-output.js
@@ -0,0 +1,4 @@
+// <output>
+// http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-output-element
+// by Addy Osmani
+Modernizr.addTest('outputelem', 'value' in document.createElement('output'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-progress-meter.js b/profiles/commons/libraries/modernizr/feature-detects/elem-progress-meter.js
new file mode 100644
index 0000000..cfa4bdf
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-progress-meter.js
@@ -0,0 +1,11 @@
+//By Stefan Wallin
+
+//tests for progressbar-support. All browsers that don't support progressbar returns undefined =)
+Modernizr.addTest("progressbar",function(){
+    return document.createElement('progress').max !== undefined;
+});
+
+//tests for meter-support. All browsers that don't support meters returns undefined =)
+Modernizr.addTest("meter",function(){
+    return document.createElement('meter').max !== undefined;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-ruby.js b/profiles/commons/libraries/modernizr/feature-detects/elem-ruby.js
new file mode 100644
index 0000000..dbb978f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-ruby.js
@@ -0,0 +1,53 @@
+// Browser support test for the HTML5 <ruby>, <rt> and <rp> elements
+// http://www.whatwg.org/specs/web-apps/current-work/multipage/text-level-semantics.html#the-ruby-element
+//
+// by @alrra
+
+Modernizr.addTest('ruby', function () {
+
+    var ruby = document.createElement('ruby'),
+        rt = document.createElement('rt'),
+        rp = document.createElement('rp'),
+        docElement = document.documentElement,
+        displayStyleProperty = 'display',
+        fontSizeStyleProperty = 'fontSize'; // 'fontSize' - because it`s only used for IE6 and IE7
+
+    ruby.appendChild(rp);
+    ruby.appendChild(rt);
+    docElement.appendChild(ruby);
+
+    // browsers that support <ruby> hide the <rp> via "display:none"
+    if ( getStyle(rp, displayStyleProperty) == 'none' ||                                                       // for non-IE browsers
+    // but in IE browsers <rp> has "display:inline" so, the test needs other conditions:
+        getStyle(ruby, displayStyleProperty) == 'ruby' && getStyle(rt, displayStyleProperty) == 'ruby-text' || // for IE8 & IE9
+        getStyle(rp, fontSizeStyleProperty) == '6pt' && getStyle(rt, fontSizeStyleProperty) == '6pt' ) {       // for IE6 & IE7
+
+        cleanUp();
+        return true;
+
+    } else {
+        cleanUp();
+        return false;
+    }
+
+    function getStyle( element, styleProperty ) {
+        var result;
+
+        if ( window.getComputedStyle ) {     // for non-IE browsers
+            result = document.defaultView.getComputedStyle(element,null).getPropertyValue(styleProperty);
+        } else if ( element.currentStyle ) { // for IE
+            result = element.currentStyle[styleProperty];
+        }
+
+        return result;
+    }
+
+    function cleanUp() {
+        docElement.removeChild(ruby);
+        // the removed child node still exists in memory, so ...
+        ruby = null;
+        rt = null;
+        rp = null;
+    }
+
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-time.js b/profiles/commons/libraries/modernizr/feature-detects/elem-time.js
new file mode 100644
index 0000000..fc88606
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-time.js
@@ -0,0 +1,4 @@
+// <time> element
+// http://www.whatwg.org/specs/web-apps/current-work/multipage/rendering.html#the-time-element-0
+// by Addy Osmani
+Modernizr.addTest('time', 'valueAsDate' in document.createElement('time'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/elem-track.js b/profiles/commons/libraries/modernizr/feature-detects/elem-track.js
new file mode 100644
index 0000000..7d8e495
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/elem-track.js
@@ -0,0 +1,11 @@
+// Track element + Timed Text Track API
+// http://www.w3.org/TR/html5/video.html#the-track-element
+// http://www.w3.org/TR/html5/media-elements.html#text-track-api
+//
+// While IE10 has implemented the track element, IE10 does not expose the underlying APIs to create timed text tracks by JS (really sad)
+// By Addy Osmani
+Modernizr.addTest({
+	texttrackapi: (typeof (document.createElement('video').addTextTrack) === 'function'),
+	// a more strict test for track including UI support: document.createElement('track').kind === 'subtitles'
+	track: ('kind' in document.createElement('track'))
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/emoji.js b/profiles/commons/libraries/modernizr/feature-detects/emoji.js
new file mode 100644
index 0000000..271db65
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/emoji.js
@@ -0,0 +1,11 @@
+// Requires a Modernizr build with `canvastext` included
+// http://www.modernizr.com/download/#-canvas-canvastext
+Modernizr.addTest('emoji', function() {
+  if (!Modernizr.canvastext) return false;
+  var node = document.createElement('canvas'),
+      ctx = node.getContext('2d');
+  ctx.textBaseline = 'top';
+  ctx.font = '32px Arial';
+  ctx.fillText('\ud83d\ude03', 0, 0); // "smiling face with open mouth" emoji
+  return ctx.getImageData(16, 16, 1, 1).data[0] !== 0;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/es5-strictmode.js b/profiles/commons/libraries/modernizr/feature-detects/es5-strictmode.js
new file mode 100644
index 0000000..bffbe95
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/es5-strictmode.js
@@ -0,0 +1,7 @@
+// strict mode
+
+// test by @kangax
+
+Modernizr.addTest('strictmode', function(){
+	return (function(){ "use strict"; return !this; })(); 
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/event-deviceorientation-motion.js b/profiles/commons/libraries/modernizr/feature-detects/event-deviceorientation-motion.js
new file mode 100644
index 0000000..644e671
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/event-deviceorientation-motion.js
@@ -0,0 +1,11 @@
+//By Shi Chuan
+//Part of Device Access aspect of HTML5, same category as geolocation
+//W3C Editor's Draft at http://dev.w3.org/geo/api/spec-source-orientation.html
+//Implementation by iOS Safari at http://goo.gl/fhce3 and http://goo.gl/rLKz8
+
+
+//test for Device Motion Event support, returns boolean value true/false
+Modernizr.addTest('devicemotion', ('DeviceMotionEvent' in window) );
+
+//test for Device Orientation Event support, returns boolean value true/false
+Modernizr.addTest('deviceorientation', ('DeviceOrientationEvent' in window) );
diff --git a/profiles/commons/libraries/modernizr/feature-detects/exif-orientation.js b/profiles/commons/libraries/modernizr/feature-detects/exif-orientation.js
new file mode 100644
index 0000000..994c13d
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/exif-orientation.js
@@ -0,0 +1,32 @@
+// EXIF Orientation test
+
+// iOS looks at the EXIF Orientation flag in jpgs and rotates the image
+// accordingly. Looks like most desktop browsers just ignore this data.
+
+// description: www.impulseadventure.com/photo/exif-orientation.html
+
+// Bug trackers:
+//    bugzil.la/298619 (unimplemented)
+//    crbug.com/56845 (looks incomplete)
+//    webk.it/19688 (available upstream but its up all ports to turn on individually)
+//
+
+// detect by Paul Sayre
+
+
+(function(){
+
+  var img = new Image();
+
+  img.onerror = function() {
+      Modernizr.addTest('exif-orientation', function () { return false; });
+  };
+
+  img.onload = function() {
+      Modernizr.addTest('exif-orientation', function () { return img.width !== 2; });
+  };
+
+  // There may be a way to shrink this more, it's a 1x2 white jpg with the orientation flag set to 6
+  img.src = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAASUkqAAgAAAABABIBAwABAAAABgASAAAAAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD+/iiiigD/2Q==";
+
+})();
diff --git a/profiles/commons/libraries/modernizr/feature-detects/file-api.js b/profiles/commons/libraries/modernizr/feature-detects/file-api.js
new file mode 100644
index 0000000..7c31e8c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/file-api.js
@@ -0,0 +1,12 @@
+/**
+ * file tests for the File API specification
+ *   Tests for objects specific to the File API W3C specification without
+ *   being redundant (don't bother testing for Blob since it is assumed
+ *   to be the File object's prototype.
+ *
+ *   Will fail in Safari 5 due to its lack of support for the standards
+ *   defined FileReader object
+ */
+Modernizr.addTest('filereader', function () {
+    return !!(window.File && window.FileList && window.FileReader);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/file-filesystem.js b/profiles/commons/libraries/modernizr/feature-detects/file-filesystem.js
new file mode 100644
index 0000000..ced6761
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/file-filesystem.js
@@ -0,0 +1,9 @@
+// Filesystem API
+// dev.w3.org/2009/dap/file-system/file-dir-sys.html
+
+// The API will be present in Chrome incognito, but will throw an exception.
+// See crbug.com/93417
+//
+// By Eric Bidelman (@ebidel)
+
+Modernizr.addTest('filesystem', !!Modernizr.prefixed('requestFileSystem', window));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-fileinput.js b/profiles/commons/libraries/modernizr/feature-detects/forms-fileinput.js
new file mode 100644
index 0000000..b33eb97
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-fileinput.js
@@ -0,0 +1,13 @@
+
+
+// Detects whether input type="file" is available on the platform
+// E.g. iOS < 6 and some android version don't support this
+
+//  It's useful if you want to hide the upload feature of your app on devices that
+//  don't support it (iphone, ipad, etc).
+
+Modernizr.addTest('fileinput', function() {
+    var elem = document.createElement('input');
+    elem.type = 'file';
+    return !elem.disabled;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-formattribute.js b/profiles/commons/libraries/modernizr/feature-detects/forms-formattribute.js
new file mode 100644
index 0000000..6b8e114
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-formattribute.js
@@ -0,0 +1,29 @@
+// Detects whether input form="form_id" is available on the platform
+// E.g. IE 10 (and below), don't support this
+Modernizr.addTest("formattribute", function() {
+	var form = document.createElement("form"),
+		input = document.createElement("input"),
+		div = document.createElement("div"),
+		id = "formtest"+(new Date().getTime()),
+		attr,
+		bool = false;
+
+		form.id = id;
+
+	//IE6/7 confuses the form idl attribute and the form content attribute
+	if(document.createAttribute){
+		attr = document.createAttribute("form");
+		attr.nodeValue = id;
+		input.setAttributeNode(attr);
+		div.appendChild(form);
+		div.appendChild(input);
+
+		document.documentElement.appendChild(div);
+
+		bool = form.elements.length === 1 && input.form == form;
+
+		div.parentNode.removeChild(div);
+	}
+
+	return bool;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-inputnumber-l10n.js b/profiles/commons/libraries/modernizr/feature-detects/forms-inputnumber-l10n.js
new file mode 100644
index 0000000..8746b42
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-inputnumber-l10n.js
@@ -0,0 +1,32 @@
+// input[type="number"] localized input/output
+// // Detects whether input type="number" is capable of receiving and
+// // displaying localized numbers, e.g. with comma separator
+// // https://bugs.webkit.org/show_bug.cgi?id=42484
+// // Based on http://trac.webkit.org/browser/trunk/LayoutTests/fast/forms/script-tests/input-number-keyoperation.js?rev=80096#L9
+// // By Peter Janes
+
+Modernizr.addTest('localizedNumber', function() {
+    var doc = document,
+        el = document.createElement('div'),
+        fake,
+        root,
+        input,
+        diff;
+    root = doc.body || (function() {
+        var de = doc.documentElement;
+        fake = true;
+        return de.insertBefore(doc.createElement('body'), de.firstElementChild || de.firstChild);
+    }());
+    el.innerHTML = '<input type="number" value="1.0" step="0.1"/>';
+    input = el.childNodes[0];
+    root.appendChild(el);
+    input.focus();
+    try {
+        doc.execCommand('InsertText', false, '1,1');
+    } catch(e) { // prevent warnings in IE
+    }
+    diff = input.type === 'number' && input.valueAsNumber === 1.1 && input.checkValidity();
+    root.removeChild(el);
+    fake && root.parentNode.removeChild(root);
+    return diff;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-placeholder.js b/profiles/commons/libraries/modernizr/feature-detects/forms-placeholder.js
new file mode 100644
index 0000000..e68014b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-placeholder.js
@@ -0,0 +1,10 @@
+// testing for placeholder attribute in inputs and textareas
+// re-using Modernizr.input if available
+
+Modernizr.addTest('placeholder', function(){
+
+  return !!( 'placeholder' in ( Modernizr.input    || document.createElement('input')    ) && 
+             'placeholder' in ( Modernizr.textarea || document.createElement('textarea') )
+           );
+
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-speechinput.js b/profiles/commons/libraries/modernizr/feature-detects/forms-speechinput.js
new file mode 100644
index 0000000..48c9021
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-speechinput.js
@@ -0,0 +1,19 @@
+// speech input for inputs
+// by @alrra
+
+
+// `webkitSpeech` in elem 
+// doesn`t work correctly in all versions of Chromium based browsers.
+//   It can return false even if they have support for speech i.imgur.com/2Y40n.png
+//  Testing with 'onwebkitspeechchange' seems to fix this problem
+
+// this detect only checks the webkit version because
+// the speech attribute is likely to be deprecated in favor of a JavaScript API.
+// http://lists.w3.org/Archives/Public/public-webapps/2011OctDec/att-1696/speechapi.html
+
+// FIXME: add support for detecting the new spec'd behavior
+
+Modernizr.addTest('speechinput', function(){
+    var elem = document.createElement('input'); 
+    return 'speech' in elem || 'onwebkitspeechchange' in elem; 
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/forms-validation.js b/profiles/commons/libraries/modernizr/feature-detects/forms-validation.js
new file mode 100644
index 0000000..5e5cfa6
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/forms-validation.js
@@ -0,0 +1,83 @@
+// This implementation only tests support for interactive form validation.
+// To check validation for a specific type or a specific other constraint,
+// the test can be combined: 
+//    - Modernizr.inputtypes.numer && Modernizr.formvalidation (browser supports rangeOverflow, typeMismatch etc. for type=number)
+//    - Modernizr.input.required && Modernizr.formvalidation (browser supports valueMissing)
+//
+(function(document, Modernizr){
+
+
+Modernizr.formvalidationapi = false;
+Modernizr.formvalidationmessage = false;
+
+Modernizr.addTest('formvalidation', function(){
+    var form = document.createElement('form');
+    if ( !('checkValidity' in form) ) {
+        return false;
+    }
+    var body = document.body,
+
+    html = document.documentElement,
+
+    bodyFaked = false,
+
+    invaildFired = false,
+
+    input;
+
+    Modernizr.formvalidationapi = true;
+
+    // Prevent form from being submitted
+    form.onsubmit = function(e) {
+        //Opera does not validate form, if submit is prevented
+        if ( !window.opera ) {
+            e.preventDefault();
+        }
+        e.stopPropagation();
+    };
+
+    // Calling form.submit() doesn't trigger interactive validation, 
+    // use a submit button instead
+    //older opera browsers need a name attribute
+    form.innerHTML = '<input name="modTest" required><button></button>';
+
+    // FF4 doesn't trigger "invalid" event if form is not in the DOM tree
+    // Chrome throws error if invalid input is not visible when submitting 
+    form.style.position = 'absolute';
+    form.style.top = '-99999em';
+
+    // We might in <head> in which case we need to create body manually
+    if ( !body ) {
+        bodyFaked = true;
+        body = document.createElement('body');
+        //avoid crashing IE8, if background image is used
+        body.style.background = "";
+        html.appendChild(body);
+    }
+
+    body.appendChild(form);
+
+    input = form.getElementsByTagName('input')[0];	
+
+    // Record whether "invalid" event is fired
+    input.oninvalid = function(e) {
+        invaildFired = true;
+        e.preventDefault();
+        e.stopPropagation();
+    };
+
+    //Opera does not fully support the validationMessage property
+    Modernizr.formvalidationmessage = !!input.validationMessage;
+
+    // Submit form by clicking submit button
+    form.getElementsByTagName('button')[0].click();
+
+    // Don't forget to clean up
+    body.removeChild(form);
+    bodyFaked && html.removeChild(body);
+
+    return invaildFired;
+});
+
+
+})(document, window.Modernizr);
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/fullscreen-api.js b/profiles/commons/libraries/modernizr/feature-detects/fullscreen-api.js
new file mode 100644
index 0000000..7432571
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/fullscreen-api.js
@@ -0,0 +1,10 @@
+Modernizr.addTest('fullscreen',function(){
+     for(var i = 0; i < Modernizr._domPrefixes.length; i++) {
+        if( document[Modernizr._domPrefixes[i].toLowerCase() + 'CancelFullScreen'])
+            return true;
+     }
+     return !!document['cancelFullScreen'] || false;
+});
+
+// http://developer.apple.com/library/safari/documentation/AudioVideo/Conceptual/Using_HTML5_Audio_Video/ControllingMediaWithJavaScript/ControllingMediaWithJavaScript.html#//apple_ref/doc/uid/TP40009523-CH3-SW20
+// https://developer.mozilla.org/en/API/Fullscreen
diff --git a/profiles/commons/libraries/modernizr/feature-detects/gamepad.js b/profiles/commons/libraries/modernizr/feature-detects/gamepad.js
new file mode 100644
index 0000000..0756289
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/gamepad.js
@@ -0,0 +1,12 @@
+// GamePad API
+// https://dvcs.w3.org/hg/gamepad/raw-file/default/gamepad.html
+// By Eric Bidelman
+
+// FF has Gamepad API support only in special builds, but not in any release (even behind a flag)
+// Their current implementation has no way to feature detect, only events to bind to.
+//   http://www.html5rocks.com/en/tutorials/doodles/gamepad/#toc-featuredetect
+
+// but a patch will bring them up to date with the spec when it lands (and they'll pass this test)
+//   https://bugzilla.mozilla.org/show_bug.cgi?id=690935
+
+Modernizr.addTest('gamepads', !!Modernizr.prefixed('getGamepads', navigator));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/getusermedia.js b/profiles/commons/libraries/modernizr/feature-detects/getusermedia.js
new file mode 100644
index 0000000..4c38bec
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/getusermedia.js
@@ -0,0 +1,5 @@
+// getUserMedia
+// http://www.whatwg.org/specs/web-apps/current-work/multipage/video-conferencing-and-peer-to-peer-communication.html
+// By Eric Bidelman
+
+Modernizr.addTest('getusermedia', !!Modernizr.prefixed('getUserMedia', navigator));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/ie8compat.js b/profiles/commons/libraries/modernizr/feature-detects/ie8compat.js
new file mode 100644
index 0000000..c95e56a
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/ie8compat.js
@@ -0,0 +1,12 @@
+
+// IE8 compat mode aka Fake IE7
+// by Erich Ocean
+
+// In this case, IE8 will be acting as IE7. You may choose to remove features in this case.
+
+// related:
+// james.padolsey.com/javascript/detect-ie-in-js-using-conditional-comments/
+
+Modernizr.addTest('ie8compat',function(){
+    return (!window.addEventListener && document.documentMode && document.documentMode === 7);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/iframe-sandbox.js b/profiles/commons/libraries/modernizr/feature-detects/iframe-sandbox.js
new file mode 100644
index 0000000..869c94a
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/iframe-sandbox.js
@@ -0,0 +1,5 @@
+// Test for `sandbox` attribute in iframes.
+//
+// Spec: http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#attr-iframe-sandbox
+
+Modernizr.addTest('sandbox', 'sandbox' in document.createElement('iframe'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/iframe-seamless.js b/profiles/commons/libraries/modernizr/feature-detects/iframe-seamless.js
new file mode 100644
index 0000000..247b9e6
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/iframe-seamless.js
@@ -0,0 +1,5 @@
+// Test for `seamless` attribute in iframes.
+//
+// Spec: http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#attr-iframe-seamless
+
+Modernizr.addTest('seamless', 'seamless' in document.createElement('iframe'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/iframe-srcdoc.js b/profiles/commons/libraries/modernizr/feature-detects/iframe-srcdoc.js
new file mode 100644
index 0000000..1769858
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/iframe-srcdoc.js
@@ -0,0 +1,5 @@
+// Test for `srcdoc` attribute in iframes.
+//
+// Spec: http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#attr-iframe-srcdoc
+
+Modernizr.addTest('srcdoc', 'srcdoc' in document.createElement('iframe'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/img-apng.js b/profiles/commons/libraries/modernizr/feature-detects/img-apng.js
new file mode 100644
index 0000000..069ac93
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/img-apng.js
@@ -0,0 +1,26 @@
+// Animated PNG
+// http://en.wikipedia.org/wiki/APNG
+// By Addy Osmani
+(function () {
+
+    if (!Modernizr.canvas) return false;
+    
+    var image = new Image(),
+        canvas = document.createElement('canvas'),
+        ctx = canvas.getContext('2d');
+
+
+    image.onload = function () {
+        Modernizr.addTest('apng', function () {
+            if (typeof canvas.getContext == 'undefined') {
+                return false;
+            } else {
+                ctx.drawImage(image, 0, 0);
+                return ctx.getImageData(0, 0, 1, 1).data[3] === 0;
+            }
+        });
+    };
+
+    image.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg==";
+
+}());
diff --git a/profiles/commons/libraries/modernizr/feature-detects/img-webp.js b/profiles/commons/libraries/modernizr/feature-detects/img-webp.js
new file mode 100644
index 0000000..360cdf8
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/img-webp.js
@@ -0,0 +1,20 @@
+// code.google.com/speed/webp/
+// by rich bradshaw, ryan seddon, and paul irish
+
+
+// This test is asynchronous. Watch out.
+
+(function(){
+
+  var image = new Image();
+
+  image.onerror = function() {
+      Modernizr.addTest('webp', false);
+  };  
+  image.onload = function() {
+      Modernizr.addTest('webp', function() { return image.width == 1; });
+  };
+
+  image.src = 'data:image/webp;base64,UklGRiwAAABXRUJQVlA4ICAAAAAUAgCdASoBAAEAL/3+/3+CAB/AAAFzrNsAAP5QAAAAAA==';
+
+}());
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/json.js b/profiles/commons/libraries/modernizr/feature-detects/json.js
new file mode 100644
index 0000000..af58064
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/json.js
@@ -0,0 +1,7 @@
+// native JSON support.
+// developer.mozilla.org/en/JSON
+
+// this will also succeed if you've loaded the JSON2.js polyfill ahead of time
+//   ... but that should be obvious. :)
+
+Modernizr.addTest('json', !!window.JSON && !!JSON.parse);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/lists-reversed.js b/profiles/commons/libraries/modernizr/feature-detects/lists-reversed.js
new file mode 100644
index 0000000..22fd92c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/lists-reversed.js
@@ -0,0 +1,6 @@
+
+// impressivewebs.com/reverse-ordered-lists-html5
+// polyfill: github.com/impressivewebs/HTML5-Reverse-Ordered-Lists
+
+
+Modernizr.addTest('olreversed', 'reversed' in document.createElement('ol'));
diff --git a/profiles/commons/libraries/modernizr/feature-detects/mathml.js b/profiles/commons/libraries/modernizr/feature-detects/mathml.js
new file mode 100644
index 0000000..e1c907a
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/mathml.js
@@ -0,0 +1,23 @@
+// MathML
+// http://www.w3.org/Math/ 
+// By Addy Osmani
+// Based on work by Davide (@dpvc) and David (@davidcarlisle)
+// in https://github.com/mathjax/MathJax/issues/182
+
+Modernizr.addTest('mathml', function(){
+	var hasMathML = false;
+	if ( document.createElementNS ) {
+	var ns = "http://www.w3.org/1998/Math/MathML",
+	    div = document.createElement("div");
+	    div.style.position = "absolute"; 
+	var mfrac = div.appendChild(document.createElementNS(ns,"math"))
+	               .appendChild(document.createElementNS(ns,"mfrac"));
+	mfrac.appendChild(document.createElementNS(ns,"mi"))
+	     .appendChild(document.createTextNode("xx"));
+	mfrac.appendChild(document.createElementNS(ns,"mi"))
+	     .appendChild(document.createTextNode("yy"));
+	document.body.appendChild(div);
+	hasMathML = div.offsetHeight > div.offsetWidth;
+	}
+	return hasMathML;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/network-connection.js b/profiles/commons/libraries/modernizr/feature-detects/network-connection.js
new file mode 100644
index 0000000..242cdfe
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/network-connection.js
@@ -0,0 +1,22 @@
+// determining low-bandwidth via navigator.connection
+
+// There are two iterations of the navigator.connection interface:
+
+// The first is present in Android 2.2+ and only in the Browser (not WebView)
+// : docs.phonegap.com/en/1.2.0/phonegap_connection_connection.md.html#connection.type
+// : davidbcalhoun.com/2010/using-navigator-connection-android
+
+// The second is specced at dev.w3.org/2009/dap/netinfo/ and perhaps landing in WebKit
+// : bugs.webkit.org/show_bug.cgi?id=73528
+
+// unknown devices are assumed as fast
+// for more rigorous network testing, consider boomerang.js: github.com/bluesmoon/boomerang/
+
+Modernizr.addTest('lowbandwidth', function() {
+
+  var connection = navigator.connection || { type: 0 }; // polyfill
+
+  return connection.type == 3 || // connection.CELL_2G
+      connection.type == 4 || // connection.CELL_3G
+      /^[23]g$/.test(connection.type); // string value in new spec
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/network-eventsource.js b/profiles/commons/libraries/modernizr/feature-detects/network-eventsource.js
new file mode 100644
index 0000000..ac94065
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/network-eventsource.js
@@ -0,0 +1,5 @@
+
+// server sent events aka eventsource
+// dev.w3.org/html5/eventsource/
+
+Modernizr.addTest('eventsource', !!window.EventSource);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/network-xhr2.js b/profiles/commons/libraries/modernizr/feature-detects/network-xhr2.js
new file mode 100644
index 0000000..8d3fb51
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/network-xhr2.js
@@ -0,0 +1,13 @@
+
+
+// XML HTTP Request Level 2
+// www.w3.org/TR/XMLHttpRequest2/
+
+// Much more details at github.com/Modernizr/Modernizr/issues/385
+
+// all three of these details report consistently across all target browsers:
+//   !!(window.ProgressEvent);
+//   !!(window.FormData);
+//   window.XMLHttpRequest && "withCredentials" in new XMLHttpRequest;
+
+Modernizr.addTest('xhr2', 'FormData' in window);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/notification.js b/profiles/commons/libraries/modernizr/feature-detects/notification.js
new file mode 100644
index 0000000..4324222
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/notification.js
@@ -0,0 +1,10 @@
+// Notifications
+// By Theodoor van Donge
+
+// window.webkitNotifications is only used by Chrome 
+//	http://www.html5rocks.com/en/tutorials/notifications/quick/
+
+// window.Notification only exist in the draft specs 
+//	http://dev.w3.org/2006/webapi/WebNotifications/publish/Notifications.html#idl-if-Notification
+
+Modernizr.addTest('notification', !!Modernizr.prefixed('Notifications', window));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/performance.js b/profiles/commons/libraries/modernizr/feature-detects/performance.js
new file mode 100644
index 0000000..903c5c9
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/performance.js
@@ -0,0 +1,5 @@
+// Navigation Timing (Performance)
+// https://dvcs.w3.org/hg/webperf/raw-file/tip/specs/NavigationTiming/
+// http://www.html5rocks.com/en/tutorials/webperformance/basics/
+// By Scott Murphy (uxder)
+Modernizr.addTest('performance', !!Modernizr.prefixed('performance', window));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/pointerlock-api.js b/profiles/commons/libraries/modernizr/feature-detects/pointerlock-api.js
new file mode 100644
index 0000000..07eb07e
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/pointerlock-api.js
@@ -0,0 +1,4 @@
+// https://developer.mozilla.org/en-US/docs/API/Pointer_Lock_API
+
+Modernizr.addTest('pointerlock',!!Modernizr.prefixed('pointerLockElement', document));
+
diff --git a/profiles/commons/libraries/modernizr/feature-detects/quota-management-api.js b/profiles/commons/libraries/modernizr/feature-detects/quota-management-api.js
new file mode 100644
index 0000000..5ce2b02
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/quota-management-api.js
@@ -0,0 +1,11 @@
+// Quota Storage Management API
+// This API can be used to check how much quota an origin is using and request more
+
+// Currently only implemented in Chrome.
+// https://developers.google.com/chrome/whitepapers/storage
+// By Addy Osmani
+
+Modernizr.addTest('quotamanagement', function(){
+  var storage = Modernizr.prefixed('StorageInfo', window);
+  return !!(storage && 'TEMPORARY' in storage && 'PERSISTENT' in storage);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/requestanimationframe.js b/profiles/commons/libraries/modernizr/feature-detects/requestanimationframe.js
new file mode 100644
index 0000000..5ac4bcf
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/requestanimationframe.js
@@ -0,0 +1,7 @@
+
+// requestAnimationFrame
+// Offload animation repainting to browser for optimized performance. 
+// http://dvcs.w3.org/hg/webperf/raw-file/tip/specs/RequestAnimationFrame/Overview.html
+// By Addy Osmani
+
+Modernizr.addTest('raf', !!Modernizr.prefixed('requestAnimationFrame', window));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/script-async.js b/profiles/commons/libraries/modernizr/feature-detects/script-async.js
new file mode 100644
index 0000000..d80d04b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/script-async.js
@@ -0,0 +1,3 @@
+// async script
+// By Theodoor van Donge
+Modernizr.addTest('scriptasync', 'async' in document.createElement('script'));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/script-defer.js b/profiles/commons/libraries/modernizr/feature-detects/script-defer.js
new file mode 100644
index 0000000..782f14a
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/script-defer.js
@@ -0,0 +1,3 @@
+// defer script
+// By Theodoor van Donge
+Modernizr.addTest('scriptdefer', 'defer' in document.createElement('script'));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/style-scoped.js b/profiles/commons/libraries/modernizr/feature-detects/style-scoped.js
new file mode 100644
index 0000000..3add1b0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/style-scoped.js
@@ -0,0 +1,6 @@
+// Browser support test for <style scoped>
+// http://www.w3.org/TR/html5/the-style-element.html#attr-style-scoped
+//
+// by @alrra
+
+Modernizr.addTest( 'stylescoped', 'scoped' in document.createElement('style') );
diff --git a/profiles/commons/libraries/modernizr/feature-detects/svg-filters.js b/profiles/commons/libraries/modernizr/feature-detects/svg-filters.js
new file mode 100644
index 0000000..d289b9d
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/svg-filters.js
@@ -0,0 +1,13 @@
+// Detect support for svg filters - http://www.w3.org/TR/SVG11/filters.html.
+// Should fail in Safari: http://stackoverflow.com/questions/9739955/feature-detecting-support-for-svg-filters.
+// detect by erik dahlstrom
+
+Modernizr.addTest('svgfilters', function(){
+	var result = false;
+    try {
+      result = typeof SVGFEColorMatrixElement !== undefined &&
+               SVGFEColorMatrixElement.SVG_FECOLORMATRIX_TYPE_SATURATE == 2;
+    }
+    catch(e) {}
+    return result;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/unicode.js b/profiles/commons/libraries/modernizr/feature-detects/unicode.js
new file mode 100644
index 0000000..39908bf
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/unicode.js
@@ -0,0 +1,32 @@
+/**
+ * Unicode special character support
+ * 
+ * Detection is made by testing missing glyph box rendering against star character
+ * If widths are the same, this "probably" means the browser didn't support the star character and rendered a glyph box instead
+ * Just need to ensure the font characters have different widths
+ * 
+ * Warning : positive Unicode support doesn't mean you can use it inside <title>, this seams more related to OS & Language packs
+ */
+Modernizr.addTest('unicode', function() {
+	
+	
+	var bool,
+
+		missingGlyph = document.createElement('span'),
+		
+		star = document.createElement('span');
+
+	Modernizr.testStyles('#modernizr{font-family:Arial,sans;font-size:300em;}', function(node) {
+
+		missingGlyph.innerHTML = '&#5987';
+		star.innerHTML = '&#9734';		
+		
+		node.appendChild(missingGlyph);
+		node.appendChild(star);
+		
+		bool = 'offsetWidth' in missingGlyph && missingGlyph.offsetWidth !== star.offsetWidth;
+	});
+
+	return bool;
+
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/url-data-uri.js b/profiles/commons/libraries/modernizr/feature-detects/url-data-uri.js
new file mode 100644
index 0000000..e6479a2
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/url-data-uri.js
@@ -0,0 +1,26 @@
+// data uri test.
+// https://github.com/Modernizr/Modernizr/issues/14
+
+// This test is asynchronous. Watch out.
+
+
+// in IE7 in HTTPS this can cause a Mixed Content security popup. 
+//  github.com/Modernizr/Modernizr/issues/362
+// To avoid that you can create a new iframe and inject this.. perhaps..
+
+
+(function(){
+
+  var datauri = new Image();
+
+
+  datauri.onerror = function() {
+      Modernizr.addTest('datauri', function () { return false; });
+  };  
+  datauri.onload = function() {
+      Modernizr.addTest('datauri', function () { return (datauri.width == 1 && datauri.height == 1); });
+  };
+
+  datauri.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
+
+})();
diff --git a/profiles/commons/libraries/modernizr/feature-detects/userdata.js b/profiles/commons/libraries/modernizr/feature-detects/userdata.js
new file mode 100644
index 0000000..79d921e
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/userdata.js
@@ -0,0 +1,7 @@
+// test if IE userdata supported
+// msdn.microsoft.com/en-us/library/ms531424(v=vs.85).aspx
+// test by @stereobooster
+
+Modernizr.addTest('userdata', function(){
+  return !!document.createElement('div').addBehavior;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/vibration.js b/profiles/commons/libraries/modernizr/feature-detects/vibration.js
new file mode 100644
index 0000000..034c25d
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/vibration.js
@@ -0,0 +1,4 @@
+// Vibration API
+// http://www.w3.org/TR/vibration/
+// https://developer.mozilla.org/en/DOM/window.navigator.mozVibrate
+Modernizr.addTest('vibrate', !!Modernizr.prefixed('vibrate', navigator));
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/web-intents.js b/profiles/commons/libraries/modernizr/feature-detects/web-intents.js
new file mode 100644
index 0000000..d0557fe
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/web-intents.js
@@ -0,0 +1,6 @@
+// Tests for the ability to use Web Intents (http://webintents.org).
+// By Eric Bidelman
+
+Modernizr.addTest('webintents', function() {
+  return !!Modernizr.prefixed('startActivity', navigator);
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/webgl-extensions.js b/profiles/commons/libraries/modernizr/feature-detects/webgl-extensions.js
new file mode 100644
index 0000000..c005c00
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/webgl-extensions.js
@@ -0,0 +1,42 @@
+
+// Grab the WebGL extensions currently supported and add to the Modernizr.webgl object
+// spec: www.khronos.org/registry/webgl/specs/latest/#5.13.14
+
+// based on code from ilmari heikkinen
+// code.google.com/p/graphics-detect/source/browse/js/detect.js
+
+
+(function(){
+
+    if (!Modernizr.webgl) return;
+
+    var canvas, ctx, exts;
+
+    try {
+        canvas  = document.createElement('canvas');
+        ctx     = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
+        exts    = ctx.getSupportedExtensions();
+    }
+    catch (e) {
+        return;
+    }
+
+    if (ctx === undefined) {
+        Modernizr.webgl = new Boolean(false);
+    }
+    else {
+        Modernizr.webgl = new Boolean(true);
+    }
+
+
+    for (var i = -1, len = exts.length; ++i < len; ){
+        Modernizr.webgl[exts[i]] = true;
+    }
+
+    // hack for addressing modernizr testsuite failures. sorry.
+    if (window.TEST && TEST.audvid){
+        TEST.audvid.push('webgl');
+    }
+
+    canvas = undefined;
+})();
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/websockets-binary.js b/profiles/commons/libraries/modernizr/feature-detects/websockets-binary.js
new file mode 100644
index 0000000..8f15c25
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/websockets-binary.js
@@ -0,0 +1,7 @@
+
+// binaryType is truthy if there is support.. returns "blob" in new-ish chrome.
+// plus.google.com/115535723976198353696/posts/ERN6zYozENV
+
+Modernizr.addTest('websocketsbinary', 
+  !!(window.WebSocket && (new WebSocket('ws://.')).binaryType)
+);
diff --git a/profiles/commons/libraries/modernizr/feature-detects/window-framed.js b/profiles/commons/libraries/modernizr/feature-detects/window-framed.js
new file mode 100644
index 0000000..f8a6704
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/window-framed.js
@@ -0,0 +1,8 @@
+
+// tests if page is iframed
+
+// github.com/Modernizr/Modernizr/issues/242
+
+Modernizr.addTest('framed', function(){
+  return window.location != top.location;
+});
diff --git a/profiles/commons/libraries/modernizr/feature-detects/workers-blobworkers.js b/profiles/commons/libraries/modernizr/feature-detects/workers-blobworkers.js
new file mode 100644
index 0000000..509127f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/workers-blobworkers.js
@@ -0,0 +1,48 @@
+// by jussi-kalliokoski
+
+
+// This test is asynchronous. Watch out.
+
+// The test will potentially add garbage to console.
+
+(function(){
+  try {
+
+    // we're avoiding using Modernizr._domPrefixes as the prefix capitalization on
+    // these guys are notoriously peculiar.
+    var BlobBuilder = window.MozBlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder || window.OBlobBuilder || window.BlobBuilder,
+        URL         = window.MozURL || window.webkitURL || window.MSURL || window.OURL || window.URL;
+
+    var data    = 'Modernizr',
+        bb      = new BlobBuilder();
+
+    bb.append('this.onmessage=function(e){postMessage(e.data)}');
+
+    var url     = URL.createObjectURL(bb.getBlob()),
+        worker  = new Worker(url);
+
+    bb = null;
+
+    worker.onmessage = function(e) {
+      worker.terminate();
+      URL.revokeObjectURL(url);
+      Modernizr.addTest('blobworkers', data === e.data);
+      worker = null;
+    };
+
+    // Just in case...
+    worker.onerror = function() {
+      Modernizr.addTest('blobworkers', false);
+      worker = null;
+    };
+
+    setTimeout(function() {
+        Modernizr.addTest('blobworkers', false);
+    }, 200);
+
+    worker.postMessage(data);
+
+  } catch (e) {
+    Modernizr.addTest('blobworkers', false);
+  }
+}());
diff --git a/profiles/commons/libraries/modernizr/feature-detects/workers-dataworkers.js b/profiles/commons/libraries/modernizr/feature-detects/workers-dataworkers.js
new file mode 100644
index 0000000..efa95a5
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/workers-dataworkers.js
@@ -0,0 +1,34 @@
+// by jussi-kalliokoski
+
+
+// This test is asynchronous. Watch out.
+
+// The test will potentially add garbage to console.
+
+(function(){
+  try {
+    var data    = 'Modernizr',
+        worker  = new Worker('data:text/javascript;base64,dGhpcy5vbm1lc3NhZ2U9ZnVuY3Rpb24oZSl7cG9zdE1lc3NhZ2UoZS5kYXRhKX0=');
+
+    worker.onmessage = function(e) {
+      worker.terminate();
+      Modernizr.addTest('dataworkers', data === e.data);
+      worker = null;
+    };
+
+    // Just in case...
+    worker.onerror = function() {
+      Modernizr.addTest('dataworkers', false);
+      worker = null;
+    };
+
+    setTimeout(function() {
+        Modernizr.addTest('dataworkers', false);
+    }, 200);
+
+    worker.postMessage(data);
+
+  } catch (e) {
+    Modernizr.addTest('dataworkers', false);
+  }
+}());
diff --git a/profiles/commons/libraries/modernizr/feature-detects/workers-sharedworkers.js b/profiles/commons/libraries/modernizr/feature-detects/workers-sharedworkers.js
new file mode 100644
index 0000000..a9d78eb
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/feature-detects/workers-sharedworkers.js
@@ -0,0 +1,3 @@
+Modernizr.addTest('sharedworkers', function(){
+  return !!window.SharedWorker;
+});
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/grunt.js b/profiles/commons/libraries/modernizr/grunt.js
new file mode 100644
index 0000000..c512761
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/grunt.js
@@ -0,0 +1,69 @@
+/*global module */
+module.exports = function( grunt ) {
+    'use strict';
+
+    grunt.initConfig({
+        meta: {
+          version: '2.7.0',
+          banner: '/*!\n' +
+            ' * Modernizr v<%= meta.version %>\n' +
+            ' * www.modernizr.com\n *\n' +
+            ' * Copyright (c) Faruk Ates, Paul Irish, Alex Sexton\n' +
+            ' * Available under the BSD and MIT licenses: www.modernizr.com/license/\n */'
+        },
+        qunit: {
+            files: ['test/index.html']
+        },
+        lint: {
+            files: [
+                'grunt.js',
+                'modernizr.js',
+                'feature-detects/*.js'
+            ]
+        },
+        min: {
+            dist: {
+                src: [
+                    '<banner:meta.banner>',
+                    'modernizr.js'
+                ],
+                dest: 'modernizr.min.js'
+            }
+        },
+        watch: {
+            files: '<config:lint.files>',
+            tasks: 'lint'
+        },
+        jshint: {
+            options: {
+                boss: true,
+                browser: true,
+                curly: false,
+                devel: true,
+                eqeqeq: false,
+                eqnull: true,
+                expr: true,
+                evil: true,
+                immed: false,
+                laxcomma: true,
+                newcap: false,
+                noarg: true,
+                smarttabs: true,
+                sub: true,
+                undef: true
+            },
+            globals: {
+                Modernizr: true,
+                DocumentTouch: true,
+                TEST: true,
+                SVGFEColorMatrixElement : true,
+                Blob: true
+            }
+        }
+    });
+
+    grunt.registerTask('default', 'min');
+
+    // Travis CI task.
+    grunt.registerTask('travis', 'qunit');
+};
diff --git a/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.ai b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.ai
new file mode 100644
index 0000000..60874e0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.ai	
@@ -0,0 +1,291 @@
+%PDF-1.5%
+1 0 obj<</Metadata 2 0 R/OCProperties<</D<</ON[5 0 R]/Order 6 0 R/RBGroups[]>>/OCGs[5 0 R]>>/Pages 3 0 R/Type/Catalog>>endobj2 0 obj<</Length 18095/Subtype/XML/Type/Metadata>>stream
+<?xpacket begin="" id="W5M0MpCehiHzreSzNTczkc9d"?>
+<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 5.0-c060 61.134777, 2010/02/12-17:32:00        ">
+   <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
+      <rdf:Description rdf:about=""
+            xmlns:xmp="http://ns.adobe.com/xap/1.0/"
+            xmlns:xmpGImg="http://ns.adobe.com/xap/1.0/g/img/">
+         <xmp:CreatorTool>Adobe Illustrator CS5</xmp:CreatorTool>
+         <xmp:CreateDate>2011-03-28T13:28:59+11:00</xmp:CreateDate>
+         <xmp:MetadataDate>2011-03-28T13:28:59+11:00</xmp:MetadataDate>
+         <xmp:ModifyDate>2011-03-28T13:28:59+11:00</xmp:ModifyDate>
+         <xmp:Thumbnails>
+            <rdf:Alt>
+               <rdf:li rdf:parseType="Resource">
+                  <xmpGImg:width>256</xmpGImg:width>
+                  <xmpGImg:height>40</xmpGImg:height>
+                  <xmpGImg:format>JPEG</xmpGImg:format>
+                  <xmpGImg:image>/9j/4AAQSkZJRgABAgEBLAEsAAD/7QAsUGhvdG9zaG9wIDMuMAA4QklNA+0AAAAAABABLAAAAAEA&#xA;AQEsAAAAAQAB/+4ADkFkb2JlAGTAAAAAAf/bAIQABgQEBAUEBgUFBgkGBQYJCwgGBggLDAoKCwoK&#xA;DBAMDAwMDAwQDA4PEA8ODBMTFBQTExwbGxscHx8fHx8fHx8fHwEHBwcNDA0YEBAYGhURFRofHx8f&#xA;Hx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8f/8AAEQgAKAEAAwER&#xA;AAIRAQMRAf/EAaIAAAAHAQEBAQEAAAAAAAAAAAQFAwIGAQAHCAkKCwEAAgIDAQEBAQEAAAAAAAAA&#xA;AQACAwQFBgcICQoLEAACAQMDAgQCBgcDBAIGAnMBAgMRBAAFIRIxQVEGE2EicYEUMpGhBxWxQiPB&#xA;UtHhMxZi8CRygvElQzRTkqKyY3PCNUQnk6OzNhdUZHTD0uIIJoMJChgZhJRFRqS0VtNVKBry4/PE&#xA;1OT0ZXWFlaW1xdXl9WZ2hpamtsbW5vY3R1dnd4eXp7fH1+f3OEhYaHiImKi4yNjo+Ck5SVlpeYmZ&#xA;qbnJ2en5KjpKWmp6ipqqusra6voRAAICAQIDBQUEBQYECAMDbQEAAhEDBCESMUEFURNhIgZxgZEy&#xA;obHwFMHR4SNCFVJicvEzJDRDghaSUyWiY7LCB3PSNeJEgxdUkwgJChgZJjZFGidkdFU38qOzwygp&#xA;0+PzhJSktMTU5PRldYWVpbXF1eX1RlZmdoaWprbG1ub2R1dnd4eXp7fH1+f3OEhYaHiImKi4yNjo&#xA;+DlJWWl5iZmpucnZ6fkqOkpaanqKmqq6ytrq+v/aAAwDAQACEQMRAD8A9U4q7FXYq+TfzF/5TvXf&#xA;+YyX/iWZmL6Q+o9k/wCK4/6oTP8AJn/yZWj/APRz/wBQsuOX6S4/b/8Aic/83/dBJ/OU00PnfX3h&#xA;do3GpXdGQlT/AH79xhiLiHK0EQdNjBF+iP8AuQitE/M3zvo7L9W1WaWJf90XJ9eMjwpJyKj/AFSM&#xA;BxRLVqOx9Nl5wAPeNvueu+Svzz0fVpEstcjXTL1zxScEm2c+5O8Z/wBao98oniIeV7Q9nMmIcWI8&#xA;cft/b+NnqAIIBBqDuCOlMqebdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdi&#xA;rsVdirsVYv588+Wfk+ztbm5tZLpbqRolWJlUgqvKp5ZKMTI0HZdm9my1cjGJAoML/wChi9E/6tFz&#xA;/wAHHlngF3H+hXL/AD4/a8a8z6tFrHmHUNUijaKO9neZY2ILKHNaGmZEI0Keu0eA4sMYHcxFMi/J&#xA;n/yZWj/9HP8A1Cy5HL9JcDt//E5/5v8Augknnf8A5TTX/wDtpXf/ACffJQ5BzOzv8Wx/1I/cEkyT&#xA;mOxV6r+Un5qz6Vcw6FrcxfSZSEtbhzU27E7Asf8AdZ/4X5ZRlx9Q8x252KMgOXEPWOY7/wBv3voD&#xA;ruMxnhXYqwvz7+Z1h5Ou7W2urKW6a6jaRWiZVACtxoeWThAy5O37N7Inq4kxkBw97KNH1S11bSrT&#xA;U7U1t7yJJo/EBhWh9x0OQIp1ufDLFMwlziaXapqVtpmm3Wo3Tcbe0ieaU/5KCu3ucUYcRyTEI85G&#xA;mK+QvzOsPON3dW1rZS2rWsayM0rKwIZuNBxyc4GPN2faXZE9JEGUgeLuZpkHUOxV2KuxVjvnrzpa&#xA;+UNIh1K5tnuo5rhbYRxkKQWR3r8X/GPJRiZHZ2HZ3Z8tVkMIkChf3frT+GQSwpKBQOoYD5iuRcCQ&#xA;o0vxQ7FXYq7FXYq7FWOecPPug+UhZHVfV/052WL0UD0EfHm7VK7LzHSp9slGBPJ2Gh7Ny6ri8OvT&#xA;3sjyLr3Yq7FXYq7FXkf/ADkX/wAcTSP+Yl/+TeXYOb1Xsr/ez/q/peDZlPbuxVm35M/+TK0f/o5/&#xA;6hZcry/SXT9v/wCJz/zf90Ek87/8ppr/AP20rv8A5Pvkocg5nZ3+LY/6kfuCSZJzHYq7FX0h+Sfn&#xA;GTXPLjaddyc9Q0njEWY1Z4GB9JjXqRQqfkPHMPLCi+e+0GgGHNxx+me/x6/rei5W6B41+c9hDqHn&#xA;zylp89fRvHSCWnXjLcKjU+g5diOxeu7AyHHps0xziL+USnH5K6jc2kOq+T9Qal7olw/pKe8TsQ3H&#xA;2Em/+yGRyd/e4ntBiEjDUQ+nIPt/s+5d+dmqXMthpvlSwNb/AF24RGQf76RhStOgaQr9AOOMb33I&#xA;9n8IE5Z5/TjH2/2JV+UOmQaX5+806bb/ANzZqsCE9SI5ONT86YchsBye3Mxy6XDM85bsq88fmSmg&#xA;39voml2Tar5guwDFaISFQN9kuQCamleI7bkjIxhe/R1nZ3ZJzxOScuDFHqkd3+YH5oaDGNQ8yeWo&#xA;DpOxlks5PjiBNPjpJMNvcAe+S4InkXNh2Zos54MOU8f9Ic/sD0PRNc03WtKg1TT5RJZ3C8lY7EU2&#xA;ZWHYqdjlZFOh1GnnhmYTFSDz2f8ANPzRrmsXGn+RdGj1CC1bjLqFySIjvTkKPEApp8NWqfDLOAD6&#xA;nex7Gw4cYnqpmJl/COf3H7mK/mz5q8wXvlq30jzHo7aXqkd6lxHJG3qW00SxSoxRwWAKl1+Hkcni&#xA;AvYuz7E0eKGY5MM+OHDXcQbD2e81jT9G8vfpPUJPStLaBXkbqT8IAVR3ZjsBmOBbyOPBPLl4IC5E&#xA;sGtPPX5n6/F+kPLnly2TSWY+hJfSUklUGlV/eRAdPAj3OWGMRzLusnZ2iwHgzZZcfXhGw+wp55K/&#xA;ME63fXGi6vYtpHmG0HKWyckh0/njJp49PDcEjBKNb9HC7Q7M8GIyY5ceKXX9aC85/miPK/m6z0i4&#xA;s/Wsbi0+svLHVpvUYyrHGidDyeNRv44Y47Ft2g7H/M4JZBKpCVeXSyfgUb5a8z+cr6DVL3WtEXSr&#xA;OCD1tPjZiZHIDFhIa16AfsDIyAHItOr0mngYRx5OORNS7vh/axvQfzb80+YrD09D8u/WtVVyJ2L8&#xA;LSGPbiWdivJjv8NRk5Y6O5dhqexMOnl+9ycMOm3qPwROi/mX5qtfNVp5d85aRDYTX5C2lxbE8CzE&#xA;hOryhgzfDs2x7YDAVYLXqOycEsBzaeZkI8wf7B9ybfmZr9tpH6E9fS7XU/rd6sSfWkD+kxp+8jqD&#xA;RsjEXfucXsnTSy+JU5Q4Y3t18imvnDV/NenRWreXtIXVnkZxcK0gj4AAcTuVrXfBEDqXG0ODBkJ8&#xA;WfB3bWwnWvzO/MbRLI3uq+V4LS1DBPUe4BqzdAArEn6BlggCaBdxp+x9JmlwwymUv6rLdK826pc/&#xA;l9N5nvLFba6S0uLyO0qeLJErPGanejhQfpyHDvTq82ihHVDBGVx4hG/fz+TE7D82/Neu6XD/AIb8&#xA;um91MBjfSMWFrC3NgiBiU5sUAY/EOuTOMA7l2mXsTBgmfGycMOn849/fW+3J5H/ysXz3/wBX28/5&#xA;Gtl/hR7nqv5J0v8AqcfkgNW8z+YdYiji1TUJ72OJi0azOXCsRSorkowA5N+DR4cRuEREnuSvJOS7&#xA;FWbfkz/5MrR/+jn/AKhZcry/SXT9v/4nP/N/3QSTzv8A8ppr/wD20rv/AJPvkocg5nZ3+LY/6kfu&#xA;CSZJzHYq7FWd/krrL6d59s4uREOoK9rKP9Zeabf66LlWYel0ntBgGTSk9Y0f1/Y+msxHzl5H+an/&#xA;AJM3yR/zEwf9RaZdj5F6rsX/ABPP/VP+5Kp55/51P8zdG82J8Fhqg+p6mR0qAELN/sOLf7DBHeJD&#xA;Ds7/AArRzwfxQ9Ufx8/m35SH+LvzU1XzK/x6bog+p6ceql90DD/h3/2QxltEDvXW/wCC6GGH+PJ6&#xA;pfj5D4L/AMuf/Jqedf8AjIf+TxwS+kI7V/xLB7v0KX5fIlz+bnnC6vBW9gZ47YNQkRCXhyH+wRB8&#xA;jhn9IZdpnh0GGMfpPP31+u3ql5bW9zaTW1yoe2mjaOZW6FGBDA19sqeahMxkCOYeK/lrd3cX5V+c&#xA;BbOzQ24ujayGtRW3+IjwoAGy/IPUHr+1oROuw8XM8N/6ZmP5H21pF+XtnJCAJbiWeS5I6mQSsgr/&#xA;ALBFyGX6nU+0U5HVyB5ACvlf32lv/OQwH+DLI03/AEjHv/zwmyWDm5Hst/jEv6h++KF/Pee4TyRp&#xA;ESVEEtxH61DSpWFiqn8T9GDDzbfZuIOpmeoifvTu11b81IbaGG28s2C28aKkKreLxCKKKBv0pkKH&#xA;e4M8GiJJOWd/1Ur/AEF+YepeftF8x32kW+nrZfubp4LhHLwtyB5CtTQOclYAIcr8zpMelnhjOUuL&#xA;cXHqu8xxo/5++WldQyjTnYBhUVVbtlO/cEVGSj9BXSkjsvLX8/8A4h6Lrf8Axxr/AP5hpf8AiByl&#xA;5/B/eR94YH+QX/KCt/zGzf8AEUyzL9Tu/aX/ABr/ADR+lD/myq/42/L5qDkdRoT3oJ7Wn68lj5Ft&#xA;7E/xbU/1P97Nd+d3/TMf9tJf4ZHH19zH2e/yv/Cy9LmmighkmmcRwxKXkkY0VVUVJJPYDK3nYxJN&#xA;DmXkFlFcfmj5yN9OrDybokhWCJqgXEnXcf5fVvBaDvlx9A8y9XkI7N0/CP8AGMnP+iPx9vuej+dl&#xA;VfJOvKoAUabdgAbAAQPlcOYef7P/AMZx/wBeP+6CSfkuiL+W2klVALm5LkClT9ZkFT9AAyWX6i5v&#xA;b5/wyf8Am/7kPFv+VM/mV/1Z/wDp5tf+quZHix73sP5f0f8AP/2Mv1O/5Uz+ZX/Vn/6ebX/qrj4s&#xA;e9f5f0f8/wD2Mv1O/wCVM/mV/wBWf/p5tf8Aqrj4se9f5f0f8/8A2Mv1O/5Uz+ZX/Vn/AOnm1/6q&#xA;4+LHvX+X9H/P/wBjL9TKPyy/LLzvovnfTdT1PTfq9jb+v603r270528iL8KSMxqzAbDIZMgIoOs7&#xA;X7X02bTShCVyNdJfzgeoSvzV+Uv5g33mfV7210r1LW6vbmaCT6xbLyjklZlNGkBFQe4wxyRADlaL&#xA;tvSQwwjKfqjGIO0ug9yV/wDKmfzK/wCrP/082v8A1VyXix73J/l/R/z/APYy/U7/AJUz+ZX/AFZ/&#xA;+nm1/wCquPix71/l/R/z/wDYy/U7/lTP5lf9Wf8A6ebX/qrj4se9f5f0f8//AGMv1Jn5X/Kn8xdN&#xA;8y6VqE2klIbS8gmmYXNttGkis/2ZCfsg9BkZZIkFxtZ21pMmGcBPeUSPpl3e59GZivn7zrz/AOUv&#xA;MGreevK2qafa+tY6bPE97N6kacFS4V2PF2Vm+EV+EHLISABd/wBma3Fi02aEzUpg1sf5pDIPzF8r&#xA;t5l8pXumxKGvABNZVIH76PdRU7DkKrv45GEqNuD2VrPy+eMz9PI+4/i1P8tPKr+WfKVrY3EYjv5S&#xA;Z74Aq1JX/ZqtQeKgLse2GcrNsu19b+YzmQ+nkPd+N0p8leVtd03z/wCaNVvbX0rDUXJs5ucbcx6h&#xA;b7KsWXb+YDGRFBye0NZiyaXFjiblDnz7kN5z8keZLXzQnnLycY21MrwvrCQhVmAAFRUqp5KAGFR0&#xA;qDXDGQqi2aDtDDLD+X1F8HSXcgdU1b84fMlm2j2+gJoqXI9K7v5JRsjbNxNagH/JDHCBEb3bfhwd&#xA;n6eXiHJ4lco1+P0M28p+TdO8v+WF0JP38Tq/1yRhT1XlFJCR2BGwHhkJSs26bW6+efN4p2PTyrk8&#xA;/wBL0X8yPy+vrq10WxGveXrmQyQxcwroT9NVamx2INO2WExlz2Lvc2o0euiJZJeFlA380N530D82&#xA;vOWlQyXGnQ2tvFOrQaNHLH6m6ODPLJI6r8P2Qta/F0wwlGJbOztToNJkIEjIkbzo102AA/Fc3pPm&#xA;jynbeZPKraLdn0nKIYpgORimjHwt138D7ZTGVG3ntHrTp8/iR3/SGGaTqv5t+WLRNIu9AXXYLZfT&#xA;tL2CYKSiii8jRiae6g/rywiJ3unb58Og1EvEjk8InmCGR+UH/Ma91WbUfMcdvp2mtF6dvpMdJJA3&#xA;KokZwWoae/0DISro6/XDSQgIYSZzveXIe6vx70HrHlnXLj83tD8wQ23LSLOyeG5uecY4yFbkAcCw&#xA;c/3q9F75ISHAQ3YNZijoMmIn95KVgb/0fh0LM9Uhkn0y7hiHKWWGREWoFWZCAKnbrlbqMMgJgnoQ&#xA;xL8ovLms+X/KbWGr2/1a7NzJL6fNJPgZVANY2de3jk8hBOztO3NVjz5+PGbjwjv/AEqP5h+Wdc1f&#xA;zP5OvdOtvXtdKvTNfyc409OP1YGrR2UttG32QcMJAAs+y9ZixYc0ZmpTjUee+0v1t/mn5Z1vXP0F&#xA;+i7b6x9SvlnufjjTjGKfF+8Za/Rggav3I7H1ePD4nGa4oUOfP4O/N7SfOWsaHBpnlyD1o7hz+kQJ&#xA;I4m9NQCi1kdNmbrTww4yAd09h5tPiymeY1X07E7/AACR6DP+b2h6Tb6Xp/lCyjtbZeK/6TFyY9Wd&#xA;j6+7MdzhIiermamOgzZDOeaXEf6J/wCJZfInmjWPIOpwapYR2mu3lndwLZRSIy8nR0iAfmy/FUdW&#xA;yIoSdVE4cWqiYS4scZRN15i9qd+WWi6lovkjTdM1OH6vfW/r+tDyR6c7iR1+JCymqsDscchs2F7X&#xA;1EM2plOBuJr/AHIHV//Z</xmpGImg:image>
+               </rdf:li>
+            </rdf:Alt>
+         </xmp:Thumbnails>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:photoshop="http://ns.adobe.com/photoshop/1.0/">
+         <photoshop:ColorMode>3</photoshop:ColorMode>
+         <photoshop:ICCProfile>sRGB IEC61966-2.1</photoshop:ICCProfile>
+         <photoshop:TextLayers>
+            <rdf:Bag>
+               <rdf:li rdf:parseType="Resource">
+                  <photoshop:LayerName>Modernizr</photoshop:LayerName>
+                  <photoshop:LayerText>Modernizr</photoshop:LayerText>
+               </rdf:li>
+            </rdf:Bag>
+         </photoshop:TextLayers>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:dc="http://purl.org/dc/elements/1.1/">
+         <dc:format>application/pdf</dc:format>
+         <dc:title>
+            <rdf:Alt>
+               <rdf:li xml:lang="x-default">Modernizr 2 Logo</rdf:li>
+            </rdf:Alt>
+         </dc:title>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"
+            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"
+            xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#">
+         <xmpMM:InstanceID>uuid:d2ad3950-7c02-824a-aed8-40a8f4f3f557</xmpMM:InstanceID>
+         <xmpMM:DocumentID>xmp.did:03801174072068118083F1FA8E5E4F1F</xmpMM:DocumentID>
+         <xmpMM:OriginalDocumentID>xmp.did:F77F117407206811BB3F9C0632107F53</xmpMM:OriginalDocumentID>
+         <xmpMM:RenditionClass>proof:pdf</xmpMM:RenditionClass>
+         <xmpMM:History>
+            <rdf:Seq>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>created</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F77F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T17:17:50-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F87F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T17:18:53-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F97F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:02:32-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FA7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:18:57-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FB7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:25:21-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FC7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:26:04-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FD7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:37:06-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>converted</stEvt:action>
+                  <stEvt:parameters>from application/vnd.adobe.photoshop to application/pdf</stEvt:parameters>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>derived</stEvt:action>
+                  <stEvt:parameters>converted from application/vnd.adobe.photoshop to application/pdf</stEvt:parameters>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FE7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:37:07-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:03801174072068118083F1FA8E5E4F1F</stEvt:instanceID>
+                  <stEvt:when>2011-03-28T13:28:58+11:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Illustrator CS5</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+            </rdf:Seq>
+         </xmpMM:History>
+         <xmpMM:DerivedFrom rdf:parseType="Resource">
+            <stRef:instanceID>uuid:edd0f61a-a49d-1d49-acc4-68ea7894e484</stRef:instanceID>
+            <stRef:documentID>xmp.did:F77F117407206811BB3F9C0632107F53</stRef:documentID>
+            <stRef:originalDocumentID>xmp.did:F77F117407206811BB3F9C0632107F53</stRef:originalDocumentID>
+         </xmpMM:DerivedFrom>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:pdf="http://ns.adobe.com/pdf/1.3/">
+         <pdf:Producer>Adobe PDF library 9.90</pdf:Producer>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:xmpTPg="http://ns.adobe.com/xap/1.0/t/pg/"
+            xmlns:stDim="http://ns.adobe.com/xap/1.0/sType/Dimensions#"
+            xmlns:xmpG="http://ns.adobe.com/xap/1.0/g/">
+         <xmpTPg:NPages>1</xmpTPg:NPages>
+         <xmpTPg:HasVisibleTransparency>False</xmpTPg:HasVisibleTransparency>
+         <xmpTPg:HasVisibleOverprint>False</xmpTPg:HasVisibleOverprint>
+         <xmpTPg:MaxPageSize rdf:parseType="Resource">
+            <stDim:w>600.000000</stDim:w>
+            <stDim:h>88.799805</stDim:h>
+            <stDim:unit>Pixels</stDim:unit>
+         </xmpTPg:MaxPageSize>
+         <xmpTPg:PlateNames>
+            <rdf:Seq>
+               <rdf:li>Cyan</rdf:li>
+               <rdf:li>Magenta</rdf:li>
+               <rdf:li>Yellow</rdf:li>
+            </rdf:Seq>
+         </xmpTPg:PlateNames>
+         <xmpTPg:SwatchGroups>
+            <rdf:Seq>
+               <rdf:li rdf:parseType="Resource">
+                  <xmpG:groupName>Default Swatch Group</xmpG:groupName>
+                  <xmpG:groupType>0</xmpG:groupType>
+               </rdf:li>
+            </rdf:Seq>
+         </xmpTPg:SwatchGroups>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:illustrator="http://ns.adobe.com/illustrator/1.0/">
+         <illustrator:Type>Document</illustrator:Type>
+      </rdf:Description>
+   </rdf:RDF>
+</x:xmpmeta>
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                           
+<?xpacket end="w"?>endstreamendobj3 0 obj<</Count 1/Kids[7 0 R]/Type/Pages>>endobj7 0 obj<</ArtBox[0.0 1.36328 583.011 88.7998]/BleedBox[0.0 0.0 600.0 88.7998]/Contents 8 0 R/LastModified(D:20110328132859+11'00')/MediaBox[0.0 0.0 600.0 88.7998]/Parent 3 0 R/PieceInfo<</Illustrator 9 0 R>>/Resources<</ExtGState<</GS0 10 0 R>>/Properties<</MC0 5 0 R>>>>/Thumb 11 0 R/TrimBox[0.0 0.0 600.0 88.7998]/Type/Page>>endobj8 0 obj<</Filter/FlateDecode/Length 1080>>stream
+HV$5WTL}e@Vhh1,KDYK|83"^~~u/^}['cyq|s
+,'pk{}1<|m|C"8V<#n)#T}Uz|i ~#ry1cM|mE{M^
+'8_U}Kpo(/l'&^h^bv+.:L\>	VH}PZaY}I-Y9{p1u#B F_WSa4dM(N}Gj"B6eu}z#]pb
+[RLRxy8nB%?\	fiKGDL&nK>kk9
+bQ|*6rFFu|Ek""#b |edt%c:Z&pT-A-OM7E>Ch=k^5Ip_]
+A##y0-bEN6	7p6RckFwJqgL~h[B_AyX"H<G,%#D5Mg7Eg LV,pFP8 RW(,HNY5UCV433Zwd)#AW7,Pm!?-[&~6PtUfWdv1X =GI*Qfyt@>5=9R)ER@598-FlF19'NOEY/A0euT1_0,uwgIvyA4?dl
+/-G!N{S:	Z#rtg\fgLdW/hAGrZ 
++6;a3F@e?~ 0endstreamendobj11 0 obj<</BitsPerComponent 8/ColorSpace 12 0 R/Filter[/ASCII85Decode/FlateDecode]/Height 11/Length 217/Width 75>>stream
+8;X.*5o.B]#Xe'qAYk1P*4a@.!l]_ep/*-_RXPW`fG[D6f.h*1a7H@op([&VW*Y^*
+W0WFo2Q9;Fb+MFP43tonNU43q7k''P:'9+35"AmKh.O9'J#%\IT$_Z*W;Z'Oj7LaA
+9^>Zd/+=U[R&s-+Brt<DrD5OMUCQS3iH5`HV"Ec'MamVcE^1X21/>.'Lp'%G5RL>:
+;0"gleOf`E!,b_4ci~>endstreamendobj12 0 obj[/Indexed/DeviceRGB 255 13 0 R]endobj13 0 obj<</Filter[/ASCII85Decode/FlateDecode]/Length 428>>stream
+8;X]O>EqN@%''O_@%e@?J;%+8(9e>X=MR6S?i^YgA3=].HDXF.R$lIL@"pJ+EP(%0
+b]6ajmNZn*!='OQZeQ^Y*,=]?C.B+\Ulg9dhD*"iC[;*=3`oP1[!S^)?1)IZ4dup`
+E1r!/,*0[*9.aFIR2&b-C#s<Xl5FH@[<=!#6V)uDBXnIr.F>oRZ7Dl%MLY\.?d>Mn
+6%Q2oYfNRF$$+ON<+]RUJmC0I<jlL.oXisZ;SYU[/7#<&37rclQKqeJe#,UF7Rgb1
+VNWFKf>nDZ4OTs0S!saG>GGKUlQ*Q?45:CI&4J'_2j<etJICj7e7nPMb=O6S7UOH<
+PO7r\I.Hu&e0d&E<.')fERr/l+*W,)q^D*ai5<uuLX.7g/>$XKrcYp0n+Xl_nU*O(
+l[$6Nn+Z_Nq0]s7hs]`XX1nZ8&94a\~>endstreamendobj5 0 obj<</Intent 14 0 R/Name(Layer 1)/Type/OCG/Usage 15 0 R>>endobj14 0 obj[/View/Design]endobj15 0 obj<</CreatorInfo<</Creator(Adobe Illustrator 15.0)/Subtype/Artwork>>>>endobj10 0 obj<</AIS false/BM/Normal/CA 1.0/OP false/OPM 1/SA true/SMask/None/Type/ExtGState/ca 1.0/op false>>endobj9 0 obj<</LastModified(D:20110328132859+11'00')/Private 16 0 R>>endobj16 0 obj<</AIMetaData 17 0 R/AIPrivateData1 18 0 R/AIPrivateData2 19 0 R/ContainerVersion 11/CreatorVersion 15/NumBlock 2/RoundtripStreamType 1/RoundtripVersion 15>>endobj17 0 obj<</Length 969>>stream
+%!PS-Adobe-3.0 %%Creator: Adobe Illustrator(R) 15.0%%AI8_CreatorVersion: 15.0.2%%For: (Marc Edwards) ()%%Title: (Modernizr 2 Logo.pdf)%%CreationDate: 28/03/11 1:28 PM%%Canvassize: 16383%%BoundingBox: -1 1 584 89%%HiResBoundingBox: -0.000488 1.36328 583.0107 88.7998%%DocumentProcessColors: Cyan Magenta Yellow%AI5_FileFormat 11.0%AI12_BuildNumber: 399%AI3_ColorUsage: Color%AI7_ImageSettings: 0%%CMYKProcessColor: 1 1 1 1 ([Registration])%AI3_Cropmarks: 0 0 600 88.7998%AI3_TemplateBox: 299.5 44.5 299.5 44.5%AI3_TileBox: -103 -235.0996 680 323.8999%AI3_DocumentPreview: None%AI5_ArtSize: 14400 14400%AI5_RulerUnits: 6%AI9_ColorModel: 2%AI5_ArtFlags: 0 0 0 1 0 0 1 0 0%AI5_TargetResolution: 800%AI5_NumLayers: 1%AI9_OpenToView: -70.5 304 2 1572 1032 26 0 0 66 96 0 0 0 1 1 0 1 1 0 1%AI5_OpenViewLayers: 7%%PageOrigin:228 -28%AI7_GridSettings: 144 144 144 144 1 0 0.8 0.8 0.8 0.9 0.9 0.9%AI9_Flatten: 1%AI12_CMSettings: 00.MS%%EndCommentsendstreamendobj18 0 obj<</Length 5017>>stream
+%%BoundingBox: -1 1 584 89%%HiResBoundingBox: -0.000488 1.36328 583.0107 88.7998%AI7_Thumbnail: 128 20 8%%BeginData: 4872 Hex Bytes%0000330000660000990000CC0033000033330033660033990033CC0033FF%0066000066330066660066990066CC0066FF009900009933009966009999%0099CC0099FF00CC0000CC3300CC6600CC9900CCCC00CCFF00FF3300FF66%00FF9900FFCC3300003300333300663300993300CC3300FF333300333333%3333663333993333CC3333FF3366003366333366663366993366CC3366FF%3399003399333399663399993399CC3399FF33CC0033CC3333CC6633CC99%33CCCC33CCFF33FF0033FF3333FF6633FF9933FFCC33FFFF660000660033%6600666600996600CC6600FF6633006633336633666633996633CC6633FF%6666006666336666666666996666CC6666FF669900669933669966669999%6699CC6699FF66CC0066CC3366CC6666CC9966CCCC66CCFF66FF0066FF33%66FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF%9933009933339933669933999933CC9933FF996600996633996666996699%9966CC9966FF9999009999339999669999999999CC9999FF99CC0099CC33%99CC6699CC9999CCCC99CCFF99FF0099FF3399FF6699FF9999FFCC99FFFF%CC0000CC0033CC0066CC0099CC00CCCC00FFCC3300CC3333CC3366CC3399%CC33CCCC33FFCC6600CC6633CC6666CC6699CC66CCCC66FFCC9900CC9933%CC9966CC9999CC99CCCC99FFCCCC00CCCC33CCCC66CCCC99CCCCCCCCCCFF%CCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0033FF0066FF0099FF00CC%FF3300FF3333FF3366FF3399FF33CCFF33FFFF6600FF6633FF6666FF6699%FF66CCFF66FFFF9900FF9933FF9966FF9999FF99CCFF99FFFFCC00FFCC33%FFCC66FFCC99FFCCCCFFCCFFFFFF33FFFF66FFFF99FFFFCC110000001100%000011111111220000002200000022222222440000004400000044444444%550000005500000055555555770000007700000077777777880000008800%000088888888AA000000AA000000AAAAAAAABB000000BB000000BBBBBBBB%DD000000DD000000DDDDDDDDEE000000EE000000EEEEEEEE0000000000FF%00FF0000FFFFFF0000FF00FFFFFF00FFFFFF%524C45FD0CFFCA8EB78EB78EB7FFCA8EB794C3C4FD72FFA1958E948E9594%FFA1958E948E958E9BA1FD6FFFCA8EB794958EB7FFC48EB794958EB78E95%94CAFD6DFFA1948E958E948EFFA1948E958E948E958E948EC3FD6CFFCA8E%B794B78EB7FFC48EB794B78EB794B78EB78EBDCAFD6AFFA2948E958E9494%FFA1948E958E948E958E948E958E95A8FD63FFC49BC39BBD9BBD8E958EB7%8E95FFC48E958EB794958EB794958EB78EBDCBFD09FFCABD9BCBFD06FFCA%BD9BCBFD13FFCA9BFD1EFFCAA2FD16FF9A948E948E948E958E948E9494FF%A1948E948E958E948E958E948E958E9BFD09FFCA8E949BFD06FFA18E94A2%FD13FF9B94A8FD1DFF8E94A8FD15FFBD8EB794B78EB794B78EB78EB7FFCA%8EB78EB794B78EB794B78EB794B78ECAFD08FFCAB78EB7CBFD05FF94B78E%CAFD13FFC48EFD1EFFCAA2FD16FF9B948E958E948E958E948E9594FFA195%8E948E958E948E958E948E958E948EFD08FFCA8E9B8EC4FD04FFA1949B95%A8FD04FFCAA1C4A2FD07FFA1C3A1FFA194A8FD04FFCA9BC3A8FD05FFA8FF%A8C4CAFFA2FFFFC49BC4CAFFFFFFCAFFFFFFA8CAA2CAA2CAA2FFFFCBA2FF%CAC4FD06FFC38E958EB794958EB794958EB7FFC48EB794958EB794958EB7%94958EB794959BFD07FFA8B7A1BD94FD04FFBD9BCA8ECAFFFFFFC38E958E%B795FD04FFCB94B7949594C38EFFFFFFCBBD8EB794959BFFFFFFA1B7A195%8EFFCA959BBD94958EBDFFFFFFBD9BFFFFBD8E958EB78E95CAFFA195A1B7%8EFD06FF9B948E948E958E948E958E948EFFA1948E958E948E958E948E95%8E948E958E94A8FD06FFCA8EC4A294A2FFFFCA8EC4A294A2FFFF9B8EC4FF%FFA19494FFFFFF9494A1FFCBC48E95A8FFCA9B8ECAFFFFA1949BFFFFC38E%95A1CBFFCA8E94A1FFFFC38EC4FFFF949BFFFFA8CBA8FFA1949BFFFFC48E%95A1FFCAA2CAC4CAA2BD8EB78EB794B78EB794B78EB7FFC48EB794B78EB7%94B78EB794B78EB794B78ECAFD06FFCAB7A1FF8EC3FFFF9BB7FFCA8ECBFF%FF8EC4FD04FFC495A1FFC495A1FD04FFC48EFFFFCA8ECBFD04FFA1B7FFFF%A1B7CAFFFFFFCA95A2FD04FFB7A1FFFFBD9BFD06FFB794FFFFFFA1B7CAFF%FF8E948E958E948E958E948E958E948E958E9494FFA1948E958E948E958E%948E958E948E958E9494FD06FFCA8EC4FFC38EFFFF949BFFA194A2FFA194%A2FD05FF8E9BFFC38EFD05FFA195CAFF9B95A2CAA2CAA8C38ECAFFC38EFD%04FFCA8EC4FD04FF8EC4FFFF94BDFD05FF9B8ECBFFFFFFC48EFFFFFFB78E%958EB78E958EB794958EB794958EB78E95FFC48E958EB794958EB794958E%B794958EB78E95CAFD05FFCA95A1FFCA95A1CA8ECAFFCA8ECAFFC48EFD06%FFBD9BFF9BB7FD05FFC48EFFFFBD8EBD95BD94BD95BDA2FFA195FD04FFA8%B7C4FD04FF95A1FFFFBD9BFD04FFC48EC4FD04FFA1B7FFFFFF8E958E948E%958E948E958E948E958E948E9494FFA1948E948E958E948E958E948E958E%948E948ECAFD05FFCA8EC3FFFF9495949BFFFFA194A2FFA194A2FD05FF8E%C3FFC38EFD05FFA194A8FF9B94A8FFFFFFA8FD04FFC48EFD04FFCA8EC4FD%04FF8EC3FFFF949BFFFFFFCA8EBDFD05FFC38EFFFFFFB794B78EB794B78E%B794B78EB794B78EB78EB7FFCA8EB78EB794B78EB794B78EB794B78EB794%B7A1FD05FFCA95A1FFFFCA8EB7C4FFFFCA8ECAFFFF8EBDFD04FFA1B7C4FF%CAB7A1FD04FFC38EFFFFCA8EC4FD08FFA1B7FD04FFCAB7C4FD04FFB7A1FF%FFBD9BFFFFFF94BDFD06FFA1B7FFFFFF8E958E948E958E948E958E948E95%8E948E9594FFA1958E948E958E948E958E948E958E948E958EC3FD05FFCA%8EC3FFFFFF958EFFFFFFA195A8FFFFC48E9BA8CBA1949AFFFFFF94949BCB%A8BD8E94A8FFFF9B8EC4CAFFA2959BFFFFC48EFD04FFCA8ECAFD04FF8EC3%FFFF949BFFFF9B949BCAA1C4A1FFFFC38EFFFFFF9594B7949594B7949594%B7949594B7949594BDFFC48EB7949594B7949594B7949594B7949594B7A1%FD05FFCAB7A1FFFFFFA1C3FFFFFFCA8ECBFFFFFFC48E958EB79BFD05FF9B%B78E959BC494FD04FFC38EB794959BFFFFFFA1B7FD04FFCA95A2FD04FFB7%A1FFFFBD9BFFFFBD94958EB78E95CAFFA195FFFFFFCAFFA8FFCAFFA8FFCA%FFA8FFCAFFA8FFCAFFA8FFFFFFA8FFCAFFA8FFCAFFA8FFCAFFA8FFCAFFA8%FD07FFA8FD0BFFCAFD05FFA8CAA8FD07FFA8CAA8FD09FFA2CAA8FD05FFA8%FD05FFCAFD05FFA8FFFFFFA8FFFFFFA8FFCAFFA8FFCAFFFFFFCAFFFFFF%%EndDataendstreamendobj19 0 obj<</Length 21034>>stream
+%AI12_CompressedDataxZ2K(  *
+M**N8ZSSP= yu-o.T*J8N]1!0l0$3K ~<EA.8VDi:
+*u#?#Qxq3Ej l?UQrg\
+|.<C::5r<+`QL@`:
+>,l*r n:l0c|~V?h=q:-ciZtFpw nWC9`?tEB ><g3(B$.==+E KT,'?>$F|>?*`4
+-Y!|>L.E@<D$GZT
+:oCQfzixb~_v>  #}3p>S1 ?"2NFp1G7c"p6 	3JN+CFp|	w!>sA_P .g3qtF]_) L1?wg~>0[Mi0B0MUM'q "fjVt# $cUesie8OHwag1tF:l% 	nbBxQg,33wx=}R(x5+S0bR1atRg9!yaa??p0xHAo(^'h*A,&H^v&"9t$0)c	gsg(N,"O :%Lw~`<.MEUvotPw?>|a^`_w$e&/{C:fg[{h4`Qj@!Qa!at7Xd8V~%3)!WUwNmCHTcH#K^asPa@Gj9Csl0Y}Nt3bkMVHcTTI3VZw<Ix(<Um(]xbmt?Z~Fv-Y4T<2Kg"Agp4+!_L#Iso8e XHNwl}oRaGo+SRWY`Au4_Y6$yHw39{)Jcw1X(mx^qA.c; G*rVf{b}|F',7/D2}8z@s'brL.Hwg.LZV5v:OQ{K~:"x6O_6?vcbY>4~:F6up>`VdYu}7;LLTU
+uN?&54o	-eS[PSW~pz3bxk?ql]>x>Fbp&m9Io:qo8{cd'()A=aePX
+v;ghR}0IR[[}z6-m{,J_4A:%GLh8EC\|y<RQ4	\cRsLpyoNAluF'tI{FMC>btOkL~;CGY,Z7:pAo]Md6*vvzch=s6?B!0p,JdI7-d<dqh>k,QvbfL?#*Jp@I&BKk_]*3]R,``"A_"vF`Rb>Xq,Ccwa_XE>:5,M4biOyu<\}d}Hm'}*jCkZ[UvAFt.D3<rhIbl46*R\6,]);GTA{I<Fg1|x((Q9l`=Tuz`!up(H;GVi?DY=?P6j@&O?gI`Q!)MApdTx:D?;TY7quP+;J\gSG`V"<)a;4P4I q
+\Q6/uwIa*Q3~&];a[3 V
+7Q3t^Vs9wQOQF (z%dD#4"iRJyUdKn#l"qk[9DbQ-~vgfj7?FL)a*EH#A	 2"ualO{b`)3:fL8D2t:#H8}K~14vs'(8z-||38|Hl<vQ4we1)(]Vn[,rOsSMHN!= )NR4uxd+,>\:!'L'F\$(m#f?YQ&PP=34d!S_[>agE!0	0W%uqbljh:aQsJ3mL{vL=;l;V(
+;x&$zC9{&D	Kw9oo<3s ?mNZY/N#a;(y7`WTO;!,M6RFvhNT D$kkTuD0,"Q{?M*Lt\$t6TQchc >H
+(tC.fD8v75uSH .|DZgNd d.b^/ TG~PoQ\pXu	e]!?v@a:a;TZ"89?>/]44Hj$98Tn9fYor<D_b|:cT0PAmGt6)'zFJs2U|V0"9ijH"r1Pi3KXNMtr``H07tGCX9KmKS{I`5='l<>h;1Nd~]4n_]<e|Qwz$,[#=JG;s+}<$ruVG=iBQ1i}XS|B_TT"8
+N;!yQK,JzB1AX$53'0QPD3C
+Q< >?(3yuxTF6Y{58~eD3{`bU-3:B@_#-gbingM:7p*	YL34>L+<*:3suC'a=MUtw7;qQzlei-jG.nlTxMmGrhn_yoP:9v!0rg@;B"57<UfY_
+wd(P/K*]O{t]:>"jl?I6;>gv/R_7b=__u]e>CQJ$Pl{7=xbu(~v_%3M=D0tLMt:x9!y<&l-aI''~{TVEz~d^>,IR*oD.1hT9Pt=EgZZ*~>#Gx>@iz*[keS#&9+|CYFc*I;<LTNpx &)qR>dFn6HS6!U'-c>&&`~tb4KRf[iRM=<bZ+1vvH{NE*xU5gk5~[tEs[t mnma2J~bqVrFzI=I$6fuW33i OU?-j'zzY Cont0mmco!~"]Zn&B2aEa|n[Zo+5;1#m(HHiyc},=y"u*@z=SQlu0/Fg72b_H~{{)H:VDlOhHA;I%461~JEv(R>g[)>ME:"4g[QH-v?<C*IuiWM,]dYMGPA%[^E~_+tO24C\A6!?c0_|?U'43RbdJ\G
+299MncT6
+S(c{'4iE	=$dB)%cx-#=m4[9s7,oO/7CBgbT~ZX^Tmqm
+<~kl E{{66y_bBw9+E^gg[!,B{foCe*nC{[BCoOGmTYwJ&}b_Mou=g8yvG=dv-X4}'3:W|^sk'T7?N7_G7;Gi3=:U,HG!~/5K>~6N avKR,>hH&VOe7	YY,*da)(I\09*Uo,?VvxVKEW*1D[xz#O~dsv2|f,7~u*`a-[{j\}VEHStk~v1-[)^Rb|189 %}#TC*64w-B"M]o:Zi1T(Hi	[I$Zx*Rl;P"#t{:RP#MeVq=y0JOSoMXod"Nz*)*bO.*eoIEP<Dr=FonQ.}H
+&$?h:BOYUHwr8jMVtoA2Wyd?2`'~6#8G X2{1){)	KJ\#*}2>lJ?W	d3c_{$Edr}LM|}wb>Eg	!qbw{f=L9K+sk(Lwa;[DC|b@~fQ#@h]6&J|Q:Qh6<LR6|lv6<-60?bDw'45avjS=VXq}<lxZ{>ntu`UMa,6}c;"vd&u=nt~O=],$c9h/">dd<eB0>4#K z}/1OA^\ia3NI2%9ys=.6&[1[3IU*Vk*"V>FnKN}4mWa z~o8*.:?9.*Cr]0V[vfPEHKQE3Bqe3I4S<[fk2\+Uc]7uFout:Swcm+V*G=6vNKQSxv#B>mk	xp:}oKqGamXfS2G$ptw6@aa^A[ _&hvW`, , b[v&`XF=gvM?y]`##Vb\b8b%sb\#$lxH}	?'v%K(Zn w,nusFZC7XZdS	0M'sD!D?_sb9y`T
+In!EGe:S_>3Msv5a6xAetrnz'mprp]1'ONGo4q#;swR
+ N- bPaVGeu>VXTg1U^|UC%yUou\/ yyhpE#&(g|p}LdT<|&:1FEVf] 0ve8vG%er0(NLt$YNF\4%P+}iN@H49"	 %5%^ ~{k@1W8^d3E|&I5%>\dlLXHH9:Db]Tmg^&KU	^S=jf-]{ ];1JY35Q%+jOb+58@P4fZ	Oly75<4.V5V?4mn{E9:kg+ 8[:#cpy/0Zn"(">J`	:4S})=*
+9IY70t~~mG5R,<nU4-/Z)a;t.a[//;#/?$L)r?j=8mKd15fGekv_7{M?*9g
+S[Ktyq)b]Sm28[n6luRoVoA&.AGd-CGQY3[s#dK9g9g9ds#s3f.CA'b9g!N^Es<9td7/u_]Nns9l/T6jXrSbZNj^9if0aQg9y|fDo;]r'M!k^+(iI!tb
+"[A**ihQ7n~CAl}clPf%%yJK M0BfdZ^BB`WK7nID90r!$5I(3iqR1Fw,F4Oy`:#u+!ymN+zjHM1.15+2J[<>q2G8"%k-~O/K?	 3:~%N8%{.[7|Cb/ -( {xusngz0f.0f60 6WWmi4qK-'#f5v+9<hq,9F\RYbGS(,b_3;9VF=ur[D	%AE3Dc_/t\t:q3 J,gv#m|yd""VON.o1YIFA)Ixdt9Y##l"vv)a<'=2T{di-GwxOCqO	-AIh)#uL[~#)9Gau|8FI$McIY>HI,\L"6\	Y;#gi1?fCPlA:w!W%qG :4i2r|
+@Dv>,gU-{|87[M>|9#?|8z2|8AW+#+,1UQ8Wluj
+2K9&@qtK1 _z_{8UHU%2	/c4]{cpPEH!gv1"A6/sr\e}[.[Ix.7Vs0vmwJaoY,Wsg*B|c[eF*3RVTn-TTgTe({hS\5s@@Xa[Z%K"nT8rcW.URIGR+} Ze*t*Cy/huT5XBxK|2HJ__&S kf-</v?\f$6G8N"Q[-=%MF cPuoGE\mdCkTPkT@&}sAe)8mwVdU\Edf%l;nmdHwa>;%&HqQm
+:Ng:%tT^]^HMPij]sn{BK{pJv`MH^w!8 z|'T-qiVrM`7{jw.czi-.B J7y7j1u;vhsPj\jBu<{Mumj\S{\kX|}U3vin_U%9kn-{zGq}%p>Q^p
+:#^RzagOt"}tl:;C6`[*.~tv>@xtvth6s+zWMgHotn1;?{]&8r.ddl:UgsFVM%{-Ttl:(`p"Kirl*,Mg7+0.&gdlE)/b+I1tvt%4OsntvX7atv%\i6`6<SOF#gH=Zq_+X0 J3qM)EZ %y'RvU1>|cp[O]^vzu6otrlK0)(&{ct[%moSIlm#%ur%(a.aN-Ed>2;(Yx*2w/a[;t+={2wd'4%J;z|*YYn+t@D-E:]at5uy)\.sEB&FstSj9R@=kVM-& PFx| .th##
+KK `(f=Q#V
+c`=T`7'~Kbz=KTFFtmOaRt5%_z\%dY,3voWWo}21o	,V` 8!CbUa$2,qu3D<Tl-	P[V6l;"J*'T[v*9!?[ 9v
+w^o5=.ni\nXk5UG5}{0O,+gZ'9wJ?OHdA[_2tO}SZSjOf~UoC=WcW%glWRBqetUM^c_+UJy~s\K=N{2B{NXj:Lz5=Vo{J;KVVtwW}FhL%mJIe?X9Ai}%6u&)iK:R:lk|!oIo=	s1Mu=-K)3/k*M!SSixM6]ip6RS>\HjHj= o\vHa4V4EGZHHS\'-*RizC/y=LDu3"%efr
+1M#GDD~,^\oQF!lRm+)BPFVxb2PU1).RUM\,=IOe"(z$3VdmS+YiM=g55&k{K4[G\/;UXcce*Lu}2-*-P<$UVqo#TWZzwra@bnVK1J4YvJNuu6rWX2;kgD
+p3yUssYfF~YsHer.2,-m{<hdqxM$th9eh=95Q33HjyFW(bsQO.CB%]p`WX+oqUs mnh=Tg@ESM l|dRD%FkBUH%)JmdY^s 6*`E6E+-UXQQwDQ>E+y-z|P|W.R:%~dUe_w&wC-P:[&N{]?-7~+Saw{P5Z#U*scJu-]D<Es!@GC]?j#u7:>p]?C7P9NVT=cuGuPU(7G',W%Fg{]9WQ9-8MX2L]?l-X-z|=U#bO9j2\}z]i)Wd#k]?w9~UVS-Hk=/Snos-G0sJxVo4ojq^T]?g5_Nm,E[e\=>Y1W6uMWrgX~
+lUd9|]?@'Ple9OU-3[U&~+,9W36p]?~POg[0!vG^sU?}{BcU?T]tQgxu%r~qf}sPKUt4vw7-l&&LN/{jlD 	h)PQI'2F$_#.wwoqOU4;R(!GPhbb;Cf=f+$[JHx`k8>ob(~gB9;bgC7g/m_	3Mb"$Uy#Q+\dD*vn%E<~zymoa1l~~>N7/_m504ORoxJpY :Oc[/NQ:i#(>JBD,L*Xr$'bX-#MEc![-{]L_3]RVb{'6YmKq?6y!MqJE~t+14}}9v3=O-6d(=<DNBsv{^GB??arL>]v;'Zrz?>Sl{6?30I	K_2^/I	k# )0l2}lTG,FiO}UJ/8 H}qi/^aC6Y zJzssza+{(2+IW?r<<F\#`]1F YY {j1KN-Ow<M$  ,;8d>F8t['d"Wwe[l`/{bzcz1<,!h^@M=TUPY&E|NO|YB! wI G8E%O;FSJQGbWETj8@X:P(}+o(K+1#6cuG_w_)pL6FG*lF/Q_J}O<#T9feP*rjrrSQJ~ 0%-w@4NnaGmzF(y{GP,!U:vHI\T~h"$_N<X{quVeJ	*FE$ERB R\S$RP^#U^O\CTf]1)<pmT*G/,j5a,Wy>	YFn]FMwOx8I36Ii1'Vg>Yb|-l@.+wEu57w&%@L]I4M,dg66B spG`Z-@UuYi%6x<iI;b^1Ngu!URqiW./3]={wN|7o,-@@H(:T1>
+W@mqPD.1cwN7Zm,$=^Te?+]@;ex44Mu{8Kv~t "6+2*LQ[?aC_pWhp$bQb#HwwSkn|pzTO$b+^"^wuMtpnZ(	T*~oLvkJe>bW-` W`9<@UFl}%WX[lc=5<ARbncb.`Y\iLh6`fRe5L]WK'mM
+vu~'',?s_,W*uv%+k ^%$d]1h%rPt0%F,6H{Amys	fQyR-oG7;_Sf#v{Pe4>HB0y+n
+x:;9	U2ukW|}.3WoR}o Z	[Y u<RY,Loc'4%lW?8$J;/a-pfg{|11g<-43{AkgvK#SP?A_YC#A.B\(z|?,* Tqk2V/[p|WvrjZim;c`YbXoe}s.BBmld?kAn}-1o^+ri<.__1/0B4_s@9UVe|p~Gj >9[y;?|TJ`"To?cY[]n7w`W.ty]Lh*,Gg*^a8c':biJW}nE6@K*v(mgEcJT`36KQ@A:9nn^=6BEvMN{TmGx:--Y"A)!\1)y#R;h4]^/[.0xwxSUO<vx+iWc[4XU{?P,b1cpCAn+"=bCbL*lt4xX(	 > < ?[[?x=j5`t oi "3g*;	asj(BIj`{aG2>/:[vzg(qTGP}x(:?~<@GS5x;6ReC*{n<{1FMY+K.uGe	u F{#b$$(=_ULe%@%A/@	JyJ$5,D@IV9|>4NVA*><Dt7)|TQ4 &	G D"^/)_v	* rU:`q;Pra&2 8g @x  v,P l>8g
+`<px( :F K1UxAp^(y@f/.EZNj%Crc$4r?	\V$TI/@R'xla:v<\I\Ob2i?-@H)[)< G;2oVo
+..uvdlreu8SdR=|==ZUv.#|#2!%D$kFID]c0X5O>-d:_Dt'+n)8C8,lYMjR)8;z^	R/n~ bW{xa7Zc=h'Ws-+%z! +"dp[K|j<Ye(!S>m`4/$[FM67Z71"mQsXT,%n>F[J$S;F^jW8CcpQDOr\z%{!pi9<v:l+!~@,0l6#wY8'NIcO'+1UIOUO[}7}xx)oga5-'H@F|>30#P wdSQc{=_#RY7Ykgp^e=iGX4mz4_$F
+&`<q<qi3:(b} 82=Ng<bX
+;KNzE]rc{1J"6'4SV}77X5c#sZ7q6,D/9]!r<B&EB|Fx`'<:Q\DF<,X&KtYbOlWz-y!N.kN}7GEKX'
+cBy\C	Lgw~<&I"Ic{S?Z-?Vn{G{=<KypmTA+P$YwPqFi:#'ivf25l<Bgk!-6f!~V)"qjSqFr\HE3I-~*B\`)&VHjH-&a9Z+0Qs0f]+.K(v}:l[9r;jJrET4:J^?u9G_e^Fr/Uc<1f-,-*i/^-KBvs=d
+7.96^ }+FV	*=%?
+uwIGZ[)zZnvyw'h|Xje?JB%qj>h[Ty>~>/>*d{xz
+}]pz~lKs=/HxvRar+,sCeBvm)(sUETsX J|w`]3Uam!|nq},uaX,KQAO3eiix:$.8R,j)<Qz]`4&%VtLxm;/lx
+`"%IQDEXvCdgw9Lovwis}jf/wj>2"SD"]1p>IM.1#z(\BZ{z5NBrHm7RyP~gRrp19V~+GjwJ@N(a;J28+u^:Ou"r$	r&H zC W6Ip(`=Y%(DH%u"|IgG*	H `-x,^(xviJP(aVn e $|sCiH|)R@.3F@r~d0[}u;m^A0HSX[.aNe$g{\T>UB!%699lV/ 2hW+Fv/NXf=:/-k<4m:J#JMk)3[D=:ar5X=QeF=(<ux>HRPO]rGawrC#AiP@L8Le`mdK^bq&%W/SZH`#;EpP*MA\;W@<R$]BL VfM.n'S:'$	U<FWvHwJyJn j/F+=yN?GG}$X 19xGVru+ty[5[c5@:&.^ lwe/lUteklll]+_&lxakQ?Vd(Bb	F_;zRy9G+nhobG)BWH&p=Fa$/+x-aI]v/ bRRBLApC0qqQD(n}s;0:	lWF}0kq6vQ?,fAtF7m\44+zxY,mh@o6WQtl;0.,\>|.V|9_ O/l
+$XeTz|Y6|`$Le9\9x y'*MO@^`|FOKqeu`Pi<qY^3)a>XO(LMBe e:aR=Jg9PHCWr`:gXOy=Q3<g6R)PCGBIes@2l5,#YYasP#'0,f'#NgxOGi.CqL*QJA&C"qy&G|t^A(| IWrl:|:]ywC<9$}v#mL.A|F 0|xfa}eBzYAI`/? )ryDE<qphAT wH
+DiD5RQOQg,i9~Ee@d
+";A/ sMF`24< 	rr`3"#>)d0;}
+<Fe{`xEv`[>%e`@ppB&=1 S6`0i:R,pYBcP=6)@@ey>=J	)&+daK{Da$yxkCGJl0B2J2L:l..R6qiMv%f,$<bI&P4,CN{A`hf 31x`|:&[e #y_)<L$_K\+Rt`w"!EP@pr@X Ag`q9^NMZ f\
+d%6pyi2"&C$+lN.	HR!Tm0 >>`@;L az:,i`'aJ*65A"P<=@r9^{,p<BdEVe+W*Ks|
+) n
+q Ja|V F0ZB*CB]y< PAhLu%& 0@U4u@*?1F gvh6`HAL,=`plY/_irD,(=mi<QGshm{ aMdSid&V& Avs]vsC{B!US"" q~.?S*!G Sh5\%4,AG<,q3tN:#U:+*"b@
+`MWk
+9R]zH4xhe{gl&`J7;zvh<		~Ht6s7z?Q~Q_endstreamendobj6 0 obj[5 0 R]endobj20 0 obj<</CreationDate(D:20110328132859+11'00')/Creator(Adobe Illustrator CS5)/ModDate(D:20110328132859+11'00')/Producer(Adobe PDF library 9.90)/Title(Modernizr 2 Logo)>>endobjxref0 210000000000 65535 f
+0000000016 00000 n
+0000000144 00000 n
+0000018316 00000 n
+0000000000 00000 f
+0000020771 00000 n
+0000048490 00000 n
+0000018367 00000 n
+0000018703 00000 n
+0000021070 00000 n
+0000020957 00000 n
+0000019852 00000 n
+0000020210 00000 n
+0000020258 00000 n
+0000020841 00000 n
+0000020872 00000 n
+0000021143 00000 n
+0000021317 00000 n
+0000022336 00000 n
+0000027404 00000 n
+0000048513 00000 n
+trailer<</Size 21/Root 1 0 R/Info 20 0 R/ID[<8D44613111B047A982BB568568FC0997><DE399FA33D7D4432BF16917DBD7AD64E>]>>startxref48693%%EOF
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.eps b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.eps
new file mode 100644
index 0000000..31ae492
Binary files /dev/null and b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.eps differ
diff --git a/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.pdf b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.pdf
new file mode 100644
index 0000000..60874e0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.pdf	
@@ -0,0 +1,291 @@
+%PDF-1.5%
+1 0 obj<</Metadata 2 0 R/OCProperties<</D<</ON[5 0 R]/Order 6 0 R/RBGroups[]>>/OCGs[5 0 R]>>/Pages 3 0 R/Type/Catalog>>endobj2 0 obj<</Length 18095/Subtype/XML/Type/Metadata>>stream
+<?xpacket begin="" id="W5M0MpCehiHzreSzNTczkc9d"?>
+<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 5.0-c060 61.134777, 2010/02/12-17:32:00        ">
+   <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
+      <rdf:Description rdf:about=""
+            xmlns:xmp="http://ns.adobe.com/xap/1.0/"
+            xmlns:xmpGImg="http://ns.adobe.com/xap/1.0/g/img/">
+         <xmp:CreatorTool>Adobe Illustrator CS5</xmp:CreatorTool>
+         <xmp:CreateDate>2011-03-28T13:28:59+11:00</xmp:CreateDate>
+         <xmp:MetadataDate>2011-03-28T13:28:59+11:00</xmp:MetadataDate>
+         <xmp:ModifyDate>2011-03-28T13:28:59+11:00</xmp:ModifyDate>
+         <xmp:Thumbnails>
+            <rdf:Alt>
+               <rdf:li rdf:parseType="Resource">
+                  <xmpGImg:width>256</xmpGImg:width>
+                  <xmpGImg:height>40</xmpGImg:height>
+                  <xmpGImg:format>JPEG</xmpGImg:format>
+                  <xmpGImg:image>/9j/4AAQSkZJRgABAgEBLAEsAAD/7QAsUGhvdG9zaG9wIDMuMAA4QklNA+0AAAAAABABLAAAAAEA&#xA;AQEsAAAAAQAB/+4ADkFkb2JlAGTAAAAAAf/bAIQABgQEBAUEBgUFBgkGBQYJCwgGBggLDAoKCwoK&#xA;DBAMDAwMDAwQDA4PEA8ODBMTFBQTExwbGxscHx8fHx8fHx8fHwEHBwcNDA0YEBAYGhURFRofHx8f&#xA;Hx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8f/8AAEQgAKAEAAwER&#xA;AAIRAQMRAf/EAaIAAAAHAQEBAQEAAAAAAAAAAAQFAwIGAQAHCAkKCwEAAgIDAQEBAQEAAAAAAAAA&#xA;AQACAwQFBgcICQoLEAACAQMDAgQCBgcDBAIGAnMBAgMRBAAFIRIxQVEGE2EicYEUMpGhBxWxQiPB&#xA;UtHhMxZi8CRygvElQzRTkqKyY3PCNUQnk6OzNhdUZHTD0uIIJoMJChgZhJRFRqS0VtNVKBry4/PE&#xA;1OT0ZXWFlaW1xdXl9WZ2hpamtsbW5vY3R1dnd4eXp7fH1+f3OEhYaHiImKi4yNjo+Ck5SVlpeYmZ&#xA;qbnJ2en5KjpKWmp6ipqqusra6voRAAICAQIDBQUEBQYECAMDbQEAAhEDBCESMUEFURNhIgZxgZEy&#xA;obHwFMHR4SNCFVJicvEzJDRDghaSUyWiY7LCB3PSNeJEgxdUkwgJChgZJjZFGidkdFU38qOzwygp&#xA;0+PzhJSktMTU5PRldYWVpbXF1eX1RlZmdoaWprbG1ub2R1dnd4eXp7fH1+f3OEhYaHiImKi4yNjo&#xA;+DlJWWl5iZmpucnZ6fkqOkpaanqKmqq6ytrq+v/aAAwDAQACEQMRAD8A9U4q7FXYq+TfzF/5TvXf&#xA;+YyX/iWZmL6Q+o9k/wCK4/6oTP8AJn/yZWj/APRz/wBQsuOX6S4/b/8Aic/83/dBJ/OU00PnfX3h&#xA;do3GpXdGQlT/AH79xhiLiHK0EQdNjBF+iP8AuQitE/M3zvo7L9W1WaWJf90XJ9eMjwpJyKj/AFSM&#xA;BxRLVqOx9Nl5wAPeNvueu+Svzz0fVpEstcjXTL1zxScEm2c+5O8Z/wBao98oniIeV7Q9nMmIcWI8&#xA;cft/b+NnqAIIBBqDuCOlMqebdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdirsVdi&#xA;rsVdirsVYv588+Wfk+ztbm5tZLpbqRolWJlUgqvKp5ZKMTI0HZdm9my1cjGJAoML/wChi9E/6tFz&#xA;/wAHHlngF3H+hXL/AD4/a8a8z6tFrHmHUNUijaKO9neZY2ILKHNaGmZEI0Keu0eA4sMYHcxFMi/J&#xA;n/yZWj/9HP8A1Cy5HL9JcDt//E5/5v8Augknnf8A5TTX/wDtpXf/ACffJQ5BzOzv8Wx/1I/cEkyT&#xA;mOxV6r+Un5qz6Vcw6FrcxfSZSEtbhzU27E7Asf8AdZ/4X5ZRlx9Q8x252KMgOXEPWOY7/wBv3voD&#xA;ruMxnhXYqwvz7+Z1h5Ou7W2urKW6a6jaRWiZVACtxoeWThAy5O37N7Inq4kxkBw97KNH1S11bSrT&#xA;U7U1t7yJJo/EBhWh9x0OQIp1ufDLFMwlziaXapqVtpmm3Wo3Tcbe0ieaU/5KCu3ucUYcRyTEI85G&#xA;mK+QvzOsPON3dW1rZS2rWsayM0rKwIZuNBxyc4GPN2faXZE9JEGUgeLuZpkHUOxV2KuxVjvnrzpa&#xA;+UNIh1K5tnuo5rhbYRxkKQWR3r8X/GPJRiZHZ2HZ3Z8tVkMIkChf3frT+GQSwpKBQOoYD5iuRcCQ&#xA;o0vxQ7FXYq7FXYq7FWOecPPug+UhZHVfV/052WL0UD0EfHm7VK7LzHSp9slGBPJ2Gh7Ny6ri8OvT&#xA;3sjyLr3Yq7FXYq7FXkf/ADkX/wAcTSP+Yl/+TeXYOb1Xsr/ez/q/peDZlPbuxVm35M/+TK0f/o5/&#xA;6hZcry/SXT9v/wCJz/zf90Ek87/8ppr/AP20rv8A5Pvkocg5nZ3+LY/6kfuCSZJzHYq7FX0h+Sfn&#xA;GTXPLjaddyc9Q0njEWY1Z4GB9JjXqRQqfkPHMPLCi+e+0GgGHNxx+me/x6/rei5W6B41+c9hDqHn&#xA;zylp89fRvHSCWnXjLcKjU+g5diOxeu7AyHHps0xziL+USnH5K6jc2kOq+T9Qal7olw/pKe8TsQ3H&#xA;2Em/+yGRyd/e4ntBiEjDUQ+nIPt/s+5d+dmqXMthpvlSwNb/AF24RGQf76RhStOgaQr9AOOMb33I&#xA;9n8IE5Z5/TjH2/2JV+UOmQaX5+806bb/ANzZqsCE9SI5ONT86YchsBye3Mxy6XDM85bsq88fmSmg&#xA;39voml2Tar5guwDFaISFQN9kuQCamleI7bkjIxhe/R1nZ3ZJzxOScuDFHqkd3+YH5oaDGNQ8yeWo&#xA;DpOxlks5PjiBNPjpJMNvcAe+S4InkXNh2Zos54MOU8f9Ic/sD0PRNc03WtKg1TT5RJZ3C8lY7EU2&#xA;ZWHYqdjlZFOh1GnnhmYTFSDz2f8ANPzRrmsXGn+RdGj1CC1bjLqFySIjvTkKPEApp8NWqfDLOAD6&#xA;nex7Gw4cYnqpmJl/COf3H7mK/mz5q8wXvlq30jzHo7aXqkd6lxHJG3qW00SxSoxRwWAKl1+Hkcni&#xA;AvYuz7E0eKGY5MM+OHDXcQbD2e81jT9G8vfpPUJPStLaBXkbqT8IAVR3ZjsBmOBbyOPBPLl4IC5E&#xA;sGtPPX5n6/F+kPLnly2TSWY+hJfSUklUGlV/eRAdPAj3OWGMRzLusnZ2iwHgzZZcfXhGw+wp55K/&#xA;ME63fXGi6vYtpHmG0HKWyckh0/njJp49PDcEjBKNb9HC7Q7M8GIyY5ceKXX9aC85/miPK/m6z0i4&#xA;s/Wsbi0+svLHVpvUYyrHGidDyeNRv44Y47Ft2g7H/M4JZBKpCVeXSyfgUb5a8z+cr6DVL3WtEXSr&#xA;OCD1tPjZiZHIDFhIa16AfsDIyAHItOr0mngYRx5OORNS7vh/axvQfzb80+YrD09D8u/WtVVyJ2L8&#xA;LSGPbiWdivJjv8NRk5Y6O5dhqexMOnl+9ycMOm3qPwROi/mX5qtfNVp5d85aRDYTX5C2lxbE8CzE&#xA;hOryhgzfDs2x7YDAVYLXqOycEsBzaeZkI8wf7B9ybfmZr9tpH6E9fS7XU/rd6sSfWkD+kxp+8jqD&#xA;RsjEXfucXsnTSy+JU5Q4Y3t18imvnDV/NenRWreXtIXVnkZxcK0gj4AAcTuVrXfBEDqXG0ODBkJ8&#xA;WfB3bWwnWvzO/MbRLI3uq+V4LS1DBPUe4BqzdAArEn6BlggCaBdxp+x9JmlwwymUv6rLdK826pc/&#xA;l9N5nvLFba6S0uLyO0qeLJErPGanejhQfpyHDvTq82ihHVDBGVx4hG/fz+TE7D82/Neu6XD/AIb8&#xA;um91MBjfSMWFrC3NgiBiU5sUAY/EOuTOMA7l2mXsTBgmfGycMOn849/fW+3J5H/ysXz3/wBX28/5&#xA;Gtl/hR7nqv5J0v8AqcfkgNW8z+YdYiji1TUJ72OJi0azOXCsRSorkowA5N+DR4cRuEREnuSvJOS7&#xA;FWbfkz/5MrR/+jn/AKhZcry/SXT9v/4nP/N/3QSTzv8A8ppr/wD20rv/AJPvkocg5nZ3+LY/6kfu&#xA;CSZJzHYq7FWd/krrL6d59s4uREOoK9rKP9Zeabf66LlWYel0ntBgGTSk9Y0f1/Y+msxHzl5H+an/&#xA;AJM3yR/zEwf9RaZdj5F6rsX/ABPP/VP+5Kp55/51P8zdG82J8Fhqg+p6mR0qAELN/sOLf7DBHeJD&#xA;Ds7/AArRzwfxQ9Ufx8/m35SH+LvzU1XzK/x6bog+p6ceql90DD/h3/2QxltEDvXW/wCC6GGH+PJ6&#xA;pfj5D4L/AMuf/Jqedf8AjIf+TxwS+kI7V/xLB7v0KX5fIlz+bnnC6vBW9gZ47YNQkRCXhyH+wRB8&#xA;jhn9IZdpnh0GGMfpPP31+u3ql5bW9zaTW1yoe2mjaOZW6FGBDA19sqeahMxkCOYeK/lrd3cX5V+c&#xA;BbOzQ24ujayGtRW3+IjwoAGy/IPUHr+1oROuw8XM8N/6ZmP5H21pF+XtnJCAJbiWeS5I6mQSsgr/&#xA;ALBFyGX6nU+0U5HVyB5ACvlf32lv/OQwH+DLI03/AEjHv/zwmyWDm5Hst/jEv6h++KF/Pee4TyRp&#xA;ESVEEtxH61DSpWFiqn8T9GDDzbfZuIOpmeoifvTu11b81IbaGG28s2C28aKkKreLxCKKKBv0pkKH&#xA;e4M8GiJJOWd/1Ur/AEF+YepeftF8x32kW+nrZfubp4LhHLwtyB5CtTQOclYAIcr8zpMelnhjOUuL&#xA;cXHqu8xxo/5++WldQyjTnYBhUVVbtlO/cEVGSj9BXSkjsvLX8/8A4h6Lrf8Axxr/AP5hpf8AiByl&#xA;5/B/eR94YH+QX/KCt/zGzf8AEUyzL9Tu/aX/ABr/ADR+lD/myq/42/L5qDkdRoT3oJ7Wn68lj5Ft&#xA;7E/xbU/1P97Nd+d3/TMf9tJf4ZHH19zH2e/yv/Cy9LmmighkmmcRwxKXkkY0VVUVJJPYDK3nYxJN&#xA;DmXkFlFcfmj5yN9OrDybokhWCJqgXEnXcf5fVvBaDvlx9A8y9XkI7N0/CP8AGMnP+iPx9vuej+dl&#xA;VfJOvKoAUabdgAbAAQPlcOYef7P/AMZx/wBeP+6CSfkuiL+W2klVALm5LkClT9ZkFT9AAyWX6i5v&#xA;b5/wyf8Am/7kPFv+VM/mV/1Z/wDp5tf+quZHix73sP5f0f8AP/2Mv1O/5Uz+ZX/Vn/6ebX/qrj4s&#xA;e9f5f0f8/wD2Mv1O/wCVM/mV/wBWf/p5tf8Aqrj4se9f5f0f8/8A2Mv1O/5Uz+ZX/Vn/AOnm1/6q&#xA;4+LHvX+X9H/P/wBjL9TKPyy/LLzvovnfTdT1PTfq9jb+v603r270528iL8KSMxqzAbDIZMgIoOs7&#xA;X7X02bTShCVyNdJfzgeoSvzV+Uv5g33mfV7210r1LW6vbmaCT6xbLyjklZlNGkBFQe4wxyRADlaL&#xA;tvSQwwjKfqjGIO0ug9yV/wDKmfzK/wCrP/082v8A1VyXix73J/l/R/z/APYy/U7/AJUz+ZX/AFZ/&#xA;+nm1/wCquPix71/l/R/z/wDYy/U7/lTP5lf9Wf8A6ebX/qrj4se9f5f0f8//AGMv1Jn5X/Kn8xdN&#xA;8y6VqE2klIbS8gmmYXNttGkis/2ZCfsg9BkZZIkFxtZ21pMmGcBPeUSPpl3e59GZivn7zrz/AOUv&#xA;MGreevK2qafa+tY6bPE97N6kacFS4V2PF2Vm+EV+EHLISABd/wBma3Fi02aEzUpg1sf5pDIPzF8r&#xA;t5l8pXumxKGvABNZVIH76PdRU7DkKrv45GEqNuD2VrPy+eMz9PI+4/i1P8tPKr+WfKVrY3EYjv5S&#xA;Z74Aq1JX/ZqtQeKgLse2GcrNsu19b+YzmQ+nkPd+N0p8leVtd03z/wCaNVvbX0rDUXJs5ucbcx6h&#xA;b7KsWXb+YDGRFBye0NZiyaXFjiblDnz7kN5z8keZLXzQnnLycY21MrwvrCQhVmAAFRUqp5KAGFR0&#xA;qDXDGQqi2aDtDDLD+X1F8HSXcgdU1b84fMlm2j2+gJoqXI9K7v5JRsjbNxNagH/JDHCBEb3bfhwd&#xA;n6eXiHJ4lco1+P0M28p+TdO8v+WF0JP38Tq/1yRhT1XlFJCR2BGwHhkJSs26bW6+efN4p2PTyrk8&#xA;/wBL0X8yPy+vrq10WxGveXrmQyQxcwroT9NVamx2INO2WExlz2Lvc2o0euiJZJeFlA380N530D82&#xA;vOWlQyXGnQ2tvFOrQaNHLH6m6ODPLJI6r8P2Qta/F0wwlGJbOztToNJkIEjIkbzo102AA/Fc3pPm&#xA;jynbeZPKraLdn0nKIYpgORimjHwt138D7ZTGVG3ntHrTp8/iR3/SGGaTqv5t+WLRNIu9AXXYLZfT&#xA;tL2CYKSiii8jRiae6g/rywiJ3unb58Og1EvEjk8InmCGR+UH/Ma91WbUfMcdvp2mtF6dvpMdJJA3&#xA;KokZwWoae/0DISro6/XDSQgIYSZzveXIe6vx70HrHlnXLj83tD8wQ23LSLOyeG5uecY4yFbkAcCw&#xA;c/3q9F75ISHAQ3YNZijoMmIn95KVgb/0fh0LM9Uhkn0y7hiHKWWGREWoFWZCAKnbrlbqMMgJgnoQ&#xA;xL8ovLms+X/KbWGr2/1a7NzJL6fNJPgZVANY2de3jk8hBOztO3NVjz5+PGbjwjv/AEqP5h+Wdc1f&#xA;zP5OvdOtvXtdKvTNfyc409OP1YGrR2UttG32QcMJAAs+y9ZixYc0ZmpTjUee+0v1t/mn5Z1vXP0F&#xA;+i7b6x9SvlnufjjTjGKfF+8Za/Rggav3I7H1ePD4nGa4oUOfP4O/N7SfOWsaHBpnlyD1o7hz+kQJ&#xA;I4m9NQCi1kdNmbrTww4yAd09h5tPiymeY1X07E7/AACR6DP+b2h6Tb6Xp/lCyjtbZeK/6TFyY9Wd&#xA;j6+7MdzhIiermamOgzZDOeaXEf6J/wCJZfInmjWPIOpwapYR2mu3lndwLZRSIy8nR0iAfmy/FUdW&#xA;yIoSdVE4cWqiYS4scZRN15i9qd+WWi6lovkjTdM1OH6vfW/r+tDyR6c7iR1+JCymqsDscchs2F7X&#xA;1EM2plOBuJr/AHIHV//Z</xmpGImg:image>
+               </rdf:li>
+            </rdf:Alt>
+         </xmp:Thumbnails>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:photoshop="http://ns.adobe.com/photoshop/1.0/">
+         <photoshop:ColorMode>3</photoshop:ColorMode>
+         <photoshop:ICCProfile>sRGB IEC61966-2.1</photoshop:ICCProfile>
+         <photoshop:TextLayers>
+            <rdf:Bag>
+               <rdf:li rdf:parseType="Resource">
+                  <photoshop:LayerName>Modernizr</photoshop:LayerName>
+                  <photoshop:LayerText>Modernizr</photoshop:LayerText>
+               </rdf:li>
+            </rdf:Bag>
+         </photoshop:TextLayers>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:dc="http://purl.org/dc/elements/1.1/">
+         <dc:format>application/pdf</dc:format>
+         <dc:title>
+            <rdf:Alt>
+               <rdf:li xml:lang="x-default">Modernizr 2 Logo</rdf:li>
+            </rdf:Alt>
+         </dc:title>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"
+            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"
+            xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#">
+         <xmpMM:InstanceID>uuid:d2ad3950-7c02-824a-aed8-40a8f4f3f557</xmpMM:InstanceID>
+         <xmpMM:DocumentID>xmp.did:03801174072068118083F1FA8E5E4F1F</xmpMM:DocumentID>
+         <xmpMM:OriginalDocumentID>xmp.did:F77F117407206811BB3F9C0632107F53</xmpMM:OriginalDocumentID>
+         <xmpMM:RenditionClass>proof:pdf</xmpMM:RenditionClass>
+         <xmpMM:History>
+            <rdf:Seq>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>created</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F77F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T17:17:50-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F87F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T17:18:53-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:F97F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:02:32-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FA7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:18:57-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FB7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:25:21-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FC7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:26:04-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FD7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:37:06-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>converted</stEvt:action>
+                  <stEvt:parameters>from application/vnd.adobe.photoshop to application/pdf</stEvt:parameters>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>derived</stEvt:action>
+                  <stEvt:parameters>converted from application/vnd.adobe.photoshop to application/pdf</stEvt:parameters>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:FE7F117407206811BB3F9C0632107F53</stEvt:instanceID>
+                  <stEvt:when>2011-03-27T18:37:07-07:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Photoshop CS5 Macintosh</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+               <rdf:li rdf:parseType="Resource">
+                  <stEvt:action>saved</stEvt:action>
+                  <stEvt:instanceID>xmp.iid:03801174072068118083F1FA8E5E4F1F</stEvt:instanceID>
+                  <stEvt:when>2011-03-28T13:28:58+11:00</stEvt:when>
+                  <stEvt:softwareAgent>Adobe Illustrator CS5</stEvt:softwareAgent>
+                  <stEvt:changed>/</stEvt:changed>
+               </rdf:li>
+            </rdf:Seq>
+         </xmpMM:History>
+         <xmpMM:DerivedFrom rdf:parseType="Resource">
+            <stRef:instanceID>uuid:edd0f61a-a49d-1d49-acc4-68ea7894e484</stRef:instanceID>
+            <stRef:documentID>xmp.did:F77F117407206811BB3F9C0632107F53</stRef:documentID>
+            <stRef:originalDocumentID>xmp.did:F77F117407206811BB3F9C0632107F53</stRef:originalDocumentID>
+         </xmpMM:DerivedFrom>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:pdf="http://ns.adobe.com/pdf/1.3/">
+         <pdf:Producer>Adobe PDF library 9.90</pdf:Producer>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:xmpTPg="http://ns.adobe.com/xap/1.0/t/pg/"
+            xmlns:stDim="http://ns.adobe.com/xap/1.0/sType/Dimensions#"
+            xmlns:xmpG="http://ns.adobe.com/xap/1.0/g/">
+         <xmpTPg:NPages>1</xmpTPg:NPages>
+         <xmpTPg:HasVisibleTransparency>False</xmpTPg:HasVisibleTransparency>
+         <xmpTPg:HasVisibleOverprint>False</xmpTPg:HasVisibleOverprint>
+         <xmpTPg:MaxPageSize rdf:parseType="Resource">
+            <stDim:w>600.000000</stDim:w>
+            <stDim:h>88.799805</stDim:h>
+            <stDim:unit>Pixels</stDim:unit>
+         </xmpTPg:MaxPageSize>
+         <xmpTPg:PlateNames>
+            <rdf:Seq>
+               <rdf:li>Cyan</rdf:li>
+               <rdf:li>Magenta</rdf:li>
+               <rdf:li>Yellow</rdf:li>
+            </rdf:Seq>
+         </xmpTPg:PlateNames>
+         <xmpTPg:SwatchGroups>
+            <rdf:Seq>
+               <rdf:li rdf:parseType="Resource">
+                  <xmpG:groupName>Default Swatch Group</xmpG:groupName>
+                  <xmpG:groupType>0</xmpG:groupType>
+               </rdf:li>
+            </rdf:Seq>
+         </xmpTPg:SwatchGroups>
+      </rdf:Description>
+      <rdf:Description rdf:about=""
+            xmlns:illustrator="http://ns.adobe.com/illustrator/1.0/">
+         <illustrator:Type>Document</illustrator:Type>
+      </rdf:Description>
+   </rdf:RDF>
+</x:xmpmeta>
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                                                                                                    
+                           
+<?xpacket end="w"?>endstreamendobj3 0 obj<</Count 1/Kids[7 0 R]/Type/Pages>>endobj7 0 obj<</ArtBox[0.0 1.36328 583.011 88.7998]/BleedBox[0.0 0.0 600.0 88.7998]/Contents 8 0 R/LastModified(D:20110328132859+11'00')/MediaBox[0.0 0.0 600.0 88.7998]/Parent 3 0 R/PieceInfo<</Illustrator 9 0 R>>/Resources<</ExtGState<</GS0 10 0 R>>/Properties<</MC0 5 0 R>>>>/Thumb 11 0 R/TrimBox[0.0 0.0 600.0 88.7998]/Type/Page>>endobj8 0 obj<</Filter/FlateDecode/Length 1080>>stream
+HV$5WTL}e@Vhh1,KDYK|83"^~~u/^}['cyq|s
+,'pk{}1<|m|C"8V<#n)#T}Uz|i ~#ry1cM|mE{M^
+'8_U}Kpo(/l'&^h^bv+.:L\>	VH}PZaY}I-Y9{p1u#B F_WSa4dM(N}Gj"B6eu}z#]pb
+[RLRxy8nB%?\	fiKGDL&nK>kk9
+bQ|*6rFFu|Ek""#b |edt%c:Z&pT-A-OM7E>Ch=k^5Ip_]
+A##y0-bEN6	7p6RckFwJqgL~h[B_AyX"H<G,%#D5Mg7Eg LV,pFP8 RW(,HNY5UCV433Zwd)#AW7,Pm!?-[&~6PtUfWdv1X =GI*Qfyt@>5=9R)ER@598-FlF19'NOEY/A0euT1_0,uwgIvyA4?dl
+/-G!N{S:	Z#rtg\fgLdW/hAGrZ 
++6;a3F@e?~ 0endstreamendobj11 0 obj<</BitsPerComponent 8/ColorSpace 12 0 R/Filter[/ASCII85Decode/FlateDecode]/Height 11/Length 217/Width 75>>stream
+8;X.*5o.B]#Xe'qAYk1P*4a@.!l]_ep/*-_RXPW`fG[D6f.h*1a7H@op([&VW*Y^*
+W0WFo2Q9;Fb+MFP43tonNU43q7k''P:'9+35"AmKh.O9'J#%\IT$_Z*W;Z'Oj7LaA
+9^>Zd/+=U[R&s-+Brt<DrD5OMUCQS3iH5`HV"Ec'MamVcE^1X21/>.'Lp'%G5RL>:
+;0"gleOf`E!,b_4ci~>endstreamendobj12 0 obj[/Indexed/DeviceRGB 255 13 0 R]endobj13 0 obj<</Filter[/ASCII85Decode/FlateDecode]/Length 428>>stream
+8;X]O>EqN@%''O_@%e@?J;%+8(9e>X=MR6S?i^YgA3=].HDXF.R$lIL@"pJ+EP(%0
+b]6ajmNZn*!='OQZeQ^Y*,=]?C.B+\Ulg9dhD*"iC[;*=3`oP1[!S^)?1)IZ4dup`
+E1r!/,*0[*9.aFIR2&b-C#s<Xl5FH@[<=!#6V)uDBXnIr.F>oRZ7Dl%MLY\.?d>Mn
+6%Q2oYfNRF$$+ON<+]RUJmC0I<jlL.oXisZ;SYU[/7#<&37rclQKqeJe#,UF7Rgb1
+VNWFKf>nDZ4OTs0S!saG>GGKUlQ*Q?45:CI&4J'_2j<etJICj7e7nPMb=O6S7UOH<
+PO7r\I.Hu&e0d&E<.')fERr/l+*W,)q^D*ai5<uuLX.7g/>$XKrcYp0n+Xl_nU*O(
+l[$6Nn+Z_Nq0]s7hs]`XX1nZ8&94a\~>endstreamendobj5 0 obj<</Intent 14 0 R/Name(Layer 1)/Type/OCG/Usage 15 0 R>>endobj14 0 obj[/View/Design]endobj15 0 obj<</CreatorInfo<</Creator(Adobe Illustrator 15.0)/Subtype/Artwork>>>>endobj10 0 obj<</AIS false/BM/Normal/CA 1.0/OP false/OPM 1/SA true/SMask/None/Type/ExtGState/ca 1.0/op false>>endobj9 0 obj<</LastModified(D:20110328132859+11'00')/Private 16 0 R>>endobj16 0 obj<</AIMetaData 17 0 R/AIPrivateData1 18 0 R/AIPrivateData2 19 0 R/ContainerVersion 11/CreatorVersion 15/NumBlock 2/RoundtripStreamType 1/RoundtripVersion 15>>endobj17 0 obj<</Length 969>>stream
+%!PS-Adobe-3.0 %%Creator: Adobe Illustrator(R) 15.0%%AI8_CreatorVersion: 15.0.2%%For: (Marc Edwards) ()%%Title: (Modernizr 2 Logo.pdf)%%CreationDate: 28/03/11 1:28 PM%%Canvassize: 16383%%BoundingBox: -1 1 584 89%%HiResBoundingBox: -0.000488 1.36328 583.0107 88.7998%%DocumentProcessColors: Cyan Magenta Yellow%AI5_FileFormat 11.0%AI12_BuildNumber: 399%AI3_ColorUsage: Color%AI7_ImageSettings: 0%%CMYKProcessColor: 1 1 1 1 ([Registration])%AI3_Cropmarks: 0 0 600 88.7998%AI3_TemplateBox: 299.5 44.5 299.5 44.5%AI3_TileBox: -103 -235.0996 680 323.8999%AI3_DocumentPreview: None%AI5_ArtSize: 14400 14400%AI5_RulerUnits: 6%AI9_ColorModel: 2%AI5_ArtFlags: 0 0 0 1 0 0 1 0 0%AI5_TargetResolution: 800%AI5_NumLayers: 1%AI9_OpenToView: -70.5 304 2 1572 1032 26 0 0 66 96 0 0 0 1 1 0 1 1 0 1%AI5_OpenViewLayers: 7%%PageOrigin:228 -28%AI7_GridSettings: 144 144 144 144 1 0 0.8 0.8 0.8 0.9 0.9 0.9%AI9_Flatten: 1%AI12_CMSettings: 00.MS%%EndCommentsendstreamendobj18 0 obj<</Length 5017>>stream
+%%BoundingBox: -1 1 584 89%%HiResBoundingBox: -0.000488 1.36328 583.0107 88.7998%AI7_Thumbnail: 128 20 8%%BeginData: 4872 Hex Bytes%0000330000660000990000CC0033000033330033660033990033CC0033FF%0066000066330066660066990066CC0066FF009900009933009966009999%0099CC0099FF00CC0000CC3300CC6600CC9900CCCC00CCFF00FF3300FF66%00FF9900FFCC3300003300333300663300993300CC3300FF333300333333%3333663333993333CC3333FF3366003366333366663366993366CC3366FF%3399003399333399663399993399CC3399FF33CC0033CC3333CC6633CC99%33CCCC33CCFF33FF0033FF3333FF6633FF9933FFCC33FFFF660000660033%6600666600996600CC6600FF6633006633336633666633996633CC6633FF%6666006666336666666666996666CC6666FF669900669933669966669999%6699CC6699FF66CC0066CC3366CC6666CC9966CCCC66CCFF66FF0066FF33%66FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF%9933009933339933669933999933CC9933FF996600996633996666996699%9966CC9966FF9999009999339999669999999999CC9999FF99CC0099CC33%99CC6699CC9999CCCC99CCFF99FF0099FF3399FF6699FF9999FFCC99FFFF%CC0000CC0033CC0066CC0099CC00CCCC00FFCC3300CC3333CC3366CC3399%CC33CCCC33FFCC6600CC6633CC6666CC6699CC66CCCC66FFCC9900CC9933%CC9966CC9999CC99CCCC99FFCCCC00CCCC33CCCC66CCCC99CCCCCCCCCCFF%CCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0033FF0066FF0099FF00CC%FF3300FF3333FF3366FF3399FF33CCFF33FFFF6600FF6633FF6666FF6699%FF66CCFF66FFFF9900FF9933FF9966FF9999FF99CCFF99FFFFCC00FFCC33%FFCC66FFCC99FFCCCCFFCCFFFFFF33FFFF66FFFF99FFFFCC110000001100%000011111111220000002200000022222222440000004400000044444444%550000005500000055555555770000007700000077777777880000008800%000088888888AA000000AA000000AAAAAAAABB000000BB000000BBBBBBBB%DD000000DD000000DDDDDDDDEE000000EE000000EEEEEEEE0000000000FF%00FF0000FFFFFF0000FF00FFFFFF00FFFFFF%524C45FD0CFFCA8EB78EB78EB7FFCA8EB794C3C4FD72FFA1958E948E9594%FFA1958E948E958E9BA1FD6FFFCA8EB794958EB7FFC48EB794958EB78E95%94CAFD6DFFA1948E958E948EFFA1948E958E948E958E948EC3FD6CFFCA8E%B794B78EB7FFC48EB794B78EB794B78EB78EBDCAFD6AFFA2948E958E9494%FFA1948E958E948E958E948E958E95A8FD63FFC49BC39BBD9BBD8E958EB7%8E95FFC48E958EB794958EB794958EB78EBDCBFD09FFCABD9BCBFD06FFCA%BD9BCBFD13FFCA9BFD1EFFCAA2FD16FF9A948E948E948E958E948E9494FF%A1948E948E958E948E958E948E958E9BFD09FFCA8E949BFD06FFA18E94A2%FD13FF9B94A8FD1DFF8E94A8FD15FFBD8EB794B78EB794B78EB78EB7FFCA%8EB78EB794B78EB794B78EB794B78ECAFD08FFCAB78EB7CBFD05FF94B78E%CAFD13FFC48EFD1EFFCAA2FD16FF9B948E958E948E958E948E9594FFA195%8E948E958E948E958E948E958E948EFD08FFCA8E9B8EC4FD04FFA1949B95%A8FD04FFCAA1C4A2FD07FFA1C3A1FFA194A8FD04FFCA9BC3A8FD05FFA8FF%A8C4CAFFA2FFFFC49BC4CAFFFFFFCAFFFFFFA8CAA2CAA2CAA2FFFFCBA2FF%CAC4FD06FFC38E958EB794958EB794958EB7FFC48EB794958EB794958EB7%94958EB794959BFD07FFA8B7A1BD94FD04FFBD9BCA8ECAFFFFFFC38E958E%B795FD04FFCB94B7949594C38EFFFFFFCBBD8EB794959BFFFFFFA1B7A195%8EFFCA959BBD94958EBDFFFFFFBD9BFFFFBD8E958EB78E95CAFFA195A1B7%8EFD06FF9B948E948E958E948E958E948EFFA1948E958E948E958E948E95%8E948E958E94A8FD06FFCA8EC4A294A2FFFFCA8EC4A294A2FFFF9B8EC4FF%FFA19494FFFFFF9494A1FFCBC48E95A8FFCA9B8ECAFFFFA1949BFFFFC38E%95A1CBFFCA8E94A1FFFFC38EC4FFFF949BFFFFA8CBA8FFA1949BFFFFC48E%95A1FFCAA2CAC4CAA2BD8EB78EB794B78EB794B78EB7FFC48EB794B78EB7%94B78EB794B78EB794B78ECAFD06FFCAB7A1FF8EC3FFFF9BB7FFCA8ECBFF%FF8EC4FD04FFC495A1FFC495A1FD04FFC48EFFFFCA8ECBFD04FFA1B7FFFF%A1B7CAFFFFFFCA95A2FD04FFB7A1FFFFBD9BFD06FFB794FFFFFFA1B7CAFF%FF8E948E958E948E958E948E958E948E958E9494FFA1948E958E948E958E%948E958E948E958E9494FD06FFCA8EC4FFC38EFFFF949BFFA194A2FFA194%A2FD05FF8E9BFFC38EFD05FFA195CAFF9B95A2CAA2CAA8C38ECAFFC38EFD%04FFCA8EC4FD04FF8EC4FFFF94BDFD05FF9B8ECBFFFFFFC48EFFFFFFB78E%958EB78E958EB794958EB794958EB78E95FFC48E958EB794958EB794958E%B794958EB78E95CAFD05FFCA95A1FFCA95A1CA8ECAFFCA8ECAFFC48EFD06%FFBD9BFF9BB7FD05FFC48EFFFFBD8EBD95BD94BD95BDA2FFA195FD04FFA8%B7C4FD04FF95A1FFFFBD9BFD04FFC48EC4FD04FFA1B7FFFFFF8E958E948E%958E948E958E948E958E948E9494FFA1948E948E958E948E958E948E958E%948E948ECAFD05FFCA8EC3FFFF9495949BFFFFA194A2FFA194A2FD05FF8E%C3FFC38EFD05FFA194A8FF9B94A8FFFFFFA8FD04FFC48EFD04FFCA8EC4FD%04FF8EC3FFFF949BFFFFFFCA8EBDFD05FFC38EFFFFFFB794B78EB794B78E%B794B78EB794B78EB78EB7FFCA8EB78EB794B78EB794B78EB794B78EB794%B7A1FD05FFCA95A1FFFFCA8EB7C4FFFFCA8ECAFFFF8EBDFD04FFA1B7C4FF%CAB7A1FD04FFC38EFFFFCA8EC4FD08FFA1B7FD04FFCAB7C4FD04FFB7A1FF%FFBD9BFFFFFF94BDFD06FFA1B7FFFFFF8E958E948E958E948E958E948E95%8E948E9594FFA1958E948E958E948E958E948E958E948E958EC3FD05FFCA%8EC3FFFFFF958EFFFFFFA195A8FFFFC48E9BA8CBA1949AFFFFFF94949BCB%A8BD8E94A8FFFF9B8EC4CAFFA2959BFFFFC48EFD04FFCA8ECAFD04FF8EC3%FFFF949BFFFF9B949BCAA1C4A1FFFFC38EFFFFFF9594B7949594B7949594%B7949594B7949594BDFFC48EB7949594B7949594B7949594B7949594B7A1%FD05FFCAB7A1FFFFFFA1C3FFFFFFCA8ECBFFFFFFC48E958EB79BFD05FF9B%B78E959BC494FD04FFC38EB794959BFFFFFFA1B7FD04FFCA95A2FD04FFB7%A1FFFFBD9BFFFFBD94958EB78E95CAFFA195FFFFFFCAFFA8FFCAFFA8FFCA%FFA8FFCAFFA8FFCAFFA8FFFFFFA8FFCAFFA8FFCAFFA8FFCAFFA8FFCAFFA8%FD07FFA8FD0BFFCAFD05FFA8CAA8FD07FFA8CAA8FD09FFA2CAA8FD05FFA8%FD05FFCAFD05FFA8FFFFFFA8FFFFFFA8FFCAFFA8FFCAFFFFFFCAFFFFFF%%EndDataendstreamendobj19 0 obj<</Length 21034>>stream
+%AI12_CompressedDataxZ2K(  *
+M**N8ZSSP= yu-o.T*J8N]1!0l0$3K ~<EA.8VDi:
+*u#?#Qxq3Ej l?UQrg\
+|.<C::5r<+`QL@`:
+>,l*r n:l0c|~V?h=q:-ciZtFpw nWC9`?tEB ><g3(B$.==+E KT,'?>$F|>?*`4
+-Y!|>L.E@<D$GZT
+:oCQfzixb~_v>  #}3p>S1 ?"2NFp1G7c"p6 	3JN+CFp|	w!>sA_P .g3qtF]_) L1?wg~>0[Mi0B0MUM'q "fjVt# $cUesie8OHwag1tF:l% 	nbBxQg,33wx=}R(x5+S0bR1atRg9!yaa??p0xHAo(^'h*A,&H^v&"9t$0)c	gsg(N,"O :%Lw~`<.MEUvotPw?>|a^`_w$e&/{C:fg[{h4`Qj@!Qa!at7Xd8V~%3)!WUwNmCHTcH#K^asPa@Gj9Csl0Y}Nt3bkMVHcTTI3VZw<Ix(<Um(]xbmt?Z~Fv-Y4T<2Kg"Agp4+!_L#Iso8e XHNwl}oRaGo+SRWY`Au4_Y6$yHw39{)Jcw1X(mx^qA.c; G*rVf{b}|F',7/D2}8z@s'brL.Hwg.LZV5v:OQ{K~:"x6O_6?vcbY>4~:F6up>`VdYu}7;LLTU
+uN?&54o	-eS[PSW~pz3bxk?ql]>x>Fbp&m9Io:qo8{cd'()A=aePX
+v;ghR}0IR[[}z6-m{,J_4A:%GLh8EC\|y<RQ4	\cRsLpyoNAluF'tI{FMC>btOkL~;CGY,Z7:pAo]Md6*vvzch=s6?B!0p,JdI7-d<dqh>k,QvbfL?#*Jp@I&BKk_]*3]R,``"A_"vF`Rb>Xq,Ccwa_XE>:5,M4biOyu<\}d}Hm'}*jCkZ[UvAFt.D3<rhIbl46*R\6,]);GTA{I<Fg1|x((Q9l`=Tuz`!up(H;GVi?DY=?P6j@&O?gI`Q!)MApdTx:D?;TY7quP+;J\gSG`V"<)a;4P4I q
+\Q6/uwIa*Q3~&];a[3 V
+7Q3t^Vs9wQOQF (z%dD#4"iRJyUdKn#l"qk[9DbQ-~vgfj7?FL)a*EH#A	 2"ualO{b`)3:fL8D2t:#H8}K~14vs'(8z-||38|Hl<vQ4we1)(]Vn[,rOsSMHN!= )NR4uxd+,>\:!'L'F\$(m#f?YQ&PP=34d!S_[>agE!0	0W%uqbljh:aQsJ3mL{vL=;l;V(
+;x&$zC9{&D	Kw9oo<3s ?mNZY/N#a;(y7`WTO;!,M6RFvhNT D$kkTuD0,"Q{?M*Lt\$t6TQchc >H
+(tC.fD8v75uSH .|DZgNd d.b^/ TG~PoQ\pXu	e]!?v@a:a;TZ"89?>/]44Hj$98Tn9fYor<D_b|:cT0PAmGt6)'zFJs2U|V0"9ijH"r1Pi3KXNMtr``H07tGCX9KmKS{I`5='l<>h;1Nd~]4n_]<e|Qwz$,[#=JG;s+}<$ruVG=iBQ1i}XS|B_TT"8
+N;!yQK,JzB1AX$53'0QPD3C
+Q< >?(3yuxTF6Y{58~eD3{`bU-3:B@_#-gbingM:7p*	YL34>L+<*:3suC'a=MUtw7;qQzlei-jG.nlTxMmGrhn_yoP:9v!0rg@;B"57<UfY_
+wd(P/K*]O{t]:>"jl?I6;>gv/R_7b=__u]e>CQJ$Pl{7=xbu(~v_%3M=D0tLMt:x9!y<&l-aI''~{TVEz~d^>,IR*oD.1hT9Pt=EgZZ*~>#Gx>@iz*[keS#&9+|CYFc*I;<LTNpx &)qR>dFn6HS6!U'-c>&&`~tb4KRf[iRM=<bZ+1vvH{NE*xU5gk5~[tEs[t mnma2J~bqVrFzI=I$6fuW33i OU?-j'zzY Cont0mmco!~"]Zn&B2aEa|n[Zo+5;1#m(HHiyc},=y"u*@z=SQlu0/Fg72b_H~{{)H:VDlOhHA;I%461~JEv(R>g[)>ME:"4g[QH-v?<C*IuiWM,]dYMGPA%[^E~_+tO24C\A6!?c0_|?U'43RbdJ\G
+299MncT6
+S(c{'4iE	=$dB)%cx-#=m4[9s7,oO/7CBgbT~ZX^Tmqm
+<~kl E{{66y_bBw9+E^gg[!,B{foCe*nC{[BCoOGmTYwJ&}b_Mou=g8yvG=dv-X4}'3:W|^sk'T7?N7_G7;Gi3=:U,HG!~/5K>~6N avKR,>hH&VOe7	YY,*da)(I\09*Uo,?VvxVKEW*1D[xz#O~dsv2|f,7~u*`a-[{j\}VEHStk~v1-[)^Rb|189 %}#TC*64w-B"M]o:Zi1T(Hi	[I$Zx*Rl;P"#t{:RP#MeVq=y0JOSoMXod"Nz*)*bO.*eoIEP<Dr=FonQ.}H
+&$?h:BOYUHwr8jMVtoA2Wyd?2`'~6#8G X2{1){)	KJ\#*}2>lJ?W	d3c_{$Edr}LM|}wb>Eg	!qbw{f=L9K+sk(Lwa;[DC|b@~fQ#@h]6&J|Q:Qh6<LR6|lv6<-60?bDw'45avjS=VXq}<lxZ{>ntu`UMa,6}c;"vd&u=nt~O=],$c9h/">dd<eB0>4#K z}/1OA^\ia3NI2%9ys=.6&[1[3IU*Vk*"V>FnKN}4mWa z~o8*.:?9.*Cr]0V[vfPEHKQE3Bqe3I4S<[fk2\+Uc]7uFout:Swcm+V*G=6vNKQSxv#B>mk	xp:}oKqGamXfS2G$ptw6@aa^A[ _&hvW`, , b[v&`XF=gvM?y]`##Vb\b8b%sb\#$lxH}	?'v%K(Zn w,nusFZC7XZdS	0M'sD!D?_sb9y`T
+In!EGe:S_>3Msv5a6xAetrnz'mprp]1'ONGo4q#;swR
+ N- bPaVGeu>VXTg1U^|UC%yUou\/ yyhpE#&(g|p}LdT<|&:1FEVf] 0ve8vG%er0(NLt$YNF\4%P+}iN@H49"	 %5%^ ~{k@1W8^d3E|&I5%>\dlLXHH9:Db]Tmg^&KU	^S=jf-]{ ];1JY35Q%+jOb+58@P4fZ	Oly75<4.V5V?4mn{E9:kg+ 8[:#cpy/0Zn"(">J`	:4S})=*
+9IY70t~~mG5R,<nU4-/Z)a;t.a[//;#/?$L)r?j=8mKd15fGekv_7{M?*9g
+S[Ktyq)b]Sm28[n6luRoVoA&.AGd-CGQY3[s#dK9g9g9ds#s3f.CA'b9g!N^Es<9td7/u_]Nns9l/T6jXrSbZNj^9if0aQg9y|fDo;]r'M!k^+(iI!tb
+"[A**ihQ7n~CAl}clPf%%yJK M0BfdZ^BB`WK7nID90r!$5I(3iqR1Fw,F4Oy`:#u+!ymN+zjHM1.15+2J[<>q2G8"%k-~O/K?	 3:~%N8%{.[7|Cb/ -( {xusngz0f.0f60 6WWmi4qK-'#f5v+9<hq,9F\RYbGS(,b_3;9VF=ur[D	%AE3Dc_/t\t:q3 J,gv#m|yd""VON.o1YIFA)Ixdt9Y##l"vv)a<'=2T{di-GwxOCqO	-AIh)#uL[~#)9Gau|8FI$McIY>HI,\L"6\	Y;#gi1?fCPlA:w!W%qG :4i2r|
+@Dv>,gU-{|87[M>|9#?|8z2|8AW+#+,1UQ8Wluj
+2K9&@qtK1 _z_{8UHU%2	/c4]{cpPEH!gv1"A6/sr\e}[.[Ix.7Vs0vmwJaoY,Wsg*B|c[eF*3RVTn-TTgTe({hS\5s@@Xa[Z%K"nT8rcW.URIGR+} Ze*t*Cy/huT5XBxK|2HJ__&S kf-</v?\f$6G8N"Q[-=%MF cPuoGE\mdCkTPkT@&}sAe)8mwVdU\Edf%l;nmdHwa>;%&HqQm
+:Ng:%tT^]^HMPij]sn{BK{pJv`MH^w!8 z|'T-qiVrM`7{jw.czi-.B J7y7j1u;vhsPj\jBu<{Mumj\S{\kX|}U3vin_U%9kn-{zGq}%p>Q^p
+:#^RzagOt"}tl:;C6`[*.~tv>@xtvth6s+zWMgHotn1;?{]&8r.ddl:UgsFVM%{-Ttl:(`p"Kirl*,Mg7+0.&gdlE)/b+I1tvt%4OsntvX7atv%\i6`6<SOF#gH=Zq_+X0 J3qM)EZ %y'RvU1>|cp[O]^vzu6otrlK0)(&{ct[%moSIlm#%ur%(a.aN-Ed>2;(Yx*2w/a[;t+={2wd'4%J;z|*YYn+t@D-E:]at5uy)\.sEB&FstSj9R@=kVM-& PFx| .th##
+KK `(f=Q#V
+c`=T`7'~Kbz=KTFFtmOaRt5%_z\%dY,3voWWo}21o	,V` 8!CbUa$2,qu3D<Tl-	P[V6l;"J*'T[v*9!?[ 9v
+w^o5=.ni\nXk5UG5}{0O,+gZ'9wJ?OHdA[_2tO}SZSjOf~UoC=WcW%glWRBqetUM^c_+UJy~s\K=N{2B{NXj:Lz5=Vo{J;KVVtwW}FhL%mJIe?X9Ai}%6u&)iK:R:lk|!oIo=	s1Mu=-K)3/k*M!SSixM6]ip6RS>\HjHj= o\vHa4V4EGZHHS\'-*RizC/y=LDu3"%efr
+1M#GDD~,^\oQF!lRm+)BPFVxb2PU1).RUM\,=IOe"(z$3VdmS+YiM=g55&k{K4[G\/;UXcce*Lu}2-*-P<$UVqo#TWZzwra@bnVK1J4YvJNuu6rWX2;kgD
+p3yUssYfF~YsHer.2,-m{<hdqxM$th9eh=95Q33HjyFW(bsQO.CB%]p`WX+oqUs mnh=Tg@ESM l|dRD%FkBUH%)JmdY^s 6*`E6E+-UXQQwDQ>E+y-z|P|W.R:%~dUe_w&wC-P:[&N{]?-7~+Saw{P5Z#U*scJu-]D<Es!@GC]?j#u7:>p]?C7P9NVT=cuGuPU(7G',W%Fg{]9WQ9-8MX2L]?l-X-z|=U#bO9j2\}z]i)Wd#k]?w9~UVS-Hk=/Snos-G0sJxVo4ojq^T]?g5_Nm,E[e\=>Y1W6uMWrgX~
+lUd9|]?@'Ple9OU-3[U&~+,9W36p]?~POg[0!vG^sU?}{BcU?T]tQgxu%r~qf}sPKUt4vw7-l&&LN/{jlD 	h)PQI'2F$_#.wwoqOU4;R(!GPhbb;Cf=f+$[JHx`k8>ob(~gB9;bgC7g/m_	3Mb"$Uy#Q+\dD*vn%E<~zymoa1l~~>N7/_m504ORoxJpY :Oc[/NQ:i#(>JBD,L*Xr$'bX-#MEc![-{]L_3]RVb{'6YmKq?6y!MqJE~t+14}}9v3=O-6d(=<DNBsv{^GB??arL>]v;'Zrz?>Sl{6?30I	K_2^/I	k# )0l2}lTG,FiO}UJ/8 H}qi/^aC6Y zJzssza+{(2+IW?r<<F\#`]1F YY {j1KN-Ow<M$  ,;8d>F8t['d"Wwe[l`/{bzcz1<,!h^@M=TUPY&E|NO|YB! wI G8E%O;FSJQGbWETj8@X:P(}+o(K+1#6cuG_w_)pL6FG*lF/Q_J}O<#T9feP*rjrrSQJ~ 0%-w@4NnaGmzF(y{GP,!U:vHI\T~h"$_N<X{quVeJ	*FE$ERB R\S$RP^#U^O\CTf]1)<pmT*G/,j5a,Wy>	YFn]FMwOx8I36Ii1'Vg>Yb|-l@.+wEu57w&%@L]I4M,dg66B spG`Z-@UuYi%6x<iI;b^1Ngu!URqiW./3]={wN|7o,-@@H(:T1>
+W@mqPD.1cwN7Zm,$=^Te?+]@;ex44Mu{8Kv~t "6+2*LQ[?aC_pWhp$bQb#HwwSkn|pzTO$b+^"^wuMtpnZ(	T*~oLvkJe>bW-` W`9<@UFl}%WX[lc=5<ARbncb.`Y\iLh6`fRe5L]WK'mM
+vu~'',?s_,W*uv%+k ^%$d]1h%rPt0%F,6H{Amys	fQyR-oG7;_Sf#v{Pe4>HB0y+n
+x:;9	U2ukW|}.3WoR}o Z	[Y u<RY,Loc'4%lW?8$J;/a-pfg{|11g<-43{AkgvK#SP?A_YC#A.B\(z|?,* Tqk2V/[p|WvrjZim;c`YbXoe}s.BBmld?kAn}-1o^+ri<.__1/0B4_s@9UVe|p~Gj >9[y;?|TJ`"To?cY[]n7w`W.ty]Lh*,Gg*^a8c':biJW}nE6@K*v(mgEcJT`36KQ@A:9nn^=6BEvMN{TmGx:--Y"A)!\1)y#R;h4]^/[.0xwxSUO<vx+iWc[4XU{?P,b1cpCAn+"=bCbL*lt4xX(	 > < ?[[?x=j5`t oi "3g*;	asj(BIj`{aG2>/:[vzg(qTGP}x(:?~<@GS5x;6ReC*{n<{1FMY+K.uGe	u F{#b$$(=_ULe%@%A/@	JyJ$5,D@IV9|>4NVA*><Dt7)|TQ4 &	G D"^/)_v	* rU:`q;Pra&2 8g @x  v,P l>8g
+`<px( :F K1UxAp^(y@f/.EZNj%Crc$4r?	\V$TI/@R'xla:v<\I\Ob2i?-@H)[)< G;2oVo
+..uvdlreu8SdR=|==ZUv.#|#2!%D$kFID]c0X5O>-d:_Dt'+n)8C8,lYMjR)8;z^	R/n~ bW{xa7Zc=h'Ws-+%z! +"dp[K|j<Ye(!S>m`4/$[FM67Z71"mQsXT,%n>F[J$S;F^jW8CcpQDOr\z%{!pi9<v:l+!~@,0l6#wY8'NIcO'+1UIOUO[}7}xx)oga5-'H@F|>30#P wdSQc{=_#RY7Ykgp^e=iGX4mz4_$F
+&`<q<qi3:(b} 82=Ng<bX
+;KNzE]rc{1J"6'4SV}77X5c#sZ7q6,D/9]!r<B&EB|Fx`'<:Q\DF<,X&KtYbOlWz-y!N.kN}7GEKX'
+cBy\C	Lgw~<&I"Ic{S?Z-?Vn{G{=<KypmTA+P$YwPqFi:#'ivf25l<Bgk!-6f!~V)"qjSqFr\HE3I-~*B\`)&VHjH-&a9Z+0Qs0f]+.K(v}:l[9r;jJrET4:J^?u9G_e^Fr/Uc<1f-,-*i/^-KBvs=d
+7.96^ }+FV	*=%?
+uwIGZ[)zZnvyw'h|Xje?JB%qj>h[Ty>~>/>*d{xz
+}]pz~lKs=/HxvRar+,sCeBvm)(sUETsX J|w`]3Uam!|nq},uaX,KQAO3eiix:$.8R,j)<Qz]`4&%VtLxm;/lx
+`"%IQDEXvCdgw9Lovwis}jf/wj>2"SD"]1p>IM.1#z(\BZ{z5NBrHm7RyP~gRrp19V~+GjwJ@N(a;J28+u^:Ou"r$	r&H zC W6Ip(`=Y%(DH%u"|IgG*	H `-x,^(xviJP(aVn e $|sCiH|)R@.3F@r~d0[}u;m^A0HSX[.aNe$g{\T>UB!%699lV/ 2hW+Fv/NXf=:/-k<4m:J#JMk)3[D=:ar5X=QeF=(<ux>HRPO]rGawrC#AiP@L8Le`mdK^bq&%W/SZH`#;EpP*MA\;W@<R$]BL VfM.n'S:'$	U<FWvHwJyJn j/F+=yN?GG}$X 19xGVru+ty[5[c5@:&.^ lwe/lUteklll]+_&lxakQ?Vd(Bb	F_;zRy9G+nhobG)BWH&p=Fa$/+x-aI]v/ bRRBLApC0qqQD(n}s;0:	lWF}0kq6vQ?,fAtF7m\44+zxY,mh@o6WQtl;0.,\>|.V|9_ O/l
+$XeTz|Y6|`$Le9\9x y'*MO@^`|FOKqeu`Pi<qY^3)a>XO(LMBe e:aR=Jg9PHCWr`:gXOy=Q3<g6R)PCGBIes@2l5,#YYasP#'0,f'#NgxOGi.CqL*QJA&C"qy&G|t^A(| IWrl:|:]ywC<9$}v#mL.A|F 0|xfa}eBzYAI`/? )ryDE<qphAT wH
+DiD5RQOQg,i9~Ee@d
+";A/ sMF`24< 	rr`3"#>)d0;}
+<Fe{`xEv`[>%e`@ppB&=1 S6`0i:R,pYBcP=6)@@ey>=J	)&+daK{Da$yxkCGJl0B2J2L:l..R6qiMv%f,$<bI&P4,CN{A`hf 31x`|:&[e #y_)<L$_K\+Rt`w"!EP@pr@X Ag`q9^NMZ f\
+d%6pyi2"&C$+lN.	HR!Tm0 >>`@;L az:,i`'aJ*65A"P<=@r9^{,p<BdEVe+W*Ks|
+) n
+q Ja|V F0ZB*CB]y< PAhLu%& 0@U4u@*?1F gvh6`HAL,=`plY/_irD,(=mi<QGshm{ aMdSid&V& Avs]vsC{B!US"" q~.?S*!G Sh5\%4,AG<,q3tN:#U:+*"b@
+`MWk
+9R]zH4xhe{gl&`J7;zvh<		~Ht6s7z?Q~Q_endstreamendobj6 0 obj[5 0 R]endobj20 0 obj<</CreationDate(D:20110328132859+11'00')/Creator(Adobe Illustrator CS5)/ModDate(D:20110328132859+11'00')/Producer(Adobe PDF library 9.90)/Title(Modernizr 2 Logo)>>endobjxref0 210000000000 65535 f
+0000000016 00000 n
+0000000144 00000 n
+0000018316 00000 n
+0000000000 00000 f
+0000020771 00000 n
+0000048490 00000 n
+0000018367 00000 n
+0000018703 00000 n
+0000021070 00000 n
+0000020957 00000 n
+0000019852 00000 n
+0000020210 00000 n
+0000020258 00000 n
+0000020841 00000 n
+0000020872 00000 n
+0000021143 00000 n
+0000021317 00000 n
+0000022336 00000 n
+0000027404 00000 n
+0000048513 00000 n
+trailer<</Size 21/Root 1 0 R/Info 20 0 R/ID[<8D44613111B047A982BB568568FC0997><DE399FA33D7D4432BF16917DBD7AD64E>]>>startxref48693%%EOF
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.png b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.png
new file mode 100644
index 0000000..0a945de
Binary files /dev/null and b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.png differ
diff --git a/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.svg b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.svg
new file mode 100644
index 0000000..5cb6bbc
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/media/Modernizr 2 Logo.svg	
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Generator: Adobe Illustrator 15.0.2, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
+<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
+	 width="600px" height="88.8px" viewBox="0 0 600 88.8" enable-background="new 0 0 600 88.8" xml:space="preserve">
+<g>
+	<polygon fill-rule="evenodd" clip-rule="evenodd" fill="#D91B77" points="0,86.4 0,57.6 28.8,57.6 28.8,28.8 57.6,28.8 57.6,0 
+		86.4,0 86.4,86.4 	"/>
+	<path fill-rule="evenodd" clip-rule="evenodd" fill="#D91B77" d="M93.6,0C141.318,0,180,38.683,180,86.399H93.6V0z"/>
+	<path fill="#D91B77" d="M580.505,50.198c-4.061,0-9.504,3.283-11.405,6.652v29.549h-6.479V44.668h6.479v6.653
+		c3.37-4.319,8.208-7.603,13.911-7.603v6.653C582.232,50.284,581.455,50.198,580.505,50.198z"/>
+	<polygon fill="#D91B77" points="551.648,86.399 519.854,86.399 519.854,81.303 542.836,50.371 519.854,50.371 519.854,44.668 
+		551.303,44.668 551.303,49.594 528.147,80.697 551.648,80.697 	"/>
+	<rect x="502.401" y="44.668" fill="#D91B77" width="6.479" height="41.731"/>
+	<path fill="#D91B77" d="M505.685,38.707c-2.42,0-4.407-1.901-4.407-4.32c0-2.419,1.987-4.407,4.407-4.407
+		c2.419,0,4.319,1.988,4.319,4.407C510.004,36.806,508.104,38.707,505.685,38.707z"/>
+	<path fill="#D91B77" d="M482.963,86.399V59.098c0-7.431-3.803-9.678-9.418-9.678c-5.098,0-9.85,3.111-12.355,6.48v30.499h-6.48
+		V44.668h6.48v6.048c2.938-3.542,8.64-7.084,14.947-7.084c8.64,0,13.219,4.407,13.219,13.479v29.289H482.963z"/>
+	<path fill="#D91B77" d="M444.083,50.198c-4.061,0-9.504,3.283-11.404,6.652v29.549h-6.479V44.668h6.479v6.653
+		c3.369-4.319,8.208-7.603,13.911-7.603v6.653C445.812,50.284,445.034,50.198,444.083,50.198z"/>
+	<polygon fill="#D91B77" points="258.067,86.399 258.067,37.93 238.541,86.399 235.604,86.399 215.991,37.93 215.991,86.399 
+		208.819,86.399 208.819,28.771 219.101,28.771 237.072,73.181 254.957,28.771 265.239,28.771 265.239,86.399 	"/>
+	<path fill="#D91B77" d="M415.746,66.01c0-12.528-7.431-22.378-20.046-22.378c-11.923,0-20.562,9.763-20.562,21.86
+		c0,13.047,8.898,21.945,21.341,21.945c6.739,0,12.355-2.333,16.589-6.479l-3.111-4.234c-3.369,3.456-8.121,5.356-12.96,5.356
+		c-8.985,0-14.429-6.565-14.946-14.428h33.696V66.01z M381.963,62.812c0.346-6.307,4.752-13.824,13.651-13.824
+		c9.504,0,13.651,7.69,13.737,13.824H381.963z"/>
+	<path fill="#D91B77" d="M358.117,28.771v22.205c-3.37-4.579-8.468-7.344-14.084-7.344c-10.887,0-18.575,8.554-18.575,21.946
+		c0,13.565,7.688,21.859,18.575,21.859c5.876,0,10.974-3.023,14.084-7.258v6.221h6.479V28.771H358.117z M358.117,74.995
+		c-2.247,3.628-7.344,6.652-12.442,6.652c-8.467,0-13.478-6.825-13.478-16.07s5.011-16.157,13.478-16.157
+		c5.099,0,10.195,3.111,12.442,6.739V74.995z"/>
+	<path fill="#D91B77" d="M296.687,43.631c-12.701,0-20.649,9.763-20.649,21.86c0,12.096,7.948,21.945,20.649,21.945
+		s20.65-9.85,20.65-21.945C317.337,53.395,309.388,43.631,296.687,43.631z M296.687,81.647c-8.899,0-13.824-7.603-13.824-16.156
+		c0-8.468,4.925-16.071,13.824-16.071c8.9,0,13.824,7.604,13.824,16.071C310.511,74.045,305.587,81.647,296.687,81.647z"/>
+</g>
+</svg>
diff --git a/profiles/commons/libraries/modernizr/modernizr.js b/profiles/commons/libraries/modernizr/modernizr.js
new file mode 100644
index 0000000..ebc047c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/modernizr.js
@@ -0,0 +1,1406 @@
+/*!
+ * Modernizr v2.7.0
+ * www.modernizr.com
+ *
+ * Copyright (c) Faruk Ates, Paul Irish, Alex Sexton
+ * Available under the BSD and MIT licenses: www.modernizr.com/license/
+ */
+
+/*
+ * Modernizr tests which native CSS3 and HTML5 features are available in
+ * the current UA and makes the results available to you in two ways:
+ * as properties on a global Modernizr object, and as classes on the
+ * <html> element. This information allows you to progressively enhance
+ * your pages with a granular level of control over the experience.
+ *
+ * Modernizr has an optional (not included) conditional resource loader
+ * called Modernizr.load(), based on Yepnope.js (yepnopejs.com).
+ * To get a build that includes Modernizr.load(), as well as choosing
+ * which tests to include, go to www.modernizr.com/download/
+ *
+ * Authors        Faruk Ates, Paul Irish, Alex Sexton
+ * Contributors   Ryan Seddon, Ben Alman
+ */
+
+window.Modernizr = (function( window, document, undefined ) {
+
+    var version = '2.7.0',
+
+    Modernizr = {},
+
+    /*>>cssclasses*/
+    // option for enabling the HTML classes to be added
+    enableClasses = true,
+    /*>>cssclasses*/
+
+    docElement = document.documentElement,
+
+    /**
+     * Create our "modernizr" element that we do most feature tests on.
+     */
+    mod = 'modernizr',
+    modElem = document.createElement(mod),
+    mStyle = modElem.style,
+
+    /**
+     * Create the input element for various Web Forms feature tests.
+     */
+    inputElem /*>>inputelem*/ = document.createElement('input') /*>>inputelem*/ ,
+
+    /*>>smile*/
+    smile = ':)',
+    /*>>smile*/
+
+    toString = {}.toString,
+
+    // TODO :: make the prefixes more granular
+    /*>>prefixes*/
+    // List of property values to set for css tests. See ticket #21
+    prefixes = ' -webkit- -moz- -o- -ms- '.split(' '),
+    /*>>prefixes*/
+
+    /*>>domprefixes*/
+    // Following spec is to expose vendor-specific style properties as:
+    //   elem.style.WebkitBorderRadius
+    // and the following would be incorrect:
+    //   elem.style.webkitBorderRadius
+
+    // Webkit ghosts their properties in lowercase but Opera & Moz do not.
+    // Microsoft uses a lowercase `ms` instead of the correct `Ms` in IE8+
+    //   erik.eae.net/archives/2008/03/10/21.48.10/
+
+    // More here: github.com/Modernizr/Modernizr/issues/issue/21
+    omPrefixes = 'Webkit Moz O ms',
+
+    cssomPrefixes = omPrefixes.split(' '),
+
+    domPrefixes = omPrefixes.toLowerCase().split(' '),
+    /*>>domprefixes*/
+
+    /*>>ns*/
+    ns = {'svg': 'http://www.w3.org/2000/svg'},
+    /*>>ns*/
+
+    tests = {},
+    inputs = {},
+    attrs = {},
+
+    classes = [],
+
+    slice = classes.slice,
+
+    featureName, // used in testing loop
+
+
+    /*>>teststyles*/
+    // Inject element with style element and some CSS rules
+    injectElementWithStyles = function( rule, callback, nodes, testnames ) {
+
+      var style, ret, node, docOverflow,
+          div = document.createElement('div'),
+          // After page load injecting a fake body doesn't work so check if body exists
+          body = document.body,
+          // IE6 and 7 won't return offsetWidth or offsetHeight unless it's in the body element, so we fake it.
+          fakeBody = body || document.createElement('body');
+
+      if ( parseInt(nodes, 10) ) {
+          // In order not to give false positives we create a node for each test
+          // This also allows the method to scale for unspecified uses
+          while ( nodes-- ) {
+              node = document.createElement('div');
+              node.id = testnames ? testnames[nodes] : mod + (nodes + 1);
+              div.appendChild(node);
+          }
+      }
+
+      // <style> elements in IE6-9 are considered 'NoScope' elements and therefore will be removed
+      // when injected with innerHTML. To get around this you need to prepend the 'NoScope' element
+      // with a 'scoped' element, in our case the soft-hyphen entity as it won't mess with our measurements.
+      // msdn.microsoft.com/en-us/library/ms533897%28VS.85%29.aspx
+      // Documents served as xml will throw if using &shy; so use xml friendly encoded version. See issue #277
+      style = ['&#173;','<style id="s', mod, '">', rule, '</style>'].join('');
+      div.id = mod;
+      // IE6 will false positive on some tests due to the style element inside the test div somehow interfering offsetHeight, so insert it into body or fakebody.
+      // Opera will act all quirky when injecting elements in documentElement when page is served as xml, needs fakebody too. #270
+      (body ? div : fakeBody).innerHTML += style;
+      fakeBody.appendChild(div);
+      if ( !body ) {
+          //avoid crashing IE8, if background image is used
+          fakeBody.style.background = '';
+          //Safari 5.13/5.1.4 OSX stops loading if ::-webkit-scrollbar is used and scrollbars are visible
+          fakeBody.style.overflow = 'hidden';
+          docOverflow = docElement.style.overflow;
+          docElement.style.overflow = 'hidden';
+          docElement.appendChild(fakeBody);
+      }
+
+      ret = callback(div, rule);
+      // If this is done after page load we don't want to remove the body so check if body exists
+      if ( !body ) {
+          fakeBody.parentNode.removeChild(fakeBody);
+          docElement.style.overflow = docOverflow;
+      } else {
+          div.parentNode.removeChild(div);
+      }
+
+      return !!ret;
+
+    },
+    /*>>teststyles*/
+
+    /*>>mq*/
+    // adapted from matchMedia polyfill
+    // by Scott Jehl and Paul Irish
+    // gist.github.com/786768
+    testMediaQuery = function( mq ) {
+
+      var matchMedia = window.matchMedia || window.msMatchMedia;
+      if ( matchMedia ) {
+        return matchMedia(mq).matches;
+      }
+
+      var bool;
+
+      injectElementWithStyles('@media ' + mq + ' { #' + mod + ' { position: absolute; } }', function( node ) {
+        bool = (window.getComputedStyle ?
+                  getComputedStyle(node, null) :
+                  node.currentStyle)['position'] == 'absolute';
+      });
+
+      return bool;
+
+     },
+     /*>>mq*/
+
+
+    /*>>hasevent*/
+    //
+    // isEventSupported determines if a given element supports the given event
+    // kangax.github.com/iseventsupported/
+    //
+    // The following results are known incorrects:
+    //   Modernizr.hasEvent("webkitTransitionEnd", elem) // false negative
+    //   Modernizr.hasEvent("textInput") // in Webkit. github.com/Modernizr/Modernizr/issues/333
+    //   ...
+    isEventSupported = (function() {
+
+      var TAGNAMES = {
+        'select': 'input', 'change': 'input',
+        'submit': 'form', 'reset': 'form',
+        'error': 'img', 'load': 'img', 'abort': 'img'
+      };
+
+      function isEventSupported( eventName, element ) {
+
+        element = element || document.createElement(TAGNAMES[eventName] || 'div');
+        eventName = 'on' + eventName;
+
+        // When using `setAttribute`, IE skips "unload", WebKit skips "unload" and "resize", whereas `in` "catches" those
+        var isSupported = eventName in element;
+
+        if ( !isSupported ) {
+          // If it has no `setAttribute` (i.e. doesn't implement Node interface), try generic element
+          if ( !element.setAttribute ) {
+            element = document.createElement('div');
+          }
+          if ( element.setAttribute && element.removeAttribute ) {
+            element.setAttribute(eventName, '');
+            isSupported = is(element[eventName], 'function');
+
+            // If property was created, "remove it" (by setting value to `undefined`)
+            if ( !is(element[eventName], 'undefined') ) {
+              element[eventName] = undefined;
+            }
+            element.removeAttribute(eventName);
+          }
+        }
+
+        element = null;
+        return isSupported;
+      }
+      return isEventSupported;
+    })(),
+    /*>>hasevent*/
+
+    // TODO :: Add flag for hasownprop ? didn't last time
+
+    // hasOwnProperty shim by kangax needed for Safari 2.0 support
+    _hasOwnProperty = ({}).hasOwnProperty, hasOwnProp;
+
+    if ( !is(_hasOwnProperty, 'undefined') && !is(_hasOwnProperty.call, 'undefined') ) {
+      hasOwnProp = function (object, property) {
+        return _hasOwnProperty.call(object, property);
+      };
+    }
+    else {
+      hasOwnProp = function (object, property) { /* yes, this can give false positives/negatives, but most of the time we don't care about those */
+        return ((property in object) && is(object.constructor.prototype[property], 'undefined'));
+      };
+    }
+
+    // Adapted from ES5-shim https://github.com/kriskowal/es5-shim/blob/master/es5-shim.js
+    // es5.github.com/#x15.3.4.5
+
+    if (!Function.prototype.bind) {
+      Function.prototype.bind = function bind(that) {
+
+        var target = this;
+
+        if (typeof target != "function") {
+            throw new TypeError();
+        }
+
+        var args = slice.call(arguments, 1),
+            bound = function () {
+
+            if (this instanceof bound) {
+
+              var F = function(){};
+              F.prototype = target.prototype;
+              var self = new F();
+
+              var result = target.apply(
+                  self,
+                  args.concat(slice.call(arguments))
+              );
+              if (Object(result) === result) {
+                  return result;
+              }
+              return self;
+
+            } else {
+
+              return target.apply(
+                  that,
+                  args.concat(slice.call(arguments))
+              );
+
+            }
+
+        };
+
+        return bound;
+      };
+    }
+
+    /**
+     * setCss applies given styles to the Modernizr DOM node.
+     */
+    function setCss( str ) {
+        mStyle.cssText = str;
+    }
+
+    /**
+     * setCssAll extrapolates all vendor-specific css strings.
+     */
+    function setCssAll( str1, str2 ) {
+        return setCss(prefixes.join(str1 + ';') + ( str2 || '' ));
+    }
+
+    /**
+     * is returns a boolean for if typeof obj is exactly type.
+     */
+    function is( obj, type ) {
+        return typeof obj === type;
+    }
+
+    /**
+     * contains returns a boolean for if substr is found within str.
+     */
+    function contains( str, substr ) {
+        return !!~('' + str).indexOf(substr);
+    }
+
+    /*>>testprop*/
+
+    // testProps is a generic CSS / DOM property test.
+
+    // In testing support for a given CSS property, it's legit to test:
+    //    `elem.style[styleName] !== undefined`
+    // If the property is supported it will return an empty string,
+    // if unsupported it will return undefined.
+
+    // We'll take advantage of this quick test and skip setting a style
+    // on our modernizr element, but instead just testing undefined vs
+    // empty string.
+
+    // Because the testing of the CSS property names (with "-", as
+    // opposed to the camelCase DOM properties) is non-portable and
+    // non-standard but works in WebKit and IE (but not Gecko or Opera),
+    // we explicitly reject properties with dashes so that authors
+    // developing in WebKit or IE first don't end up with
+    // browser-specific content by accident.
+
+    function testProps( props, prefixed ) {
+        for ( var i in props ) {
+            var prop = props[i];
+            if ( !contains(prop, "-") && mStyle[prop] !== undefined ) {
+                return prefixed == 'pfx' ? prop : true;
+            }
+        }
+        return false;
+    }
+    /*>>testprop*/
+
+    // TODO :: add testDOMProps
+    /**
+     * testDOMProps is a generic DOM property test; if a browser supports
+     *   a certain property, it won't return undefined for it.
+     */
+    function testDOMProps( props, obj, elem ) {
+        for ( var i in props ) {
+            var item = obj[props[i]];
+            if ( item !== undefined) {
+
+                // return the property name as a string
+                if (elem === false) return props[i];
+
+                // let's bind a function
+                if (is(item, 'function')){
+                  // default to autobind unless override
+                  return item.bind(elem || obj);
+                }
+
+                // return the unbound function or obj or value
+                return item;
+            }
+        }
+        return false;
+    }
+
+    /*>>testallprops*/
+    /**
+     * testPropsAll tests a list of DOM properties we want to check against.
+     *   We specify literally ALL possible (known and/or likely) properties on
+     *   the element including the non-vendor prefixed one, for forward-
+     *   compatibility.
+     */
+    function testPropsAll( prop, prefixed, elem ) {
+
+        var ucProp  = prop.charAt(0).toUpperCase() + prop.slice(1),
+            props   = (prop + ' ' + cssomPrefixes.join(ucProp + ' ') + ucProp).split(' ');
+
+        // did they call .prefixed('boxSizing') or are we just testing a prop?
+        if(is(prefixed, "string") || is(prefixed, "undefined")) {
+          return testProps(props, prefixed);
+
+        // otherwise, they called .prefixed('requestAnimationFrame', window[, elem])
+        } else {
+          props = (prop + ' ' + (domPrefixes).join(ucProp + ' ') + ucProp).split(' ');
+          return testDOMProps(props, prefixed, elem);
+        }
+    }
+    /*>>testallprops*/
+
+
+    /**
+     * Tests
+     * -----
+     */
+
+    // The *new* flexbox
+    // dev.w3.org/csswg/css3-flexbox
+
+    tests['flexbox'] = function() {
+      return testPropsAll('flexWrap');
+    };
+
+    // The *old* flexbox
+    // www.w3.org/TR/2009/WD-css3-flexbox-20090723/
+
+    tests['flexboxlegacy'] = function() {
+        return testPropsAll('boxDirection');
+    };
+
+    // On the S60 and BB Storm, getContext exists, but always returns undefined
+    // so we actually have to call getContext() to verify
+    // github.com/Modernizr/Modernizr/issues/issue/97/
+
+    tests['canvas'] = function() {
+        var elem = document.createElement('canvas');
+        return !!(elem.getContext && elem.getContext('2d'));
+    };
+
+    tests['canvastext'] = function() {
+        return !!(Modernizr['canvas'] && is(document.createElement('canvas').getContext('2d').fillText, 'function'));
+    };
+
+    // webk.it/70117 is tracking a legit WebGL feature detect proposal
+
+    // We do a soft detect which may false positive in order to avoid
+    // an expensive context creation: bugzil.la/732441
+
+    tests['webgl'] = function() {
+        return !!window.WebGLRenderingContext;
+    };
+
+    /*
+     * The Modernizr.touch test only indicates if the browser supports
+     *    touch events, which does not necessarily reflect a touchscreen
+     *    device, as evidenced by tablets running Windows 7 or, alas,
+     *    the Palm Pre / WebOS (touch) phones.
+     *
+     * Additionally, Chrome (desktop) used to lie about its support on this,
+     *    but that has since been rectified: crbug.com/36415
+     *
+     * We also test for Firefox 4 Multitouch Support.
+     *
+     * For more info, see: modernizr.github.com/Modernizr/touch.html
+     */
+
+    tests['touch'] = function() {
+        var bool;
+
+        if(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
+          bool = true;
+        } else {
+          injectElementWithStyles(['@media (',prefixes.join('touch-enabled),('),mod,')','{#modernizr{top:9px;position:absolute}}'].join(''), function( node ) {
+            bool = node.offsetTop === 9;
+          });
+        }
+
+        return bool;
+    };
+
+
+    // geolocation is often considered a trivial feature detect...
+    // Turns out, it's quite tricky to get right:
+    //
+    // Using !!navigator.geolocation does two things we don't want. It:
+    //   1. Leaks memory in IE9: github.com/Modernizr/Modernizr/issues/513
+    //   2. Disables page caching in WebKit: webk.it/43956
+    //
+    // Meanwhile, in Firefox < 8, an about:config setting could expose
+    // a false positive that would throw an exception: bugzil.la/688158
+
+    tests['geolocation'] = function() {
+        return 'geolocation' in navigator;
+    };
+
+
+    tests['postmessage'] = function() {
+      return !!window.postMessage;
+    };
+
+
+    // Chrome incognito mode used to throw an exception when using openDatabase
+    // It doesn't anymore.
+    tests['websqldatabase'] = function() {
+      return !!window.openDatabase;
+    };
+
+    // Vendors had inconsistent prefixing with the experimental Indexed DB:
+    // - Webkit's implementation is accessible through webkitIndexedDB
+    // - Firefox shipped moz_indexedDB before FF4b9, but since then has been mozIndexedDB
+    // For speed, we don't test the legacy (and beta-only) indexedDB
+    tests['indexedDB'] = function() {
+      return !!testPropsAll("indexedDB", window);
+    };
+
+    // documentMode logic from YUI to filter out IE8 Compat Mode
+    //   which false positives.
+    tests['hashchange'] = function() {
+      return isEventSupported('hashchange', window) && (document.documentMode === undefined || document.documentMode > 7);
+    };
+
+    // Per 1.6:
+    // This used to be Modernizr.historymanagement but the longer
+    // name has been deprecated in favor of a shorter and property-matching one.
+    // The old API is still available in 1.6, but as of 2.0 will throw a warning,
+    // and in the first release thereafter disappear entirely.
+    tests['history'] = function() {
+      return !!(window.history && history.pushState);
+    };
+
+    tests['draganddrop'] = function() {
+        var div = document.createElement('div');
+        return ('draggable' in div) || ('ondragstart' in div && 'ondrop' in div);
+    };
+
+    // FF3.6 was EOL'ed on 4/24/12, but the ESR version of FF10
+    // will be supported until FF19 (2/12/13), at which time, ESR becomes FF17.
+    // FF10 still uses prefixes, so check for it until then.
+    // for more ESR info, see: mozilla.org/en-US/firefox/organizations/faq/
+    tests['websockets'] = function() {
+        return 'WebSocket' in window || 'MozWebSocket' in window;
+    };
+
+
+    // css-tricks.com/rgba-browser-support/
+    tests['rgba'] = function() {
+        // Set an rgba() color and check the returned value
+
+        setCss('background-color:rgba(150,255,150,.5)');
+
+        return contains(mStyle.backgroundColor, 'rgba');
+    };
+
+    tests['hsla'] = function() {
+        // Same as rgba(), in fact, browsers re-map hsla() to rgba() internally,
+        //   except IE9 who retains it as hsla
+
+        setCss('background-color:hsla(120,40%,100%,.5)');
+
+        return contains(mStyle.backgroundColor, 'rgba') || contains(mStyle.backgroundColor, 'hsla');
+    };
+
+    tests['multiplebgs'] = function() {
+        // Setting multiple images AND a color on the background shorthand property
+        //  and then querying the style.background property value for the number of
+        //  occurrences of "url(" is a reliable method for detecting ACTUAL support for this!
+
+        setCss('background:url(https://),url(https://),red url(https://)');
+
+        // If the UA supports multiple backgrounds, there should be three occurrences
+        //   of the string "url(" in the return value for elemStyle.background
+
+        return (/(url\s*\(.*?){3}/).test(mStyle.background);
+    };
+
+
+
+    // this will false positive in Opera Mini
+    //   github.com/Modernizr/Modernizr/issues/396
+
+    tests['backgroundsize'] = function() {
+        return testPropsAll('backgroundSize');
+    };
+
+    tests['borderimage'] = function() {
+        return testPropsAll('borderImage');
+    };
+
+
+    // Super comprehensive table about all the unique implementations of
+    // border-radius: muddledramblings.com/table-of-css3-border-radius-compliance
+
+    tests['borderradius'] = function() {
+        return testPropsAll('borderRadius');
+    };
+
+    // WebOS unfortunately false positives on this test.
+    tests['boxshadow'] = function() {
+        return testPropsAll('boxShadow');
+    };
+
+    // FF3.0 will false positive on this test
+    tests['textshadow'] = function() {
+        return document.createElement('div').style.textShadow === '';
+    };
+
+
+    tests['opacity'] = function() {
+        // Browsers that actually have CSS Opacity implemented have done so
+        //  according to spec, which means their return values are within the
+        //  range of [0.0,1.0] - including the leading zero.
+
+        setCssAll('opacity:.55');
+
+        // The non-literal . in this regex is intentional:
+        //   German Chrome returns this value as 0,55
+        // github.com/Modernizr/Modernizr/issues/#issue/59/comment/516632
+        return (/^0.55$/).test(mStyle.opacity);
+    };
+
+
+    // Note, Android < 4 will pass this test, but can only animate
+    //   a single property at a time
+    //   daneden.me/2011/12/putting-up-with-androids-bullshit/
+    tests['cssanimations'] = function() {
+        return testPropsAll('animationName');
+    };
+
+
+    tests['csscolumns'] = function() {
+        return testPropsAll('columnCount');
+    };
+
+
+    tests['cssgradients'] = function() {
+        /**
+         * For CSS Gradients syntax, please see:
+         * webkit.org/blog/175/introducing-css-gradients/
+         * developer.mozilla.org/en/CSS/-moz-linear-gradient
+         * developer.mozilla.org/en/CSS/-moz-radial-gradient
+         * dev.w3.org/csswg/css3-images/#gradients-
+         */
+
+        var str1 = 'background-image:',
+            str2 = 'gradient(linear,left top,right bottom,from(#9f9),to(white));',
+            str3 = 'linear-gradient(left top,#9f9, white);';
+
+        setCss(
+             // legacy webkit syntax (FIXME: remove when syntax not in use anymore)
+              (str1 + '-webkit- '.split(' ').join(str2 + str1) +
+             // standard syntax             // trailing 'background-image:'
+              prefixes.join(str3 + str1)).slice(0, -str1.length)
+        );
+
+        return contains(mStyle.backgroundImage, 'gradient');
+    };
+
+
+    tests['cssreflections'] = function() {
+        return testPropsAll('boxReflect');
+    };
+
+
+    tests['csstransforms'] = function() {
+        return !!testPropsAll('transform');
+    };
+
+
+    tests['csstransforms3d'] = function() {
+
+        var ret = !!testPropsAll('perspective');
+
+        // Webkit's 3D transforms are passed off to the browser's own graphics renderer.
+        //   It works fine in Safari on Leopard and Snow Leopard, but not in Chrome in
+        //   some conditions. As a result, Webkit typically recognizes the syntax but
+        //   will sometimes throw a false positive, thus we must do a more thorough check:
+        if ( ret && 'webkitPerspective' in docElement.style ) {
+
+          // Webkit allows this media query to succeed only if the feature is enabled.
+          // `@media (transform-3d),(-webkit-transform-3d){ ... }`
+          injectElementWithStyles('@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}', function( node, rule ) {
+            ret = node.offsetLeft === 9 && node.offsetHeight === 3;
+          });
+        }
+        return ret;
+    };
+
+
+    tests['csstransitions'] = function() {
+        return testPropsAll('transition');
+    };
+
+
+    /*>>fontface*/
+    // @font-face detection routine by Diego Perini
+    // javascript.nwbox.com/CSSSupport/
+
+    // false positives:
+    //   WebOS github.com/Modernizr/Modernizr/issues/342
+    //   WP7   github.com/Modernizr/Modernizr/issues/538
+    tests['fontface'] = function() {
+        var bool;
+
+        injectElementWithStyles('@font-face {font-family:"font";src:url("https://")}', function( node, rule ) {
+          var style = document.getElementById('smodernizr'),
+              sheet = style.sheet || style.styleSheet,
+              cssText = sheet ? (sheet.cssRules && sheet.cssRules[0] ? sheet.cssRules[0].cssText : sheet.cssText || '') : '';
+
+          bool = /src/i.test(cssText) && cssText.indexOf(rule.split(' ')[0]) === 0;
+        });
+
+        return bool;
+    };
+    /*>>fontface*/
+
+    // CSS generated content detection
+    tests['generatedcontent'] = function() {
+        var bool;
+
+        injectElementWithStyles(['#',mod,'{font:0/0 a}#',mod,':after{content:"',smile,'";visibility:hidden;font:3px/1 a}'].join(''), function( node ) {
+          bool = node.offsetHeight >= 3;
+        });
+
+        return bool;
+    };
+
+
+
+    // These tests evaluate support of the video/audio elements, as well as
+    // testing what types of content they support.
+    //
+    // We're using the Boolean constructor here, so that we can extend the value
+    // e.g.  Modernizr.video     // true
+    //       Modernizr.video.ogg // 'probably'
+    //
+    // Codec values from : github.com/NielsLeenheer/html5test/blob/9106a8/index.html#L845
+    //                     thx to NielsLeenheer and zcorpan
+
+    // Note: in some older browsers, "no" was a return value instead of empty string.
+    //   It was live in FF3.5.0 and 3.5.1, but fixed in 3.5.2
+    //   It was also live in Safari 4.0.0 - 4.0.4, but fixed in 4.0.5
+
+    tests['video'] = function() {
+        var elem = document.createElement('video'),
+            bool = false;
+
+        // IE9 Running on Windows Server SKU can cause an exception to be thrown, bug #224
+        try {
+            if ( bool = !!elem.canPlayType ) {
+                bool      = new Boolean(bool);
+                bool.ogg  = elem.canPlayType('video/ogg; codecs="theora"')      .replace(/^no$/,'');
+
+                // Without QuickTime, this value will be `undefined`. github.com/Modernizr/Modernizr/issues/546
+                bool.h264 = elem.canPlayType('video/mp4; codecs="avc1.42E01E"') .replace(/^no$/,'');
+
+                bool.webm = elem.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,'');
+            }
+
+        } catch(e) { }
+
+        return bool;
+    };
+
+    tests['audio'] = function() {
+        var elem = document.createElement('audio'),
+            bool = false;
+
+        try {
+            if ( bool = !!elem.canPlayType ) {
+                bool      = new Boolean(bool);
+                bool.ogg  = elem.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,'');
+                bool.mp3  = elem.canPlayType('audio/mpeg;')               .replace(/^no$/,'');
+
+                // Mimetypes accepted:
+                //   developer.mozilla.org/En/Media_formats_supported_by_the_audio_and_video_elements
+                //   bit.ly/iphoneoscodecs
+                bool.wav  = elem.canPlayType('audio/wav; codecs="1"')     .replace(/^no$/,'');
+                bool.m4a  = ( elem.canPlayType('audio/x-m4a;')            ||
+                              elem.canPlayType('audio/aac;'))             .replace(/^no$/,'');
+            }
+        } catch(e) { }
+
+        return bool;
+    };
+
+
+    // In FF4, if disabled, window.localStorage should === null.
+
+    // Normally, we could not test that directly and need to do a
+    //   `('localStorage' in window) && ` test first because otherwise Firefox will
+    //   throw bugzil.la/365772 if cookies are disabled
+
+    // Also in iOS5 Private Browsing mode, attempting to use localStorage.setItem
+    // will throw the exception:
+    //   QUOTA_EXCEEDED_ERRROR DOM Exception 22.
+    // Peculiarly, getItem and removeItem calls do not throw.
+
+    // Because we are forced to try/catch this, we'll go aggressive.
+
+    // Just FWIW: IE8 Compat mode supports these features completely:
+    //   www.quirksmode.org/dom/html5.html
+    // But IE8 doesn't support either with local files
+
+    tests['localstorage'] = function() {
+        try {
+            localStorage.setItem(mod, mod);
+            localStorage.removeItem(mod);
+            return true;
+        } catch(e) {
+            return false;
+        }
+    };
+
+    tests['sessionstorage'] = function() {
+        try {
+            sessionStorage.setItem(mod, mod);
+            sessionStorage.removeItem(mod);
+            return true;
+        } catch(e) {
+            return false;
+        }
+    };
+
+
+    tests['webworkers'] = function() {
+        return !!window.Worker;
+    };
+
+
+    tests['applicationcache'] = function() {
+        return !!window.applicationCache;
+    };
+
+
+    // Thanks to Erik Dahlstrom
+    tests['svg'] = function() {
+        return !!document.createElementNS && !!document.createElementNS(ns.svg, 'svg').createSVGRect;
+    };
+
+    // specifically for SVG inline in HTML, not within XHTML
+    // test page: paulirish.com/demo/inline-svg
+    tests['inlinesvg'] = function() {
+      var div = document.createElement('div');
+      div.innerHTML = '<svg/>';
+      return (div.firstChild && div.firstChild.namespaceURI) == ns.svg;
+    };
+
+    // SVG SMIL animation
+    tests['smil'] = function() {
+        return !!document.createElementNS && /SVGAnimate/.test(toString.call(document.createElementNS(ns.svg, 'animate')));
+    };
+
+    // This test is only for clip paths in SVG proper, not clip paths on HTML content
+    // demo: srufaculty.sru.edu/david.dailey/svg/newstuff/clipPath4.svg
+
+    // However read the comments to dig into applying SVG clippaths to HTML content here:
+    //   github.com/Modernizr/Modernizr/issues/213#issuecomment-1149491
+    tests['svgclippaths'] = function() {
+        return !!document.createElementNS && /SVGClipPath/.test(toString.call(document.createElementNS(ns.svg, 'clipPath')));
+    };
+
+    /*>>webforms*/
+    // input features and input types go directly onto the ret object, bypassing the tests loop.
+    // Hold this guy to execute in a moment.
+    function webforms() {
+        /*>>input*/
+        // Run through HTML5's new input attributes to see if the UA understands any.
+        // We're using f which is the <input> element created early on
+        // Mike Taylr has created a comprehensive resource for testing these attributes
+        //   when applied to all input types:
+        //   miketaylr.com/code/input-type-attr.html
+        // spec: www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#input-type-attr-summary
+
+        // Only input placeholder is tested while textarea's placeholder is not.
+        // Currently Safari 4 and Opera 11 have support only for the input placeholder
+        // Both tests are available in feature-detects/forms-placeholder.js
+        Modernizr['input'] = (function( props ) {
+            for ( var i = 0, len = props.length; i < len; i++ ) {
+                attrs[ props[i] ] = !!(props[i] in inputElem);
+            }
+            if (attrs.list){
+              // safari false positive's on datalist: webk.it/74252
+              // see also github.com/Modernizr/Modernizr/issues/146
+              attrs.list = !!(document.createElement('datalist') && window.HTMLDataListElement);
+            }
+            return attrs;
+        })('autocomplete autofocus list placeholder max min multiple pattern required step'.split(' '));
+        /*>>input*/
+
+        /*>>inputtypes*/
+        // Run through HTML5's new input types to see if the UA understands any.
+        //   This is put behind the tests runloop because it doesn't return a
+        //   true/false like all the other tests; instead, it returns an object
+        //   containing each input type with its corresponding true/false value
+
+        // Big thanks to @miketaylr for the html5 forms expertise. miketaylr.com/
+        Modernizr['inputtypes'] = (function(props) {
+
+            for ( var i = 0, bool, inputElemType, defaultView, len = props.length; i < len; i++ ) {
+
+                inputElem.setAttribute('type', inputElemType = props[i]);
+                bool = inputElem.type !== 'text';
+
+                // We first check to see if the type we give it sticks..
+                // If the type does, we feed it a textual value, which shouldn't be valid.
+                // If the value doesn't stick, we know there's input sanitization which infers a custom UI
+                if ( bool ) {
+
+                    inputElem.value         = smile;
+                    inputElem.style.cssText = 'position:absolute;visibility:hidden;';
+
+                    if ( /^range$/.test(inputElemType) && inputElem.style.WebkitAppearance !== undefined ) {
+
+                      docElement.appendChild(inputElem);
+                      defaultView = document.defaultView;
+
+                      // Safari 2-4 allows the smiley as a value, despite making a slider
+                      bool =  defaultView.getComputedStyle &&
+                              defaultView.getComputedStyle(inputElem, null).WebkitAppearance !== 'textfield' &&
+                              // Mobile android web browser has false positive, so must
+                              // check the height to see if the widget is actually there.
+                              (inputElem.offsetHeight !== 0);
+
+                      docElement.removeChild(inputElem);
+
+                    } else if ( /^(search|tel)$/.test(inputElemType) ){
+                      // Spec doesn't define any special parsing or detectable UI
+                      //   behaviors so we pass these through as true
+
+                      // Interestingly, opera fails the earlier test, so it doesn't
+                      //  even make it here.
+
+                    } else if ( /^(url|email)$/.test(inputElemType) ) {
+                      // Real url and email support comes with prebaked validation.
+                      bool = inputElem.checkValidity && inputElem.checkValidity() === false;
+
+                    } else {
+                      // If the upgraded input compontent rejects the :) text, we got a winner
+                      bool = inputElem.value != smile;
+                    }
+                }
+
+                inputs[ props[i] ] = !!bool;
+            }
+            return inputs;
+        })('search tel url email datetime date month week time datetime-local number range color'.split(' '));
+        /*>>inputtypes*/
+    }
+    /*>>webforms*/
+
+
+    // End of test definitions
+    // -----------------------
+
+
+
+    // Run through all tests and detect their support in the current UA.
+    // todo: hypothetically we could be doing an array of tests and use a basic loop here.
+    for ( var feature in tests ) {
+        if ( hasOwnProp(tests, feature) ) {
+            // run the test, throw the return value into the Modernizr,
+            //   then based on that boolean, define an appropriate className
+            //   and push it into an array of classes we'll join later.
+            featureName  = feature.toLowerCase();
+            Modernizr[featureName] = tests[feature]();
+
+            classes.push((Modernizr[featureName] ? '' : 'no-') + featureName);
+        }
+    }
+
+    /*>>webforms*/
+    // input tests need to run.
+    Modernizr.input || webforms();
+    /*>>webforms*/
+
+
+    /**
+     * addTest allows the user to define their own feature tests
+     * the result will be added onto the Modernizr object,
+     * as well as an appropriate className set on the html element
+     *
+     * @param feature - String naming the feature
+     * @param test - Function returning true if feature is supported, false if not
+     */
+     Modernizr.addTest = function ( feature, test ) {
+       if ( typeof feature == 'object' ) {
+         for ( var key in feature ) {
+           if ( hasOwnProp( feature, key ) ) {
+             Modernizr.addTest( key, feature[ key ] );
+           }
+         }
+       } else {
+
+         feature = feature.toLowerCase();
+
+         if ( Modernizr[feature] !== undefined ) {
+           // we're going to quit if you're trying to overwrite an existing test
+           // if we were to allow it, we'd do this:
+           //   var re = new RegExp("\\b(no-)?" + feature + "\\b");
+           //   docElement.className = docElement.className.replace( re, '' );
+           // but, no rly, stuff 'em.
+           return Modernizr;
+         }
+
+         test = typeof test == 'function' ? test() : test;
+
+         if (typeof enableClasses !== "undefined" && enableClasses) {
+           docElement.className += ' ' + (test ? '' : 'no-') + feature;
+         }
+         Modernizr[feature] = test;
+
+       }
+
+       return Modernizr; // allow chaining.
+     };
+
+
+    // Reset modElem.cssText to nothing to reduce memory footprint.
+    setCss('');
+    modElem = inputElem = null;
+
+    /*>>shiv*/
+    /**
+     * @preserve HTML5 Shiv prev3.7.1 | @afarkas @jdalton @jon_neal @rem | MIT/GPL2 Licensed
+     */
+    ;(function(window, document) {
+        /*jshint evil:true */
+        /** version */
+        var version = '3.7.0';
+
+        /** Preset options */
+        var options = window.html5 || {};
+
+        /** Used to skip problem elements */
+        var reSkip = /^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i;
+
+        /** Not all elements can be cloned in IE **/
+        var saveClones = /^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i;
+
+        /** Detect whether the browser supports default html5 styles */
+        var supportsHtml5Styles;
+
+        /** Name of the expando, to work with multiple documents or to re-shiv one document */
+        var expando = '_html5shiv';
+
+        /** The id for the the documents expando */
+        var expanID = 0;
+
+        /** Cached data for each document */
+        var expandoData = {};
+
+        /** Detect whether the browser supports unknown elements */
+        var supportsUnknownElements;
+
+        (function() {
+          try {
+            var a = document.createElement('a');
+            a.innerHTML = '<xyz></xyz>';
+            //if the hidden property is implemented we can assume, that the browser supports basic HTML5 Styles
+            supportsHtml5Styles = ('hidden' in a);
+
+            supportsUnknownElements = a.childNodes.length == 1 || (function() {
+              // assign a false positive if unable to shiv
+              (document.createElement)('a');
+              var frag = document.createDocumentFragment();
+              return (
+                typeof frag.cloneNode == 'undefined' ||
+                typeof frag.createDocumentFragment == 'undefined' ||
+                typeof frag.createElement == 'undefined'
+              );
+            }());
+          } catch(e) {
+            // assign a false positive if detection fails => unable to shiv
+            supportsHtml5Styles = true;
+            supportsUnknownElements = true;
+          }
+
+        }());
+
+        /*--------------------------------------------------------------------------*/
+
+        /**
+         * Creates a style sheet with the given CSS text and adds it to the document.
+         * @private
+         * @param {Document} ownerDocument The document.
+         * @param {String} cssText The CSS text.
+         * @returns {StyleSheet} The style element.
+         */
+        function addStyleSheet(ownerDocument, cssText) {
+          var p = ownerDocument.createElement('p'),
+          parent = ownerDocument.getElementsByTagName('head')[0] || ownerDocument.documentElement;
+
+          p.innerHTML = 'x<style>' + cssText + '</style>';
+          return parent.insertBefore(p.lastChild, parent.firstChild);
+        }
+
+        /**
+         * Returns the value of `html5.elements` as an array.
+         * @private
+         * @returns {Array} An array of shived element node names.
+         */
+        function getElements() {
+          var elements = html5.elements;
+          return typeof elements == 'string' ? elements.split(' ') : elements;
+        }
+
+        /**
+         * Returns the data associated to the given document
+         * @private
+         * @param {Document} ownerDocument The document.
+         * @returns {Object} An object of data.
+         */
+        function getExpandoData(ownerDocument) {
+          var data = expandoData[ownerDocument[expando]];
+          if (!data) {
+            data = {};
+            expanID++;
+            ownerDocument[expando] = expanID;
+            expandoData[expanID] = data;
+          }
+          return data;
+        }
+
+        /**
+         * returns a shived element for the given nodeName and document
+         * @memberOf html5
+         * @param {String} nodeName name of the element
+         * @param {Document} ownerDocument The context document.
+         * @returns {Object} The shived element.
+         */
+        function createElement(nodeName, ownerDocument, data){
+          if (!ownerDocument) {
+            ownerDocument = document;
+          }
+          if(supportsUnknownElements){
+            return ownerDocument.createElement(nodeName);
+          }
+          if (!data) {
+            data = getExpandoData(ownerDocument);
+          }
+          var node;
+
+          if (data.cache[nodeName]) {
+            node = data.cache[nodeName].cloneNode();
+          } else if (saveClones.test(nodeName)) {
+            node = (data.cache[nodeName] = data.createElem(nodeName)).cloneNode();
+          } else {
+            node = data.createElem(nodeName);
+          }
+
+          // Avoid adding some elements to fragments in IE < 9 because
+          // * Attributes like `name` or `type` cannot be set/changed once an element
+          //   is inserted into a document/fragment
+          // * Link elements with `src` attributes that are inaccessible, as with
+          //   a 403 response, will cause the tab/window to crash
+          // * Script elements appended to fragments will execute when their `src`
+          //   or `text` property is set
+          return node.canHaveChildren && !reSkip.test(nodeName) && !node.tagUrn ? data.frag.appendChild(node) : node;
+        }
+
+        /**
+         * returns a shived DocumentFragment for the given document
+         * @memberOf html5
+         * @param {Document} ownerDocument The context document.
+         * @returns {Object} The shived DocumentFragment.
+         */
+        function createDocumentFragment(ownerDocument, data){
+          if (!ownerDocument) {
+            ownerDocument = document;
+          }
+          if(supportsUnknownElements){
+            return ownerDocument.createDocumentFragment();
+          }
+          data = data || getExpandoData(ownerDocument);
+          var clone = data.frag.cloneNode(),
+          i = 0,
+          elems = getElements(),
+          l = elems.length;
+          for(;i<l;i++){
+            clone.createElement(elems[i]);
+          }
+          return clone;
+        }
+
+        /**
+         * Shivs the `createElement` and `createDocumentFragment` methods of the document.
+         * @private
+         * @param {Document|DocumentFragment} ownerDocument The document.
+         * @param {Object} data of the document.
+         */
+        function shivMethods(ownerDocument, data) {
+          if (!data.cache) {
+            data.cache = {};
+            data.createElem = ownerDocument.createElement;
+            data.createFrag = ownerDocument.createDocumentFragment;
+            data.frag = data.createFrag();
+          }
+
+
+          ownerDocument.createElement = function(nodeName) {
+            //abort shiv
+            if (!html5.shivMethods) {
+              return data.createElem(nodeName);
+            }
+            return createElement(nodeName, ownerDocument, data);
+          };
+
+          ownerDocument.createDocumentFragment = Function('h,f', 'return function(){' +
+                                                          'var n=f.cloneNode(),c=n.createElement;' +
+                                                          'h.shivMethods&&(' +
+                                                          // unroll the `createElement` calls
+                                                          getElements().join().replace(/[\w\-]+/g, function(nodeName) {
+            data.createElem(nodeName);
+            data.frag.createElement(nodeName);
+            return 'c("' + nodeName + '")';
+          }) +
+            ');return n}'
+                                                         )(html5, data.frag);
+        }
+
+        /*--------------------------------------------------------------------------*/
+
+        /**
+         * Shivs the given document.
+         * @memberOf html5
+         * @param {Document} ownerDocument The document to shiv.
+         * @returns {Document} The shived document.
+         */
+        function shivDocument(ownerDocument) {
+          if (!ownerDocument) {
+            ownerDocument = document;
+          }
+          var data = getExpandoData(ownerDocument);
+
+          if (html5.shivCSS && !supportsHtml5Styles && !data.hasCSS) {
+            data.hasCSS = !!addStyleSheet(ownerDocument,
+                                          // corrects block display not defined in IE6/7/8/9
+                                          'article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}' +
+                                            // adds styling not present in IE6/7/8/9
+                                            'mark{background:#FF0;color:#000}' +
+                                            // hides non-rendered elements
+                                            'template{display:none}'
+                                         );
+          }
+          if (!supportsUnknownElements) {
+            shivMethods(ownerDocument, data);
+          }
+          return ownerDocument;
+        }
+
+        /*--------------------------------------------------------------------------*/
+
+        /**
+         * The `html5` object is exposed so that more elements can be shived and
+         * existing shiving can be detected on iframes.
+         * @type Object
+         * @example
+         *
+         * // options can be changed before the script is included
+         * html5 = { 'elements': 'mark section', 'shivCSS': false, 'shivMethods': false };
+         */
+        var html5 = {
+
+          /**
+           * An array or space separated string of node names of the elements to shiv.
+           * @memberOf html5
+           * @type Array|String
+           */
+          'elements': options.elements || 'abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video',
+
+          /**
+           * current version of html5shiv
+           */
+          'version': version,
+
+          /**
+           * A flag to indicate that the HTML5 style sheet should be inserted.
+           * @memberOf html5
+           * @type Boolean
+           */
+          'shivCSS': (options.shivCSS !== false),
+
+          /**
+           * Is equal to true if a browser supports creating unknown/HTML5 elements
+           * @memberOf html5
+           * @type boolean
+           */
+          'supportsUnknownElements': supportsUnknownElements,
+
+          /**
+           * A flag to indicate that the document's `createElement` and `createDocumentFragment`
+           * methods should be overwritten.
+           * @memberOf html5
+           * @type Boolean
+           */
+          'shivMethods': (options.shivMethods !== false),
+
+          /**
+           * A string to describe the type of `html5` object ("default" or "default print").
+           * @memberOf html5
+           * @type String
+           */
+          'type': 'default',
+
+          // shivs the document according to the specified `html5` object options
+          'shivDocument': shivDocument,
+
+          //creates a shived element
+          createElement: createElement,
+
+          //creates a shived documentFragment
+          createDocumentFragment: createDocumentFragment
+        };
+
+        /*--------------------------------------------------------------------------*/
+
+        // expose html5
+        window.html5 = html5;
+
+        // shiv the document
+        shivDocument(document);
+
+    }(this, document));
+    /*>>shiv*/
+
+    // Assign private properties to the return object with prefix
+    Modernizr._version      = version;
+
+    // expose these for the plugin API. Look in the source for how to join() them against your input
+    /*>>prefixes*/
+    Modernizr._prefixes     = prefixes;
+    /*>>prefixes*/
+    /*>>domprefixes*/
+    Modernizr._domPrefixes  = domPrefixes;
+    Modernizr._cssomPrefixes  = cssomPrefixes;
+    /*>>domprefixes*/
+
+    /*>>mq*/
+    // Modernizr.mq tests a given media query, live against the current state of the window
+    // A few important notes:
+    //   * If a browser does not support media queries at all (eg. oldIE) the mq() will always return false
+    //   * A max-width or orientation query will be evaluated against the current state, which may change later.
+    //   * You must specify values. Eg. If you are testing support for the min-width media query use:
+    //       Modernizr.mq('(min-width:0)')
+    // usage:
+    // Modernizr.mq('only screen and (max-width:768)')
+    Modernizr.mq            = testMediaQuery;
+    /*>>mq*/
+
+    /*>>hasevent*/
+    // Modernizr.hasEvent() detects support for a given event, with an optional element to test on
+    // Modernizr.hasEvent('gesturestart', elem)
+    Modernizr.hasEvent      = isEventSupported;
+    /*>>hasevent*/
+
+    /*>>testprop*/
+    // Modernizr.testProp() investigates whether a given style property is recognized
+    // Note that the property names must be provided in the camelCase variant.
+    // Modernizr.testProp('pointerEvents')
+    Modernizr.testProp      = function(prop){
+        return testProps([prop]);
+    };
+    /*>>testprop*/
+
+    /*>>testallprops*/
+    // Modernizr.testAllProps() investigates whether a given style property,
+    //   or any of its vendor-prefixed variants, is recognized
+    // Note that the property names must be provided in the camelCase variant.
+    // Modernizr.testAllProps('boxSizing')
+    Modernizr.testAllProps  = testPropsAll;
+    /*>>testallprops*/
+
+
+    /*>>teststyles*/
+    // Modernizr.testStyles() allows you to add custom styles to the document and test an element afterwards
+    // Modernizr.testStyles('#modernizr { position:absolute }', function(elem, rule){ ... })
+    Modernizr.testStyles    = injectElementWithStyles;
+    /*>>teststyles*/
+
+
+    /*>>prefixed*/
+    // Modernizr.prefixed() returns the prefixed or nonprefixed property name variant of your input
+    // Modernizr.prefixed('boxSizing') // 'MozBoxSizing'
+
+    // Properties must be passed as dom-style camelcase, rather than `box-sizing` hypentated style.
+    // Return values will also be the camelCase variant, if you need to translate that to hypenated style use:
+    //
+    //     str.replace(/([A-Z])/g, function(str,m1){ return '-' + m1.toLowerCase(); }).replace(/^ms-/,'-ms-');
+
+    // If you're trying to ascertain which transition end event to bind to, you might do something like...
+    //
+    //     var transEndEventNames = {
+    //       'WebkitTransition' : 'webkitTransitionEnd',
+    //       'MozTransition'    : 'transitionend',
+    //       'OTransition'      : 'oTransitionEnd',
+    //       'msTransition'     : 'MSTransitionEnd',
+    //       'transition'       : 'transitionend'
+    //     },
+    //     transEndEventName = transEndEventNames[ Modernizr.prefixed('transition') ];
+
+    Modernizr.prefixed      = function(prop, obj, elem){
+      if(!obj) {
+        return testPropsAll(prop, 'pfx');
+      } else {
+        // Testing DOM property e.g. Modernizr.prefixed('requestAnimationFrame', window) // 'mozRequestAnimationFrame'
+        return testPropsAll(prop, obj, elem);
+      }
+    };
+    /*>>prefixed*/
+
+
+    /*>>cssclasses*/
+    // Remove "no-js" class from <html> element, if it exists:
+    docElement.className = docElement.className.replace(/(^|\s)no-js(\s|$)/, '$1$2') +
+
+                            // Add the new classes to the <html> element.
+                            (enableClasses ? ' js ' + classes.join(' ') : '');
+    /*>>cssclasses*/
+
+    return Modernizr;
+
+})(this, this.document);
diff --git a/profiles/commons/libraries/modernizr/readme.md b/profiles/commons/libraries/modernizr/readme.md
new file mode 100644
index 0000000..e025d02
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/readme.md
@@ -0,0 +1,28 @@
+Modernizr [![Build Status](https://secure.travis-ci.org/Modernizr/Modernizr.png?branch=master)](http://travis-ci.org/Modernizr/Modernizr)
+=========
+
+### a JavaScript library allowing you to use CSS3 & HTML5 while maintaining control over unsupported browsers 
+
+Modernizr tests which native CSS3 and HTML5 features are available in
+the current UA and makes the results available to you in two ways:
+as properties on a global `Modernizr` object, and as classes on the
+`<html>` element. This information allows you to progressively enhance
+your pages with a granular level of control over the experience.
+
+Modernizr has an optional (*not included*) conditional resource loader
+called `Modernizr.load()`, based on Yepnope.js ([yepnopejs.com](http://yepnopejs.com/)).
+To get a build that includes `Modernizr.load()`, as well as choosing
+which tests to include, go to [www.modernizr.com/download/](http://www.modernizr.com/download/)
+
+[Full documentation on modernizr.com/docs/](http://www.modernizr.com/docs/)
+
+* * *
+
+Modernizr is dual-licensed under the [BSD and MIT licenses](http://www.modernizr.com/license/).
+
+[modernizr.com](http://www.modernizr.com/)
+
+
+#### Try it out: 
+
+Run the test suite: [http://modernizr.github.com/Modernizr/test/](http://modernizr.github.com/Modernizr/test/)
diff --git a/profiles/commons/libraries/modernizr/test/basic.html b/profiles/commons/libraries/modernizr/test/basic.html
new file mode 100644
index 0000000..21ea6dc
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/basic.html
@@ -0,0 +1,65 @@
+<!DOCTYPE html>
+<html class="+no-js no-js- no-js i-has-no-js">
+<head>
+  <meta charset="UTF-8">
+  <title>Modernizr Test Suite</title>
+  <link rel="stylesheet" href="qunit/qunit.css">
+  <style>
+     body { margin-bottom: 150px;}
+     #testbed { font-family: Helvetica; color: #444; padding-bottom: 100px;}
+     #testbed button { margin: 30px; font-size: 13px;}
+     .data-notes, .offScreen { display:none;}
+     table { width: 100%;}
+     tbody tr:nth-child(even) td, tbody tr:nth-child(even) th {  border: 1px solid #ccc; border-left: 0; border-right: 0;}
+     table td:nth-child(even), table th:nth-child(even) { background: #e6e6e6;}
+     table tbody tr:hover td, table tbody tr:hover th { background: #e1e100!important;}
+     td.wrong { background:red!important;}
+     #html5section { visibility: hidden; }
+     h1 label { display:none;}
+     .output { padding: 0 0 0 16px;}
+     .output ul { margin: 0;}
+     .output li { color: #854747; }
+     .output li.yes{color:#090;}
+     .output li b{color:#000;}
+     .output {font:14px/1.3 Inconsolata,Consolas,monospace;
+                    -webkit-column-count: 5;
+                       -moz-column-count: 5;
+                            column-count: 5;}
+      .output + .output { border-top: 5px solid #ccc; }
+      textarea { width: 100%; min-height: 75px;}
+      #caniusetrigger { font-size: 38px; font-family: monospace; display:block; }
+  </style>
+
+  <script src="https://raw.github.com/Modernizr/Modernizr/master/modernizr.js"></script>
+
+  <script>window.Modernizr || document.write('<script src="../modernizr.js"><\/script>')</script>
+
+  <script src="js/lib/polyfills.js"></script>
+  <script src="js/lib/detect-global.js"></script>
+  
+  <script src="qunit/qunit.js"></script>
+  <script src="js/lib/jquery-1.7b2.js"></script>
+  
+  <script src="js/setup.js"></script>
+  
+  <script src="js/unit.js"></script>
+</head>
+<body>
+  <h1 id="qunit-header">Modernizr Test Suite</h1>
+  <h2 id="qunit-banner"></h2>
+  <div id="qunit-testrunner-toolbar"></div>
+  <h2 id="qunit-userAgent"></h2>
+
+  <ol id="qunit-tests"></ol>
+
+  <div id="mod-output" class=output></div>
+  <div id="mod-feattest-output" class=output></div>
+
+
+  <br>
+ 
+  <section><aside>this is an aside within a section</aside></section>
+  
+  
+</body>
+</html> 
diff --git a/profiles/commons/libraries/modernizr/test/caniuse.html b/profiles/commons/libraries/modernizr/test/caniuse.html
new file mode 100644
index 0000000..81e1058
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse.html
@@ -0,0 +1,1451 @@
+<!DOCTYPE html>
+<!-- saved from url=(0025)http://tests.caniuse.com/ -->
+<html class=" no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>WCIU test page</title>
+<meta charset="utf-8">
+
+<!-- pull in latest modernizr -->
+<script src="../modernizr.js"></script>
+
+<script src="./caniuse_files/jquery.min.js"></script>
+<link rel="stylesheet" type="text/css" href="./caniuse_files/style.css">
+
+<script>
+
+function setResult(id, result) {
+	$('#' + id).addClass(result ? 'pass' : 'fail');
+}
+
+</script>
+
+</head><body><h2>The <a href="http://caniuse.com/">When can I use...</a> test suite... <small>(originally from <a href="http://tests.caniuse.com/">tests.caniuse.com</a>)</small></h2> 
+<div id="intro">
+	<p>This is a basic test suite of various web technologies for the <a href="./caniuse_files/caniuse.html">When Can I Use</a> website.</p>
+	<p>It is used to quickly test basic support for features in upcoming browsers, rather than any full support of the feature's specification.</p>
+	<p>Results on this page generally match the results as they appear on the When Can I Use site, but <strong>may not always</strong> due to a variety of circumstances (test may pass but support is actually buggy, not tested well enough, has alternative method, etc).</p>
+	
+	<p>Four different types of tests are used:</p>
+	<dl>
+		<dt>Auto</dt>
+		<dd>Automated JS-based tests. (m) means <a href="http://modernizr.com/">Modernizr</a> is used.</dd>
+	
+		<dt>Visual</dt>
+		<dd>Requires visual confirmation/comparison to confirm</dd>
+	
+		<dt>Visual-square</dt>
+		<dd>Test must create a 30x30px green (lime) square</dd>
+	
+		<dt>Interactive</dt>
+		<dd>Requires interaction to confirm support</dd>
+	</dl>
+	
+	<p>If you are interested in contributing tests you can contact me at: when (at) caniuse (dotcom).</p>
+	
+</div>
+
+
+<div id="options">
+<form action="http://tests.caniuse.com/?" method="get"><label for="browser_list">Select browser to compare results with: </label><select id="ua" name="ua" autocomplete="false"><option value="">(none)</option><option value="and2.1">Android Browser 2.1</option><option value="and2.2">Android Browser 2.2</option><option value="and2.3">Android Browser 2.3</option><option value="and3">Android Browser 3</option><option value="chr10">Chrome 10</option><option value="chr11">Chrome 11</option><option value="chr12">Chrome 12</option><option value="chr13" selected="">Chrome 13</option><option value="chr4">Chrome 4</option><option value="chr5">Chrome 5</option><option value="chr6">Chrome 6</option><option value="chr7">Chrome 7</option><option value="chr8">Chrome 8</option><option value="chr9">Chrome 9</option><option value="ff2">Firefox 2</option><option value="ff3">Firefox 3</option><option value="ff3.5">Firefox 3.5</option><option value="ff3.6">Firefox 3.6</option><option value="ff4">Firefox 4</option><option value="ff5">Firefox 5</option><option value="ff6">Firefox 6</option><option value="ie10">IE 10</option><option value="ie5.5">IE 5.5</option><option value="ie6">IE 6</option><option value="ie7">IE 7</option><option value="ie8">IE 8</option><option value="ie9">IE 9</option><option value="ios3.2">iOS Safari 3.2</option><option value="ios4.1">iOS Safari 4.0-4.1</option><option value="ios4.2">iOS Safari 4.2-4.3</option><option value="op10.1">Opera 10.0-10.1</option><option value="op10.5">Opera 10.5</option><option value="op10.6">Opera 10.6</option><option value="op11">Opera 11</option><option value="op11.1">Opera 11.1</option><option value="op11.5">Opera 11.5</option><option value="op12">Opera 12</option><option value="op9">Opera 9</option><option value="op9.6">Opera 9.5-9.6</option><option value="omini5">Opera Mini 5.0-6.0</option><option value="omob10">Opera Mobile 10</option><option value="omob11">Opera Mobile 11</option><option value="saf3.1">Safari 3.1</option><option value="saf3.2">Safari 3.2</option><option value="saf4">Safari 4</option><option value="saf5">Safari 5</option><option value="saf6">Safari 6</option></select><div><label for="prefix">Select CSS prefix to use (does not affect modernizr or non-CSS tests): </label><select id="prefix" name="prefix" autocomplete="false"><option value="all" selected="">All combinations</option><option value="-webkit-">-webkit-</option><option value="-moz-">-moz-</option><option value="-ms-">-ms-</option><option value="-o-">-o-</option><option value="none">(no prefix)</option></select><input id="opt_submit" type="submit" value="Go"></div></form></div><table><caption>Tests</caption><thead><tr><th>Feature</th><th>chr13</th><th>Tests</th></tr></thead><tbody><tr><th><h3>Toolbar/context menu</h3><span class="links">[<a href="http://caniuse.com/menu">Table</a>] [<a href="http://tests.caniuse.com/?feat=menu&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+
+</td></tr>
+<tr><th><h3>Audio element</h3><span class="links">[<a href="http://caniuse.com/audio">Table</a>] [<a href="http://tests.caniuse.com/?feat=audio&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="audio0" class="auto pass"></div><script>
+setResult('audio0', !!document.createElement('audio').canPlayType);
+</script><div class="info">document.createElement('audio').canPlayType</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="audio1" class="interact"></div><audio controls="">
+ <source src="mimeaud.php?type=.wav">
+ <source src="mimeaud.php?type=.mp3">
+ <source src="mimeaud.php?type=.ogg">
+ <source src="mimeaud.php?type=.aac">
+ <source src="mimeaud.php?type=.flac">
+ <source src="mimeaud.php?type=.wma">
+ Audio fail
+</audio>
+<div class="info">Audio element with 6 different sources (with MIME set)</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="audio2" class="interact"></div><audio controls="">
+ <source src="mimeaud.php?nomime=1&amp;type=.wav">
+ <source src="mimeaud.php?nomime=1&amp;type=.mp3">
+ <source src="mimeaud.php?nomime=1&amp;type=.ogg">
+ <source src="mimeaud.php?nomime=1&amp;type=.aac">
+ <source src="mimeaud.php?nomime=1&amp;type=.flac">
+ <source src="mimeaud.php?nomime=1&amp;type=.wma">
+--&gt;
+ Audio fail
+</audio>
+
+<div class="info">Audio element with 6 different sources (no MIME set)</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Background-image options</h3><span class="links">[<a href="http://caniuse.com/background-img-opts">Table</a>] [<a href="http://tests.caniuse.com/?feat=background-img-opts&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="background-img-opts0" class="auto pass"></div><script>setResult('background-img-opts0', Modernizr.backgroundsize);</script><div class="info">Modernizr test for: "backgroundsize"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="background-img-opts1" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background:lime">
+<div style="-webkit-background-clip:content-box;-moz-background-clip:content-box;-ms-background-clip:content-box;-o-background-clip:content-box;background-clip:content-box;padding:30px 30px 0 0;background-color:red"></div>
+</div>
+</div><div class="info">background-clip: content-box;</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="background-img-opts2" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background:lime">
+<div style="-webkit-background-origin:content-box;-moz-background-origin:content-box;-ms-background-origin:content-box;-o-background-origin:content-box;background-origin:content-box;padding:30px 30px 0 0;background-image:url(caniuse_files/red30x30.png);background-repeat: no-repeat;"></div>
+</div>
+</div><div class="info">background-origin: content-box;</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="background-img-opts2" class="visual-square"></div><div class="square"><div style="-webkit-background-size:30px 30px;-moz-background-size:30px 30px;-ms-background-size:30px 30px;-o-background-size:30px 30px;background-size:30px 30px;background-image:url(caniuse_files/green5x5.png);background-repeat: no-repeat;width:30px;height:30px;"></div>
+</div><div class="info">background-size: 30px 30px;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Border images</h3><span class="links">[<a href="http://caniuse.com/border-image">Table</a>] [<a href="http://tests.caniuse.com/?feat=border-image&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="border-image0" class="auto pass"></div><script>setResult('border-image0', Modernizr.borderimage);</script><div class="info">Modernizr test for: "borderimage"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="border-image1" class="visual-square"></div><div class="square"><div style="border-width: 15px;	-webkit-border-image-source: url(caniuse_files/green5x5.png);-moz-border-image-source: url(caniuse_files/green5x5.png);-ms-border-image-source: url(caniuse_files/green5x5.png);-o-border-image-source: url(caniuse_files/green5x5.png);border-image-source: url(caniuse_files/green5x5.png);-webkit-border-image-slice: 2;-moz-border-image-slice: 2;-ms-border-image-slice: 2;-o-border-image-slice: 2;border-image-slice: 2; width:0; height: 0;"></div></div><div class="info">Separate properties:
+border-image-source: url(caniuse_files/green5x5.png);
+border-image-slice: 2;</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="border-image3" class="visual-square"></div><div class="square"><div style="border-width: 15px;	-webkit-border-image: url(caniuse_files/green5x5.png) 2;-moz-border-image: url(caniuse_files/green5x5.png) 2;-ms-border-image: url(caniuse_files/green5x5.png) 2;-o-border-image: url(caniuse_files/green5x5.png) 2;border-image: url(caniuse_files/green5x5.png) 2; width:0; height: 0;"></div></div><div class="info">Shorthand syntax: border-image: url(caniuse_files/green5x5.png) 2;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Border-radius (rounded corners)</h3><span class="links">[<a href="http://caniuse.com/border-radius">Table</a>] [<a href="http://tests.caniuse.com/?feat=border-radius&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="border-radius0" class="auto pass"></div><script>setResult('border-radius0', Modernizr.borderradius);</script><div class="info">Modernizr test for: "borderradius"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="border-radius1" class="visual-square"></div><div class="square"><div style="width:30px; height:30px; overflow:hidden; position:relative;">
+  <div style="background:lime; height: 40px; "></div>
+  <div style="background:red; position:absolute; z-index:10; top: 0;
+              height: 400px; width: 400px;
+              -webkit-border-radius: 150px;
+-moz-border-radius: 150px;
+-ms-border-radius: 150px;
+-o-border-radius: 150px;
+border-radius: 150px;
+
+"></div>
+</div></div></div>
+
+</td></tr>
+<tr><th><h3>Canvas (basic support)</h3><span class="links">[<a href="http://caniuse.com/canvas">Table</a>] [<a href="http://tests.caniuse.com/?feat=canvas&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="canvas0" class="auto pass"></div><script>setResult('canvas0', Modernizr.canvas);</script><div class="info">Modernizr test for: "canvas"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="canvas1" class="visual-square"></div><div class="square"><canvas width="30" height="30" style="background:red;" id="canv_test"></canvas>
+
+<script>
+var canvas = $('#canv_test')[0], 
+    ctx    = canvas.getContext && canvas.getContext('2d');
+
+if (ctx){
+  ctx.fillStyle = '#00ff00';
+  ctx.fillRect(0,0,100,40);
+}
+</script></div><div class="info">Draw rect on canvas using fillStyle and fillRect</div></div>
+
+</td></tr>
+<tr><th><h3>classList (DOMTokenList )</h3><span class="links">[<a href="http://caniuse.com/classlist">Table</a>] [<a href="http://tests.caniuse.com/?feat=classlist&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="classlist0" class="auto pass"></div><script>
+setResult('classlist0', "classList" in document.body);
+</script><div class="info">"classList" in document.body</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="classlist1" class="visual-square"></div><div class="square"><div id="classlisttest" class="pass" style="width:30px;height:30px;"></div>
+<script>
+try{
+  document.getElementById('classlisttest').classList.remove('fail');
+  document.getElementById('classlisttest').classList.add('pass');
+}catch(e){}
+
+
+</script></div></div>
+
+</td></tr>
+<tr><th><h3>Cross-Origin Resource Sharing</h3><span class="links">[<a href="http://caniuse.com/cors">Table</a>] [<a href="http://tests.caniuse.com/?feat=cors&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="cors0" class="auto pass"></div><script>
+$(function() {
+	$.get('http://a.deveria.com/tests/cors/true.php', function(data) {
+		setResult('cors0', data);
+	});
+});
+
+</script><div class="info">Instant XHR request on page that should permit it.</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Animation</h3><span class="links">[<a href="http://caniuse.com/css-animation">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-animation&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-animation0" class="auto pass"></div><script>setResult('css-animation0', Modernizr.cssanimations);</script><div class="info">Modernizr test for: "cssanimations"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-animation1" class="visual-square"></div><div class="square"><style>
+ #css-animation1test {
+	-webkit-animation: staylime 60s infinite;
+-moz-animation: staylime 60s infinite;
+-ms-animation: staylime 60s infinite;
+-o-animation: staylime 60s infinite;
+animation: staylime 60s infinite;
+}
+
+@-webkit-keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }
+@-moz-keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }
+@-ms-keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }
+@-o-keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }
+@keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }
+
+
+</style>
+
+<div id="css-animation1test" style="width:30px;height:30px;"></div></div><div class="info">animation: staylime 60s infinite; 
+
+@keyframes staylime {
+	from { background-color: lime; }
+	to   { background-color: lime; }
+ }</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Box-shadow</h3><span class="links">[<a href="http://caniuse.com/css-boxshadow">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-boxshadow&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-boxshadow0" class="auto pass"></div><script>setResult('css-boxshadow0', Modernizr.boxshadow);</script><div class="info">Modernizr test for: "boxshadow"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-boxshadow1" class="visual-square"></div><div class="square"><div style="background:red; width: 30px; height: 30px;
+            -webkit-box-shadow: inset lime 0px 0px 150px;
+-moz-box-shadow: inset lime 0px 0px 150px;
+-ms-box-shadow: inset lime 0px 0px 150px;
+-o-box-shadow: inset lime 0px 0px 150px;
+box-shadow: inset lime 0px 0px 150px;
+ "></div>
+</div><div class="info">Must be greenish, may not be entirely lime depending on the implementation.</div></div>
+
+</td></tr>
+<tr><th><h3>CSS position:fixed</h3><span class="links">[<a href="http://caniuse.com/css-fixed">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-fixed&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+
+<div class="test_wrap"><h3>Interact</h3><div id="css-fixed1" class="interact"></div><a href="http://tests.caniuse.com/fixed.html">Test here</a></div>
+
+</td></tr>
+<tr><th><h3>CSS Gradients</h3><span class="links">[<a href="http://caniuse.com/css-gradients">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-gradients&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-gradients0" class="auto pass"></div><script>setResult('css-gradients0', Modernizr.cssgradients);</script><div class="info">Modernizr test for: "cssgradients"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-gradients1" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background-image: -webkit-linear-gradient(lime, lime);background-image: -moz-linear-gradient(lime, lime);background-image: -ms-linear-gradient(lime, lime);background-image: -o-linear-gradient(lime, lime);background-image: linear-gradient(lime, lime);"></div></div><div class="info">linear-gradient(lime, lime);</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-gradients2" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background-image:-webkit-radial-gradient(lime, lime);background-image:-moz-radial-gradient(lime, lime);background-image:-ms-radial-gradient(lime, lime);background-image:-o-radial-gradient(lime, lime);background-image:radial-gradient(lime, lime);"></div></div><div class="info">radial-gradient(lime, lime)</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Opacity</h3><span class="links">[<a href="http://caniuse.com/css-opacity">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-opacity&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-opacity0" class="auto pass"></div><script>setResult('css-opacity0', Modernizr.opacity);</script><div class="info">Modernizr test for: "opacity"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-opacity1" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;position:relative;background:lime">
+	<div style="width:30px;height:30px;background:red;-webkit-opacity:0;-moz-opacity:0;-ms-opacity:0;-o-opacity:0;opacity:0;"></div></div>
+</div>
+</div><div class="info">Test for opacity: 0</div>
+
+</td></tr>
+<tr><th><h3>CSS3 Text-shadow</h3><span class="links">[<a href="http://caniuse.com/css-textshadow">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-textshadow&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-textshadow0" class="auto pass"></div><script>setResult('css-textshadow0', Modernizr.textshadow);</script><div class="info">Modernizr test for: "textshadow"</div></div>
+
+<div class="test_wrap"><h3>Visual</h3><div id="css-textshadow1" class="visual"></div><div class="vis_test"><div style="width:30px;height:30px;overflow:hidden" id="css-textshadow1">
+ 
+<div style="font:25px/25px Times New Roman, Times; color:white;-webkit-text-shadow:25px 0 3px lime;-moz-text-shadow:25px 0 3px lime;-ms-text-shadow:25px 0 3px lime;-o-text-shadow:25px 0 3px lime;text-shadow:25px 0 3px lime;position:relative; left:-25px;">A</div>
+
+</div></div><div class="vis_ref"><img src="./caniuse_files/text-shadow1.png"></div><div class="info">font-size: 25px;
+color: white;
+text-shadow: 25px 0 3px lime; position: relative;
+left: -25px;</div></div>
+
+<div class="test_wrap"><h3>Visual</h3><div id="css-textshadow2" class="visual"></div><div class="vis_test"><div style="width:40px;height:30px;overflow:hidden" id="css-textshadow2">
+ <div style="font:25px/25px Times New Roman, Times; color:white; -webkit-text-shadow:25px 0 3px #0F0, 35px 0 3px #0C0, 45px 0 3px #090;-moz-text-shadow:25px 0 3px #0F0, 35px 0 3px #0C0, 45px 0 3px #090;-ms-text-shadow:25px 0 3px #0F0, 35px 0 3px #0C0, 45px 0 3px #090;-o-text-shadow:25px 0 3px #0F0, 35px 0 3px #0C0, 45px 0 3px #090;text-shadow:25px 0 3px #0F0, 35px 0 3px #0C0, 45px 0 3px #090; position:relative; left:-35px;">A</div>
+</div>
+</div><div class="vis_ref"><img src="./caniuse_files/text-shadow2.png"></div><div class="info">Multiple shadow test</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Transitions</h3><span class="links">[<a href="http://caniuse.com/css-transitions">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-transitions&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-transitions0" class="auto pass"></div><script>setResult('css-transitions0', Modernizr.csstransitions);</script><div class="info">Modernizr test for: "csstransitions"</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="css-transitions1" class="interact"></div><style>
+#css-transitions1wrap {
+	width: 30px;
+	height: 30px;
+	border: 1px solid;
+	overflow: hidden;
+	margin: 0 auto;
+}
+
+#css-transitions1test {
+	-webkit-transition-property: left;
+	-webkit-transition-duration: 3s;
+	-webkit-transition-timing-function: cubic-bezier(0, 1, 1, 0);
+-moz-transition-property: left;
+	-moz-transition-duration: 3s;
+	-moz-transition-timing-function: cubic-bezier(0, 1, 1, 0);
+-ms-transition-property: left;
+	-ms-transition-duration: 3s;
+	-ms-transition-timing-function: cubic-bezier(0, 1, 1, 0);
+-o-transition-property: left;
+	-o-transition-duration: 3s;
+	-o-transition-timing-function: cubic-bezier(0, 1, 1, 0);
+transition-property: left;
+	transition-duration: 3s;
+	transition-timing-function: cubic-bezier(0, 1, 1, 0);
+	background-color: lime;
+	position: relative;
+	left: -30px;
+	top: 0;
+}
+
+#css-transitions1wrap:hover #css-transitions1test {
+	left: 30px;
+}
+
+</style>
+<div id="css-transitions1wrap">
+	<div id="css-transitions1test" style="width:30px;height:30px;"></div>
+</div><p class="condition">Green square must (briefly) appear on hover</p><div class="info">5 second transition from left to right using cubic-bezier(0, 1, 1, 0); </div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Colors</h3><span class="links">[<a href="http://caniuse.com/css3-colors">Table</a>] [<a href="http://tests.caniuse.com/?feat=css3-colors&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css3-colors0" class="auto pass"></div><script>setResult('css3-colors0', Modernizr.hsla);</script><div class="info">Modernizr test for: "hsla"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css3-colors1" class="visual-square"></div><div class="square"><div style="background-color: red;      width: 30px; height: 30px; background-color: hsl(120, 100%, 50%);"></div></div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css3-colors2" class="visual-square"></div><div class="square"><div style="background-color: red;      width: 30px; height: 30px; background-color: rgba(0, 255, 0, 1);"></div></div></div>
+
+</td></tr>
+<tr><th><h3>dataset &amp; data-* attributes</h3><span class="links">[<a href="http://caniuse.com/dataset">Table</a>] [<a href="http://tests.caniuse.com/?feat=dataset&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="dataset0" class="auto pass" data-foo="bar"></div><script>
+var result = 'dataset' in document.body;
+if(result) {
+var elem = document.getElementById('dataset0'); elem.setAttribute('data-foo', 'bar');
+result = elem.dataset.foo == 'bar';
+}
+setResult('dataset0', result);
+</script><div class="info">Test for 'dataset' in document.body and getting the correct value returned from a data-foo attribute.</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="dataset1" class="interact"></div><a href="http://trac.webkit.org/export/66582/trunk/LayoutTests/fast/dom/dataset.html">Test here</a></div>
+
+</td></tr>
+<tr><th><h3>Details &amp; Summary elements</h3><span class="links">[<a href="http://caniuse.com/details">Table</a>] [<a href="http://tests.caniuse.com/?feat=details&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="details0" class="auto pass"></div><script>
+setResult('details0', 'open' in document.createElement('details'));
+</script></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="details1" class="interact"></div><details>
+    <summary>(summary button)</summary>
+    <p>(detail contents)</p>
+</details><p class="condition">"(detail contents)" should be visible ONLY after clicking summary</p><div class="info">Basic details element with summary and paragraph as children.</div></div>
+
+</td></tr>
+<tr><th><h3>Server-sent DOM events</h3><span class="links">[<a href="http://caniuse.com/eventsource">Table</a>] [<a href="http://tests.caniuse.com/?feat=eventsource&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="eventsource0" class="auto pass"></div><script>
+setResult('eventsource0', typeof EventSource !== 'undefined');
+</script></div>
+
+</td></tr>
+<tr><th><h3>File API</h3><span class="links">[<a href="http://caniuse.com/fileapi">Table</a>] [<a href="http://tests.caniuse.com/?feat=fileapi&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="fileapi0" class="auto pass"></div><script>
+setResult('fileapi0', !!window.FileReader);
+</script></div>
+
+</td></tr>
+<tr><th><h3>Flexible Box Layout Module</h3><span class="links">[<a href="http://caniuse.com/flexbox">Table</a>] [<a href="http://tests.caniuse.com/?feat=flexbox&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="flexbox0" class="auto pass"></div><script>setResult('flexbox0', Modernizr.flexbox);</script><div class="info">Modernizr test for: "flexbox"</div></div>
+
+</td></tr>
+<tr><th><h3>@font-face Web fonts</h3><span class="links">[<a href="http://caniuse.com/fontface">Table</a>] [<a href="http://tests.caniuse.com/?feat=fontface&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="fontface0" class="auto pass"></div><script>setResult('fontface0', Modernizr.fontface);</script><div class="info">Modernizr test for: "fontface"</div></div>
+
+</td></tr>
+<tr><th><h3>Geolocation</h3><span class="links">[<a href="http://caniuse.com/geolocation">Table</a>] [<a href="http://tests.caniuse.com/?feat=geolocation&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="geolocation0" class="auto pass"></div><script>setResult('geolocation0', Modernizr.geolocation);</script><div class="info">Modernizr test for: "geolocation"</div></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="geolocation1" class="auto pass"></div><script>
+(function() {
+	var result = false;
+	var geo = navigator.geolocation;
+	if(geo) {
+		result = (
+			"getCurrentPosition" in geo
+			&& "watchPosition" in geo
+			&& "clearWatch" in geo
+		);
+	}
+	setResult('geolocation1', result);
+}());
+</script><div class="info">Test for getCurrentPosition, watchPosition and clearWatch in navigator.geolocation</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="geolocation2" class="interact"></div><button id="geolocation2test">Get location</button>
+<script>
+(function() {
+	var btn = document.getElementById('geolocation2test');
+	if(!navigator.geolocation && !navigator.geolocation.getCurrentPosition) return false;
+	btn.onclick = function() {
+		var feat = document.getElementById('geolocation2');
+		navigator.geolocation.getCurrentPosition(function(pos) {
+			feat.innerHTML = '<p>Result:<br>LAT: ' + pos.coords.latitude + '<br>LON: ' + pos.coords.longitude + '</p>';
+		}, function(error) {
+			feat.innerHTML = '<p>Error:' + error.message + '</p>';
+		});
+		
+		feat.innerHTML = '<p>Waiting for response...</p>';
+		
+		return false;
+	}
+})();
+
+</script><p class="condition">Must provide LAT and LON info (may need to give permission first)</p><div class="info">Test for navigator.geolocation.getCurrentPosition on which position.coords.latitude and position.coords.longitude are expected. </div></div>
+
+</td></tr>
+<tr><th><h3>getElementsByClassName</h3><span class="links">[<a href="http://caniuse.com/getelementsbyclassname">Table</a>] [<a href="http://tests.caniuse.com/?feat=getelementsbyclassname&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="getelementsbyclassname0" class="auto pass"></div><script>
+setResult('getelementsbyclassname0', typeof document.getElementsByClassName === 'function')
+</script></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="getelementsbyclassname1" class="visual-square"></div><div class="square"><div style="width: 30px; height: 30px; background-image: initial; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: lime; background-position: initial initial; background-repeat: initial initial; " id="getelementsbyclassname1container">
+	<div id="getelementsbyclassname1test">
+		<div class="getelementsbyclassname1test"></div>
+		<div class="getelementsbyclassname1test altgetelementsbyclassname1test"></div>
+		<div class="altgetelementsbyclassname1test"></div>
+	</div>
+<script>
+(function() {
+	if(document.getElementsByClassName) {
+		var elems = document.getElementsByClassName('getelementsbyclassname1test');
+		var from_id = document.getElementById('getelementsbyclassname1test').getElementsByTagName('*');
+		if(elems.length && elems.length === 2) {
+			if(elems[0] === from_id[0] && elems[1] === from_id[1]) {
+				document.getElementById('getelementsbyclassname1container').style.background = 'lime';
+			}
+		}
+	}
+}());
+</script></div><div class="info">Test if two divs were correctly retrieved using getElementsByClassName</div></div>
+
+</div></td></tr>
+<tr><th><h3>Hashchange event</h3><span class="links">[<a href="http://caniuse.com/hashchange">Table</a>] [<a href="http://tests.caniuse.com/?feat=hashchange&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="hashchange0" class="auto pass"></div><script>setResult('hashchange0', Modernizr.hashchange);</script><div class="info">Modernizr test for: "hashchange"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="hashchange1" class="visual-square"></div><div class="square"><iframe style="width:30px;height:30px;border:0" src="./caniuse_files/hashchange.html"></iframe></div><div class="info">iframe with addEventListener('hashchange', function() {
+	document.body.style.background = 'lime';
+}, false);
+</div></div>
+
+</td></tr>
+<tr><th><h3>Session history management</h3><span class="links">[<a href="http://caniuse.com/history">Table</a>] [<a href="http://tests.caniuse.com/?feat=history&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="history0" class="auto pass"></div><script>setResult('history0', Modernizr.history);</script><div class="info">Modernizr test for: "history"</div></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="history1" class="auto"></div><iframe src="./caniuse_files/pushstate.html#history1"  style="display:none"></iframe><div class="info">Test if history.pushState was successful</div></div>
+
+</td></tr>
+<tr><th><h3>IndexedDB</h3><span class="links">[<a href="http://caniuse.com/indexeddb">Table</a>] [<a href="http://tests.caniuse.com/?feat=indexeddb&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="indexeddb0" class="auto pass"></div><script>setResult('indexeddb0', Modernizr.indexeddb);</script><div class="info">Modernizr test for: "indexeddb"</div></div>
+
+</td></tr>
+<tr><th><h3>JSON parsing</h3><span class="links">[<a href="http://caniuse.com/json">Table</a>] [<a href="http://tests.caniuse.com/?feat=json&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="json0" class="auto pass"></div><script>
+setResult('json0', 'JSON' in window)
+</script></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="json1" class="auto pass"></div><script>
+(function() {
+try {
+var obj = {
+	key1: 'my_str',
+	key2: ['my', 'array'],
+	key3: {
+		my: 'object',
+		with_numbers: [1, 2, 3, 4.5678],
+		and_also: 9
+	}
+};
+
+var str = JSON.stringify(obj);
+if(typeof str === 'string') {
+	var new_obj = JSON.parse(str);
+	if(
+		new_obj.key1 === 'my_str'
+		&& new_obj.key2.length === 2
+		&& new_obj.key2[1] === 'array'
+		&& new_obj.key3.with_numbers[3] === 4.5678
+		&& new_obj.key3.and_also === 9
+	) {
+		setResult('json1', true);
+	} else {
+		setResult('json1', false);
+	}
+} else {
+	setResult('json1', false);
+}
+} catch(e){
+setResult('json1', false);
+}
+}());
+</script><div class="info">Create a JS object, convert to JSON string, convert back to object and compare.</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Multiple backgrounds</h3><span class="links">[<a href="http://caniuse.com/multibackgrounds">Table</a>] [<a href="http://tests.caniuse.com/?feat=multibackgrounds&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="multibackgrounds0" class="auto pass"></div><script>setResult('multibackgrounds0', Modernizr.multiplebgs);</script><div class="info">Modernizr test for: "multiplebgs"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="multibackgrounds1" class="visual-square"></div><div class="square"><div style="background-repeat: repeat-x; background-image: url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png); background-position: 0 0, 0 5px, 0 10px, 0 15px, 0 20px, 0 25px; width:30px;height:30px;"></div></div><div class="info">background-repeat: repeat-x;
+background-image: url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png), url(caniuse_files/green5x5.png);
+background-position: 0 0, 0 5px, 0 10px, 0 15px, 0 20px, 0 25px;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Multiple column layout</h3><span class="links">[<a href="http://caniuse.com/multicolumn">Table</a>] [<a href="http://tests.caniuse.com/?feat=multicolumn&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="multicolumn0" class="auto pass"></div><script>setResult('multicolumn0', Modernizr.csscolumns);</script><div class="info">Modernizr test for: "csscolumns"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="multicolumn1" class="visual-square"></div><div class="square"><div style="-webkit-column-width: 15px; -webkit-column-gap: 0;-moz-column-width: 15px; -moz-column-gap: 0;-ms-column-width: 15px; -ms-column-gap: 0;-o-column-width: 15px; -o-column-gap: 0;column-width: 15px; column-gap: 0; width:30px;height:30px;background:red;">
+	<div style="inline-block;width:15px;height:30px;background:lime;"></div>
+	<div style="inline-block;width:15px;height:30px;background:lime;"></div>
+</div>
+</div><div class="info">column-width: 15px;
+column-gap: 0;</div></div>
+
+</td></tr>
+<tr><th><h3>Web Storage - name/value pairs</h3><span class="links">[<a href="http://caniuse.com/namevalue-storage">Table</a>] [<a href="http://tests.caniuse.com/?feat=namevalue-storage&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="namevalue-storage0" class="auto pass"></div><script>setResult('namevalue-storage0', Modernizr.localstorage);</script><div class="info">Modernizr test for: "localstorage"</div></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="namevalue-storage1" class="auto pass"></div><script>
+(function() {
+	var result = false;
+	if(window.localStorage) {
+		try {
+			localStorage.setItem('foo', 'bar');
+			if(localStorage.getItem('foo') === 'bar'
+				&& localStorage['foo'] === 'bar'
+				&& localStorage.foo === 'bar'
+			) {
+				localStorage.removeItem('foo');
+				if(localStorage.getItem('foo') === null) {
+					result = true;
+				}
+			}
+		} catch(e) {}
+	}
+	setResult('namevalue-storage1', result);
+})();
+
+</script><div class="info">Test if getItem, setItem and removeItem work.</div></div>
+
+</td></tr>
+<tr><th><h3>Web Notifications</h3><span class="links">[<a href="http://caniuse.com/notifications">Table</a>] [<a href="http://tests.caniuse.com/?feat=notifications&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="notifications0" class="auto pass"></div><script>
+setResult('notifications0',
+"webkitNotifications" in window
+|| "mozNotifications" in window
+|| "oNotifications" in window
+|| "msNotifications" in window
+|| "khtmlNotifications" in window
+|| "notifications" in window
+);
+</script></div>
+
+</td></tr>
+<tr><th><h3>Offline web applications</h3><span class="links">[<a href="http://caniuse.com/offline-apps">Table</a>] [<a href="http://tests.caniuse.com/?feat=offline-apps&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="offline-apps0" class="auto pass"></div><script>setResult('offline-apps0', Modernizr.applicationcache);</script><div class="info">Modernizr test for: "applicationcache"</div></div>
+
+</td></tr>
+<tr><th><h3>querySelector/querySelectorAll</h3><span class="links">[<a href="http://caniuse.com/queryselector">Table</a>] [<a href="http://tests.caniuse.com/?feat=queryselector&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="queryselector0" class="auto pass"></div><script>
+setResult('queryselector0', !!document.querySelectorAll && !!document.querySelector)
+</script></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="queryselector1" class="auto pass"></div>	<div id="queryselector1test">
+		<div data-foo="queryselector1"></div>
+		<div id="queryselector1target"></div>
+		<div class="altqueryselector1test"></div>
+	</div>
+<script>
+(function() {
+	if(document.querySelector) {
+		var elem = document.querySelector('[data-foo=queryselector1] + *');
+		var target = document.getElementById('queryselector1target');
+		setResult('queryselector1', elem === target);
+	}
+}());
+</script><div class="info">querySelector test on selector '[data-foo=bar] + *'</div></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="queryselector2" class="auto pass"></div>	<div id="queryselector2test">
+		<div data-foo="queryselector2"></div>
+		<div id="queryselector2target"></div>
+		<div class="altqueryselector2test"></div>
+	</div>
+<script>
+(function() {
+	if(document.querySelector) {
+		var elem = document.querySelector('[data-foo=queryselector2] + *');
+		var target = document.getElementById('queryselector2target');
+		setResult('queryselector2', elem === target);
+	}
+}());
+</script><div class="info">querySelectorAll test on selector '[data-foo=bar] + *'</div></div>
+
+</td></tr>
+<tr><th><h3>SVG (basic support)</h3><span class="links">[<a href="http://caniuse.com/svg">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="svg0" class="auto pass"></div><script>setResult('svg0', Modernizr.svg);</script><div class="info">Modernizr test for: "svg"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg1" class="visual-square"></div><div class="square"><object type="image/svg+xml" width="30" height="30" data="./caniuse_files/svg-img.svg" style="overflow:visible"> SVG fail
+</object></div><div class="info">SVG in &lt;object&gt;</div></div>
+
+</td></tr>
+<tr><th><h3>SVG effects for HTML</h3><span class="links">[<a href="http://caniuse.com/svg-html">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-html&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;</td><td>
+
+<div class="test_wrap"><h3>Visual</h3><div id="svg-html1" class="visual"></div><div class="vis_test"> <object type="image/svg+xml" width="60" height="30" data="http://tests.caniuse.com/blur-html.svg"> SVG fail
+ </object></div><div class="vis_ref"><img src="./caniuse_files/svg-html-blur.png"></div><p class="condition">Text must appear blurry</p><div class="info">SVG with feGaussianBlur filter on foreignObject</div></div>
+
+</td></tr>
+<tr><th><h3>Inline SVG in HTML5</h3><span class="links">[<a href="http://caniuse.com/svg-html5">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-html5&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="svg-html50" class="auto pass"></div><script>setResult('svg-html50', Modernizr.inlinesvg);</script><div class="info">Modernizr test for: "inlinesvg"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-html51" class="visual-square"></div><div class="square"><svg width="30" height="30" xmlns="http://www.w3.org/2000/svg" style="background:red;"> 
+    <rect height="30" width="30" y="0" x="0" fill="#00ff00"></rect> 
+</svg>
+</div></div>
+
+</td></tr>
+<tr><th><h3>SVG SMIL animation</h3><span class="links">[<a href="http://caniuse.com/svg-smil">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-smil&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="svg-smil0" class="auto pass"></div><script>setResult('svg-smil0', Modernizr.smil);</script><div class="info">Modernizr test for: "smil"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-smil1" class="visual-square"></div><div class="square"><object type="image/svg+xml" width="30" height="30" data="http://tests.caniuse.com/svg-animate.svg" style="overflow:visible"> SVG fail
+</object></div><div class="info">SVG with animate element inside a rect</div></div>
+
+</td></tr>
+<tr><th><h3>Touch events</h3><span class="links">[<a href="http://caniuse.com/touch">Table</a>] [<a href="http://tests.caniuse.com/?feat=touch&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="touch0" class="auto fail"></div><script>setResult('touch0', Modernizr.touch);</script><div class="info">Modernizr test for: "touch"</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Transforms</h3><span class="links">[<a href="http://caniuse.com/transforms2d">Table</a>] [<a href="http://tests.caniuse.com/?feat=transforms2d&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="transforms2d0" class="auto pass"></div><script>setResult('transforms2d0', Modernizr.csstransforms);</script><div class="info">Modernizr test for: "csstransforms"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="transforms2d1" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background:red;overflow:hidden">
+	<div style="background:lime;width:30px;height:30px;position:relative;left:-30px;-webkit-transform: translate(30px);-moz-transform: translate(30px);-ms-transform: translate(30px);-o-transform: translate(30px);transform: translate(30px); "></div>
+</div>
+</div><div class="info">transform: translate(30px);</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 3D Transforms</h3><span class="links">[<a href="http://caniuse.com/transforms3d">Table</a>] [<a href="http://tests.caniuse.com/?feat=transforms3d&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="transforms3d0" class="auto pass"></div><script>setResult('transforms3d0', Modernizr.csstransforms3d);</script><div class="info">Modernizr test for: "csstransforms3d"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="transforms3d1" class="visual-square"></div><div class="square"><style>
+#transforms3d1container {
+	background: red;
+	width: 30px;
+	height: 30px;
+	overflow: hidden;
+	-webkit-perspective: 600;
+	-webkit-perspective-origin: 0 200px;
+	-moz-perspective: 600;
+	-moz-perspective-origin: 0 200px;
+	-ms-perspective: 600;
+	-ms-perspective-origin: 0 200px;
+	-o-perspective: 600;
+	-o-perspective-origin: 0 200px;
+	perspective: 600;
+	perspective-origin: 0 200px;
+
+}
+
+#transforms3d1test { 
+	width:400px; height:100px;
+	background: lime;
+	position: relative;
+	top: 30px;
+	-webkit-transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);
+	-moz-transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);
+	-ms-transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);
+	-o-transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);
+	transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);
+
+}
+</style>
+<div id="transforms3d1container">
+	<div id="transforms3d1test"></div>
+</div></div><div class="info">Parent:
+perspective: 600;
+perspective-origin: 0 200px;
+
+Child:
+
+transform: translate3d(-234px, 0, 0) rotate3d(0, 1, 0, -70deg);</div></div>
+
+</td></tr>
+<tr><th><h3>Video element</h3><span class="links">[<a href="http://caniuse.com/video">Table</a>] [<a href="http://tests.caniuse.com/?feat=video&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="video0" class="auto pass"></div><script>
+setResult('video0', !!document.createElement('video').canPlayType);
+</script></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="video1" class="interact"></div><video width="160" height="120" controls="">
+	<source src="video.mp4" type="video/mp4">
+	<source src="video.ogv" type="video/ogv">
+	<source src="video.webm" type="video/webm">
+</video><div class="info">Video with controls and all three formats available.</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="video2" class="interact"></div><video width="160" height="120" controls="">
+	<source src="mimevid.php?type=.mp4" type="video/mp4">
+	<source src="mimevid.php?type=.ogv" type="video/ogg">
+	<source src="mimevid.php?type=.webm" type="video/webm">
+</video><div class="info">Video with controls and all three formats available (with MIME).</div></div>
+
+</td></tr>
+<tr><th><h3>Web Sockets</h3><span class="links">[<a href="http://caniuse.com/websockets">Table</a>] [<a href="http://tests.caniuse.com/?feat=websockets&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="websockets0" class="auto pass"></div><script>setResult('websockets0', Modernizr.websockets);</script><div class="info">Modernizr test for: "websockets"</div></div>
+
+</td></tr>
+<tr><th><h3>Web Workers</h3><span class="links">[<a href="http://caniuse.com/webworkers">Table</a>] [<a href="http://tests.caniuse.com/?feat=webworkers&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="webworkers0" class="auto pass"></div><script>setResult('webworkers0', Modernizr.webworkers);</script><div class="info">Modernizr test for: "webworkers"</div></div>
+
+<div class="test_wrap"><h3>Auto</h3><div id="webworkers1" class="auto pass"></div><script>
+(function() {
+
+try {
+
+	var w = new Worker('worker.js');
+	
+	w.onmessage = function (event) {
+	  var success = (event.data && event.data === 'worker works');
+	  setResult('webworkers1', success);
+	}
+	
+	w.postMessage('');
+
+} catch(e) {
+	setResult('webworkers1', false);
+}
+
+}());
+</script><div class="info">Create a new Worker using new Worker('worker.js');
+
+Then, test postMessage and onmessage event.</div></div>
+
+</td></tr>
+<tr><th><h3>Cross-document messaging</h3><span class="links">[<a href="http://caniuse.com/x-doc-messaging">Table</a>] [<a href="http://tests.caniuse.com/?feat=x-doc-messaging&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="x-doc-messaging0" class="auto pass"></div><script>setResult('x-doc-messaging0', Modernizr.postmessage);</script><div class="info">Modernizr test for: "postmessage"</div></div>
+
+</td></tr>
+<tr><th><h3>XMLHttpRequest 2</h3><span class="links">[<a href="http://caniuse.com/xhr2">Table</a>] [<a href="http://tests.caniuse.com/?feat=xhr2&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="xhr20" class="auto pass"></div><script>
+var progEv = !!(window.ProgressEvent);
+var fdata = !!(window.FormData);
+setResult('xhr20', (progEv && fdata));
+</script></div>
+
+</td></tr>
+<tr><th><h3>XHTML served as application/xhtml+xml</h3><span class="links">[<a href="http://caniuse.com/xhtml">Table</a>] [<a href="http://tests.caniuse.com/?feat=xhtml&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="xhtml0" class="auto pass"></div><iframe src="./caniuse_files/xhtml.html" width="15" height="15" style="display:none"></iframe></div>
+
+</td></tr>
+<tr><th><h3>CSS Generated content</h3><span class="links">[<a href="http://caniuse.com/css-gencontent">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-gencontent&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="css-gencontent0" class="visual"></div><div class="vis_test"><style>
+#gencontent:before {
+ content: 'A';
+}
+#gencontent:after {
+ content: 'Z';
+}
+</style>
+<span id="gencontent">-</span></div><div class="vis_ref"><img src="./caniuse_files/before-after.png"></div><div class="info">Element with CSS: 
+#gencontent:before {
+ content: 'A';
+}
+#gencontent:after {
+ content: 'Z';
+}</div></div>
+
+</td></tr>
+<tr><th><h3>CSS Table display</h3><span class="links">[<a href="http://caniuse.com/css-table">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-table&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="css-table0" class="visual"></div><div class="vis_test"><style>
+#table-test { display: table; }
+#table-test .table-tr { display: table-row; }
+#table-test .table-td { display: table-cell;border:1px solid; }
+</style>
+<div style="display:inline-block;vertical-align:middle">
+<div id="table-test">
+	<div class="table-tr">
+		<div class="table-td">topleft</div>
+		<div class="table-td">topright</div>
+	</div>
+	<div class="table-tr">
+		<div class="table-td">bottomleft</div>
+		<div class="table-td">bottomright</div>
+	</div>
+</div>
+</div></div><div class="vis_ref"><img src="./caniuse_files/table.png"></div><p class="condition">Should be 2x2 table</p></div>
+
+</td></tr>
+<tr><th><h3>HTML5 form features</h3><span class="links">[<a href="http://caniuse.com/forms">Table</a>] [<a href="http://tests.caniuse.com/?feat=forms&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="forms0" class="visual"></div><div class="vis_test"><input type="date"><br><input type="time"><br><input type="range"><br><input type="number"></div><p class="condition">date/time/range/number widgets</p></div>
+
+</td></tr>
+<tr><th><h3>MathML</h3><span class="links">[<a href="http://caniuse.com/mathml">Table</a>] [<a href="http://tests.caniuse.com/?feat=mathml&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="mathml0" class="visual"></div><div class="vis_test"><iframe src="./caniuse_files/mathml.html" width="210" height="110" style="border:0;"></iframe></div><div class="vis_ref"><img src="./caniuse_files/mathml_ref.png"></div></div>
+
+</td></tr>
+<tr><th><h3>PNG alpha transparency</h3><span class="links">[<a href="http://caniuse.com/png-alpha">Table</a>] [<a href="http://tests.caniuse.com/?feat=png-alpha&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="png-alpha0" class="visual"></div><div class="vis_test"><img src="./caniuse_files/alpha.png" style="background-color:lime"></div><div class="vis_ref"><img src="./caniuse_files/png_alpha_result.png"></div></div>
+
+</td></tr>
+<tr><th><h3>Ruby annotation</h3><span class="links">[<a href="http://caniuse.com/ruby">Table</a>] [<a href="http://tests.caniuse.com/?feat=ruby&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="ruby0" class="visual"></div><div class="vis_test">
+<div style="display:inline-block;vertical-align:middle">
+<ruby>(bottom1)<rt>(top1)</rt>(bottom2)<rt>(top2)</rt></ruby>
+</div></div><div class="vis_ref"><img src="./caniuse_files/ruby.png"></div><p class="condition">Elements should be stacked on top of each other</p></div>
+
+</td></tr>
+<tr><th><h3>SVG filters</h3><span class="links">[<a href="http://caniuse.com/svg-filters">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-filters&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="svg-filters0" class="visual"></div><div class="vis_test"><object data="http://tests.caniuse.com/blur.svg" type="image/svg+xml" height="70" width="70">
+	object SVG not supported
+</object>
+</div><div class="vis_ref"><img src="./caniuse_files/svg_blur.png"></div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-filters1" class="visual-square"></div><div class="square"><object type="image/svg+xml" width="30" height="30" data="http://tests.caniuse.com/fecolormatrix.svg" style="overflow:visible"> SVG fail
+</object></div><p class="condition">Must be green (not lime)</p><div class="info">SVG with &lt;feColorMatrix type="hueRotate" values="120"/&gt;</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-filters2" class="visual-square"></div><div class="square"><object type="image/svg+xml" width="30" height="30" data="http://tests.caniuse.com/feflood.svg" style="overflow:visible"> SVG fail
+</object></div><div class="info">SVG with &lt;feFlood flood-color="lime"/&gt;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Word-wrap</h3><span class="links">[<a href="http://caniuse.com/wordwrap">Table</a>] [<a href="http://tests.caniuse.com/?feat=wordwrap&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="wordwrap0" class="visual"></div><div class="vis_test"><style>
+#wordwraptest {
+  display: inline-block;
+  width: 30px;
+  word-wrap: break-word;
+}
+
+</style>
+<div id="wordwraptest">abcdefghijklmnopqrstuvwxyz</div>
+
+
+</div><p class="condition">Text should wrap</p></div>
+
+<div class="test_wrap"><h3>Visual</h3><div id="wordwrap1" class="visual"></div><div class="vis_test"><style>
+#wordwraptest2 {
+  display: inline-block;
+  width: 30px;
+  word-wrap: normal;
+}
+</style>
+
+<div id="wordwraptest2">abcdefghijklmnopqrstuvwxyz</div>
+</div><p class="condition">Text should overflow box</p></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="wordwrap2" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background:red;overflow:hidden">
+	<div style="color:lime;font-size:10px;line-height:10px;word-wrap:break-word;background:lime;">abcdefghijklmnop</div>
+</div>
+</div><div class="info">word-wrap: break-word;</div></div>
+
+</td></tr>
+<tr><th><h3>calc() as CSS unit value</h3><span class="links">[<a href="http://caniuse.com/calc">Table</a>] [<a href="http://tests.caniuse.com/?feat=calc&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="calc0" class="visual-square"></div><div class="square"><style>
+#calc0test {
+	width: 0px;
+	width: -webkit-calc(10px + 20px);
+	width: -moz-calc(10px + 20px);
+	width: -ms-calc(10px + 20px);
+	width: -o-calc(10px + 20px);
+	width: calc(10px + 20px);
+	height: 30px;
+	background: lime;
+}
+</style>
+<div id="calc0test"></div>
+</div><div class="info">width: calc(10px + 20px);</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="calc2" class="visual-square"></div><div class="square"><style>
+#calc2test {
+height:-webkit-calc(60px - 100%); width:-webkit-calc((100% / 2) + 15px - 0.5em); border-right:-webkit-calc(0.5em) solid lime;
+height:-moz-calc(60px - 100%); width:-moz-calc((100% / 2) + 15px - 0.5em); border-right:-moz-calc(0.5em) solid lime;
+height:-ms-calc(60px - 100%); width:-ms-calc((100% / 2) + 15px - 0.5em); border-right:-ms-calc(0.5em) solid lime;
+height:-o-calc(60px - 100%); width:-o-calc((100% / 2) + 15px - 0.5em); border-right:-o-calc(0.5em) solid lime;
+height:calc(60px - 100%); width:calc((100% / 2) + 15px - 0.5em); border-right:calc(0.5em) solid lime;
+
+background: lime;
+}
+</style>
+<div id="calc2test"></div>
+</div><div class="info">height: calc(60px - 100%);
+width: calc((100% / 2) + 15px - 0.5em);
+border-right: calc(0.5em) solid lime;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS Grid Layout</h3><span class="links">[<a href="http://caniuse.com/css-grid">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-grid&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-grid0" class="visual-square"></div><div class="square"><style>
+#css-grid0grid {
+	display: -webkit-grid; 	display: -moz-grid; 	display: -ms-grid; 	display: -o-grid; 	display: grid; 
+	-webkit-grid-columns: 15px 1fr; 	-moz-grid-columns: 15px 1fr; 	-ms-grid-columns: 15px 1fr; 	-o-grid-columns: 15px 1fr; 	grid-columns: 15px 1fr; 
+	-webkit-grid-rows: 15px 15px; 	-moz-grid-rows: 15px 15px; 	-ms-grid-rows: 15px 15px; 	-o-grid-rows: 15px 15px; 	grid-rows: 15px 15px; 
+
+}
+
+#css-grid0grid > div {
+	background: lime;
+}
+
+#css-grid0a {
+	-webkit-grid-row: 1; 	-moz-grid-row: 1; 	-ms-grid-row: 1; 	-o-grid-row: 1; 	grid-row: 1; 
+	-webkit-grid-column: 1; 	-moz-grid-column: 1; 	-ms-grid-column: 1; 	-o-grid-column: 1; 	grid-column: 1; 
+}
+
+#css-grid0b {
+	-webkit-grid-row: 1; 	-moz-grid-row: 1; 	-ms-grid-row: 1; 	-o-grid-row: 1; 	grid-row: 1; 
+	-webkit-grid-column: 2; 	-moz-grid-column: 2; 	-ms-grid-column: 2; 	-o-grid-column: 2; 	grid-column: 2; 
+}
+
+#css-grid0c {
+	-webkit-grid-row: 2; 	-moz-grid-row: 2; 	-ms-grid-row: 2; 	-o-grid-row: 2; 	grid-row: 2; 
+	-webkit-grid-column: 1; 	-moz-grid-column: 1; 	-ms-grid-column: 1; 	-o-grid-column: 1; 	grid-column: 1; 
+	-webkit-grid-column-span: 2; 	-moz-grid-column-span: 2; 	-ms-grid-column-span: 2; 	-o-grid-column-span: 2; 	grid-column-span: 2; 
+}
+</style>
+
+<div id="css-grid0grid">
+	 <div id="css-grid0a"></div>
+	 <div id="css-grid0b"></div>
+	 <div id="css-grid0c"></div>
+</div>
+
+</div><div class="info">Grid with two columns, two rows and three elements taking up space.</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Media Queries</h3><span class="links">[<a href="http://caniuse.com/css-mediaqueries">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-mediaqueries&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-mediaqueries0" class="visual-square"></div><div class="square"><style>
+#mediaq1,#mediaq2,#mediaq3,#mediaq4 {
+ background: red;
+ float: left;
+ width: 15px;
+ height: 15px;
+}
+
+#mediaq3 {
+	clear: left;
+}
+
+@media all and (min-width: 0px) {
+ #mediaq1, #mediaq3 { background: lime; }
+}
+
+@media all and (max-width: 999999px) {
+ #mediaq2, #mediaq4 { background: lime; }
+}
+
+
+@media all and (min-width: 999999px) {
+ #mediaq3 { background: red; }
+}
+
+@media all and (max-width: 0px) {
+ #mediaq4 { background: red; }
+}
+
+</style>
+
+<div id="mediaq1"></div>
+<div id="mediaq2"></div>
+<div id="mediaq3"></div>
+<div id="mediaq4"></div></div></div>
+
+</td></tr>
+<tr><th><h3>CSS 2.1 selectors</h3><span class="links">[<a href="http://caniuse.com/css-sel2">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-sel2&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-sel20" class="visual-square"></div><div class="square"><style>
+#css-sel20test div {
+	width: 30px;
+	height: 30px;
+	background: red;
+}
+
+#css-sel20test > div {
+	background: lime;
+}
+</style>
+<div id="css-sel20test">
+	<div></div>
+</div>
+</div><div class="info">Test for child ( &gt; )selector</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-sel21" class="visual-square"></div><div class="square"><style>
+#css-sel21test + div { background: lime; width:30px; height:30px;}
+</style>
+<div id="css-sel21test"></div>
+<div></div>
+</div><div class="info">Adjacent sibling selector test ( + )</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="css-sel22" class="visual-square"></div><div class="square"><style>
+#css-sel22test[role="none"] { background: lime; width:30px; height:30px;}
+</style>
+<div id="css-sel22test" role="none"></div></div><div class="info">Attribute selector ( [role="none"] )</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Box-sizing</h3><span class="links">[<a href="http://caniuse.com/css3-boxsizing">Table</a>] [<a href="http://tests.caniuse.com/?feat=css3-boxsizing&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="css3-boxsizing0" class="visual-square"></div><div class="square"><style>
+#boxsizetest {
+   -webkit-box-sizing: border-box;
+-moz-box-sizing: border-box;
+-ms-box-sizing: border-box;
+-o-box-sizing: border-box;
+box-sizing: border-box;
+    background: red;
+    border-left: 30px solid lime;
+    display: inline-block;
+    height: 30px;
+    width: 30px;
+}
+</style>
+<div id="boxsizetest"></div>
+</div></div>
+
+</td></tr>
+<tr><th><h3>Data URLs</h3><span class="links">[<a href="http://caniuse.com/datauri">Table</a>] [<a href="http://tests.caniuse.com/?feat=datauri&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="datauri0" class="visual-square"></div><div class="square"><div style="background-image: url(&#39;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAP8AAAAAbwN%2BQwAAAAxJREFUeNpiYAAIMAAAAgABT21Z4QAAAABJRU5ErkJggg%3D%3D&#39;);width:30px;height:30px;"></div></div><div class="info">div with data URL as background image</div></div>
+
+</td></tr>
+<tr><th><h3>New semantic elements</h3><span class="links">[<a href="http://caniuse.com/html5semantic">Table</a>] [<a href="http://tests.caniuse.com/?feat=html5semantic&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="html5semantic0" class="visual-square"></div><div class="square"><style>
+#html5semantic0test {
+	width: 30px;
+	height: 30px;
+	background: red;
+}
+
+#html5semantic0test * {
+	background: lime;
+	height: 4px;
+}
+
+#html5semantic0test section {
+	height: 6px;
+}
+</style>
+
+<div id="html5semantic0test">
+	<section></section>
+	<article></article>
+	<aside></aside>
+	<hgroup></hgroup>
+	<header></header>
+	<footer></footer>
+	<nav></nav>
+</div></div><div class="info">section, article, aside, hgroup, header, footer, nav tested for default "block" style.</div></div>
+
+</td></tr>
+<tr><th><h3>CSS inline-block</h3><span class="links">[<a href="http://caniuse.com/inline-block">Table</a>] [<a href="http://tests.caniuse.com/?feat=inline-block&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="inline-block0" class="visual-square"></div><div class="square"><div style="background:lime;display:inline-block;width:15px;height:30px;"></div><div style="background:lime;display:inline-block;width:15px;height:30px;"></div></div></div>
+
+</td></tr>
+<tr><th><h3>CSS min/max-width/height</h3><span class="links">[<a href="http://caniuse.com/minmaxwh">Table</a>] [<a href="http://tests.caniuse.com/?feat=minmaxwh&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="minmaxwh0" class="visual-square"></div><div class="square"><div style="width:200%;max-width:30px;height:30px;overflow:visible;background:lime"></div></div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="minmaxwh1" class="visual-square"></div><div class="square"><div style="width:0;min-width:30px;height:30px;background:lime"></div></div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="minmaxwh2" class="visual-square"></div><div class="square"><div style="height:100px;max-height:30px;width:30px;background:lime"></div></div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="minmaxwh3" class="visual-square"></div><div class="square"><div style="height:0;min-height:30px;width:30px;background:lime"></div></div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 object-fit/object-position</h3><span class="links">[<a href="http://caniuse.com/object-fit">Table</a>] [<a href="http://tests.caniuse.com/?feat=object-fit&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="object-fit0" class="visual-square"></div><div class="square"><style>
+#object-fit0test {
+	width: 30px;
+	height: 30px;
+	background: lime;
+	overflow: hidden;
+}
+
+#object-fit0test img {
+	-webkit-object-fit: contain;
+-moz-object-fit: contain;
+-ms-object-fit: contain;
+-o-object-fit: contain;
+object-fit: contain;
+
+}
+</style>
+
+<div id="object-fit0test">
+	<img src="./caniuse_files/red30x30.png" width="90" height="30">
+</div></div><div class="info">object-fit: contain</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="object-fit2" class="visual-square"></div><div class="square"><style>
+#object-fit2test {
+	width: 30px;
+	height: 30px;
+	background: lime;
+	overflow: hidden;
+}
+
+#object-fit2test img {
+	-webkit-object-position: 30px 30px;
+-moz-object-position: 30px 30px;
+-ms-object-position: 30px 30px;
+-o-object-position: 30px 30px;
+object-position: 30px 30px;
+
+}
+</style>
+
+<div id="object-fit2test">
+	<img src="./caniuse_files/red30x30.png" width="30" height="30">
+</div>
+</div><div class="info">object-position: 30px 30px;</div></div>
+
+</td></tr>
+<tr><th><h3>rem (root em) units</h3><span class="links">[<a href="http://caniuse.com/rem">Table</a>] [<a href="http://tests.caniuse.com/?feat=rem&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="rem0" class="visual-square"></div><div class="square"><div style="background:red;width:30px;height:30px;position:relative;overflow:hidden;text-align:left">
+	<span style="font-size:1px;background:lime;color:lime;position:relative;left:-6px;line-height:30px;font-size:5rem;">A</span>
+</div></div><div class="info">span with single character and font-size: 5rem;</div></div>
+
+</td></tr>
+<tr><th><h3>SVG in CSS backgrounds</h3><span class="links">[<a href="http://caniuse.com/svg-css">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-css&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-css0" class="visual-square"></div><div class="square"><div style="width:30px;height:30px;background-image: url(caniuse_files/svg-img.svg)"></div>
+
+</div></div>
+
+</td></tr>
+<tr><th><h3>SVG in HTML img element</h3><span class="links">[<a href="http://caniuse.com/svg-img">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-img&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual-square</h3><div id="svg-img0" class="visual-square"></div><div class="square"><img src="./caniuse_files/svg-img.svg" width="30" height="30"></div></div>
+
+</td></tr>
+<tr><th><h3>contenteditable attribute (basic support)</h3><span class="links">[<a href="http://caniuse.com/contenteditable">Table</a>] [<a href="http://tests.caniuse.com/?feat=contenteditable&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Interact</h3><div id="contenteditable0" class="interact"></div><div contenteditable="true">
+<p>This element should be editable.</p>
+</div><div class="info">Div element with attribute  contenteditable="true"</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 selectors</h3><span class="links">[<a href="http://caniuse.com/css-sel3">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-sel3&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Interact</h3><div id="css-sel30" class="interact"></div><a href="http://tools.css3.info/selectors-test/test.html" target="_blank">Test here</a></div>
+
+</td></tr>
+<tr><th><h3>Drag and Drop</h3><span class="links">[<a href="http://caniuse.com/dragndrop">Table</a>] [<a href="http://tests.caniuse.com/?feat=dragndrop&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Interact</h3><div id="dragndrop0" class="interact"></div><a href="http://html5demos.com/drag">Test here</a></div>
+
+</td></tr>
+<tr><th><h3>WAI-ARIA Accessibility features</h3><span class="links">[<a href="http://caniuse.com/wai-aria">Table</a>] [<a href="http://tests.caniuse.com/?feat=wai-aria&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;</td><td>
+
+</td></tr>
+<tr><th><h3>Text API for Canvas</h3><span class="links">[<a href="http://caniuse.com/canvas-text">Table</a>] [<a href="http://tests.caniuse.com/?feat=canvas-text&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="canvas-text0" class="auto pass"></div><script>setResult('canvas-text0', Modernizr.canvastext);</script><div class="info">Modernizr test for: "canvastext"</div></div>
+
+</td></tr>
+<tr><th><h3>WebGL - 3D Canvas graphics</h3><span class="links">[<a href="http://caniuse.com/webgl">Table</a>] [<a href="http://tests.caniuse.com/?feat=webgl&prefix=all">Single feat</a>]</span></th><td class="current partial">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="webgl0" class="auto pass"></div><script>setResult('webgl0', Modernizr.webgl);</script><div class="info">Modernizr test for: "webgl"</div></div>
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="webgl1" class="visual-square"></div><div class="square"><canvas width="30" height="30" style="background:red;" id="webgl_canvas"></canvas>
+<script>
+var elem  = $('#webgl_canvas')[0], g;
+try {
+    g     = elem.getContext && elem.getContext('experimental-webgl');
+} catch(e){};
+
+if (g){    
+  g.clearColor(0,1,0,1);
+  g.clear(g.COLOR_BUFFER_BIT);
+}
+</script>
+</div></div>
+
+</td></tr>
+<tr><th><h3>SVG fonts</h3><span class="links">[<a href="http://caniuse.com/svg-fonts">Table</a>] [<a href="http://tests.caniuse.com/?feat=svg-fonts&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="svg-fonts0" class="visual"></div><div class="vis_test"><style>
+@font-face { 
+  font-family: Windsong_svg; 
+  src: url(caniuse_files/Windsong-webfont.svg#webfontuOn4Eelr) format("svg");
+}
+#windsong_svg {
+	font: 18px Windsong_svg;
+	margin: 5px;
+}
+</style>
+<p id="windsong_svg">Windsong font</p>
+</div><div class="vis_ref"><img src="./caniuse_files/windsong_font.png"></div></div>
+
+</td></tr>
+<tr><th><h3>TTF/OTF - TrueType and OpenType font support</h3><span class="links">[<a href="http://caniuse.com/ttf">Table</a>] [<a href="http://tests.caniuse.com/?feat=ttf&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="ttf0" class="visual"></div><div class="vis_test"><style>
+@font-face {
+	font-family: 'Windsong_otf';
+	src: url('caniuse_files/Windsong-webfont.otf');
+}
+
+#windsong_otf {
+	font: 18px Windsong_otf;
+	margin: 5px;
+}
+</style>
+<p id="windsong_otf">Windsong font</p>
+</div><div class="vis_ref"><img src="./caniuse_files/windsong_font.png"></div><div class="info">OTF font test</div></div>
+
+<div class="test_wrap"><h3>Visual</h3><div id="ttf1" class="visual"></div><div class="vis_test"><style>
+@font-face {
+	font-family: 'Windsong_ttf';
+	src: url('caniuse_files/Windsong-webfont.ttf');
+}
+
+#windsong_ttf {
+	font: 18px Windsong_ttf;
+	margin: 5px;
+}
+</style>
+<p id="windsong_ttf">Windsong font</p>
+</div><div class="vis_ref"><img src="./caniuse_files/windsong_font.png"></div><div class="info">TTF font test</div></div>
+
+</td></tr>
+<tr><th><h3>WOFF - Web Open Font Format</h3><span class="links">[<a href="http://caniuse.com/woff">Table</a>] [<a href="http://tests.caniuse.com/?feat=woff&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="woff0" class="visual"></div><div class="vis_test"><style>
+@font-face {
+	font-family: 'Windsong_woff';
+	src: url('caniuse_files/Windsong-webfont.woff');
+}
+
+#windsong_woff {
+	font: 18px Windsong_woff;
+	margin: 5px;
+}
+</style>
+<p id="windsong_woff">Windsong font</p>
+</div><div class="vis_ref"><img src="./caniuse_files/windsong_font.png"></div></div>
+
+</td></tr>
+<tr><th><h3>Progress &amp; Meter</h3><span class="links">[<a href="http://caniuse.com/progressmeter">Table</a>] [<a href="http://tests.caniuse.com/?feat=progressmeter&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="progressmeter0" class="visual"></div><div class="vis_test"><div style="display:inline-block;vertical-align:middle">
+<progress value="5" max="10">fail</progress>
+<meter value="5" max="10">fail</meter>
+</div></div><p class="condition">Progress and meter widgets at 50%</p></div>
+
+</td></tr>
+<tr><th><h3>Datalist element</h3><span class="links">[<a href="http://caniuse.com/datalist">Table</a>] [<a href="http://tests.caniuse.com/?feat=datalist&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Interact</h3><div id="datalist0" class="interact"></div><input type="text" list="mydatalist">
+<datalist id="mydatalist">
+<option value="foo">foo</option>
+<option value="bar">bar</option>
+<option value="foobar">foobar</option>
+</datalist><p class="condition">Show "foo" and "foobar" as options when "f" is entered</p></div>
+
+</td></tr>
+<tr><th><h3>Form validation</h3><span class="links">[<a href="http://caniuse.com/form-validation">Table</a>] [<a href="http://tests.caniuse.com/?feat=form-validation&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Interact</h3><div id="form-validation0" class="interact"></div><iframe src="./caniuse_files/form_validation.html" width="300" height="80"></iframe><p class="condition">Form should show warning and NOT submit</p></div>
+
+</td></tr>
+<tr><th><h3>MPEG-4/H.264 video format</h3><span class="links">[<a href="http://caniuse.com/mpeg4">Table</a>] [<a href="http://tests.caniuse.com/?feat=mpeg4&prefix=all">Single feat</a>]</span></th><td class="current fail">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="mpeg40" class="auto pass"></div><script>
+var v = document.createElement('video'); 
+setResult('mpeg40', !!(v.canPlayType && v.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').replace(/no/, '')));
+</script></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="mpeg41" class="interact"></div><video src="video.mp4" width="160" height="120" controls="">fail</video><div class="info">Video, no MIME, no type attribute.</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="mpeg42" class="interact"></div><video width="160" height="120" controls="">
+ <source src="video.mp4" type="video/ogg; codecs=&quot;theora, vorbis&quot;">
+</video><div class="info">Video with source element</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="mpeg43" class="interact"></div><video width="160" height="120" controls="">
+ <source src="mimevid.php?type=.mp4" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
+</video><div class="info">Video with source element and MIME set</div></div>
+
+</td></tr>
+<tr><th><h3>Ogg/Theora video format</h3><span class="links">[<a href="http://caniuse.com/ogv">Table</a>] [<a href="http://tests.caniuse.com/?feat=ogv&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="ogv0" class="auto pass"></div><script>
+var v = document.createElement('video'); 
+setResult('ogv0', !!(v.canPlayType && v.canPlayType('video/ogg; codecs="theora"').replace(/no/, '')));
+</script></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="ogv1" class="interact"></div><video src="video.ogv" width="160" height="120" controls="">fail</video><div class="info">Video, no MIME, no type attribute.</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="ogv2" class="interact"></div><video width="160" height="120" controls="">
+ <source src="mimevid.php?type=.ogv" type="video/ogg; codecs=&quot;theora, vorbis&quot;">
+</video><div class="info">Video with source element and MIME set</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="ogv3" class="interact"></div><video width="160" height="120" controls="">
+ <source src="video.ogv" type="video/ogg; codecs=&quot;theora, vorbis&quot;">
+</video><div class="info">Video with source element</div></div>
+
+</td></tr>
+<tr><th><h3>WebM/VP8 video format</h3><span class="links">[<a href="http://caniuse.com/webm">Table</a>] [<a href="http://tests.caniuse.com/?feat=webm&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="webm0" class="auto pass"></div><script>
+var v = document.createElement('video'); 
+setResult('webm0', !!(v.canPlayType && v.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/no/, '')));
+</script></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="webm1" class="interact"></div><video src="video.webm" width="160" height="120" controls="">fail</video><div class="info">Video, no MIME, no type attribute.</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="webm2" class="interact"></div><video width="160" height="120" controls="">
+ <source src="video.webm" type="video/ogg; codecs=&quot;theora, vorbis&quot;">
+</video><div class="info">Video with source element</div></div>
+
+<div class="test_wrap"><h3>Interact</h3><div id="webm3" class="interact"></div><video width="160" height="120" controls="">
+ <source src="mimevid.php?type=.webm" type="video/webm; codecs=&quot;vp8, vorbis&quot;">
+</video><div class="info">Video with source element and MIME set</div></div>
+
+</td></tr>
+<tr><th><h3>Animated PNG (APNG) [unoff]</h3><span class="links">[<a href="http://caniuse.com/apng">Table</a>] [<a href="http://tests.caniuse.com/?feat=apng&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="apng0" class="auto fail"></div><script>
+(function() {
+	// From: http://eligrey.com/blog/post/apng-feature-detection
+	var apngTest = new Image();
+	var canv = document.createElement("canvas");
+	var apng_supported = null;
+	if(canv.getContext && canv.getContext("2d").drawImage) {
+		var ctx = canv.getContext("2d");
+		var apng_supported = false;
+		apngTest.onload = function () {
+			ctx.drawImage(apngTest, 0, 0);
+			apng_supported = ( ctx.getImageData(0, 0, 1, 1).data[3] === 0 );
+			setResult('apng0', apng_supported);
+		};
+		apngTest.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg==";
+	} else {
+		setResult('apng0', false);
+	}
+}());
+
+
+</script><div class="info">Test for second frame using Canvas element </div></div>
+
+<div class="test_wrap"><h3>Visual</h3><div id="apng1" class="visual"></div><div class="vis_test"><img src="./caniuse_files/apng_test.png" width="16" height="16"></div><p class="condition">Must animate</p></div>
+
+</td></tr>
+<tr><th><h3>CSS Canvas Drawings [unoff]</h3><span class="links">[<a href="http://caniuse.com/css-canvas">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-canvas&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="css-canvas0" class="auto pass"></div><script>
+setResult('css-canvas0', 'getCSSCanvasContext' in document)
+</script><div class="info">'getCSSCanvasContext' in document</div></div>
+
+</td></tr>
+<tr><th><h3>CSS Reflections [unoff]</h3><span class="links">[<a href="http://caniuse.com/css-reflections">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-reflections&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="css-reflections0" class="auto pass"></div><script>setResult('css-reflections0', Modernizr.cssreflections);</script><div class="info">Modernizr test for: "cssreflections"</div></div>
+
+
+<div class="test_wrap"><h3>Visual-square</h3><div id="reflections1" class="visual-square"></div><div class="square">
+
+  <div style="width:30px; height:30px; overflow:hidden; position:relative; background:red;">
+ <div style="background: lime;
+            height: 30px;
+            position: relative;
+            top: -30px;
+            width: 30px;
+            -webkit-box-reflect: below 0;
+               -moz-box-reflect: below 0;
+                -ms-box-reflect: below 0;
+                 -o-box-reflect: below 0;
+                    box-reflect: below 0;
+            "></div>
+
+</div></div></div>
+
+
+</td></tr>
+<tr><th><h3>Web SQL Database [unoff]</h3><span class="links">[<a href="http://caniuse.com/sql-storage">Table</a>] [<a href="http://tests.caniuse.com/?feat=sql-storage&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto (m)</h3><div id="sql-storage0" class="auto pass"></div><script>setResult('sql-storage0', Modernizr.websqldatabase);</script><div class="info">Modernizr test for: "websqldatabase"</div></div>
+
+</td></tr>
+<tr><th><h3>Stream API [unoff]</h3><span class="links">[<a href="http://caniuse.com/stream">Table</a>] [<a href="http://tests.caniuse.com/?feat=stream&prefix=all">Single feat</a>]</span></th><td class="current unknown">&nbsp;</td><td>
+<div class="test_wrap"><h3>Auto</h3><div id="stream0" class="auto fail"></div><script>
+setResult('stream0', "getUserMedia" in navigator);
+</script><div class="info">Test for "getUserMedia" in navigator object</div></div>
+
+</td></tr>
+<tr><th><h3>CSS Masks [unoff]</h3><span class="links">[<a href="http://caniuse.com/css-masks">Table</a>] [<a href="http://tests.caniuse.com/?feat=css-masks&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="css-masks0" class="visual"></div><div class="vis_test"><style>
+#masktest {
+	-webkit-mask-image: url(caniuse_files/alpha.png);
+-moz-mask-image: url(caniuse_files/alpha.png);
+-ms-mask-image: url(caniuse_files/alpha.png);
+-o-mask-image: url(caniuse_files/alpha.png);
+mask-image: url(caniuse_files/alpha.png);
+    background: black;
+    height: 16px;
+    width: 32px;
+    display: inline-block;
+    margin-left: -32px;
+}
+#masktestbg {
+    display: inline-block;
+	background: lime;
+    height: 16px;
+    width: 32px;
+	left: -32px;
+}
+
+</style>
+<div id="masktestbg"></div><div id="masktest"></div>
+
+</div><div class="vis_ref"><img src="./caniuse_files/png_alpha_result.png"></div><div class="info">mask-image: url(caniuse_files/alpha.png);</div></div>
+
+</td></tr>
+<tr><th><h3>CSS3 Text-overflow [unoff]</h3><span class="links">[<a href="http://caniuse.com/text-overflow">Table</a>] [<a href="http://tests.caniuse.com/?feat=text-overflow&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="text-overflow0" class="visual"></div><div class="vis_test"><style>
+#textof {
+ width: 4em;
+ display: inline-block;
+ overflow: hidden;
+ font: 16px courier, monospace;
+-webkit-text-overflow: ellipsis; 
+-moz-text-overflow: ellipsis; 
+-ms-text-overflow: ellipsis; 
+-o-text-overflow: ellipsis; 
+text-overflow: ellipsis; 
+
+ text-overflow: ellipsis; 
+}
+</style>
+
+<div id="textof">
+abcdefghijklmnopqrstuvwxyz
+</div></div><p class="condition">Should end with ellipsis</p><div class="info">text-overflow: ellipsis;</div></div>
+
+</td></tr>
+<tr><th><h3>CSS text-stroke [unoff]</h3><span class="links">[<a href="http://caniuse.com/text-stroke">Table</a>] [<a href="http://tests.caniuse.com/?feat=text-stroke&prefix=all">Single feat</a>]</span></th><td class="current pass">&nbsp;<span>-pre-</span></td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="text-stroke0" class="visual"></div><div class="vis_test"><style>
+#textstroke {
+-webkit-text-stroke: 2px lime;
+-moz-text-stroke: 2px lime;
+-ms-text-stroke: 2px lime;
+-o-text-stroke: 2px lime;
+text-stroke: 2px lime;
+
+color: #000;
+font-size: 15px;
+padding: 5px;
+font-family: Times New Roman, Times, serif;
+}
+</style>
+
+<div id="textstroke">
+green stroked text
+</div></div><div class="vis_ref"><img src="./caniuse_files/stroked-text.png"></div><div class="info">text-stroke: 2px lime;</div></div>
+
+</td></tr>
+<tr><th><h3>EOT - Embedded OpenType fonts [unoff]</h3><span class="links">[<a href="http://caniuse.com/eot">Table</a>] [<a href="http://tests.caniuse.com/?feat=eot&prefix=all">Single feat</a>]</span></th><td class="current fail">&nbsp;</td><td>
+<div class="test_wrap"><h3>Visual</h3><div id="eot0" class="visual"></div><div class="vis_test"><style>
+@font-face {
+	font-family: 'Windsong_eot';
+	src: url('caniuse_files/Windsong-webfont.eot');
+}
+
+#windsong_eot {
+	font: 18px Windsong_eot;
+	margin: 5px;
+}
+</style>
+<p id="windsong_eot">Windsong font</p>
+</div><div class="vis_ref"><img src="./caniuse_files/windsong_font.png"></div></div>
+
+</td></tr>
+<tr><th><h3>XHTML+SMIL animation [unoff]</h3><span class="links">[<a href="http://caniuse.com/xhtmlsmil">Table</a>] [<a href="http://tests.caniuse.com/?feat=xhtmlsmil&prefix=all">Single feat</a>]</span></th><td class="current fail">&nbsp;</td><td>
+
+</td></tr>
+</tbody></table>
+<p>Most tests by <a href="http://a.deveria.com/">Alexis Deveria</a>, additional contributions by <a href="http://paulirish.com/">Paul Irish</a></p>
+
+<script>
+(function() {
+var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
+document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
+}());
+</script><script src="./caniuse_files/ga.js" type="text/javascript"></script>
+<script>
+(function() {
+try {
+var pageTracker = _gat._getTracker("UA-16085010-1");
+pageTracker._trackPageview();
+} catch(err) {}
+}());
+</script></body></html>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.eot b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.eot
new file mode 100644
index 0000000..768d053
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.eot differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.otf b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.otf
new file mode 100644
index 0000000..369e640
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.otf differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.svg b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.svg
new file mode 100644
index 0000000..b200eb5
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.svg
@@ -0,0 +1,147 @@
+<?xml version="1.0" standalone="no"?>
+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" >
+<svg xmlns="http://www.w3.org/2000/svg">
+<metadata>
+This is a custom SVG webfont generated by Font Squirrel.
+Copyright   : Bright Ideas Magazine
+</metadata>
+<defs>
+<font id="webfontuOn4Eelr" horiz-adv-x="622" >
+<font-face units-per-em="2048" ascent="1638" descent="-410" />
+<missing-glyph horiz-adv-x="589" />
+<glyph unicode=" "  horiz-adv-x="589" />
+<glyph unicode="&#x09;" horiz-adv-x="589" />
+<glyph unicode="&#xa0;" horiz-adv-x="589" />
+<glyph unicode="!" horiz-adv-x="827" d="M322 -33q0 20 20 49q23 31 41 31q20 -8 20 -45q0 -27 -18 -49q-18 -20 -43 -21q-20 0 -20 35zM410 182q0 14 8 25q4 4 6 8t6 10l10 15q43 74 172 333q145 291 248 527q0 10 17 20q14 8 24 8q31 -2 31 -32q0 -8 -2 -13q-31 -80 -92 -198l-115 -211l-258 -484 q-14 -31 -39 -24q-16 6 -16 16z" />
+<glyph unicode="&#x22;" horiz-adv-x="458" d="M432 864l143 293q6 12 21 12q45 0 45 -32q0 -4 -4 -9q-80 -141 -188 -278q-8 -10 -17 -4q-6 4 0 18zM571 864l144 293q6 12 20 12q45 0 45 -32q0 -4 -4 -9q-80 -141 -188 -278q-8 -10 -17 -4q-6 4 0 18z" />
+<glyph unicode="#" horiz-adv-x="798" d="M47 442q0 14 16 21q100 31 236 59l115 209q-129 -23 -219 -49q-16 -4 -16.5 12.5t16.5 20.5q80 23 243 59q96 170 133 246q10 14 23 14q25 0 12 -26l-119 -222q151 37 265 56q111 205 174 344q8 14 18 14t10 -10q0 -2 -1 -4t-1 -4q-68 -166 -151 -332q10 2 56 9t83 11 l29 4q25 2 24 -16q0 -20 -24 -27l-31 -6q-80 -10 -164 -24l-104 -197q37 10 82 17l86 10q20 2 20 -19q0 -27 -29 -30l-77 -11q-18 -2 -111 -22q-27 -45 -102 -184l-197 -359q-14 -20 -33 -20q-20 0 -20 16q0 4 4 12l199 365l88 158q-90 -18 -254 -48q-57 -102 -168 -280 q-18 -35 -41 0q-4 6 -4 22q0 -5 3 3q1 2 5 14q63 76 151 229q-104 -18 -202 -49q-23 -6 -23 14zM352 535q31 6 117 26.5t133 30.5h10l111 201q-8 -2 -32.5 -7.5t-39.5 -7.5q-78 -18 -188 -39l-76 -139z" />
+<glyph unicode="$" horiz-adv-x="677" d="M43 160q0 63 33 129q8 16 28 16q23 0 17 -24q-23 -68 -23 -97q0 -18 11 -43q23 -43 57 -43q23 0 74 11q4 8 6 16t10 27.5t20 52.5l134 348q-51 164 -52 223q0 31 7 55q12 63 81 127q68 61 154 84l90 220h4v2h6q10 0 11 -15l-80 -198q41 6 84 -4q49 -12 49 -66 q0 -29 -8 -59q-18 -63 -86 -95q-10 -2 -23 0q-14 4 -18 11q-14 14 -11 34q2 23 14.5 23t18.5 -14q6 -16 17 -11q45 31 45 76q0 37 -39 55q-35 4 -66 -6l-159 -420q49 -147 49 -215q0 -61 -25 -112q-49 -117 -215 -185q-39 -117 -76 -247q0 -18 -22 -15q-10 0 -10 21 q20 80 69 227l-12 -4q-6 -2 -12 -2q-25 -4 -35 -4q-51 0 -84 35t-33 86zM279 121q109 39 143 106q29 61 29 125q0 53 -27 154l-117 -311zM414 760q0 -51 22 -135l142 362q-109 -33 -142 -113q-22 -55 -22 -114z" />
+<glyph unicode="%" horiz-adv-x="1130" d="M137 -174q150 195 502 602l485 545q-57 -45 -149 -90q-205 -106 -293 -107q-41 0 -78 12q-154 -164 -319 -163q-12 0 -37 4q-20 4 -37 20q-23 23 -23 49q0 18 9 35q120 187 436 295q29 20 59 21q35 0 47 -35q6 -23 -6 -47q-35 -63 -96 -138q37 -8 61 -8q139 0 336 135 q111 78 314 256l34 39q14 14 28.5 0t2.5 -28l-39 -41l-49 -52q-545 -561 -1141 -1325q-18 -25 -39 -12q-20 10 -8 33zM240 688q14 -18 57 -20q156 23 268 141q-29 18 -28 65q0 51 24 89q12 16 21 24q-194 -77 -338 -239q-20 -35 -4 -60zM575 889q0 -28 25 -43q51 57 100 137 q4 16 -2 21q-18 16 -45 0q-78 -54 -78 -115zM651 86q70 199 283 340q-2 6 6 18q12 4 21 -2q2 2 10 6.5t12 8.5q6 2 8 -2q0 -4 -2 -6q-8 -8 -20 -17q25 -43 24.5 -102.5t-24.5 -118.5q-100 -225 -260 -225q-35 0 -50 14q-31 25 -8 86zM690 76q-2 -20 12 -33q12 -12 50 0 q88 35 145 112.5t57 172.5q0 35 -14 82q-201 -164 -250 -334z" />
+<glyph unicode="&#x26;" horiz-adv-x="1449" d="M190 160q0 33 9 59q31 100 92 176q41 47 133 115q129 94 250 137q-78 31 -78 119q0 25 10 61q37 131 137 207q102 78 230 78q53 0 96 -24.5t43 -69.5q0 -76 -98 -137q-51 -35 -127 -35q-47 0 -66 45q-4 8 6 37q8 20 35 20q12 -33 47 -35q51 -6 86 15q39 23 45 28 q22 18 31 50v12q0 55 -108 55q-113 0 -199 -67.5t-117 -180.5q-2 -8 -2 -24q0 -43 37 -78q43 -39 104 -45q16 0 17 -16q0 -23 -21 -25q-193 -43 -338 -156q-80 -59 -112 -98q-47 -57 -76 -154q-8 -25 -8 -53q0 -80 69 -131q59 -47 160 -53q274 -18 463 235q33 45 33 127 q0 119 -82 156h-17q-186 0 -204 -117q-12 -74 65 -80q29 -4 41 9q2 2 23 32q6 10 16 4t6 -20q-20 -90 -98 -90q-49 0 -78 35q-31 35 -27 100q2 70 89 121q74 43 167 43q90 0 225.5 -51.5t200.5 -51.5q137 0 224 93q84 90 84 239q0 41 -43 84q-45 45 -80 45q-188 0 -189 -157 q0 -59 86 -60q39 0 74 41q6 8 14 8q16 0 17 -26q0 -25 -39 -58q-35 -29 -66 -28q-55 0 -90 32q-37 35 -37 82q0 109 63.5 170.5t166.5 55.5q68 -4 119 -70q45 -59 45 -119q0 -170 -97 -280q-102 -117 -256 -117q-80 0 -180 49q-131 63 -168 72q63 -57 64 -146 q0 -94 -39 -145q-223 -293 -504 -281q-111 6 -193 70q-86 68 -86 162z" />
+<glyph unicode="'" horiz-adv-x="325" d="M432 864l143 293q6 12 21 12q45 0 45 -32q0 -4 -4 -9q-80 -141 -188 -278q-8 -10 -17 -4q-6 4 0 18z" />
+<glyph unicode="(" horiz-adv-x="415" d="M49 147q0 123 37 263q25 102 135 284q119 201 258 340l117 105q2 2 8 2q8 0 10 -8.5t-4 -12.5q-43 -37 -108 -102q-126 -129 -246 -344q-82 -145 -119 -275q-33 -119 -33 -252q0 -221 70 -284q6 -6 6 -17q0 -25 -22 -24q-8 0 -17 8q-92 96 -92 317z" />
+<glyph unicode=")" horiz-adv-x="415" d="M-129 -153.5q-2 8.5 4 12.5q43 37 111 104q126 129 245 344q78 139 117 275q35 127 35 252q0 221 -70 284q-8 8 -8 17q0 23 25 22q10 0 16 -6q90 -92 90 -317q0 -125 -37 -263q-25 -102 -135 -284q-121 -205 -258 -342l-115 -103q-4 -4 -8 -4q-10 0 -12 8.5z" />
+<glyph unicode="*" horiz-adv-x="593" d="M281 780q0 10 12 23l26 26q37 31 148 95q-80 49 -109 104q-2 8 9 21q10 10 20 10t10 -8q12 -27 47 -43q35 -20 66 -35l12 -4l64 166q6 23 30 22q18 0 15 -16q-12 -51 -49 -152q96 61 157 111q12 8 19 8q16 0 16 -16q0 -10 -10 -19q-74 -63 -184 -129l77 -24 q35 -12 50 -23q12 -9 24 -43q6 -10 -8 -25q-12 -12 -25 -12q-10 0 -14 10q-14 25 -59 39q-41 10 -82 27l-78 -178q-6 -16 -23 -17q-20 0 -14 21l66 174q-125 -78 -146 -92l-26 -27q-12 -12 -23 -12q-18 0 -18 18z" />
+<glyph unicode="+" d="M201 466.5q0 22.5 26 27.5q16 0 70.5 1t93.5 1l56 2l10 41l45 174q8 39 37 39q25 0 22 -27l-47 -186q-6 -27 -12 -41h16q4 0 10.5 1t8.5 1q23 0 81 1t93 1q41 0 41 -27q0 -25 -29 -31h-184h-52l-12 -51l-45 -164q-8 -27 -31 -26q-22 0 -18 24l41 166q6 27 12 49h-43h-84 q-25 0 -51.5 1t-28.5 1q-26 0 -26 22.5z" />
+<glyph unicode="," horiz-adv-x="290" d="M35 -150q43 51 76 115q29 57 26 68q-12 63 56 82q10 2 15 -7.5t5 -31.5q0 -20 -55 -94q-61 -86 -123 -146q-8 6 0 14z" />
+<glyph unicode="-" d="M201 514q0 23 26 25q37 4 99 4q8 0 131 4h151q39 0 39 -24.5t-26 -30.5q-16 0 -71.5 -1.5t-92.5 -1.5h-131h-52h-47q-26 0 -26 25z" />
+<glyph unicode="." horiz-adv-x="290" d="M125 18q-6 25 16 58q20 31 52 39q10 2 15 -7.5t5 -31.5q0 -16 -25 -47q-23 -29 -34 -29q-29 0 -29 18z" />
+<glyph unicode="/" horiz-adv-x="813" d="M190 -92q0 9 7 18l223 277l473 598q39 45 270 336q10 10 19 10q25 0 24 -23q0 -12 -4 -16l-266 -340l-471 -602l-223 -275q-8 -12 -23 -12q-29 0 -29 29z" />
+<glyph unicode="0" horiz-adv-x="786" d="M68 121q0 68 26 174q37 158 185 377q72 115 206 252q186 195 344 247q20 2 21 -10q12 -18 -37 -33h41q131 -10 131 -200q0 -72 -18 -144q-39 -156 -140 -323q-160 -268 -342 -432q-120 -104 -252 -105q-92 0 -131 53q-34 58 -34 144zM125 154q0 -68 37 -123 q25 -39 106 -33q180 33 369 262q90 109 184 285q86 160 111 297q6 27 6 63q0 174 -100 174q-2 0 -10.5 -1t-10.5 -1q-111 -23 -160 -125q-39 -84 -10 -159q4 -25 -18 -33q-29 -10 -29 20q-14 39 -14 78q0 70 28 115q2 4 10.5 16t12.5 19l-4 -7q-131 -131 -160 -163 q-92 -96 -156 -191q-127 -186 -167 -352q-25 -92 -25 -141z" />
+<glyph unicode="1" horiz-adv-x="512" d="M113 -6q27 68 213 428q14 29 344 604q-90 -45 -217 -45q-18 0 -17 20q0 10 23 15q104 18 143 33q84 27 137 86q14 18 33 14q10 0 14 -14q4 -10 -10 -27l-24 -31q-393 -662 -574 -1083q-6 -27 -31 -27q-12 0 -24 10.5t-10 16.5z" />
+<glyph unicode="2" horiz-adv-x="1028" d="M8 27q0 20 10 41q43 92 158 147q94 47 203 53q102 6 180 -26q326 233 516 565q49 89 49 178v31q-2 45 -49 61q-53 20 -123 2q-88 -170 -221 -225q-41 -18 -59 4q-18 20 16 72q6 9 25 31q80 102 217 151q31 61 61 160q8 18 19 16q20 0 12 -20q-18 -76 -47 -144 q68 14 125 -4q72 -27 86 -82q6 -25 6 -53q0 -61 -64 -184q-180 -334 -528 -582q2 0 3 -2t4 -4l9 -6l218 -187q127 -109 247 -135q33 0 19 -26q-4 -29 -33 -19q-131 20 -260 129l-219 193q-18 15 -37 24l-24.5 -17t-28.5 -19q-139 -86 -205 -117q-121 -59 -217 -68 q-68 -6 -68 62zM84 55q-8 -16 6 -16q96 0 203 49q37 15 184 98l29 19q-61 23 -133 22q-86 0 -164 -43q-88 -51 -125 -129zM733 913q100 31 170 148q-92 -43 -158 -137z" />
+<glyph unicode="3" horiz-adv-x="876" d="M23 39q0 98 106 201q20 14 35 6q29 -16 4 -37q-63 -78 -57 -154q10 -106 151 -106q78 0 158 37q309 145 469 430q53 96 53 182q0 141 -133 178q-102 -66 -211 -98q-45 -12 -59 8q-4 12 -4 33q18 66 124 94q88 23 150 14l8 7q143 113 150 204q-4 25 -39 25 q-162 -23 -258 -115q-8 -8 -15 -16q-31 -20 -47 2q-8 14 4 27l4 8q57 63 150 151q6 4 18 4q20 0 21 -16q0 -8 -8 -16l-25 -25q109 57 182 57q41 0 62 -20q22 -22 18 -55q-12 -111 -170 -232q141 -46 142 -203q0 -100 -66 -215q-172 -315 -504 -465q-95 -43 -190 -43 q-152 0 -209 97q-14 24 -14 51zM600 733zM600 733q61 6 139 51q-20 0 -49 -4q-63 -12 -90 -47z" />
+<glyph unicode="4" horiz-adv-x="946" d="M43 348q-12 20 12 33l45 27q12 8 107 65q217 129 321 215q166 137 240 297q23 49 12 100q-12 53 -78 43l-8 -2v2q-10 0 -10 11q0 14 10 14q23 12 43 12q66 0 88 -59q25 -72 -4 -139q-106 -238 -459 -459q72 2 148 -23q98 -35 164 -49l256 492q6 20 26 14q29 -4 15 -33 l-250 -483q49 -10 113 -10q96 0 176 33q20 12 37 -15q12 -23 -15 -43q-84 -39 -188 -39q-70 0 -150 19q-90 -174 -108 -215q-74 -158 -80 -217q0 -6 -14.5 -20.5t-22.5 -14.5q-16 -4 -26.5 4t-10.5 18q16 96 94 232l121 225l-125 45q-72 27 -129 27q-106 0 -203 -52l-77 -49 l-41 -22q-23 0 -29 16z" />
+<glyph unicode="5" horiz-adv-x="950" d="M31 178q0 102 41 180q47 96 139 103q55 4 100 -27q45 -29 41 -82q-2 -33 -24 -33q-12 0 -19 11v22q2 33 -26.5 51.5t-69.5 14.5q-63 -6 -100 -82q-33 -66 -33 -135q0 -59 35 -123q25 -39 71 -51q78 -18 146 4q178 59 268 135q315 260 315 508q0 20 -4 57q-12 94 -73 100 q-16 2 -47 3q-104 0 -238 -66q-23 -12 -35 8q-8 14 4 29q98 101 246 313q23 33 51 23q71 -25 142 -25q101 0 184 49q20 12 29 -4q12 -16 -11 -33q-76 -63 -182 -63q-63 0 -180 31q-29 -57 -176 -242q104 45 217 51q57 2 98 -47q33 -41 43 -110q10 -94 -22 -181 q-76 -207 -242 -366q-164 -158 -377 -226q-76 -25 -127 -24q-39 0 -70 12q-114 43 -114 215z" />
+<glyph unicode="6" horiz-adv-x="724" d="M39 147q0 160 176 390q195 246 471 471q301 246 762 405q16 8 20 -6q12 -23 -10 -25q-498 -186 -817 -471q-229 -205 -387 -401q-154 -195 -154 -348q0 -57 25 -94q51 -82 151 -82q72 0 156 45q180 96 176 205q0 31 -47 30q-211 -6 -358 -223q-25 -16 -35 -6 q-12 12 -2 26q39 76 104 134q169 141 308 129q70 -6 88 -43q8 -16 8 -41q0 -78 -58 -136q-63 -63 -161 -112q-106 -53 -195 -53q-119 0 -192 92q-29 53 -29 114z" />
+<glyph unicode="7" horiz-adv-x="765" d="M109 -313q-4 14 2 26q49 195 192 449q102 184 242 364q-143 20 -228 9v-5l-8 2q-16 6 -8 19q0 8 10 8q104 37 271 12q2 2 8 11.5t10 13.5q174 213 455 436q-84 -31 -168 -31q-113 0 -269 62q-16 4 -24 4q-61 0 -131 -82l-10 -6q-25 -18 -41 -4q-20 20 4 39l28 28 q43 37 131 132q10 10 21 8q10 0 14 -11q2 -8 -2 -16l-30 -43q31 6 63 -6q127 -47 254 -47q129 0 244 51q14 10 35 10q29 0 28 -8q8 -20 -14 -37l-51 -39q-170 -125 -275 -213q-145 -125 -229 -256l-2 -4q70 -10 125 -10q10 0 38.5 6t41.5 6q20 6 26 -14q0 -29 -26 -33 q-53 -20 -91 -14q-57 0 -149 14q-328 -430 -426 -809q-12 -45 -41 -39q-14 1 -20 17z" />
+<glyph unicode="8" horiz-adv-x="589" d="M-14 27q0 70 37 118q139 193 387 414q-53 137 -48 221q9 135 99 264q84 117 188 117q33 0 60 -14q72 -41 71 -166q2 -10 -4 -25q0 -23 -18 -28q-12 -10 -31 8q-12 88 -20 106q-23 59 -84 56q-82 -12 -150 -129q-66 -113 -65 -221q0 -47 41 -154l83 76l404 362 q82 80 307 268q23 12 29 -2q4 -8 -6 -24q-53 -41 -144 -129l-79.5 -77t-45 -42t-19.5 -17.5l-13 -13.5l-404 -362l-94 -86q45 -111 45 -185q0 -55 -27 -118q-49 -115 -157 -205q-109 -88 -236 -107q-59 -8 -92 37q-14 21 -14 58zM43 39q0 -55 57 -55q51 0 127 53 q160 113 205 235q37 101 12 185q-10 41 -16 53q-72 -66 -147 -143l-117 -123q-55 -63 -96 -123q-25 -37 -25 -82z" />
+<glyph unicode="9" horiz-adv-x="552" d="M82 -303q0 16 12 33l592 1005q-80 -72 -211 -151q-74 -43 -164 -43q-63 0 -95 23.5t-30 68.5q6 201 361 401q137 78 248 78q33 0 63 -10q10 0 10 -12q0 -29 -26 -21q-43 18 -127 -10q-139 -47 -230 -111q-94 -66 -190 -180q-43 -49 -43 -123q6 -35 47 -47q83 -25 166 25 q270 164 409 444l9 12q6 10 16 11q20 0 21 -15q0 -6 -5 -14l-12 -25l-414 -739q-252 -444 -364 -612q-12 -12 -23 -13q-20 0 -20 25z" />
+<glyph unicode=":" horiz-adv-x="290" d="M125 18q-6 25 16 58q20 31 52 39q10 2 15 -7.5t5 -31.5q0 -16 -25 -47q-23 -29 -34 -29q-29 0 -29 18zM236 285q-6 25 16 57q20 31 51 39q10 2 15.5 -7t5.5 -32q0 -16 -25 -47q-23 -29 -35 -29q-28 1 -28 19z" />
+<glyph unicode=";" horiz-adv-x="290" d="M35 -150q43 51 76 115q29 57 26 68q-12 63 56 82q10 2 15 -7.5t5 -31.5q0 -20 -55 -94q-61 -86 -123 -146q-8 6 0 14zM225 285q-6 27 15 57q20 29 53 39q10 2 15 -7t5 -32q0 -16 -24 -47q-23 -29 -37 -29q-27 1 -27 19z" />
+<glyph unicode="&#x3c;" horiz-adv-x="839" d="M166 373q0 20 27 35l194 106q166 78 561 287q2 2 10 2q18 0 19 -19q0 -6 -8 -12l-551 -307l-148 -82q6 0 18.5 -3l20.5 -5q16 -4 58.5 -16.5t103.5 -28.5l285 -60q8 -2 22 -20q0 -14 -14 -23q-6 -6 -23 -6l-282 62q-58 15 -178 43q-10 0 -91 22q-24 7 -24 25z" />
+<glyph unicode="=" d="M141 377q0 25 25 26q16 0 71.5 1.5t94.5 1.5q47 2 145 4q23 0 81 1t93 1q39 0 39 -27q0 -25 -26 -31h-187q-35 0 -83 -1t-62 -1h-84q-27 0 -53 1l-27 1q-27 0 -27 23zM201 539q0 20 26 24q16 0 70.5 2t93.5 2q47 2 146 4h174q41 0 41 -24.5t-29 -30.5q-20 0 -81.5 -1 t-102.5 -1h-148h-84h-80q-26 0 -26 25z" />
+<glyph unicode="&#x3e;" horiz-adv-x="839" d="M109 162q0 8 8 14l549 305l147 84q-8 2 -14 3t-10.5 2t-7.5 2t-4 1h-1l-164 43l-284 62q-8 2 -23 20q0 14 14 23q6 6 23 6l283 -61q58 -15 178 -43q12 0 90 -23q27 -6 27 -25q0 -20 -29 -36l-195 -105q-166 -78 -561 -287q-2 -2 -10 -2q-16 1 -16 17z" />
+<glyph unicode="?" horiz-adv-x="827" d="M322 -33q0 20 20 49q23 31 41 31q20 -8 20 -45q0 -27 -18 -49q-18 -20 -43 -21q-20 0 -20 35zM375 158q59 252 237 417l234 201q119 119 119 234q0 70 -113 65q-78 0 -184 -53l-47 -29q-49 -76 -125 -164l-13 -16q-12 -16 -30 -6q-16 10 -2 35l14 30q39 84 135 148 q4 6 70 113q10 16 16 16q20 0 12 -14q-2 0 -16 -31q-2 -4 -8 -18.5t-17 -34.5l82 41q49 23 95 24q76 6 122 -12q57 -25 58 -94q0 -98 -119 -226q-25 -27 -176 -163q-109 -96 -162 -172q-45 -59 -78 -160q-8 -31 -18 -63.5l-21 -69.5q-2 -25 -39 -27q-12 0 -20 10 q-8 13 -6 19z" />
+<glyph unicode="@" horiz-adv-x="1437" d="M72 328q0 205 172 420q133 166 307 266q324 182 602 182q113 0 197 -33q76 -31 125 -104q47 -72 47 -162q0 -45 -13 -84q-59 -193 -200 -321q-158 -145 -340 -146q-55 0 -70 43q-12 39 -4 84q-164 -131 -295 -156q-53 -12 -72 -8q-49 10 -47 62q10 100 205 223 q174 109 365 139q33 6 32 -12q0 -4 -4 -4q-174 -31 -317 -107q-158 -86 -221 -211q-2 -4 -2 -12q0 -20 30 -20q25 0 68 12q162 49 289 168l80 92q14 12 22 10q14 -2 14 -26l-8 -13q-27 -27 -76 -82q-23 -29 -18 -84q0 -20 16 -32q41 -33 105 -17q170 45 285 185 q111 135 120 319q4 72 -45 131q-43 55 -110 84q-89 37 -197 37q-72 0 -141 -14q-285 -57 -496 -213q-229 -164 -327 -418q-31 -76 -31 -158q0 -127 76 -231q109 -152 364 -152q420 0 660 213q18 14 28 4q12 -16 0 -28q-117 -117 -303 -183q-184 -68 -381 -67q-117 0 -217 24 q-131 31 -205 152q-69 109 -69 248z" />
+<glyph unicode="A" horiz-adv-x="1069" d="M59 59q47 324 486 686q143 121 436 267q131 63 213 63q31 0 31 -16q0 -10 -4 -16.5t-13 -4.5q-8 1 -16 1q-68 0 -199 -62q-205 -98 -375 -229q-195 -150 -301 -279q-125 -156 -180 -356q-4 -16 -4 -21q0 -29 23 -47q18 -16 39 -16q80 4 141 39q46 25 141 98 q186 143 268 233l293 316q170 184 271 327q14 27 28 19q13 -9 13 -17q0 -4 -2 -8l-367 -579q-53 -90 -78 -172q-39 -137 -39 -160q0 -55 31 -82q10 -10 31 -10q90 0 227 114q2 0 3 1q3 -1 3 2l2 -2q2 -1 4 -1q12 -6 2 -16q-168 -162 -274 -162q-63 0 -88 58q-8 25 -8 61 q0 29 30 176q98 213 187 346q-35 -43 -107 -110q-82 -78 -127 -129q-100 -111 -276 -242l-170 -129q-87 -56 -177 -56q-9 0 -18 1q-37 0 -61 37q-20 29 -20 61q0 7 1 16z" />
+<glyph unicode="B" horiz-adv-x="815" d="M27 109q0 39 12 77q31 106 201 162q125 209 221 342l47 62l227 327q-244 -145 -479 -145q-47 0 -72 2q-8 0 -8 10t8 10h25q286 0 584 209l14 11l2 2q5 2 8.5 1.5t7.5 -1.5q8 -6 9 -17l-9 -16q-27 -41 -114 -160q98 76 192 94q23 2 45 -10q20 -12 21 -35q0 -29 -21 -61 q-119 -137 -284 -242q205 0 229 -137q0 -8 1 -22.5t1 -20.5q0 -137 -67.5 -274.5t-174.5 -223.5q-186 -150 -381 -149q-117 0 -194 63q-51 52 -51 142zM90 123l2 -19l111 183q-119 -62 -113 -164zM100 47l17 -18q74 -59 180 -60q168 0 326 131q106 88 168 217q54 114 54 227 q0 17 -1 34q-6 106 -164 106q-45 0 -111 -14l-59 -19l-12 -4q-6 0 -13 2l-180 -303q-111 -182 -192 -287zM522 711q2 0 10.5 2l16.5 4l16 4q95 49 197 129l78 59q37 31 57 72q2 6 2 11q0 7 -4 16q-5 11 -16 10h-5q-106 -20 -196 -109q-74 -74 -150 -190z" />
+<glyph unicode="C" horiz-adv-x="854" d="M59 162q0 88 35 192q125 403 561 701q100 66 187 65q39 0 67 -16q117 94 269 135l1 1q2 0 7 -5l-4 -8q-86 -39 -234 -131q-4 -4 -8 -6q-6 -4 -6 -5q37 -37 37 -94q0 -66 -51 -117q-70 -70 -127 -69q-23 0 -31 22q-8 18 -2 39q18 117 117 209q-20 10 -46 10 q-70 0 -143 -49q-250 -166 -409 -415q-162 -252 -162 -445q0 -84 41 -129q67 -73 162 -73q11 0 22 1q227 18 449 314q10 14 22 2q8 -8 0 -23q-84 -123 -190 -217q-143 -125 -281 -135q-18 -1 -35 -1q-109 0 -172 54q-76 68 -76 193zM815 899q-1 -5 -1 -9q0 -6 3 -11 q6 -8 17 -9q51 14 81 66q14 29 15 49q0 33 -29 72q-57 -56 -86 -158z" />
+<glyph unicode="D" horiz-adv-x="1368" d="M8 -45q0 43 35 82q76 82 223 82q59 0 152 -17q55 -10 106 -26q121 102 213 256q35 57 156 289l76 159q-74 -25 -138 -24q-51 0 -100 16q-90 31 -90 94q2 111 143 187q119 66 267 71q11 0 21 1q127 0 228 -70q94 -66 144 -178q33 -76 33 -162q0 -237 -160 -467 q-80 -115 -205 -197q-150 -96 -289 -96q-53 0 -92 10l-180 66q-160 -137 -344 -168q-42 -7 -75 -7q-60 0 -89 23q-35 27 -35 76zM72 -27q0 -33 32 -47q27 -12 72 -12q109 0 213 63q55 33 105 72q-100 33 -201 33q-55 0 -103 -8q-82 -12 -106 -58q-12 -21 -12 -43zM578 55 q89 -31 116 -37q76 -20 127 -20q98 0 183 45q197 104 317 311q104 184 104 359q0 90 -30 149q-117 216 -327 217q-17 0 -34 -2q-111 -10 -207 -55q-133 -61 -133 -148q0 -47 68 -65q37 -10 78 -10q76 0 149 28l66 148q2 10 16 10t14 -16q0 -4 -2 -8q-6 -16 -19 -44l-30 -67 q49 29 66 63q6 14 24 15q16 0 13 -21q-2 -43 -58 -76q-23 -14 -67 -34q-95 -224 -148 -326q-82 -158 -211 -330q-40 -51 -75 -86z" />
+<glyph unicode="E" horiz-adv-x="909" d="M72 121q0 207 233 383q135 102 201 141q-18 39 -19 86q0 102 68 189q98 129 274 202q59 25 120 25q17 0 34 -2q96 98 244 135q8 2 14 2q15 0 15 -12q0 -10 -11 -13q-117 -12 -223 -120q84 -29 90 -107q0 -29 -22 -49q-47 -33 -82 -33q-16 0 -39 6q-48 17 -48 64 q0 15 5 33q4 10 22 47h-16q-53 0 -86 -17q-311 -154 -311 -338q0 -31 14 -73q102 53 199 63q12 1 22 1q67 0 96 -48q12 -14 8 -43q-6 -23 -20 -37q-63 -68 -168 -67q-94 0 -154 65q-193 -109 -327 -278q-66 -88 -66 -185q0 -80 47 -143q37 -39 140 -39q18 0 43 4 q166 43 303 141q66 45 243 201q6 10 21 2q6 -12 0 -22q-356 -381 -655 -381q-43 0 -93 18q-53 20 -63 35q-53 72 -53 164zM573 625q46 -43 111 -43q61 0 109 39q12 12 12 28q-4 18 -17 23q-27 7 -53 7q-42 0 -84 -17q-29 -10 -78 -37zM965 1034q0 -35 39 -45q4 -1 9 -1 q25 0 50 26q7 11 7 20q0 8 -5 17q-20 33 -80 43v-2q-20 -27 -20 -58z" />
+<glyph unicode="F" horiz-adv-x="729" d="M6 -84q113 354 377 518q78 49 168 92q18 25 63 99q12 23 113 202q72 127 131 199q-86 -8 -176 -8q-139 0 -176 -4q-188 -14 -326 -123l-16 -4q-6 6 -2 12q86 100 272 150q70 18 184 22l92.5 4t90.5 2q74 6 117 13q57 51 129 84q33 14 65 14q61 0 62 -39q0 -31 -37 -47 q-86 -41 -213 -66q-10 -2 -17 -2q-80 -92 -159 -239l-130 -244q82 35 281 82l12 2q12 2 21 0q6 -2 6 -10q0 -10 -2 -17l-16 -22l-33 -51q-27 -45 -29 -78v-29q0 -8 -12 -20q-23 -6 -27 8q-2 8 -2 30q0 58 37 136q-123 -25 -276 -93l-31 -40l-221 -295q-139 -174 -271 -263 q-10 -8 -20 -8q-23 0 -29 11q-3 6 -3 11t3 11zM96 -8q55 39 80 67q121 133 174 197q82 96 154 201l-101 -58q-203 -122 -307 -407zM973 1098q45 8 75.5 16t44 15.5t11.5 15.5q-6 2 -13 1q-14 0 -36 -9q-37 -14 -82 -39z" />
+<glyph unicode="G" horiz-adv-x="1159" d="M-172 -43q0 10 8 16q184 88 377 207q-2 18 -2 56q0 125 57 296l23 48q14 27 35 16q10 0 14 -14l10 -76q18 -121 74 -189l147 99q174 115 258 176q154 111 238 192q-41 53 -41 127q4 88 64 166q51 68 141 117q27 14 50 14q7 0 13 -2q58 -12 58 -72v-12q-6 -90 -97 -192 l-127 -137q47 -43 109 -43q37 0 74 18q31 49 55 49q16 0 26.5 -8t10.5 -21q-4 -47 -70 -73q-127 -227 -221 -365q-135 -187 -295 -307q-43 -31 -127 -63q-88 -33 -164 -37q-17 -1 -32 -1q-151 0 -218 81q-39 49 -57 118q-203 -131 -366 -198l-5 -1l-4 -1q-16 0 -16 16z M268 215l111 74q-66 78 -82 192q-33 -102 -33 -199q0 -34 4 -67zM274 178q6 -43 15 -59q22 -58 104 -92q61 -26 130 -26q14 0 28 1q49 6 135 33q78 27 107 49q166 125 282 287q63 86 201 336h-31q-90 0 -153 53q-219 -207 -496 -373l-147 -94q49 -37 118 -37q66 0 189 49 q12 6 20 -8q6 -12 -8 -23q-111 -68 -213 -67q-92 0 -152 57q-10 -6 -25.5 -17l-37.5 -28q-25 -16 -43.5 -26.5t-22.5 -14.5zM1104 821q131 135 178 252q8 18 8 32q0 24 -26 32h-6q-19 0 -50 -19q-131 -83 -131 -203q0 -54 27 -94z" />
+<glyph unicode="H" horiz-adv-x="999" d="M35 29q0 59 31 133q0 16 18 16q20 0 14 -20q-5 -44 -5 -79q0 -41 7 -63q12 -43 80 -43q16 0 35 7q186 55 356 305l131 192h-4q-57 25 -57 80q0 29 29 61q27 29 80 29q23 0 47 -14q61 111 104 241q18 59 19 107q0 76 -48 133q-45 51 -129 51q-82 0 -157 -57q-10 -6 -15 -2 q-12 6 0 18q74 76 191 76q125 0 174 -76q37 -59 37 -120q0 -41 -17 -101q-46 -151 -129 -301q12 -22 19 -43q4 -14 8 -43q78 10 160 45q86 37 98 41q138 206 215 301q135 166 277 268q23 10 30 5q2 -2 3 -6q0 -9 -19 -25q-203 -168 -424 -514q4 0 8 3t11.5 6t13.5 5 q10 2 22 -4q2 -2 -6 -20q-8 -4 -29.5 -16.5t-56.5 -29.5l-92 -135q-193 -287 -289 -501q-17 -39 -48 -40q-2 0 -5 1q-29 2 -16 34q12 29 22 48q87 266 87 443q0 17 -1 34q-11 -1 -22 -1q-26 0 -48 5q-197 -332 -403 -490q-98 -74 -174 -73q-133 0 -133 129zM709 551 q8 -23 22 -27q25 37 43 72q-12 8 -18 8q-29 0 -41 -18q-8 -12 -8 -23q0 -6 2 -12zM776 512h2q4 0 14.5 -1t20.5 -1v27q-4 18 -8 24q-6 -12 -21 -35q-2 -2 -4 -6zM831 174q55 92 187 289l53 74q-129 -57 -213 -72q1 -24 1 -48q0 -133 -28 -243z" />
+<glyph unicode="I" horiz-adv-x="864" d="M8 33q0 46 31 92q29 43 80 61q53 20 117 29q20 6 26 -12q0 -18 -20 -25l-60 -16q-47 -14 -73 -41q-31 -35 -31 -66q0 -23 18 -39q25 -14 53 -14q21 0 41 8q244 92 517 365q20 88 53 176q160 424 426 633q10 8 22 8q21 -2 21 -18q0 -9 -6 -21q-53 -176 -185 -397 q-123 -205 -274 -381q-43 -185 -43 -413q0 -50 2 -101q0 -31 -25 -31q-16 0 -26 20q-6 28 -6 95.5t6 175.5q4 92 20 184q-289 -272 -522 -348q-23 -8 -57 -8q-74 0 -93 33q-12 22 -12 51zM791 469q291 369 362 637q-245 -266 -362 -637z" />
+<glyph unicode="J" horiz-adv-x="655" d="M-299 -842q0 49 23 99q156 328 401 526q72 59 291 188q2 4 20 47q143 336 195 527q31 114 31 203q0 78 -21 139q-37 117 -143 149q-33 4 -49 4q-121 0 -269 -86q-119 -70 -162 -129q-27 -39 -26 -73q0 -27 18 -33q34 -10 69 -10l103 22h8q2 -2 -2 -8q-66 -49 -145 -49 q-31 0 -55 6q-53 13 -54 51q0 8 3 17q49 215 419 339q43 15 89 15l53 -4q207 -37 207 -310q0 -322 -211 -774q45 27 149 84q76 41 129 88h6h6q7 -4 8 -7q0 -4 -6 -9q-10 -10 -79 -72q-68 -47 -246 -149l-156 -340q-92 -195 -194 -322q-131 -156 -306 -235q-20 -4 -28 -4 q-76 -1 -76 110zM-223 -860q7 -15 21 -15q3 0 5 1q182 74 318 280q133 203 266 500q-195 -113 -240 -150q-117 -94 -208 -221q-49 -74 -154 -258q-22 -39 -22 -77q0 -30 14 -60z" />
+<glyph unicode="K" horiz-adv-x="714" d="M-80 51q0 53 21 103q2 14 22 20q25 0 17 -20q-2 -20 -2 -38q0 -93 55 -106q6 -1 13 -1q51 0 124 83q143 162 299 449q-62 6 -62 47q0 31 25 55q21 21 51 21q21 0 47 -11l86 156q115 215 132 303q0 8 -3 8h-12q-27 -6 -166 -71q-2 0 -3 -1l-3 -1q-16 0 -16 16q0 8 8 16 q74 49 199 103q23 10 41 4q27 -6 22 -37q-12 -82 -153 -352l-95 -172q2 -2 5 -7.5t6 -7.5q68 27 153 90l152 121q203 160 399 477q8 14 23 15q12 0 12 -10v-7q-55 -113 -164 -254q-94 -123 -176 -198q-225 -207 -383 -273q9 -36 9 -87q0 -15 -1 -31q-10 -182 -27 -295 q-28 -175 -36 -271q-16 -168 -17 -200q0 -145 74 -213q14 -10 6 -21q-4 -4 -10 -4q-4 0 -8 2q-115 74 -115 265v20q2 94 53 405q39 236 39 336q0 43 -6 78q-20 -6 -31 -8q-150 -260 -178 -303q-106 -166 -223 -267q-49 -43 -113 -43q-90 0 -90 117zM461 600q0 -10 35 -10 l2 4q2 4 7 11t9 16q-15 6 -26 5q-25 0 -27 -26z" />
+<glyph unicode="L" horiz-adv-x="770" d="M45 59q0 82 76 136q74 51 166 51q98 0 172 -56q59 61 96 117q78 111 188 289q-84 -25 -143 -25q-102 0 -178 41q-92 46 -105 123q-2 20 17 21q16 0 18 -15q18 -111 250 -110q86 0 186 37q43 68 86 149q47 94 136 176q100 98 186 98.5t86 -75.5q0 -52 -43 -105 q-23 -29 -76 -77q-133 -127 -350 -216q-61 -104 -225 -337q-41 -59 -96 -119l108 -123q78 -88 209 -217q77 -65 117 -80q57 -25 174 -25q68 0 119 31q59 37 59 94q0 41 -37 41q-66 0 -76 -55q0 -4 -3 -12.5t-3 -12.5q-4 -16 -18 -12q-14 6 -13 23l5 20q14 111 108 111 q29 0 51 -33q20 -29 21 -64q0 -80 -57.5 -139t-137.5 -59q-123 0 -198 37q-39 20 -138 102q-59 53 -104 107q-59 68 -107 110q-47 51 -118 115q-25 -25 -111 -98q-119 -102 -176 -102.5t-88 38.5q-33 43 -33 100zM82 59q0 -78 88 -77q51 0 145 73q49 41 103 92 q-66 41 -148 41q-188 0 -188 -129zM856 694q174 74 281 168l61 53q31 35 31 78q0 37 -47 37q-72 0 -158 -82q-63 -63 -111 -151q-18 -35 -57 -103z" />
+<glyph unicode="M" horiz-adv-x="1062" d="M-106 1038q0 61 71 152q92 115 230 196q126 74 258 74q127 0 194 -74q20 -29 21 -81q0 -98 -121 -390q-8 -20 -23 -49q147 147 312 185q19 4 32 4q29 0 37 -21q6 -18 6 -43q0 -37 -24 -104q-31 -82 -172 -395q141 166 157 182q102 102 199 123q4 0 8 1t6 1q41 0 52 -56 q3 -18 3 -35t-3 -32q-16 -78 -97 -244q-76 -160 -100 -244q-10 -33 -10 -106q0 -162 59 -215q31 -18 21 -37q-6 -14 -23 -16q-4 0 -24 4q-76 39 -76 213q0 100 20 174q25 88 144 370q29 70 28 119q0 29 -16 33q-3 1 -7 1q-38 0 -118 -58q-88 -63 -145 -138 q-109 -137 -201 -313l-111 -215q-18 -41 -45 -41q-2 0 -3 1l-3 1q-18 12 -6 45q12 25 14 31l68 127q156 307 307 692q23 61 23 90q0 18 -25 19q-55 0 -149 -54q-104 -59 -181 -145q-70 -156 -145 -299l-238 -491q-4 -12 -22 -23q-4 -4 -25 -4q-16 0 -22 6q-18 12 2 33 q166 292 448 872q137 281 137 416q0 39 -16 66q-31 49 -156 55q-13 1 -26 1q-197 0 -371 -177q-80 -80 -80 -154q0 -18 6 -37q23 -41 80 -41q29 0 60 13q14 0 16 -13q0 -10 -10 -16q-76 -29 -125 -29q-66 0 -90 45q-10 18 -10 45z" />
+<glyph unicode="N" horiz-adv-x="796" d="M43 926q0 76 72 137q152 135 309 135q100 0 154 -65q29 -47 28 -113q0 -154 -196 -522q166 213 475 569q25 31 67 66q26 19 49 18q8 0 17 -2q14 -4 22 -25q14 -31 14 -79q0 -44 -12 -101q-39 -162 -151 -409q-129 -283 -176 -410q-39 -121 -39 -209q0 -147 96 -209 q10 -6 4 -29q-11 -17 -22 -17q-5 0 -11 3q-43 0 -86 86q-33 66 -32 158q0 52 12 110q35 160 174 459t174 461q10 42 10 71q0 43 -22 56q-12 4 -25 -8q-74 -66 -176 -183q-147 -170 -360 -442q-2 -2 -18.5 -23.5t-41.5 -58.5q-72 -104 -106 -160q-80 -127 -113 -194 q-14 -33 -38.5 -31t-14.5 29l8 24l340 619q131 248 131 364q0 61 -33 107q-51 41 -114 41q-113 0 -246 -123q-45 -43 -45 -86q0 -29 24.5 -47.5t57.5 -18.5q20 0 28 5l38 19t48 26q12 6 19 -9q2 -8 -6 -14q-31 -31 -94 -61q-37 -18 -78 -19q-51 0 -82 29q-33 31 -33 76z" />
+<glyph unicode="O" horiz-adv-x="649" d="M49 109q0 82 49 192q182 414 502 655q-4 12 -4 19q0 72 76 129q88 64 170 63h8q102 -4 139 -61q18 -27 29 -72q51 39 104 94q8 8 17 9q10 -2 10 -10q0 -3 -2 -7q-18 -37 -68 -73l-57 -46q1 -16 1 -32q0 -89 -42 -193q-98 -236 -223 -407q-188 -262 -488 -385 q-57 -25 -108 -25q-70 0 -90 47q-23 52 -23 103zM117 117q0 -57 24.5 -75.5t61.5 -18.5q39 0 90 22q262 113 426 348q197 283 246 545q0 2 1 9t1 14q-90 -66 -174 -72q-27 -2 -51 -3q-92 0 -126 40q-104 -84 -233 -244q-100 -121 -197 -309q-69 -133 -69 -256zM666 1001 q92 63 217 115q-14 4 -47 8q-9 1 -18 1q-49 0 -91 -29q-57 -42 -61 -95zM674 971q25 -43 119 -43q52 0 98 24q18 10 74 45q-2 43 -17 74q-8 20 -37 35q-114 -47 -237 -135z" />
+<glyph unicode="P" horiz-adv-x="872" d="M8 -27q-15 26 -15 64.5t15 89.5q4 16 19 8q6 -2 10 -16q0 -9 -1 -18q0 -58 15 -70q4 -4 25 12q74 66 127 150l135 225q-20 35 -20 80q0 19 4 41q6 47 47 88q37 37 81 37h7t8 -1t6 -1l145 274l113 211q-92 -16 -223 -82q-121 -61 -168 -127q-23 -32 -23 -50q0 -6 2 -9 q0 -6 -8 -11q-6 -2 -8 2q-4 11 -4 24q0 24 16 56q37 72 164 142q172 94 291 116q63 94 102 109q4 2 8 1q10 0 13 -9q2 -12 -12 -21q-33 -23 -68 -76q11 1 22 1q43 0 80 -11q106 -31 146 -147q16 -53 16 -105q0 -102 -53 -198q-78 -139 -176 -244q-166 -172 -350 -172 q-82 0 -134 51l-94 -160q-59 -100 -90 -139q-51 -76 -106 -119q-18 -12 -37 -12q-15 0 -27 16zM365 526q0 -23 8 -49l78 144q-35 0 -60 -31q-26 -33 -26 -64zM395 440q37 -43 127 -49h11q108 0 245 117q147 127 219 287q29 63 29 134.5t-33 125.5q-45 72 -116 90 q-31 9 -72 9q-12 0 -25 -1q0 -2 -3 -5t-6 -9t-5 -13q-106 -227 -256 -485q35 -23 53 -74q6 -12 -6 -22q-12 -8 -25 10q-4 6 -20 24.5l-23 26.5z" />
+<glyph unicode="Q" horiz-adv-x="808" d="M39 -6q-1 5 -1 11q0 27 25 65q70 84 183 84q83 0 153 -62q168 98 340 293q80 88 146 215q61 125 86 219q25 104 24 154q0 78 -39 119q-39 39 -102 38q-57 0 -111 -22q-213 -82 -325 -207q-137 -152 -158 -280q-6 -43 -6 -76q0 -111 80 -111q49 0 108 76l15 33q6 49 0 61 q0 2 -1 5l-1 3q0 16 14 16.5t16 -12.5q8 -23 9 -47q0 -13 -2 -26q-6 -39 -21 -54q-70 -94 -141 -94q-131 0 -131 172q0 168 176 363q127 139 360 223q53 20 115 21q133 0 164 -93q18 -52 18 -116q0 -150 -92 -347q-74 -156 -168 -258q-168 -184 -348 -294q27 -31 45 -80 q8 -28 8 -55.5t-8 -55.5q80 61 227 164q94 63 170 125q10 8 21 2q12 -8 0 -21q-125 -106 -166 -129q-25 -15 -264 -209q-31 -117 -103 -223q-76 -109 -176 -168q-23 -8 -37 -7q-9 0 -14 3q-12 6 -12 25q0 23 14 53q125 205 277 340q13 52 12 89q0 22 -4 38q-14 47 -37 82 q-168 -94 -266 -94q-60 0 -72 49zM100 23q0 -10 13 -23q14 -14 26 -10q104 20 215 78q-27 31 -61 38q-25 8 -60 9q-121 0 -133 -92zM172 -535q74 51 131 125q35 45 80 162q-90 -94 -117 -129q-69 -88 -94 -158z" />
+<glyph unicode="R" horiz-adv-x="856" d="M51 51q14 68 23 133q0 10 14 15q16 0 16 -11q0 -2 -8 -59q-4 -49 -4 -53q0 -35 17 -45q16 0 18 2q57 35 149 174l152 244q31 49 43 71q-68 -14 -100 -14q-23 0 -37 8q-16 10 -15 27q4 29 41 53q66 45 140 45q23 0 32 -2l58 115q70 137 153 354q-143 -35 -307 -141 q-6 -3 -12 -13q2 -16 102 -20q14 0 14.5 -14.5t-16.5 -14.5q-32 -4 -58 -4q-61 0 -95 23q-14 10 -13 26q2 14 33 35q229 141 371 172l8 21q0 16 23 16q12 0 14 -4q0 -8 -2 -14l-4 -13q68 12 127 13q193 0 192 -129q0 -94 -137 -232q-53 -53 -197 -141q-125 -74 -174 -99 q25 -50 25 -98q0 -123 -82 -475q-43 -184 -43 -227q0 -78 43 -115q4 -4 25 -4q45 2 90 76q6 18 22 12q10 -12 6 -25q-12 -47 -55 -84q-45 -39 -92 -38q-27 0 -39 12q-63 49 -63 168q0 41 4 61q12 57 79 316q45 172 46 303q0 66 -15 98l-16 -8q-12 -3 -19 -6 q-98 -178 -252 -404q-80 -117 -163 -176q-9 -6 -19 -6q-18 0 -28 16q-15 35 -15 69v11zM383 563q1 -7 17 -7q29 0 100 22q2 4 7 12t7 12q-18 6 -33 4q-96 -16 -98 -43zM573 625q2 -2 7.5 -6.5t9.5 -8.5q76 35 143 76q314 193 314 350q0 97 -127 97q-53 0 -132 -15h-2 q-86 -255 -213 -493z" />
+<glyph unicode="S" horiz-adv-x="790" d="M-72 -29q8 6 31 24.5t37 31.5q63 51 67 53q-4 20 -3 38q0 45 20 83q41 80 143 104q42 9 93 9q37 0 77 -5l86 58q51 37 144 118l147 129q63 211 115 301q88 154 254 224q8 4 22 6q8 3 15 3q16 0 20 -15l4 -13q0 -2 1 -8t1 -8q0 -86 -198 -322l-181 -176q-15 -49 -30 -129 l-25 -184q-18 -121 -63 -187q-117 -174 -355 -192q-18 -1 -34 -1q-94 0 -152 42q-45 33 -84 88l-123 -88q-12 -8 -29 0q-7 4 -7 7.5t7 8.5zM117 117l223 149q-72 0 -80 -2q-133 -24 -143 -147zM123 72q25 -59 74 -95q45 -31 116 -30q76 0 131 22q123 45 193 140 q55 74 78 178l37 182v-1l8 89l-23 -20q-39 -31 -80 -70q-84 -76 -211 -170q2 0 10.5 -5t14.5 -7q22 -15 18 -25q-8 -23 -40 -10q-8 2 -27 5l-31 5zM850 680l119 117q52 61 110 153q57 90 58 119q0 6 -2 6q-63 -6 -134 -90q-92 -113 -143 -278z" />
+<glyph unicode="T" horiz-adv-x="702" d="M6 10q0 33 14 101q41 172 156 338l19 18q12 10 30 4q4 0 17 -22q4 -14 10 -30l6 -16q12 -27 29 -32q12 -6 26 -6q39 0 93 41q14 12 20 -5q6 -10 -4 -18q-78 -68 -137 -68q-18 0 -33 9q-51 29 -66 84q-72 -100 -102 -213q-20 -76 -21 -115q0 -41 17 -80q14 -14 37 -14 q65 0 159 98q92 94 181 256l151 272q88 145 97 156q61 88 116 133q63 53 109 80q-80 0 -148 18q-25 8 -47 16.5t-45 14.5q-61 16 -102 17q-70 0 -148 -46q-43 -27 -65 -90q-8 -23 10 -28q6 -2 21 -2q29 0 65 24l74 51q10 8 18 5q8 -8 -8 -25q-59 -55 -133 -96 q-33 -16 -55 -17q-47 0 -48 49q0 16 3 25q18 80 114 141q84 49 168 49q43 0 201 -40q68 -18 145 -19q169 0 357 86h5q19 0 19 -18q-6 -20 -22 -27q-145 -66 -275 -84q-4 -2 -10 -2q-88 -25 -186 -115q-104 -96 -205 -276l-168 -309q-213 -346 -383 -367q-6 -1 -12 -1 q-64 0 -64 95z" />
+<glyph unicode="U" horiz-adv-x="784" d="M66 51q0 166 217 508l98 148q14 25 53 84q133 193 199 358q12 27 2 49q-6 13 -32 13q-16 0 -40 -5q-39 -8 -69 -30q-109 -78 -121 -166q-6 -12 -15 -21q-12 -6 -16 8q3 104 147 209q76 53 132 54q63 0 63 -62q0 -45 -94 -221q-51 -96 -170 -275q-129 -193 -172 -274 q-86 -156 -107 -278q-6 -43 -6 -68q0 -76 51 -84q4 -1 8 -1q35 0 89 46q230 194 467 528l378 580l16 21q15 22 25 38q25 41 41 29q5 -2 6 -9q0 -3 -2 -9q0 -12 -10 -23l-483 -790q-45 -84 -82 -211q-35 -123 -35 -207q0 -29 2 -41q0 -41 -27 -41h-4q-14 0 -20 20 q-4 14 -4 45q0 238 184 539q-217 -307 -430 -500q-84 -76 -168 -75q-71 -1 -71 114z" />
+<glyph unicode="V" horiz-adv-x="538" d="M-266 903q-4 10 -5 24q0 16 7 36q12 53 86 108q172 127 342 127q137 0 176 -113q15 -45 15 -115q0 -53 -9 -118q-25 -184 -119 -463q-63 -193 -92 -262l248 395q68 109 279 412q158 207 317 244q9 2 17 -4t8 -17q0 -5 -9 -14q-10 -10 -22 -15q-164 -55 -279 -208 q-182 -250 -270 -398l-358 -588q-8 -22 -23 -22q-6 0 -12 4q-14 6 -11 21l154 454l70 227q39 129 53 228q11 74 11 128t-11 89q-31 98 -135 100h-7q-72 0 -192 -55q-158 -72 -182 -164l-2 -16q12 -35 59 -35q14 0 27 6q10 6 18 -2q4 -10 -12 -16q-35 -14 -66 -15 q-55 0 -71 37z" />
+<glyph unicode="W" horiz-adv-x="1105" d="M-23 844q0 37 21 71q100 166 272 275q176 111 342 110q65 0 123 -18q84 -29 84 -166q0 -190 -125 -469l-221 -440q39 55 242 291q150 174 225 305l14 22q12 22 31 13q12 -2 6 -21l-24 -78q-100 -326 -101 -618q0 -14 1 -42t1 -42q100 285 203 506q170 365 229 467 q147 254 330 409q9 7 14 8q5 0 9 -6q5 -4 5 -8q0 -7 -9 -14q-168 -156 -312 -406q-88 -154 -223 -456l-137 -308q-72 -166 -107 -307l-4 -16q-8 -21 -22 -21h-4q-23 0 -17 19q-16 137 -16 252q0 254 74 489l-273 -328q-152 -195 -241 -354l-7 -12q-6 -23 -30 -14 q-16 4 -8 24l18 41l305 635q113 233 113 446q0 115 -49 152q-45 25 -107 25q-141 0 -311 -103q-172 -102 -260 -244q-20 -29 -21 -65q0 -33 23 -55q84 -78 219 -78q182 0 385 123q0 4 8 0l-2 -9q-218 -135 -412 -135q-135 0 -221 74q-33 27 -33 76zM637 838z" />
+<glyph unicode="X" horiz-adv-x="1134" d="M31 82q0 27 8 49q27 84 94 158q72 82 160 100l4 -1q4 -1 8 -1q0 -20 -8 -22q-156 -61 -217 -236q-3 -12 -3 -22q0 -38 34 -60q20 -12 55 -12q51 0 108 24q285 123 486 473q94 162 94 324q0 51 -12 88q-37 109 -123 109q-174 0 -275 -68q-12 0 -14 2q-14 8 0 21 q139 104 285 104q59 0 94 -20q106 -63 106 -226q0 -20 -4 -65q156 274 414 360q51 18 100 19q70 0 109 -39q20 -20 20 -54q0 -68 -65 -114q-6 -6 -10 -6q-8 -2 -11 2q-14 10 -2 22q35 39 35 78q0 23 -16 35q-31 23 -82 22q-96 0 -221 -88q-115 -84 -181 -184 q-72 -113 -114 -252q-45 -147 -45 -252q0 -31 8 -76q35 -166 82 -243q70 -111 205 -140q14 0 18 -10q4 -6 0 -16q-2 -8 -14 -17q-10 -7 -14 -6h-3q-163 25 -258 209q-82 158 -82 307q0 41 17 140q-117 -188 -283 -340q-213 -188 -385 -189q-102 0 -102 113z" />
+<glyph unicode="Y" horiz-adv-x="669" d="M123 -465q53 115 188 272q37 45 109 111l72 166l83 188q-184 -283 -387 -309q-100 0 -100 109q0 82 49 192q25 59 109 219q76 145 102 219q66 180 66 261q0 70 -37 96q-29 22 -67 22q-25 0 -54 -10q-25 -8 -117 -55q-76 -57 -76 -86q0 -6 3 -10q2 -8 20 -13q20 0 31 8 q6 2 8 0q4 -4 4 -6q0 -8 -8 -8q-12 -10 -39 -10q-41 0 -41 29q0 72 158 163q70 41 131 41q45 0 78 -20q47 -28 47 -126v-13q-4 -82 -74 -267q-14 -41 -139 -299q-82 -172 -99 -274q-1 -8 -1 -15q0 -29 16 -53q18 -28 47 -27q6 0 12 1q190 25 350 282q27 45 148 279 q66 125 121 274q6 18 24 19q22 0 22 -16q0 -6 -3 -15q-2 -6 -9.5 -19.5t-15.5 -33.5q-6 -16 -23 -58l-348 -782q127 86 240 199l4 2q2 0 2 -1q2 -1 4 -3q6 -2 0 -8q-16 -18 -141 -134q-111 -102 -139 -120l-119 -250q-129 -266 -148 -299q-78 -150 -166 -262 q-13 -22 -28 -22q-3 0 -6 1q-13 3 -13 21q0 76 38 182.5t112 267.5zM27 -838q68 96 145 242l125 254l82 168q-49 -43 -92 -109q-53 -82 -137 -235l-74 -160q-37 -86 -49 -160z" />
+<glyph unicode="Z" horiz-adv-x="628" d="M37 70q41 37 76 36h18q129 121 426 435q35 35 213 247q123 143 223 230q-61 -12 -94 -12q-55 0 -157.5 18t-135.5 18q-43 0 -151 -45q-4 -2 -13 -2q-18 0 -18 15q0 16 25 28q2 0 153 95q8 4 16 4q23 0 23 -17q0 -4 -6 -10q-2 -2 -10.5 -7t-12.5 -9h13q31 0 131 -23 q90 -20 151 -20q55 0 103 12l90 24q31 6 30 -16q0 -12 -18 -24q-141 -94 -278 -248l-250 -287l-283 -297l-104 -117q74 -23 155 -112q92 -104 123 -125q145 -94 326 -94q29 0 66.5 1t45.5 1h35q16 -4 17 -17q0 -18 -23 -20l-29 -2l-120 -11q-180 0 -344 101q-12 6 -136 123 q-86 80 -176 92q-53 -51 -86 -53q-13 -1 -23 -2q-39 0 -39 21q0 25 48 69z" />
+<glyph unicode="[" horiz-adv-x="618" d="M72 -250q51 178 151 430q16 43 135 332l140 334l69 174q80 195 111 194h76q20 0 44.5 1.5t30.5 1.5q18 0 19 -17q0 -18 -14 -18q-49 -6 -148 -6q-14 0 -41 -72l-18.5 -46t-20.5 -54l-71 -179l-140 -329l-127 -332q-37 -92 -135 -395h21q8 -2 22 -2h25q2 0 10 1t12 1h51 q20 0 20.5 -20.5t-20.5 -20.5h-51q-4 0 -12 -1t-10 -1h-25h-84q-14 0 -18 4q-6 6 -2 20z" />
+<glyph unicode="\" horiz-adv-x="813" d="M338 1151q0 23 24 23q16 0 23 -17l80 -223l254 -719l106 -299q0 -2 1 -5t1 -5q0 -27 -30 -27q-18 0 -25 19l-108 297l-248 720l-76 228l-1 4z" />
+<glyph unicode="]" horiz-adv-x="618" d="M-141 -256q0 20 16 20q33 4 145 5q16 0 43 73l37 99q10 27 18.5 45t23 53l32.5 80l137 330l127 331q47 121 137 396h-22q-8 2 -23 2h-24h-23h-51q-20 0 -20 20.5t20 20.5h51h23h24h84q16 0 21 -5q6 -6 2 -20q-46 -157 -154 -430q-43 -113 -133 -332l-141 -332l-70 -176 q-80 -195 -106 -194q-8 0 -35 -1t-45 -1h-76q-18 0 -18 16z" />
+<glyph unicode="^" horiz-adv-x="593" d="M383 1024q0 12 12 18q20 10 140 86q72 45 104 46q12 0 59 -56l54 -65q8 -8 8 -23q0 -29 -21 -29q-6 0 -14 5l-47 49q-37 41 -49 41q-37 0 -226 -88q-20 -7 -20 16z" />
+<glyph unicode="_" horiz-adv-x="813" d="M-109 -289q0 20 21 21q156 2 246 2q115 -6 266 2q94 4 168 4q347 -6 319 -6q25 0 25 -27q0 -28 -25 -24q-115 0 -319 4q-66 -4 -432 -4q-206 6 -246 6q-23 -1 -23 22z" />
+<glyph unicode="`" horiz-adv-x="325" d="M281 1128q0 35 43 35q12 0 18 -10q45 -88 147 -260q8 -10 0 -19q-6 -8 -16 0q-127 150 -190 246q-2 2 -2 8z" />
+<glyph unicode="a" horiz-adv-x="692" d="M35 78q40 89 147 160q154 100 273 112q6 4 10 -8q0 -8 -10 -8q-166 -51 -250 -113q-25 -16 -90 -78q-34 -45 -34 -70q0 -20 21 -24q13 -2 27 -2l96 25q143 72 199 108q98 63 188 178q9 13 17 13q4 0 8 -4q12 -16 0 -29l-23.5 -24.5l-35.5 -39.5q-29 -39 -35 -53 q-49 -80 -49 -139v-19q3 -28 43 -36q10 -3 20 -3q25 0 55 15q78 51 146 119q4 4 6 2q4 -2 4 -6q0 -2 -2 -4q-70 -78 -131 -123q-45 -33 -100 -33h-21q-45 6 -61 49q-8 23 -9 45q0 39 33 98q-40 -34 -135 -98q-59 -37 -158 -82q-53 -20 -92 -20q-33 0 -49 16q-17 19 -17 41 q0 17 9 35z" />
+<glyph unicode="b" horiz-adv-x="438" d="M31 88q27 72 100 164l127 154l301 411l213 291q213 289 361 410q32 25 56 25q11 0 21 -5q19 -9 19 -32q0 -8 -2 -17q-18 -106 -88 -221q-33 -51 -142 -201q-96 -127 -329 -340q-178 -141 -326 -270h8q55 -25 56 -133q0 -47 -9 -88q-6 -41 -26 -82q4 -2 10 -3t10 -1 q15 -3 43 0q53 4 105 38l20 11q6 4 12 -2q3 -6 0 -12.5t-18 -18.5q-57 -39 -115 -45q-28 -3 -49 0q-18 2 -33 10q-43 -74 -116 -123q-72 -47 -138 -51q-18 0 -43 12q-10 4 -22 23q-14 25 -14 53q0 21 8 43zM84 88q-4 -13 -4 -26q0 -25 16 -42q6 -6 19 -6q10 0 24 4 q123 31 187 129q-90 61 -90 158v17q-127 -152 -152 -234zM272 305q0 -80 68 -133q16 31 27 76q5 23 4.5 49t-4.5 53q-8 57 -25 64q-18 6 -35 -13q-35 -39 -35 -96zM412 553q129 100 241 207l181 172q92 96 151 180q109 154 123 178q57 92 70 166q0 12 -13 12q-14 0 -22 -8 q-152 -115 -346 -368q-113 -150 -207 -293z" />
+<glyph unicode="c" horiz-adv-x="577" d="M20 80q8 82 109 162q184 147 301 147q14 0 43 -4q33 -6 33 -23q18 16 26 17q16 0 7 -17q-2 -2 -5 -4q-14 -12 -22 -22l-55 -68q-27 -33 -45 -32l-4 2q-6 12 28 47q22 28 25 49q4 27 -23 26q-68 0 -129 -36q-168 -96 -219 -218q-4 -12 -4 -20q0 -63 90 -70q24 -2 48 -2 q127 0 257 54q88 37 99 41q41 18 79 51q6 3 13 0q5 -2 5 -5q0 -2 -3 -5q-51 -43 -168 -103q-55 -29 -164 -53q-96 -21 -170 -21h-18q-59 4 -95 27q-40 25 -39 68q-1 6 0 12z" />
+<glyph unicode="d" horiz-adv-x="507" d="M-27 1061q0 46 19 104q51 154 194 285q147 135 328 172q35 8 78 8q180 0 260 -127q35 -100 35 -215q0 -57 -10 -129l-7.5 -45t-7.5 -51q117 49 295 149q10 8 17 -4q4 -5 3 -8q0 -5 -8 -10q-178 -102 -311 -160q-72 -346 -311 -682q2 0 4 2q14 -2 80 -16q27 -4 20 -25 q-4 -27 -26 -20q-43 10 -109 14q-92 -135 -151 -194q-94 -94 -205 -125q-25 -6 -47 -7q-84 0 -103 64q-4 12 -4 39q0 52 37 98q147 178 401 178q39 0 58 -2l168 289q59 156 125 369l-166 -60q-242 -47 -348 -47q-154 0 -265 62l-30 34l-4 9q-9 16 -9 51zM39 1087l8 -49 l23 -24q117 -70 260 -70q77 0 288 37l185 66q29 131 28.5 239.5t-22.5 192.5q-74 117 -225 116q-121 0 -234 -69q-270 -167 -311 -439zM53 66q0 -29 23 -37q27 -10 49 -11q104 0 229 140q53 57 115 147q-250 0 -381 -155q-35 -41 -35 -84z" />
+<glyph unicode="e" horiz-adv-x="522" d="M37 158q61 92 201 166q125 65 213 65q14 0 28 -2q2 -2 7.5 -5t7.5 -5q4 -4 0 -10l-5 -13l-12 -18q-6 -4 -33 -27q-137 -70 -344 -147q-14 -12 -28 -58q9 -65 129 -73q6 -1 13 -1q31 0 101 11q68 10 113 27q92 37 158 96q6 6 16 0q5 -2 5 -5q0 -2 -3 -5q-55 -57 -153 -109 q-37 -18 -117 -37q-84 -20 -146 -20q-172 0 -172 107q0 32 21 63zM131 201q150 57 287 125q29 23 28 24q0 3 -11 4q-7 0 -23 -2q-172 -42 -281 -151z" />
+<glyph unicode="f" horiz-adv-x="368" d="M-424 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137 q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM-362 -850q4 0 8 2q242 188 383 463 q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM63 186.5q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM104 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110z" />
+<glyph unicode="g" d="M-702 -1759q-2 17 -2 35q0 71 28 149q138 390 363 744q287 453 669 763l93 230q-180 -137 -359 -137q-33 0 -55 14q-33 20 -33 45q0 61 82 119q178 127 545 217q6 0 10 -6q0 -12 -6 -13q-340 -92 -506 -208q-23 -14 -37 -46q-12 -29 -10 -43q6 -29 49 -28q205 8 377 211 q8 8 12 14q12 12 17 12q2 0 4 -1t4 -1q25 -18 0 -51q-2 -4 -5 -7t-11.5 -12.5l-20.5 -23.5l-86 -231q61 23 106 53q115 74 168 119q6 6 8 2q3 -1 3 -4t-5 -6q-100 -90 -151 -123q-16 -10 -158 -111q-203 -481 -475 -950l-219 -389q-139 -221 -275 -342q-39 -35 -73.5 -35 t-50.5 41zM-651 -1675q0 -37 30 -37q18 0 46 16q254 266 489 711q74 143 408 848l-205 -193q-123 -121 -205 -233q-489 -668 -561 -1094q0 -4 -1 -10t-1 -8z" />
+<glyph unicode="h" horiz-adv-x="610" d="M-35 16l10 25q16 27 58 76l100 164q68 104 225 315l205 283l301 430q76 100 156 172q4 4 12 4q23 0 19 -27q-2 -16 -21 -45q-80 -123 -174 -239l-209 -267l-260 -340q-126 -169 -240 -338q125 109 248 174q22 13 39 13q12 0 23 -6q10 -4 22 -35q0 -2 1 -8.5t1 -10.5 q0 -33 -26.5 -114.5t-26.5 -120.5q0 -55 43 -78q11 -5 24 -5q17 0 40 9q70 27 157 103q6 3 13 0q8 -2 2 -11q-98 -88 -152 -125q-52 -33 -84 -33q-3 0 -6 1q-46 3 -74.5 36.5t-28.5 90.5q0 37 27 120q31 94 31 119q0 18 -12 19q-233 -135 -355 -281q-33 -49 -49 -76l-10 -10 q-10 -10 -23 -2q-8 6 -8 11q0 3 2 7z" />
+<glyph unicode="i" horiz-adv-x="315" d="M27 55q0 53 47 117q35 53 86 119q8 12 53 67l10 13q10 12 21 20q20 20 37 -12q4 -10 -13 -29q-2 -2 -9 -11l-13 -17q-119 -141 -158 -226q-4 -6 -4 -24q0 -51 53 -52q43 0 66 15q88 49 155 106q6 3 13 0q6 -2 0 -8q-98 -92 -148 -123q-50 -33 -94 -33h-8q-43 2 -70 23 q-24 18 -24 55zM324 508q8 14 26 39l17 14q8 8 12 10q2 3 4.5 3t5.5 -3q8 -8 10 -32q0 -16 -12 -47q-20 -23 -35 -23h-4q-27 5 -26 27q0 5 2 12z" />
+<glyph unicode="j" horiz-adv-x="380" d="M-1001 -1372q0 168 145 409q172 287 403 474q39 35 140 114l159 119q72 53 148 102l176 267l109 184q-51 -35 -273 -217q-10 -12 -16 4q0 12 4 16l264 222q57 45 76 55l20 14q23 16 35 -12q6 -14 -2 -27q-2 -2 -10 -12l-15 -18q-63 -76 -180 -261q-63 -102 -106 -161 l225 139q84 47 156 111q6 3 12 0q10 -2 2 -11q-100 -94 -149 -125l-299 -192q-2 -2 -6.5 -9.5t-12.5 -17.5t-16 -22l-273 -406q-88 -137 -311 -454l-166 -218q-123 -139 -190 -139q-49 0 -49 72zM-938 -1307q0 -23 10 -26q5 -2 11 -2q38 0 112 73q66 66 172 199 q123 152 314 451q74 117 256 374q-8 -6 -21.5 -15t-32.5 -23l-176 -127l-147 -123q-221 -180 -387 -461q-35 -57 -74 -166q-37 -109 -37 -154zM416 520l28 39l15 14q6 6 14 11q2 3 3.5 3t4.5 -3q8 -8 11 -33q0 -23 -11 -47q-20 -23 -37 -23h-4q-27 5 -26 27q0 5 2 12z" />
+<glyph unicode="k" horiz-adv-x="598" d="M-86 -18l4 8l4 8l252 319l143 187q125 158 254 338q170 240 312 299l12 2q5 2 9 2q8 0 9 -8l11 -9l1 -4q1 -4 1 -8v-8l-1 -4q-1 -4 -1 -6l-4 -4q-27 -72 -191 -248l-223 -238q-156 -160 -221 -213q-10 -14 -21 -27l-10 -14v-2l-2 -2q-4 -4 -15.5 -18.5l-19.5 -24.5 q-2 -2 -4 -5l-6 -9l94 65l111 72q53 31 118 41q35 0 37 -8q6 -14 -16 -47q-2 -2 -29 -27q-33 -29 -82 -49q-77 -34 -147 -37q-2 0 -23 -16q-19 -40 -18 -78v-10q2 -51 33 -90q61 -78 114 -78q78 0 103 12q76 37 155 107q6 3 13 0q8 -2 0 -11q-102 -94 -150 -125 q-51 -33 -108 -32q-109 0 -181 120q-29 49 -28 99q0 31 10 57q-76 -55 -117 -96l-151 -191q-9 -11 -16 -11q-4 0 -9 5q-6 11 -6 17zM338 477q63 53 244 246q168 180 237 270q34 43 43 62l10 18v2l-8 10l-24 -12q-84 -41 -219 -231zM340 350q78 12 137 47q18 10 39 35 q-67 -12 -176 -82z" />
+<glyph unicode="l" horiz-adv-x="266" d="M27 51q-1 11 -2 24q0 114 104 287q70 123 258 424q190 270 426 476q11 9 21 9q7 0 14 -5q10 -6 10 -31q-2 -100 -156 -299q-88 -117 -370 -389l-96 -94l-76 -121q-76 -152 -88 -228q-2 -12 -2 -22q0 -57 55 -57q43 0 65 14q88 51 158 111q6 3 12 0q8 -2 2 -11 q-98 -88 -151 -125q-51 -33 -102 -32q-76 -1 -82 69zM276 524l39 39l191 189q106 109 176 200q78 100 84 113q41 66 51 125q0 9 -4 9q-5 0 -16 -11q-156 -119 -365 -420q-84 -123 -156 -244z" />
+<glyph unicode="m" horiz-adv-x="911" d="M-37 88q-1 2 -1 5q0 6 5 9l150 129q104 86 139 92.5t49 -30.5q4 -18 -16 -53q-6 -14 -41 -60l90 76q57 45 137 78q27 10 45 10q33 0 35 -27q2 -12 -12 -38l-94 -138l126 109q80 66 160 100q18 6 43 10q3 0 6 1q31 0 37 -27q2 -14 -16 -39q-2 -4 -86 -117 q-55 -67 -56 -110q0 -34 39 -43q12 -3 24 -3l56 17q106 63 166 115q4 4 13 0q3 -2 3 -5t-3 -6q-115 -106 -156 -129q-59 -37 -103 -37q-8 0 -28 5q-53 10 -66 49q-4 14 -4 28q0 40 33 86q23 31 40 56.5t30.5 44l23.5 32t14 18.5l5 5q0 10 -21 4q-72 -23 -184 -112 q-111 -90 -146 -150q-23 -39 -41 -39q-12 0 -12 23q0 15 74 129q72 113 72 129q0 10 -19 4q-115 -35 -223 -139l-156 -152q-8 -8 -26 -21q-12 -7 -21 -7q-13 0 -18 18q-6 14 6 26l12 15q59 59 127 145q66 84 66 98q-2 8 -11 9q-20 0 -102 -70l-150 -129q-8 -8 -14 6z" />
+<glyph unicode="n" horiz-adv-x="704" d="M39 -39q0 16 8 25l12 14q78 78 140 152q76 90 75 104q-2 8 -10 8q-18 0 -76 -49l-120 -102q-12 -12 -17 4q0 12 4 16l123 103q78 63 113 69q7 1 13 1q32 0 42 -25q0 -6 -16 -45q-20 -43 -62 -89q154 108 307 172q16 8 43 9q37 0 39 -21q2 -12 -16 -37q-16 -23 -84 -104 q-51 -54 -51 -97q0 -29 47 -42q13 -3 25 -4q27 0 53 16q88 51 157 111q6 3 13 0q4 -1 4 -4t-4 -7q-102 -94 -150 -125q-51 -33 -98 -32q-84 0 -100 57q-4 16 -5 31q0 39 29 77q86 111 86 115q0 12 -18 6q-123 -39 -264 -145l-181 -150l-24 -16q-12 -6 -24.5 -6t-12.5 10z " />
+<glyph unicode="o" horiz-adv-x="528" d="M18 25q-3 14 -2 27q0 17 4 32q29 86 142 178q84 70 188 96q20 14 49 15q77 0 99 -62q4 -16 4 -43q0 -59 -66 -143h41q51 4 111 45q0 2 20 12q8 6 13 -2q2 -3 1.5 -6t-1.5 -6q-4 -6 -21 -21q-66 -45 -119 -51q-14 0 -25.5 -1t-17.5 -2l-6 -1q-4 0 -10 1t-9 2t-5 1 q-141 -133 -281 -133q-39 0 -78 17q-25 12 -31 45zM67 69q0 -14 11 -30q12 -16 39 -21h33q63 0 122 33q16 8 95 66q-74 35 -74 127q0 33 18 69q-57 -23 -116 -65q-49 -35 -95 -94q-33 -47 -33 -85zM336 246q0 -76 59 -105q74 86 74 129q0 20 -12 39q-23 31 -58 31 q-63 0 -63 -94z" />
+<glyph unicode="p" horiz-adv-x="552" d="M-666 -1311l2 2l2 15q57 125 164 336l168 333l256 514q166 338 238 521q0 4 14 10q2 1 5 1q4 0 12 -5q-39 -137 -86 -246q137 166 352 240q20 8 51 4q23 -2 33 -23q8 -12 -6 -55q-25 -66 -119 -162q-111 -111 -207 -156q23 -16 49 -16q141 0 203 37q102 61 168 119l4 2 q5 -2 5 -5q0 -2 -3 -5q-98 -90 -152 -123q-93 -58 -225 -58h-24q-61 4 -103 21q-60 -22 -96 -22q-14 0 -27 3l-172 -364q-35 -68 -123 -254l-335 -658l-3 2l-8 -20q-4 -12 -14 -12q-4 0 -10 2q-17 6 -13 22zM51 53q18 5 38 5q32 0 71 -13q55 12 108 51q226 162 226 262 q0 6 -9 9q-14 0 -20 -2q-234 -81 -414 -312z" />
+<glyph unicode="q" horiz-adv-x="659" d="M-162 -1061q0 2 1 6l1 4q47 106 137 271q113 213 138 264l172 330q4 29 4 59q0 20 22 39l33 16q27 41 53 88q45 90 97 156q-78 -55 -144 -90q-76 -41 -174 -76q-55 -20 -94 -20q-32 0 -53 14q-17 13 -18 33q0 18 14 47q59 98 178 168q166 98 301 110q7 -1 8 -8 q0 -10 -8 -10q-96 -29 -139 -45q-80 -33 -136 -70q-25 -14 -102 -78q-51 -46 -51 -85q0 -11 14 -11q78 0 133 25q129 59 221 112q121 74 220 181q13 15 25 15q7 0 11 -5q12 -18 -8 -37l-69 -63q-20 -20 -45 -56q-86 -129 -138 -221q-4 -8 -11 -19.5l-15 -25.5q145 66 180 86 q80 49 172 123q2 4 10 0q6 -4 6 -8q0 -3 -4 -8q-101 -95 -159 -130q-182 -109 -250 -141l-9 -4l-36 -57q-14 -135 -31 -234q-14 -74 -74 -248q-47 -137 -149 -288q-98 -147 -199 -148q-35 0 -35 39zM-88 -995q0 -8 6 -19q49 10 113 90q100 125 151 265q63 176 78 245 q2 12 7 54.5t9 70.5l-126 -248z" />
+<glyph unicode="r" horiz-adv-x="483" d="M63 154q0 8 3 12l137 137l96 96q14 17 27 18q10 0 18 -9q15 -18 -12 -50q-14 -16 -15 -41q0 -18 9 -45q10 -35 10 -47q0 -25 -12 -30q-41 -25 -80 -76t-45 -86q-2 -14 6 -22.5t26 -8.5q80 0 152 41q109 63 160 107q6 3 12 0q5 -2 5 -5q0 -2 -3 -6q-92 -86 -154 -123 q-98 -64 -177 -63h-7q-45 2 -63 18q-21 18 -21 46q0 9 2 20q18 84 139 194q-13 39 -13 72q0 15 3 29l-190 -182q-9 -8 -13 4z" />
+<glyph unicode="s" horiz-adv-x="503" d="M-23 84q0 12 5 16l262 213l88 78q10 29 34.5 51.5t55.5 22.5q20 0 27 -27q3 -25 -19 -37q-37 -20 -55 -32q-14 -25 -15 -64q0 -25 7 -80q8 -74 8 -75q0 -82 -37 -125q35 6 63 18q100 49 154 115q2 6 8 0q2 -5 3 -7q0 -3 -3 -6l-59 -59q-59 -57 -96 -72q-18 -8 -93 -24 q-43 -37 -108 -37h-10q-72 2 -72 53q0 45 70 45l2 -1q2 -1 8 -2t13 -3l20.5 -6t25.5 -8q45 25 60 104q0 18 -1 73.5t-1 90.5q6 35 8 49l-336 -270q-4 0 -8 2z" />
+<glyph unicode="t" horiz-adv-x="409" d="M-412 633q0 14 23 35q115 80 278 80q86 0 217 -25l216 -41q61 -4 135 -14q82 145 168 219l-7 -2q13 13 23 12q7 0 12 -6q16 -16 -4 -35q-68 -63 -147 -188l62 -2q49 0 100 4q76 2 268 84q20 10 26 -6q6 -7 6 -14t-8 -11q-16 -16 -24 -23q-150 -84 -342 -84q-53 0 -115 7 l-49 -76l-195 -318q-127 -203 -231 -292q-13 -11 -22 -12q-9 0 -17 9q-6 6 -6 15q0 15 25 37q104 92 223 268l190 305l41 66q-33 8 -53 8q-55 6 -256 49q-152 33 -246 33q-137 0 -221 -64q23 -4 66 -10l8 -8q0 -8 -6 -8q-37 -12 -86 -13q-52 1 -52 21z" />
+<glyph unicode="u" horiz-adv-x="550" d="M-10 51q8 47 90 154l96 121q25 31 43 18q4 -2 4 -8l-28 -37l-66 -76q-52 -68 -80 -135q-2 -4 -2 -12q0 -37 53 -37q76 2 181 106l174 195q6 8 18 8q23 0 23 -18q0 -6 -2 -8q-6 -10 -64 -74q-59 -70 -92 -139q-4 -12 -4 -25q0 -51 53 -51q39 0 66 14q94 53 153 103 q6 3 12 0q5 -2 5 -5q0 -2 -2 -6q-80 -74 -148 -116q-51 -33 -102 -33q-53 0 -72 22q-19 20 -19 49q0 26 17 58q-55 -55 -115 -92q-70 -41 -119 -45q-3 0 -6 -1q-31 0 -53 25q-16 18 -16 35z" />
+<glyph unicode="v" horiz-adv-x="505" d="M6 63q2 88 60 164q35 45 124 111q16 12 35 14q29 4 39 2q12 -4 12 -8q0 -6 -61 -37q-68 -35 -115 -94q-44 -55 -43 -127v-18q4 -35 33 -35q117 0 264 123q-30 21 -29 60q0 7 1 13q6 55 53 91q51 39 100 38q31 0 43 -26q6 -20 4 -31q-14 -51 -118 -137q27 -16 49 -16 q37 0 84 20q16 8 47 29q8 4 14 -2q2 -3 2 -6q0 -4 -6 -9q-4 -2 -11 -8t-20 -14q-71 -37 -110 -37q-43 0 -80 18q-197 -160 -309 -159q-31 0 -50 30q-12 24 -12 51zM371 231q0 -27 16 -47q111 98 111 133q0 16 -21 17q-31 0 -65 -25q-41 -31 -41 -78z" />
+<glyph unicode="w" horiz-adv-x="976" d="M33 63q39 98 278 287q31 25 47 0q6 -10 -8 -31q-35 -27 -45 -34l-119 -95q-70 -57 -102 -116q-12 -23 18 -29q27 -4 45 2q193 55 402 275q31 31 51 28q27 -6 8 -33q-31 -31 -47 -45q-96 -111 -96 -180q0 -18 2 -26q11 -31 62 -31h10q133 6 297 164q207 201 207 401 q0 86 -66 119q-39 20 -82 20q-66 0 -125 -45q-53 -37 -59 -106q0 -20 -13 -21q-8 0 -8 28q0 59 47 103q70 70 162 70q55 0 102 -27q84 -47 84 -166q0 -92 -53 -202q-55 -111 -166 -209q-195 -172 -329 -172q-27 0 -52 6q-51 16 -57 61q-3 16 -3 32q0 37 15 73 q-68 -57 -174 -115q-102 -55 -149 -61q-16 -2 -29 -3q-39 0 -53 19q-9 13 -10 28q1 13 8 31z" />
+<glyph unicode="x" horiz-adv-x="782" d="M59 153l2 9l142 114q102 80 133 94.5t125 37.5q7 1 14 0q32 0 51 -11q22 -12 19 -43q-3 -40 -25 -73q18 10 205 135q5 3 10 2l15 -6q0 -9 -7 -13q-147 -106 -235 -163q-37 -100 -37 -127q0 -10 4 -31q23 -59 111 -60q39 0 71 17q98 55 162 106q2 2 4 2q8 0 12.5 -2 t4.5 -4t-2 -4q-52 -49 -148 -123q-53 -33 -116.5 -33t-106.5 21q-53 23 -53 85q0 12 2 26q2 16 26 86l-305 -199q-16 -10 -28 2q-6 18 6 20q160 111 342 224l32 71q16 33 13 45q-12 23 -45 23q-39 0 -103 -31q-55 -27 -278 -203q-7 -6 -12 -4t-5 10z" />
+<glyph unicode="y" horiz-adv-x="524" d="M-557 -907q0 72 65 180q35 57 187 225q113 127 332 275l114 80l215 337q-164 -158 -284 -163q-29 0 -43 14q-16 16 -15 37q6 51 68 149q45 70 82 115q10 12 31 27q7 3 14 3l10 -1l4 -9q4 -12 -12 -38l-61 -88q-49 -76 -72 -136q-2 -8 0 -20q4 -12 16 -12q123 6 367 290 q6 8 16 9q12 0 12 -15q0 -2 -4 -10l-286 -453l227 148q111 70 170 121q6 6 8 2q2 -1 2 -3q0 -3 -6 -7q-23 -23 -151 -123q-104 -82 -295 -211q-143 -236 -242 -381q-188 -279 -336 -381q-47 -27 -70 -27q-63 0 -63 66zM-494 -866q0 -10 5 -27q2 -12 22 -12q23 0 35 10 q143 94 313 342q66 94 213 330q-10 -6 -16 -10.5l-16.5 -12.5t-26.5 -18q-205 -135 -311 -254q-84 -94 -156 -197q-62 -85 -62 -151z" />
+<glyph unicode="z" horiz-adv-x="565" d="M-596 -1567v12q0 100 49 265q65 209 172 368l119 181q72 106 133 176q139 156 313 323q-4 63 -14 109q-16 63 -123 63q-25 0 -37 -2q-43 -6 -45 4q-6 18 9 29l22 10l256 125q133 76 209 187q20 27 0 30q-7 2 -17 2q-49 0 -151 -39q-137 -53 -229 -133q-6 -4 -13 2 q-2 6 2 11q86 86 220 149q129 61 206 62q14 0 27 -5q8 -2 27 -20q14 -31 2 -55q-6 -18 -29 -41q-117 -131 -403 -266q100 -18 122 -119q0 -4 2.5 -14.5t4.5 -20.5t2 -21l372 340q12 8 21 0q2 -2 2 -4q0 -6 -8 -12l-387 -360q4 -274 -291 -746l-131 -219q-72 -117 -146 -213 l-104 -133q-65 -74 -117 -74q-47 0 -47 49zM-522 -1481q0 -33 16 -32q45 0 152 135q172 219 372 590q166 307 172 507q-195 -195 -286 -303q-45 -53 -236 -344q-123 -188 -186 -512q-4 -29 -4 -41z" />
+<glyph unicode="{" horiz-adv-x="651" d="M47 -35q0 127 94 275l52 77q29 51 28 101q0 41 -28 69q-18 8 -58 31q-12 12 -8 25q2 12 18 16q98 20 131 39q57 31 76 92q4 63 15 144q49 244 340 301q18 4 18 -10.5t-18 -16.5q-252 -49 -299 -283q0 -37 -15 -151q-33 -113 -190 -156q6 -2 12 -8q35 -39 35 -86 q0 -86 -78 -200.5t-78 -248.5q0 -143 117 -143q8 0 37 8q23 6 26 6q20 0 21 -20q0 -14 -14 -21q-47 -25 -76 -24q-158 0 -158 184z" />
+<glyph unicode="|" horiz-adv-x="813" d="M242 -88q0 4 4 12q6 12 26.5 50l57.5 108l84 156l350 677l127 242q6 12 20 12q25 0 25 -22q0 -8 -2 -12l-121 -244l-348 -680l-168 -313q-8 -14 -25 -15q-30 0 -30 29z" />
+<glyph unicode="}" horiz-adv-x="651" d="M-72 -207q0 14 17 17q252 49 299 282q0 20 16 152q33 113 189 155q-6 2 -13 9q-33 35 -33 86q0 86 78 200.5t78 247.5q0 143 -117 143q-8 0 -36 -8q-20 -6 -27 -6q-20 0 -21 21q0 14 13 20q47 25 78 25q156 0 155 -185q0 -129 -92 -274l-51 -78q-29 -51 -29 -100 q0 -41 29 -70q18 -8 57 -31q12 -12 8 -24q-2 -12 -20 -17q-94 -18 -129 -39q-57 -31 -76 -92q-2 -33 -16 -143q-49 -244 -338 -301q-19 -4 -19 10z" />
+<glyph unicode="~" horiz-adv-x="442" d="M313 1047q0 10 9 16q88 66 133 65q22 0 55.5 -24.5t73.5 -24.5q53 0 82 41q10 14 20 15q18 0 19 -21q0 -29 -45.5 -59.5t-75.5 -30.5q-43 0 -74 23q-34 25 -55 24q-41 0 -103 -45q-4 -4 -14 -4q-25 0 -25 25z" />
+<glyph unicode="&#xa2;" horiz-adv-x="677" d="M150 346q0 113 57 207q37 61 121 145q106 106 219 152l102 242h2v2l3 1q3 1 5 1q14 0 15 -19l-86 -215q37 12 67 12q55 0 62 -49q35 41 65 62q4 4 6 4q6 0 11 -10q4 -12 -2 -15q-41 -31 -88 -104q-16 -25 -39 -70q-6 -12 -21 -12q-23 0 -22 16l1 2q1 2 1 4l4 11 q8 16 29 47q4 16 4 33q0 25 -25 24q-39 0 -76 -12l-190 -522q135 25 299 194q6 6 14 6q12 0 12 -12q0 -8 -6 -14q-96 -98 -147 -140q-102 -80 -195 -94l-108 -303q0 -25 -25 -18q-4 0 -10 10q-2 2 -2 14q63 190 102 293h-12q-55 0 -102 37q-45 37 -45 90zM201 365 q0 -39 32 -64q34 -25 74 -25h25l192 512q-96 -39 -172 -114q-72 -72 -104 -127q-47 -82 -47 -182z" />
+<glyph unicode="&#xa3;" horiz-adv-x="1284" d="M18 43q4 27 54 41q39 12 86 12q31 0 75 -10q57 33 129 109q111 111 197 264l-82 2l-41 4q-27 0 -26 18q0 27 32 27q8 2 45 0h101l41 78l92 188q53 109 104 174q139 182 267 183q43 0 77 -21q27 -16 54 -61q25 -41 20 -82q-6 -88 -135 -230q-10 -10 -21 -10q-18 0 -18 16 q0 10 8 19q51 57 72 90q39 59 41 115q2 47 -49 90q-23 16 -54 16q-94 0 -217 -160q-49 -61 -114 -200q-72 -152 -105 -205h47h41h39h43q45 0 74 -4q12 -2 12 -21q4 -18 -10 -22q-6 -3 -74 -6q-53 -4 -86 -4l-10 1q-10 1 -32.5 2t-47.5 1h-26q-94 -158 -228 -293 q-55 -55 -102 -96q31 -16 139 -64q156 -53 299 -53q78 0 174 43q84 39 131 94q6 4 21 18q12 12 26 13q25 0 25 -23q0 -14 -10 -24l-21 -25q-49 -61 -149 -106q-106 -49 -201 -50q-113 0 -303 66q-74 37 -176 78q-83 -49 -172 -49q-58 0 -56 57zM76 43q0 -2 2 0q18 0 63 8 q-65 6 -65 -8z" />
+<glyph unicode="&#xa5;" horiz-adv-x="819" d="M-88 903q-10 27 0 60q12 51 88 108q172 127 342 127q137 0 176 -113q33 -90 33 -202q0 -23 -4 -56q-23 -160 -70 -323q72 92 199 223l209 215q178 197 350 236q18 2 25 -17q2 -8 -9 -18q-10 -12 -20 -15q-166 -53 -305 -204l-217 -226q-157 -166 -228 -258h164 q41 0 41 -24.5t-29 -30.5q-20 0 -81.5 -1t-102.5 -1h-27l-55 -107l7 2q7 1 14 1q23 0 81 1t93 1q39 0 39 -27q0 -25 -27 -31h-186q-4 0 -20.5 -1t-29.5 -1l-163 -313q-2 0 -4 2l-7 -21q-6 -16 -24 -10q-16 6 -12 23l2 2l2 14l151 303h-41h-84q-27 0 -53 1l-27 1 q-27 0 -26 23q0 25 24 26q16 0 71.5 1t94.5 1h23.5h18.5t13.5 1t9.5 1h3l53 107h-61h-84h-80q-27 0 -27 25q0 20 27 24q29 0 164 4h86q51 156 86 385q14 111 -25 242q-31 98 -135 100q-71 3 -197 -55q-158 -72 -182 -164l-2 -16q12 -35 59 -35q14 0 27 6q10 4 16 -2 q4 -10 -12 -16q-35 -14 -63 -15q-58 0 -72 37z" />
+<glyph unicode="&#xa9;" horiz-adv-x="1032" d="M135 389q0 125 107 287q111 172 276 285q186 129 379 129q172 0 279 -105q102 -102 102 -264q0 -133 -88 -301q-96 -186 -260 -309q-188 -143 -422 -144q-373 0 -373 422zM176 389q0 -381 332 -381q218 0 399 135q152 115 246 293q84 162 84 285q0 143 -92 235.5 t-248 92.5q-182 0 -358 -121q-154 -109 -263 -269q-100 -155 -100 -270zM365 285q0 51 22 125q80 256 361 448q63 45 122 45q23 0 43 -10q74 57 168 84q4 4 11 -4q0 -12 -5 -12q-49 -25 -147 -80q0 -3 -6 -7q23 -27 22 -59q0 -45 -32 -78q-47 -47 -86 -47q-16 0 -23 17 q-6 12 -2 28q16 78 72 131q-49 15 -111 -24q-158 -104 -262 -269q-102 -162 -102 -280q0 -49 26 -80q47 -51 113 -45q141 12 285 199q6 12 20 2q6 -6 0 -19q-147 -221 -303 -229q-86 -6 -137 39q-49 43 -49 125zM856 756q-4 -14 6 -17q33 14 51 43q18 33 -6 68 q-31 -31 -51 -94z" />
+<glyph unicode="&#xad;" d="M201 514q0 23 26 25q37 4 99 4q8 0 131 4h151q39 0 39 -24.5t-26 -30.5q-16 0 -71.5 -1.5t-92.5 -1.5h-131h-52h-47q-26 0 -26 25z" />
+<glyph unicode="&#xae;" horiz-adv-x="892" d="M279 682q0 123 137 262q150 160 321 160q100 0 168 -64q63 -61 64 -161q0 -135 -119 -281q-145 -174 -346 -174q-225 0 -225 258zM309 682q0 -227 195 -227q193 0 323 161q113 137 113 263q0 86 -55 141q-53 53 -148 53q-160 0 -301 -147q-127 -129 -127 -244zM453 625 q0 12 6 43q12 4 16 2q0 -6 -2 -14.5l-4 -16.5q-2 -16 4 -21h4q16 12 98 140q2 2 6.5 8t6.5 8q-14 0 -27 -2q-20 0 -20 14q0 6 14 21q29 18 55 14q10 18 21 35q33 68 47 113q-45 -14 -96 -45v-2l28 -7q8 0 8 -4q0 -6 -8 -8q-37 -6 -51 6q-14 0 -4 13q0 6 8 12q35 23 123 57 q2 2 2 6q0 6 10 7q8 0 7 -11l-3 -2q106 20 107 -39q0 -33 -45 -78q-18 -18 -66 -47q-14 -12 -55 -32q10 -16 6 -35q0 -31 -16.5 -92.5t-16.5 -77.5q0 -23 15 -37h6q12 0 29 22q0 4 12 5l2 -9q-12 -45 -51 -45q-10 0 -13 6q-29 20 -20 76q4 31 20 86q12 31 9 82l-2 12v-2 l-9 -4q-16 -27 -82 -131q-25 -35 -57 -59l-6 -2q-9 0 -12 6q-4 21 -4 29zM567 793h4q4 0 11.5 2t17.5 4q2 0 2 2v4h-6q-27 -4 -29 -12zM631 813q0 -2 2 -2q16 8 45 25q100 66 102 108q2 31 -28 33q-25 4 -54 -4v2l2 -2q-16 -49 -69 -160z" />
+<glyph unicode="&#xb4;" horiz-adv-x="325" d="M295 903q-6 10 6 21l211 211q8 4 14 4q16 0 28.5 -12.5t12.5 -28.5q0 -8 -6 -15q-100 -86 -250 -180q-12 -10 -16 0z" />
+<glyph unicode="&#x2000;" horiz-adv-x="815" />
+<glyph unicode="&#x2001;" horiz-adv-x="1630" />
+<glyph unicode="&#x2002;" horiz-adv-x="815" />
+<glyph unicode="&#x2003;" horiz-adv-x="1630" />
+<glyph unicode="&#x2004;" horiz-adv-x="542" />
+<glyph unicode="&#x2005;" horiz-adv-x="405" />
+<glyph unicode="&#x2006;" horiz-adv-x="270" />
+<glyph unicode="&#x2007;" horiz-adv-x="270" />
+<glyph unicode="&#x2008;" horiz-adv-x="202" />
+<glyph unicode="&#x2009;" horiz-adv-x="323" />
+<glyph unicode="&#x200a;" horiz-adv-x="90" />
+<glyph unicode="&#x2010;" d="M201 514q0 23 26 25q37 4 99 4q8 0 131 4h151q39 0 39 -24.5t-26 -30.5q-16 0 -71.5 -1.5t-92.5 -1.5h-131h-52h-47q-26 0 -26 25z" />
+<glyph unicode="&#x2011;" d="M201 514q0 23 26 25q37 4 99 4q8 0 131 4h151q39 0 39 -24.5t-26 -30.5q-16 0 -71.5 -1.5t-92.5 -1.5h-131h-52h-47q-26 0 -26 25z" />
+<glyph unicode="&#x2012;" d="M201 514q0 23 26 25q37 4 99 4q8 0 131 4h151q39 0 39 -24.5t-26 -30.5q-16 0 -71.5 -1.5t-92.5 -1.5h-131h-52h-47q-26 0 -26 25z" />
+<glyph unicode="&#x2013;" horiz-adv-x="696" d="M154 403.5q0 22.5 26 24.5q37 4 99 4q43 0 231 4q20 0 70.5 1t81.5 1q41 0 40 -26q0 -23 -28 -29q-16 0 -70.5 -1t-91.5 -1q-27 0 -104.5 -1t-128.5 -1h-52q-12 0 -27.5 1t-19.5 1q-26 0 -26 22.5z" />
+<glyph unicode="&#x2014;" horiz-adv-x="1163" d="M154 403.5q0 22.5 26 24.5q37 4 99 4q195 0 690 4q20 0 70.5 1t80.5 1q41 0 41 -26q0 -23 -28 -29q-16 0 -70.5 -1t-91.5 -1h-108.5t-250 -1t-333.5 -1h-52q-12 0 -27.5 1t-19.5 1q-26 0 -26 22.5z" />
+<glyph unicode="&#x2018;" horiz-adv-x="333" d="M262 868q0 96 168 252q6 6 12 4q8 -2 9 -8q0 -4 -5 -8l-61 -74q-45 -61 -59 -106q18 0 32 -27q16 -29 11 -57q-12 -53 -43 -53q-64 -1 -64 77z" />
+<glyph unicode="&#x2019;" horiz-adv-x="333" d="M270 780q0 4 4 8l62 74q45 61 59 107q-14 0 -33 28q-16 27 -10 56q12 53 43 53q63 0 64 -78q0 -96 -168 -252q-6 -6 -12 -4q-9 2 -9 8z" />
+<glyph unicode="&#x201c;" horiz-adv-x="491" d="M262 868q0 96 168 252q6 6 12 4q8 -2 9 -8q0 -4 -5 -8l-61 -74q-45 -61 -59 -106q18 0 32 -27q16 -29 11 -57q-12 -53 -43 -53q-64 -1 -64 77zM436 868q0 96 168 252q6 6 12 4q8 -2 9 -8q0 -4 -4 -8l-62 -74q-41 -57 -57 -106q16 0 30 -27q16 -29 11 -57q-12 -53 -43 -53 q-64 -1 -64 77z" />
+<glyph unicode="&#x201d;" horiz-adv-x="538" d="M270 780q0 4 4 8l62 74q45 61 59 107q-14 0 -33 28q-16 27 -10 56q12 53 43 53q63 0 64 -78q0 -96 -168 -252q-6 -6 -12 -4q-9 2 -9 8zM428 780q0 4 4 8l62 74q41 57 57 107q-14 0 -33 28q-14 23 -8 56q12 53 43 53q63 0 63 -78q0 -96 -167 -252q-6 -6 -13 -4q-8 2 -8 8z " />
+<glyph unicode="&#x2022;" horiz-adv-x="528" d="M168 367q20 90 119 163q70 68 170 95q14 4 43 4q74 0 98 -37q18 -12 23 -64q6 -88 -78 -168q-135 -125 -262 -124q-31 0 -68 14q-31 12 -43 51q-8 33 -2 66z" />
+<glyph unicode="&#x2026;" horiz-adv-x="845" d="M158 18q-6 27 14.5 57.5t50.5 39.5q10 2 15.5 -7.5t5.5 -31.5q0 -18 -22.5 -47t-37.5 -29q-26 0 -26 18zM451 18q-6 27 14 58q20 29 53 39q10 2 15.5 -7.5t5.5 -31.5q0 -16 -25 -47q-23 -29 -37 -29q-26 0 -26 18zM752 18q-6 27 14 57.5t51 39.5q10 2 15.5 -7.5 t5.5 -31.5q0 -18 -22.5 -47t-37.5 -29q-26 0 -26 18z" />
+<glyph unicode="&#x202f;" horiz-adv-x="323" />
+<glyph unicode="&#x205f;" horiz-adv-x="405" />
+<glyph unicode="&#x2122;" horiz-adv-x="894" d="M350 965q-2 8 10 20q59 41 142 41q16 0 219 -35q8 0 28.5 -3t34.5 -3q35 53 84 107l4 -7l-2 -2l-4 9q10 12 23 4q8 -14 -2 -23q-35 -35 -68 -88h72q33 0 131 41q10 10 20 -2q8 -8 -2 -18q-12 -12 -14 -13q-88 -49 -227 -41q-2 -4 -23 -37l-53.5 -86l-44.5 -71 q-61 -98 -115 -146q-23 -10 -28 -2q-12 12 10 31q63 53 123 150l102 165q-12 4 -20 5q-205 41 -244 40q-68 0 -113 -28q16 0 29 -2q3 -8 6 -8q0 -8 -8 -9q-12 -4 -41 -3.5t-29 14.5zM680 707q0 8 4 8q66 57 145 112q18 4 31 -20q0 -8 -8 -25q0 -2 -3 -5t-3 -5q41 35 94 62h8 q4 0 8.5 1t6.5 1q23 0 22 -17q0 -6 -8 -20q-18 -31 -27 -43q39 37 119 86q8 2 23 2q23 0 24 -15q0 -10 -8 -22l-43 -62q-27 -35 -27 -51q0 -14 17 -18q10 -4 37 6q10 6 82 57h10q2 -2 2 -8q-39 -39 -78 -67q-51 -20 -70 -19q-29 6 -34 31q-6 35 14 61l55 72q-2 2 -4 0 q-29 -6 -90 -55q-55 -43 -72 -72q-12 -23 -24 -23q-10 0 -11 15q0 6 37 65q35 55 35 62q-2 2 -4 0q-49 -14 -111 -70l-77 -76q-2 0 -6.5 -4t-6.5 -4q-8 -4 -10 -4q-14 0 -16 10q-4 10 4 19l6 6q96 96 94 119q-3 0 -123 -99q-6 -5 -14 9z" />
+<glyph unicode="&#xe000;" horiz-adv-x="420" d="M0 420h420v-420h-420v420z" />
+<glyph unicode="&#xfb01;" horiz-adv-x="684" d="M396 55q0 53 47 117q35 53 86 119q8 12 53 67l10 13q10 12 21 20q20 20 37 -12q4 -10 -13 -29q-2 -2 -9 -11l-13 -17q-119 -141 -158 -226q-4 -6 -4 -24q0 -51 53 -52q43 0 66 15q88 49 155 106q6 3 13 0q6 -2 0 -8q-98 -92 -148 -123q-50 -33 -94 -33h-8q-43 2 -70 23 q-24 18 -24 55zM693 508q8 14 26 39l17 14q8 8 12 10q2 3 4.5 3t5.5 -3q8 -8 10 -32q0 -16 -12 -47q-20 -23 -35 -23h-4q-27 5 -26 27q0 5 2 12zM-424 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327 q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133 q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM-362 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM63 186.5 q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM104 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110z" />
+<glyph unicode="&#xfb02;" horiz-adv-x="634" d="M396 51q-1 11 -2 24q0 114 104 287q70 123 258 424q190 270 426 476q11 9 21 9q7 0 14 -5q10 -6 10 -31q-2 -100 -156 -299q-88 -117 -370 -389l-96 -94l-76 -121q-76 -152 -88 -228q-2 -12 -2 -22q0 -57 55 -57q43 0 65 14q88 51 158 111q6 3 12 0q8 -2 2 -11 q-98 -88 -151 -125q-51 -33 -102 -32q-76 -1 -82 69zM645 524l39 39l191 189q106 109 176 200q78 100 84 113q41 66 51 125q0 9 -4 9q-5 0 -16 -11q-156 -119 -365 -420q-84 -123 -156 -244zM-424 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77 q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8 q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM-362 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127 l-204 -358q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM63 186.5q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM104 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110z" />
+<glyph unicode="&#xfb03;" horiz-adv-x="1052" d="M764 55q0 53 47 117q35 53 86 119q8 12 53 67l10 13q10 12 21 20q20 20 37 -12q4 -10 -13 -29q-2 -2 -9 -11l-13 -17q-119 -141 -158 -226q-4 -6 -4 -24q0 -51 53 -52q43 0 66 15q88 49 155 106q6 3 13 0q6 -2 0 -8q-98 -92 -148 -123q-50 -33 -94 -33h-8q-43 2 -70 23 q-24 18 -24 55zM1061 508q8 14 26 39l17 14q8 8 12 10q2 3 4.5 3t5.5 -3q8 -8 10 -32q0 -16 -12 -47q-20 -23 -35 -23h-4q-27 5 -26 27q0 5 2 12zM-55 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327 q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133 q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM7 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM432 186.5 q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM473 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110zM-424 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327q8 12 61 74 q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133 q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM-362 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM63 186.5 q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM104 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110z" />
+<glyph unicode="&#xfb04;" horiz-adv-x="1003" d="M764 51q-1 11 -2 24q0 114 104 287q70 123 258 424q190 270 426 476q11 9 21 9q7 0 14 -5q10 -6 10 -31q-2 -100 -156 -299q-88 -117 -370 -389l-96 -94l-76 -121q-76 -152 -88 -228q-2 -12 -2 -22q0 -57 55 -57q43 0 65 14q88 51 158 111q6 3 12 0q8 -2 2 -11 q-98 -88 -151 -125q-51 -33 -102 -32q-76 -1 -82 69zM1013 524l39 39l191 189q106 109 176 200q78 100 84 113q41 66 51 125q0 9 -4 9q-5 0 -16 -11q-156 -119 -365 -420q-84 -123 -156 -244zM-55 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77 q6 0 13 -1q27 -4 53 -29q102 168 256 388l219 327q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8 q-55 -51 -143 -123q-45 -31 -96 -31h-21q-14 -66 -43 -133q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM7 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358 q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM432 186.5q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM473 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110zM-424 -911q41 162 164 405q45 88 225 414l94 160q-41 49 -41 118q0 76 82 77q6 0 13 -1 q27 -4 53 -29q102 168 256 388l219 327q8 12 61 74q12 12 22 12q9 0 15 -10q4 -4 5 -12q0 -13 -13 -33q-20 -37 -199 -293l-229 -315q-6 -14 -82 -123q-4 -8 -31 -45q37 -63 37 -137q0 -23 -2 -43h15q43 0 77 20q41 20 152 115q4 4 10 0q6 -2 0 -8q-55 -51 -143 -123 q-45 -31 -96 -31h-21q-14 -66 -43 -133q-66 -164 -158 -328q-51 -92 -147 -217q-154 -199 -262 -258q-6 -4 -12 -4q-7 0 -14.5 5.5t-7.5 16.5q0 4 1 11zM-362 -850q4 0 8 2q242 188 383 463q82 162 125 270q31 82 39 113q-57 8 -105 45l-74 -127l-204 -358 q-119 -217 -172 -396q-2 -6 -2 -9t2 -3zM63 186.5q0 -49.5 21 -84.5l70 113q-18 20 -41 21q-50 0 -50 -49.5zM104 72q35 -35 95 -45q2 18 2 39q0 66 -25 116q-27 -38 -72 -110z" />
+</font>
+</defs></svg> 
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.ttf b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.ttf
new file mode 100644
index 0000000..4d34192
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.ttf differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.woff b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.woff
new file mode 100644
index 0000000..1aa47d4
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/Windsong-webfont.woff differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/alpha.png b/profiles/commons/libraries/modernizr/test/caniuse_files/alpha.png
new file mode 100644
index 0000000..b7a0f35
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/alpha.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/apng_test.png b/profiles/commons/libraries/modernizr/test/caniuse_files/apng_test.png
new file mode 100644
index 0000000..f359d3c
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/apng_test.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/before-after.png b/profiles/commons/libraries/modernizr/test/caniuse_files/before-after.png
new file mode 100644
index 0000000..7a94c4b
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/before-after.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/form_validation.html b/profiles/commons/libraries/modernizr/test/caniuse_files/form_validation.html
new file mode 100644
index 0000000..e7a060c
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/form_validation.html
@@ -0,0 +1,15 @@
+<!DOCTYPE html>
+<!-- saved from url=(0045)http://tests.caniuse.com/form_validation.html -->
+<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>
+if(location.href.indexOf('?') >= 0) {
+	document.write('FAIL');
+}
+</script>
+
+</head><body><form action="http://tests.caniuse.com/form_validation.html?" method="post">
+
+<input type="url" name="foo" required="">
+<input type="submit" value="submit me!">
+
+</form>
+</body></html>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/ga.js b/profiles/commons/libraries/modernizr/test/caniuse_files/ga.js
new file mode 100644
index 0000000..76a01b0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/ga.js
@@ -0,0 +1,43 @@
+(function(){var k=void 0,aa=encodeURIComponent,l=String,o=Math,ba="push",ca="cookie",p="charAt",q="indexOf",da="getTime",r="toString",t="window",v="length",w="document",x="split",y="location",ea="protocol",fa="href",z="substring",A="join",C="toLowerCase";var ga="_gat",ha="_gaq",ia="4.9.4",ja="_gaUserPrefs",ka="ioo",D="&",E="=",F="__utma=",H="__utmb=",la="__utmc=",ma="__utmk=",I="__utmv=",J="__utmz=",na="__utmx=",oa="GASO=";var pa=function(){var d=this,f=[],b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";d.set=function(b){f[b]=!0};d.Sc=function(){for(var d=[],e=0;e<f[v];e++)f[e]&&(d[o.floor(e/6)]^=1<<e%6);for(e=0;e<d[v];e++)d[e]=b[p](d[e]||0);return d[A]("")+"~"}},qa=new pa;function K(d){qa.set(d)};var ra=function(d,f){var b=this;b.window=d;b.document=f;b.setTimeout=function(b,e){setTimeout(b,e)};b.Jb=function(b){return navigator.userAgent[q](b)>=0};b.Xc=function(){return b.Jb("Firefox")&&![].reduce};b.Vc=function(){return L[t][ja]};b.Gc=function(){return L[t].external};b.Hc=function(){return L[t].performance||L[t].webkitPerformance};b.Ic=function(){return L[t].top==L[t]};b.Ya=function(b){var e=L[t]&&L[t].gaGlobal;if(b&&!e)e={},L[t].gaGlobal=e;return e};b.ec=function(b){L[w][y].href=b};b.qb=
+function(d){if(!d||!b.Jb("Firefox"))return d;for(var d=d.replace(/\n|\r/g," "),e=0,f=d[v];e<f;++e){var g=d.charCodeAt(e)&255;if(g==10||g==13)d=d[z](0,e)+"?"+d[z](e+1)}return d}},L=new ra(window,document);var sa=function(d){return function(f,b,h){d[f]=function(){K(b);return h.apply(d,arguments)};return h}},ta=function(d,f,b,h){d.addEventListener?d.addEventListener(f,b,!!h):d.attachEvent&&d.attachEvent("on"+f,b)},ua=function(d){return Object.prototype[r].call(Object(d))=="[object Array]"},M=function(d){return k==d||"-"==d||""==d},N=function(d,f,b){var h="-",e;!M(d)&&!M(f)&&!M(b)&&(e=d[q](f),e>-1&&(b=d[q](b,e),b<0&&(b=d[v]),h=d[z](e+f[q](E)+1,b)));return h},xa=function(d){var f=!1,b=0,h,e;if(!M(d)){f=
+!0;for(h=0;h<d[v];h++)e=d[p](h),b+="."==e?1:0,f=f&&b<=1&&(0==h&&"-"==e||".0123456789"[q](e)>-1)}return f},P=function(d,f){var b=aa;return b instanceof Function?f?encodeURI(d):b(d):(K(68),escape(d))},Q=function(d,f){var b=decodeURIComponent,h,d=d[x]("+")[A](" ");if(b instanceof Function)try{h=f?decodeURI(d):b(d)}catch(e){K(17),h=unescape(d)}else K(68),h=unescape(d);return h},R=function(d,f){return d[q](f)>-1};
+function ya(d){if(!d||""==d)return"";for(;d[p](0)[v]>0&&" \n\r\t"[q](d[p](0))>-1;)d=d[z](1);for(;d[p](d[v]-1)[v]>0&&" \n\r\t"[q](d[p](d[v]-1))>-1;)d=d[z](0,d[v]-1);return d}var T=function(d,f){d[ba]||K(94);d[d[v]]=f},za=function(d){var f=1,b=0,h;if(!M(d)){f=0;for(h=d[v]-1;h>=0;h--)b=d.charCodeAt(h),f=(f<<6&268435455)+b+(b<<14),b=f&266338304,f=b!=0?f^b>>21:f}return f},Aa=function(){return o.round(o.random()*2147483647)},Ba=function(){};var Ca=function(d,f){this.ib=d;this.jb=f},Da=function(){function d(b){for(var d=[],b=b[x](","),e,f=0;f<b[v];f++)e=b[f][x](":"),d[ba](new Ca(e[0],e[1]));return d}var f=this;f.Ca="utm_campaign";f.Da="utm_content";f.Ea="utm_id";f.Fa="utm_medium";f.Ga="utm_nooverride";f.Ha="utm_source";f.Ia="utm_term";f.Ja="gclid";f.vc="dclid";f.U=0;f.w=0;f.La=15768E6;f.Ma=18E5;f.s=63072E6;f.V=[];f.W=[];f.wc="cse";f.xc="q";f.Ta=50;f.J=d("daum:q,eniro:search_word,naver:query,pchome:q,images.google:q,google:q,yahoo:p,yahoo:q,msn:q,bing:q,aol:query,aol:encquery,aol:q,lycos:query,ask:q,altavista:q,netscape:query,cnn:query,about:terms,mamma:q,alltheweb:q,voila:rdata,virgilio:qs,live:q,baidu:wd,alice:qs,yandex:text,najdi:q,mama:query,seznam:q,search:q,wp:szukaj,onet:qt,szukacz:q,yam:k,kvasir:q,sesam:q,ozu:q,terra:query,mynet:q,ekolay:q,rambler:query,rambler:words");
+f.f="/";f.L=100;f.ga="/__utm.gif";f.la=1;f.ma=1;f.u="|";f.ka=1;f.Ka=1;f.Ua=1;f.b="auto";f.B=1;f.Wb=10;f.zc=10;f.Ac=0.2;f.o=k};var Ea=function(d){function f(a,c,b,j){var i="",d=0,i=N(a,"2"+c,";");if(!M(i)){a=i[q]("^"+b+".");if(a<0)return["",0];i=i[z](a+b[v]+2);i[q]("^")>0&&(i=i[x]("^")[0]);b=i[x](":");i=b[1];d=parseInt(b[0],10);!j&&d<e.m&&(i="")}M(i)&&(i="");return[i,d]}function b(a,c){return"^"+[[c,a[1]][A]("."),a[0]][A](":")}function h(a){var c=new Date,a=new Date(c[da]()+a);return"expires="+a.toGMTString()+"; "}var e=this,m=d;e.m=(new Date)[da]();var g=[F,H,la,J,I,na,oa];e.g=function(){var a=L[w][ca];return m.o?e.Nc(a,
+m.o):a};e.Nc=function(a,c){for(var b=[],j,i=0;i<g[v];i++)j=f(a,g[i],c)[0],M(j)||(b[b[v]]=g[i]+j+";");return b[A]("")};e.l=function(a,c,b){var j=b>0?h(b):"";m.o&&(c=e.Oc(L[w][ca],a,m.o,c,b),a="2"+a,j=b>0?h(m.s):"");a+=c;a=L.qb(a);a[v]>2E3&&(K(69),a=a[z](0,2E3));j=a+"; path="+m.f+"; "+j+e.hb();if(!V.pb())L[w].cookie=j};e.Oc=function(a,c,d,j,i){var g="",i=i||m.s,j=b([j,e.m+i*1],d),g=N(a,"2"+c,";");if(!M(g))return a=b(f(a,c,d,!0),d),g=g[x](a)[A](""),g=j+g;return j};e.hb=function(){return M(m.b)?"":"domain="+
+m.b+";"}};var Fa=function(d){function f(a){a=ua(a)?a[A]("."):"";return M(a)?"-":a}function b(a,c){var n=[],b;if(!M(a)&&(n=a[x]("."),c))for(b=0;b<n[v];b++)xa(n[b])||(n[b]="-");return n}function h(a,c,n){var b=i.I,j,d;for(j=0;j<b[v];j++)d=b[j][0],d+=M(c)?c:c+b[j][4],b[j][2](N(a,d,n))}var e,m,g,a,c,u,j,i=this,s,n=d;i.i=new Ea(d);i.Ba=function(){return k==s||s==i.K()};i.g=function(){return i.i.g()};i.ea=function(){return c?c:"-"};i.Pa=function(a){c=a};i.fa=function(a){s=xa(a)?a*1:"-"};i.da=function(){return f(u)};
+i.X=function(a){u=b(a)};i.yc=function(){i.i.l(I,"",-1)};i.Rb=function(){return s?s:"-"};i.hb=function(){return M(n.b)?"":"domain="+n.b+";"};i.ba=function(){return f(e)};i.Na=function(a){e=b(a,1)};i.z=function(){return f(m)};i.$=function(a){m=b(a,1)};i.ca=function(){return f(g)};i.Oa=function(a){g=b(a,1)};i.qa=function(){return f(a)};i.ra=function(c){a=b(c);for(c=0;c<a[v];c++)c<4&&!xa(a[c])&&(a[c]="-")};i.Fc=function(){return j};i.Dc=function(a){j=a};i.Qb=function(){e=[];m=[];g=[];a=[];c=k;u=[];s=
+k};i.K=function(){for(var a="",c=0;c<i.I[v];c++)a+=i.I[c][1]();return za(a)};i.Z=function(a){var c=i.g(),n=!1;c&&(h(c,a,";"),i.fa(l(i.K())),n=!0);return n};i.Sb=function(a){h(a,"",D);i.fa(N(a,ma,D))};i.Tb=function(){var a=i.I,c=[],n;for(n=0;n<a[v];n++)T(c,a[n][0]+a[n][1]());T(c,ma+i.K());return c[A](D)};i.Ub=function(a,c){var b=i.I,j=n.f;i.Z(a);n.f=c;for(var d=0;d<b[v];d++)if(!M(b[d][1]()))b[d][3]();n.f=j};i.Qa=function(){i.i.l(F,i.ba(),n.s)};i.aa=function(){i.i.l(H,i.z(),n.Ma)};i.Ra=function(){i.i.l(la,
+i.ca(),0)};i.sa=function(){i.i.l(J,i.qa(),n.La)};i.Sa=function(){i.i.l(na,i.ea(),n.s)};i.Y=function(){i.i.l(I,i.da(),n.s)};i.Ec=function(){i.i.l(oa,i.Fc(),0)};i.I=[[F,i.ba,i.Na,i.Qa,"."],[H,i.z,i.$,i.aa,""],[la,i.ca,i.Oa,i.Ra,""],[na,i.ea,i.Pa,i.Sa,""],[J,i.qa,i.ra,i.sa,"."],[I,i.da,i.X,i.Y,"."]]};var Ga="https:"==L[w][y][ea]?"https://ssl.google-analytics.com/":"http://www.google-analytics.com/",Ha=Ga+"p/__utm.gif",Ja=function(){var d=this;d.Bb=function(f,b,h,e,m){b[v]<=2036||m?d.Aa(f+"?"+b,e):b[v]<=8192?L.Xc()?d.Aa(f+"?"+h+"&err=ff2post&len="+b[v],e):d.fd(b,e):d.Aa(f+"?"+h+"&err=len&max=8192&len="+b[v],e)};d.Aa=function(d,b){var h=new Image(1,1);h.src=d;h.onload=function(){h.onload=null;(b||Ba)()}};d.fd=function(f,b){d.ed(f,b)||d.Ob(f,b)};d.ed=function(d,b){var h,e=L[t].XDomainRequest;if(e)h=
+new e,h.open("POST",Ha);else if(e=L[t].XMLHttpRequest)e=new e,"withCredentials"in e&&(h=e,h.open("POST",Ha,!0),h.setRequestHeader("Content-Type","text/plain"));if(h)return h.onreadystatechange=function(){h.readyState==4&&(b&&b(),h=null)},h.send(d),!0;return!1};d.Ob=function(f,b){var h=L[w];if(h.body){f=aa(f);try{var e=h.createElement('<iframe name="'+f+'"></iframe>')}catch(m){e=h.createElement("iframe"),e.name=f}e.height="0";e.width="0";e.style.display="none";e.style.visibility="hidden";var g=h[y],
+g=g[ea]+"//"+g.host+"/favicon.ico",g=Ga+"u/post_iframe.html#"+aa(g),a=function(){e.src="";e.parentNode&&e.parentNode.removeChild(e)};ta(L[t],"beforeunload",a);var c=!1,u=0,j=function(){if(!c){try{if(u>9||e.contentWindow[y].host==h[y].host){c=!0;a();var d=L[t],g="beforeunload",n=a;d.removeEventListener?d.removeEventListener(g,n,!1):d.detachEvent&&d.detachEvent("on"+g,n);b&&b();return}}catch(f){}u++;L.setTimeout(j,200)}};ta(e,"load",j);h.body.appendChild(e);e.src=g}else L.setTimeout(function(){d.Ob(f,
+b)},100)}};var Ka=function(d){var f=this,b=d,h=new Fa(b),e=null,m=!V.pb(),g=function(){};f.Uc=function(){return"https:"==L[w][y][ea]?"https://ssl.google-analytics.com/__utm.gif":"http://www.google-analytics.com/__utm.gif"};f.A=function(a,c,d,j,i,s){e||(e=new Ja);var n=b.B,O=L[w][y];h.Z(d);var B=h.z()[x](".");if(B[1]<500||j){if(i){var S=(new Date)[da](),X;X=(S-B[3])*(b.Ac/1E3);X>=1&&(B[2]=o.min(o.floor(B[2]*1+X),b.zc),B[3]=S)}if(j||!i||B[2]>=1){!j&&i&&(B[2]=B[2]*1-1);j=B[1]*1+1;B[1]=j;i="utmwv="+ia;S="&utms="+
+j;X="&utmn="+Aa();j=i+"e"+S+X;a=i+S+X+(M(O.hostname)?"":"&utmhn="+P(O.hostname))+(b.L==100?"":"&utmsp="+P(b.L))+a;if(0==n||2==n)O=2==n?g:s||g,m&&e.Bb(b.ga,a,j,O,!0);if(1==n||2==n)c="&utmac="+c,j+=c,a+=c+"&utmcc="+f.Tc(d),V.Ab&&(d="&aip=1",j+=d,a+=d),a+="&utmu="+qa.Sc(),m&&e.Bb(f.Uc(),a,j,s)}}h.$(B[A]("."));h.aa()};f.Tc=function(a){for(var c=[],b=[F,J,I,na],d=h.g(),i,g=0;g<b[v];g++)if(i=N(d,b[g]+a,";"),!M(i)){if(b[g]==I){i=i[x](a+".")[1][x]("|")[0];if(M(i))continue;i=a+"."+i}T(c,b[g]+i+";")}return P(c[A]("+"))}};var W=function(){var d=this;d.N=[];d.Va=function(f){for(var b,h=d.N,e=0;e<h[v];e++)b=f==h[e].q?h[e]:b;return b};d.Xb=function(f,b,h,e,m,g,a,c){var u=d.Va(f);k==u?(u=new W.Wc(f,b,h,e,m,g,a,c),T(d.N,u)):(u.tb=b,u.zb=h,u.yb=e,u.wb=m,u.ub=g,u.xb=a,u.vb=c);return u}};W.Qc=function(d,f,b,h,e,m){var g=this;g.Fb=d;g.va=f;g.n=b;g.Cb=h;g.Db=e;g.Eb=m;g.ha=function(){return"&"+["utmt=item","tid="+P(g.Fb),"ipc="+P(g.va),"ipn="+P(g.n),"iva="+P(g.Cb),"ipr="+P(g.Db),"iqt="+P(g.Eb)][A]("&utm")}};
+W.Wc=function(d,f,b,h,e,m,g,a){var c=this;c.q=d;c.tb=f;c.zb=b;c.yb=h;c.wb=e;c.ub=m;c.xb=g;c.vb=a;c.M=[];c.Vb=function(a,b,d,g,n){var e=c.Rc(a),f=c.q;k==e?T(c.M,new W.Qc(f,a,b,d,g,n)):(e.Fb=f,e.va=a,e.n=b,e.Cb=d,e.Db=g,e.Eb=n)};c.Rc=function(a){for(var b,d=c.M,g=0;g<d[v];g++)b=a==d[g].va?d[g]:b;return b};c.ha=function(){return"&"+["utmt=tran","id="+P(c.q),"st="+P(c.tb),"to="+P(c.zb),"tx="+P(c.yb),"sp="+P(c.wb),"ci="+P(c.ub),"rg="+P(c.xb),"co="+P(c.vb)][A]("&utmt")}};var La=function(d){function f(){var b,a,c;a="ShockwaveFlash";var d="$version",j=L[t].navigator;if((j=j?j.plugins:k)&&j[v]>0)for(b=0;b<j[v]&&!c;b++)a=j[b],R(a.name,"Shockwave Flash")&&(c=a.description[x]("Shockwave Flash ")[1]);else{a=a+"."+a;try{b=new ActiveXObject(a+".7"),c=b.GetVariable(d)}catch(e){}if(!c)try{b=new ActiveXObject(a+".6"),c="WIN 6,0,21,0",b.we="always",c=b.GetVariable(d)}catch(f){}if(!c)try{b=new ActiveXObject(a),c=b.GetVariable(d)}catch(n){}c&&(c=c[x](" ")[1][x](","),c=c[0]+"."+
+c[1]+" r"+c[2])}return c?c:h}var b=this,h="-",e=L[t].screen,m=L[t].navigator;b.Nb=e?e.width+"x"+e.height:h;b.Mb=e?e.colorDepth+"-bit":h;b.cd=P(L[w].characterSet?L[w].characterSet:L[w].charset?L[w].charset:h);b.Lb=(m&&m.language?m.language:m&&m.browserLanguage?m.browserLanguage:h)[C]();b.Kb=m&&m.javaEnabled()?1:0;b.dd=d?f():h;b.dc=function(){return D+"utm"+["cs="+P(b.cd),"sr="+b.Nb,"sc="+b.Mb,"ul="+b.Lb,"je="+b.Kb,"fl="+P(b.dd)][A]("&utm")};b.cc=function(){for(var d=L[t].navigator,a=L[t].history[v],
+d=d.appName+d.version+b.Lb+d.platform+d.userAgent+b.Kb+b.Nb+b.Mb+(L[w][ca]?L[w][ca]:"")+(L[w].referrer?L[w].referrer:""),c=d[v];a>0;)d+=a--^c++;return za(d)}};var Z=function(d,f,b,h){function e(a){var c="",c=a[x]("://")[1][C]();R(c,"/")&&(c=c[x]("/")[0]);return c}var m=h,g=this;g.a=d;g.ob=f;g.m=b;g.mb=function(a){var c=g.ua();return new Z.v(N(a,m.Ea+E,D),N(a,m.Ha+E,D),N(a,m.Ja+E,D),g.R(a,m.Ca,"(not set)"),g.R(a,m.Fa,"(not set)"),g.R(a,m.Ia,c&&!M(c.G)?Q(c.G):k),g.R(a,m.Da,k),N(a,m.vc+E,D))};g.nb=function(a){var c=e(a),b;b=a;var d="";b=b[x]("://")[1][C]();R(b,"/")&&(b=b[x]("/")[1],R(b,"?")&&(d=b[x]("?")[0]));b=d;if(R(c,"google")&&(a=a[x]("?")[A](D),R(a,D+
+m.xc+E)&&b==m.wc))return!0;return!1};g.ua=function(){var a,c=g.ob,b,d=m.J;if(!M(c)&&"0"!=c&&R(c,"://")&&!g.nb(c)){a=e(c);for(var i=0;i<d[v];i++)if(b=d[i],R(a,b.ib[C]())&&(c=c[x]("?")[A](D),R(c,D+b.jb+E)))return a=c[x](D+b.jb+E)[1],R(a,D)&&(a=a[x](D)[0]),new Z.v(k,b.ib,k,"(organic)","organic",a,k,k)}};g.R=function(a,c,b){a=N(a,c+E,D);return b=!M(a)?Q(a):!M(b)?b:"-"};g.Bc=function(a){var c=m.V,b=!1;if(a&&"organic"==a.P)for(var a=Q(a.G)[C](),d=0;d<c[v];d++)b=b||c[d][C]()==a;return b};g.lb=function(){var a=
+"",c="",a=g.ob;if(!M(a)&&"0"!=a&&R(a,"://")&&!g.nb(a))return a=a[x]("://")[1],R(a,"/")&&(c=a[z](a[q]("/")),c=c[x]("?")[0],a=a[x]("/")[0][C]()),0==a[q]("www.")&&(a=a[z](4)),new Z.v(k,a,k,"(referral)","referral",k,c,k)};g.kb=function(a){var c="";m.U&&(c=a&&a.hash?a[fa][z](a[fa][q]("#")):"",c=""!=c?c+D:c);c+=a.search;return c};g.ta=function(){return new Z.v(k,"(direct)",k,"(direct)","(none)",k,k,k)};g.Cc=function(a){var c=!1,b=m.W;if(a&&"referral"==a.P)for(var a=P(a.Q)[C](),d=0;d<b[v];d++)c=c||R(a,b[d][C]());
+return c};g.h=function(a){return k!=a&&a.fb()};g.te=function(a){var a=N(a,J+g.a+".",";"),c=a[x]("."),a=new Z.v;a.gb(c.slice(4)[A]("."));if(!g.h(a))return!0;c=L[w][y];c=g.kb(c);c=g.mb(c);g.h(c)||(c=g.ua(),g.h(c)||(c=g.lb()));return g.h(c)&&a.H()[C]()!=c.H()[C]()};g.Pb=function(a,c){if(m.Ka){var b="",d="-",e,f=0,n,h,B=g.a;if(a){h=a.g();b=g.kb(L[w][y]);if(m.w&&a.Ba()&&(d=Q(a.qa()),!M(d)&&!R(d,";"))){a.ra(d);a.sa();return}d=N(h,J+B+".",";");e=g.mb(b);if(g.h(e)&&(b=N(b,m.Ga+E,D),"1"==b&&!M(d)))return;
+if(!g.h(e)){e=g.ua();b=g.Bc(e);if(!M(d)&&b)return;b&&(e=g.ta())}if(!g.h(e)&&c){e=g.lb();b=g.Cc(e);if(!M(d)&&b)return;b&&(e=g.ta())}g.h(e)||M(d)&&c&&(e=g.ta());if(g.h(e)&&(M(d)||(f=d[x]("."),n=new Z.v,n.gb(f.slice(4)[A](".")),n=n.H()[C]()==e.H()[C](),f=f[3]*1),!n||c))h=N(h,F+B+".",";"),n=h.lastIndexOf("."),h=n>9?h[z](n+1)*1:0,f++,h=0==h?1:h,a.ra([B,g.m,h,f,e.H()][A](".")),a.sa()}}}};
+Z.v=function(d,f,b,h,e,m,g,a){var c=this;c.q=d;c.Q=f;c.ya=b;c.n=h;c.P=e;c.G=m;c.Gb=g;c.xa=a;c.H=function(){var a=[],b=[["cid",c.q],["csr",c.Q],["gclid",c.ya],["ccn",c.n],["cmd",c.P],["ctr",c.G],["cct",c.Gb],["dclid",c.xa]],d,e;if(c.fb())for(d=0;d<b[v];d++)M(b[d][1])||(e=b[d][1][x]("+")[A]("%20"),e=e[x](" ")[A]("%20"),T(a,"utm"+b[d][0]+E+e));return L.qb(a[A]("|"))};c.fb=function(){return!(M(c.q)&&M(c.Q)&&M(c.ya)&&M(c.xa))};c.gb=function(a){var b=function(b){return Q(N(a,"utm"+b+E,"|"))};c.q=b("cid");
+c.Q=b("csr");c.ya=b("gclid");c.n=b("ccn");c.P=b("cmd");c.G=b("ctr");c.Gb=b("cct");c.xa=b("dclid")}};var Ma=function(d,f,b,h){var e=this,m=f,g=E,a=d,c=h;e.S=b;e.wa="";e.r={};e.$b=function(){var a;a=N(e.S.g(),I+m+".",";")[x](m+".")[1];if(!M(a)){a=a[x]("|");var b=e.r,c=a[1],d;if(!M(c))for(var c=c[x](","),n=0;n<c[v];n++)d=c[n],M(d)||(d=d[x](g),d[v]==4&&(b[d[0]]=[Q(d[1]),Q(d[2]),1]));e.wa=Q(a[0]);e.T()}};e.T=function(){e.Pc();var a=P(e.wa),b,c,d="";for(b in e.r)(c=e.r[b])&&1===c[2]&&(d+=b+g+P(c[0])+g+P(c[1])+g+1+",");M(d)||(a+="|"+d);M(a)?e.S.yc():(e.S.X(m+"."+a),e.S.Y())};e.bc=function(a){e.wa=a;e.T()};
+e.ac=function(b,c,d,g){1!=g&&2!=g&&3!=g&&(g=3);var n=!1;if(c&&d&&b>0&&b<=a.Ta){var f=P(c),h=P(d);f[v]+h[v]<=64&&(e.r[b]=[c,d,g],e.T(),n=!0)}return n};e.Zb=function(a){if((a=e.r[a])&&1===a[2])return a[1]};e.Yb=function(a){var b=e.r;b[a]&&(delete b[a],e.T())};e.Pc=function(){c.t(8);c.t(9);c.t(11);var a=e.r,b,d;for(d in a)if(b=a[d])c.j(8,d,b[0]),c.j(9,d,b[1]),(b=b[2])&&3!=b&&c.j(11,d,""+b)}};var Na=function(){function d(a,b,c,d){k==g[a]&&(g[a]={});k==g[a][b]&&(g[a][b]=[]);g[a][b][c]=d}function f(a,b,c){if(k!=g[a]&&k!=g[a][b])return g[a][b][c]}function b(a,b){if(k!=g[a]&&k!=g[a][b]){g[a][b]=k;var c=!0,d;for(d=0;d<u[v];d++)if(k!=g[a][u[d]]){c=!1;break}c&&(g[a]=k)}}function h(a){var b="",c=!1,d,e;for(d=0;d<u[v];d++)if(e=a[u[d]],k!=e){c&&(b+=u[d]);for(var c=[],g=k,f=k,f=0;f<e[v];f++)if(k!=e[f]){g="";f!=S&&k==e[f-1]&&(g+=f[r]()+n);var h;h=e[f];for(var O="",m=k,U=k,wa=k,m=0;m<h[v];m++)U=h[p](m),
+wa=B[U],O+=k!=wa?wa:U;h=O;g+=h;T(c,g)}e=j+c[A](s)+i;b+=e;c=!1}else c=!0;return b}var e=this,m=sa(e),g={},a="k",c="v",u=[a,c],j="(",i=")",s="*",n="!",O="'",B={};B[O]="'0";B[i]="'1";B[s]="'2";B[n]="'3";var S=1;e.Yc=function(a){return k!=g[a]};e.C=function(){var a="",b;for(b in g)k!=g[b]&&(a+=b[r]()+h(g[b]));return a};e.hc=function(a){if(a==k)return e.C();var b=a.C(),c;for(c in g)k!=g[c]&&!a.Yc(c)&&(b+=c[r]()+h(g[c]));return b};e.j=m("_setKey",89,function(b,c,n){if(typeof n!="string")return!1;d(b,a,
+c,n);return!0});e.ja=m("_setValue",90,function(a,b,n){if(typeof n!="number"&&(k==Number||!(n instanceof Number))||o.round(n)!=n||n==NaN||n==Infinity)return!1;d(a,c,b,n[r]());return!0});e.fc=m("_getKey",87,function(b,c){return f(b,a,c)});e.gc=m("_getValue",88,function(a,b){return f(a,c,b)});e.t=m("_clearKey",85,function(c){b(c,a)});e.ia=m("_clearValue",86,function(a){b(a,c)})};var Oa=function(d,f){var b=this,h=sa(b);b.ze=f;b.gd=d;b.Za=h("_trackEvent",91,function(d,h,g){return f.Za(b.gd,d,h,g)})};var Pa=function(d,f){var b=this,h=L.Gc(),e=L.Hc(),m=10;b.rb=new Na;b.Kc=function(){var b,a="timing",c="onloadT";h&&h[c]!=k&&h.isValidLoadTime?b=h[c]:e&&e[a]&&(b=e[a].loadEventStart-e[a].fetchStart);return b};b.Mc=function(){return d.D()&&d.Xa()%100<m};b.Lc=function(){var e="&utmt=event&utme="+P(b.rb.C())+d.na();f.A(e,d.p,d.a,!1,!0)};b.Jc=function(b){b=o.min(o.floor(b/100),5E3);return b>0?b+"00":"0"};b.sb=function(){var d=b.Kc();if(d==k||isNaN(d))return!1;if(d<=0)return!0;if(d>2147483648)return!1;
+var a=b.rb;a.t(14);a.ia(14);var c=b.Jc(d);a.j(14,1,c)&&a.ja(14,1,d)&&b.Lc();h&&h.isValidLoadTime!=k&&h.setPageReadyTime();return!1};b.Wa=function(){if(!b.Mc())return!1;if(!L.Ic())return!1;b.sb()&&ta(L[t],"load",b.sb,!1);return!0}};var $=function(){};$.Zc=function(d){var f="gaso=",b=L[w][y].hash;d=b&&1==b[q](f)?N(b,f,D):(b=L[t].name)&&0<=b[q](f)?N(b,f,D):N(d.g(),oa,";");return d};$.ad=function(d,f){var b=(f||"www")+".google.com",b="https://"+b+"/analytics/reporting/overlay_js?gaso="+d+D+Aa(),h="_gasojs",e=L[w].createElement("script");e.type="text/javascript";e.src=b;if(h)e.id=h;(L[w].getElementsByTagName("head")[0]||L[w].getElementsByTagName("body")[0]).appendChild(e)};
+$.load=function(d,f){if(!$.$c){var b=$.Zc(f),h=b&&b.match(/^(?:\|([-0-9a-z.]{1,30})\|)?([-.\w]{10,1200})$/i);if(h)f.Dc(b),f.Ec(),V._gasoDomain=d.b,V._gasoCPath=d.f,$.ad(h[2],h[1]);$.$c=!0}};var Qa=function(d,f,b){function h(){if("auto"==j.b){var a=L[w].domain;"www."==a[z](0,4)&&(a=a[z](4));j.b=a}j.b=j.b[C]()}function e(){h();var a=j.b,b=a[q]("www.google.")*a[q](".google.")*a[q]("google.");return b||"/"!=j.f||a[q]("google.org")>-1}function m(b,c,d){if(M(b)||M(c)||M(d))return"-";b=N(b,F+a.a+".",c);M(b)||(b=b[x]("."),b[5]=""+(b[5]?b[5]*1+1:1),b[3]=b[4],b[4]=d,b=b[A]("."));return b}function g(){return"file:"!=L[w][y][ea]&&e()}var a=this,c=sa(a),u=k,j=new Da,i=!1,s=k;a.n=d;a.m=o.round((new Date)[da]()/
+1E3);a.p=f||"UA-XXXXX-X";a.ab=L[w].referrer;a.oa=k;a.d=k;a.F=!1;a.O=k;a.e=k;a.bb=k;a.pa=k;a.a=k;a.k=k;j.o=b?P(b):k;a.eb=!1;a.mc=function(){return Aa()^a.O.cc()&2147483647};a.lc=function(){if(!j.b||""==j.b||"none"==j.b)return j.b="",1;h();return j.Ua?za(j.b):1};a.kc=function(a,b){if(M(a))a="-";else{b+=j.f&&"/"!=j.f?j.f:"";var c=a[q](b),a=c>=0&&c<=8?"0":"["==a[p](0)&&"]"==a[p](a[v]-1)?"-":a}return a};a.na=function(b){var c="";c+=j.ka?a.O.dc():"";c+=j.la&&!M(L[w].title)?"&utmdt="+P(L[w].title):"";var d;
+d=L.Ya(!0);if(!d.hid)d.hid=Aa();d=d.hid;c+="&utmhid="+d+"&utmr="+P(l(a.oa))+"&utmp="+P(a.pc(b));return c};a.pc=function(a){var b=L[w][y];a&&K(13);return a=k!=a&&""!=a?P(a,!0):P(b.pathname+b.search,!0)};a.uc=function(b){if(a.D()){var c="";a.e!=k&&a.e.C()[v]>0&&(c+="&utme="+P(a.e.C()));c+=a.na(b);u.A(c,a.p,a.a)}};a.jc=function(){var b=new Fa(j);return b.Z(a.a)?b.Tb():k};a.cb=c("_getLinkerUrl",52,function(b,c){var d=b[x]("#"),e=b,f=a.jc();if(f)if(c&&1>=d[v])e+="#"+f;else if(!c||1>=d[v])1>=d[v]?e+=(R(b,
+"?")?D:"?")+f:e=d[0]+(R(b,"?")?D:"?")+f+"#"+d[1];return e});a.nc=function(){var b=a.m,c=a.k,d=c.g(),e=a.a+"",f=L.Ya(),g,h=R(d,F+e+"."),i=R(d,H+e),u=R(d,la+e),s,G=[],Y="",Ia=!1,d=M(d)?"":d;if(j.w&&!a.eb){g=L[w][y]&&L[w][y].hash?L[w][y][fa][z](L[w][y][fa][q]("#")):"";j.U&&!M(g)&&(Y=g+D);Y+=L[w][y].search;if(!M(Y)&&R(Y,F))c.Sb(Y),c.Ba()||c.Qb(),s=c.ba(),a.eb=!0;g=c.ea;var va=c.Pa,U=c.Sa;M(g())||(va(Q(g())),R(g(),";")||U());g=c.da;va=c.X;U=c.Y;M(g())||(va(g()),R(g(),";")||U())}M(s)?h?(s=!i||!u)?(s=m(d,
+";",l(b)),a.F=!0):(s=N(d,F+e+".",";"),G=N(d,H+e,";")[x](".")):(s=[e,a.mc(),b,b,b,1][A]("."),Ia=a.F=!0):M(c.z())||M(c.ca())?(s=m(Y,D,l(b)),a.F=!0):(G=c.z()[x]("."),e=G[0]);s=s[x](".");L[t]&&f&&f.dh==e&&!j.o&&(s[4]=f.sid?f.sid:s[4],Ia&&(s[3]=f.sid?f.sid:s[4],f.vid&&(b=f.vid[x]("."),s[1]=b[0],s[2]=b[1])));c.Na(s[A]("."));G[0]=e;G[1]=G[1]?G[1]:0;G[2]=k!=G[2]?G[2]:j.Wb;G[3]=G[3]?G[3]:s[4];c.$(G[A]("."));c.Oa(e);M(c.Rb())||c.fa(c.K());c.Qa();c.aa();c.Ra()};a.oc=function(){u=new Ka(j)};a.getName=c("_getName",
+58,function(){return a.n});a.c=c("_initData",2,function(){var b;if(!i){if(!a.O)a.O=new La(j.ma);a.a=a.lc();a.k=new Fa(j);a.e=new Na;s=new Ma(j,l(a.a),a.k,a.e);a.oc()}if(g()){if(!i)a.oa=a.kc(a.ab,L[w].domain),b=new Z(l(a.a),a.oa,a.m,j);a.nc(b);s.$b()}if(!i)g()&&b.Pb(a.k,a.F),a.bb=new Na,$.load(j,a.k),i=!0});a.Xa=c("_visitCode",54,function(){a.c();var b=N(a.k.g(),F+a.a+".",";"),b=b[x](".");return b[v]<4?"":b[1]});a.qd=c("_cookiePathCopy",30,function(b){a.c();a.k&&a.k.Ub(a.a,b)});a.D=function(){return a.Xa()%
+1E4<j.L*100};a.re=c("_trackPageview",1,function(b){if(g())a.c(),a.uc(b),a.F=!1});a.se=c("_trackTrans",18,function(){var b=a.a,c=[],d,e,f;a.c();if(a.d&&a.D()){for(d=0;d<a.d.N[v];d++){e=a.d.N[d];T(c,e.ha());for(f=0;f<e.M[v];f++)T(c,e.M[f].ha())}for(d=0;d<c[v];d++)u.A(c[d],a.p,b,!0)}});a.me=c("_setTrans",20,function(){var b,c,d,e;b=L[w].getElementById?L[w].getElementById("utmtrans"):L[w].utmform&&L[w].utmform.utmtrans?L[w].utmform.utmtrans:k;a.c();if(b&&b.value){a.d=new W;e=b.value[x]("UTM:");j.u=!j.u||
+""==j.u?"|":j.u;for(b=0;b<e[v];b++){e[b]=ya(e[b]);c=e[b][x](j.u);for(d=0;d<c[v];d++)c[d]=ya(c[d]);"T"==c[0]?a.$a(c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8]):"I"==c[0]&&a.ic(c[1],c[2],c[3],c[4],c[5],c[6])}}});a.$a=c("_addTrans",21,function(b,c,d,e,f,g,h,i){a.d=a.d?a.d:new W;return a.d.Xb(b,c,d,e,f,g,h,i)});a.ic=c("_addItem",19,function(b,c,d,e,f,g){var h;a.d=a.d?a.d:new W;(h=a.d.Va(b))||(h=a.$a(b,"","","","","","",""));h.Vb(c,d,e,f,g)});a.oe=c("_setVar",22,function(b){b&&""!=b&&e()&&(a.c(),s.bc(b),a.D()&&
+u.A("&utmt=var",a.p,a.a))});a.Yd=c("_setCustomVar",10,function(b,c,d,e){a.c();return s.ac(b,c,d,e)});a.td=c("_deleteCustomVar",35,function(b){a.c();s.Yb(b)});a.Cd=c("_getVisitorCustomVar",50,function(b){a.c();return s.Zb(b)});a.fe=c("_setMaxCustomVariables",71,function(a){j.Ta=a});a.link=c("_link",101,function(b,c){j.w&&b&&(a.c(),L.ec(a.cb(b,c)))});a.Fd=c("_linkByPost",102,function(b,c){if(j.w&&b&&b.action)a.c(),b.action=a.cb(b.action,c)});a.pe=c("_setXKey",83,function(b,c,d){a.e.j(b,c,d)});a.qe=
+c("_setXValue",84,function(b,c,d){a.e.ja(b,c,d)});a.Dd=c("_getXKey",76,function(b,c){return a.e.fc(b,c)});a.Ed=c("_getXValue",77,function(b,c){return a.e.gc(b,c)});a.od=c("_clearXKey",72,function(b){a.e.t(b)});a.pd=c("_clearXValue",73,function(b){a.e.ia(b)});a.sd=c("_createXObj",75,function(){a.c();return new Na});a.qc=c("_sendXEvent",78,function(b){var c="";a.c();a.D()&&(c+="&utmt=event&utme="+P(a.e.hc(b))+a.na(),u.A(c,a.p,a.a,!1,!0))});a.rd=c("_createEventTracker",74,function(b){a.c();return new Oa(b,
+a)});a.Za=c("_trackEvent",4,function(b,c,d,e){a.c();var f=a.bb;k!=b&&k!=c&&""!=b&&""!=c?(f.t(5),f.ia(5),(b=f.j(5,1,b)&&f.j(5,2,c)&&(k==d||f.j(5,3,d))&&(k==e||f.ja(5,1,e)))&&a.qc(f)):b=!1;return b});a.Wa=c("_trackPageLoadTime",100,function(){a.c();if(!a.pa)a.pa=new Pa(a,u);return a.pa.Wa()});a.wd=function(){return j};a.ae=c("_setDomainName",6,function(a){j.b=a});a.kd=c("_addOrganic",14,function(a,b,c){j.J.splice(c?0:j.J[v],0,new Ca(a,b))});a.nd=c("_clearOrganic",70,function(){j.J=[]});a.hd=c("_addIgnoredOrganic",
+15,function(a){T(j.V,a)});a.ld=c("_clearIgnoredOrganic",97,function(){j.V=[]});a.jd=c("_addIgnoredRef",31,function(a){T(j.W,a)});a.md=c("_clearIgnoredRef",32,function(){j.W=[]});a.Id=c("_setAllowHash",8,function(a){j.Ua=a?1:0});a.Td=c("_setCampaignTrack",36,function(a){j.Ka=a?1:0});a.Ud=c("_setClientInfo",66,function(a){j.ka=a?1:0});a.vd=c("_getClientInfo",53,function(){return j.ka});a.Vd=c("_setCookiePath",9,function(a){j.f=a});a.ne=c("_setTransactionDelim",82,function(a){j.u=a});a.Xd=c("_setCookieTimeout",
+25,function(b){a.rc(b*1E3)});a.rc=c("_setCampaignCookieTimeout",29,function(a){j.La=a});a.Zd=c("_setDetectFlash",61,function(a){j.ma=a?1:0});a.xd=c("_getDetectFlash",65,function(){return j.ma});a.$d=c("_setDetectTitle",62,function(a){j.la=a?1:0});a.yd=c("_getDetectTitle",56,function(){return j.la});a.ce=c("_setLocalGifPath",46,function(a){j.ga=a});a.zd=c("_getLocalGifPath",57,function(){return j.ga});a.ee=c("_setLocalServerMode",92,function(){j.B=0});a.ie=c("_setRemoteServerMode",63,function(){j.B=
+1});a.de=c("_setLocalRemoteServerMode",47,function(){j.B=2});a.Ad=c("_getServiceMode",59,function(){return j.B});a.je=c("_setSampleRate",45,function(a){j.L=a});a.ke=c("_setSessionTimeout",27,function(b){a.sc(b*1E3)});a.sc=c("_setSessionCookieTimeout",26,function(a){j.Ma=a});a.Jd=c("_setAllowLinker",11,function(a){j.w=a?1:0});a.Hd=c("_setAllowAnchor",7,function(a){j.U=a?1:0});a.Qd=c("_setCampNameKey",41,function(a){j.Ca=a});a.Md=c("_setCampContentKey",38,function(a){j.Da=a});a.Nd=c("_setCampIdKey",
+39,function(a){j.Ea=a});a.Od=c("_setCampMediumKey",40,function(a){j.Fa=a});a.Pd=c("_setCampNOKey",42,function(a){j.Ga=a});a.Rd=c("_setCampSourceKey",43,function(a){j.Ha=a});a.Sd=c("_setCampTermKey",44,function(a){j.Ia=a});a.Ld=c("_setCampCIdKey",37,function(a){j.Ja=a});a.ud=c("_getAccount",64,function(){return a.p});a.Gd=c("_setAccount",3,function(b){a.p=b});a.ge=c("_setNamespace",48,function(a){j.o=a?P(a):k});a.Bd=c("_getVersion",60,function(){return ia});a.Kd=c("_setAutoTrackOutbound",79,Ba);a.le=
+c("_setTrackOutboundSubdomains",81,Ba);a.be=c("_setHrefExamineLimit",80,Ba);a.he=c("_setReferrerOverride",49,function(b){a.ab=b});a.Wd=c("_setCookiePersistence",24,function(b){a.tc(b)});a.tc=c("_setVisitorCookieTimeout",28,function(a){j.s=a})};var Ra=function(){var d=this,f=sa(d);d.Ab=!1;d.Ib={};d.bd=0;d._gasoDomain=k;d._gasoCPath=k;d.ve=f("_getTracker",0,function(b,f){return d.za(b,k,f)});d.za=f("_createTracker",55,function(b,d,e){d&&K(23);e&&K(67);d==k&&(d="~"+V.bd++);return V.Ib[d]=new Qa(d,b,e)});d.Hb=f("_getTrackerByName",51,function(b){b=b||"";return V.Ib[b]||V.za(k,b)});d.pb=function(){var b=L.Vc();return b&&b[ka]&&b[ka]()};d.ue=f("_anonymizeIp",16,function(){d.Ab=!0})};var Ta=function(){var d=this,f=sa(d);d.xe=f("_createAsyncTracker",33,function(b,d){return V.za(b,d||"")});d.ye=f("_getAsyncTracker",34,function(b){return V.Hb(b)});d.push=function(){K(5);for(var b=arguments,d=0,e=0;e<b[v];e++)try{if(typeof b[e]==="function")b[e]();else{var f="",g=b[e][0],a=g.lastIndexOf(".");a>0&&(f=g[z](0,a),g=g[z](a+1));var c=f==ga?V:f==ha?Sa:V.Hb(f);c[g].apply(c,b[e].slice(1))}}catch(u){d++}return d}};var V=new Ra;var Ua=L[t][ga];Ua&&typeof Ua._getTracker=="function"?V=Ua:L[t][ga]=V;var Sa=new Ta;a:{var Va=L[t][ha],Wa=!1;if(Va&&typeof Va[ba]=="function"&&(Wa=ua(Va),!Wa))break a;L[t][ha]=Sa;Wa&&Sa[ba].apply(Sa,Va)};})();
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/green5x5.png b/profiles/commons/libraries/modernizr/test/caniuse_files/green5x5.png
new file mode 100644
index 0000000..1825547
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/green5x5.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/hashchange.html b/profiles/commons/libraries/modernizr/test/caniuse_files/hashchange.html
new file mode 100644
index 0000000..ad95f69
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/hashchange.html
@@ -0,0 +1,16 @@
+<!DOCTYPE html>
+<html>
+<head>
+	<meta charset="utf-8" />
+	<title>hashchange test</title>
+</head>
+<body style="background:red;overflow:hidden;">
+<script>
+addEventListener('hashchange', function() {
+	document.body.style.background = 'lime';
+}, false);
+
+location.hash = Math.random();
+</script>
+</body>
+</html>
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/jquery.min.js b/profiles/commons/libraries/modernizr/test/caniuse_files/jquery.min.js
new file mode 100644
index 0000000..b2ac174
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/jquery.min.js
@@ -0,0 +1,18 @@
+/*!
+ * jQuery JavaScript Library v1.6.1
+ * http://jquery.com/
+ *
+ * Copyright 2011, John Resig
+ * Dual licensed under the MIT or GPL Version 2 licenses.
+ * http://jquery.org/license
+ *
+ * Includes Sizzle.js
+ * http://sizzlejs.com/
+ * Copyright 2011, The Dojo Foundation
+ * Released under the MIT, BSD, and GPL Licenses.
+ *
+ * Date: Thu May 12 15:04:36 2011 -0400
+ */
+(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}function cv(a){if(!cj[a]){var b=f("<"+a+">").appendTo("body"),d=b.css("display");b.remove();if(d==="none"||d===""){ck||(ck=c.createElement("iframe"),ck.frameBorder=ck.width=ck.height=0),c.body.appendChild(ck);if(!cl||!ck.createElement)cl=(ck.contentWindow||ck.contentDocument).document,cl.write("<!doctype><html><body></body></html>");b=cl.createElement(a),cl.body.appendChild(b),d=f.css(b,"display"),c.body.removeChild(ck)}cj[a]=d}return cj[a]}function cu(a,b){var c={};f.each(cp.concat.apply([],cp.slice(0,b)),function(){c[this]=a});return c}function ct(){cq=b}function cs(){setTimeout(ct,0);return cq=f.now()}function ci(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function ch(){try{return new a.XMLHttpRequest}catch(b){}}function cb(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1)for(h in a.converters)typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h]);l=k,k=d[g];if(k==="*")k=l;else if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))}}return c}function ca(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g)i in d&&(c[g[i]]=d[i]);while(f[0]==="*")f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"));if(h)for(i in e)if(e[i]&&e[i].test(h)){f.unshift(i);break}if(f[0]in d)j=f[0];else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function b_(a,b,c,d){if(f.isArray(b))f.each(b,function(b,e){c||bF.test(a)?d(a,e):b_(a+"["+(typeof e=="object"||f.isArray(e)?b:"")+"]",e,c,d)});else if(!c&&b!=null&&typeof b=="object")for(var e in b)b_(a+"["+e+"]",b[e],c,d);else d(a,b)}function b$(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h=a[f],i=0,j=h?h.length:0,k=a===bU,l;for(;i<j&&(k||!l);i++)l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=b$(a,c,d,e,l,g)));(k||!l)&&!g["*"]&&(l=b$(a,c,d,e,"*",g));return l}function bZ(a){return function(b,c){typeof b!="string"&&(c=b,b="*");if(f.isFunction(c)){var d=b.toLowerCase().split(bQ),e=0,g=d.length,h,i,j;for(;e<g;e++)h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)}}}function bD(a,b,c){var d=b==="width"?bx:by,e=b==="width"?a.offsetWidth:a.offsetHeight;if(c==="border")return e;f.each(d,function(){c||(e-=parseFloat(f.css(a,"padding"+this))||0),c==="margin"?e+=parseFloat(f.css(a,"margin"+this))||0:e-=parseFloat(f.css(a,"border"+this+"Width"))||0});return e}function bn(a,b){b.src?f.ajax({url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)}function bm(a){f.nodeName(a,"input")?bl(a):a.getElementsByTagName&&f.grep(a.getElementsByTagName("input"),bl)}function bl(a){if(a.type==="checkbox"||a.type==="radio")a.defaultChecked=a.checked}function bk(a){return"getElementsByTagName"in a?a.getElementsByTagName("*"):"querySelectorAll"in a?a.querySelectorAll("*"):[]}function bj(a,b){var c;if(b.nodeType===1){b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase();if(c==="object")b.outerHTML=a.outerHTML;else if(c!=="input"||a.type!=="checkbox"&&a.type!=="radio"){if(c==="option")b.selected=a.defaultSelected;else if(c==="input"||c==="textarea")b.defaultValue=a.defaultValue}else a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value);b.removeAttribute(f.expando)}}function bi(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c=f.expando,d=f.data(a),e=f.data(b,d);if(d=d[c]){var g=d.events;e=e[c]=f.extend({},d);if(g){delete e.handle,e.events={};for(var h in g)for(var i=0,j=g[h].length;i<j;i++)f.event.add(b,h+(g[h][i].namespace?".":"")+g[h][i].namespace,g[h][i],g[h][i].data)}}}}function bh(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function X(a,b,c){b=b||0;if(f.isFunction(b))return f.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return f.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1});if(S.test(b))return f.filter(b,d,!c);b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c})}function W(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function O(a,b){return(a&&a!=="*"?a+".":"")+b.replace(A,"`").replace(B,"&")}function N(a){var b,c,d,e,g,h,i,j,k,l,m,n,o,p=[],q=[],r=f._data(this,"events");if(!(a.liveFired===this||!r||!r.live||a.target.disabled||a.button&&a.type==="click")){a.namespace&&(n=new RegExp("(^|\\.)"+a.namespace.split(".").join("\\.(?:.*\\.)?")+"(\\.|$)")),a.liveFired=this;var s=r.live.slice(0);for(i=0;i<s.length;i++)g=s[i],g.origType.replace(y,"")===a.type?q.push(g.selector):s.splice(i--,1);e=f(a.target).closest(q,a.currentTarget);for(j=0,k=e.length;j<k;j++){m=e[j];for(i=0;i<s.length;i++){g=s[i];if(m.selector===g.selector&&(!n||n.test(g.namespace))&&!m.elem.disabled){h=m.elem,d=null;if(g.preType==="mouseenter"||g.preType==="mouseleave")a.type=g.preType,d=f(a.relatedTarget).closest(g.selector)[0],d&&f.contains(h,d)&&(d=h);(!d||d!==h)&&p.push({elem:h,handleObj:g,level:m.level})}}}for(j=0,k=p.length;j<k;j++){e=p[j];if(c&&e.level>c)break;a.currentTarget=e.elem,a.data=e.handleObj.data,a.handleObj=e.handleObj,o=e.handleObj.origHandler.apply(e.elem,arguments);if(o===!1||a.isPropagationStopped()){c=e.level,o===!1&&(b=!1);if(a.isImmediatePropagationStopped())break}}return b}}function L(a,c,d){var e=f.extend({},d[0]);e.type=a,e.originalEvent={},e.liveFired=b,f.event.handle.call(c,e),e.isDefaultPrevented()&&d[0].preventDefault()}function F(){return!0}function E(){return!1}function m(a,c,d){var e=c+"defer",g=c+"queue",h=c+"mark",i=f.data(a,e,b,!0);i&&(d==="queue"||!f.data(a,g,b,!0))&&(d==="mark"||!f.data(a,h,b,!0))&&setTimeout(function(){!f.data(a,g,b,!0)&&!f.data(a,h,b,!0)&&(f.removeData(a,e,!0),i.resolve())},0)}function l(a){for(var b in a)if(b!=="toJSON")return!1;return!0}function k(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(j,"$1-$2").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNaN(d)?i.test(d)?f.parseJSON(d):d:parseFloat(d)}catch(g){}f.data(a,c,d)}else d=b}return d}var c=a.document,d=a.navigator,e=a.location,f=function(){function H(){if(!e.isReady){try{c.documentElement.doScroll("left")}catch(a){setTimeout(H,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/\d/,n=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,o=/^[\],:{}\s]*$/,p=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,q=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,r=/(?:^|:|,)(?:\s*\[)+/g,s=/(webkit)[ \/]([\w.]+)/,t=/(opera)(?:.*version)?[ \/]([\w.]+)/,u=/(msie) ([\w.]+)/,v=/(mozilla)(?:.*? rv:([\w.]+))?/,w=d.userAgent,x,y,z,A=Object.prototype.toString,B=Object.prototype.hasOwnProperty,C=Array.prototype.push,D=Array.prototype.slice,E=String.prototype.trim,F=Array.prototype.indexOf,G={};e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a)return this;if(a.nodeType){this.context=this[0]=a,this.length=1;return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=n.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2])return f.find(a);this.length=1,this[0]=h}this.context=c,this.selector=a;return this}return!d||d.jquery?(d||f).find(a):this.constructor(d).find(a)}if(e.isFunction(a))return f.ready(a);a.selector!==b&&(this.selector=a.selector,this.context=a.context);return e.makeArray(a,this)},selector:"",jquery:"1.6.1",length:0,size:function(){return this.length},toArray:function(){return D.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();e.isArray(a)?C.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),y.done(a);return this},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(D.apply(this,arguments),"slice",D.call(arguments).join(","))},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:C,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);for(;j<k;j++)if((a=arguments[j])!=null)for(c in a){d=i[c],f=a[c];if(i===f)continue;l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body)return setTimeout(e.ready,1);e.isReady=!0;if(a!==!0&&--e.readyWait>0)return;y.resolveWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").unbind("ready")}},bindReady:function(){if(!y){y=e._Deferred();if(c.readyState==="complete")return setTimeout(e.ready,1);if(c.addEventListener)c.addEventListener("DOMContentLoaded",z,!1),a.addEventListener("load",e.ready,!1);else if(c.attachEvent){c.attachEvent("onreadystatechange",z),a.attachEvent("onload",e.ready);var b=!1;try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&H()}}},isFunction:function(a){return e.type(a)==="function"},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a&&typeof a=="object"&&"setInterval"in a},isNaN:function(a){return a==null||!m.test(a)||isNaN(a)},type:function(a){return a==null?String(a):G[A.call(a)]||"object"},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a))return!1;if(a.constructor&&!B.call(a,"constructor")&&!B.call(a.constructor.prototype,"isPrototypeOf"))return!1;var c;for(c in a);return c===b||B.call(a,c)},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw a},parseJSON:function(b){if(typeof b!="string"||!b)return null;b=e.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(o.test(b.replace(p,"@").replace(q,"]").replace(r,"")))return(new Function("return "+b))();e.error("Invalid JSON: "+b)},parseXML:function(b,c,d){a.DOMParser?(d=new DOMParser,c=d.parseFromString(b,"text/xml")):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b)),d=c.documentElement,(!d||!d.nodeName||d.nodeName==="parsererror")&&e.error("Invalid XML: "+b);return c},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a)if(c.apply(a[f],d)===!1)break}else for(;g<h;)if(c.apply(a[g++],d)===!1)break}else if(i){for(f in a)if(c.call(a[f],f,a[f])===!1)break}else for(;g<h;)if(c.call(a[g],g,a[g++])===!1)break;return a},trim:E?function(a){return a==null?"":E.call(a)}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?C.call(c,a):e.merge(c,a)}return c},inArray:function(a,b){if(F)return F.call(b,a);for(var c=0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number")for(var f=c.length;e<f;e++)a[d++]=c[e];else while(c[e]!==b)a[d++]=c[e++];a.length=d;return a},grep:function(a,b,c){var d=[],e;c=!!c;for(var f=0,g=a.length;f<g;f++)e=!!b(a[f],f),c!==e&&d.push(a[f]);return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));if(k)for(;i<j;i++)f=c(a[i],i,d),f!=null&&(h[h.length]=f);else for(g in a)f=c(a[g],g,d),f!=null&&(h[h.length]=f);return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a))return b;var f=D.call(arguments,2),g=function(){return a.apply(c,f.concat(D.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;return g},access:function(a,c,d,f,g,h){var i=a.length;if(typeof c=="object"){for(var j in c)e.access(a,j,c[j],f,g,d);return a}if(d!==b){f=!h&&f&&e.isFunction(d);for(var k=0;k<i;k++)g(a[k],c,f?d.call(a[k],k,g(a[k],c)):d,h);return a}return i?g(a[0],c):b},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=s.exec(a)||t.exec(a)||u.exec(a)||a.indexOf("compatible")<0&&v.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){G["[object "+b+"]"]=b.toLowerCase()}),x=e.uaMatch(w),x.browser&&(e.browser[x.browser]=!0,e.browser.version=x.version),e.browser.webkit&&(e.browser.safari=!0),j.test("")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?z=function(){c.removeEventListener("DOMContentLoaded",z,!1),e.ready()}:c.attachEvent&&(z=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",z),e.ready())});return e}(),g="done fail isResolved isRejected promise then always pipe".split(" "),h=[].slice;f.extend({_Deferred:function(){var a=[],b,c,d,e={done:function(){if(!d){var c=arguments,g,h,i,j,k;b&&(k=b,b=0);for(g=0,h=c.length;g<h;g++)i=c[g],j=f.type(i),j==="array"?e.done.apply(e,i):j==="function"&&a.push(i);k&&e.resolveWith(k[0],k[1])}return this},resolveWith:function(e,f){if(!d&&!b&&!c){f=f||[],c=1;try{while(a[0])a.shift().apply(e,f)}finally{b=[e,f],c=0}}return this},resolve:function(){e.resolveWith(this,arguments);return this},isResolved:function(){return!!c||!!b},cancel:function(){d=1,a=[];return this}};return e},Deferred:function(a){var b=f._Deferred(),c=f._Deferred(),d;f.extend(b,{then:function(a,c){b.done(a).fail(c);return this},always:function(){return b.done.apply(b,arguments).fail.apply(this,arguments)},fail:c.done,rejectWith:c.resolveWith,reject:c.resolve,isRejected:c.isResolved,pipe:function(a,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[c,"reject"]},function(a,c){var e=c[0],g=c[1],h;f.isFunction(e)?b[a](function(){h=e.apply(this,arguments),h&&f.isFunction(h.promise)?h.promise().then(d.resolve,d.reject):d[g](h)}):b[a](d[g])})}).promise()},promise:function(a){if(a==null){if(d)return d;d=a={}}var c=g.length;while(c--)a[g[c]]=b[g[c]];return a}}),b.done(c.cancel).fail(b.cancel),delete b.cancel,a&&a.call(b,b);return b},when:function(a){function i(a){return function(c){b[a]=arguments.length>1?h.call(arguments,0):c,--e||g.resolveWith(g,h.call(b,0))}}var b=arguments,c=0,d=b.length,e=d,g=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred();if(d>1){for(;c<d;c++)b[c]&&f.isFunction(b[c].promise)?b[c].promise().then(i(c),g.reject):--e;e||g.resolveWith(g,b)}else g!==a&&g.resolveWith(g,d?[a]:[]);return g.promise()}}),f.support=function(){var a=c.createElement("div"),b=c.documentElement,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;a.setAttribute("className","t"),a.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=a.getElementsByTagName("*"),e=a.getElementsByTagName("a")[0];if(!d||!d.length||!e)return{};f=c.createElement("select"),g=f.appendChild(c.createElement("option")),h=a.getElementsByTagName("input")[0],j={leadingWhitespace:a.firstChild.nodeType===3,tbody:!a.getElementsByTagName("tbody").length,htmlSerialize:!!a.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55$/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:h.value==="on",optSelected:g.selected,getSetAttribute:a.className!=="t",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0},h.checked=!0,j.noCloneChecked=h.cloneNode(!0).checked,f.disabled=!0,j.optDisabled=!g.disabled;try{delete a.test}catch(s){j.deleteExpando=!1}!a.addEventListener&&a.attachEvent&&a.fireEvent&&(a.attachEvent("onclick",function b(){j.noCloneEvent=!1,a.detachEvent("onclick",b)}),a.cloneNode(!0).fireEvent("onclick")),h=c.createElement("input"),h.value="t",h.setAttribute("type","radio"),j.radioValue=h.value==="t",h.setAttribute("checked","checked"),a.appendChild(h),k=c.createDocumentFragment(),k.appendChild(a.firstChild),j.checkClone=k.cloneNode(!0).cloneNode(!0).lastChild.checked,a.innerHTML="",a.style.width=a.style.paddingLeft="1px",l=c.createElement("body"),m={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"};for(q in m)l.style[q]=m[q];l.appendChild(a),b.insertBefore(l,b.firstChild),j.appendChecked=h.checked,j.boxModel=a.offsetWidth===2,"zoom"in a.style&&(a.style.display="inline",a.style.zoom=1,j.inlineBlockNeedsLayout=a.offsetWidth===2,a.style.display="",a.innerHTML="<div style='width:4px;'></div>",j.shrinkWrapBlocks=a.offsetWidth!==2),a.innerHTML="<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>",n=a.getElementsByTagName("td"),r=n[0].offsetHeight===0,n[0].style.display="",n[1].style.display="none",j.reliableHiddenOffsets=r&&n[0].offsetHeight===0,a.innerHTML="",c.defaultView&&c.defaultView.getComputedStyle&&(i=c.createElement("div"),i.style.width="0",i.style.marginRight="0",a.appendChild(i),j.reliableMarginRight=(parseInt((c.defaultView.getComputedStyle(i,null)||{marginRight:0}).marginRight,10)||0)===0),l.innerHTML="",b.removeChild(l);if(a.attachEvent)for(q in{submit:1,change:1,focusin:1})p="on"+q,r=p in a,r||(a.setAttribute(p,"return;"),r=typeof a[p]=="function"),j[q+"Bubbles"]=r;return j}(),f.boxModel=f.support.boxModel;var i=/^(?:\{.*\}|\[.*\])$/,j=/([a-z])([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];return!!a&&!l(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g=f.expando,h=typeof c=="string",i,j=a.nodeType,k=j?f.cache:a,l=j?a[f.expando]:a[f.expando]&&f.expando;if((!l||e&&l&&!k[l][g])&&h&&d===b)return;l||(j?a[f.expando]=l=++f.uuid:l=f.expando),k[l]||(k[l]={},j||(k[l].toJSON=f.noop));if(typeof c=="object"||typeof c=="function")e?k[l][g]=f.extend(k[l][g],c):k[l]=f.extend(k[l],c);i=k[l],e&&(i[g]||(i[g]={}),i=i[g]),d!==b&&(i[f.camelCase(c)]=d);if(c==="events"&&!i[c])return i[g]&&i[g].events;return h?i[f.camelCase(c)]:i}},removeData:function(b,c,d){if(!!f.acceptData(b)){var e=f.expando,g=b.nodeType,h=g?f.cache:b,i=g?b[f.expando]:f.expando;if(!h[i])return;if(c){var j=d?h[i][e]:h[i];if(j){delete j[c];if(!l(j))return}}if(d){delete h[i][e];if(!l(h[i]))return}var k=h[i][e];f.support.deleteExpando||h!=a?delete h[i]:h[i]=null,k?(h[i]={},g||(h[i].toJSON=f.noop),h[i][e]=k):g&&(f.support.deleteExpando?delete b[f.expando]:b.removeAttribute?b.removeAttribute(f.expando):b[f.expando]=null)}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),f.fn.extend({data:function(a,c){var d=null;if(typeof a=="undefined"){if(this.length){d=f.data(this[0]);if(this[0].nodeType===1){var e=this[0].attributes,g;for(var h=0,i=e.length;h<i;h++)g=e[h].name,g.indexOf("data-")===0&&(g=f.camelCase(g.substring(5)),k(this[0],g,d[g]))}}return d}if(typeof a=="object")return this.each(function(){f.data(this,a)});var j=a.split(".");j[1]=j[1]?"."+j[1]:"";if(c===b){d=this.triggerHandler("getData"+j[1]+"!",[j[0]]),d===b&&this.length&&(d=f.data(this[0],a),d=k(this[0],a,d));return d===b&&j[1]?this.data(j[0]):d}return this.each(function(){var b=f(this),d=[j[0],c];b.triggerHandler("setData"+j[1]+"!",d),f.data(this,a,c),b.triggerHandler("changeData"+j[1]+"!",d)})},removeData:function(a){return this.each(function(){f.removeData(this,a)})}}),f.extend({_mark:function(a,c){a&&(c=(c||"fx")+"mark",f.data(a,c,(f.data(a,c,b,!0)||0)+1,!0))},_unmark:function(a,c,d){a!==!0&&(d=c,c=a,a=!1);if(c){d=d||"fx";var e=d+"mark",g=a?0:(f.data(c,e,b,!0)||1)-1;g?f.data(c,e,g,!0):(f.removeData(c,e,!0),m(c,d,"mark"))}},queue:function(a,c,d){if(a){c=(c||"fx")+"queue";var e=f.data(a,c,b,!0);d&&(!e||f.isArray(d)?e=f.data(a,c,f.makeArray(d),!0):e.push(d));return e||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e;d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),d.call(a,function(){f.dequeue(a,b)})),c.length||(f.removeData(a,b+"queue",!0),m(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){typeof a!="string"&&(c=a,a="fx");if(c===b)return f.queue(this[0],a);return this.each(function(){var b=f.queue(this,a,c);a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(){var c=this;setTimeout(function(){f.dequeue(c,b)},a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;while(g--)if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f._Deferred(),!0))h++,l.done(m);m();return d.promise()}});var n=/[\n\t\r]/g,o=/\s+/,p=/\r/g,q=/^(?:button|input)$/i,r=/^(?:button|input|object|select|textarea)$/i,s=/^a(?:rea)?$/i,t=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,u=/\:/,v,w;f.fn.extend({attr:function(a,b){return f.access(this,a,b,!0,f.attr)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)})},prop:function(a,b){return f.access(this,a,b,!0,f.prop)},removeProp:function(a){a=f.propFix[a]||a;return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.addClass(a.call(this,b,c.attr("class")||""))});if(a&&typeof a=="string"){var b=(a||"").split(o);for(var c=0,d=this.length;c<d;c++){var e=this[c];if(e.nodeType===1)if(!e.className)e.className=a;else{var g=" "+e.className+" ",h=e.className;for(var i=0,j=b.length;i<j;i++)g.indexOf(" "+b[i]+" ")<0&&(h+=" "+b[i]);e.className=f.trim(h)}}}return this},removeClass:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.removeClass(a.call(this,b,c.attr("class")))});if(a&&typeof a=="string"||a===b){var c=(a||"").split(o);for(var d=0,e=this.length;d<e;d++){var g=this[d];if(g.nodeType===1&&g.className)if(a){var h=(" "+g.className+" ").replace(n," ");for(var i=0,j=c.length;i<j;i++)h=h.replace(" "+c[i]+" "," ");g.className=f.trim(h)}else g.className=""}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a))return this.each(function(c){var d=f(this);d.toggleClass(a.call(this,c,d.attr("class"),b),b)});return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(o);while(e=j[g++])i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ";for(var c=0,d=this.length;c<d;c++)if((" "+this[c].className+" ").replace(n," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e=this[0];if(!arguments.length){if(e){c=f.valHooks[e.nodeName.toLowerCase()]||f.valHooks[e.type];if(c&&"get"in c&&(d=c.get(e,"value"))!==b)return d;return(e.value||"").replace(p,"")}return b}var g=f.isFunction(a);return this.each(function(d){var e=f(this),h;if(this.nodeType===1){g?h=a.call(this,d,e.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""})),c=f.valHooks[this.nodeName.toLowerCase()]||f.valHooks[this.type];if(!c||!("set"in c)||c.set(this,h,"value")===b)this.value=h}})}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c=a.selectedIndex,d=[],e=a.options,g=a.type==="select-one";if(c<0)return null;for(var h=g?c:0,i=g?c+1:e.length;h<i;h++){var j=e[h];if(j.selected&&(f.support.optDisabled?!j.disabled:j.getAttribute("disabled")===null)&&(!j.parentNode.disabled||!f.nodeName(j.parentNode,"optgroup"))){b=f(j).val();if(g)return b;d.push(b)}}if(g&&!d.length&&e.length)return f(e[c]).val();return d},set:function(a,b){var c=f.makeArray(b);f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attrFix:{tabindex:"tabIndex"},attr:function(a,c,d,e){var g=a.nodeType;if(!a||g===3||g===8||g===2)return b;if(e&&c in f.attrFn)return f(a)[c](d);if(!("getAttribute"in a))return f.prop(a,c,d);var h,i,j=g!==1||!f.isXMLDoc(a);c=j&&f.attrFix[c]||c,i=f.attrHooks[c],i||(!t.test(c)||typeof d!="boolean"&&d!==b&&d.toLowerCase()!==c.toLowerCase()?v&&(f.nodeName(a,"form")||u.test(c))&&(i=v):i=w);if(d!==b){if(d===null){f.removeAttr(a,c);return b}if(i&&"set"in i&&j&&(h=i.set(a,d,c))!==b)return h;a.setAttribute(c,""+d);return d}if(i&&"get"in i&&j)return i.get(a,c);h=a.getAttribute(c);return h===null?b:h},removeAttr:function(a,b){var c;a.nodeType===1&&(b=f.attrFix[b]||b,f.support.getSetAttribute?a.removeAttribute(b):(f.attr(a,b,""),a.removeAttributeNode(a.getAttributeNode(b))),t.test(b)&&(c=f.propFix[b]||b)in a&&(a[c]=!1))},attrHooks:{type:{set:function(a,b){if(q.test(a.nodeName)&&a.parentNode)f.error("type property can't be changed");else if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);return b}}},tabIndex:{get:function(a){var c=a.getAttributeNode("tabIndex");return c&&c.specified?parseInt(c.value,10):r.test(a.nodeName)||s.test(a.nodeName)&&a.href?0:b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e=a.nodeType;if(!a||e===3||e===8||e===2)return b;var g,h,i=e!==1||!f.isXMLDoc(a);c=i&&f.propFix[c]||c,h=f.propHooks[c];return d!==b?h&&"set"in h&&(g=h.set(a,d,c))!==b?g:a[c]=d:h&&"get"in h&&(g=h.get(a,c))!==b?g:a[c]},propHooks:{}}),w={get:function(a,c){return a[f.propFix[c]||c]?c.toLowerCase():b},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=b),a.setAttribute(c,c.toLowerCase()));return c}},f.attrHooks.value={get:function(a,b){if(v&&f.nodeName(a,"button"))return v.get(a,b);return a.value},set:function(a,b,c){if(v&&f.nodeName(a,"button"))return v.set(a,b,c);a.value=b}},f.support.getSetAttribute||(f.attrFix=f.propFix,v=f.attrHooks.name=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);return d&&d.nodeValue!==""?d.nodeValue:b},set:function(a,b,c){var d=a.getAttributeNode(c);if(d){d.nodeValue=b;return b}}},f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");return c}}})})),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}})),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b))return a.checked=f.inArray(f(a).val(),b)>=0}})});var x=Object.prototype.hasOwnProperty,y=/\.(.*)$/,z=/^(?:textarea|input|select)$/i,A=/\./g,B=/ /g,C=/[^\w\s.|`]/g,D=function(a){return a.replace(C,"\\$&")};f.event={add:function(a,c,d,e){if(a.nodeType!==3&&a.nodeType!==8){if(d===!1)d=E;else if(!d)return;var g,h;d.handler&&(g=d,d=g.handler),d.guid||(d.guid=f.guid++);var i=f._data(a);if(!i)return;var j=i.events,k=i.handle;j||(i.events=j={}),k||(i.handle=k=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.handle.apply(k.elem,arguments):b}),k.elem=a,c=c.split(" ");var l,m=0,n;while(l=c[m++]){h=g?f.extend({},g):{handler:d,data:e},l.indexOf(".")>-1?(n=l.split("."),l=n.shift(),h.namespace=n.slice(0).sort().join(".")):(n=[],h.namespace=""),h.type=l,h.guid||(h.guid=d.guid);var o=j[l],p=f.event.special[l]||{};if(!o){o=j[l]=[];if(!p.setup||p.setup.call(a,e,n,k)===!1)a.addEventListener?a.addEventListener(l,k,!1):a.attachEvent&&a.attachEvent("on"+l,k)}p.add&&(p.add.call(a,h),h.handler.guid||(h.handler.guid=d.guid)),o.push(h),f.event.global[l]=!0}a=null}},global:{},remove:function(a,c,d,e){if(a.nodeType!==3&&a.nodeType!==8){d===!1&&(d=E);var g,h,i,j,k=0,l,m,n,o,p,q,r,s=f.hasData(a)&&f._data(a),t=s&&s.events;if(!s||!t)return;c&&c.type&&(d=c.handler,c=c.type);if(!c||typeof c=="string"&&c.charAt(0)==="."){c=c||"";for(h in t)f.event.remove(a,h+c);return}c=c.split(" ");while(h=c[k++]){r=h,q=null,l=h.indexOf(".")<0,m=[],l||(m=h.split("."),h=m.shift(),n=new RegExp("(^|\\.)"+f.map(m.slice(0).sort(),D).join("\\.(?:.*\\.)?")+"(\\.|$)")),p=t[h];if(!p)continue;if(!d){for(j=0;j<p.length;j++){q=p[j];if(l||n.test(q.namespace))f.event.remove(a,r,q.handler,j),p.splice(j--,1)}continue}o=f.event.special[h]||{};for(j=e||0;j<p.length;j++){q=p[j];if(d.guid===q.guid){if(l||n.test(q.namespace))e==null&&p.splice(j--,1),o.remove&&o.remove.call(a,q);if(e!=null)break}}if(p.length===0||e!=null&&p.length===1)(!o.teardown||o.teardown.call(a,m)===!1)&&f.removeEvent(a,h,s.handle),g=null,delete t[h]}if(f.isEmptyObject(t)){var u=s.handle;u&&(u.elem=null),delete s.events,delete s.handle,f.isEmptyObject(s)&&f.removeData(a,b,!0)}}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){var h=c.type||c,i=[],j;h.indexOf("!")>=0&&(h=h.slice(0,-1),j=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());if(!!e&&!f.event.customEvent[h]||!!f.event.global[h]){c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.exclusive=j,c.namespace=i.join("."),c.namespace_re=new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)");if(g||!e)c.preventDefault(),c.stopPropagation();if(!e){f.each(f.cache,function(){var a=f.expando,b=this[a];b&&b.events&&b.events[h]&&f.event.trigger(c,d,b.handle.elem
+)});return}if(e.nodeType===3||e.nodeType===8)return;c.result=b,c.target=e,d=d?f.makeArray(d):[],d.unshift(c);var k=e,l=h.indexOf(":")<0?"on"+h:"";do{var m=f._data(k,"handle");c.currentTarget=k,m&&m.apply(k,d),l&&f.acceptData(k)&&k[l]&&k[l].apply(k,d)===!1&&(c.result=!1,c.preventDefault()),k=k.parentNode||k.ownerDocument||k===c.target.ownerDocument&&a}while(k&&!c.isPropagationStopped());if(!c.isDefaultPrevented()){var n,o=f.event.special[h]||{};if((!o._default||o._default.call(e.ownerDocument,c)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)){try{l&&e[h]&&(n=e[l],n&&(e[l]=null),f.event.triggered=h,e[h]())}catch(p){}n&&(e[l]=n),f.event.triggered=b}}return c.result}},handle:function(c){c=f.event.fix(c||a.event);var d=((f._data(this,"events")||{})[c.type]||[]).slice(0),e=!c.exclusive&&!c.namespace,g=Array.prototype.slice.call(arguments,0);g[0]=c,c.currentTarget=this;for(var h=0,i=d.length;h<i;h++){var j=d[h];if(e||c.namespace_re.test(j.namespace)){c.handler=j.handler,c.data=j.data,c.handleObj=j;var k=j.handler.apply(this,g);k!==b&&(c.result=k,k===!1&&(c.preventDefault(),c.stopPropagation()));if(c.isImmediatePropagationStopped())break}}return c.result},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),fix:function(a){if(a[f.expando])return a;var d=a;a=f.Event(d);for(var e=this.props.length,g;e;)g=this.props[--e],a[g]=d[g];a.target||(a.target=a.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),!a.relatedTarget&&a.fromElement&&(a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement);if(a.pageX==null&&a.clientX!=null){var h=a.target.ownerDocument||c,i=h.documentElement,j=h.body;a.pageX=a.clientX+(i&&i.scrollLeft||j&&j.scrollLeft||0)-(i&&i.clientLeft||j&&j.clientLeft||0),a.pageY=a.clientY+(i&&i.scrollTop||j&&j.scrollTop||0)-(i&&i.clientTop||j&&j.clientTop||0)}a.which==null&&(a.charCode!=null||a.keyCode!=null)&&(a.which=a.charCode!=null?a.charCode:a.keyCode),!a.metaKey&&a.ctrlKey&&(a.metaKey=a.ctrlKey),!a.which&&a.button!==b&&(a.which=a.button&1?1:a.button&2?3:a.button&4?2:0);return a},guid:1e8,proxy:f.proxy,special:{ready:{setup:f.bindReady,teardown:f.noop},live:{add:function(a){f.event.add(this,O(a.origType,a.selector),f.extend({},a,{handler:N,guid:a.handler.guid}))},remove:function(a){f.event.remove(this,O(a.origType,a.selector),a)}},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}}},f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!this.preventDefault)return new f.Event(a,b);a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?F:E):this.type=a,b&&f.extend(this,b),this.timeStamp=f.now(),this[f.expando]=!0},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=F;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=F;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=F,this.stopPropagation()},isDefaultPrevented:E,isPropagationStopped:E,isImmediatePropagationStopped:E};var G=function(a){var b=a.relatedTarget;a.type=a.data;try{if(b&&b!==c&&!b.parentNode)return;while(b&&b!==this)b=b.parentNode;b!==this&&f.event.handle.apply(this,arguments)}catch(d){}},H=function(a){a.type=a.data,f.event.handle.apply(this,arguments)};f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={setup:function(c){f.event.add(this,b,c&&c.selector?H:G,a)},teardown:function(a){f.event.remove(this,b,a&&a.selector?H:G)}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(a,b){if(!f.nodeName(this,"form"))f.event.add(this,"click.specialSubmit",function(a){var b=a.target,c=b.type;(c==="submit"||c==="image")&&f(b).closest("form").length&&L("submit",this,arguments)}),f.event.add(this,"keypress.specialSubmit",function(a){var b=a.target,c=b.type;(c==="text"||c==="password")&&f(b).closest("form").length&&a.keyCode===13&&L("submit",this,arguments)});else return!1},teardown:function(a){f.event.remove(this,".specialSubmit")}});if(!f.support.changeBubbles){var I,J=function(a){var b=a.type,c=a.value;b==="radio"||b==="checkbox"?c=a.checked:b==="select-multiple"?c=a.selectedIndex>-1?f.map(a.options,function(a){return a.selected}).join("-"):"":f.nodeName(a,"select")&&(c=a.selectedIndex);return c},K=function(c){var d=c.target,e,g;if(!!z.test(d.nodeName)&&!d.readOnly){e=f._data(d,"_change_data"),g=J(d),(c.type!=="focusout"||d.type!=="radio")&&f._data(d,"_change_data",g);if(e===b||g===e)return;if(e!=null||g)c.type="change",c.liveFired=b,f.event.trigger(c,arguments[1],d)}};f.event.special.change={filters:{focusout:K,beforedeactivate:K,click:function(a){var b=a.target,c=f.nodeName(b,"input")?b.type:"";(c==="radio"||c==="checkbox"||f.nodeName(b,"select"))&&K.call(this,a)},keydown:function(a){var b=a.target,c=f.nodeName(b,"input")?b.type:"";(a.keyCode===13&&!f.nodeName(b,"textarea")||a.keyCode===32&&(c==="checkbox"||c==="radio")||c==="select-multiple")&&K.call(this,a)},beforeactivate:function(a){var b=a.target;f._data(b,"_change_data",J(b))}},setup:function(a,b){if(this.type==="file")return!1;for(var c in I)f.event.add(this,c+".specialChange",I[c]);return z.test(this.nodeName)},teardown:function(a){f.event.remove(this,".specialChange");return z.test(this.nodeName)}},I=f.event.special.change.filters,I.focus=I.beforeactivate}f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){function e(a){var c=f.event.fix(a);c.type=b,c.originalEvent={},f.event.trigger(c,null,c.target),c.isDefaultPrevented()&&a.preventDefault()}var d=0;f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)}}}),f.each(["bind","one"],function(a,c){f.fn[c]=function(a,d,e){var g;if(typeof a=="object"){for(var h in a)this[c](h,d,a[h],e);return this}if(arguments.length===2||d===!1)e=d,d=b;c==="one"?(g=function(a){f(this).unbind(a,g);return e.apply(this,arguments)},g.guid=e.guid||f.guid++):g=e;if(a==="unload"&&c!=="one")this.one(a,d,e);else for(var i=0,j=this.length;i<j;i++)f.event.add(this[i],a,g,d);return this}}),f.fn.extend({unbind:function(a,b){if(typeof a=="object"&&!a.preventDefault)for(var c in a)this.unbind(c,a[c]);else for(var d=0,e=this.length;d<e;d++)f.event.remove(this[d],a,b);return this},delegate:function(a,b,c,d){return this.live(b,c,d,a)},undelegate:function(a,b,c){return arguments.length===0?this.unbind("live"):this.die(b,null,c,a)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return f.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f.data(this,"lastToggle"+a.guid)||0)%d;f.data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var M={focus:"focusin",blur:"focusout",mouseenter:"mouseover",mouseleave:"mouseout"};f.each(["live","die"],function(a,c){f.fn[c]=function(a,d,e,g){var h,i=0,j,k,l,m=g||this.selector,n=g?this:f(this.context);if(typeof a=="object"&&!a.preventDefault){for(var o in a)n[c](o,d,a[o],m);return this}if(c==="die"&&!a&&g&&g.charAt(0)==="."){n.unbind(g);return this}if(d===!1||f.isFunction(d))e=d||E,d=b;a=(a||"").split(" ");while((h=a[i++])!=null){j=y.exec(h),k="",j&&(k=j[0],h=h.replace(y,""));if(h==="hover"){a.push("mouseenter"+k,"mouseleave"+k);continue}l=h,M[h]?(a.push(M[h]+k),h=h+k):h=(M[h]||h)+k;if(c==="live")for(var p=0,q=n.length;p<q;p++)f.event.add(n[p],"live."+O(h,m),{data:d,selector:m,handler:e,origType:h,origHandler:e,preType:l});else n.unbind("live."+O(h,m),e)}return this}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);return arguments.length>0?this.bind(b,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0)}),function(){function u(a,b,c,d,e,f){for(var g=0,h=d.length;g<h;g++){var i=d[g];if(i){var j=!1;i=i[a];while(i){if(i.sizcache===c){j=d[i.sizset];break}if(i.nodeType===1){f||(i.sizcache=c,i.sizset=g);if(typeof b!="string"){if(i===b){j=!0;break}}else if(k.filter(b,[i]).length>0){j=i;break}}i=i[a]}d[g]=j}}}function t(a,b,c,d,e,f){for(var g=0,h=d.length;g<h;g++){var i=d[g];if(i){var j=!1;i=i[a];while(i){if(i.sizcache===c){j=d[i.sizset];break}i.nodeType===1&&!f&&(i.sizcache=c,i.sizset=g);if(i.nodeName.toLowerCase()===b){j=i;break}i=i[a]}d[g]=j}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d=0,e=Object.prototype.toString,g=!1,h=!0,i=/\\/g,j=/\W/;[0,0].sort(function(){h=!1;return 0});var k=function(b,d,f,g){f=f||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9)return[];if(!b||typeof b!="string")return f;var i,j,n,o,q,r,s,t,u=!0,w=k.isXML(d),x=[],y=b;do{a.exec(""),i=a.exec(y);if(i){y=i[3],x.push(i[1]);if(i[2]){o=i[3];break}}}while(i);if(x.length>1&&m.exec(b))if(x.length===2&&l.relative[x[0]])j=v(x[0]+x[1],d);else{j=l.relative[x[0]]?[d]:k(x.shift(),d);while(x.length)b=x.shift(),l.relative[b]&&(b+=x.shift()),j=v(b,j)}else{!g&&x.length>1&&d.nodeType===9&&!w&&l.match.ID.test(x[0])&&!l.match.ID.test(x[x.length-1])&&(q=k.find(x.shift(),d,w),d=q.expr?k.filter(q.expr,q.set)[0]:q.set[0]);if(d){q=g?{expr:x.pop(),set:p(g)}:k.find(x.pop(),x.length===1&&(x[0]==="~"||x[0]==="+")&&d.parentNode?d.parentNode:d,w),j=q.expr?k.filter(q.expr,q.set):q.set,x.length>0?n=p(j):u=!1;while(x.length)r=x.pop(),s=r,l.relative[r]?s=x.pop():r="",s==null&&(s=d),l.relative[r](n,s,w)}else n=x=[]}n||(n=j),n||k.error(r||b);if(e.call(n)==="[object Array]")if(!u)f.push.apply(f,n);else if(d&&d.nodeType===1)for(t=0;n[t]!=null;t++)n[t]&&(n[t]===!0||n[t].nodeType===1&&k.contains(d,n[t]))&&f.push(j[t]);else for(t=0;n[t]!=null;t++)n[t]&&n[t].nodeType===1&&f.push(j[t]);else p(n,f);o&&(k(o,h,f,g),k.uniqueSort(f));return f};k.uniqueSort=function(a){if(r){g=h,a.sort(r);if(g)for(var b=1;b<a.length;b++)a[b]===a[b-1]&&a.splice(b--,1)}return a},k.matches=function(a,b){return k(a,null,null,b)},k.matchesSelector=function(a,b){return k(b,null,null,[a]).length>0},k.find=function(a,b,c){var d;if(!a)return[];for(var e=0,f=l.order.length;e<f;e++){var g,h=l.order[e];if(g=l.leftMatch[h].exec(a)){var j=g[1];g.splice(1,1);if(j.substr(j.length-1)!=="\\"){g[1]=(g[1]||"").replace(i,""),d=l.find[h](g,b,c);if(d!=null){a=a.replace(l.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);return{set:d,expr:a}},k.filter=function(a,c,d,e){var f,g,h=a,i=[],j=c,m=c&&c[0]&&k.isXML(c[0]);while(a&&c.length){for(var n in l.filter)if((f=l.leftMatch[n].exec(a))!=null&&f[2]){var o,p,q=l.filter[n],r=f[1];g=!1,f.splice(1,1);if(r.substr(r.length-1)==="\\")continue;j===i&&(i=[]);if(l.preFilter[n]){f=l.preFilter[n](f,j,d,i,e,m);if(!f)g=o=!0;else if(f===!0)continue}if(f)for(var s=0;(p=j[s])!=null;s++)if(p){o=q(p,f,s,j);var t=e^!!o;d&&o!=null?t?g=!0:j[s]=!1:t&&(i.push(p),g=!0)}if(o!==b){d||(j=i),a=a.replace(l.match[n],"");if(!g)return[];break}}if(a===h)if(g==null)k.error(a);else break;h=a}return j},k.error=function(a){throw"Syntax error, unrecognized expression: "+a};var l=k.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!j.test(b),e=c&&!d;d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++)if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1);a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b}e&&k.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!j.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;e++)c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b);d&&k.filter(b,a,!0)}},"":function(a,b,c){var e,f=d++,g=u;typeof b=="string"&&!j.test(b)&&(b=b.toLowerCase(),e=b,g=t),g("parentNode",b,f,a,e,c)},"~":function(a,b,c){var e,f=d++,g=u;typeof b=="string"&&!j.test(b)&&(b=b.toLowerCase(),e=b,g=t),g("previousSibling",b,f,a,e,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++)d[e].getAttribute("name")===a[1]&&c.push(d[e]);return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined")return b.getElementsByTagName(a[1])}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(i,"")+" ";if(f)return a;for(var g=0,h;(h=b[g])!=null;g++)h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1));return!1},ID:function(a){return a[1].replace(i,"")},TAG:function(a,b){return a[1].replace(i,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){a[2]||k.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else a[2]&&k.error(a[0]);a[0]=d++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(i,"");!f&&l.attrMap[g]&&(a[1]=l.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(i,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not")if((a.exec(b[3])||"").length>1||/^\w/.test(b[3]))b[3]=k(b[3],null,null,c);else{var g=k.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return!1}else if(l.match.POS.test(b[0])||l.match.CHILD.test(b[0]))return!0;return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;return a.selected===!0},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!k(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=l.filters[e];if(f)return f(a,c,b,d);if(e==="contains")return(a.textContent||a.innerText||k.getText([a])||"").indexOf(b[3])>=0;if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++)if(g[h]===a)return!1;return!0}k.error(e)},CHILD:function(a,b){var c=b[1],d=a;switch(c){case"only":case"first":while(d=d.previousSibling)if(d.nodeType===1)return!1;if(c==="first")return!0;d=a;case"last":while(d=d.nextSibling)if(d.nodeType===1)return!1;return!0;case"nth":var e=b[2],f=b[3];if(e===1&&f===0)return!0;var g=b[0],h=a.parentNode;if(h&&(h.sizcache!==g||!a.nodeIndex)){var i=0;for(d=h.firstChild;d;d=d.nextSibling)d.nodeType===1&&(d.nodeIndex=++i);h.sizcache=g}var j=a.nodeIndex-f;return e===0?j===0:j%e===0&&j/e>=0}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=l.attrHandle[c]?l.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1},POS:function(a,b,c,d){var e=b[2],f=l.setFilters[e];if(f)return f(a,c,b,d)}}},m=l.match.POS,n=function(a,b){return"\\"+(b-0+1)};for(var o in l.match)l.match[o]=new RegExp(l.match[o].source+/(?![^\[]*\])(?![^\(]*\))/.source),l.leftMatch[o]=new RegExp(/(^(?:.|\r|\n)*?)/.source+l.match[o].source.replace(/\\(\d+)/g,n));var p=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(q){p=function(a,b){var c=0,d=b||[];if(e.call(a)==="[object Array]")Array.prototype.push.apply(d,a);else if(typeof a.length=="number")for(var f=a.length;c<f;c++)d.push(a[c]);else for(;a[c];c++)d.push(a[c]);return d}}var r,s;c.documentElement.compareDocumentPosition?r=function(a,b){if(a===b){g=!0;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1}:(r=function(a,b){if(a===b){g=!0;return 0}if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],h=a.parentNode,i=b.parentNode,j=h;if(h===i)return s(a,b);if(!h)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)f.unshift(j),j=j.parentNode;c=e.length,d=f.length;for(var k=0;k<c&&k<d;k++)if(e[k]!==f[k])return s(e[k],f[k]);return k===c?s(a,f[k],-1):s(e[k],b,1)},s=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),k.getText=function(a){var b="",c;for(var d=0;a[d];d++)c=a[d],c.nodeType===3||c.nodeType===4?b+=c.nodeValue:c.nodeType!==8&&(b+=k.getText(c.childNodes));return b},function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(l.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]}},l.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(l.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++)c[e].nodeType===1&&d.push(c[e]);c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(l.attrHandle.href=function(a){return a.getAttribute("href",2)}),a=null}(),c.querySelectorAll&&function(){var a=k,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){k=function(b,e,f,g){e=e||c;if(!g&&!k.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1])return p(e.getElementsByTagName(b),f);if(h[2]&&l.find.CLASS&&e.getElementsByClassName)return p(e.getElementsByClassName(h[2]),f)}if(e.nodeType===9){if(b==="body"&&e.body)return p([e.body],f);if(h&&h[3]){var i=e.getElementById(h[3]);if(!i||!i.parentNode)return p([],f);if(i.id===h[3])return p([i],f)}try{return p(e.querySelectorAll(b),f)}catch(j){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var m=e,n=e.getAttribute("id"),o=n||d,q=e.parentNode,r=/^\s*[+~]/.test(b);n?o=o.replace(/'/g,"\\$&"):e.setAttribute("id",o),r&&q&&(e=e.parentNode);try{if(!r||q)return p(e.querySelectorAll("[id='"+o+"'] "+b),f)}catch(s){}finally{n||m.removeAttribute("id")}}}return a(b,e,f,g)};for(var e in a)k[e]=a[e];b=null}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")}catch(f){e=!0}k.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!k.isXML(a))try{if(e||!l.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);if(f||!d||a.document&&a.document.nodeType!==11)return f}}catch(g){}return k(c,null,null,[a]).length>0}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1)return;l.order.splice(1,0,"CLASS"),l.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c)return b.getElementsByClassName(a[1])},a=null}}(),c.documentElement.contains?k.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)}:c.documentElement.compareDocumentPosition?k.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}:k.contains=function(){return!1},k.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1};var v=function(a,b){var c,d=[],e="",f=b.nodeType?[b]:b;while(c=l.match.PSEUDO.exec(a))e+=c[0],a=a.replace(l.match.PSEUDO,"");a=l.relative[a]?a+"*":a;for(var g=0,h=f.length;g<h;g++)k(a,f[g],d);return k.filter(e,d)};f.find=k,f.expr=k.selectors,f.expr[":"]=f.expr.filters,f.unique=k.uniqueSort,f.text=k.getText,f.isXMLDoc=k.isXML,f.contains=k.contains}();var P=/Until$/,Q=/^(?:parents|prevUntil|prevAll)/,R=/,/,S=/^.[^:#\[\.,]*$/,T=Array.prototype.slice,U=f.expr.match.POS,V={children:!0,contents:!0,next:!0,prev:!0};f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string")return f(a).filter(function(){for(c=0,d=b.length;c<d;c++)if(f.contains(b[c],this))return!0});var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0)for(h=g;h<e.length;h++)for(i=0;i<g;i++)if(e[i]===e[h]){e.splice(h--,1);break}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;a++)if(f.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(X(this,a,!1),"not",a)},filter:function(a){return this.pushStack(X(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?f.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h,i,j={},k=1;if(g&&a.length){for(d=0,e=a.length;d<e;d++)i=a[d],j[i]||(j[i]=U.test(i)?f(i,b||this.context):i);while(g&&g.ownerDocument&&g!==b){for(i in j)h=j[i],(h.jquery?h.index(g)>-1:f(g).is(h))&&c.push({selector:i,elem:g,level:k});g=g.parentNode,k++}}return c}var l=U.test(a)||typeof a!="string"?f(a,b||this.context):0;for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(l?l.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11)break}}c=c.length>1?f.unique(c):c;return this.pushStack(c,"closest",a)},index:function(a){if(!a||typeof a=="string")return f.inArray(this[0],a?f(a):this.parent().children());return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);return this.pushStack(W(c[0])||W(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling(a.parentNode.firstChild,a)},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c),g=T.call(arguments);P.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!V[a]?f.unique(e):e,(this.length>1||R.test(d))&&Q.test(a)&&(e=e.reverse());return this.pushStack(e,a,g.join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d)))g.nodeType===1&&e.push(g),g=g[c];return e},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var Y=/ jQuery\d+="(?:\d+|null)"/g,Z=/^\s+/,$=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,_=/<([\w:]+)/,ba=/<tbody/i,bb=/<|&#?\w+;/,bc=/<(?:script|object|embed|option|style)/i,bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.text(a.call(this,b,c.text()))});if(typeof a!="object"&&a!==b)return this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a));return f.text(this)},wrapAll:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapAll(a.call(this,b))});if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapInner(a.call(this,b))});return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){return this.each(function(){f(this).wrapAll(a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=f(arguments[0]);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f(arguments[0]).toArray());return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++)if(!a||f.filter(a,[d]).length)!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d);return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));while(b.firstChild)b.removeChild(b.firstChild)}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;return this.map(function(){return f.clone(this,a,b)})},html:function(a){if(a===b)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(Y,""):null;if(typeof a=="string"&&!bc.test(a)&&(f.support.leadingWhitespace||!Z.test(a))&&!bg[(_.exec(a)||["",""])[1].toLowerCase()]){a=a.replace($,"<$1></$2>");try{for(var c=0,d=this.length;c<d;c++)this[c].nodeType===1&&(f.cleanData(this[c].getElementsByTagName("*")),this[c].innerHTML=a)}catch(e){this.empty().append(a)}}else f.isFunction(a)?this.each(function(b){var c=f(this);c.html(a.call(this,b,c.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a))return this.each(function(b){var c=f(this),d=c.html();c.replaceWith(a.call(this,b,d))});typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j))return this.each(function(){f(this).domManip(a,c,d,!0)});if(f.isFunction(j))return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)});if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++)d.call(c?bh(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)}k.length&&f.each(k,bn)}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i=b&&b[0]?b[0].ownerDocument||b[0]:c;a.length===1&&typeof a[0]=="string"&&a[0].length<512&&i===c&&a[0].charAt(0)==="<"&&!bc.test(a[0])&&(f.support.checkClone||!bd.test(a[0]))&&(g=!0,h=f.fragments[a[0]],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[a[0]]=h?e:1);return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)}}),f.extend({clone:function(a,b,c){var d=a.cloneNode(!0),e,g,h;if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bj(a,d),e=bk(a),g=bk(d);for(h=0;e[h];++h)bj(e[h],g[h])}if(b){bi(a,d);if(c){e=bk(a),g=bk(d);for(h=0;e[h];++h)bi(e[h],g[h])}}return d},clean:function(a,b,d,e){var g;b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||
+b[0]&&b[0].ownerDocument||c);var h=[],i;for(var j=0,k;(k=a[j])!=null;j++){typeof k=="number"&&(k+="");if(!k)continue;if(typeof k=="string")if(!bb.test(k))k=b.createTextNode(k);else{k=k.replace($,"<$1></$2>");var l=(_.exec(k)||["",""])[1].toLowerCase(),m=bg[l]||bg._default,n=m[0],o=b.createElement("div");o.innerHTML=m[1]+k+m[2];while(n--)o=o.lastChild;if(!f.support.tbody){var p=ba.test(k),q=l==="table"&&!p?o.firstChild&&o.firstChild.childNodes:m[1]==="<table>"&&!p?o.childNodes:[];for(i=q.length-1;i>=0;--i)f.nodeName(q[i],"tbody")&&!q[i].childNodes.length&&q[i].parentNode.removeChild(q[i])}!f.support.leadingWhitespace&&Z.test(k)&&o.insertBefore(b.createTextNode(Z.exec(k)[0]),o.firstChild),k=o.childNodes}var r;if(!f.support.appendChecked)if(k[0]&&typeof (r=k.length)=="number")for(i=0;i<r;i++)bm(k[i]);else bm(k);k.nodeType?h.push(k):h=f.merge(h,k)}if(d){g=function(a){return!a.type||be.test(a.type)};for(j=0;h[j];j++)if(e&&f.nodeName(h[j],"script")&&(!h[j].type||h[j].type.toLowerCase()==="text/javascript"))e.push(h[j].parentNode?h[j].parentNode.removeChild(h[j]):h[j]);else{if(h[j].nodeType===1){var s=f.grep(h[j].getElementsByTagName("script"),g);h.splice.apply(h,[j+1,0].concat(s))}d.appendChild(h[j])}}return h},cleanData:function(a){var b,c,d=f.cache,e=f.expando,g=f.event.special,h=f.support.deleteExpando;for(var i=0,j;(j=a[i])!=null;i++){if(j.nodeName&&f.noData[j.nodeName.toLowerCase()])continue;c=j[f.expando];if(c){b=d[c]&&d[c][e];if(b&&b.events){for(var k in b.events)g[k]?f.event.remove(j,k):f.removeEvent(j,k,b.handle);b.handle&&(b.handle.elem=null)}h?delete j[f.expando]:j.removeAttribute&&j.removeAttribute(f.expando),delete d[c]}}}});var bo=/alpha\([^)]*\)/i,bp=/opacity=([^)]*)/,bq=/-([a-z])/ig,br=/([A-Z]|^ms)/g,bs=/^-?\d+(?:px)?$/i,bt=/^-?\d/,bu=/^[+\-]=/,bv=/[^+\-\.\de]+/g,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Left","Right"],by=["Top","Bottom"],bz,bA,bB,bC=function(a,b){return b.toUpperCase()};f.fn.css=function(a,c){if(arguments.length===2&&c===b)return this;return f.access(this,a,c,!0,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)})},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bz(a,"opacity","opacity");return c===""?"1":c}return a.style.opacity}}},cssNumber:{zIndex:!0,fontWeight:!0,opacity:!0,zoom:!0,lineHeight:!0,widows:!0,orphans:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];c=f.cssProps[i]||i;if(d===b){if(k&&"get"in k&&(g=k.get(a,!1,e))!==b)return g;return j[c]}h=typeof d;if(h==="number"&&isNaN(d)||d==null)return;h==="string"&&bu.test(d)&&(d=+d.replace(bv,"")+parseFloat(f.css(a,c))),h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set"in k)||(d=k.set(a,d))!==b)try{j[c]=d}catch(l){}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");if(g&&"get"in g&&(e=g.get(a,!0,d))!==b)return e;if(bz)return bz(a,c)},swap:function(a,b,c){var d={};for(var e in b)d[e]=a.style[e],a.style[e]=b[e];c.call(a);for(e in b)a.style[e]=d[e]},camelCase:function(a){return a.replace(bq,bC)}}),f.curCSS=f.css,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){var e;if(c){a.offsetWidth!==0?e=bD(a,b,d):f.swap(a,bw,function(){e=bD(a,b,d)});if(e<=0){e=bz(a,b,b),e==="0px"&&bB&&(e=bB(a,b,b));if(e!=null)return e===""||e==="auto"?"0px":e}if(e<0||e==null){e=a.style[b];return e===""||e==="auto"?"0px":e}return typeof e=="string"?e:e+"px"}},set:function(a,b){if(!bs.test(b))return b;b=parseFloat(b);if(b>=0)return b+"px"}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return bp.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle;c.zoom=1;var e=f.isNaN(b)?"":"alpha(opacity="+b*100+")",g=d&&d.filter||c.filter||"";c.filter=bo.test(g)?g.replace(bo,e):g+" "+e}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){var c;f.swap(a,{display:"inline-block"},function(){b?c=bz(a,"margin-right","marginRight"):c=a.style.marginRight});return c}})}),c.defaultView&&c.defaultView.getComputedStyle&&(bA=function(a,c){var d,e,g;c=c.replace(br,"-$1").toLowerCase();if(!(e=a.ownerDocument.defaultView))return b;if(g=e.getComputedStyle(a,null))d=g.getPropertyValue(c),d===""&&!f.contains(a.ownerDocument.documentElement,a)&&(d=f.style(a,c));return d}),c.documentElement.currentStyle&&(bB=function(a,b){var c,d=a.currentStyle&&a.currentStyle[b],e=a.runtimeStyle&&a.runtimeStyle[b],f=a.style;!bs.test(d)&&bt.test(d)&&(c=f.left,e&&(a.runtimeStyle.left=a.currentStyle.left),f.left=b==="fontSize"?"1em":d||0,d=f.pixelLeft+"px",f.left=c,e&&(a.runtimeStyle.left=e));return d===""?"auto":d}),bz=bA||bB,f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style.display||f.css(a,"display"))==="none"},f.expr.filters.visible=function(a){return!f.expr.filters.hidden(a)});var bE=/%20/g,bF=/\[\]$/,bG=/\r?\n/g,bH=/#.*$/,bI=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bJ=/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bK=/^(?:about|app|app\-storage|.+\-extension|file|widget):$/,bL=/^(?:GET|HEAD)$/,bM=/^\/\//,bN=/\?/,bO=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bP=/^(?:select|textarea)/i,bQ=/\s+/,bR=/([?&])_=[^&]*/,bS=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bT=f.fn.load,bU={},bV={},bW,bX;try{bW=e.href}catch(bY){bW=c.createElement("a"),bW.href="",bW=bW.href}bX=bS.exec(bW.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bT)return bT.apply(this,arguments);if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a}),i.html(g?f("<div>").append(c.replace(bO,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||bP.test(this.nodeName)||bJ.test(this.type))}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bG,"\r\n")}}):{name:b.name,value:c.replace(bG,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.bind(b,a)}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")},ajaxSetup:function(a,b){b?f.extend(!0,a,f.ajaxSettings,b):(b=a,a=f.extend(!0,f.ajaxSettings,b));for(var c in{context:1,url:1})c in b?a[c]=b[c]:c in f.ajaxSettings&&(a[c]=f.ajaxSettings[c]);return a},ajaxSettings:{url:bW,isLocal:bK.test(bX[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":"*/*"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML}},ajaxPrefilter:bZ(bU),ajaxTransport:bZ(bV),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a?4:0;var o,r,u,w=l?ca(d,v,l):b,x,y;if(a>=200&&a<300||a===304){if(d.ifModified){if(x=v.getResponseHeader("Last-Modified"))f.lastModified[k]=x;if(y=v.getResponseHeader("Etag"))f.etag[k]=y}if(a===304)c="notmodified",o=!0;else try{r=cb(d,w),c="success",o=!0}catch(z){c="parsererror",u=z}}else{u=c;if(!c||a)c="error",a<0&&(a=0)}v.status=a,v.statusText=c,o?h.resolveWith(e,[r,c,v]):h.rejectWith(e,[v,c,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.resolveWith(e,[v,c]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f._Deferred(),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;if(s===2){if(!o){o={};while(c=bI.exec(n))o[c[1].toLowerCase()]=c[2]}c=o[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.done,v.statusCode=function(a){if(a){var b;if(s<2)for(b in a)j[b]=[j[b],a[b]];else b=a[v.status],v.then(b,b)}return this},d.url=((a||d.url)+"").replace(bH,"").replace(bM,bX[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bQ),d.crossDomain==null&&(r=bS.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bX[1]&&r[2]==bX[2]&&(r[3]||(r[1]==="http:"?80:443))==(bX[3]||(bX[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),b$(bU,d,c,v);if(s===2)return!1;t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bL.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");if(!d.hasContent){d.data&&(d.url+=(bN.test(d.url)?"&":"?")+d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bR,"$1_="+x);d.url=y+(y===d.url?(bN.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", */*; q=0.01":""):d.accepts["*"]);for(u in d.headers)v.setRequestHeader(u,d.headers[u]);if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();return!1}for(u in{success:1,error:1,complete:1})v[u](d[u]);p=b$(bV,d,c,v);if(!p)w(-1,"No Transport");else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")},d.timeout));try{s=1,p.send(l,w)}catch(z){status<2?w(-1,z):f.error(z)}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a))f.each(a,function(){e(this.name,this.value)});else for(var g in a)b_(g,a[g],c,e);return d.join("&").replace(bE,"+")}}),f.extend({active:0,lastModified:{},etag:{}});var cc=f.now(),cd=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cc++}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=b.contentType==="application/x-www-form-urlencoded"&&typeof b.data=="string";if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(cd.test(b.url)||e&&cd.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";b.jsonp!==!1&&(j=j.replace(cd,l),b.url===j&&(e&&(k=k.replace(cd,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState))d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var ce=a.ActiveXObject?function(){for(var a in cg)cg[a](0,1)}:!1,cf=0,cg;f.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&ch()||ci()}:ch,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);if(c.xhrFields)for(j in c.xhrFields)h[j]=c.xhrFields[j];c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(j in e)h.setRequestHeader(j,e[j])}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,ce&&delete cg[i]);if(e)h.readyState!==4&&h.abort();else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n),m.text=h.responseText;try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cf,ce&&(cg||(cg={},f(a).unload(ce)),cg[i]=d),h.onreadystatechange=d)},abort:function(){d&&d(0,1)}}}});var cj={},ck,cl,cm=/^(?:toggle|show|hide)$/,cn=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,co,cp=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cq,cr=a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame;f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0)return this.animate(cu("show",3),a,b,c);for(var g=0,h=this.length;g<h;g++)d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),e===""&&f.css(d,"display")==="none"&&f._data(d,"olddisplay",cv(d.nodeName)));for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none")d.style.display=f._data(d,"olddisplay")||""}}return this},hide:function(a,b,c){if(a||a===0)return this.animate(cu("hide",3),a,b,c);for(var d=0,e=this.length;d<e;d++)if(this[d].style){var g=f.css(this[d],"display");g!=="none"&&!f._data(this[d],"olddisplay")&&f._data(this[d],"olddisplay",g)}for(d=0;d<e;d++)this[d].style&&(this[d].style.display="none");return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");f(this)[b?"show":"hide"]()}):this.animate(cu("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=f.speed(b,c,d);if(f.isEmptyObject(a))return this.each(e.complete,[!1]);a=f.extend({},a);return this[e.queue===!1?"each":"queue"](function(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o;b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]),h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";if(h==="hide"&&d||h==="show"&&!d)return b.complete.call(this);c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(f.support.inlineBlockNeedsLayout?(j=cv(this.nodeName),j==="inline"?this.style.display="inline-block":(this.style.display="inline",this.style.zoom=1)):this.style.display="inline-block"))}b.overflow!=null&&(this.style.overflow="hidden");for(i in a)k=new f.fx(this,b,i),h=a[i],cm.test(h)?k[h==="toggle"?d?"show":"hide":h]():(l=cn.exec(h),m=k.cur(),l?(n=parseFloat(l[2]),o=l[3]||(f.cssNumber[i]?"":"px"),o!=="px"&&(f.style(this,i,(n||1)+o),m=(n||1)/k.cur()*m,f.style(this,i,m+o)),l[1]&&(n=(l[1]==="-="?-1:1)*n+m),k.custom(m,n,o)):k.custom(m,h,""));return!0})},stop:function(a,b){a&&this.queue([]),this.each(function(){var a=f.timers,c=a.length;b||f._unmark(!0,this);while(c--)a[c].elem===this&&(b&&a[c](!0),a.splice(c,1))}),b||this.dequeue();return this}}),f.each({slideDown:cu("show",1),slideUp:cu("hide",1),slideToggle:cu("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default,d.old=d.complete,d.complete=function(a){d.queue!==!1?f.dequeue(this):a!==!1&&f._unmark(this),f.isFunction(d.old)&&d.old.call(this)};return d},easing:{linear:function(a,b,c,d){return c+d*a},swing:function(a,b,c,d){return(-Math.cos(a*Math.PI)/2+.5)*d+c}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,b,c){function h(a){return d.step(a)}var d=this,e=f.fx,g;this.startTime=cq||cs(),this.start=a,this.end=b,this.unit=c||this.unit||(f.cssNumber[this.prop]?"":"px"),this.now=this.start,this.pos=this.state=0,h.elem=this.elem,h()&&f.timers.push(h)&&!co&&(cr?(co=1,g=function(){co&&(cr(g),e.tick())},cr(g)):co=setInterval(e.tick,e.interval))},show:function(){this.options.orig[this.prop]=f.style(this.elem,this.prop),this.options.show=!0,this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()},hide:function(){this.options.orig[this.prop]=f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)},step:function(a){var b=cq||cs(),c=!0,d=this.elem,e=this.options,g,h;if(a||b>=e.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),e.animatedProperties[this.prop]=!0;for(g in e.animatedProperties)e.animatedProperties[g]!==!0&&(c=!1);if(c){e.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){d.style["overflow"+b]=e.overflow[a]}),e.hide&&f(d).hide();if(e.hide||e.show)for(var i in e.animatedProperties)f.style(d,i,e.orig[i]);e.complete.call(d)}return!1}e.duration==Infinity?this.now=b:(h=b-this.startTime,this.state=h/e.duration,this.pos=f.easing[e.animatedProperties[this.prop]](this.state,h,0,1,e.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();return!0}},f.extend(f.fx,{tick:function(){for(var a=f.timers,b=0;b<a.length;++b)a[b]()||a.splice(b--,1);a.length||f.fx.stop()},interval:13,stop:function(){clearInterval(co),co=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=(a.prop==="width"||a.prop==="height"?Math.max(0,a.now):a.now)+a.unit:a.elem[a.prop]=a.now}}}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem}).length});var cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect"in c.documentElement?f.fn.offset=function(a){var b=this[0],c;if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);try{c=b.getBoundingClientRect()}catch(d){}var e=b.ownerDocument,g=e.documentElement;if(!c||!f.contains(g,b))return c?{top:c.top,left:c.left}:{top:0,left:0};var h=e.body,i=cy(e),j=g.clientTop||h.clientTop||0,k=g.clientLeft||h.clientLeft||0,l=i.pageYOffset||f.support.boxModel&&g.scrollTop||h.scrollTop,m=i.pageXOffset||f.support.boxModel&&g.scrollLeft||h.scrollLeft,n=c.top+l-j,o=c.left+m-k;return{top:n,left:o}}:f.fn.offset=function(a){var b=this[0];if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);f.offset.initialize();var c,d=b.offsetParent,e=b,g=b.ownerDocument,h=g.documentElement,i=g.body,j=g.defaultView,k=j?j.getComputedStyle(b,null):b.currentStyle,l=b.offsetTop,m=b.offsetLeft;while((b=b.parentNode)&&b!==i&&b!==h){if(f.offset.supportsFixedPosition&&k.position==="fixed")break;c=j?j.getComputedStyle(b,null):b.currentStyle,l-=b.scrollTop,m-=b.scrollLeft,b===d&&(l+=b.offsetTop,m+=b.offsetLeft,f.offset.doesNotAddBorder&&(!f.offset.doesAddBorderForTableAndCells||!cw.test(b.nodeName))&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),e=d,d=b.offsetParent),f.offset.subtractsBorderForOverflowNotVisible&&c.overflow!=="visible"&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),k=c}if(k.position==="relative"||k.position==="static")l+=i.offsetTop,m+=i.offsetLeft;f.offset.supportsFixedPosition&&k.position==="fixed"&&(l+=Math.max(h.scrollTop,i.scrollTop),m+=Math.max(h.scrollLeft,i.scrollLeft));return{top:l,left:m}},f.offset={initialize:function(){var a=c.body,b=c.createElement("div"),d,e,g,h,i=parseFloat(f.css(a,"marginTop"))||0,j="<div style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;'><div></div></div><table style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>";f.extend(b.style,{position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",height:"1px",visibility:"hidden"}),b.innerHTML=j,a.insertBefore(b,a.firstChild),d=b.firstChild,e=d.firstChild,h=d.nextSibling.firstChild.firstChild,this.doesNotAddBorder=e.offsetTop!==5,this.doesAddBorderForTableAndCells=h.offsetTop===5,e.style.position="fixed",e.style.top="20px",this.supportsFixedPosition=e.offsetTop===20||e.offsetTop===15,e.style.position=e.style.top="",d.style.overflow="hidden",d.style.position="relative",this.subtractsBorderForOverflowNotVisible=e.offsetTop===-5,this.doesNotIncludeMarginInBodyOffset=a.offsetTop!==i,a.removeChild(b),f.offset.initialize=f.noop},bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;f.offset.initialize(),f.offset.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using"in b?b.using.call(a,k):e.css(k)}},f.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static")a=a.offsetParent;return a})}}),f.each(["Left","Top"],function(a,c){var d="scroll"+c;f.fn[d]=function(c){var e,g;if(c===b){e=this[0];if(!e)return null;g=cy(e);return g?"pageXOffset"in g?g[a?"pageYOffset":"pageXOffset"]:f.support.boxModel&&g.document.documentElement[d]||g.document.body[d]:e[d]}return this.each(function(){g=cy(this),g?g.scrollTo(a?f(g).scrollLeft():c,a?c:f(g).scrollTop()):this[d]=c})}}),f.each(["Height","Width"],function(a,c){var d=c.toLowerCase();f.fn["inner"+c]=function(){return this[0]?parseFloat(f.css(this[0],d,"padding")):null},f.fn["outer"+c]=function(a){return this[0]?parseFloat(f.css(this[0],d,a?"margin":"border")):null},f.fn[d]=function(a){var e=this[0];if(!e)return a==null?null:this;if(f.isFunction(a))return this.each(function(b){var c=f(this);c[d](a.call(this,b,c[d]()))});if(f.isWindow(e)){var g=e.document.documentElement["client"+c];return e.document.compatMode==="CSS1Compat"&&g||e.document.body["client"+c]||g}if(e.nodeType===9)return Math.max(e.documentElement["client"+c],e.body["scroll"+c],e.documentElement["scroll"+c],e.body["offset"+c],e.documentElement["offset"+c]);if(a===b){var h=f.css(e,d),i=parseFloat(h);return f.isNaN(i)?h:i}return this.css(d,typeof a=="string"?a:a+"px")}}),a.jQuery=a.$=f})(window);
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/mathml.html b/profiles/commons/libraries/modernizr/test/caniuse_files/mathml.html
new file mode 100644
index 0000000..8203884
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/mathml.html
@@ -0,0 +1,120 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xmlns:html="http://www.w3.org/1999/xhtml">
+<head>
+	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
+	<title>Untitled</title>
+</head>
+<body>
+<math xmlns="http://www.w3.org/1998/Math/MathML">
+<mrow>
+  <mi>k</mi>
+  <mo>=</mo>
+  <mfrac>
+    <mrow>
+      <mfrac>
+         <mrow>
+          <msup>
+            <mo></mo>
+            <mn>2</mn>
+          </msup>
+          <mi>z</mi>
+        </mrow>
+        <mrow>
+          <mo></mo>
+          <msup>
+            <mi>x</mi>
+            <mn>2</mn>
+          </msup>
+        </mrow>
+      </mfrac>
+      <mfrac>
+        <mrow>
+          <msup>
+            <mo></mo>
+            <mn>2</mn>
+          </msup>
+          <mi>z</mi>
+        </mrow>
+        <mrow>
+          <mo></mo>
+          <msup>
+            <mi>y</mi>
+            <mn>2</mn>
+          </msup>
+        </mrow>
+      </mfrac>
+      <mo>-</mo>
+      <msup>
+        <mrow>
+          <mo>(</mo>
+          <mfrac>
+            <mrow>
+              <msup>
+                <mo></mo>
+                <mn>2</mn>
+              </msup>
+              <mi>z</mi>
+            </mrow>
+            <mrow>
+              <mo></mo>
+              <mi>x</mi>
+              <mo></mo>
+              <mi>y</mi>
+              </mrow>
+          </mfrac>
+          <mo>)</mo>
+        </mrow>
+        <mn>2</mn>
+      </msup>
+    </mrow>
+    <mrow>
+      <msup>
+        <mrow>
+          <mo>(</mo>
+          <mn>1</mn>
+          <mo>+</mo>
+          <msup>
+            <mrow>
+              <mo>(</mo>
+              <mfrac>
+                <mrow>
+                  <mo></mo>
+                  <mi>z</mi>
+                </mrow>
+                <mrow>
+                  <mo></mo>
+                  <mi>x</mi>
+                </mrow>
+              </mfrac>
+              <mo>)</mo>
+            </mrow>
+            <mn>2</mn>
+          </msup>
+          <mo>+</mo>
+          <msup>
+            <mrow>
+              <mo>(</mo>
+              <mfrac>
+                <mrow>
+                  <mo></mo>
+                  <mi>z</mi>
+                </mrow>
+                <mrow>
+                  <mo></mo>
+                  <mi>y</mi>
+                </mrow>
+              </mfrac>
+              <mo>)</mo>
+            </mrow>
+            <mn>2</mn>
+          </msup>
+          <mo>)</mo>
+        </mrow>
+        <mn>2</mn>
+      </msup>
+    </mrow>
+  </mfrac>
+</mrow>
+</math>
+</body>
+</html>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/mathml_ref.png b/profiles/commons/libraries/modernizr/test/caniuse_files/mathml_ref.png
new file mode 100644
index 0000000..1633e58
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/mathml_ref.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/modernizr-1.7.min.js b/profiles/commons/libraries/modernizr/test/caniuse_files/modernizr-1.7.min.js
new file mode 100644
index 0000000..6f54850
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/modernizr-1.7.min.js
@@ -0,0 +1,2 @@
+// Modernizr v1.7  www.modernizr.com
+window.Modernizr=function(a,b,c){function G(){e.input=function(a){for(var b=0,c=a.length;b<c;b++)t[a[b]]=!!(a[b]in l);return t}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" ")),e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)l.setAttribute("type",f=a[d]),e=l.type!=="text",e&&(l.value=m,l.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&l.style.WebkitAppearance!==c?(g.appendChild(l),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(l,null).WebkitAppearance!=="textfield"&&l.offsetHeight!==0,g.removeChild(l)):/^(search|tel)$/.test(f)||(/^(url|email)$/.test(f)?e=l.checkValidity&&l.checkValidity()===!1:/^color$/.test(f)?(g.appendChild(l),g.offsetWidth,e=l.value!=m,g.removeChild(l)):e=l.value!=m)),s[a[d]]=!!e;return s}("search tel url email datetime date month week time datetime-local number range color".split(" "))}function F(a,b){var c=a.charAt(0).toUpperCase()+a.substr(1),d=(a+" "+p.join(c+" ")+c).split(" ");return!!E(d,b)}function E(a,b){for(var d in a)if(k[a[d]]!==c&&(!b||b(a[d],j)))return!0}function D(a,b){return(""+a).indexOf(b)!==-1}function C(a,b){return typeof a===b}function B(a,b){return A(o.join(a+";")+(b||""))}function A(a){k.cssText=a}var d="1.7",e={},f=!0,g=b.documentElement,h=b.head||b.getElementsByTagName("head")[0],i="modernizr",j=b.createElement(i),k=j.style,l=b.createElement("input"),m=":)",n=Object.prototype.toString,o=" -webkit- -moz- -o- -ms- -khtml- ".split(" "),p="Webkit Moz O ms Khtml".split(" "),q={svg:"http://www.w3.org/2000/svg"},r={},s={},t={},u=[],v,w=function(a){var c=b.createElement("style"),d=b.createElement("div"),e;c.textContent=a+"{#modernizr{height:3px}}",h.appendChild(c),d.id="modernizr",g.appendChild(d),e=d.offsetHeight===3,c.parentNode.removeChild(c),d.parentNode.removeChild(d);return!!e},x=function(){function d(d,e){e=e||b.createElement(a[d]||"div");var f=(d="on"+d)in e;f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=C(e[d],"function"),C(e[d],c)||(e[d]=c),e.removeAttribute(d))),e=null;return f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),y=({}).hasOwnProperty,z;C(y,c)||C(y.call,c)?z=function(a,b){return b in a&&C(a.constructor.prototype[b],c)}:z=function(a,b){return y.call(a,b)},r.flexbox=function(){function c(a,b,c,d){a.style.cssText=o.join(b+":"+c+";")+(d||"")}function a(a,b,c,d){b+=":",a.style.cssText=(b+o.join(c+";"+b)).slice(0,-b.length)+(d||"")}var d=b.createElement("div"),e=b.createElement("div");a(d,"display","box","width:42px;padding:0;"),c(e,"box-flex","1","width:10px;"),d.appendChild(e),g.appendChild(d);var f=e.offsetWidth===42;d.removeChild(e),g.removeChild(d);return f},r.canvas=function(){var a=b.createElement("canvas");return a.getContext&&a.getContext("2d")},r.canvastext=function(){return e.canvas&&C(b.createElement("canvas").getContext("2d").fillText,"function")},r.webgl=function(){return!!a.WebGLRenderingContext},r.touch=function(){return"ontouchstart"in a||w("@media ("+o.join("touch-enabled),(")+"modernizr)")},r.geolocation=function(){return!!navigator.geolocation},r.postmessage=function(){return!!a.postMessage},r.websqldatabase=function(){var b=!!a.openDatabase;return b},r.indexedDB=function(){for(var b=-1,c=p.length;++b<c;){var d=p[b].toLowerCase();if(a[d+"_indexedDB"]||a[d+"IndexedDB"])return!0}return!1},r.hashchange=function(){return x("hashchange",a)&&(b.documentMode===c||b.documentMode>7)},r.history=function(){return !!(a.history&&history.pushState)},r.draganddrop=function(){return x("dragstart")&&x("drop")},r.websockets=function(){return"WebSocket"in a},r.rgba=function(){A("background-color:rgba(150,255,150,.5)");return D(k.backgroundColor,"rgba")},r.hsla=function(){A("background-color:hsla(120,40%,100%,.5)");return D(k.backgroundColor,"rgba")||D(k.backgroundColor,"hsla")},r.multiplebgs=function(){A("background:url(//:),url(//:),red url(//:)");return(new RegExp("(url\\s*\\(.*?){3}")).test(k.background)},r.backgroundsize=function(){return F("backgroundSize")},r.borderimage=function(){return F("borderImage")},r.borderradius=function(){return F("borderRadius","",function(a){return D(a,"orderRadius")})},r.boxshadow=function(){return F("boxShadow")},r.textshadow=function(){return b.createElement("div").style.textShadow===""},r.opacity=function(){B("opacity:.55");return/^0.55$/.test(k.opacity)},r.cssanimations=function(){return F("animationName")},r.csscolumns=function(){return F("columnCount")},r.cssgradients=function(){var a="background-image:",b="gradient(linear,left top,right bottom,from(#9f9),to(white));",c="linear-gradient(left top,#9f9, white);";A((a+o.join(b+a)+o.join(c+a)).slice(0,-a.length));return D(k.backgroundImage,"gradient")},r.cssreflections=function(){return F("boxReflect")},r.csstransforms=function(){return!!E(["transformProperty","WebkitTransform","MozTransform","OTransform","msTransform"])},r.csstransforms3d=function(){var a=!!E(["perspectiveProperty","WebkitPerspective","MozPerspective","OPerspective","msPerspective"]);a&&"webkitPerspective"in g.style&&(a=w("@media ("+o.join("transform-3d),(")+"modernizr)"));return a},r.csstransitions=function(){return F("transitionProperty")},r.fontface=function(){var a,c,d=h||g,e=b.createElement("style"),f=b.implementation||{hasFeature:function(){return!1}};e.type="text/css",d.insertBefore(e,d.firstChild),a=e.sheet||e.styleSheet;var i=f.hasFeature("CSS2","")?function(b){if(!a||!b)return!1;var c=!1;try{a.insertRule(b,0),c=/src/i.test(a.cssRules[0].cssText),a.deleteRule(a.cssRules.length-1)}catch(d){}return c}:function(b){if(!a||!b)return!1;a.cssText=b;return a.cssText.length!==0&&/src/i.test(a.cssText)&&a.cssText.replace(/\r+|\n+/g,"").indexOf(b.split(" ")[0])===0};c=i('@font-face { font-family: "font"; src: url(data:,); }'),d.removeChild(e);return c},r.video=function(){var a=b.createElement("video"),c=!!a.canPlayType;if(c){c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"');var d='video/mp4; codecs="avc1.42E01E';c.h264=a.canPlayType(d+'"')||a.canPlayType(d+', mp4a.40.2"'),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"')}return c},r.audio=function(){var a=b.createElement("audio"),c=!!a.canPlayType;c&&(c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"'),c.mp3=a.canPlayType("audio/mpeg;"),c.wav=a.canPlayType('audio/wav; codecs="1"'),c.m4a=a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;"));return c},r.localstorage=function(){try{return!!localStorage.getItem}catch(a){return!1}},r.sessionstorage=function(){try{return!!sessionStorage.getItem}catch(a){return!1}},r.webWorkers=function(){return!!a.Worker},r.applicationcache=function(){return!!a.applicationCache},r.svg=function(){return!!b.createElementNS&&!!b.createElementNS(q.svg,"svg").createSVGRect},r.inlinesvg=function(){var a=b.createElement("div");a.innerHTML="<svg/>";return(a.firstChild&&a.firstChild.namespaceURI)==q.svg},r.smil=function(){return!!b.createElementNS&&/SVG/.test(n.call(b.createElementNS(q.svg,"animate")))},r.svgclippaths=function(){return!!b.createElementNS&&/SVG/.test(n.call(b.createElementNS(q.svg,"clipPath")))};for(var H in r)z(r,H)&&(v=H.toLowerCase(),e[v]=r[H](),u.push((e[v]?"":"no-")+v));e.input||G(),e.crosswindowmessaging=e.postmessage,e.historymanagement=e.history,e.addTest=function(a,b){a=a.toLowerCase();if(!e[a]){b=!!b(),g.className+=" "+(b?"":"no-")+a,e[a]=b;return e}},A(""),j=l=null,f&&a.attachEvent&&function(){var a=b.createElement("div");a.innerHTML="<elem></elem>";return a.childNodes.length!==1}()&&function(a,b){function p(a,b){var c=-1,d=a.length,e,f=[];while(++c<d)e=a[c],(b=e.media||b)!="screen"&&f.push(p(e.imports,b),e.cssText);return f.join("")}function o(a){var b=-1;while(++b<e)a.createElement(d[b])}var c="abbr|article|aside|audio|canvas|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",d=c.split("|"),e=d.length,f=new RegExp("(^|\\s)("+c+")","gi"),g=new RegExp("<(/*)("+c+")","gi"),h=new RegExp("(^|[^\\n]*?\\s)("+c+")([^\\n]*)({[\\n\\w\\W]*?})","gi"),i=b.createDocumentFragment(),j=b.documentElement,k=j.firstChild,l=b.createElement("body"),m=b.createElement("style"),n;o(b),o(i),k.insertBefore(m,k.firstChild),m.media="print",a.attachEvent("onbeforeprint",function(){var a=-1,c=p(b.styleSheets,"all"),k=[],o;n=n||b.body;while((o=h.exec(c))!=null)k.push((o[1]+o[2]+o[3]).replace(f,"$1.iepp_$2")+o[4]);m.styleSheet.cssText=k.join("\n");while(++a<e){var q=b.getElementsByTagName(d[a]),r=q.length,s=-1;while(++s<r)q[s].className.indexOf("iepp_")<0&&(q[s].className+=" iepp_"+d[a])}i.appendChild(n),j.appendChild(l),l.className=n.className,l.innerHTML=n.innerHTML.replace(g,"<$1font")}),a.attachEvent("onafterprint",function(){l.innerHTML="",j.removeChild(l),j.appendChild(n),m.styleSheet.cssText=""})}(a,b),e._enableHTML5=f,e._version=d,g.className=g.className.replace(/\bno-js\b/,"")+" js "+u.join(" ");return e}(this,this.document)
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/png_alpha_result.png b/profiles/commons/libraries/modernizr/test/caniuse_files/png_alpha_result.png
new file mode 100644
index 0000000..45fdf06
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/png_alpha_result.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/pushstate.html b/profiles/commons/libraries/modernizr/test/caniuse_files/pushstate.html
new file mode 100644
index 0000000..bcef606
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/pushstate.html
@@ -0,0 +1,40 @@
+<!DOCTYPE html>
+<html>
+<head>
+	<meta charset="utf-8" />
+	<title>popstate event test</title>
+</head>
+<body>
+
+<script>
+
+(function() {
+	var test_id;
+	
+	function showResult(r) {
+		if(test_id && window.parent.setResult) {
+			parent.setResult(test_id, r);
+		} else {
+			alert(r);
+		}
+	}
+	
+	if(location.hash.length) {
+		test_id = location.hash.substr(1);
+	}
+	
+	if(history.pushState) {
+		var rand = Math.random();
+		setTimeout(function() {
+			history.pushState({foo: 'bar'}, "title", './' + rand);
+			var result = (location.href.indexOf(rand) > -1);
+			showResult(result);
+		}, 100);
+	} 
+	
+})();
+
+</script>
+
+</body>
+</html>
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/red30x30.png b/profiles/commons/libraries/modernizr/test/caniuse_files/red30x30.png
new file mode 100644
index 0000000..561c8d2
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/red30x30.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/ruby.png b/profiles/commons/libraries/modernizr/test/caniuse_files/ruby.png
new file mode 100644
index 0000000..4fe06dd
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/ruby.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/stroked-text.png b/profiles/commons/libraries/modernizr/test/caniuse_files/stroked-text.png
new file mode 100644
index 0000000..e75890f
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/stroked-text.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/style.css b/profiles/commons/libraries/modernizr/test/caniuse_files/style.css
new file mode 100644
index 0000000..d90731b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/style.css
@@ -0,0 +1,168 @@
+body {
+	font-family: "Lucida Grande", Lucida, Verdana, sans-serif;
+	font-size: 12px;
+}
+
+a {
+	text-decoration: none;
+}
+a:hover {
+	text-decoration: underline;
+}
+
+table, tr, th, td {
+	border: 1px solid #AAA;
+}
+
+table {
+	margin-top: 1em;
+	width: 100%;
+}
+
+tbody th {
+	text-align: left;
+	font-size: 14px;
+	width: 200px;
+}
+
+th h3 {
+	margin: 3px;
+	font-size: 12px;
+}
+
+th span.links {
+	font-size: 10px;
+}
+
+dt {
+	font-weight: bold;
+}
+
+tr:hover > th,
+tr:hover > td + td { background-color: #FFC; }
+
+div.test_wrap {
+	display: -moz-inline-stack;
+	display: inline-block;
+	border: 1px solid #CCC;
+	text-align: center;
+	vertical-align: top;
+	min-height: 50px;
+	margin-right: 5px;
+	background: white;
+	position: relative;
+}
+
+div.test_wrap h3 {
+	text-align: center;
+	margin: 2px;
+	font-size: 10px;
+}
+
+div.auto {
+	display: -moz-inline-stack;
+	display: inline-block;
+	border: 1px solid;
+	width: 30px;
+	height: 30px;
+}
+
+div.square {
+	display: -moz-inline-stack;
+	display: inline-block;
+	border: 1px solid;
+	width: 30px;
+	height: 30px;
+	background: red;
+}
+
+div.info {
+	display: none;
+	position: absolute;
+	top: 100%;
+	z-index: 2;
+	left: 0;
+	background: white;
+	padding: 2px;
+	min-width: 300px;
+	border: 1px solid;
+	text-align: left;
+}
+
+div.test_wrap:hover > div.info {
+	display: block;
+}
+
+
+div.vis_test {
+	display: -moz-inline-stack;
+	display: inline-block;
+}
+
+div.vis_ref {
+	display: -moz-inline-stack;
+	display: inline-block;
+	border-left: 1px dashed black;
+	margin-left: 5px;
+	padding-left: 5px;
+	vertical-align: top;
+}
+
+p.condition {
+	font-style: italic;
+	margin: 2px;
+	clear: both;
+}
+
+.pass {
+  background: lime;
+}
+
+.fail {
+  background: red;
+}
+
+.partial {
+  background: yellow;
+}
+
+.unknown {
+  background: #aaa;
+}
+
+.current span {
+    border-radius: 6px;
+    -moz-border-radius: 6px;
+    background: none repeat scroll 0 0 #E6EA69;
+    color: black;
+    float: right;
+    font-size: 8px;
+    padding: 0 1px;
+}
+
+#intro, #options {
+	width: 400px;
+	background: #EEE;
+	border-radius: 10px;
+	padding: 5px 10px;
+	margin: 10px;
+	float: left;
+}
+
+#intro dt::after {
+	content: ':';
+}
+
+#intro dd {
+	margin-bottom: 1em;
+}
+
+#opt_submit {
+	display: block;
+	margin: 10px;
+}
+
+#options label {
+	display: block;
+	margin: 5px;
+}
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/svg-html-blur.png b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-html-blur.png
new file mode 100644
index 0000000..549b297
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-html-blur.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg
new file mode 100644
index 0000000..c0a867f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"> 
+    <rect fill="#00ff00" x="0" y="0" width="30" height="30"> 
+</rect>
+</svg>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg.1 b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg.1
new file mode 100644
index 0000000..c0a867f
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/svg-img.svg.1
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"> 
+    <rect fill="#00ff00" x="0" y="0" width="30" height="30"> 
+</rect>
+</svg>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/svg_blur.png b/profiles/commons/libraries/modernizr/test/caniuse_files/svg_blur.png
new file mode 100644
index 0000000..17cb6e3
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/svg_blur.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/table.png b/profiles/commons/libraries/modernizr/test/caniuse_files/table.png
new file mode 100644
index 0000000..e9b9b9d
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/table.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow1.png b/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow1.png
new file mode 100644
index 0000000..47b3cea
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow1.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow2.png b/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow2.png
new file mode 100644
index 0000000..f335189
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/text-shadow2.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/windsong_font.png b/profiles/commons/libraries/modernizr/test/caniuse_files/windsong_font.png
new file mode 100644
index 0000000..b983d2a
Binary files /dev/null and b/profiles/commons/libraries/modernizr/test/caniuse_files/windsong_font.png differ
diff --git a/profiles/commons/libraries/modernizr/test/caniuse_files/xhtml.html b/profiles/commons/libraries/modernizr/test/caniuse_files/xhtml.html
new file mode 100644
index 0000000..af4be89
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/caniuse_files/xhtml.html
@@ -0,0 +1,14 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
+	<title>Untitled</title>
+</head>
+<body><p>true</p>	
+	<script>
+	<![CDATA[
+	window.parent.setResult('xhtml0', document.body.firstChild.textContent == 'true');
+	]]>
+	</script>
+</body>
+</html>
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/index.html b/profiles/commons/libraries/modernizr/test/index.html
new file mode 100644
index 0000000..587f0c8
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/index.html
@@ -0,0 +1,104 @@
+<!DOCTYPE html>
+<html class="+no-js no-js- no-js i-has-no-js">
+<head>
+  <meta charset="UTF-8">
+  <title>Modernizr Test Suite</title>
+  <link rel="stylesheet" href="qunit/qunit.css">
+  <style>
+     body { margin-bottom: 150px;}
+     #testbed { font-family: Helvetica; color: #444; padding-bottom: 100px;}
+     #testbed button { margin: 30px; font-size: 13px;}
+     .data-notes, .offScreen { display:none;}
+     table { width: 100%;}
+     tbody tr:nth-child(even) td, tbody tr:nth-child(even) th {  border: 1px solid #ccc; border-left: 0; border-right: 0;}
+     table td:nth-child(even), table th:nth-child(even) { background: #e6e6e6;}
+     table tbody tr:hover td, table tbody tr:hover th { background: #e1e100!important;}
+     td.wrong { background:red!important;}
+     #html5section { visibility: hidden; }
+     h1 label { display:none;}
+     .output { padding: 0 0 0 16px;}
+     .output ul { margin: 0;}
+     .output li { color: #854747; }
+     .output li.yes{color:#090;}
+     .output li b{color:#000;}
+     .output {font:14px/1.3 Inconsolata,Consolas,monospace;
+                    -webkit-column-count: 5;
+                       -moz-column-count: 5;
+                            column-count: 5;}
+      .output + .output { border-top: 5px solid #ccc; }
+      textarea { width: 100%; min-height: 75px;}
+      #caniusetrigger { font-size: 38px; font-family: monospace; display:block; }
+  </style>
+
+
+  <script>window.Modernizr || document.write('<script src="../modernizr.js"><\/script>')</script>
+
+  <script src="https://raw.github.com/Modernizr/Modernizr/master/modernizr.js"></script>
+
+  <script src="js/lib/polyfills.js"></script>
+  <script src="js/lib/detect-global.js"></script>
+
+  <script src="qunit/qunit.js"></script>
+  <script src="js/lib/jquery-1.7b2.js"></script>
+
+  <script src="js/lib/jsonselect.js"></script>
+  <script src="js/lib/uaparser.js"></script>
+  <script src="js/lib/github.js"></script>
+
+  <script src="js/setup.js"></script>
+
+  <script src="js/unit.js"></script>
+  <script src="js/unit-caniuse.js"></script>
+</head>
+<body>
+  <h1 id="qunit-header">Modernizr Test Suite</h1>
+  <h2 id="qunit-banner"></h2>
+  <div id="qunit-testrunner-toolbar"></div>
+  <h2 id="qunit-userAgent"></h2>
+
+  <ol id="qunit-tests"></ol>
+
+  <div id="mod-output" class=output></div>
+  <div id="mod-feattest-output" class=output></div>
+
+
+  <br>
+
+  <section><aside>this is an aside within a section</aside></section>
+
+
+
+
+  <h5>JSON.stringify(Modernizr)</h5>
+  <textarea></textarea>
+  <a href="#"   id="caniusetrigger"
+                onclick="return revealreftests(this)"
+                title="add a #caniuse hash to this page to make this automatic"
+                >Show the Ref Tests from Caniuse and Modernizr</a>
+
+
+  <script src="js/dumpdata.js"></script>
+  <script>
+    function revealreftests(a){
+
+        if (!a) a = document.getElementById('caniusetrigger');
+        a.parentNode && a.parentNode.removeChild(a);
+
+        var iframe = document.createElement('iframe');
+        iframe.src = 'caniuse.html';
+        iframe.style.cssText = 'width: 100%; height: 7000px; border: 15px double #F0C; \
+                                -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; ';
+        document.body.appendChild(iframe);
+
+        return false;
+    }
+
+    if (location.hash.replace(/^#/,'') == 'caniuse'){
+        setTimeout(revealreftests, 100);
+    }
+
+  </script>
+
+
+</body>
+</html>
diff --git a/profiles/commons/libraries/modernizr/test/js/basic.html b/profiles/commons/libraries/modernizr/test/js/basic.html
new file mode 100644
index 0000000..9f378a9
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/basic.html
@@ -0,0 +1,65 @@
+<!DOCTYPE html>
+<html class="+no-js no-js- no-js i-has-no-js">
+<head>
+  <meta charset="UTF-8">
+  <title>Modernizr Test Suite</title>
+  <link rel="stylesheet" href="qunit/qunit.css">
+  <style>
+     body { margin-bottom: 150px;}
+     #testbed { font-family: Helvetica; color: #444; padding-bottom: 100px;}
+     #testbed button { margin: 30px; font-size: 13px;}
+     .data-notes, .offScreen { display:none;}
+     table { width: 100%;}
+     tbody tr:nth-child(even) td, tbody tr:nth-child(even) th {  border: 1px solid #ccc; border-left: 0; border-right: 0;}
+     table td:nth-child(even), table th:nth-child(even) { background: #e6e6e6;}
+     table tbody tr:hover td, table tbody tr:hover th { background: #e1e100!important;}
+     td.wrong { background:red!important;}
+     #html5section { visibility: hidden; }
+     h1 label { display:none;}
+     .output { padding: 0 0 0 16px;}
+     .output ul { margin: 0;}
+     .output li { color: #854747; }
+     .output li.yes{color:#090;}
+     .output li b{color:#000;}
+     .output {font:14px/1.3 Inconsolata,Consolas,monospace;
+                    -webkit-column-count: 5;
+                       -moz-column-count: 5;
+                            column-count: 5;}
+      .output + .output { border-top: 5px solid #ccc; }
+      textarea { width: 100%; min-height: 75px;}
+      #caniusetrigger { font-size: 38px; font-family: monospace; display:block; }
+  </style>
+
+  <script src="https://raw.github.com/Modernizr/Modernizr/master/modernizr.js"></script>
+
+  <script>window.Modernizr || document.write('<script src="../modernizr.js"><\/script>'); console.log("Loading in the /js folder *trollface*")</script>
+
+  <script src="js/lib/polyfills.js"></script>
+  <script src="js/lib/detect-global.js"></script>
+  
+  <script src="qunit/qunit.js"></script>
+  <script src="js/lib/jquery-1.7b2.js"></script>
+  
+  <script src="js/setup.js"></script>
+  
+  <script src="js/unit.js"></script>
+</head>
+<body>
+  <h1 id="qunit-header">Modernizr Test Suite</h1>
+  <h2 id="qunit-banner"></h2>
+  <div id="qunit-testrunner-toolbar"></div>
+  <h2 id="qunit-userAgent"></h2>
+
+  <ol id="qunit-tests"></ol>
+
+  <div id="mod-output" class=output></div>
+  <div id="mod-feattest-output" class=output></div>
+
+
+  <br>
+ 
+  <section><aside>this is an aside within a section</aside></section>
+  
+  
+</body>
+</html> 
diff --git a/profiles/commons/libraries/modernizr/test/js/dumpdata.js b/profiles/commons/libraries/modernizr/test/js/dumpdata.js
new file mode 100644
index 0000000..43c667b
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/dumpdata.js
@@ -0,0 +1,75 @@
+function dumpModernizr(){
+  var str = '';
+  dumpModernizr.old = dumpModernizr.old || {};
+
+    for (var prop in Modernizr) {
+
+      // skip previously done ones.
+      if (dumpModernizr.old[prop]) continue;
+      else dumpModernizr.old[prop] = true;
+
+      if (typeof Modernizr[prop] === 'function') continue;
+      // skip unit test items
+      if (/^test/.test(prop)) continue;
+
+      if (~TEST.inputs.indexOf(prop)) {
+        str += '<li><b>'+prop+'{}</b><ul>';
+        for (var field in Modernizr[prop]) {
+          str += '<li class="' + (Modernizr[prop][field] ? 'yes' : '') + '">' + field + ': ' + Modernizr[prop][field] + '</li>';
+        }
+        str += '</ul></li>';
+      } else {
+        str += '<li  id="'+prop+'" class="' + (Modernizr[prop] ? 'yes' : '') + '">' + prop + ': ' + Modernizr[prop] + '</li>';
+      }
+  }
+  return str;
+}
+
+
+function grabFeatDetects(){
+  // thx github.js
+  $.getScript('https://api.github.com/repos/Modernizr/Modernizr/git/trees/master?recursive=1&callback=processTree');
+}
+
+
+function processTree(data){
+  var filenames = [];
+
+  for (var i = 0; i < data.data.tree.length; i++){
+    var file = data.data.tree[i];
+    var match = file.path.match(/^feature-detects\/(.*)/);
+    if (!match) continue;
+
+    var relpath = location.host == "modernizr.github.com" ?
+                    '../modernizr-git/' : '../';
+
+    filenames.push(relpath + match[0]);
+  }
+
+  var jqxhrs = filenames.map(function(filename){
+    return jQuery.getScript(filename);
+  });
+
+  jQuery.when.apply(jQuery, jqxhrs).done(resultsToDOM);
+
+}
+
+function resultsToDOM(){
+
+  var modOutput = document.createElement('div'),
+      ref = document.getElementById('qunit-testresult') || document.getElementById('qunit-tests');
+
+  modOutput.className = 'output';
+  modOutput.innerHTML = dumpModernizr();
+
+  ref.parentNode.insertBefore(modOutput, ref);
+
+  // Modernizr object as text
+  document.getElementsByTagName('textarea')[0].innerHTML = JSON.stringify(Modernizr);
+
+}
+
+/* uno    */ resultsToDOM();
+/* dos    */ grabFeatDetects();
+/* tres   */ setTimeout(resultsToDOM,  5e3);
+/* quatro */ setTimeout(resultsToDOM, 15e3);
diff --git a/profiles/commons/libraries/modernizr/test/js/lib/detect-global.js b/profiles/commons/libraries/modernizr/test/js/lib/detect-global.js
new file mode 100644
index 0000000..48b4ac2
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/lib/detect-global.js
@@ -0,0 +1,153 @@
+// https://github.com/kangax/detect-global
+
+// tweaked to run without a UI.
+
+(function () {
+    function getPropertyDescriptors(object) {
+      var props = { };
+      for (var prop in object) {
+        
+        // nerfing for firefox who goes crazy over some objects like sessionStorage
+        try {
+          
+          props[prop] = {
+            type:  typeof object[prop],
+            value: object[prop]
+          };
+          
+        } catch(e){
+          props[prop] = {}; 
+        }
+      }
+      return props;
+    }
+    
+    function getCleanWindow() {
+      var elIframe = document.createElement('iframe');
+      elIframe.style.display = 'none';
+      
+      var ref = document.getElementsByTagName('script')[0];
+      ref.parentNode.insertBefore(elIframe, ref);
+      
+      elIframe.src = 'about:blank';
+      return elIframe.contentWindow;
+    }
+    
+    function appendControl(el, name) {
+      var elCheckbox = document.createElement('input');
+      elCheckbox.type = 'checkbox';
+      elCheckbox.checked = true;
+      elCheckbox.id = '__' + name;
+      
+      var elLabel = document.createElement('label');
+      elLabel.htmlFor = '__' + name;
+      elLabel.innerHTML = 'Exclude ' + name + ' properties?';
+      elLabel.style.marginLeft = '0.5em';
+      
+      var elWrapper = document.createElement('p');
+      elWrapper.style.marginBottom = '0.5em';
+      
+      elWrapper.appendChild(elCheckbox);
+      elWrapper.appendChild(elLabel);
+
+      el.appendChild(elWrapper);
+    }
+    
+    function appendAnalyze(el) {
+      var elAnalyze = document.createElement('button');
+      elAnalyze.id = '__analyze';
+      elAnalyze.innerHTML = 'Analyze';
+      elAnalyze.style.marginTop = '1em';
+      el.appendChild(elAnalyze);
+    }
+    
+    function appendCancel(el) {
+      var elCancel = document.createElement('a');
+      elCancel.href = '#';
+      elCancel.innerHTML = 'Cancel';
+      elCancel.style.cssText = 'color:#eee;margin-left:0.5em;';
+      elCancel.onclick = function() {
+        el.parentNode.removeChild(el);
+        return false; 
+      };
+      el.appendChild(elCancel);
+    }
+    
+    function initConfigPopup() {
+      var el = document.createElement('div');
+      
+      el.style.cssText =  'position:fixed; left:10px; top:10px; width:300px; background:rgba(50,50,50,0.9);' +
+                          '-moz-border-radius:10px; padding:1em; color: #eee; text-align: left;' +
+                          'font-family: "Helvetica Neue", Verdana, Arial, sans serif; z-index: 99999;';
+      
+      for (var prop in propSets) {
+        appendControl(el, prop);
+      }
+      
+      appendAnalyze(el);
+      appendCancel(el);
+      
+      var ref = document.getElementsByTagName('script')[0];
+      ref.parentNode.insertBefore(el, ref);
+    }
+    
+    function getPropsCount(object) {
+      var count = 0;
+      for (var prop in object) {
+        count++;
+      }
+      return count;
+    }
+    
+    function shouldDeleteProperty(propToCheck) {
+      for (var prop in propSets) {
+        var elCheckbox = document.getElementById('__' + prop);
+        var isPropInSet = propSets[prop].indexOf(propToCheck) > -1;
+        if (isPropInSet && (elCheckbox ? elCheckbox.checked : true) ) {
+          return true;
+        }
+      }
+    }
+    
+    function analyze() {
+      var global = (function(){ return this; })(),
+          globalProps = getPropertyDescriptors(global),
+          cleanWindow = getCleanWindow();
+          
+      for (var prop in cleanWindow) {
+        if (globalProps[prop]) {
+          delete globalProps[prop];
+        }
+      }
+      for (var prop in globalProps) {
+        if (shouldDeleteProperty(prop)) {
+          delete globalProps[prop];
+        }
+      }
+      
+      window.__globalsCount = getPropsCount(globalProps);
+      window.__globals      = globalProps;
+      
+      window.console && console.log('Total number of global properties: ' + __globalsCount);
+      window.console && console.dir(__globals);
+    }
+    
+    var propSets = {
+      'Prototype':        '$$ $A $F $H $R $break $continue $w Abstract Ajax Class Enumerable Element Field Form ' +
+                          'Hash Insertion ObjectRange PeriodicalExecuter Position Prototype Selector Template Toggle Try'.split(' '),
+                        
+      'Scriptaculous':    'Autocompleter Builder Control Draggable Draggables Droppables Effect Sortable SortableObserver Sound Scriptaculous'.split(' '),
+      'Firebug':          'loadFirebugConsole console _getFirebugConsoleElement _FirebugConsole _FirebugCommandLine _firebug'.split(' '),
+      'Mozilla':          'Components XPCNativeWrapper XPCSafeJSObjectWrapper getInterface netscape GetWeakReference GeckoActiveXObject'.split(' '),
+      'GoogleAnalytics':  'gaJsHost gaGlobal _gat _gaq pageTracker'.split(' '),
+      'lazyGlobals':      'onhashchange'.split(' ')
+    };
+    
+    // initConfigPopup(); // disable because we're going UI-less.
+    
+    var analyzeElem = document.getElementById('__analyze');
+    analyzeElem && (analyzeElem.onclick = analyze);
+    
+    analyze(); // and assign total added globals to window.__globalsCount
+    
+})();
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/test/js/lib/jquery-1.7b2.js b/profiles/commons/libraries/modernizr/test/js/lib/jquery-1.7b2.js
new file mode 100644
index 0000000..98c6d0d
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/lib/jquery-1.7b2.js
@@ -0,0 +1,9279 @@
+/*!
+ * jQuery JavaScript Library v1.7b2
+ * http://jquery.com/
+ *
+ * Copyright 2011, John Resig
+ * Dual licensed under the MIT or GPL Version 2 licenses.
+ * http://jquery.org/license
+ *
+ * Includes Sizzle.js
+ * http://sizzlejs.com/
+ * Copyright 2011, The Dojo Foundation
+ * Released under the MIT, BSD, and GPL Licenses.
+ *
+ * Date: Thu Oct 13 21:12:55 2011 -0400
+ */
+(function( window, undefined ) {
+
+// Use the correct document accordingly with window argument (sandbox)
+var document = window.document,
+	navigator = window.navigator,
+	location = window.location;
+var jQuery = (function() {
+
+// Define a local copy of jQuery
+var jQuery = function( selector, context ) {
+		// The jQuery object is actually just the init constructor 'enhanced'
+		return new jQuery.fn.init( selector, context, rootjQuery );
+	},
+
+	// Map over jQuery in case of overwrite
+	_jQuery = window.jQuery,
+
+	// Map over the $ in case of overwrite
+	_$ = window.$,
+
+	// A central reference to the root jQuery(document)
+	rootjQuery,
+
+	// A simple way to check for HTML strings or ID strings
+	// Prioritize #id over <tag> to avoid XSS via location.hash (#9521)
+	quickExpr = /^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,
+
+	// Check if a string has a non-whitespace character in it
+	rnotwhite = /\S/,
+
+	// Used for trimming whitespace
+	trimLeft = /^\s+/,
+	trimRight = /\s+$/,
+
+	// Check for digits
+	rdigit = /\d/,
+
+	// Match a standalone tag
+	rsingleTag = /^<(\w+)\s*\/?>(?:<\/\1>)?$/,
+
+	// JSON RegExp
+	rvalidchars = /^[\],:{}\s]*$/,
+	rvalidescape = /\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,
+	rvalidtokens = /"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
+	rvalidbraces = /(?:^|:|,)(?:\s*\[)+/g,
+
+	// Useragent RegExp
+	rwebkit = /(webkit)[ \/]([\w.]+)/,
+	ropera = /(opera)(?:.*version)?[ \/]([\w.]+)/,
+	rmsie = /(msie) ([\w.]+)/,
+	rmozilla = /(mozilla)(?:.*? rv:([\w.]+))?/,
+
+	// Matches dashed string for camelizing
+	rdashAlpha = /-([a-z]|[0-9])/ig,
+	rmsPrefix = /^-ms-/,
+
+	// Used by jQuery.camelCase as callback to replace()
+	fcamelCase = function( all, letter ) {
+		return ( letter + "" ).toUpperCase();
+	},
+
+	// Keep a UserAgent string for use with jQuery.browser
+	userAgent = navigator.userAgent,
+
+	// For matching the engine and version of the browser
+	browserMatch,
+
+	// The deferred used on DOM ready
+	readyList,
+
+	// The ready event handler
+	DOMContentLoaded,
+
+	// Save a reference to some core methods
+	toString = Object.prototype.toString,
+	hasOwn = Object.prototype.hasOwnProperty,
+	push = Array.prototype.push,
+	slice = Array.prototype.slice,
+	trim = String.prototype.trim,
+	indexOf = Array.prototype.indexOf,
+
+	// [[Class]] -> type pairs
+	class2type = {};
+
+jQuery.fn = jQuery.prototype = {
+	constructor: jQuery,
+	init: function( selector, context, rootjQuery ) {
+		var match, elem, ret, doc;
+
+		// Handle $(""), $(null), or $(undefined)
+		if ( !selector ) {
+			return this;
+		}
+
+		// Handle $(DOMElement)
+		if ( selector.nodeType ) {
+			this.context = this[0] = selector;
+			this.length = 1;
+			return this;
+		}
+
+		// The body element only exists once, optimize finding it
+		if ( selector === "body" && !context && document.body ) {
+			this.context = document;
+			this[0] = document.body;
+			this.selector = selector;
+			this.length = 1;
+			return this;
+		}
+
+		// Handle HTML strings
+		if ( typeof selector === "string" ) {
+			// Are we dealing with HTML string or an ID?
+			if ( selector.charAt(0) === "<" && selector.charAt( selector.length - 1 ) === ">" && selector.length >= 3 ) {
+				// Assume that strings that start and end with <> are HTML and skip the regex check
+				match = [ null, selector, null ];
+
+			} else {
+				match = quickExpr.exec( selector );
+			}
+
+			// Verify a match, and that no context was specified for #id
+			if ( match && (match[1] || !context) ) {
+
+				// HANDLE: $(html) -> $(array)
+				if ( match[1] ) {
+					context = context instanceof jQuery ? context[0] : context;
+					doc = (context ? context.ownerDocument || context : document);
+
+					// If a single string is passed in and it's a single tag
+					// just do a createElement and skip the rest
+					ret = rsingleTag.exec( selector );
+
+					if ( ret ) {
+						if ( jQuery.isPlainObject( context ) ) {
+							selector = [ document.createElement( ret[1] ) ];
+							jQuery.fn.attr.call( selector, context, true );
+
+						} else {
+							selector = [ doc.createElement( ret[1] ) ];
+						}
+
+					} else {
+						ret = jQuery.buildFragment( [ match[1] ], [ doc ] );
+						selector = (ret.cacheable ? jQuery.clone(ret.fragment) : ret.fragment).childNodes;
+					}
+
+					return jQuery.merge( this, selector );
+
+				// HANDLE: $("#id")
+				} else {
+					elem = document.getElementById( match[2] );
+
+					// Check parentNode to catch when Blackberry 4.6 returns
+					// nodes that are no longer in the document #6963
+					if ( elem && elem.parentNode ) {
+						// Handle the case where IE and Opera return items
+						// by name instead of ID
+						if ( elem.id !== match[2] ) {
+							return rootjQuery.find( selector );
+						}
+
+						// Otherwise, we inject the element directly into the jQuery object
+						this.length = 1;
+						this[0] = elem;
+					}
+
+					this.context = document;
+					this.selector = selector;
+					return this;
+				}
+
+			// HANDLE: $(expr, $(...))
+			} else if ( !context || context.jquery ) {
+				return (context || rootjQuery).find( selector );
+
+			// HANDLE: $(expr, context)
+			// (which is just equivalent to: $(context).find(expr)
+			} else {
+				return this.constructor( context ).find( selector );
+			}
+
+		// HANDLE: $(function)
+		// Shortcut for document ready
+		} else if ( jQuery.isFunction( selector ) ) {
+			return rootjQuery.ready( selector );
+		}
+
+		if (selector.selector !== undefined) {
+			this.selector = selector.selector;
+			this.context = selector.context;
+		}
+
+		return jQuery.makeArray( selector, this );
+	},
+
+	// Start with an empty selector
+	selector: "",
+
+	// The current version of jQuery being used
+	jquery: "1.7b2",
+
+	// The default length of a jQuery object is 0
+	length: 0,
+
+	// The number of elements contained in the matched element set
+	size: function() {
+		return this.length;
+	},
+
+	toArray: function() {
+		return slice.call( this, 0 );
+	},
+
+	// Get the Nth element in the matched element set OR
+	// Get the whole matched element set as a clean array
+	get: function( num ) {
+		return num == null ?
+
+			// Return a 'clean' array
+			this.toArray() :
+
+			// Return just the object
+			( num < 0 ? this[ this.length + num ] : this[ num ] );
+	},
+
+	// Take an array of elements and push it onto the stack
+	// (returning the new matched element set)
+	pushStack: function( elems, name, selector ) {
+		// Build a new jQuery matched element set
+		var ret = this.constructor();
+
+		if ( jQuery.isArray( elems ) ) {
+			push.apply( ret, elems );
+
+		} else {
+			jQuery.merge( ret, elems );
+		}
+
+		// Add the old object onto the stack (as a reference)
+		ret.prevObject = this;
+
+		ret.context = this.context;
+
+		if ( name === "find" ) {
+			ret.selector = this.selector + (this.selector ? " " : "") + selector;
+		} else if ( name ) {
+			ret.selector = this.selector + "." + name + "(" + selector + ")";
+		}
+
+		// Return the newly-formed element set
+		return ret;
+	},
+
+	// Execute a callback for every element in the matched set.
+	// (You can seed the arguments with an array of args, but this is
+	// only used internally.)
+	each: function( callback, args ) {
+		return jQuery.each( this, callback, args );
+	},
+
+	ready: function( fn ) {
+		// Attach the listeners
+		jQuery.bindReady();
+
+		// Add the callback
+		readyList.add( fn );
+
+		return this;
+	},
+
+	eq: function( i ) {
+		return i === -1 ?
+			this.slice( i ) :
+			this.slice( i, +i + 1 );
+	},
+
+	first: function() {
+		return this.eq( 0 );
+	},
+
+	last: function() {
+		return this.eq( -1 );
+	},
+
+	slice: function() {
+		return this.pushStack( slice.apply( this, arguments ),
+			"slice", slice.call(arguments).join(",") );
+	},
+
+	map: function( callback ) {
+		return this.pushStack( jQuery.map(this, function( elem, i ) {
+			return callback.call( elem, i, elem );
+		}));
+	},
+
+	end: function() {
+		return this.prevObject || this.constructor(null);
+	},
+
+	// For internal use only.
+	// Behaves like an Array's method, not like a jQuery method.
+	push: push,
+	sort: [].sort,
+	splice: [].splice
+};
+
+// Give the init function the jQuery prototype for later instantiation
+jQuery.fn.init.prototype = jQuery.fn;
+
+jQuery.extend = jQuery.fn.extend = function() {
+	var options, name, src, copy, copyIsArray, clone,
+		target = arguments[0] || {},
+		i = 1,
+		length = arguments.length,
+		deep = false;
+
+	// Handle a deep copy situation
+	if ( typeof target === "boolean" ) {
+		deep = target;
+		target = arguments[1] || {};
+		// skip the boolean and the target
+		i = 2;
+	}
+
+	// Handle case when target is a string or something (possible in deep copy)
+	if ( typeof target !== "object" && !jQuery.isFunction(target) ) {
+		target = {};
+	}
+
+	// extend jQuery itself if only one argument is passed
+	if ( length === i ) {
+		target = this;
+		--i;
+	}
+
+	for ( ; i < length; i++ ) {
+		// Only deal with non-null/undefined values
+		if ( (options = arguments[ i ]) != null ) {
+			// Extend the base object
+			for ( name in options ) {
+				src = target[ name ];
+				copy = options[ name ];
+
+				// Prevent never-ending loop
+				if ( target === copy ) {
+					continue;
+				}
+
+				// Recurse if we're merging plain objects or arrays
+				if ( deep && copy && ( jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy)) ) ) {
+					if ( copyIsArray ) {
+						copyIsArray = false;
+						clone = src && jQuery.isArray(src) ? src : [];
+
+					} else {
+						clone = src && jQuery.isPlainObject(src) ? src : {};
+					}
+
+					// Never move original objects, clone them
+					target[ name ] = jQuery.extend( deep, clone, copy );
+
+				// Don't bring in undefined values
+				} else if ( copy !== undefined ) {
+					target[ name ] = copy;
+				}
+			}
+		}
+	}
+
+	// Return the modified object
+	return target;
+};
+
+jQuery.extend({
+	noConflict: function( deep ) {
+		if ( window.$ === jQuery ) {
+			window.$ = _$;
+		}
+
+		if ( deep && window.jQuery === jQuery ) {
+			window.jQuery = _jQuery;
+		}
+
+		return jQuery;
+	},
+
+	// Is the DOM ready to be used? Set to true once it occurs.
+	isReady: false,
+
+	// A counter to track how many items to wait for before
+	// the ready event fires. See #6781
+	readyWait: 1,
+
+	// Hold (or release) the ready event
+	holdReady: function( hold ) {
+		if ( hold ) {
+			jQuery.readyWait++;
+		} else {
+			jQuery.ready( true );
+		}
+	},
+
+	// Handle when the DOM is ready
+	ready: function( wait ) {
+		// Either a released hold or an DOMready/load event and not yet ready
+		if ( (wait === true && !--jQuery.readyWait) || (wait !== true && !jQuery.isReady) ) {
+			// Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).
+			if ( !document.body ) {
+				return setTimeout( jQuery.ready, 1 );
+			}
+
+			// Remember that the DOM is ready
+			jQuery.isReady = true;
+
+			// If a normal DOM Ready event fired, decrement, and wait if need be
+			if ( wait !== true && --jQuery.readyWait > 0 ) {
+				return;
+			}
+
+			// If there are functions bound, to execute
+			readyList.fireWith( document, [ jQuery ] );
+
+			// Trigger any bound ready events
+			if ( jQuery.fn.trigger ) {
+				jQuery( document ).trigger( "ready" ).unbind( "ready" );
+			}
+		}
+	},
+
+	bindReady: function() {
+		if ( readyList ) {
+			return;
+		}
+
+		readyList = jQuery.Callbacks( "once memory" );
+
+		// Catch cases where $(document).ready() is called after the
+		// browser event has already occurred.
+		if ( document.readyState === "complete" ) {
+			// Handle it asynchronously to allow scripts the opportunity to delay ready
+			return setTimeout( jQuery.ready, 1 );
+		}
+
+		// Mozilla, Opera and webkit nightlies currently support this event
+		if ( document.addEventListener ) {
+			// Use the handy event callback
+			document.addEventListener( "DOMContentLoaded", DOMContentLoaded, false );
+
+			// A fallback to window.onload, that will always work
+			window.addEventListener( "load", jQuery.ready, false );
+
+		// If IE event model is used
+		} else if ( document.attachEvent ) {
+			// ensure firing before onload,
+			// maybe late but safe also for iframes
+			document.attachEvent( "onreadystatechange", DOMContentLoaded );
+
+			// A fallback to window.onload, that will always work
+			window.attachEvent( "onload", jQuery.ready );
+
+			// If IE and not a frame
+			// continually check to see if the document is ready
+			var toplevel = false;
+
+			try {
+				toplevel = window.frameElement == null;
+			} catch(e) {}
+
+			if ( document.documentElement.doScroll && toplevel ) {
+				doScrollCheck();
+			}
+		}
+	},
+
+	// See test/unit/core.js for details concerning isFunction.
+	// Since version 1.3, DOM methods and functions like alert
+	// aren't supported. They return false on IE (#2968).
+	isFunction: function( obj ) {
+		return jQuery.type(obj) === "function";
+	},
+
+	isArray: Array.isArray || function( obj ) {
+		return jQuery.type(obj) === "array";
+	},
+
+	// A crude way of determining if an object is a window
+	isWindow: function( obj ) {
+		return obj && typeof obj === "object" && "setInterval" in obj;
+	},
+
+	isNumeric: function( obj ) {
+		return obj != null && rdigit.test( obj ) && !isNaN( obj );
+	},
+
+	type: function( obj ) {
+		return obj == null ?
+			String( obj ) :
+			class2type[ toString.call(obj) ] || "object";
+	},
+
+	isPlainObject: function( obj ) {
+		// Must be an Object.
+		// Because of IE, we also have to check the presence of the constructor property.
+		// Make sure that DOM nodes and window objects don't pass through, as well
+		if ( !obj || jQuery.type(obj) !== "object" || obj.nodeType || jQuery.isWindow( obj ) ) {
+			return false;
+		}
+
+		try {
+			// Not own constructor property must be Object
+			if ( obj.constructor &&
+				!hasOwn.call(obj, "constructor") &&
+				!hasOwn.call(obj.constructor.prototype, "isPrototypeOf") ) {
+				return false;
+			}
+		} catch ( e ) {
+			// IE8,9 Will throw exceptions on certain host objects #9897
+			return false;
+		}
+
+		// Own properties are enumerated firstly, so to speed up,
+		// if last one is own, then all properties are own.
+
+		var key;
+		for ( key in obj ) {}
+
+		return key === undefined || hasOwn.call( obj, key );
+	},
+
+	isEmptyObject: function( obj ) {
+		for ( var name in obj ) {
+			return false;
+		}
+		return true;
+	},
+
+	error: function( msg ) {
+		throw msg;
+	},
+
+	parseJSON: function( data ) {
+		if ( typeof data !== "string" || !data ) {
+			return null;
+		}
+
+		// Make sure leading/trailing whitespace is removed (IE can't handle it)
+		data = jQuery.trim( data );
+
+		// Attempt to parse using the native JSON parser first
+		if ( window.JSON && window.JSON.parse ) {
+			return window.JSON.parse( data );
+		}
+
+		// Make sure the incoming data is actual JSON
+		// Logic borrowed from http://json.org/json2.js
+		if ( rvalidchars.test( data.replace( rvalidescape, "@" )
+			.replace( rvalidtokens, "]" )
+			.replace( rvalidbraces, "")) ) {
+
+			return (new Function( "return " + data ))();
+
+		}
+		jQuery.error( "Invalid JSON: " + data );
+	},
+
+	// Cross-browser xml parsing
+	parseXML: function( data ) {
+		var xml, tmp;
+		try {
+			if ( window.DOMParser ) { // Standard
+				tmp = new DOMParser();
+				xml = tmp.parseFromString( data , "text/xml" );
+			} else { // IE
+				xml = new ActiveXObject( "Microsoft.XMLDOM" );
+				xml.async = "false";
+				xml.loadXML( data );
+			}
+		} catch( e ) {
+			xml = undefined;
+		}
+		if ( !xml || !xml.documentElement || xml.getElementsByTagName( "parsererror" ).length ) {
+			jQuery.error( "Invalid XML: " + data );
+		}
+		return xml;
+	},
+
+	noop: function() {},
+
+	// Evaluates a script in a global context
+	// Workarounds based on findings by Jim Driscoll
+	// http://weblogs.java.net/blog/driscoll/archive/2009/09/08/eval-javascript-global-context
+	globalEval: function( data ) {
+		if ( data && rnotwhite.test( data ) ) {
+			// We use execScript on Internet Explorer
+			// We use an anonymous function so that context is window
+			// rather than jQuery in Firefox
+			( window.execScript || function( data ) {
+				window[ "eval" ].call( window, data );
+			} )( data );
+		}
+	},
+
+	// Convert dashed to camelCase; used by the css and data modules
+	// Microsoft forgot to hump their vendor prefix (#9572)
+	camelCase: function( string ) {
+		return string.replace( rmsPrefix, "ms-" ).replace( rdashAlpha, fcamelCase );
+	},
+
+	nodeName: function( elem, name ) {
+		return elem.nodeName && elem.nodeName.toUpperCase() === name.toUpperCase();
+	},
+
+	// args is for internal usage only
+	each: function( object, callback, args ) {
+		var name, i = 0,
+			length = object.length,
+			isObj = length === undefined || jQuery.isFunction( object );
+
+		if ( args ) {
+			if ( isObj ) {
+				for ( name in object ) {
+					if ( callback.apply( object[ name ], args ) === false ) {
+						break;
+					}
+				}
+			} else {
+				for ( ; i < length; ) {
+					if ( callback.apply( object[ i++ ], args ) === false ) {
+						break;
+					}
+				}
+			}
+
+		// A special, fast, case for the most common use of each
+		} else {
+			if ( isObj ) {
+				for ( name in object ) {
+					if ( callback.call( object[ name ], name, object[ name ] ) === false ) {
+						break;
+					}
+				}
+			} else {
+				for ( ; i < length; ) {
+					if ( callback.call( object[ i ], i, object[ i++ ] ) === false ) {
+						break;
+					}
+				}
+			}
+		}
+
+		return object;
+	},
+
+	// Use native String.trim function wherever possible
+	trim: trim ?
+		function( text ) {
+			return text == null ?
+				"" :
+				trim.call( text );
+		} :
+
+		// Otherwise use our own trimming functionality
+		function( text ) {
+			return text == null ?
+				"" :
+				text.toString().replace( trimLeft, "" ).replace( trimRight, "" );
+		},
+
+	// results is for internal usage only
+	makeArray: function( array, results ) {
+		var ret = results || [];
+
+		if ( array != null ) {
+			// The window, strings (and functions) also have 'length'
+			// The extra typeof function check is to prevent crashes
+			// in Safari 2 (See: #3039)
+			// Tweaked logic slightly to handle Blackberry 4.7 RegExp issues #6930
+			var type = jQuery.type( array );
+
+			if ( array.length == null || type === "string" || type === "function" || type === "regexp" || jQuery.isWindow( array ) ) {
+				push.call( ret, array );
+			} else {
+				jQuery.merge( ret, array );
+			}
+		}
+
+		return ret;
+	},
+
+	inArray: function( elem, array, i ) {
+		var len;
+
+		if ( array ) {
+			if ( indexOf ) {
+				return indexOf.call( array, elem, i );
+			}
+
+			len = array.length;
+			i = i ? i < 0 ? Math.max( 0, len + i ) : i : 0;
+
+			for ( ; i < len; i++ ) {
+				// Skip accessing in sparse arrays
+				if ( i in array && array[ i ] === elem ) {
+					return i;
+				}
+			}
+		}
+
+		return -1;
+	},
+
+	merge: function( first, second ) {
+		var i = first.length,
+			j = 0;
+
+		if ( typeof second.length === "number" ) {
+			for ( var l = second.length; j < l; j++ ) {
+				first[ i++ ] = second[ j ];
+			}
+
+		} else {
+			while ( second[j] !== undefined ) {
+				first[ i++ ] = second[ j++ ];
+			}
+		}
+
+		first.length = i;
+
+		return first;
+	},
+
+	grep: function( elems, callback, inv ) {
+		var ret = [], retVal;
+		inv = !!inv;
+
+		// Go through the array, only saving the items
+		// that pass the validator function
+		for ( var i = 0, length = elems.length; i < length; i++ ) {
+			retVal = !!callback( elems[ i ], i );
+			if ( inv !== retVal ) {
+				ret.push( elems[ i ] );
+			}
+		}
+
+		return ret;
+	},
+
+	// arg is for internal usage only
+	map: function( elems, callback, arg ) {
+		var value, key, ret = [],
+			i = 0,
+			length = elems.length,
+			// jquery objects are treated as arrays
+			isArray = elems instanceof jQuery || length !== undefined && typeof length === "number" && ( ( length > 0 && elems[ 0 ] && elems[ length -1 ] ) || length === 0 || jQuery.isArray( elems ) ) ;
+
+		// Go through the array, translating each of the items to their
+		if ( isArray ) {
+			for ( ; i < length; i++ ) {
+				value = callback( elems[ i ], i, arg );
+
+				if ( value != null ) {
+					ret[ ret.length ] = value;
+				}
+			}
+
+		// Go through every key on the object,
+		} else {
+			for ( key in elems ) {
+				value = callback( elems[ key ], key, arg );
+
+				if ( value != null ) {
+					ret[ ret.length ] = value;
+				}
+			}
+		}
+
+		// Flatten any nested arrays
+		return ret.concat.apply( [], ret );
+	},
+
+	// A global GUID counter for objects
+	guid: 1,
+
+	// Bind a function to a context, optionally partially applying any
+	// arguments.
+	proxy: function( fn, context ) {
+		if ( typeof context === "string" ) {
+			var tmp = fn[ context ];
+			context = fn;
+			fn = tmp;
+		}
+
+		// Quick check to determine if target is callable, in the spec
+		// this throws a TypeError, but we will just return undefined.
+		if ( !jQuery.isFunction( fn ) ) {
+			return undefined;
+		}
+
+		// Simulated bind
+		var args = slice.call( arguments, 2 ),
+			proxy = function() {
+				return fn.apply( context, args.concat( slice.call( arguments ) ) );
+			};
+
+		// Set the guid of unique handler to the same of original handler, so it can be removed
+		proxy.guid = fn.guid = fn.guid || proxy.guid || jQuery.guid++;
+
+		return proxy;
+	},
+
+	// Mutifunctional method to get and set values to a collection
+	// The value/s can optionally be executed if it's a function
+	access: function( elems, key, value, exec, fn, pass ) {
+		var length = elems.length;
+
+		// Setting many attributes
+		if ( typeof key === "object" ) {
+			for ( var k in key ) {
+				jQuery.access( elems, k, key[k], exec, fn, value );
+			}
+			return elems;
+		}
+
+		// Setting one attribute
+		if ( value !== undefined ) {
+			// Optionally, function values get executed if exec is true
+			exec = !pass && exec && jQuery.isFunction(value);
+
+			for ( var i = 0; i < length; i++ ) {
+				fn( elems[i], key, exec ? value.call( elems[i], i, fn( elems[i], key ) ) : value, pass );
+			}
+
+			return elems;
+		}
+
+		// Getting an attribute
+		return length ? fn( elems[0], key ) : undefined;
+	},
+
+	now: function() {
+		return (new Date()).getTime();
+	},
+
+	// Use of jQuery.browser is frowned upon.
+	// More details: http://docs.jquery.com/Utilities/jQuery.browser
+	uaMatch: function( ua ) {
+		ua = ua.toLowerCase();
+
+		var match = rwebkit.exec( ua ) ||
+			ropera.exec( ua ) ||
+			rmsie.exec( ua ) ||
+			ua.indexOf("compatible") < 0 && rmozilla.exec( ua ) ||
+			[];
+
+		return { browser: match[1] || "", version: match[2] || "0" };
+	},
+
+	sub: function() {
+		function jQuerySub( selector, context ) {
+			return new jQuerySub.fn.init( selector, context );
+		}
+		jQuery.extend( true, jQuerySub, this );
+		jQuerySub.superclass = this;
+		jQuerySub.fn = jQuerySub.prototype = this();
+		jQuerySub.fn.constructor = jQuerySub;
+		jQuerySub.sub = this.sub;
+		jQuerySub.fn.init = function init( selector, context ) {
+			if ( context && context instanceof jQuery && !(context instanceof jQuerySub) ) {
+				context = jQuerySub( context );
+			}
+
+			return jQuery.fn.init.call( this, selector, context, rootjQuerySub );
+		};
+		jQuerySub.fn.init.prototype = jQuerySub.fn;
+		var rootjQuerySub = jQuerySub(document);
+		return jQuerySub;
+	},
+
+	browser: {}
+});
+
+// Populate the class2type map
+jQuery.each("Boolean Number String Function Array Date RegExp Object".split(" "), function(i, name) {
+	class2type[ "[object " + name + "]" ] = name.toLowerCase();
+});
+
+browserMatch = jQuery.uaMatch( userAgent );
+if ( browserMatch.browser ) {
+	jQuery.browser[ browserMatch.browser ] = true;
+	jQuery.browser.version = browserMatch.version;
+}
+
+// Deprecated, use jQuery.browser.webkit instead
+if ( jQuery.browser.webkit ) {
+	jQuery.browser.safari = true;
+}
+
+// IE doesn't match non-breaking spaces with \s
+if ( rnotwhite.test( "\xA0" ) ) {
+	trimLeft = /^[\s\xA0]+/;
+	trimRight = /[\s\xA0]+$/;
+}
+
+// All jQuery objects should point back to these
+rootjQuery = jQuery(document);
+
+// Cleanup functions for the document ready method
+if ( document.addEventListener ) {
+	DOMContentLoaded = function() {
+		document.removeEventListener( "DOMContentLoaded", DOMContentLoaded, false );
+		jQuery.ready();
+	};
+
+} else if ( document.attachEvent ) {
+	DOMContentLoaded = function() {
+		// Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).
+		if ( document.readyState === "complete" ) {
+			document.detachEvent( "onreadystatechange", DOMContentLoaded );
+			jQuery.ready();
+		}
+	};
+}
+
+// The DOM ready check for Internet Explorer
+function doScrollCheck() {
+	if ( jQuery.isReady ) {
+		return;
+	}
+
+	try {
+		// If IE is used, use the trick by Diego Perini
+		// http://javascript.nwbox.com/IEContentLoaded/
+		document.documentElement.doScroll("left");
+	} catch(e) {
+		setTimeout( doScrollCheck, 1 );
+		return;
+	}
+
+	// and execute any waiting functions
+	jQuery.ready();
+}
+
+// Expose jQuery as an AMD module, but only for AMD loaders that
+// understand the issues with loading multiple versions of jQuery
+// in a page that all might call define(). The loader will indicate
+// they have special allowances for multiple jQuery versions by
+// specifying define.amd.jQuery = true. Register as a named module,
+// since jQuery can be concatenated with other files that may use define,
+// but not use a proper concatenation script that understands anonymous
+// AMD modules. A named AMD is safest and most robust way to register.
+// Lowercase jquery is used because AMD module names are derived from
+// file names, and jQuery is normally delivered in a lowercase file name.
+if ( typeof define === "function" && define.amd && define.amd.jQuery ) {
+	define( "jquery", [], function () { return jQuery; } );
+}
+
+return jQuery;
+
+})();
+
+
+// String to Object flags format cache
+var flagsCache = {};
+
+// Convert String-formatted flags into Object-formatted ones and store in cache
+function createFlags( flags ) {
+	var object = flagsCache[ flags ] = {},
+		i, length;
+	flags = flags.split( /\s+/ );
+	for ( i = 0, length = flags.length; i < length; i++ ) {
+		object[ flags[i] ] = true;
+	}
+	return object;
+}
+
+/*
+ * Create a callback list using the following parameters:
+ *
+ *	flags:	an optional list of space-separated flags that will change how
+ *			the callback list behaves
+ *
+ * By default a callback list will act like an event callback list and can be
+ * "fired" multiple times.
+ *
+ * Possible flags:
+ *
+ *	once:			will ensure the callback list can only be fired once (like a Deferred)
+ *
+ *	memory:			will keep track of previous values and will call any callback added
+ *					after the list has been fired right away with the latest "memorized"
+ *					values (like a Deferred)
+ *
+ *	unique:			will ensure a callback can only be added once (no duplicate in the list)
+ *
+ *	stopOnFalse:	interrupt callings when a callback returns false
+ *
+ */
+jQuery.Callbacks = function( flags ) {
+
+	// Convert flags from String-formatted to Object-formatted
+	// (we check in cache first)
+	flags = flags ? ( flagsCache[ flags ] || createFlags( flags ) ) : {};
+
+	var // Actual callback list
+		list = [],
+		// Stack of fire calls for repeatable lists
+		stack = [],
+		// Last fire value (for non-forgettable lists)
+		memory,
+		// Flag to know if list is currently firing
+		firing,
+		// First callback to fire (used internally by add and fireWith)
+		firingStart,
+		// End of the loop when firing
+		firingLength,
+		// Index of currently firing callback (modified by remove if needed)
+		firingIndex,
+		// Add one or several callbacks to the list
+		add = function( args ) {
+			var i,
+				length,
+				elem,
+				type,
+				actual;
+			for ( i = 0, length = args.length; i < length; i++ ) {
+				elem = args[ i ];
+				type = jQuery.type( elem );
+				if ( type === "array" ) {
+					// Inspect recursively
+					add( elem );
+				} else if ( type === "function" ) {
+					// Add if not in unique mode and callback is not in
+					if ( !flags.unique || !self.has( elem ) ) {
+						list.push( elem );
+					}
+				}
+			}
+		},
+		// Fire callbacks
+		fire = function( context, args ) {
+			args = args || [];
+			memory = !flags.memory || [ context, args ];
+			firing = true;
+			firingIndex = firingStart || 0;
+			firingStart = 0;
+			firingLength = list.length;
+			for ( ; list && firingIndex < firingLength; firingIndex++ ) {
+				if ( list[ firingIndex ].apply( context, args ) === false && flags.stopOnFalse ) {
+					memory = true; // Mark as halted
+					break;
+				}
+			}
+			firing = false;
+			if ( list ) {
+				if ( !flags.once ) {
+					if ( stack && stack.length ) {
+						memory = stack.shift();
+						self.fireWith( memory[ 0 ], memory[ 1 ] );
+					}
+				} else if ( memory === true ) {
+					self.disable();
+				} else {
+					list = [];
+				}
+			}
+		},
+		// Actual Callbacks object
+		self = {
+			// Add a callback or a collection of callbacks to the list
+			add: function() {
+				if ( list ) {
+					var length = list.length;
+					add( arguments );
+					// Do we need to add the callbacks to the
+					// current firing batch?
+					if ( firing ) {
+						firingLength = list.length;
+					// With memory, if we're not firing then
+					// we should call right away, unless previous
+					// firing was halted (stopOnFalse)
+					} else if ( memory && memory !== true ) {
+						firingStart = length;
+						fire( memory[ 0 ], memory[ 1 ] );
+					}
+				}
+				return this;
+			},
+			// Remove a callback from the list
+			remove: function() {
+				if ( list ) {
+					var args = arguments,
+						argIndex = 0,
+						argLength = args.length;
+					for ( ; argIndex < argLength ; argIndex++ ) {
+						for ( var i = 0; i < list.length; i++ ) {
+							if ( args[ argIndex ] === list[ i ] ) {
+								// Handle firingIndex and firingLength
+								if ( firing ) {
+									if ( i <= firingLength ) {
+										firingLength--;
+										if ( i <= firingIndex ) {
+											firingIndex--;
+										}
+									}
+								}
+								// Remove the element
+								list.splice( i--, 1 );
+								// If we have some unicity property then
+								// we only need to do this once
+								if ( flags.unique ) {
+									break;
+								}
+							}
+						}
+					}
+				}
+				return this;
+			},
+			// Control if a given callback is in the list
+			has: function( fn ) {
+				if ( list ) {
+					var i = 0,
+						length = list.length;
+					for ( ; i < length; i++ ) {
+						if ( fn === list[ i ] ) {
+							return true;
+						}
+					}
+				}
+				return false;
+			},
+			// Remove all callbacks from the list
+			empty: function() {
+				list = [];
+				return this;
+			},
+			// Have the list do nothing anymore
+			disable: function() {
+				list = stack = memory = undefined;
+				return this;
+			},
+			// Is it disabled?
+			disabled: function() {
+				return !list;
+			},
+			// Lock the list in its current state
+			lock: function() {
+				stack = undefined;
+				if ( !memory || memory === true ) {
+					self.disable();
+				}
+				return this;
+			},
+			// Is it locked?
+			locked: function() {
+				return !stack;
+			},
+			// Call all callbacks with the given context and arguments
+			fireWith: function( context, args ) {
+				if ( stack ) {
+					if ( firing ) {
+						if ( !flags.once ) {
+							stack.push( [ context, args ] );
+						}
+					} else if ( !( flags.once && memory ) ) {
+						fire( context, args );
+					}
+				}
+				return this;
+			},
+			// Call all the callbacks with the given arguments
+			fire: function() {
+				self.fireWith( this, arguments );
+				return this;
+			},
+			// To know if the callbacks have already been called at least once
+			fired: function() {
+				return !!memory;
+			}
+		};
+
+	return self;
+};
+
+
+
+
+var // Static reference to slice
+	sliceDeferred = [].slice;
+
+jQuery.extend({
+
+	Deferred: function( func ) {
+		var doneList = jQuery.Callbacks( "once memory" ),
+			failList = jQuery.Callbacks( "once memory" ),
+			progressList = jQuery.Callbacks( "memory" ),
+			state = "pending",
+			lists = {
+				resolve: doneList,
+				reject: failList,
+				notify: progressList
+			},
+			promise = {
+				done: doneList.add,
+				fail: failList.add,
+				progress: progressList.add,
+
+				state: function() {
+					return state;
+				},
+
+				// Deprecated
+				isResolved: doneList.fired,
+				isRejected: failList.fired,
+
+				then: function( doneCallbacks, failCallbacks, progressCallbacks ) {
+					deferred.done( doneCallbacks ).fail( failCallbacks ).progress( progressCallbacks );
+					return this;
+				},
+				always: function() {
+					return deferred.done.apply( deferred, arguments ).fail.apply( deferred, arguments );
+				},
+				pipe: function( fnDone, fnFail, fnProgress ) {
+					return jQuery.Deferred(function( newDefer ) {
+						jQuery.each( {
+							done: [ fnDone, "resolve" ],
+							fail: [ fnFail, "reject" ],
+							progress: [ fnProgress, "notify" ]
+						}, function( handler, data ) {
+							var fn = data[ 0 ],
+								action = data[ 1 ],
+								returned;
+							if ( jQuery.isFunction( fn ) ) {
+								deferred[ handler ](function() {
+									returned = fn.apply( this, arguments );
+									if ( returned && jQuery.isFunction( returned.promise ) ) {
+										returned.promise().then( newDefer.resolve, newDefer.reject, newDefer.notify );
+									} else {
+										newDefer[ action + "With" ]( this === deferred ? newDefer : this, [ returned ] );
+									}
+								});
+							} else {
+								deferred[ handler ]( newDefer[ action ] );
+							}
+						});
+					}).promise();
+				},
+				// Get a promise for this deferred
+				// If obj is provided, the promise aspect is added to the object
+				promise: function( obj ) {
+					if ( obj == null ) {
+						obj = promise;
+					} else {
+						for( var key in promise ) {
+							obj[ key ] = promise[ key ];
+						}
+					}
+					return obj;
+				}
+			},
+			deferred = promise.promise({}),
+			key;
+
+		for ( key in lists ) {
+			deferred[ key ] = lists[ key ].fire;
+			deferred[ key + "With" ] = lists[ key ].fireWith;
+		}
+
+		// Handle state
+		deferred.done( function() {
+			state = "resolved";
+		}, failList.disable, progressList.lock ).fail( function() {
+			state = "rejected";
+		}, doneList.disable, progressList.lock );
+
+		// Call given func if any
+		if ( func ) {
+			func.call( deferred, deferred );
+		}
+
+		// All done!
+		return deferred;
+	},
+
+	// Deferred helper
+	when: function( firstParam ) {
+		var args = sliceDeferred.call( arguments, 0 ),
+			i = 0,
+			length = args.length,
+			pValues = new Array( length ),
+			count = length,
+			pCount = length,
+			deferred = length <= 1 && firstParam && jQuery.isFunction( firstParam.promise ) ?
+				firstParam :
+				jQuery.Deferred(),
+			promise = deferred.promise();
+		function resolveFunc( i ) {
+			return function( value ) {
+				args[ i ] = arguments.length > 1 ? sliceDeferred.call( arguments, 0 ) : value;
+				if ( !( --count ) ) {
+					deferred.resolveWith( deferred, args );
+				}
+			};
+		}
+		function progressFunc( i ) {
+			return function( value ) {
+				pValues[ i ] = arguments.length > 1 ? sliceDeferred.call( arguments, 0 ) : value;
+				deferred.notifyWith( promise, pValues );
+			};
+		}
+		if ( length > 1 ) {
+			for( ; i < length; i++ ) {
+				if ( args[ i ] && args[ i ].promise && jQuery.isFunction( args[ i ].promise ) ) {
+					args[ i ].promise().then( resolveFunc(i), deferred.reject, progressFunc(i) );
+				} else {
+					--count;
+				}
+			}
+			if ( !count ) {
+				deferred.resolveWith( deferred, args );
+			}
+		} else if ( deferred !== firstParam ) {
+			deferred.resolveWith( deferred, length ? [ firstParam ] : [] );
+		}
+		return promise;
+	}
+});
+
+
+
+
+jQuery.support = (function() {
+
+	var div = document.createElement( "div" ),
+		documentElement = document.documentElement,
+		all,
+		a,
+		select,
+		opt,
+		input,
+		marginDiv,
+		support,
+		fragment,
+		body,
+		testElementParent,
+		testElement,
+		testElementStyle,
+		tds,
+		events,
+		eventName,
+		i,
+		isSupported,
+		offsetSupport;
+
+	// Preliminary tests
+	div.setAttribute("className", "t");
+	div.innerHTML = "   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/><nav></nav>";
+
+
+	all = div.getElementsByTagName( "*" );
+	a = div.getElementsByTagName( "a" )[ 0 ];
+
+	// Can't get basic test support
+	if ( !all || !all.length || !a ) {
+		return {};
+	}
+
+	// First batch of supports tests
+	select = document.createElement( "select" );
+	opt = select.appendChild( document.createElement("option") );
+	input = div.getElementsByTagName( "input" )[ 0 ];
+
+	support = {
+		// IE strips leading whitespace when .innerHTML is used
+		leadingWhitespace: ( div.firstChild.nodeType === 3 ),
+
+		// Make sure that tbody elements aren't automatically inserted
+		// IE will insert them into empty tables
+		tbody: !div.getElementsByTagName( "tbody" ).length,
+
+		// Make sure that link elements get serialized correctly by innerHTML
+		// This requires a wrapper element in IE
+		htmlSerialize: !!div.getElementsByTagName( "link" ).length,
+
+		// Get the style information from getAttribute
+		// (IE uses .cssText instead)
+		style: /top/.test( a.getAttribute("style") ),
+
+		// Make sure that URLs aren't manipulated
+		// (IE normalizes it by default)
+		hrefNormalized: ( a.getAttribute( "href" ) === "/a" ),
+
+		// Make sure that element opacity exists
+		// (IE uses filter instead)
+		// Use a regex to work around a WebKit issue. See #5145
+		opacity: /^0.55/.test( a.style.opacity ),
+
+		// Verify style float existence
+		// (IE uses styleFloat instead of cssFloat)
+		cssFloat: !!a.style.cssFloat,
+
+		// Make sure unknown elements (like HTML5 elems) are handled appropriately
+		unknownElems: !!div.getElementsByTagName( "nav" ).length,
+
+		// Make sure that if no value is specified for a checkbox
+		// that it defaults to "on".
+		// (WebKit defaults to "" instead)
+		checkOn: ( input.value === "on" ),
+
+		// Make sure that a selected-by-default option has a working selected property.
+		// (WebKit defaults to false instead of true, IE too, if it's in an optgroup)
+		optSelected: opt.selected,
+
+		// Test setAttribute on camelCase class. If it works, we need attrFixes when doing get/setAttribute (ie6/7)
+		getSetAttribute: div.className !== "t",
+
+		// Will be defined later
+		submitBubbles: true,
+		changeBubbles: true,
+		focusinBubbles: false,
+		deleteExpando: true,
+		noCloneEvent: true,
+		inlineBlockNeedsLayout: false,
+		shrinkWrapBlocks: false,
+		reliableMarginRight: true
+	};
+
+	// Make sure checked status is properly cloned
+	input.checked = true;
+	support.noCloneChecked = input.cloneNode( true ).checked;
+
+	// Make sure that the options inside disabled selects aren't marked as disabled
+	// (WebKit marks them as disabled)
+	select.disabled = true;
+	support.optDisabled = !opt.disabled;
+
+	// Test to see if it's possible to delete an expando from an element
+	// Fails in Internet Explorer
+	try {
+		delete div.test;
+	} catch( e ) {
+		support.deleteExpando = false;
+	}
+
+	if ( !div.addEventListener && div.attachEvent && div.fireEvent ) {
+		div.attachEvent( "onclick", function() {
+			// Cloning a node shouldn't copy over any
+			// bound event handlers (IE does this)
+			support.noCloneEvent = false;
+		});
+		div.cloneNode( true ).fireEvent( "onclick" );
+	}
+
+	// Check if a radio maintains its value
+	// after being appended to the DOM
+	input = document.createElement("input");
+	input.value = "t";
+	input.setAttribute("type", "radio");
+	support.radioValue = input.value === "t";
+
+	input.setAttribute("checked", "checked");
+	div.appendChild( input );
+	fragment = document.createDocumentFragment();
+	fragment.appendChild( div.firstChild );
+
+	// WebKit doesn't clone checked state correctly in fragments
+	support.checkClone = fragment.cloneNode( true ).cloneNode( true ).lastChild.checked;
+
+	div.innerHTML = "";
+
+	// Figure out if the W3C box model works as expected
+	div.style.width = div.style.paddingLeft = "1px";
+
+	// We don't want to do body-related feature tests on frameset
+	// documents, which lack a body. So we use
+	// document.getElementsByTagName("body")[0], which is undefined in
+	// frameset documents, while document.body isnt. (7398)
+	body = document.getElementsByTagName("body")[ 0 ];
+	// We use our own, invisible, body unless the body is already present
+	// in which case we use a div (#9239)
+	testElement = document.createElement( body ? "div" : "body" );
+	testElementStyle = {
+		visibility: "hidden",
+		width: 0,
+		height: 0,
+		border: 0,
+		margin: 0,
+		background: "none"
+	};
+	if ( body ) {
+		jQuery.extend( testElementStyle, {
+			position: "absolute",
+			left: "-999px",
+			top: "-999px"
+		});
+	}
+	for ( i in testElementStyle ) {
+		testElement.style[ i ] = testElementStyle[ i ];
+	}
+	testElement.appendChild( div );
+	testElementParent = body || documentElement;
+	testElementParent.insertBefore( testElement, testElementParent.firstChild );
+
+	// Check if a disconnected checkbox will retain its checked
+	// value of true after appended to the DOM (IE6/7)
+	support.appendChecked = input.checked;
+
+	support.boxModel = div.offsetWidth === 2;
+
+	if ( "zoom" in div.style ) {
+		// Check if natively block-level elements act like inline-block
+		// elements when setting their display to 'inline' and giving
+		// them layout
+		// (IE < 8 does this)
+		div.style.display = "inline";
+		div.style.zoom = 1;
+		support.inlineBlockNeedsLayout = ( div.offsetWidth === 2 );
+
+		// Check if elements with layout shrink-wrap their children
+		// (IE 6 does this)
+		div.style.display = "";
+		div.innerHTML = "<div style='width:4px;'></div>";
+		support.shrinkWrapBlocks = ( div.offsetWidth !== 2 );
+	}
+
+	div.innerHTML = "<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>";
+	tds = div.getElementsByTagName( "td" );
+
+	// Check if table cells still have offsetWidth/Height when they are set
+	// to display:none and there are still other visible table cells in a
+	// table row; if so, offsetWidth/Height are not reliable for use when
+	// determining if an element has been hidden directly using
+	// display:none (it is still safe to use offsets if a parent element is
+	// hidden; don safety goggles and see bug #4512 for more information).
+	// (only IE 8 fails this test)
+	isSupported = ( tds[ 0 ].offsetHeight === 0 );
+
+	tds[ 0 ].style.display = "";
+	tds[ 1 ].style.display = "none";
+
+	// Check if empty table cells still have offsetWidth/Height
+	// (IE < 8 fail this test)
+	support.reliableHiddenOffsets = isSupported && ( tds[ 0 ].offsetHeight === 0 );
+	div.innerHTML = "";
+
+	// Check if div with explicit width and no margin-right incorrectly
+	// gets computed margin-right based on width of container. For more
+	// info see bug #3333
+	// Fails in WebKit before Feb 2011 nightlies
+	// WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right
+	if ( document.defaultView && document.defaultView.getComputedStyle ) {
+		marginDiv = document.createElement( "div" );
+		marginDiv.style.width = "0";
+		marginDiv.style.marginRight = "0";
+		div.appendChild( marginDiv );
+		support.reliableMarginRight =
+			( parseInt( ( document.defaultView.getComputedStyle( marginDiv, null ) || { marginRight: 0 } ).marginRight, 10 ) || 0 ) === 0;
+	}
+
+	// Remove the body element we added
+	testElement.innerHTML = "";
+
+	// Technique from Juriy Zaytsev
+	// http://perfectionkills.com/detecting-event-support-without-browser-sniffing/
+	// We only care about the case where non-standard event systems
+	// are used, namely in IE. Short-circuiting here helps us to
+	// avoid an eval call (in setAttribute) which can cause CSP
+	// to go haywire. See: https://developer.mozilla.org/en/Security/CSP
+	if ( div.attachEvent ) {
+		for( i in {
+			submit: 1,
+			change: 1,
+			focusin: 1
+		} ) {
+			eventName = "on" + i;
+			isSupported = ( eventName in div );
+			if ( !isSupported ) {
+				div.setAttribute( eventName, "return;" );
+				isSupported = ( typeof div[ eventName ] === "function" );
+			}
+			support[ i + "Bubbles" ] = isSupported;
+		}
+	}
+
+	// Determine fixed-position support early
+	testElement.style.position = "static";
+	testElement.style.top = "0px";
+	testElement.style.marginTop = "1px";
+	offsetSupport = (function( body, container ) {
+
+		var outer, inner, table, td, supports,
+			bodyMarginTop = parseFloat( body.style.marginTop ) || 0,
+			ptlm = "position:absolute;top:0;left:0;width:1px;height:1px;margin:0;",
+			style = "style='" + ptlm + "border:5px solid #000;padding:0;'",
+			html = "<div " + style + "><div></div></div>" +
+							"<table " + style + " cellpadding='0' cellspacing='0'>" +
+							"<tr><td></td></tr></table>";
+
+		container.style.cssText = ptlm + "border:0;visibility:hidden";
+
+		container.innerHTML = html;
+		body.insertBefore( container, body.firstChild );
+		outer = container.firstChild;
+		inner = outer.firstChild;
+		td = outer.nextSibling.firstChild.firstChild;
+
+		supports = {
+			doesNotAddBorder: (inner.offsetTop !== 5),
+			doesAddBorderForTableAndCells: (td.offsetTop === 5)
+		};
+
+		inner.style.position = "fixed";
+		inner.style.top = "20px";
+
+		// safari subtracts parent border width here which is 5px
+		supports.supportsFixedPosition = (inner.offsetTop === 20 || inner.offsetTop === 15);
+		inner.style.position = inner.style.top = "";
+
+		outer.style.overflow = "hidden";
+		outer.style.position = "relative";
+
+		supports.subtractsBorderForOverflowNotVisible = (inner.offsetTop === -5);
+		supports.doesNotIncludeMarginInBodyOffset = (body.offsetTop !== bodyMarginTop);
+
+		return supports;
+
+	})( testElement, div );
+
+	jQuery.extend( support, offsetSupport );
+	testElementParent.removeChild( testElement );
+
+	// Null connected elements to avoid leaks in IE
+	testElement = fragment = select = opt = body = marginDiv = div = input = null;
+
+	return support;
+})();
+
+// Keep track of boxModel
+jQuery.boxModel = jQuery.support.boxModel;
+
+
+
+
+var rbrace = /^(?:\{.*\}|\[.*\])$/,
+	rmultiDash = /([A-Z])/g;
+
+jQuery.extend({
+	cache: {},
+
+	// Please use with caution
+	uuid: 0,
+
+	// Unique for each copy of jQuery on the page
+	// Non-digits removed to match rinlinejQuery
+	expando: "jQuery" + ( jQuery.fn.jquery + Math.random() ).replace( /\D/g, "" ),
+
+	// The following elements throw uncatchable exceptions if you
+	// attempt to add expando properties to them.
+	noData: {
+		"embed": true,
+		// Ban all objects except for Flash (which handle expandos)
+		"object": "clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",
+		"applet": true
+	},
+
+	hasData: function( elem ) {
+		elem = elem.nodeType ? jQuery.cache[ elem[jQuery.expando] ] : elem[ jQuery.expando ];
+		return !!elem && !isEmptyDataObject( elem );
+	},
+
+	data: function( elem, name, data, pvt /* Internal Use Only */ ) {
+		if ( !jQuery.acceptData( elem ) ) {
+			return;
+		}
+
+		var thisCache, ret,
+			internalKey = jQuery.expando,
+			getByName = typeof name === "string",
+
+			// We have to handle DOM nodes and JS objects differently because IE6-7
+			// can't GC object references properly across the DOM-JS boundary
+			isNode = elem.nodeType,
+
+			// Only DOM nodes need the global jQuery cache; JS object data is
+			// attached directly to the object so GC can occur automatically
+			cache = isNode ? jQuery.cache : elem,
+
+			// Only defining an ID for JS objects if its cache already exists allows
+			// the code to shortcut on the same path as a DOM node with no cache
+			id = isNode ? elem[ jQuery.expando ] : elem[ jQuery.expando ] && jQuery.expando;
+
+		// Avoid doing any more work than we need to when trying to get data on an
+		// object that has no data at all
+		if ( (!id || !cache[id] || (!pvt && !cache[id].data)) && getByName && data === undefined ) {
+			return;
+		}
+
+		if ( !id ) {
+			// Only DOM nodes need a new unique ID for each element since their data
+			// ends up in the global cache
+			if ( isNode ) {
+				elem[ jQuery.expando ] = id = ++jQuery.uuid;
+			} else {
+				id = jQuery.expando;
+			}
+		}
+
+		if ( !cache[ id ] ) {
+			cache[ id ] = {};
+
+			// Avoids exposing jQuery metadata on plain JS objects when the object 
+			// is serialized using JSON.stringify
+			if ( !isNode ) {
+				cache[ id ].toJSON = jQuery.noop;
+			}
+		}
+
+		// An object can be passed to jQuery.data instead of a key/value pair; this gets
+		// shallow copied over onto the existing cache
+		if ( typeof name === "object" || typeof name === "function" ) {
+			if ( pvt ) {
+				cache[ id ] = jQuery.extend( cache[ id ], name );
+			} else {
+				cache[ id ].data = jQuery.extend( cache[ id ].data, name );
+			}
+		}
+
+		thisCache = cache[ id ];
+
+		// jQuery data() is stored in a separate object inside the object's internal data
+		// cache in order to avoid key collisions between internal data and user-defined
+		// data.
+		if ( !pvt ) {
+			if ( !thisCache.data ) {
+				thisCache.data = {};
+			}
+
+			thisCache = thisCache.data;
+		}
+
+		if ( data !== undefined ) {
+			thisCache[ jQuery.camelCase( name ) ] = data;
+		}
+
+		// TODO: This is a hack for 1.5 ONLY. It will be removed in 1.6. Users should
+		// not attempt to inspect the internal events object using jQuery.data, as this
+		// internal data object is undocumented and subject to change.
+		if ( name === "events" && !thisCache[name] ) {
+			return thisCache[ internalKey ] && thisCache[ internalKey ].events;
+		}
+
+		// Check for both converted-to-camel and non-converted data property names
+		// If a data property was specified
+		if ( getByName ) {
+
+			// First Try to find as-is property data
+			ret = thisCache[ name ];
+
+			// Test for null|undefined property data
+			if ( ret == null ) {
+
+				// Try to find the camelCased property
+				ret = thisCache[ jQuery.camelCase( name ) ];
+			}
+		} else {
+			ret = thisCache;
+		}
+
+		return ret;
+	},
+
+	removeData: function( elem, name, pvt /* Internal Use Only */ ) {
+		if ( !jQuery.acceptData( elem ) ) {
+			return;
+		}
+
+		var thisCache, i, l,
+
+			// Reference to internal data cache key
+			internalKey = jQuery.expando,
+
+			isNode = elem.nodeType,
+
+			// See jQuery.data for more information
+			cache = isNode ? jQuery.cache : elem,
+
+			// See jQuery.data for more information
+			id = isNode ? elem[ jQuery.expando ] : jQuery.expando;
+
+		// If there is already no cache entry for this object, there is no
+		// purpose in continuing
+		if ( !cache[ id ] ) {
+			return;
+		}
+
+		if ( name ) {
+
+			thisCache = pvt ? cache[ id ] : cache[ id ].data;
+
+			if ( thisCache ) {
+
+				// Support space separated names
+				if ( jQuery.isArray( name ) ) {
+					name = name;
+				} else if ( name in thisCache ) {
+					name = [ name ];
+				} else {
+
+					// split the camel cased version by spaces
+					name = jQuery.camelCase( name );
+					if ( name in thisCache ) {
+						name = [ name ];
+					} else {
+						name = name.split( " " );
+					}
+				}
+
+				for ( i = 0, l = name.length; i < l; i++ ) {
+					delete thisCache[ name[i] ];
+				}
+
+				// If there is no data left in the cache, we want to continue
+				// and let the cache object itself get destroyed
+				if ( !( pvt ? isEmptyDataObject : jQuery.isEmptyObject )( thisCache ) ) {
+					return;
+				}
+			}
+		}
+
+		// See jQuery.data for more information
+		if ( !pvt ) {
+			delete cache[ id ].data;
+
+			// Don't destroy the parent cache unless the internal data object
+			// had been the only thing left in it
+			if ( !isEmptyDataObject(cache[ id ]) ) {
+				return;
+			}
+		}
+
+		// Browsers that fail expando deletion also refuse to delete expandos on
+		// the window, but it will allow it on all other JS objects; other browsers
+		// don't care
+		// Ensure that `cache` is not a window object #10080
+		if ( jQuery.support.deleteExpando || !cache.setInterval ) {
+			delete cache[ id ];
+		} else {
+			cache[ id ] = null;
+		}
+
+		// We destroyed the cache and need to eliminate the expando on the node to avoid
+		// false lookups in the cache for entries that no longer exist
+		if ( isNode ) {
+			// IE does not allow us to delete expando properties from nodes,
+			// nor does it have a removeAttribute function on Document nodes;
+			// we must handle all of these cases
+			if ( jQuery.support.deleteExpando ) {
+				delete elem[ jQuery.expando ];
+			} else if ( elem.removeAttribute ) {
+				elem.removeAttribute( jQuery.expando );
+			} else {
+				elem[ jQuery.expando ] = null;
+			}
+		}
+	},
+
+	// For internal use only.
+	_data: function( elem, name, data ) {
+		return jQuery.data( elem, name, data, true );
+	},
+
+	// A method for determining if a DOM node can handle the data expando
+	acceptData: function( elem ) {
+		if ( elem.nodeName ) {
+			var match = jQuery.noData[ elem.nodeName.toLowerCase() ];
+
+			if ( match ) {
+				return !(match === true || elem.getAttribute("classid") !== match);
+			}
+		}
+
+		return true;
+	}
+});
+
+jQuery.fn.extend({
+	data: function( key, value ) {
+		var parts, attr, name,
+			data = null;
+
+		if ( typeof key === "undefined" ) {
+			if ( this.length ) {
+				data = jQuery.data( this[0] );
+
+				if ( this[0].nodeType === 1 && !jQuery._data( this[0], "parsedAttrs" ) ) {
+					attr = this[0].attributes;
+					for ( var i = 0, l = attr.length; i < l; i++ ) {
+						name = attr[i].name;
+
+						if ( name.indexOf( "data-" ) === 0 ) {
+							name = jQuery.camelCase( name.substring(5) );
+
+							dataAttr( this[0], name, data[ name ] );
+						}
+					}
+					jQuery._data( this[0], "parsedAttrs", true );
+				}
+			}
+
+			return data;
+
+		} else if ( typeof key === "object" ) {
+			return this.each(function() {
+				jQuery.data( this, key );
+			});
+		}
+
+		parts = key.split(".");
+		parts[1] = parts[1] ? "." + parts[1] : "";
+
+		if ( value === undefined ) {
+			data = this.triggerHandler("getData" + parts[1] + "!", [parts[0]]);
+
+			// Try to fetch any internally stored data first
+			if ( data === undefined && this.length ) {
+				data = jQuery.data( this[0], key );
+				data = dataAttr( this[0], key, data );
+			}
+
+			return data === undefined && parts[1] ?
+				this.data( parts[0] ) :
+				data;
+
+		} else {
+			return this.each(function() {
+				var $this = jQuery( this ),
+					args = [ parts[0], value ];
+
+				$this.triggerHandler( "setData" + parts[1] + "!", args );
+				jQuery.data( this, key, value );
+				$this.triggerHandler( "changeData" + parts[1] + "!", args );
+			});
+		}
+	},
+
+	removeData: function( key ) {
+		return this.each(function() {
+			jQuery.removeData( this, key );
+		});
+	}
+});
+
+function dataAttr( elem, key, data ) {
+	// If nothing was found internally, try to fetch any
+	// data from the HTML5 data-* attribute
+	if ( data === undefined && elem.nodeType === 1 ) {
+
+		var name = "data-" + key.replace( rmultiDash, "-$1" ).toLowerCase();
+
+		data = elem.getAttribute( name );
+
+		if ( typeof data === "string" ) {
+			try {
+				data = data === "true" ? true :
+				data === "false" ? false :
+				data === "null" ? null :
+				jQuery.isNumeric( data ) ? parseFloat( data ) :
+					rbrace.test( data ) ? jQuery.parseJSON( data ) :
+					data;
+			} catch( e ) {}
+
+			// Make sure we set the data so it isn't changed later
+			jQuery.data( elem, key, data );
+
+		} else {
+			data = undefined;
+		}
+	}
+
+	return data;
+}
+
+// checks a cache object for emptiness
+function isEmptyDataObject( obj ) {
+	for ( var name in obj ) {
+
+		// if the public data object is empty, the private is still empty
+		if ( name === "data" && jQuery.isEmptyObject( obj[name] ) ) {
+			continue;
+		}
+		if ( name !== "toJSON" ) {
+			return false;
+		}
+	}
+
+	return true;
+}
+
+
+
+
+function handleQueueMarkDefer( elem, type, src ) {
+	var deferDataKey = type + "defer",
+		queueDataKey = type + "queue",
+		markDataKey = type + "mark",
+		defer = jQuery._data( elem, deferDataKey );
+	if ( defer &&
+		( src === "queue" || !jQuery._data(elem, queueDataKey) ) &&
+		( src === "mark" || !jQuery._data(elem, markDataKey) ) ) {
+		// Give room for hard-coded callbacks to fire first
+		// and eventually mark/queue something else on the element
+		setTimeout( function() {
+			if ( !jQuery._data( elem, queueDataKey ) &&
+				!jQuery._data( elem, markDataKey ) ) {
+				jQuery.removeData( elem, deferDataKey, true );
+				defer.fire();
+			}
+		}, 0 );
+	}
+}
+
+jQuery.extend({
+
+	_mark: function( elem, type ) {
+		if ( elem ) {
+			type = (type || "fx") + "mark";
+			jQuery._data( elem, type, (jQuery._data( elem, type ) || 0) + 1 );
+		}
+	},
+
+	_unmark: function( force, elem, type ) {
+		if ( force !== true ) {
+			type = elem;
+			elem = force;
+			force = false;
+		}
+		if ( elem ) {
+			type = type || "fx";
+			var key = type + "mark",
+				count = force ? 0 : ( (jQuery._data( elem, key ) || 1) - 1 );
+			if ( count ) {
+				jQuery._data( elem, key, count );
+			} else {
+				jQuery.removeData( elem, key, true );
+				handleQueueMarkDefer( elem, type, "mark" );
+			}
+		}
+	},
+
+	queue: function( elem, type, data ) {
+		var q;
+		if ( elem ) {
+			type = (type || "fx") + "queue";
+			q = jQuery._data( elem, type );
+
+			// Speed up dequeue by getting out quickly if this is just a lookup
+			if ( data ) {
+				if ( !q || jQuery.isArray(data) ) {
+					q = jQuery._data( elem, type, jQuery.makeArray(data) );
+				} else {
+					q.push( data );
+				}
+			}
+			return q || [];
+		}
+	},
+
+	dequeue: function( elem, type ) {
+		type = type || "fx";
+
+		var queue = jQuery.queue( elem, type ),
+			fn = queue.shift(),
+			runner = {};
+
+		// If the fx queue is dequeued, always remove the progress sentinel
+		if ( fn === "inprogress" ) {
+			fn = queue.shift();
+		}
+
+		if ( fn ) {
+			// Add a progress sentinel to prevent the fx queue from being
+			// automatically dequeued
+			if ( type === "fx" ) {
+				queue.unshift( "inprogress" );
+			}
+
+			jQuery._data( elem, type + ".run", runner );
+			fn.call( elem, function() {
+				jQuery.dequeue( elem, type );
+			}, runner );
+		}
+
+		if ( !queue.length ) {
+			jQuery.removeData( elem, type + "queue " + type + ".run", true );
+			handleQueueMarkDefer( elem, type, "queue" );
+		}
+	}
+});
+
+jQuery.fn.extend({
+	queue: function( type, data ) {
+		if ( typeof type !== "string" ) {
+			data = type;
+			type = "fx";
+		}
+
+		if ( data === undefined ) {
+			return jQuery.queue( this[0], type );
+		}
+		return this.each(function() {
+			var queue = jQuery.queue( this, type, data );
+
+			if ( type === "fx" && queue[0] !== "inprogress" ) {
+				jQuery.dequeue( this, type );
+			}
+		});
+	},
+	dequeue: function( type ) {
+		return this.each(function() {
+			jQuery.dequeue( this, type );
+		});
+	},
+	// Based off of the plugin by Clint Helfers, with permission.
+	// http://blindsignals.com/index.php/2009/07/jquery-delay/
+	delay: function( time, type ) {
+		time = jQuery.fx ? jQuery.fx.speeds[ time ] || time : time;
+		type = type || "fx";
+
+		return this.queue( type, function( next, runner ) {
+			var timeout = setTimeout( next, time );
+			runner.stop = function() {
+				clearTimeout( timeout );
+			};
+		});
+	},
+	clearQueue: function( type ) {
+		return this.queue( type || "fx", [] );
+	},
+	// Get a promise resolved when queues of a certain type
+	// are emptied (fx is the type by default)
+	promise: function( type, object ) {
+		if ( typeof type !== "string" ) {
+			object = type;
+			type = undefined;
+		}
+		type = type || "fx";
+		var defer = jQuery.Deferred(),
+			elements = this,
+			i = elements.length,
+			count = 1,
+			deferDataKey = type + "defer",
+			queueDataKey = type + "queue",
+			markDataKey = type + "mark",
+			tmp;
+		function resolve() {
+			if ( !( --count ) ) {
+				defer.resolveWith( elements, [ elements ] );
+			}
+		}
+		while( i-- ) {
+			if (( tmp = jQuery.data( elements[ i ], deferDataKey, undefined, true ) ||
+					( jQuery.data( elements[ i ], queueDataKey, undefined, true ) ||
+						jQuery.data( elements[ i ], markDataKey, undefined, true ) ) &&
+					jQuery.data( elements[ i ], deferDataKey, jQuery.Callbacks( "once memory" ), true ) )) {
+				count++;
+				tmp.add( resolve );
+			}
+		}
+		resolve();
+		return defer.promise();
+	}
+});
+
+
+
+
+var rclass = /[\n\t\r]/g,
+	rspace = /\s+/,
+	rreturn = /\r/g,
+	rtype = /^(?:button|input)$/i,
+	rfocusable = /^(?:button|input|object|select|textarea)$/i,
+	rclickable = /^a(?:rea)?$/i,
+	rboolean = /^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
+	nodeHook, boolHook, fixSpecified;
+
+jQuery.fn.extend({
+	attr: function( name, value ) {
+		return jQuery.access( this, name, value, true, jQuery.attr );
+	},
+
+	removeAttr: function( name ) {
+		return this.each(function() {
+			jQuery.removeAttr( this, name );
+		});
+	},
+
+	prop: function( name, value ) {
+		return jQuery.access( this, name, value, true, jQuery.prop );
+	},
+
+	removeProp: function( name ) {
+		name = jQuery.propFix[ name ] || name;
+		return this.each(function() {
+			// try/catch handles cases where IE balks (such as removing a property on window)
+			try {
+				this[ name ] = undefined;
+				delete this[ name ];
+			} catch( e ) {}
+		});
+	},
+
+	addClass: function( value ) {
+		var classNames, i, l, elem,
+			setClass, c, cl;
+
+		if ( jQuery.isFunction( value ) ) {
+			return this.each(function( j ) {
+				jQuery( this ).addClass( value.call(this, j, this.className) );
+			});
+		}
+
+		if ( value && typeof value === "string" ) {
+			classNames = value.split( rspace );
+
+			for ( i = 0, l = this.length; i < l; i++ ) {
+				elem = this[ i ];
+
+				if ( elem.nodeType === 1 ) {
+					if ( !elem.className && classNames.length === 1 ) {
+						elem.className = value;
+
+					} else {
+						setClass = " " + elem.className + " ";
+
+						for ( c = 0, cl = classNames.length; c < cl; c++ ) {
+							if ( !~setClass.indexOf( " " + classNames[ c ] + " " ) ) {
+								setClass += classNames[ c ] + " ";
+							}
+						}
+						elem.className = jQuery.trim( setClass );
+					}
+				}
+			}
+		}
+
+		return this;
+	},
+
+	removeClass: function( value ) {
+		var classNames, i, l, elem, className, c, cl;
+
+		if ( jQuery.isFunction( value ) ) {
+			return this.each(function( j ) {
+				jQuery( this ).removeClass( value.call(this, j, this.className) );
+			});
+		}
+
+		if ( (value && typeof value === "string") || value === undefined ) {
+			classNames = (value || "").split( rspace );
+
+			for ( i = 0, l = this.length; i < l; i++ ) {
+				elem = this[ i ];
+
+				if ( elem.nodeType === 1 && elem.className ) {
+					if ( value ) {
+						className = (" " + elem.className + " ").replace( rclass, " " );
+						for ( c = 0, cl = classNames.length; c < cl; c++ ) {
+							className = className.replace(" " + classNames[ c ] + " ", " ");
+						}
+						elem.className = jQuery.trim( className );
+
+					} else {
+						elem.className = "";
+					}
+				}
+			}
+		}
+
+		return this;
+	},
+
+	toggleClass: function( value, stateVal ) {
+		var type = typeof value,
+			isBool = typeof stateVal === "boolean";
+
+		if ( jQuery.isFunction( value ) ) {
+			return this.each(function( i ) {
+				jQuery( this ).toggleClass( value.call(this, i, this.className, stateVal), stateVal );
+			});
+		}
+
+		return this.each(function() {
+			if ( type === "string" ) {
+				// toggle individual class names
+				var className,
+					i = 0,
+					self = jQuery( this ),
+					state = stateVal,
+					classNames = value.split( rspace );
+
+				while ( (className = classNames[ i++ ]) ) {
+					// check each className given, space seperated list
+					state = isBool ? state : !self.hasClass( className );
+					self[ state ? "addClass" : "removeClass" ]( className );
+				}
+
+			} else if ( type === "undefined" || type === "boolean" ) {
+				if ( this.className ) {
+					// store className if set
+					jQuery._data( this, "__className__", this.className );
+				}
+
+				// toggle whole className
+				this.className = this.className || value === false ? "" : jQuery._data( this, "__className__" ) || "";
+			}
+		});
+	},
+
+	hasClass: function( selector ) {
+		var className = " " + selector + " ";
+		for ( var i = 0, l = this.length; i < l; i++ ) {
+			if ( this[i].nodeType === 1 && (" " + this[i].className + " ").replace(rclass, " ").indexOf( className ) > -1 ) {
+				return true;
+			}
+		}
+
+		return false;
+	},
+
+	val: function( value ) {
+		var hooks, ret,
+			elem = this[0];
+
+		if ( !arguments.length ) {
+			if ( elem ) {
+				hooks = jQuery.valHooks[ elem.nodeName.toLowerCase() ] || jQuery.valHooks[ elem.type ];
+
+				if ( hooks && "get" in hooks && (ret = hooks.get( elem, "value" )) !== undefined ) {
+					return ret;
+				}
+
+				ret = elem.value;
+
+				return typeof ret === "string" ?
+					// handle most common string cases
+					ret.replace(rreturn, "") :
+					// handle cases where value is null/undef or number
+					ret == null ? "" : ret;
+			}
+
+			return undefined;
+		}
+
+		var isFunction = jQuery.isFunction( value );
+
+		return this.each(function( i ) {
+			var self = jQuery(this), val;
+
+			if ( this.nodeType !== 1 ) {
+				return;
+			}
+
+			if ( isFunction ) {
+				val = value.call( this, i, self.val() );
+			} else {
+				val = value;
+			}
+
+			// Treat null/undefined as ""; convert numbers to string
+			if ( val == null ) {
+				val = "";
+			} else if ( typeof val === "number" ) {
+				val += "";
+			} else if ( jQuery.isArray( val ) ) {
+				val = jQuery.map(val, function ( value ) {
+					return value == null ? "" : value + "";
+				});
+			}
+
+			hooks = jQuery.valHooks[ this.nodeName.toLowerCase() ] || jQuery.valHooks[ this.type ];
+
+			// If set returns undefined, fall back to normal setting
+			if ( !hooks || !("set" in hooks) || hooks.set( this, val, "value" ) === undefined ) {
+				this.value = val;
+			}
+		});
+	}
+});
+
+jQuery.extend({
+	valHooks: {
+		option: {
+			get: function( elem ) {
+				// attributes.value is undefined in Blackberry 4.7 but
+				// uses .value. See #6932
+				var val = elem.attributes.value;
+				return !val || val.specified ? elem.value : elem.text;
+			}
+		},
+		select: {
+			get: function( elem ) {
+				var value,
+					index = elem.selectedIndex,
+					values = [],
+					options = elem.options,
+					one = elem.type === "select-one";
+
+				// Nothing was selected
+				if ( index < 0 ) {
+					return null;
+				}
+
+				// Loop through all the selected options
+				for ( var i = one ? index : 0, max = one ? index + 1 : options.length; i < max; i++ ) {
+					var option = options[ i ];
+
+					// Don't return options that are disabled or in a disabled optgroup
+					if ( option.selected && (jQuery.support.optDisabled ? !option.disabled : option.getAttribute("disabled") === null) &&
+							(!option.parentNode.disabled || !jQuery.nodeName( option.parentNode, "optgroup" )) ) {
+
+						// Get the specific value for the option
+						value = jQuery( option ).val();
+
+						// We don't need an array for one selects
+						if ( one ) {
+							return value;
+						}
+
+						// Multi-Selects return an array
+						values.push( value );
+					}
+				}
+
+				// Fixes Bug #2551 -- select.val() broken in IE after form.reset()
+				if ( one && !values.length && options.length ) {
+					return jQuery( options[ index ] ).val();
+				}
+
+				return values;
+			},
+
+			set: function( elem, value ) {
+				var values = jQuery.makeArray( value );
+
+				jQuery(elem).find("option").each(function() {
+					this.selected = jQuery.inArray( jQuery(this).val(), values ) >= 0;
+				});
+
+				if ( !values.length ) {
+					elem.selectedIndex = -1;
+				}
+				return values;
+			}
+		}
+	},
+
+	attrFn: {
+		val: true,
+		css: true,
+		html: true,
+		text: true,
+		data: true,
+		width: true,
+		height: true,
+		offset: true
+	},
+
+	attr: function( elem, name, value, pass ) {
+		var nType = elem.nodeType;
+
+		// don't get/set attributes on text, comment and attribute nodes
+		if ( !elem || nType === 3 || nType === 8 || nType === 2 ) {
+			return undefined;
+		}
+
+		if ( pass && name in jQuery.attrFn ) {
+			return jQuery( elem )[ name ]( value );
+		}
+
+		// Fallback to prop when attributes are not supported
+		if ( !("getAttribute" in elem) ) {
+			return jQuery.prop( elem, name, value );
+		}
+
+		var ret, hooks,
+			notxml = nType !== 1 || !jQuery.isXMLDoc( elem );
+
+		// Normalize the name if needed
+		if ( notxml ) {
+			name = name.toLowerCase();
+			hooks = jQuery.attrHooks[ name ] || (rboolean.test( name ) ? boolHook : nodeHook);
+		}
+
+		if ( value !== undefined ) {
+
+			if ( value === null ) {
+				jQuery.removeAttr( elem, name );
+				return undefined;
+
+			} else if ( hooks && "set" in hooks && notxml && (ret = hooks.set( elem, value, name )) !== undefined ) {
+				return ret;
+
+			} else {
+				elem.setAttribute( name, "" + value );
+				return value;
+			}
+
+		} else if ( hooks && "get" in hooks && notxml && (ret = hooks.get( elem, name )) !== null ) {
+			return ret;
+
+		} else {
+
+			ret = elem.getAttribute( name );
+
+			// Non-existent attributes return null, we normalize to undefined
+			return ret === null ?
+				undefined :
+				ret;
+		}
+	},
+
+	removeAttr: function( elem, value ) {
+		var propName, attrNames, name, l,
+			i = 0;
+
+		if ( elem.nodeType === 1 ) {
+			attrNames = (value || "").split( rspace );
+			l = attrNames.length;
+
+			for ( ; i < l; i++ ) {
+				name = attrNames[ i ].toLowerCase();
+
+				// See #9699 for explanation of this approach (setting first, then removal)
+				jQuery.attr( elem, name, "" );
+				elem.removeAttribute( name );
+
+				// Set corresponding property to false for boolean attributes
+				if ( rboolean.test( name ) && (propName = jQuery.propFix[ name ] || name) in elem ) {
+					elem[ propName ] = false;
+				}
+			}
+		}
+	},
+
+	attrHooks: {
+		type: {
+			set: function( elem, value ) {
+				// We can't allow the type property to be changed (since it causes problems in IE)
+				if ( rtype.test( elem.nodeName ) && elem.parentNode ) {
+					jQuery.error( "type property can't be changed" );
+				} else if ( !jQuery.support.radioValue && value === "radio" && jQuery.nodeName(elem, "input") ) {
+					// Setting the type on a radio button after the value resets the value in IE6-9
+					// Reset value to it's default in case type is set after value
+					// This is for element creation
+					var val = elem.value;
+					elem.setAttribute( "type", value );
+					if ( val ) {
+						elem.value = val;
+					}
+					return value;
+				}
+			}
+		},
+		// Use the value property for back compat
+		// Use the nodeHook for button elements in IE6/7 (#1954)
+		value: {
+			get: function( elem, name ) {
+				if ( nodeHook && jQuery.nodeName( elem, "button" ) ) {
+					return nodeHook.get( elem, name );
+				}
+				return name in elem ?
+					elem.value :
+					null;
+			},
+			set: function( elem, value, name ) {
+				if ( nodeHook && jQuery.nodeName( elem, "button" ) ) {
+					return nodeHook.set( elem, value, name );
+				}
+				// Does not return so that setAttribute is also used
+				elem.value = value;
+			}
+		}
+	},
+
+	propFix: {
+		tabindex: "tabIndex",
+		readonly: "readOnly",
+		"for": "htmlFor",
+		"class": "className",
+		maxlength: "maxLength",
+		cellspacing: "cellSpacing",
+		cellpadding: "cellPadding",
+		rowspan: "rowSpan",
+		colspan: "colSpan",
+		usemap: "useMap",
+		frameborder: "frameBorder",
+		contenteditable: "contentEditable"
+	},
+
+	prop: function( elem, name, value ) {
+		var nType = elem.nodeType;
+
+		// don't get/set properties on text, comment and attribute nodes
+		if ( !elem || nType === 3 || nType === 8 || nType === 2 ) {
+			return undefined;
+		}
+
+		var ret, hooks,
+			notxml = nType !== 1 || !jQuery.isXMLDoc( elem );
+
+		if ( notxml ) {
+			// Fix name and attach hooks
+			name = jQuery.propFix[ name ] || name;
+			hooks = jQuery.propHooks[ name ];
+		}
+
+		if ( value !== undefined ) {
+			if ( hooks && "set" in hooks && (ret = hooks.set( elem, value, name )) !== undefined ) {
+				return ret;
+
+			} else {
+				return (elem[ name ] = value);
+			}
+
+		} else {
+			if ( hooks && "get" in hooks && (ret = hooks.get( elem, name )) !== null ) {
+				return ret;
+
+			} else {
+				return elem[ name ];
+			}
+		}
+	},
+
+	propHooks: {
+		tabIndex: {
+			get: function( elem ) {
+				// elem.tabIndex doesn't always return the correct value when it hasn't been explicitly set
+				// http://fluidproject.org/blog/2008/01/09/getting-setting-and-removing-tabindex-values-with-javascript/
+				var attributeNode = elem.getAttributeNode("tabindex");
+
+				return attributeNode && attributeNode.specified ?
+					parseInt( attributeNode.value, 10 ) :
+					rfocusable.test( elem.nodeName ) || rclickable.test( elem.nodeName ) && elem.href ?
+						0 :
+						undefined;
+			}
+		}
+	}
+});
+
+// Add the tabIndex propHook to attrHooks for back-compat (different case is intentional)
+jQuery.attrHooks.tabindex = jQuery.propHooks.tabIndex;
+
+// Hook for boolean attributes
+boolHook = {
+	get: function( elem, name ) {
+		// Align boolean attributes with corresponding properties
+		// Fall back to attribute presence where some booleans are not supported
+		var attrNode,
+			property = jQuery.prop( elem, name );
+		return property === true || typeof property !== "boolean" && ( attrNode = elem.getAttributeNode(name) ) && attrNode.nodeValue !== false ?
+			name.toLowerCase() :
+			undefined;
+	},
+	set: function( elem, value, name ) {
+		var propName;
+		if ( value === false ) {
+			// Remove boolean attributes when set to false
+			jQuery.removeAttr( elem, name );
+		} else {
+			// value is true since we know at this point it's type boolean and not false
+			// Set boolean attributes to the same name and set the DOM property
+			propName = jQuery.propFix[ name ] || name;
+			if ( propName in elem ) {
+				// Only set the IDL specifically if it already exists on the element
+				elem[ propName ] = true;
+			}
+
+			elem.setAttribute( name, name.toLowerCase() );
+		}
+		return name;
+	}
+};
+
+// IE6/7 do not support getting/setting some attributes with get/setAttribute
+if ( !jQuery.support.getSetAttribute ) {
+
+	fixSpecified = {
+		name: true,
+		id: true
+	};
+
+	// Use this for any attribute in IE6/7
+	// This fixes almost every IE6/7 issue
+	nodeHook = jQuery.valHooks.button = {
+		get: function( elem, name ) {
+			var ret;
+			ret = elem.getAttributeNode( name );
+			return ret && (fixSpecified[ name ] ? ret.nodeValue !== "" : ret.specified) ?
+				ret.nodeValue :
+				undefined;
+		},
+		set: function( elem, value, name ) {
+			// Set the existing or create a new attribute node
+			var ret = elem.getAttributeNode( name );
+			if ( !ret ) {
+				ret = document.createAttribute( name );
+				elem.setAttributeNode( ret );
+			}
+			return (ret.nodeValue = value + "");
+		}
+	};
+
+	// Apply the nodeHook to tabindex
+	jQuery.attrHooks.tabindex.set = nodeHook.set;
+
+	// Set width and height to auto instead of 0 on empty string( Bug #8150 )
+	// This is for removals
+	jQuery.each([ "width", "height" ], function( i, name ) {
+		jQuery.attrHooks[ name ] = jQuery.extend( jQuery.attrHooks[ name ], {
+			set: function( elem, value ) {
+				if ( value === "" ) {
+					elem.setAttribute( name, "auto" );
+					return value;
+				}
+			}
+		});
+	});
+
+	// Set contenteditable to false on removals(#10429)
+	// Setting to empty string throws an error as an invalid value
+	jQuery.attrHooks.contenteditable = {
+		get: nodeHook.get,
+		set: function( elem, value, name ) {
+			if ( value === "" ) {
+				value = "false";
+			}
+			nodeHook.set( elem, value, name );
+		}
+	};
+}
+
+
+// Some attributes require a special call on IE
+if ( !jQuery.support.hrefNormalized ) {
+	jQuery.each([ "href", "src", "width", "height" ], function( i, name ) {
+		jQuery.attrHooks[ name ] = jQuery.extend( jQuery.attrHooks[ name ], {
+			get: function( elem ) {
+				var ret = elem.getAttribute( name, 2 );
+				return ret === null ? undefined : ret;
+			}
+		});
+	});
+}
+
+if ( !jQuery.support.style ) {
+	jQuery.attrHooks.style = {
+		get: function( elem ) {
+			// Return undefined in the case of empty string
+			// Normalize to lowercase since IE uppercases css property names
+			return elem.style.cssText.toLowerCase() || undefined;
+		},
+		set: function( elem, value ) {
+			return (elem.style.cssText = "" + value);
+		}
+	};
+}
+
+// Safari mis-reports the default selected property of an option
+// Accessing the parent's selectedIndex property fixes it
+if ( !jQuery.support.optSelected ) {
+	jQuery.propHooks.selected = jQuery.extend( jQuery.propHooks.selected, {
+		get: function( elem ) {
+			var parent = elem.parentNode;
+
+			if ( parent ) {
+				parent.selectedIndex;
+
+				// Make sure that it also works with optgroups, see #5701
+				if ( parent.parentNode ) {
+					parent.parentNode.selectedIndex;
+				}
+			}
+			return null;
+		}
+	});
+}
+
+// Radios and checkboxes getter/setter
+if ( !jQuery.support.checkOn ) {
+	jQuery.each([ "radio", "checkbox" ], function() {
+		jQuery.valHooks[ this ] = {
+			get: function( elem ) {
+				// Handle the case where in Webkit "" is returned instead of "on" if a value isn't specified
+				return elem.getAttribute("value") === null ? "on" : elem.value;
+			}
+		};
+	});
+}
+jQuery.each([ "radio", "checkbox" ], function() {
+	jQuery.valHooks[ this ] = jQuery.extend( jQuery.valHooks[ this ], {
+		set: function( elem, value ) {
+			if ( jQuery.isArray( value ) ) {
+				return (elem.checked = jQuery.inArray( jQuery(elem).val(), value ) >= 0);
+			}
+		}
+	});
+});
+
+
+
+
+var rnamespaces = /\.(.*)$/,
+	rformElems = /^(?:textarea|input|select)$/i,
+	rperiod = /\./g,
+	rspaces = / /g,
+	rescape = /[^\w\s.|`]/g,
+	rtypenamespace = /^([^\.]*)?(?:\.(.+))?$/,
+	rhoverHack = /\bhover(\.\S+)?/,
+	rkeyEvent = /^key/,
+	rmouseEvent = /^(?:mouse|contextmenu)|click/,
+	rquickIs = /^([\w\-]+)?(?:#([\w\-]+))?(?:\.([\w\-]+))?(?:\[([\w+\-]+)=["']?([\w\-]*)["']?\])?$/,
+	quickParse = function( selector ) {
+		var quick = rquickIs.exec( selector );
+		if ( quick ) {
+			//   0  1    2   3      4         5
+			// [ _, tag, id, class, attrName, attrValue ]
+			quick[1] = ( quick[1] || "" ).toLowerCase();
+			quick[3] = quick[3] && new RegExp( "\\b" + quick[3] + "\\b" );
+		}
+		return quick;
+	},
+	quickIs = function( elem, m ) {
+		return (
+			(!m[1] || elem.nodeName.toLowerCase() === m[1]) &&
+			(!m[2] || elem.id === m[2]) &&
+			(!m[3] || m[3].test( elem.className )) &&
+			(!m[4] || elem.getAttribute( m[4] ) == m[5])
+		);
+	};
+
+/*
+ * Helper functions for managing events -- not part of the public interface.
+ * Props to Dean Edwards' addEvent library for many of the ideas.
+ */
+jQuery.event = {
+
+	add: function( elem, types, handler, data, selector ) {
+
+		var elemData, eventHandle, events,
+			t, tns, type, namespaces, handleObj,
+			handleObjIn, quick, handlers, special;
+
+		// Don't attach events to noData or text/comment nodes (allow plain objects tho)
+		if ( elem.nodeType === 3 || elem.nodeType === 8 || !types || !handler || !(elemData = jQuery._data( elem )) ) {
+			return;
+		}
+
+		// Caller can pass in an object of custom data in lieu of the handler
+		if ( handler.handler ) {
+			handleObjIn = handler;
+			handler = handleObjIn.handler;
+		}
+
+		// Make sure that the handler has a unique ID, used to find/remove it later
+		if ( !handler.guid ) {
+			handler.guid = jQuery.guid++;
+		}
+
+		// Init the element's event structure and main handler, if this is the first
+		events = elemData.events;
+		if ( !events ) {
+			elemData.events = events = {};
+		}
+		eventHandle = elemData.handle;
+		if ( !eventHandle ) {
+			elemData.handle = eventHandle = function( e ) {
+				// Discard the second event of a jQuery.event.trigger() and
+				// when an event is called after a page has unloaded
+				return typeof jQuery !== "undefined" && (!e || jQuery.event.triggered !== e.type) ?
+					jQuery.event.handle.apply( eventHandle.elem, arguments ) :
+					undefined;
+			};
+			// Add elem as a property of the handle fn to prevent a memory leak with IE non-native events
+			eventHandle.elem = elem;
+		}
+
+		// Handle multiple events separated by a space
+		// jQuery(...).bind("mouseover mouseout", fn);
+		types = types.replace( rhoverHack, "mouseover$1 mouseout$1" ).split( " " );
+		for ( t = 0; t < types.length; t++ ) {
+
+			tns = rtypenamespace.exec( types[t] ) || [];
+			type = tns[1];
+			namespaces = (tns[2] || "").split( "." ).sort();
+
+			// If event changes its type, use the special event handlers for the changed type
+			special = jQuery.event.special[ type ] || {};
+
+			// If selector defined, determine special event api type, otherwise given type
+			type = ( selector ? special.delegateType : special.bindType ) || type;
+
+			// Update special based on newly reset type
+			special = jQuery.event.special[ type ] || {};
+
+			// handleObj is passed to all event handlers
+			handleObj = jQuery.extend({
+				type: type,
+				origType: tns[1],
+				data: data,
+				handler: handler,
+				guid: handler.guid,
+				selector: selector,
+				namespace: namespaces.join(".")
+			}, handleObjIn );
+
+			// Delegated event; pre-analyze selector so it's processed quickly on event dispatch
+			if ( selector ) {
+				handleObj.quick = quickParse( selector );
+				if ( !handleObj.quick && jQuery.expr.match.POS.test( selector ) ) {
+					handleObj.isPositional = true;
+				}
+			}
+
+			// Init the event handler queue if we're the first
+			handlers = events[ type ];
+			if ( !handlers ) {
+				handlers = events[ type ] = [];
+				handlers.delegateCount = 0;
+
+				// Only use addEventListener/attachEvent if the special events handler returns false
+				if ( !special.setup || special.setup.call( elem, data, namespaces, eventHandle ) === false ) {
+					// Bind the global event handler to the element
+					if ( elem.addEventListener ) {
+						elem.addEventListener( type, eventHandle, false );
+
+					} else if ( elem.attachEvent ) {
+						elem.attachEvent( "on" + type, eventHandle );
+					}
+				}
+			}
+
+			if ( special.add ) {
+				special.add.call( elem, handleObj );
+
+				if ( !handleObj.handler.guid ) {
+					handleObj.handler.guid = handler.guid;
+				}
+			}
+
+			// Add to the element's handler list, delegates in front
+			if ( selector ) {
+				handlers.splice( handlers.delegateCount++, 0, handleObj );
+			} else {
+				handlers.push( handleObj );
+			}
+
+			// Keep track of which events have ever been used, for event optimization
+			jQuery.event.global[ type ] = true;
+		}
+
+		// Nullify elem to prevent memory leaks in IE
+		elem = null;
+	},
+
+	global: {},
+
+	// Detach an event or set of events from an element
+	remove: function( elem, types, handler, selector ) {
+
+		var elemData = jQuery.hasData( elem ) && jQuery._data( elem ),
+			t, tns, type, namespaces, origCount,
+			j, events, special, handle, eventType, handleObj;
+
+		if ( !elemData || !(events = elemData.events) ) {
+			return;
+		}
+
+		// For removal, types can be an Event object
+		if ( types && types.type && types.handler ) {
+			handler = types.handler;
+			types = types.type;
+			selector = types.selector;
+		}
+
+		// Once for each type.namespace in types; type may be omitted
+		types = (types || "").replace( rhoverHack, "mouseover$1 mouseout$1" ).split(" ");
+		for ( t = 0; t < types.length; t++ ) {
+			tns = rtypenamespace.exec( types[t] ) || [];
+			type = tns[1];
+			namespaces = tns[2];
+
+			// Unbind all events (on this namespace, if provided) for the element
+			if ( !type ) {
+				namespaces = namespaces? "." + namespaces : "";
+				for ( j in events ) {
+					jQuery.event.remove( elem, j + namespaces, handler, selector );
+				}
+				return;
+			}
+
+			special = jQuery.event.special[ type ] || {};
+			type = ( selector? special.delegateType : special.bindType ) || type;
+			eventType = events[ type ] || [];
+			origCount = eventType.length;
+			namespaces = namespaces ? new RegExp("(^|\\.)" + namespaces.split(".").sort().join("\\.(?:.*\\.)?") + "(\\.|$)") : null;
+
+			// Only need to loop for special events or selective removal
+			if ( handler || namespaces || selector || special.remove ) {
+				for ( j = 0; j < eventType.length; j++ ) {
+					handleObj = eventType[ j ];
+
+					if ( !handler || handler.guid === handleObj.guid ) {
+						if ( !namespaces || namespaces.test( handleObj.namespace ) ) {
+							if ( !selector || selector === handleObj.selector || selector === "**" && handleObj.selector ) {
+								eventType.splice( j--, 1 );
+
+								if ( handleObj.selector ) {
+									eventType.delegateCount--;
+								}
+								if ( special.remove ) {
+									special.remove.call( elem, handleObj );
+								}
+							}
+						}
+					}
+				}
+			} else {
+				// Removing all events
+				eventType.length = 0;
+			}
+
+			// Remove generic event handler if we removed something and no more handlers exist
+			// (avoids potential for endless recursion during removal of special event handlers)
+			if ( eventType.length === 0 && origCount !== eventType.length ) {
+				if ( !special.teardown || special.teardown.call( elem, namespaces ) === false ) {
+					jQuery.removeEvent( elem, type, elemData.handle );
+				}
+
+				delete events[ type ];
+			}
+		}
+
+		// Remove the expando if it's no longer used
+		if ( jQuery.isEmptyObject( events ) ) {
+			handle = elemData.handle;
+			if ( handle ) {
+				handle.elem = null;
+			}
+
+			// removeData also checks for emptiness and clears the expando if empty
+			// so use it instead of delete
+			jQuery.removeData( elem, [ "events", "handle" ], true );
+		}
+	},
+
+	// Events that are safe to short-circuit if no handlers are attached.
+	// Native DOM events should not be added, they may have inline handlers.
+	customEvent: {
+		"getData": true,
+		"setData": true,
+		"changeData": true
+	},
+
+	trigger: function( event, data, elem, onlyHandlers ) {
+		// Don't do events on text and comment nodes
+		if ( elem && (elem.nodeType === 3 || elem.nodeType === 8) ) {
+			return;
+		}
+
+		// Event object or event type
+		var type = event.type || event,
+			namespaces = [],
+			cache, exclusive, i, cur, old, ontype, special, handle, eventPath, bubbleType;
+
+		if ( type.indexOf( "!" ) >= 0 ) {
+			// Exclusive events trigger only for the exact event (no namespaces)
+			type = type.slice(0, -1);
+			exclusive = true;
+		}
+
+		if ( type.indexOf( "." ) >= 0 ) {
+			// Namespaced trigger; create a regexp to match event type in handle()
+			namespaces = type.split(".");
+			type = namespaces.shift();
+			namespaces.sort();
+		}
+
+		if ( (!elem || jQuery.event.customEvent[ type ]) && !jQuery.event.global[ type ] ) {
+			// No jQuery handlers for this event type, and it can't have inline handlers
+			return;
+		}
+
+		// Caller can pass in an Event, Object, or just an event type string
+		event = typeof event === "object" ?
+			// jQuery.Event object
+			event[ jQuery.expando ] ? event :
+			// Object literal
+			new jQuery.Event( type, event ) :
+			// Just the event type (string)
+			new jQuery.Event( type );
+
+		event.type = type;
+		event.isTrigger = true;
+		event.exclusive = exclusive;
+		event.namespace = namespaces.join( "." );
+		event.namespace_re = event.namespace? new RegExp("(^|\\.)" + namespaces.join("\\.(?:.*\\.)?") + "(\\.|$)") : null;
+		ontype = type.indexOf( ":" ) < 0 ? "on" + type : "";
+
+		// triggerHandler() and global events don't bubble or run the default action
+		if ( onlyHandlers || !elem ) {
+			event.preventDefault();
+		}
+
+		// Handle a global trigger
+		if ( !elem ) {
+
+			// TODO: Stop taunting the data cache; remove global events and always attach to document
+			cache = jQuery.cache;
+			event.stopPropagation();
+			for ( i in cache ) {
+				if ( cache[ i ].events && cache[ i ].events[ type ] ) {
+					jQuery.event.trigger( event, data, cache[ i ].handle.elem );
+				}
+			}
+			return;
+		}
+
+		// Clean up the event in case it is being reused
+		event.result = undefined;
+		if ( !event.target ) {
+			event.target = elem;
+		}
+
+		// Clone any incoming data and prepend the event, creating the handler arg list
+		data = data != null ? jQuery.makeArray( data ) : [];
+		data.unshift( event );
+
+		// Allow special events to draw outside the lines
+		special = jQuery.event.special[ type ] || {};
+		if ( special.trigger && special.trigger.apply( elem, data ) === false ) {
+			return;
+		}
+
+		// Determine event propagation path in advance, per W3C events spec (#9951)
+		// Bubble up to document, then to window; watch for a global ownerDocument var (#9724)
+		eventPath = [[ elem, special.bindType || type ]];
+		if ( !onlyHandlers && !special.noBubble && !jQuery.isWindow( elem ) ) {
+
+			bubbleType = special.delegateType || type;
+			old = null;
+			for ( cur = elem.parentNode; cur; cur = cur.parentNode ) {
+				eventPath.push([ cur, bubbleType ]);
+				old = cur;
+			}
+
+			// Only add window if we got to document (e.g., not plain obj or detached DOM)
+			if ( old && old === elem.ownerDocument ) {
+				eventPath.push([ old.defaultView || old.parentWindow || window, bubbleType ]);
+			}
+		}
+
+		// Fire handlers on the event path
+		for ( i = 0; i < eventPath.length; i++ ) {
+
+			cur = eventPath[i][0];
+			event.type = eventPath[i][1];
+
+			handle = (jQuery._data( cur, "events" ) || {})[ event.type ] && jQuery._data( cur, "handle" );
+			if ( handle ) {
+				handle.apply( cur, data );
+			}
+			handle = ontype && cur[ ontype ];
+			if ( handle && jQuery.acceptData( cur ) ) {
+				handle.apply( cur, data );
+			}
+
+			if ( event.isPropagationStopped() ) {
+				break;
+			}
+		}
+		event.type = type;
+
+		// If nobody prevented the default action, do it now
+		if ( !event.isDefaultPrevented() ) {
+
+			if ( (!special._default || special._default.call( elem.ownerDocument, event, data ) === false) &&
+				!(type === "click" && jQuery.nodeName( elem, "a" )) && jQuery.acceptData( elem ) ) {
+
+				// Call a native DOM method on the target with the same name name as the event.
+				// Can't use an .isFunction() check here because IE6/7 fails that test.
+				// Don't do default actions on window, that's where global variables be (#6170)
+				// IE<9 dies on focus/blur to hidden element (#1486)
+				if ( ontype && elem[ type ] && ((type !== "focus" && type !== "blur") || event.target.offsetWidth !== 0) && !jQuery.isWindow( elem ) ) {
+
+					// Don't re-trigger an onFOO event when we call its FOO() method
+					old = elem[ ontype ];
+
+					if ( old ) {
+						elem[ ontype ] = null;
+					}
+
+					// Prevent re-triggering of the same event, since we already bubbled it above
+					jQuery.event.triggered = type;
+					elem[ type ]();
+					jQuery.event.triggered = undefined;
+
+					if ( old ) {
+						elem[ ontype ] = old;
+					}
+				}
+			}
+		}
+
+		return event.result;
+	},
+
+	handle: function( event ) {
+
+		// Make a writable jQuery.Event from the native event object
+		event = jQuery.event.fix( event || window.event );
+
+		var handlers = ((jQuery._data( this, "events" ) || {})[ event.type ] || []),
+			delegateCount = handlers.delegateCount,
+			args = [].slice.call( arguments, 0 ),
+			handlerQueue = [],
+			i, cur, selMatch, matches, handleObj, sel, hit, related;
+
+		// Use the fix-ed jQuery.Event rather than the (read-only) native event
+		args[0] = event;
+
+		// Determine handlers that should run if there are delegated events
+		// Avoid disabled elements in IE (#6911) and non-left-click bubbling in Firefox (#3861)
+		if ( delegateCount && !event.target.disabled && !(event.button && event.type === "click") ) {
+
+			for ( cur = event.target; cur != this; cur = cur.parentNode || this ) {
+				selMatch = {};
+				matches = [];
+				for ( i = 0; i < delegateCount; i++ ) {
+					handleObj = handlers[ i ];
+					sel = handleObj.selector;
+					hit = selMatch[ sel ];
+
+					if ( handleObj.isPositional ) {
+						// Since .is() does not work for positionals; see http://jsfiddle.net/eJ4yd/3/
+						hit = ( hit || (selMatch[ sel ] = jQuery( sel )) ).index( cur ) >= 0;
+					} else if ( hit === undefined ) {
+						hit = selMatch[ sel ] = ( handleObj.quick ? quickIs( cur, handleObj.quick ) : jQuery( cur ).is( sel ) );
+					}
+					if ( hit ) {
+						matches.push( handleObj );
+					}
+				}
+				if ( matches.length ) {
+					handlerQueue.push({ elem: cur, matches: matches });
+				}
+			}
+		}
+
+		// Copy the remaining (bound) handlers in case they're changed
+		handlers = handlers.slice( delegateCount );
+
+		// Run delegates first; they may want to stop propagation beneath us
+		event.delegateTarget = this;
+		for ( i = 0; i < handlerQueue.length && !event.isPropagationStopped(); i++ ) {
+			matched = handlerQueue[ i ];
+			dispatch( matched.elem, event, matched.matches, args );
+		}
+		delete event.delegateTarget;
+
+		// Run non-delegated handlers for this level
+		if ( handlers.length ) {
+			dispatch( this, event, handlers, args );
+		}
+
+		return event.result;
+	},
+
+	// Includes some event props shared by KeyEvent and MouseEvent
+	// *** attrChange attrName relatedNode srcElement  are not normalized, non-W3C, deprecated, will be removed in 1.8 ***
+	props: "attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),
+
+	fixHooks: {},
+
+	keyHooks: {
+		props: "char charCode key keyCode".split(" "),
+		filter: function( event, original ) {
+
+			// Add which for key events
+			if ( event.which == null ) {
+				event.which = original.charCode != null ? original.charCode : original.keyCode;
+			}
+
+			return event;
+		}
+	},
+
+	mouseHooks: {
+		props: "button buttons clientX clientY fromElement layerX layerY offsetX offsetY pageX pageY screenX screenY toElement wheelDelta".split(" "),
+		filter: function( event, original ) {
+			var eventDoc, doc, body,
+				button = original.button,
+				fromElement = original.fromElement;
+
+			// Calculate pageX/Y if missing and clientX/Y available
+			if ( event.pageX == null && original.clientX != null ) {
+				eventDoc = event.target.ownerDocument || document;
+				doc = eventDoc.documentElement;
+				body = eventDoc.body;
+
+				event.pageX = original.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc && doc.clientLeft || body && body.clientLeft || 0);
+				event.pageY = original.clientY + (doc && doc.scrollTop  || body && body.scrollTop  || 0) - (doc && doc.clientTop  || body && body.clientTop  || 0);
+			}
+
+			// Add relatedTarget, if necessary
+			if ( !event.relatedTarget && fromElement ) {
+				event.relatedTarget = fromElement === event.target ? original.toElement : fromElement;
+			}
+
+			// Add which for click: 1 === left; 2 === middle; 3 === right
+			// Note: button is not normalized, so don't use it
+			if ( !event.which && button !== undefined ) {
+				event.which = ( button & 1 ? 1 : ( button & 2 ? 3 : ( button & 4 ? 2 : 0 ) ) );
+			}
+
+			return event;
+		}
+	},
+
+	fix: function( event ) {
+		if ( event[ jQuery.expando ] ) {
+			return event;
+		}
+
+		// Create a writable copy of the event object and normalize some properties
+		var i, prop,
+			originalEvent = event,
+			fixHook = jQuery.event.fixHooks[ event.type ] || {},
+			copy = fixHook.props ? this.props.concat( fixHook.props ) : this.props;
+
+		event = jQuery.Event( originalEvent );
+
+		for ( i = copy.length; i; ) {
+			prop = copy[ --i ];
+			event[ prop ] = originalEvent[ prop ];
+		}
+
+		// Fix target property, if necessary (#1925, IE 6/7/8 & Safari2)
+		if ( !event.target ) {
+			event.target = originalEvent.srcElement || document;
+		}
+
+		// Target should not be a text node (#504, Safari)
+		if ( event.target.nodeType === 3 ) {
+			event.target = event.target.parentNode;
+		}
+
+		// For mouse/key events; add metaKey if it's not there (#3368, IE6/7/8)
+		if ( event.metaKey === undefined ) {
+			event.metaKey = event.ctrlKey;
+		}
+
+		return fixHook.filter? fixHook.filter( event, originalEvent ) : event;
+	},
+
+	special: {
+		ready: {
+			// Make sure the ready event is setup
+			setup: jQuery.bindReady
+		},
+
+		focus: {
+			delegateType: "focusin",
+			noBubble: true
+		},
+		blur: {
+			delegateType: "focusout",
+			noBubble: true
+		},
+
+		beforeunload: {
+			setup: function( data, namespaces, eventHandle ) {
+				// We only want to do this special case on windows
+				if ( jQuery.isWindow( this ) ) {
+					this.onbeforeunload = eventHandle;
+				}
+			},
+
+			teardown: function( namespaces, eventHandle ) {
+				if ( this.onbeforeunload === eventHandle ) {
+					this.onbeforeunload = null;
+				}
+			}
+		}
+	},
+
+	simulate: function( type, elem, event, bubble ) {
+		// Piggyback on a donor event to simulate a different one.
+		// Fake originalEvent to avoid donor's stopPropagation, but if the
+		// simulated event prevents default then we do the same on the donor.
+		var e = jQuery.extend(
+			new jQuery.Event(),
+			event,
+			{ type: type,
+				isSimulated: true,
+				originalEvent: {}
+			}
+		);
+		if ( bubble ) {
+			jQuery.event.trigger( e, null, elem );
+		} else {
+			jQuery.event.handle.call( elem, e );
+		}
+		if ( e.isDefaultPrevented() ) {
+			event.preventDefault();
+		}
+	}
+};
+
+// Run jQuery handler functions; called from jQuery.event.handle
+function dispatch( target, event, handlers, args ) {
+	var run_all = !event.exclusive && !event.namespace,
+		specialHandle = ( jQuery.event.special[ event.type ] || {} ).handle,
+		j, handleObj, ret;
+
+	event.currentTarget = target;
+	for ( j = 0; j < handlers.length && !event.isImmediatePropagationStopped(); j++ ) {
+		handleObj = handlers[ j ];
+
+		// Triggered event must either 1) be non-exclusive and have no namespace, or
+		// 2) have namespace(s) a subset or equal to those in the bound event (both can have no namespace).
+		if ( run_all || (!event.namespace && !handleObj.namespace) || event.namespace_re && event.namespace_re.test( handleObj.namespace ) ) {
+
+			// Pass in a reference to the handler function itself
+			// So that we can later remove it
+			event.handler = handleObj.handler;
+			event.data = handleObj.data;
+			event.handleObj = handleObj;
+
+			ret = ( specialHandle || handleObj.handler ).apply( target, args );
+
+			if ( ret !== undefined ) {
+				event.result = ret;
+				if ( ret === false ) {
+					event.preventDefault();
+					event.stopPropagation();
+				}
+			}
+		}
+	}
+}
+
+jQuery.removeEvent = document.removeEventListener ?
+	function( elem, type, handle ) {
+		if ( elem.removeEventListener ) {
+			elem.removeEventListener( type, handle, false );
+		}
+	} :
+	function( elem, type, handle ) {
+		if ( elem.detachEvent ) {
+			elem.detachEvent( "on" + type, handle );
+		}
+	};
+
+jQuery.Event = function( src, props ) {
+	// Allow instantiation without the 'new' keyword
+	if ( !(this instanceof jQuery.Event) ) {
+		return new jQuery.Event( src, props );
+	}
+
+	// Event object
+	if ( src && src.type ) {
+		this.originalEvent = src;
+		this.type = src.type;
+
+		// Events bubbling up the document may have been marked as prevented
+		// by a handler lower down the tree; reflect the correct value.
+		this.isDefaultPrevented = ( src.defaultPrevented || src.returnValue === false ||
+			src.getPreventDefault && src.getPreventDefault() ) ? returnTrue : returnFalse;
+
+	// Event type
+	} else {
+		this.type = src;
+	}
+
+	// Put explicitly provided properties onto the event object
+	if ( props ) {
+		jQuery.extend( this, props );
+	}
+
+	// Create a timestamp if incoming event doesn't have one
+	this.timeStamp = src && src.timeStamp || jQuery.now();
+
+	// Mark it as fixed
+	this[ jQuery.expando ] = true;
+};
+
+function returnFalse() {
+	return false;
+}
+function returnTrue() {
+	return true;
+}
+
+// jQuery.Event is based on DOM3 Events as specified by the ECMAScript Language Binding
+// http://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html
+jQuery.Event.prototype = {
+	preventDefault: function() {
+		this.isDefaultPrevented = returnTrue;
+
+		var e = this.originalEvent;
+		if ( !e ) {
+			return;
+		}
+
+		// if preventDefault exists run it on the original event
+		if ( e.preventDefault ) {
+			e.preventDefault();
+
+		// otherwise set the returnValue property of the original event to false (IE)
+		} else {
+			e.returnValue = false;
+		}
+	},
+	stopPropagation: function() {
+		this.isPropagationStopped = returnTrue;
+
+		var e = this.originalEvent;
+		if ( !e ) {
+			return;
+		}
+		// if stopPropagation exists run it on the original event
+		if ( e.stopPropagation ) {
+			e.stopPropagation();
+		}
+		// otherwise set the cancelBubble property of the original event to true (IE)
+		e.cancelBubble = true;
+	},
+	stopImmediatePropagation: function() {
+		this.isImmediatePropagationStopped = returnTrue;
+		this.stopPropagation();
+	},
+	isDefaultPrevented: returnFalse,
+	isPropagationStopped: returnFalse,
+	isImmediatePropagationStopped: returnFalse
+};
+
+// Create mouseenter/leave events using mouseover/out and event-time checks
+jQuery.each({
+	mouseenter: "mouseover",
+	mouseleave: "mouseout"
+}, function( orig, fix ) {
+	jQuery.event.special[ orig ] = jQuery.event.special[ fix ] = {
+		delegateType: fix,
+		bindType: fix,
+
+		handle: function( event ) {
+			var target = this,
+				related = event.relatedTarget,
+				handleObj = event.handleObj,
+				selector = handleObj.selector,
+				oldType, ret;
+
+			// For a real mouseover/out, always call the handler; for
+			// mousenter/leave call the handler if related is outside the target.
+			// NB: No relatedTarget if the mouse left/entered the browser window
+			if ( !related || handleObj.origType === event.type || (related !== target && !jQuery.contains( target, related )) ) {
+				oldType = event.type;
+				event.type = handleObj.origType;
+				ret = handleObj.handler.apply( this, arguments );
+				event.type = oldType;
+			}
+			return ret;
+		}
+	};
+});
+
+// IE submit delegation
+if ( !jQuery.support.submitBubbles ) {
+
+	jQuery.event.special.submit = {
+		setup: function() {
+			// Only need this for delegated form submit events
+			if ( jQuery.nodeName( this, "form" ) ) {
+				return false;
+			}
+
+			// Lazy-add a submit handler when a descendant form may potentially be submitted
+			jQuery.event.add( this, "click._submit keypress._submit", function( e ) {
+				// Node name check avoids a VML-related crash in IE (#9807)
+				var elem = e.target,
+					form = jQuery.nodeName( elem, "input" ) || jQuery.nodeName( elem, "button" ) ? elem.form : undefined;
+				if ( form && !form._submit_attached ) {
+					jQuery.event.add( form, "submit._submit", function( event ) {
+						// Form was submitted, bubble the event up the tree
+						if ( this.parentNode ) {
+							jQuery.event.simulate( "submit", this.parentNode, event, true );
+						}
+					});
+					form._submit_attached = true;
+				}
+			});
+			// return undefined since we don't need an event listener
+		},
+
+		teardown: function() {
+			// Only need this for delegated form submit events
+			if ( jQuery.nodeName( this, "form" ) ) {
+				return false;
+			}
+
+			// Remove delegated handlers; cleanData eventually reaps submit handlers attached above
+			jQuery.event.remove( this, "._submit" );
+		}
+	};
+}
+
+// IE change delegation and checkbox/radio fix
+if ( !jQuery.support.changeBubbles ) {
+
+	jQuery.event.special.change = {
+
+		setup: function() {
+
+			if ( rformElems.test( this.nodeName ) ) {
+				// IE doesn't fire change on a check/radio until blur; trigger it on click
+				// after a propertychange. Eat the blur-change in special.change.handle.
+				// This still fires onchange a second time for check/radio after blur.
+				if ( this.type === "checkbox" || this.type === "radio" ) {
+					jQuery.event.add( this, "propertychange._change", function( event ) {
+						if ( event.originalEvent.propertyName === "checked" ) {
+							this._just_changed = true;
+						}
+					});
+					jQuery.event.add( this, "click._change", function( event ) {
+						if ( this._just_changed ) {
+							this._just_changed = false;
+							jQuery.event.simulate( "change", this, event, true );
+						}
+					});
+				}
+				return false;
+			}
+			// Delegated event; lazy-add a change handler on descendant inputs
+			jQuery.event.add( this, "beforeactivate._change", function( e ) {
+				var elem = e.target;
+
+				if ( rformElems.test( elem.nodeName ) && !elem._change_attached ) {
+					jQuery.event.add( elem, "change._change", function( event ) {
+						if ( this.parentNode && !event.isSimulated ) {
+							jQuery.event.simulate( "change", this.parentNode, event, true );
+						}
+					});
+					elem._change_attached = true;
+				}
+			});
+		},
+
+		handle: function( event ) {
+			var elem = event.target;
+
+			// Swallow native change events from checkbox/radio, we already triggered them above
+			if ( this !== elem || event.isSimulated || event.isTrigger || (elem.type !== "radio" && elem.type !== "checkbox") ) {
+				return event.handleObj.handler.apply( this, arguments );
+			}
+		},
+
+		teardown: function() {
+			jQuery.event.remove( this, "._change" );
+
+			return rformElems.test( this.nodeName );
+		}
+	};
+}
+
+// Create "bubbling" focus and blur events
+if ( !jQuery.support.focusinBubbles ) {
+	jQuery.each({ focus: "focusin", blur: "focusout" }, function( orig, fix ) {
+
+		// Attach a single capturing handler while someone wants focusin/focusout
+		var attaches = 0,
+			handler = function( event ) {
+				jQuery.event.simulate( fix, event.target, jQuery.event.fix( event ), true );
+			};
+
+		jQuery.event.special[ fix ] = {
+			setup: function() {
+				if ( attaches++ === 0 ) {
+					document.addEventListener( orig, handler, true );
+				}
+			},
+			teardown: function() {
+				if ( --attaches === 0 ) {
+					document.removeEventListener( orig, handler, true );
+				}
+			}
+		};
+	});
+}
+
+jQuery.fn.extend({
+
+	on: function( types, selector, data, fn, /*INTERNAL*/ one ) {
+		var origFn, type;
+
+		// Types can be a map of types/handlers
+		if ( typeof types === "object" ) {
+			// ( types-Object, selector, data )
+			if ( typeof selector !== "string" ) {
+				// ( types-Object, data )
+				data = selector;
+				selector = undefined;
+			}
+			for ( type in types ) {
+				this.on( type, selector, data, types[ type ], one );
+			}
+			return this;
+		}
+
+		if ( data == null && fn == null ) {
+			// ( types, fn )
+			fn = selector;
+			data = selector = undefined;
+		} else if ( fn == null ) {
+			if ( typeof selector === "string" ) {
+				// ( types, selector, fn )
+				fn = data;
+				data = undefined;
+			} else {
+				// ( types, data, fn )
+				fn = data;
+				data = selector;
+				selector = undefined;
+			}
+		}
+		if ( fn === false ) {
+			fn = returnFalse;
+		} else if ( !fn ) {
+			return this;
+		}
+
+		if ( one === 1 ) {
+			origFn = fn;
+			fn = function( event ) {
+				jQuery.event.remove( event.delegateTarget || this, event );
+				return origFn.apply( this, arguments );
+			};
+			// Use same guid so caller can remove using origFn
+			fn.guid = origFn.guid || ( origFn.guid = jQuery.guid++ );
+		}
+		return this.each( function() {
+			jQuery.event.add( this, types, fn, data, selector );
+		});
+	},
+	one: function( types, selector, data, fn ) {
+		return this.on.call( this, types, selector, data, fn, 1 );
+	},
+	off: function( types, selector, fn ) {
+		if ( types && types.preventDefault ) {
+			// ( event )  native or jQuery.Event
+			return this.off( types.type, types.handler, types.selector );
+		}
+		if ( typeof types === "object" ) {
+			// ( types-object [, selector] )
+			for ( var type in types ) {
+				this.off( type, selector, types[ type ] );
+			}
+			return this;
+		}
+		if ( selector === false || typeof selector === "function" ) {
+			// ( types [, fn] )
+			fn = selector;
+			selector = undefined;
+		}
+		if ( fn === false ) {
+			fn = returnFalse;
+		}
+		return this.each(function() {
+			jQuery.event.remove( this, types, fn, selector );
+		});
+	},
+
+	bind: function( types, data, fn ) {
+		return this.on( types, null, data, fn );
+	},
+	unbind: function( types, fn ) {
+		return this.off( types, null, fn );
+	},
+
+	live: function( types, data, fn ) {
+		jQuery( this.context ).on( types, this.selector, data, fn );
+		return this;
+	},
+	die: function( types, fn ) {
+		jQuery( this.context ).off( types, this.selector || "**", fn );
+		return this;
+	},
+
+	delegate: function( selector, types, data, fn ) {
+		return this.on( types, selector, data, fn );
+	},
+	undelegate: function( selector, types, fn ) {
+		// ( namespace ) or ( selector, types [, fn] )
+		return arguments.length == 1? this.off( selector, "**" ) : this.off( types, selector, fn );
+	},
+
+	trigger: function( type, data ) {
+		return this.each(function() {
+			jQuery.event.trigger( type, data, this );
+		});
+	},
+	triggerHandler: function( type, data ) {
+		if ( this[0] ) {
+			return jQuery.event.trigger( type, data, this[0], true );
+		}
+	},
+
+	toggle: function( fn ) {
+		// Save reference to arguments for access in closure
+		var args = arguments,
+			guid = fn.guid || jQuery.guid++,
+			i = 0,
+			toggler = function( event ) {
+				// Figure out which function to execute
+				var lastToggle = ( jQuery._data( this, "lastToggle" + fn.guid ) || 0 ) % i;
+				jQuery._data( this, "lastToggle" + fn.guid, lastToggle + 1 );
+
+				// Make sure that clicks stop
+				event.preventDefault();
+
+				// and execute the function
+				return args[ lastToggle ].apply( this, arguments ) || false;
+			};
+
+		// link all the functions, so any of them can unbind this click handler
+		toggler.guid = guid;
+		while ( i < args.length ) {
+			args[ i++ ].guid = guid;
+		}
+
+		return this.click( toggler );
+	},
+
+	hover: function( fnOver, fnOut ) {
+		return this.mouseenter( fnOver ).mouseleave( fnOut || fnOver );
+	}
+});
+
+jQuery.each( ("blur focus focusin focusout load resize scroll unload click dblclick " +
+	"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave " +
+	"change select submit keydown keypress keyup error contextmenu").split(" "), function( i, name ) {
+
+	// Handle event binding
+	jQuery.fn[ name ] = function( data, fn ) {
+		if ( fn == null ) {
+			fn = data;
+			data = null;
+		}
+
+		return arguments.length > 0 ?
+			this.bind( name, data, fn ) :
+			this.trigger( name );
+	};
+
+	if ( jQuery.attrFn ) {
+		jQuery.attrFn[ name ] = true;
+	}
+
+	if ( rkeyEvent.test( name ) ) {
+		jQuery.event.fixHooks[ name ] = jQuery.event.keyHooks;
+	}
+
+	if ( rmouseEvent.test( name ) ) {
+		jQuery.event.fixHooks[ name ] = jQuery.event.mouseHooks;
+	}
+});
+
+
+
+/*!
+ * Sizzle CSS Selector Engine
+ *  Copyright 2011, The Dojo Foundation
+ *  Released under the MIT, BSD, and GPL Licenses.
+ *  More information: http://sizzlejs.com/
+ */
+(function(){
+
+var chunker = /((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,
+	expando = "sizcache" + (Math.random() + '').replace('.', ''),
+	done = 0,
+	toString = Object.prototype.toString,
+	hasDuplicate = false,
+	baseHasDuplicate = true,
+	rBackslash = /\\/g,
+	rReturn = /\r\n/g,
+	rNonWord = /\W/;
+
+// Here we check if the JavaScript engine is using some sort of
+// optimization where it does not always call our comparision
+// function. If that is the case, discard the hasDuplicate value.
+//   Thus far that includes Google Chrome.
+[0, 0].sort(function() {
+	baseHasDuplicate = false;
+	return 0;
+});
+
+var Sizzle = function( selector, context, results, seed ) {
+	results = results || [];
+	context = context || document;
+
+	var origContext = context;
+
+	if ( context.nodeType !== 1 && context.nodeType !== 9 ) {
+		return [];
+	}
+	
+	if ( !selector || typeof selector !== "string" ) {
+		return results;
+	}
+
+	var m, set, checkSet, extra, ret, cur, pop, i,
+		prune = true,
+		contextXML = Sizzle.isXML( context ),
+		parts = [],
+		soFar = selector;
+	
+	// Reset the position of the chunker regexp (start from head)
+	do {
+		chunker.exec( "" );
+		m = chunker.exec( soFar );
+
+		if ( m ) {
+			soFar = m[3];
+		
+			parts.push( m[1] );
+		
+			if ( m[2] ) {
+				extra = m[3];
+				break;
+			}
+		}
+	} while ( m );
+
+	if ( parts.length > 1 && origPOS.exec( selector ) ) {
+
+		if ( parts.length === 2 && Expr.relative[ parts[0] ] ) {
+			set = posProcess( parts[0] + parts[1], context, seed );
+
+		} else {
+			set = Expr.relative[ parts[0] ] ?
+				[ context ] :
+				Sizzle( parts.shift(), context );
+
+			while ( parts.length ) {
+				selector = parts.shift();
+
+				if ( Expr.relative[ selector ] ) {
+					selector += parts.shift();
+				}
+				
+				set = posProcess( selector, set, seed );
+			}
+		}
+
+	} else {
+		// Take a shortcut and set the context if the root selector is an ID
+		// (but not if it'll be faster if the inner selector is an ID)
+		if ( !seed && parts.length > 1 && context.nodeType === 9 && !contextXML &&
+				Expr.match.ID.test(parts[0]) && !Expr.match.ID.test(parts[parts.length - 1]) ) {
+
+			ret = Sizzle.find( parts.shift(), context, contextXML );
+			context = ret.expr ?
+				Sizzle.filter( ret.expr, ret.set )[0] :
+				ret.set[0];
+		}
+
+		if ( context ) {
+			ret = seed ?
+				{ expr: parts.pop(), set: makeArray(seed) } :
+				Sizzle.find( parts.pop(), parts.length === 1 && (parts[0] === "~" || parts[0] === "+") && context.parentNode ? context.parentNode : context, contextXML );
+
+			set = ret.expr ?
+				Sizzle.filter( ret.expr, ret.set ) :
+				ret.set;
+
+			if ( parts.length > 0 ) {
+				checkSet = makeArray( set );
+
+			} else {
+				prune = false;
+			}
+
+			while ( parts.length ) {
+				cur = parts.pop();
+				pop = cur;
+
+				if ( !Expr.relative[ cur ] ) {
+					cur = "";
+				} else {
+					pop = parts.pop();
+				}
+
+				if ( pop == null ) {
+					pop = context;
+				}
+
+				Expr.relative[ cur ]( checkSet, pop, contextXML );
+			}
+
+		} else {
+			checkSet = parts = [];
+		}
+	}
+
+	if ( !checkSet ) {
+		checkSet = set;
+	}
+
+	if ( !checkSet ) {
+		Sizzle.error( cur || selector );
+	}
+
+	if ( toString.call(checkSet) === "[object Array]" ) {
+		if ( !prune ) {
+			results.push.apply( results, checkSet );
+
+		} else if ( context && context.nodeType === 1 ) {
+			for ( i = 0; checkSet[i] != null; i++ ) {
+				if ( checkSet[i] && (checkSet[i] === true || checkSet[i].nodeType === 1 && Sizzle.contains(context, checkSet[i])) ) {
+					results.push( set[i] );
+				}
+			}
+
+		} else {
+			for ( i = 0; checkSet[i] != null; i++ ) {
+				if ( checkSet[i] && checkSet[i].nodeType === 1 ) {
+					results.push( set[i] );
+				}
+			}
+		}
+
+	} else {
+		makeArray( checkSet, results );
+	}
+
+	if ( extra ) {
+		Sizzle( extra, origContext, results, seed );
+		Sizzle.uniqueSort( results );
+	}
+
+	return results;
+};
+
+Sizzle.uniqueSort = function( results ) {
+	if ( sortOrder ) {
+		hasDuplicate = baseHasDuplicate;
+		results.sort( sortOrder );
+
+		if ( hasDuplicate ) {
+			for ( var i = 1; i < results.length; i++ ) {
+				if ( results[i] === results[ i - 1 ] ) {
+					results.splice( i--, 1 );
+				}
+			}
+		}
+	}
+
+	return results;
+};
+
+Sizzle.matches = function( expr, set ) {
+	return Sizzle( expr, null, null, set );
+};
+
+Sizzle.matchesSelector = function( node, expr ) {
+	return Sizzle( expr, null, null, [node] ).length > 0;
+};
+
+Sizzle.find = function( expr, context, isXML ) {
+	var set, i, len, match, type, left;
+
+	if ( !expr ) {
+		return [];
+	}
+
+	for ( i = 0, len = Expr.order.length; i < len; i++ ) {
+		type = Expr.order[i];
+		
+		if ( (match = Expr.leftMatch[ type ].exec( expr )) ) {
+			left = match[1];
+			match.splice( 1, 1 );
+
+			if ( left.substr( left.length - 1 ) !== "\\" ) {
+				match[1] = (match[1] || "").replace( rBackslash, "" );
+				set = Expr.find[ type ]( match, context, isXML );
+
+				if ( set != null ) {
+					expr = expr.replace( Expr.match[ type ], "" );
+					break;
+				}
+			}
+		}
+	}
+
+	if ( !set ) {
+		set = typeof context.getElementsByTagName !== "undefined" ?
+			context.getElementsByTagName( "*" ) :
+			[];
+	}
+
+	return { set: set, expr: expr };
+};
+
+Sizzle.filter = function( expr, set, inplace, not ) {
+	var match, anyFound,
+		type, found, item, filter, left,
+		i, pass,
+		old = expr,
+		result = [],
+		curLoop = set,
+		isXMLFilter = set && set[0] && Sizzle.isXML( set[0] );
+
+	while ( expr && set.length ) {
+		for ( type in Expr.filter ) {
+			if ( (match = Expr.leftMatch[ type ].exec( expr )) != null && match[2] ) {
+				filter = Expr.filter[ type ];
+				left = match[1];
+
+				anyFound = false;
+
+				match.splice(1,1);
+
+				if ( left.substr( left.length - 1 ) === "\\" ) {
+					continue;
+				}
+
+				if ( curLoop === result ) {
+					result = [];
+				}
+
+				if ( Expr.preFilter[ type ] ) {
+					match = Expr.preFilter[ type ]( match, curLoop, inplace, result, not, isXMLFilter );
+
+					if ( !match ) {
+						anyFound = found = true;
+
+					} else if ( match === true ) {
+						continue;
+					}
+				}
+
+				if ( match ) {
+					for ( i = 0; (item = curLoop[i]) != null; i++ ) {
+						if ( item ) {
+							found = filter( item, match, i, curLoop );
+							pass = not ^ found;
+
+							if ( inplace && found != null ) {
+								if ( pass ) {
+									anyFound = true;
+
+								} else {
+									curLoop[i] = false;
+								}
+
+							} else if ( pass ) {
+								result.push( item );
+								anyFound = true;
+							}
+						}
+					}
+				}
+
+				if ( found !== undefined ) {
+					if ( !inplace ) {
+						curLoop = result;
+					}
+
+					expr = expr.replace( Expr.match[ type ], "" );
+
+					if ( !anyFound ) {
+						return [];
+					}
+
+					break;
+				}
+			}
+		}
+
+		// Improper expression
+		if ( expr === old ) {
+			if ( anyFound == null ) {
+				Sizzle.error( expr );
+
+			} else {
+				break;
+			}
+		}
+
+		old = expr;
+	}
+
+	return curLoop;
+};
+
+Sizzle.error = function( msg ) {
+	throw "Syntax error, unrecognized expression: " + msg;
+};
+
+/**
+ * Utility function for retreiving the text value of an array of DOM nodes
+ * @param {Array|Element} elem
+ */
+var getText = Sizzle.getText = function( elem ) {
+    var i, node,
+		nodeType = elem.nodeType,
+		ret = "";
+
+	if ( nodeType ) {
+		if ( nodeType === 1 ) {
+			// Use textContent || innerText for elements
+			if ( typeof elem.textContent === 'string' ) {
+				return elem.textContent;
+			} else if ( typeof elem.innerText === 'string' ) {
+				// Replace IE's carriage returns
+				return elem.innerText.replace( rReturn, '' );
+			} else {
+				// Traverse it's children
+				for ( elem = elem.firstChild; elem; elem = elem.nextSibling) {
+					ret += getText( elem );
+				}
+			}
+		} else if ( nodeType === 3 || nodeType === 4 ) {
+			return elem.nodeValue;
+		}
+	} else {
+
+		// If no nodeType, this is expected to be an array
+		for ( i = 0; (node = elem[i]); i++ ) {
+			// Do not traverse comment nodes
+			if ( node.nodeType !== 8 ) {
+				ret += getText( node );
+			}
+		}
+	}
+	return ret;
+};
+
+var Expr = Sizzle.selectors = {
+	order: [ "ID", "NAME", "TAG" ],
+
+	match: {
+		ID: /#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
+		CLASS: /\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
+		NAME: /\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,
+		ATTR: /\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,
+		TAG: /^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,
+		CHILD: /:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,
+		POS: /:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,
+		PSEUDO: /:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/
+	},
+
+	leftMatch: {},
+
+	attrMap: {
+		"class": "className",
+		"for": "htmlFor"
+	},
+
+	attrHandle: {
+		href: function( elem ) {
+			return elem.getAttribute( "href" );
+		},
+		type: function( elem ) {
+			return elem.getAttribute( "type" );
+		}
+	},
+
+	relative: {
+		"+": function(checkSet, part){
+			var isPartStr = typeof part === "string",
+				isTag = isPartStr && !rNonWord.test( part ),
+				isPartStrNotTag = isPartStr && !isTag;
+
+			if ( isTag ) {
+				part = part.toLowerCase();
+			}
+
+			for ( var i = 0, l = checkSet.length, elem; i < l; i++ ) {
+				if ( (elem = checkSet[i]) ) {
+					while ( (elem = elem.previousSibling) && elem.nodeType !== 1 ) {}
+
+					checkSet[i] = isPartStrNotTag || elem && elem.nodeName.toLowerCase() === part ?
+						elem || false :
+						elem === part;
+				}
+			}
+
+			if ( isPartStrNotTag ) {
+				Sizzle.filter( part, checkSet, true );
+			}
+		},
+
+		">": function( checkSet, part ) {
+			var elem,
+				isPartStr = typeof part === "string",
+				i = 0,
+				l = checkSet.length;
+
+			if ( isPartStr && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+
+				for ( ; i < l; i++ ) {
+					elem = checkSet[i];
+
+					if ( elem ) {
+						var parent = elem.parentNode;
+						checkSet[i] = parent.nodeName.toLowerCase() === part ? parent : false;
+					}
+				}
+
+			} else {
+				for ( ; i < l; i++ ) {
+					elem = checkSet[i];
+
+					if ( elem ) {
+						checkSet[i] = isPartStr ?
+							elem.parentNode :
+							elem.parentNode === part;
+					}
+				}
+
+				if ( isPartStr ) {
+					Sizzle.filter( part, checkSet, true );
+				}
+			}
+		},
+
+		"": function(checkSet, part, isXML){
+			var nodeCheck,
+				doneName = done++,
+				checkFn = dirCheck;
+
+			if ( typeof part === "string" && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+				nodeCheck = part;
+				checkFn = dirNodeCheck;
+			}
+
+			checkFn( "parentNode", part, doneName, checkSet, nodeCheck, isXML );
+		},
+
+		"~": function( checkSet, part, isXML ) {
+			var nodeCheck,
+				doneName = done++,
+				checkFn = dirCheck;
+
+			if ( typeof part === "string" && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+				nodeCheck = part;
+				checkFn = dirNodeCheck;
+			}
+
+			checkFn( "previousSibling", part, doneName, checkSet, nodeCheck, isXML );
+		}
+	},
+
+	find: {
+		ID: function( match, context, isXML ) {
+			if ( typeof context.getElementById !== "undefined" && !isXML ) {
+				var m = context.getElementById(match[1]);
+				// Check parentNode to catch when Blackberry 4.6 returns
+				// nodes that are no longer in the document #6963
+				return m && m.parentNode ? [m] : [];
+			}
+		},
+
+		NAME: function( match, context ) {
+			if ( typeof context.getElementsByName !== "undefined" ) {
+				var ret = [],
+					results = context.getElementsByName( match[1] );
+
+				for ( var i = 0, l = results.length; i < l; i++ ) {
+					if ( results[i].getAttribute("name") === match[1] ) {
+						ret.push( results[i] );
+					}
+				}
+
+				return ret.length === 0 ? null : ret;
+			}
+		},
+
+		TAG: function( match, context ) {
+			if ( typeof context.getElementsByTagName !== "undefined" ) {
+				return context.getElementsByTagName( match[1] );
+			}
+		}
+	},
+	preFilter: {
+		CLASS: function( match, curLoop, inplace, result, not, isXML ) {
+			match = " " + match[1].replace( rBackslash, "" ) + " ";
+
+			if ( isXML ) {
+				return match;
+			}
+
+			for ( var i = 0, elem; (elem = curLoop[i]) != null; i++ ) {
+				if ( elem ) {
+					if ( not ^ (elem.className && (" " + elem.className + " ").replace(/[\t\n\r]/g, " ").indexOf(match) >= 0) ) {
+						if ( !inplace ) {
+							result.push( elem );
+						}
+
+					} else if ( inplace ) {
+						curLoop[i] = false;
+					}
+				}
+			}
+
+			return false;
+		},
+
+		ID: function( match ) {
+			return match[1].replace( rBackslash, "" );
+		},
+
+		TAG: function( match, curLoop ) {
+			return match[1].replace( rBackslash, "" ).toLowerCase();
+		},
+
+		CHILD: function( match ) {
+			if ( match[1] === "nth" ) {
+				if ( !match[2] ) {
+					Sizzle.error( match[0] );
+				}
+
+				match[2] = match[2].replace(/^\+|\s*/g, '');
+
+				// parse equations like 'even', 'odd', '5', '2n', '3n+2', '4n-1', '-n+6'
+				var test = /(-?)(\d*)(?:n([+\-]?\d*))?/.exec(
+					match[2] === "even" && "2n" || match[2] === "odd" && "2n+1" ||
+					!/\D/.test( match[2] ) && "0n+" + match[2] || match[2]);
+
+				// calculate the numbers (first)n+(last) including if they are negative
+				match[2] = (test[1] + (test[2] || 1)) - 0;
+				match[3] = test[3] - 0;
+			}
+			else if ( match[2] ) {
+				Sizzle.error( match[0] );
+			}
+
+			// TODO: Move to normal caching system
+			match[0] = done++;
+
+			return match;
+		},
+
+		ATTR: function( match, curLoop, inplace, result, not, isXML ) {
+			var name = match[1] = match[1].replace( rBackslash, "" );
+			
+			if ( !isXML && Expr.attrMap[name] ) {
+				match[1] = Expr.attrMap[name];
+			}
+
+			// Handle if an un-quoted value was used
+			match[4] = ( match[4] || match[5] || "" ).replace( rBackslash, "" );
+
+			if ( match[2] === "~=" ) {
+				match[4] = " " + match[4] + " ";
+			}
+
+			return match;
+		},
+
+		PSEUDO: function( match, curLoop, inplace, result, not ) {
+			if ( match[1] === "not" ) {
+				// If we're dealing with a complex expression, or a simple one
+				if ( ( chunker.exec(match[3]) || "" ).length > 1 || /^\w/.test(match[3]) ) {
+					match[3] = Sizzle(match[3], null, null, curLoop);
+
+				} else {
+					var ret = Sizzle.filter(match[3], curLoop, inplace, true ^ not);
+
+					if ( !inplace ) {
+						result.push.apply( result, ret );
+					}
+
+					return false;
+				}
+
+			} else if ( Expr.match.POS.test( match[0] ) || Expr.match.CHILD.test( match[0] ) ) {
+				return true;
+			}
+			
+			return match;
+		},
+
+		POS: function( match ) {
+			match.unshift( true );
+
+			return match;
+		}
+	},
+	
+	filters: {
+		enabled: function( elem ) {
+			return elem.disabled === false && elem.type !== "hidden";
+		},
+
+		disabled: function( elem ) {
+			return elem.disabled === true;
+		},
+
+		checked: function( elem ) {
+			return elem.checked === true;
+		},
+		
+		selected: function( elem ) {
+			// Accessing this property makes selected-by-default
+			// options in Safari work properly
+			if ( elem.parentNode ) {
+				elem.parentNode.selectedIndex;
+			}
+			
+			return elem.selected === true;
+		},
+
+		parent: function( elem ) {
+			return !!elem.firstChild;
+		},
+
+		empty: function( elem ) {
+			return !elem.firstChild;
+		},
+
+		has: function( elem, i, match ) {
+			return !!Sizzle( match[3], elem ).length;
+		},
+
+		header: function( elem ) {
+			return (/h\d/i).test( elem.nodeName );
+		},
+
+		text: function( elem ) {
+			var attr = elem.getAttribute( "type" ), type = elem.type;
+			// IE6 and 7 will map elem.type to 'text' for new HTML5 types (search, etc) 
+			// use getAttribute instead to test this case
+			return elem.nodeName.toLowerCase() === "input" && "text" === type && ( attr === type || attr === null );
+		},
+
+		radio: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "radio" === elem.type;
+		},
+
+		checkbox: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "checkbox" === elem.type;
+		},
+
+		file: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "file" === elem.type;
+		},
+
+		password: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "password" === elem.type;
+		},
+
+		submit: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return (name === "input" || name === "button") && "submit" === elem.type;
+		},
+
+		image: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "image" === elem.type;
+		},
+
+		reset: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return (name === "input" || name === "button") && "reset" === elem.type;
+		},
+
+		button: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return name === "input" && "button" === elem.type || name === "button";
+		},
+
+		input: function( elem ) {
+			return (/input|select|textarea|button/i).test( elem.nodeName );
+		},
+
+		focus: function( elem ) {
+			return elem === elem.ownerDocument.activeElement;
+		}
+	},
+	setFilters: {
+		first: function( elem, i ) {
+			return i === 0;
+		},
+
+		last: function( elem, i, match, array ) {
+			return i === array.length - 1;
+		},
+
+		even: function( elem, i ) {
+			return i % 2 === 0;
+		},
+
+		odd: function( elem, i ) {
+			return i % 2 === 1;
+		},
+
+		lt: function( elem, i, match ) {
+			return i < match[3] - 0;
+		},
+
+		gt: function( elem, i, match ) {
+			return i > match[3] - 0;
+		},
+
+		nth: function( elem, i, match ) {
+			return match[3] - 0 === i;
+		},
+
+		eq: function( elem, i, match ) {
+			return match[3] - 0 === i;
+		}
+	},
+	filter: {
+		PSEUDO: function( elem, match, i, array ) {
+			var name = match[1],
+				filter = Expr.filters[ name ];
+
+			if ( filter ) {
+				return filter( elem, i, match, array );
+
+			} else if ( name === "contains" ) {
+				return (elem.textContent || elem.innerText || getText([ elem ]) || "").indexOf(match[3]) >= 0;
+
+			} else if ( name === "not" ) {
+				var not = match[3];
+
+				for ( var j = 0, l = not.length; j < l; j++ ) {
+					if ( not[j] === elem ) {
+						return false;
+					}
+				}
+
+				return true;
+
+			} else {
+				Sizzle.error( name );
+			}
+		},
+
+		CHILD: function( elem, match ) {
+			var first, last,
+				doneName, parent, cache,
+				count, diff,
+				type = match[1],
+				node = elem;
+
+			switch ( type ) {
+				case "only":
+				case "first":
+					while ( (node = node.previousSibling) )	 {
+						if ( node.nodeType === 1 ) { 
+							return false; 
+						}
+					}
+
+					if ( type === "first" ) { 
+						return true; 
+					}
+
+					node = elem;
+
+				case "last":
+					while ( (node = node.nextSibling) )	 {
+						if ( node.nodeType === 1 ) { 
+							return false; 
+						}
+					}
+
+					return true;
+
+				case "nth":
+					first = match[2];
+					last = match[3];
+
+					if ( first === 1 && last === 0 ) {
+						return true;
+					}
+					
+					doneName = match[0];
+					parent = elem.parentNode;
+	
+					if ( parent && (parent[ expando ] !== doneName || !elem.nodeIndex) ) {
+						count = 0;
+						
+						for ( node = parent.firstChild; node; node = node.nextSibling ) {
+							if ( node.nodeType === 1 ) {
+								node.nodeIndex = ++count;
+							}
+						} 
+
+						parent[ expando ] = doneName;
+					}
+					
+					diff = elem.nodeIndex - last;
+
+					if ( first === 0 ) {
+						return diff === 0;
+
+					} else {
+						return ( diff % first === 0 && diff / first >= 0 );
+					}
+			}
+		},
+
+		ID: function( elem, match ) {
+			return elem.nodeType === 1 && elem.getAttribute("id") === match;
+		},
+
+		TAG: function( elem, match ) {
+			return (match === "*" && elem.nodeType === 1) || !!elem.nodeName && elem.nodeName.toLowerCase() === match;
+		},
+		
+		CLASS: function( elem, match ) {
+			return (" " + (elem.className || elem.getAttribute("class")) + " ")
+				.indexOf( match ) > -1;
+		},
+
+		ATTR: function( elem, match ) {
+			var name = match[1],
+				result = Sizzle.attr ?
+					Sizzle.attr( elem, name ) :
+					Expr.attrHandle[ name ] ?
+					Expr.attrHandle[ name ]( elem ) :
+					elem[ name ] != null ?
+						elem[ name ] :
+						elem.getAttribute( name ),
+				value = result + "",
+				type = match[2],
+				check = match[4];
+
+			return result == null ?
+				type === "!=" :
+				!type && Sizzle.attr ?
+				result != null :
+				type === "=" ?
+				value === check :
+				type === "*=" ?
+				value.indexOf(check) >= 0 :
+				type === "~=" ?
+				(" " + value + " ").indexOf(check) >= 0 :
+				!check ?
+				value && result !== false :
+				type === "!=" ?
+				value !== check :
+				type === "^=" ?
+				value.indexOf(check) === 0 :
+				type === "$=" ?
+				value.substr(value.length - check.length) === check :
+				type === "|=" ?
+				value === check || value.substr(0, check.length + 1) === check + "-" :
+				false;
+		},
+
+		POS: function( elem, match, i, array ) {
+			var name = match[2],
+				filter = Expr.setFilters[ name ];
+
+			if ( filter ) {
+				return filter( elem, i, match, array );
+			}
+		}
+	}
+};
+
+var origPOS = Expr.match.POS,
+	fescape = function(all, num){
+		return "\\" + (num - 0 + 1);
+	};
+
+for ( var type in Expr.match ) {
+	Expr.match[ type ] = new RegExp( Expr.match[ type ].source + (/(?![^\[]*\])(?![^\(]*\))/.source) );
+	Expr.leftMatch[ type ] = new RegExp( /(^(?:.|\r|\n)*?)/.source + Expr.match[ type ].source.replace(/\\(\d+)/g, fescape) );
+}
+
+var makeArray = function( array, results ) {
+	array = Array.prototype.slice.call( array, 0 );
+
+	if ( results ) {
+		results.push.apply( results, array );
+		return results;
+	}
+	
+	return array;
+};
+
+// Perform a simple check to determine if the browser is capable of
+// converting a NodeList to an array using builtin methods.
+// Also verifies that the returned array holds DOM nodes
+// (which is not the case in the Blackberry browser)
+try {
+	Array.prototype.slice.call( document.documentElement.childNodes, 0 )[0].nodeType;
+
+// Provide a fallback method if it does not work
+} catch( e ) {
+	makeArray = function( array, results ) {
+		var i = 0,
+			ret = results || [];
+
+		if ( toString.call(array) === "[object Array]" ) {
+			Array.prototype.push.apply( ret, array );
+
+		} else {
+			if ( typeof array.length === "number" ) {
+				for ( var l = array.length; i < l; i++ ) {
+					ret.push( array[i] );
+				}
+
+			} else {
+				for ( ; array[i]; i++ ) {
+					ret.push( array[i] );
+				}
+			}
+		}
+
+		return ret;
+	};
+}
+
+var sortOrder, siblingCheck;
+
+if ( document.documentElement.compareDocumentPosition ) {
+	sortOrder = function( a, b ) {
+		if ( a === b ) {
+			hasDuplicate = true;
+			return 0;
+		}
+
+		if ( !a.compareDocumentPosition || !b.compareDocumentPosition ) {
+			return a.compareDocumentPosition ? -1 : 1;
+		}
+
+		return a.compareDocumentPosition(b) & 4 ? -1 : 1;
+	};
+
+} else {
+	sortOrder = function( a, b ) {
+		// The nodes are identical, we can exit early
+		if ( a === b ) {
+			hasDuplicate = true;
+			return 0;
+
+		// Fallback to using sourceIndex (in IE) if it's available on both nodes
+		} else if ( a.sourceIndex && b.sourceIndex ) {
+			return a.sourceIndex - b.sourceIndex;
+		}
+
+		var al, bl,
+			ap = [],
+			bp = [],
+			aup = a.parentNode,
+			bup = b.parentNode,
+			cur = aup;
+
+		// If the nodes are siblings (or identical) we can do a quick check
+		if ( aup === bup ) {
+			return siblingCheck( a, b );
+
+		// If no parents were found then the nodes are disconnected
+		} else if ( !aup ) {
+			return -1;
+
+		} else if ( !bup ) {
+			return 1;
+		}
+
+		// Otherwise they're somewhere else in the tree so we need
+		// to build up a full list of the parentNodes for comparison
+		while ( cur ) {
+			ap.unshift( cur );
+			cur = cur.parentNode;
+		}
+
+		cur = bup;
+
+		while ( cur ) {
+			bp.unshift( cur );
+			cur = cur.parentNode;
+		}
+
+		al = ap.length;
+		bl = bp.length;
+
+		// Start walking down the tree looking for a discrepancy
+		for ( var i = 0; i < al && i < bl; i++ ) {
+			if ( ap[i] !== bp[i] ) {
+				return siblingCheck( ap[i], bp[i] );
+			}
+		}
+
+		// We ended someplace up the tree so do a sibling check
+		return i === al ?
+			siblingCheck( a, bp[i], -1 ) :
+			siblingCheck( ap[i], b, 1 );
+	};
+
+	siblingCheck = function( a, b, ret ) {
+		if ( a === b ) {
+			return ret;
+		}
+
+		var cur = a.nextSibling;
+
+		while ( cur ) {
+			if ( cur === b ) {
+				return -1;
+			}
+
+			cur = cur.nextSibling;
+		}
+
+		return 1;
+	};
+}
+
+// Check to see if the browser returns elements by name when
+// querying by getElementById (and provide a workaround)
+(function(){
+	// We're going to inject a fake input element with a specified name
+	var form = document.createElement("div"),
+		id = "script" + (new Date()).getTime(),
+		root = document.documentElement;
+
+	form.innerHTML = "<a name='" + id + "'/>";
+
+	// Inject it into the root element, check its status, and remove it quickly
+	root.insertBefore( form, root.firstChild );
+
+	// The workaround has to do additional checks after a getElementById
+	// Which slows things down for other browsers (hence the branching)
+	if ( document.getElementById( id ) ) {
+		Expr.find.ID = function( match, context, isXML ) {
+			if ( typeof context.getElementById !== "undefined" && !isXML ) {
+				var m = context.getElementById(match[1]);
+
+				return m ?
+					m.id === match[1] || typeof m.getAttributeNode !== "undefined" && m.getAttributeNode("id").nodeValue === match[1] ?
+						[m] :
+						undefined :
+					[];
+			}
+		};
+
+		Expr.filter.ID = function( elem, match ) {
+			var node = typeof elem.getAttributeNode !== "undefined" && elem.getAttributeNode("id");
+
+			return elem.nodeType === 1 && node && node.nodeValue === match;
+		};
+	}
+
+	root.removeChild( form );
+
+	// release memory in IE
+	root = form = null;
+})();
+
+(function(){
+	// Check to see if the browser returns only elements
+	// when doing getElementsByTagName("*")
+
+	// Create a fake element
+	var div = document.createElement("div");
+	div.appendChild( document.createComment("") );
+
+	// Make sure no comments are found
+	if ( div.getElementsByTagName("*").length > 0 ) {
+		Expr.find.TAG = function( match, context ) {
+			var results = context.getElementsByTagName( match[1] );
+
+			// Filter out possible comments
+			if ( match[1] === "*" ) {
+				var tmp = [];
+
+				for ( var i = 0; results[i]; i++ ) {
+					if ( results[i].nodeType === 1 ) {
+						tmp.push( results[i] );
+					}
+				}
+
+				results = tmp;
+			}
+
+			return results;
+		};
+	}
+
+	// Check to see if an attribute returns normalized href attributes
+	div.innerHTML = "<a href='#'></a>";
+
+	if ( div.firstChild && typeof div.firstChild.getAttribute !== "undefined" &&
+			div.firstChild.getAttribute("href") !== "#" ) {
+
+		Expr.attrHandle.href = function( elem ) {
+			return elem.getAttribute( "href", 2 );
+		};
+	}
+
+	// release memory in IE
+	div = null;
+})();
+
+if ( document.querySelectorAll ) {
+	(function(){
+		var oldSizzle = Sizzle,
+			div = document.createElement("div"),
+			id = "__sizzle__";
+
+		div.innerHTML = "<p class='TEST'></p>";
+
+		// Safari can't handle uppercase or unicode characters when
+		// in quirks mode.
+		if ( div.querySelectorAll && div.querySelectorAll(".TEST").length === 0 ) {
+			return;
+		}
+	
+		Sizzle = function( query, context, extra, seed ) {
+			context = context || document;
+
+			// Only use querySelectorAll on non-XML documents
+			// (ID selectors don't work in non-HTML documents)
+			if ( !seed && !Sizzle.isXML(context) ) {
+				// See if we find a selector to speed up
+				var match = /^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec( query );
+				
+				if ( match && (context.nodeType === 1 || context.nodeType === 9) ) {
+					// Speed-up: Sizzle("TAG")
+					if ( match[1] ) {
+						return makeArray( context.getElementsByTagName( query ), extra );
+					
+					// Speed-up: Sizzle(".CLASS")
+					} else if ( match[2] && Expr.find.CLASS && context.getElementsByClassName ) {
+						return makeArray( context.getElementsByClassName( match[2] ), extra );
+					}
+				}
+				
+				if ( context.nodeType === 9 ) {
+					// Speed-up: Sizzle("body")
+					// The body element only exists once, optimize finding it
+					if ( query === "body" && context.body ) {
+						return makeArray( [ context.body ], extra );
+						
+					// Speed-up: Sizzle("#ID")
+					} else if ( match && match[3] ) {
+						var elem = context.getElementById( match[3] );
+
+						// Check parentNode to catch when Blackberry 4.6 returns
+						// nodes that are no longer in the document #6963
+						if ( elem && elem.parentNode ) {
+							// Handle the case where IE and Opera return items
+							// by name instead of ID
+							if ( elem.id === match[3] ) {
+								return makeArray( [ elem ], extra );
+							}
+							
+						} else {
+							return makeArray( [], extra );
+						}
+					}
+					
+					try {
+						return makeArray( context.querySelectorAll(query), extra );
+					} catch(qsaError) {}
+
+				// qSA works strangely on Element-rooted queries
+				// We can work around this by specifying an extra ID on the root
+				// and working up from there (Thanks to Andrew Dupont for the technique)
+				// IE 8 doesn't work on object elements
+				} else if ( context.nodeType === 1 && context.nodeName.toLowerCase() !== "object" ) {
+					var oldContext = context,
+						old = context.getAttribute( "id" ),
+						nid = old || id,
+						hasParent = context.parentNode,
+						relativeHierarchySelector = /^\s*[+~]/.test( query );
+
+					if ( !old ) {
+						context.setAttribute( "id", nid );
+					} else {
+						nid = nid.replace( /'/g, "\\$&" );
+					}
+					if ( relativeHierarchySelector && hasParent ) {
+						context = context.parentNode;
+					}
+
+					try {
+						if ( !relativeHierarchySelector || hasParent ) {
+							return makeArray( context.querySelectorAll( "[id='" + nid + "'] " + query ), extra );
+						}
+
+					} catch(pseudoError) {
+					} finally {
+						if ( !old ) {
+							oldContext.removeAttribute( "id" );
+						}
+					}
+				}
+			}
+		
+			return oldSizzle(query, context, extra, seed);
+		};
+
+		for ( var prop in oldSizzle ) {
+			Sizzle[ prop ] = oldSizzle[ prop ];
+		}
+
+		// release memory in IE
+		div = null;
+	})();
+}
+
+(function(){
+	var html = document.documentElement,
+		matches = html.matchesSelector || html.mozMatchesSelector || html.webkitMatchesSelector || html.msMatchesSelector;
+
+	if ( matches ) {
+		// Check to see if it's possible to do matchesSelector
+		// on a disconnected node (IE 9 fails this)
+		var disconnectedMatch = !matches.call( document.createElement( "div" ), "div" ),
+			pseudoWorks = false;
+
+		try {
+			// This should fail with an exception
+			// Gecko does not error, returns false instead
+			matches.call( document.documentElement, "[test!='']:sizzle" );
+	
+		} catch( pseudoError ) {
+			pseudoWorks = true;
+		}
+
+		Sizzle.matchesSelector = function( node, expr ) {
+			// Make sure that attribute selectors are quoted
+			expr = expr.replace(/\=\s*([^'"\]]*)\s*\]/g, "='$1']");
+
+			if ( !Sizzle.isXML( node ) ) {
+				try { 
+					if ( pseudoWorks || !Expr.match.PSEUDO.test( expr ) && !/!=/.test( expr ) ) {
+						var ret = matches.call( node, expr );
+
+						// IE 9's matchesSelector returns false on disconnected nodes
+						if ( ret || !disconnectedMatch ||
+								// As well, disconnected nodes are said to be in a document
+								// fragment in IE 9, so check for that
+								node.document && node.document.nodeType !== 11 ) {
+							return ret;
+						}
+					}
+				} catch(e) {}
+			}
+
+			return Sizzle(expr, null, null, [node]).length > 0;
+		};
+	}
+})();
+
+(function(){
+	var div = document.createElement("div");
+
+	div.innerHTML = "<div class='test e'></div><div class='test'></div>";
+
+	// Opera can't find a second classname (in 9.6)
+	// Also, make sure that getElementsByClassName actually exists
+	if ( !div.getElementsByClassName || div.getElementsByClassName("e").length === 0 ) {
+		return;
+	}
+
+	// Safari caches class attributes, doesn't catch changes (in 3.2)
+	div.lastChild.className = "e";
+
+	if ( div.getElementsByClassName("e").length === 1 ) {
+		return;
+	}
+	
+	Expr.order.splice(1, 0, "CLASS");
+	Expr.find.CLASS = function( match, context, isXML ) {
+		if ( typeof context.getElementsByClassName !== "undefined" && !isXML ) {
+			return context.getElementsByClassName(match[1]);
+		}
+	};
+
+	// release memory in IE
+	div = null;
+})();
+
+function dirNodeCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
+	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
+		var elem = checkSet[i];
+
+		if ( elem ) {
+			var match = false;
+
+			elem = elem[dir];
+
+			while ( elem ) {
+				if ( elem[ expando ] === doneName ) {
+					match = checkSet[elem.sizset];
+					break;
+				}
+
+				if ( elem.nodeType === 1 && !isXML ){
+					elem[ expando ] = doneName;
+					elem.sizset = i;
+				}
+
+				if ( elem.nodeName.toLowerCase() === cur ) {
+					match = elem;
+					break;
+				}
+
+				elem = elem[dir];
+			}
+
+			checkSet[i] = match;
+		}
+	}
+}
+
+function dirCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
+	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
+		var elem = checkSet[i];
+
+		if ( elem ) {
+			var match = false;
+			
+			elem = elem[dir];
+
+			while ( elem ) {
+				if ( elem[ expando ] === doneName ) {
+					match = checkSet[elem.sizset];
+					break;
+				}
+
+				if ( elem.nodeType === 1 ) {
+					if ( !isXML ) {
+						elem[ expando ] = doneName;
+						elem.sizset = i;
+					}
+
+					if ( typeof cur !== "string" ) {
+						if ( elem === cur ) {
+							match = true;
+							break;
+						}
+
+					} else if ( Sizzle.filter( cur, [elem] ).length > 0 ) {
+						match = elem;
+						break;
+					}
+				}
+
+				elem = elem[dir];
+			}
+
+			checkSet[i] = match;
+		}
+	}
+}
+
+if ( document.documentElement.contains ) {
+	Sizzle.contains = function( a, b ) {
+		return a !== b && (a.contains ? a.contains(b) : true);
+	};
+
+} else if ( document.documentElement.compareDocumentPosition ) {
+	Sizzle.contains = function( a, b ) {
+		return !!(a.compareDocumentPosition(b) & 16);
+	};
+
+} else {
+	Sizzle.contains = function() {
+		return false;
+	};
+}
+
+Sizzle.isXML = function( elem ) {
+	// documentElement is verified for cases where it doesn't yet exist
+	// (such as loading iframes in IE - #4833) 
+	var documentElement = (elem ? elem.ownerDocument || elem : 0).documentElement;
+
+	return documentElement ? documentElement.nodeName !== "HTML" : false;
+};
+
+var posProcess = function( selector, context, seed ) {
+	var match,
+		tmpSet = [],
+		later = "",
+		root = context.nodeType ? [context] : context;
+
+	// Position selectors must be done after the filter
+	// And so must :not(positional) so we move all PSEUDOs to the end
+	while ( (match = Expr.match.PSEUDO.exec( selector )) ) {
+		later += match[0];
+		selector = selector.replace( Expr.match.PSEUDO, "" );
+	}
+
+	selector = Expr.relative[selector] ? selector + "*" : selector;
+
+	for ( var i = 0, l = root.length; i < l; i++ ) {
+		Sizzle( selector, root[i], tmpSet, seed );
+	}
+
+	return Sizzle.filter( later, tmpSet );
+};
+
+// EXPOSE
+// Override sizzle attribute retrieval
+Sizzle.attr = jQuery.attr;
+Sizzle.selectors.attrMap = {};
+jQuery.find = Sizzle;
+jQuery.expr = Sizzle.selectors;
+jQuery.expr[":"] = jQuery.expr.filters;
+jQuery.unique = Sizzle.uniqueSort;
+jQuery.text = Sizzle.getText;
+jQuery.isXMLDoc = Sizzle.isXML;
+jQuery.contains = Sizzle.contains;
+
+
+})();
+
+
+var runtil = /Until$/,
+	rparentsprev = /^(?:parents|prevUntil|prevAll)/,
+	// Note: This RegExp should be improved, or likely pulled from Sizzle
+	rmultiselector = /,/,
+	isSimple = /^.[^:#\[\.,]*$/,
+	slice = Array.prototype.slice,
+	POS = jQuery.expr.match.POS,
+	// methods guaranteed to produce a unique set when starting from a unique set
+	guaranteedUnique = {
+		children: true,
+		contents: true,
+		next: true,
+		prev: true
+	};
+
+jQuery.fn.extend({
+	find: function( selector ) {
+		var self = this,
+			i, l;
+
+		if ( typeof selector !== "string" ) {
+			return jQuery( selector ).filter(function() {
+				for ( i = 0, l = self.length; i < l; i++ ) {
+					if ( jQuery.contains( self[ i ], this ) ) {
+						return true;
+					}
+				}
+			});
+		}
+
+		var ret = this.pushStack( "", "find", selector ),
+			length, n, r;
+
+		for ( i = 0, l = this.length; i < l; i++ ) {
+			length = ret.length;
+			jQuery.find( selector, this[i], ret );
+
+			if ( i > 0 ) {
+				// Make sure that the results are unique
+				for ( n = length; n < ret.length; n++ ) {
+					for ( r = 0; r < length; r++ ) {
+						if ( ret[r] === ret[n] ) {
+							ret.splice(n--, 1);
+							break;
+						}
+					}
+				}
+			}
+		}
+
+		return ret;
+	},
+
+	has: function( target ) {
+		var targets = jQuery( target );
+		return this.filter(function() {
+			for ( var i = 0, l = targets.length; i < l; i++ ) {
+				if ( jQuery.contains( this, targets[i] ) ) {
+					return true;
+				}
+			}
+		});
+	},
+
+	not: function( selector ) {
+		return this.pushStack( winnow(this, selector, false), "not", selector);
+	},
+
+	filter: function( selector ) {
+		return this.pushStack( winnow(this, selector, true), "filter", selector );
+	},
+
+	is: function( selector ) {
+		return !!selector && ( 
+			typeof selector === "string" ?
+				// If this is a positional selector, check membership in the returned set
+				// so $("p:first").is("p:last") won't return true for a doc with two "p".
+				POS.test( selector ) ? 
+					jQuery( selector, this.context ).index( this[0] ) >= 0 :
+					jQuery.filter( selector, this ).length > 0 :
+				this.filter( selector ).length > 0 );
+	},
+
+	closest: function( selectors, context ) {
+		var ret = [], i, l, cur = this[0];
+		
+		// Array (deprecated as of jQuery 1.7)
+		if ( jQuery.isArray( selectors ) ) {
+			var level = 1;
+
+			while ( cur && cur.ownerDocument && cur !== context ) {
+				for ( i = 0; i < selectors.length; i++ ) {
+
+					if ( jQuery( cur ).is( selectors[ i ] ) ) {
+						ret.push({ selector: selectors[ i ], elem: cur, level: level });
+					}
+				}
+
+				cur = cur.parentNode;
+				level++;
+			}
+
+			return ret;
+		}
+
+		// String
+		var pos = POS.test( selectors ) || typeof selectors !== "string" ?
+				jQuery( selectors, context || this.context ) :
+				0;
+
+		for ( i = 0, l = this.length; i < l; i++ ) {
+			cur = this[i];
+
+			while ( cur ) {
+				if ( pos ? pos.index(cur) > -1 : jQuery.find.matchesSelector(cur, selectors) ) {
+					ret.push( cur );
+					break;
+
+				} else {
+					cur = cur.parentNode;
+					if ( !cur || !cur.ownerDocument || cur === context || cur.nodeType === 11 ) {
+						break;
+					}
+				}
+			}
+		}
+
+		ret = ret.length > 1 ? jQuery.unique( ret ) : ret;
+
+		return this.pushStack( ret, "closest", selectors );
+	},
+
+	// Determine the position of an element within
+	// the matched set of elements
+	index: function( elem ) {
+
+		// No argument, return index in parent
+		if ( !elem ) {
+			return ( this[0] && this[0].parentNode ) ? this.prevAll().length : -1;
+		}
+
+		// index in selector
+		if ( typeof elem === "string" ) {
+			return jQuery.inArray( this[0], jQuery( elem ) );
+		}
+
+		// Locate the position of the desired element
+		return jQuery.inArray(
+			// If it receives a jQuery object, the first element is used
+			elem.jquery ? elem[0] : elem, this );
+	},
+
+	add: function( selector, context ) {
+		var set = typeof selector === "string" ?
+				jQuery( selector, context ) :
+				jQuery.makeArray( selector && selector.nodeType ? [ selector ] : selector ),
+			all = jQuery.merge( this.get(), set );
+
+		return this.pushStack( isDisconnected( set[0] ) || isDisconnected( all[0] ) ?
+			all :
+			jQuery.unique( all ) );
+	},
+
+	andSelf: function() {
+		return this.add( this.prevObject );
+	}
+});
+
+// A painfully simple check to see if an element is disconnected
+// from a document (should be improved, where feasible).
+function isDisconnected( node ) {
+	return !node || !node.parentNode || node.parentNode.nodeType === 11;
+}
+
+jQuery.each({
+	parent: function( elem ) {
+		var parent = elem.parentNode;
+		return parent && parent.nodeType !== 11 ? parent : null;
+	},
+	parents: function( elem ) {
+		return jQuery.dir( elem, "parentNode" );
+	},
+	parentsUntil: function( elem, i, until ) {
+		return jQuery.dir( elem, "parentNode", until );
+	},
+	next: function( elem ) {
+		return jQuery.nth( elem, 2, "nextSibling" );
+	},
+	prev: function( elem ) {
+		return jQuery.nth( elem, 2, "previousSibling" );
+	},
+	nextAll: function( elem ) {
+		return jQuery.dir( elem, "nextSibling" );
+	},
+	prevAll: function( elem ) {
+		return jQuery.dir( elem, "previousSibling" );
+	},
+	nextUntil: function( elem, i, until ) {
+		return jQuery.dir( elem, "nextSibling", until );
+	},
+	prevUntil: function( elem, i, until ) {
+		return jQuery.dir( elem, "previousSibling", until );
+	},
+	siblings: function( elem ) {
+		return jQuery.sibling( elem.parentNode.firstChild, elem );
+	},
+	children: function( elem ) {
+		return jQuery.sibling( elem.firstChild );
+	},
+	contents: function( elem ) {
+		return jQuery.nodeName( elem, "iframe" ) ?
+			elem.contentDocument || elem.contentWindow.document :
+			jQuery.makeArray( elem.childNodes );
+	}
+}, function( name, fn ) {
+	jQuery.fn[ name ] = function( until, selector ) {
+		var ret = jQuery.map( this, fn, until ),
+			// The variable 'args' was introduced in
+			// https://github.com/jquery/jquery/commit/52a0238
+			// to work around a bug in Chrome 10 (Dev) and should be removed when the bug is fixed.
+			// http://code.google.com/p/v8/issues/detail?id=1050
+			args = slice.call(arguments);
+
+		if ( !runtil.test( name ) ) {
+			selector = until;
+		}
+
+		if ( selector && typeof selector === "string" ) {
+			ret = jQuery.filter( selector, ret );
+		}
+
+		ret = this.length > 1 && !guaranteedUnique[ name ] ? jQuery.unique( ret ) : ret;
+
+		if ( (this.length > 1 || rmultiselector.test( selector )) && rparentsprev.test( name ) ) {
+			ret = ret.reverse();
+		}
+
+		return this.pushStack( ret, name, args.join(",") );
+	};
+});
+
+jQuery.extend({
+	filter: function( expr, elems, not ) {
+		if ( not ) {
+			expr = ":not(" + expr + ")";
+		}
+
+		return elems.length === 1 ?
+			jQuery.find.matchesSelector(elems[0], expr) ? [ elems[0] ] : [] :
+			jQuery.find.matches(expr, elems);
+	},
+
+	dir: function( elem, dir, until ) {
+		var matched = [],
+			cur = elem[ dir ];
+
+		while ( cur && cur.nodeType !== 9 && (until === undefined || cur.nodeType !== 1 || !jQuery( cur ).is( until )) ) {
+			if ( cur.nodeType === 1 ) {
+				matched.push( cur );
+			}
+			cur = cur[dir];
+		}
+		return matched;
+	},
+
+	nth: function( cur, result, dir, elem ) {
+		result = result || 1;
+		var num = 0;
+
+		for ( ; cur; cur = cur[dir] ) {
+			if ( cur.nodeType === 1 && ++num === result ) {
+				break;
+			}
+		}
+
+		return cur;
+	},
+
+	sibling: function( n, elem ) {
+		var r = [];
+
+		for ( ; n; n = n.nextSibling ) {
+			if ( n.nodeType === 1 && n !== elem ) {
+				r.push( n );
+			}
+		}
+
+		return r;
+	}
+});
+
+// Implement the identical functionality for filter and not
+function winnow( elements, qualifier, keep ) {
+
+	// Can't pass null or undefined to indexOf in Firefox 4
+	// Set to 0 to skip string check
+	qualifier = qualifier || 0;
+
+	if ( jQuery.isFunction( qualifier ) ) {
+		return jQuery.grep(elements, function( elem, i ) {
+			var retVal = !!qualifier.call( elem, i, elem );
+			return retVal === keep;
+		});
+
+	} else if ( qualifier.nodeType ) {
+		return jQuery.grep(elements, function( elem, i ) {
+			return (elem === qualifier) === keep;
+		});
+
+	} else if ( typeof qualifier === "string" ) {
+		var filtered = jQuery.grep(elements, function( elem ) {
+			return elem.nodeType === 1;
+		});
+
+		if ( isSimple.test( qualifier ) ) {
+			return jQuery.filter(qualifier, filtered, !keep);
+		} else {
+			qualifier = jQuery.filter( qualifier, filtered );
+		}
+	}
+
+	return jQuery.grep(elements, function( elem, i ) {
+		return (jQuery.inArray( elem, qualifier ) >= 0) === keep;
+	});
+}
+
+
+
+
+function createSafeFragment( document ) {
+	var nodeNames = (
+		"abbr article aside audio canvas datalist details figcaption figure footer " +
+		"header hgroup mark meter nav output progress section summary time video"
+	).split( " " ),
+	safeFrag = document.createDocumentFragment();
+
+	if ( safeFrag.createElement ) {
+		while ( nodeNames.length ) {
+			safeFrag.createElement(
+				nodeNames.pop()
+			);
+		}
+	}
+	return safeFrag;
+}
+
+var rinlinejQuery = / jQuery\d+="(?:\d+|null)"/g,
+	rleadingWhitespace = /^\s+/,
+	rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,
+	rtagName = /<([\w:]+)/,
+	rtbody = /<tbody/i,
+	rhtml = /<|&#?\w+;/,
+	rnoInnerhtml = /<(?:script|style)/i,
+	rnocache = /<(?:script|object|embed|option|style)/i,
+	// checked="checked" or checked
+	rchecked = /checked\s*(?:[^=]|=\s*.checked.)/i,
+	rscriptType = /\/(java|ecma)script/i,
+	rcleanScript = /^\s*<!(?:\[CDATA\[|\-\-)/,
+	wrapMap = {
+		option: [ 1, "<select multiple='multiple'>", "</select>" ],
+		legend: [ 1, "<fieldset>", "</fieldset>" ],
+		thead: [ 1, "<table>", "</table>" ],
+		tr: [ 2, "<table><tbody>", "</tbody></table>" ],
+		td: [ 3, "<table><tbody><tr>", "</tr></tbody></table>" ],
+		col: [ 2, "<table><tbody></tbody><colgroup>", "</colgroup></table>" ],
+		area: [ 1, "<map>", "</map>" ],
+		_default: [ 0, "", "" ]
+	},
+	safeFragment = createSafeFragment( document );
+
+wrapMap.optgroup = wrapMap.option;
+wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
+wrapMap.th = wrapMap.td;
+
+// IE can't serialize <link> and <script> tags normally
+if ( !jQuery.support.htmlSerialize ) {
+	wrapMap._default = [ 1, "div<div>", "</div>" ];
+}
+
+jQuery.fn.extend({
+	text: function( text ) {
+		if ( jQuery.isFunction(text) ) {
+			return this.each(function(i) {
+				var self = jQuery( this );
+
+				self.text( text.call(this, i, self.text()) );
+			});
+		}
+
+		if ( typeof text !== "object" && text !== undefined ) {
+			return this.empty().append( (this[0] && this[0].ownerDocument || document).createTextNode( text ) );
+		}
+
+		return jQuery.text( this );
+	},
+
+	wrapAll: function( html ) {
+		if ( jQuery.isFunction( html ) ) {
+			return this.each(function(i) {
+				jQuery(this).wrapAll( html.call(this, i) );
+			});
+		}
+
+		if ( this[0] ) {
+			// The elements to wrap the target around
+			var wrap = jQuery( html, this[0].ownerDocument ).eq(0).clone(true);
+
+			if ( this[0].parentNode ) {
+				wrap.insertBefore( this[0] );
+			}
+
+			wrap.map(function() {
+				var elem = this;
+
+				while ( elem.firstChild && elem.firstChild.nodeType === 1 ) {
+					elem = elem.firstChild;
+				}
+
+				return elem;
+			}).append( this );
+		}
+
+		return this;
+	},
+
+	wrapInner: function( html ) {
+		if ( jQuery.isFunction( html ) ) {
+			return this.each(function(i) {
+				jQuery(this).wrapInner( html.call(this, i) );
+			});
+		}
+
+		return this.each(function() {
+			var self = jQuery( this ),
+				contents = self.contents();
+
+			if ( contents.length ) {
+				contents.wrapAll( html );
+
+			} else {
+				self.append( html );
+			}
+		});
+	},
+
+	wrap: function( html ) {
+		return this.each(function() {
+			jQuery( this ).wrapAll( html );
+		});
+	},
+
+	unwrap: function() {
+		return this.parent().each(function() {
+			if ( !jQuery.nodeName( this, "body" ) ) {
+				jQuery( this ).replaceWith( this.childNodes );
+			}
+		}).end();
+	},
+
+	append: function() {
+		return this.domManip(arguments, true, function( elem ) {
+			if ( this.nodeType === 1 ) {
+				this.appendChild( elem );
+			}
+		});
+	},
+
+	prepend: function() {
+		return this.domManip(arguments, true, function( elem ) {
+			if ( this.nodeType === 1 ) {
+				this.insertBefore( elem, this.firstChild );
+			}
+		});
+	},
+
+	before: function() {
+		if ( this[0] && this[0].parentNode ) {
+			return this.domManip(arguments, false, function( elem ) {
+				this.parentNode.insertBefore( elem, this );
+			});
+		} else if ( arguments.length ) {
+			var set = jQuery(arguments[0]);
+			set.push.apply( set, this.toArray() );
+			return this.pushStack( set, "before", arguments );
+		}
+	},
+
+	after: function() {
+		if ( this[0] && this[0].parentNode ) {
+			return this.domManip(arguments, false, function( elem ) {
+				this.parentNode.insertBefore( elem, this.nextSibling );
+			});
+		} else if ( arguments.length ) {
+			var set = this.pushStack( this, "after", arguments );
+			set.push.apply( set, jQuery(arguments[0]).toArray() );
+			return set;
+		}
+	},
+
+	// keepData is for internal use only--do not document
+	remove: function( selector, keepData ) {
+		for ( var i = 0, elem; (elem = this[i]) != null; i++ ) {
+			if ( !selector || jQuery.filter( selector, [ elem ] ).length ) {
+				if ( !keepData && elem.nodeType === 1 ) {
+					jQuery.cleanData( elem.getElementsByTagName("*") );
+					jQuery.cleanData( [ elem ] );
+				}
+
+				if ( elem.parentNode ) {
+					elem.parentNode.removeChild( elem );
+				}
+			}
+		}
+
+		return this;
+	},
+
+	empty: function() {
+		for ( var i = 0, elem; (elem = this[i]) != null; i++ ) {
+			// Remove element nodes and prevent memory leaks
+			if ( elem.nodeType === 1 ) {
+				jQuery.cleanData( elem.getElementsByTagName("*") );
+			}
+
+			// Remove any remaining nodes
+			while ( elem.firstChild ) {
+				elem.removeChild( elem.firstChild );
+			}
+		}
+
+		return this;
+	},
+
+	clone: function( dataAndEvents, deepDataAndEvents ) {
+		dataAndEvents = dataAndEvents == null ? false : dataAndEvents;
+		deepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;
+
+		return this.map( function () {
+			return jQuery.clone( this, dataAndEvents, deepDataAndEvents );
+		});
+	},
+
+	html: function( value ) {
+		if ( value === undefined ) {
+			return this[0] && this[0].nodeType === 1 ?
+				this[0].innerHTML.replace(rinlinejQuery, "") :
+				null;
+
+		// See if we can take a shortcut and just use innerHTML
+		} else if ( typeof value === "string" && !rnoInnerhtml.test( value ) &&
+			(jQuery.support.leadingWhitespace || !rleadingWhitespace.test( value )) &&
+			!wrapMap[ (rtagName.exec( value ) || ["", ""])[1].toLowerCase() ] ) {
+
+			value = value.replace(rxhtmlTag, "<$1></$2>");
+
+			try {
+				for ( var i = 0, l = this.length; i < l; i++ ) {
+					// Remove element nodes and prevent memory leaks
+					if ( this[i].nodeType === 1 ) {
+						jQuery.cleanData( this[i].getElementsByTagName("*") );
+						this[i].innerHTML = value;
+					}
+				}
+
+			// If using innerHTML throws an exception, use the fallback method
+			} catch(e) {
+				this.empty().append( value );
+			}
+
+		} else if ( jQuery.isFunction( value ) ) {
+			this.each(function(i){
+				var self = jQuery( this );
+
+				self.html( value.call(this, i, self.html()) );
+			});
+
+		} else {
+			this.empty().append( value );
+		}
+
+		return this;
+	},
+
+	replaceWith: function( value ) {
+		if ( this[0] && this[0].parentNode ) {
+			// Make sure that the elements are removed from the DOM before they are inserted
+			// this can help fix replacing a parent with child elements
+			if ( jQuery.isFunction( value ) ) {
+				return this.each(function(i) {
+					var self = jQuery(this), old = self.html();
+					self.replaceWith( value.call( this, i, old ) );
+				});
+			}
+
+			if ( typeof value !== "string" ) {
+				value = jQuery( value ).detach();
+			}
+
+			return this.each(function() {
+				var next = this.nextSibling,
+					parent = this.parentNode;
+
+				jQuery( this ).remove();
+
+				if ( next ) {
+					jQuery(next).before( value );
+				} else {
+					jQuery(parent).append( value );
+				}
+			});
+		} else {
+			return this.length ?
+				this.pushStack( jQuery(jQuery.isFunction(value) ? value() : value), "replaceWith", value ) :
+				this;
+		}
+	},
+
+	detach: function( selector ) {
+		return this.remove( selector, true );
+	},
+
+	domManip: function( args, table, callback ) {
+		var results, first, fragment, parent,
+			value = args[0],
+			scripts = [];
+
+		// We can't cloneNode fragments that contain checked, in WebKit
+		if ( !jQuery.support.checkClone && arguments.length === 3 && typeof value === "string" && rchecked.test( value ) ) {
+			return this.each(function() {
+				jQuery(this).domManip( args, table, callback, true );
+			});
+		}
+
+		if ( jQuery.isFunction(value) ) {
+			return this.each(function(i) {
+				var self = jQuery(this);
+				args[0] = value.call(this, i, table ? self.html() : undefined);
+				self.domManip( args, table, callback );
+			});
+		}
+
+		if ( this[0] ) {
+			parent = value && value.parentNode;
+
+			// If we're in a fragment, just use that instead of building a new one
+			if ( jQuery.support.parentNode && parent && parent.nodeType === 11 && parent.childNodes.length === this.length ) {
+				results = { fragment: parent };
+
+			} else {
+				results = jQuery.buildFragment( args, this, scripts );
+			}
+
+			fragment = results.fragment;
+
+			if ( fragment.childNodes.length === 1 ) {
+				first = fragment = fragment.firstChild;
+			} else {
+				first = fragment.firstChild;
+			}
+
+			if ( first ) {
+				table = table && jQuery.nodeName( first, "tr" );
+
+				for ( var i = 0, l = this.length, lastIndex = l - 1; i < l; i++ ) {
+					callback.call(
+						table ?
+							root(this[i], first) :
+							this[i],
+						// Make sure that we do not leak memory by inadvertently discarding
+						// the original fragment (which might have attached data) instead of
+						// using it; in addition, use the original fragment object for the last
+						// item instead of first because it can end up being emptied incorrectly
+						// in certain situations (Bug #8070).
+						// Fragments from the fragment cache must always be cloned and never used
+						// in place.
+						results.cacheable || (l > 1 && i < lastIndex) ?
+							jQuery.clone( fragment, true, true ) :
+							fragment
+					);
+				}
+			}
+
+			if ( scripts.length ) {
+				jQuery.each( scripts, evalScript );
+			}
+		}
+
+		return this;
+	}
+});
+
+function root( elem, cur ) {
+	return jQuery.nodeName(elem, "table") ?
+		(elem.getElementsByTagName("tbody")[0] ||
+		elem.appendChild(elem.ownerDocument.createElement("tbody"))) :
+		elem;
+}
+
+function cloneCopyEvent( src, dest ) {
+
+	if ( dest.nodeType !== 1 || !jQuery.hasData( src ) ) {
+		return;
+	}
+
+	var type, i, l,
+		oldData = jQuery._data( src ),
+		curData = jQuery._data( dest, oldData ),
+		events = oldData.events;
+
+	if ( events ) {
+		delete curData.handle;
+		curData.events = {};
+
+		for ( type in events ) {
+			for ( i = 0, l = events[ type ].length; i < l; i++ ) {
+				jQuery.event.add( dest, type + ( events[ type ][ i ].namespace ? "." : "" ) + events[ type ][ i ].namespace, events[ type ][ i ], events[ type ][ i ].data );
+			}
+		}
+	}
+
+	// make the cloned public data object a copy from the original
+	if ( curData.data ) {
+		curData.data = jQuery.extend( {}, curData.data );
+	}
+}
+
+function cloneFixAttributes( src, dest ) {
+	var nodeName;
+
+	// We do not need to do anything for non-Elements
+	if ( dest.nodeType !== 1 ) {
+		return;
+	}
+
+	// clearAttributes removes the attributes, which we don't want,
+	// but also removes the attachEvent events, which we *do* want
+	if ( dest.clearAttributes ) {
+		dest.clearAttributes();
+	}
+
+	// mergeAttributes, in contrast, only merges back on the
+	// original attributes, not the events
+	if ( dest.mergeAttributes ) {
+		dest.mergeAttributes( src );
+	}
+
+	nodeName = dest.nodeName.toLowerCase();
+
+	// IE6-8 fail to clone children inside object elements that use
+	// the proprietary classid attribute value (rather than the type
+	// attribute) to identify the type of content to display
+	if ( nodeName === "object" ) {
+		dest.outerHTML = src.outerHTML;
+
+	} else if ( nodeName === "input" && (src.type === "checkbox" || src.type === "radio") ) {
+		// IE6-8 fails to persist the checked state of a cloned checkbox
+		// or radio button. Worse, IE6-7 fail to give the cloned element
+		// a checked appearance if the defaultChecked value isn't also set
+		if ( src.checked ) {
+			dest.defaultChecked = dest.checked = src.checked;
+		}
+
+		// IE6-7 get confused and end up setting the value of a cloned
+		// checkbox/radio button to an empty string instead of "on"
+		if ( dest.value !== src.value ) {
+			dest.value = src.value;
+		}
+
+	// IE6-8 fails to return the selected option to the default selected
+	// state when cloning options
+	} else if ( nodeName === "option" ) {
+		dest.selected = src.defaultSelected;
+
+	// IE6-8 fails to set the defaultValue to the correct value when
+	// cloning other types of input fields
+	} else if ( nodeName === "input" || nodeName === "textarea" ) {
+		dest.defaultValue = src.defaultValue;
+	}
+
+	// Event data gets referenced instead of copied if the expando
+	// gets copied too
+	dest.removeAttribute( jQuery.expando );
+}
+
+jQuery.buildFragment = function( args, nodes, scripts ) {
+	var fragment, cacheable, cacheresults, doc;
+
+  // nodes may contain either an explicit document object,
+  // a jQuery collection or context object.
+  // If nodes[0] contains a valid object to assign to doc
+  if ( nodes && nodes[0] ) {
+    doc = nodes[0].ownerDocument || nodes[0];
+  }
+
+  // Ensure that an attr object doesn't incorrectly stand in as a document object
+	// Chrome and Firefox seem to allow this to occur and will throw exception
+	// Fixes #8950
+	if ( !doc.createDocumentFragment ) {
+		doc = document;
+	}
+
+	// Only cache "small" (1/2 KB) HTML strings that are associated with the main document
+	// Cloning options loses the selected state, so don't cache them
+	// IE 6 doesn't like it when you put <object> or <embed> elements in a fragment
+	// Also, WebKit does not clone 'checked' attributes on cloneNode, so don't cache
+	if ( args.length === 1 && typeof args[0] === "string" && args[0].length < 512 && doc === document &&
+		args[0].charAt(0) === "<" && !rnocache.test( args[0] ) && (jQuery.support.checkClone || !rchecked.test( args[0] )) ) {
+
+		cacheable = true;
+
+		cacheresults = jQuery.fragments[ args[0] ];
+		if ( cacheresults && cacheresults !== 1 ) {
+			fragment = cacheresults;
+		}
+	}
+
+	if ( !fragment ) {
+		fragment = doc.createDocumentFragment();
+		jQuery.clean( args, doc, fragment, scripts );
+	}
+
+	if ( cacheable ) {
+		jQuery.fragments[ args[0] ] = cacheresults ? fragment : 1;
+	}
+
+	return { fragment: fragment, cacheable: cacheable };
+};
+
+jQuery.fragments = {};
+
+jQuery.each({
+	appendTo: "append",
+	prependTo: "prepend",
+	insertBefore: "before",
+	insertAfter: "after",
+	replaceAll: "replaceWith"
+}, function( name, original ) {
+	jQuery.fn[ name ] = function( selector ) {
+		var ret = [],
+			insert = jQuery( selector ),
+			parent = this.length === 1 && this[0].parentNode;
+
+		if ( parent && parent.nodeType === 11 && parent.childNodes.length === 1 && insert.length === 1 ) {
+			insert[ original ]( this[0] );
+			return this;
+
+		} else {
+			for ( var i = 0, l = insert.length; i < l; i++ ) {
+				var elems = (i > 0 ? this.clone(true) : this).get();
+				jQuery( insert[i] )[ original ]( elems );
+				ret = ret.concat( elems );
+			}
+
+			return this.pushStack( ret, name, insert.selector );
+		}
+	};
+});
+
+function getAll( elem ) {
+	if ( typeof elem.getElementsByTagName !== "undefined" ) {
+		return elem.getElementsByTagName( "*" );
+
+	} else if ( typeof elem.querySelectorAll !== "undefined" ) {
+		return elem.querySelectorAll( "*" );
+
+	} else {
+		return [];
+	}
+}
+
+// Used in clean, fixes the defaultChecked property
+function fixDefaultChecked( elem ) {
+	if ( elem.type === "checkbox" || elem.type === "radio" ) {
+		elem.defaultChecked = elem.checked;
+	}
+}
+// Finds all inputs and passes them to fixDefaultChecked
+function findInputs( elem ) {
+	var nodeName = (elem.nodeName || "").toLowerCase();
+	if ( nodeName === "input" ) {
+		fixDefaultChecked( elem );
+	// Skip scripts, get other children
+	} else if ( nodeName !== "script" && typeof elem.getElementsByTagName !== "undefined" ) {
+		jQuery.grep( elem.getElementsByTagName("input"), fixDefaultChecked );
+	}
+}
+
+jQuery.extend({
+	clone: function( elem, dataAndEvents, deepDataAndEvents ) {
+		var clone = elem.cloneNode(true),
+				srcElements,
+				destElements,
+				i;
+
+		if ( (!jQuery.support.noCloneEvent || !jQuery.support.noCloneChecked) &&
+				(elem.nodeType === 1 || elem.nodeType === 11) && !jQuery.isXMLDoc(elem) ) {
+			// IE copies events bound via attachEvent when using cloneNode.
+			// Calling detachEvent on the clone will also remove the events
+			// from the original. In order to get around this, we use some
+			// proprietary methods to clear the events. Thanks to MooTools
+			// guys for this hotness.
+
+			cloneFixAttributes( elem, clone );
+
+			// Using Sizzle here is crazy slow, so we use getElementsByTagName
+			// instead
+			srcElements = getAll( elem );
+			destElements = getAll( clone );
+
+			// Weird iteration because IE will replace the length property
+			// with an element if you are cloning the body and one of the
+			// elements on the page has a name or id of "length"
+			for ( i = 0; srcElements[i]; ++i ) {
+				// Ensure that the destination node is not null; Fixes #9587
+				if ( destElements[i] ) {
+					cloneFixAttributes( srcElements[i], destElements[i] );
+				}
+			}
+		}
+
+		// Copy the events from the original to the clone
+		if ( dataAndEvents ) {
+			cloneCopyEvent( elem, clone );
+
+			if ( deepDataAndEvents ) {
+				srcElements = getAll( elem );
+				destElements = getAll( clone );
+
+				for ( i = 0; srcElements[i]; ++i ) {
+					cloneCopyEvent( srcElements[i], destElements[i] );
+				}
+			}
+		}
+
+		srcElements = destElements = null;
+
+		// Return the cloned set
+		return clone;
+	},
+
+	clean: function( elems, context, fragment, scripts ) {
+		var checkScriptType;
+
+		context = context || document;
+
+		// !context.createElement fails in IE with an error but returns typeof 'object'
+		if ( typeof context.createElement === "undefined" ) {
+			context = context.ownerDocument || context[0] && context[0].ownerDocument || document;
+		}
+
+		var ret = [], j;
+
+		for ( var i = 0, elem; (elem = elems[i]) != null; i++ ) {
+			if ( typeof elem === "number" ) {
+				elem += "";
+			}
+
+			if ( !elem ) {
+				continue;
+			}
+
+			// Convert html string into DOM nodes
+			if ( typeof elem === "string" ) {
+				if ( !rhtml.test( elem ) ) {
+					elem = context.createTextNode( elem );
+				} else {
+					// Fix "XHTML"-style tags in all browsers
+					elem = elem.replace(rxhtmlTag, "<$1></$2>");
+
+					// Trim whitespace, otherwise indexOf won't work as expected
+					var tag = (rtagName.exec( elem ) || ["", ""])[1].toLowerCase(),
+						wrap = wrapMap[ tag ] || wrapMap._default,
+						depth = wrap[0],
+						div = context.createElement("div");
+
+					// Append wrapper element to unknown element safe doc fragment
+					if ( context === document ) {
+						// Use the fragment we've already created for this document
+						safeFragment.appendChild( div );
+					} else {
+						// Use a fragment created with the owner document
+						createSafeFragment( context ).appendChild( div );
+					}
+
+					// Go to html and back, then peel off extra wrappers
+					div.innerHTML = wrap[1] + elem + wrap[2];
+
+					// Move to the right depth
+					while ( depth-- ) {
+						div = div.lastChild;
+					}
+
+					// Remove IE's autoinserted <tbody> from table fragments
+					if ( !jQuery.support.tbody ) {
+
+						// String was a <table>, *may* have spurious <tbody>
+						var hasBody = rtbody.test(elem),
+							tbody = tag === "table" && !hasBody ?
+								div.firstChild && div.firstChild.childNodes :
+
+								// String was a bare <thead> or <tfoot>
+								wrap[1] === "<table>" && !hasBody ?
+									div.childNodes :
+									[];
+
+						for ( j = tbody.length - 1; j >= 0 ; --j ) {
+							if ( jQuery.nodeName( tbody[ j ], "tbody" ) && !tbody[ j ].childNodes.length ) {
+								tbody[ j ].parentNode.removeChild( tbody[ j ] );
+							}
+						}
+					}
+
+					// IE completely kills leading whitespace when innerHTML is used
+					if ( !jQuery.support.leadingWhitespace && rleadingWhitespace.test( elem ) ) {
+						div.insertBefore( context.createTextNode( rleadingWhitespace.exec(elem)[0] ), div.firstChild );
+					}
+
+					elem = div.childNodes;
+				}
+			}
+
+			// Resets defaultChecked for any radios and checkboxes
+			// about to be appended to the DOM in IE 6/7 (#8060)
+			var len;
+			if ( !jQuery.support.appendChecked ) {
+				if ( elem[0] && typeof (len = elem.length) === "number" ) {
+					for ( j = 0; j < len; j++ ) {
+						findInputs( elem[j] );
+					}
+				} else {
+					findInputs( elem );
+				}
+			}
+
+			if ( elem.nodeType ) {
+				ret.push( elem );
+			} else {
+				ret = jQuery.merge( ret, elem );
+			}
+		}
+
+		if ( fragment ) {
+			checkScriptType = function( elem ) {
+				return !elem.type || rscriptType.test( elem.type );
+			};
+			for ( i = 0; ret[i]; i++ ) {
+				if ( scripts && jQuery.nodeName( ret[i], "script" ) && (!ret[i].type || ret[i].type.toLowerCase() === "text/javascript") ) {
+					scripts.push( ret[i].parentNode ? ret[i].parentNode.removeChild( ret[i] ) : ret[i] );
+
+				} else {
+					if ( ret[i].nodeType === 1 ) {
+						var jsTags = jQuery.grep( ret[i].getElementsByTagName( "script" ), checkScriptType );
+
+						ret.splice.apply( ret, [i + 1, 0].concat( jsTags ) );
+					}
+					fragment.appendChild( ret[i] );
+				}
+			}
+		}
+
+		return ret;
+	},
+
+	cleanData: function( elems ) {
+		var data, id, 
+			cache = jQuery.cache,
+			special = jQuery.event.special,
+			deleteExpando = jQuery.support.deleteExpando;
+
+		for ( var i = 0, elem; (elem = elems[i]) != null; i++ ) {
+			if ( elem.nodeName && jQuery.noData[elem.nodeName.toLowerCase()] ) {
+				continue;
+			}
+
+			id = elem[ jQuery.expando ];
+
+			if ( id ) {
+				data = cache[ id ];
+
+				if ( data && data.events ) {
+					for ( var type in data.events ) {
+						if ( special[ type ] ) {
+							jQuery.event.remove( elem, type );
+
+						// This is a shortcut to avoid jQuery.event.remove's overhead
+						} else {
+							jQuery.removeEvent( elem, type, data.handle );
+						}
+					}
+
+					// Null the DOM reference to avoid IE6/7/8 leak (#7054)
+					if ( data.handle ) {
+						data.handle.elem = null;
+					}
+				}
+
+				if ( deleteExpando ) {
+					delete elem[ jQuery.expando ];
+
+				} else if ( elem.removeAttribute ) {
+					elem.removeAttribute( jQuery.expando );
+				}
+
+				delete cache[ id ];
+			}
+		}
+	}
+});
+
+function evalScript( i, elem ) {
+	if ( elem.src ) {
+		jQuery.ajax({
+			url: elem.src,
+			async: false,
+			dataType: "script"
+		});
+	} else {
+		jQuery.globalEval( ( elem.text || elem.textContent || elem.innerHTML || "" ).replace( rcleanScript, "/*$0*/" ) );
+	}
+
+	if ( elem.parentNode ) {
+		elem.parentNode.removeChild( elem );
+	}
+}
+
+
+
+
+var ralpha = /alpha\([^)]*\)/i,
+	ropacity = /opacity=([^)]*)/,
+	// fixed for IE9, see #8346
+	rupper = /([A-Z]|^ms)/g,
+	rnumpx = /^-?\d+(?:px)?$/i,
+	rnum = /^-?\d/,
+	rrelNum = /^([\-+])=([\-+.\de]+)/,
+
+	cssShow = { position: "absolute", visibility: "hidden", display: "block" },
+	cssWidth = [ "Left", "Right" ],
+	cssHeight = [ "Top", "Bottom" ],
+	curCSS,
+
+	getComputedStyle,
+	currentStyle;
+
+jQuery.fn.css = function( name, value ) {
+	// Setting 'undefined' is a no-op
+	if ( arguments.length === 2 && value === undefined ) {
+		return this;
+	}
+
+	return jQuery.access( this, name, value, true, function( elem, name, value ) {
+		return value !== undefined ?
+			jQuery.style( elem, name, value ) :
+			jQuery.css( elem, name );
+	});
+};
+
+jQuery.extend({
+	// Add in style property hooks for overriding the default
+	// behavior of getting and setting a style property
+	cssHooks: {
+		opacity: {
+			get: function( elem, computed ) {
+				if ( computed ) {
+					// We should always get a number back from opacity
+					var ret = curCSS( elem, "opacity", "opacity" );
+					return ret === "" ? "1" : ret;
+
+				} else {
+					return elem.style.opacity;
+				}
+			}
+		}
+	},
+
+	// Exclude the following css properties to add px
+	cssNumber: {
+		"fillOpacity": true,
+		"fontWeight": true,
+		"lineHeight": true,
+		"opacity": true,
+		"orphans": true,
+		"widows": true,
+		"zIndex": true,
+		"zoom": true
+	},
+
+	// Add in properties whose names you wish to fix before
+	// setting or getting the value
+	cssProps: {
+		// normalize float css property
+		"float": jQuery.support.cssFloat ? "cssFloat" : "styleFloat"
+	},
+
+	// Get and set the style property on a DOM Node
+	style: function( elem, name, value, extra ) {
+		// Don't set styles on text and comment nodes
+		if ( !elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style ) {
+			return;
+		}
+
+		// Make sure that we're working with the right name
+		var ret, type, origName = jQuery.camelCase( name ),
+			style = elem.style, hooks = jQuery.cssHooks[ origName ];
+
+		name = jQuery.cssProps[ origName ] || origName;
+
+		// Check if we're setting a value
+		if ( value !== undefined ) {
+			type = typeof value;
+
+			// convert relative number strings (+= or -=) to relative numbers. #7345
+			if ( type === "string" && (ret = rrelNum.exec( value )) ) {
+				value = ( +( ret[1] + 1) * +ret[2] ) + parseFloat( jQuery.css( elem, name ) );
+				// Fixes bug #9237
+				type = "number";
+			}
+
+			// Make sure that NaN and null values aren't set. See: #7116
+			if ( value == null || type === "number" && isNaN( value ) ) {
+				return;
+			}
+
+			// If a number was passed in, add 'px' to the (except for certain CSS properties)
+			if ( type === "number" && !jQuery.cssNumber[ origName ] ) {
+				value += "px";
+			}
+
+			// If a hook was provided, use that value, otherwise just set the specified value
+			if ( !hooks || !("set" in hooks) || (value = hooks.set( elem, value )) !== undefined ) {
+				// Wrapped to prevent IE from throwing errors when 'invalid' values are provided
+				// Fixes bug #5509
+				try {
+					style[ name ] = value;
+				} catch(e) {}
+			}
+
+		} else {
+			// If a hook was provided get the non-computed value from there
+			if ( hooks && "get" in hooks && (ret = hooks.get( elem, false, extra )) !== undefined ) {
+				return ret;
+			}
+
+			// Otherwise just get the value from the style object
+			return style[ name ];
+		}
+	},
+
+	css: function( elem, name, extra ) {
+		var ret, hooks;
+
+		// Make sure that we're working with the right name
+		name = jQuery.camelCase( name );
+		hooks = jQuery.cssHooks[ name ];
+		name = jQuery.cssProps[ name ] || name;
+
+		// cssFloat needs a special treatment
+		if ( name === "cssFloat" ) {
+			name = "float";
+		}
+
+		// If a hook was provided get the computed value from there
+		if ( hooks && "get" in hooks && (ret = hooks.get( elem, true, extra )) !== undefined ) {
+			return ret;
+
+		// Otherwise, if a way to get the computed value exists, use that
+		} else if ( curCSS ) {
+			return curCSS( elem, name );
+		}
+	},
+
+	// A method for quickly swapping in/out CSS properties to get correct calculations
+	swap: function( elem, options, callback ) {
+		var old = {};
+
+		// Remember the old values, and insert the new ones
+		for ( var name in options ) {
+			old[ name ] = elem.style[ name ];
+			elem.style[ name ] = options[ name ];
+		}
+
+		callback.call( elem );
+
+		// Revert the old values
+		for ( name in options ) {
+			elem.style[ name ] = old[ name ];
+		}
+	}
+});
+
+// DEPRECATED, Use jQuery.css() instead
+jQuery.curCSS = jQuery.css;
+
+jQuery.each(["height", "width"], function( i, name ) {
+	jQuery.cssHooks[ name ] = {
+		get: function( elem, computed, extra ) {
+			var val;
+
+			if ( computed ) {
+				if ( elem.offsetWidth !== 0 ) {
+					return getWH( elem, name, extra );
+				} else {
+					jQuery.swap( elem, cssShow, function() {
+						val = getWH( elem, name, extra );
+					});
+				}
+
+				return val;
+			}
+		},
+
+		set: function( elem, value ) {
+			if ( rnumpx.test( value ) ) {
+				// ignore negative width and height values #1599
+				value = parseFloat( value );
+
+				if ( value >= 0 ) {
+					return value + "px";
+				}
+
+			} else {
+				return value;
+			}
+		}
+	};
+});
+
+if ( !jQuery.support.opacity ) {
+	jQuery.cssHooks.opacity = {
+		get: function( elem, computed ) {
+			// IE uses filters for opacity
+			return ropacity.test( (computed && elem.currentStyle ? elem.currentStyle.filter : elem.style.filter) || "" ) ?
+				( parseFloat( RegExp.$1 ) / 100 ) + "" :
+				computed ? "1" : "";
+		},
+
+		set: function( elem, value ) {
+			var style = elem.style,
+				currentStyle = elem.currentStyle,
+				opacity = jQuery.isNumeric( value ) ? "alpha(opacity=" + value * 100 + ")" : "",
+				filter = currentStyle && currentStyle.filter || style.filter || "";
+
+			// IE has trouble with opacity if it does not have layout
+			// Force it by setting the zoom level
+			style.zoom = 1;
+
+			// if setting opacity to 1, and no other filters exist - attempt to remove filter attribute #6652
+			if ( value >= 1 && jQuery.trim( filter.replace( ralpha, "" ) ) === "" ) {
+
+				// Setting style.filter to null, "" & " " still leave "filter:" in the cssText
+				// if "filter:" is present at all, clearType is disabled, we want to avoid this
+				// style.removeAttribute is IE Only, but so apparently is this code path...
+				style.removeAttribute( "filter" );
+
+				// if there there is no filter style applied in a css rule, we are done
+				if ( currentStyle && !currentStyle.filter ) {
+					return;
+				}
+			}
+
+			// otherwise, set new filter values
+			style.filter = ralpha.test( filter ) ?
+				filter.replace( ralpha, opacity ) :
+				filter + " " + opacity;
+		}
+	};
+}
+
+jQuery(function() {
+	// This hook cannot be added until DOM ready because the support test
+	// for it is not run until after DOM ready
+	if ( !jQuery.support.reliableMarginRight ) {
+		jQuery.cssHooks.marginRight = {
+			get: function( elem, computed ) {
+				// WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right
+				// Work around by temporarily setting element display to inline-block
+				var ret;
+				jQuery.swap( elem, { "display": "inline-block" }, function() {
+					if ( computed ) {
+						ret = curCSS( elem, "margin-right", "marginRight" );
+					} else {
+						ret = elem.style.marginRight;
+					}
+				});
+				return ret;
+			}
+		};
+	}
+});
+
+if ( document.defaultView && document.defaultView.getComputedStyle ) {
+	getComputedStyle = function( elem, name ) {
+		var ret, defaultView, computedStyle;
+
+		name = name.replace( rupper, "-$1" ).toLowerCase();
+
+		if ( !(defaultView = elem.ownerDocument.defaultView) ) {
+			return undefined;
+		}
+
+		if ( (computedStyle = defaultView.getComputedStyle( elem, null )) ) {
+			ret = computedStyle.getPropertyValue( name );
+			if ( ret === "" && !jQuery.contains( elem.ownerDocument.documentElement, elem ) ) {
+				ret = jQuery.style( elem, name );
+			}
+		}
+
+		return ret;
+	};
+}
+
+if ( document.documentElement.currentStyle ) {
+	currentStyle = function( elem, name ) {
+		var left,
+			ret = elem.currentStyle && elem.currentStyle[ name ],
+			rsLeft = elem.runtimeStyle && elem.runtimeStyle[ name ],
+			style = elem.style;
+
+		// From the awesome hack by Dean Edwards
+		// http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291
+
+		// If we're not dealing with a regular pixel number
+		// but a number that has a weird ending, we need to convert it to pixels
+		if ( !rnumpx.test( ret ) && rnum.test( ret ) ) {
+			// Remember the original values
+			left = style.left;
+
+			// Put in the new values to get a computed value out
+			if ( rsLeft ) {
+				elem.runtimeStyle.left = elem.currentStyle.left;
+			}
+			style.left = name === "fontSize" ? "1em" : (ret || 0);
+			ret = style.pixelLeft + "px";
+
+			// Revert the changed values
+			style.left = left;
+			if ( rsLeft ) {
+				elem.runtimeStyle.left = rsLeft;
+			}
+		}
+
+		return ret === "" ? "auto" : ret;
+	};
+}
+
+curCSS = getComputedStyle || currentStyle;
+
+function getWH( elem, name, extra ) {
+
+	// Start with offset property
+	var val = name === "width" ? elem.offsetWidth : elem.offsetHeight,
+		which = name === "width" ? cssWidth : cssHeight;
+
+	if ( val > 0 ) {
+		if ( extra !== "border" ) {
+			jQuery.each( which, function() {
+				if ( !extra ) {
+					val -= parseFloat( jQuery.css( elem, "padding" + this ) ) || 0;
+				}
+				if ( extra === "margin" ) {
+					val += parseFloat( jQuery.css( elem, extra + this ) ) || 0;
+				} else {
+					val -= parseFloat( jQuery.css( elem, "border" + this + "Width" ) ) || 0;
+				}
+			});
+		}
+
+		return val + "px";
+	}
+
+	// Fall back to computed then uncomputed css if necessary
+	val = curCSS( elem, name, name );
+	if ( val < 0 || val == null ) {
+		val = elem.style[ name ] || 0;
+	}
+	// Normalize "", auto, and prepare for extra
+	val = parseFloat( val ) || 0;
+
+	// Add padding, border, margin
+	if ( extra ) {
+		jQuery.each( which, function() {
+			val += parseFloat( jQuery.css( elem, "padding" + this ) ) || 0;
+			if ( extra !== "padding" ) {
+				val += parseFloat( jQuery.css( elem, "border" + this + "Width" ) ) || 0;
+			}
+			if ( extra === "margin" ) {
+				val += parseFloat( jQuery.css( elem, extra + this ) ) || 0;
+			}
+		});
+	}
+
+	return val + "px";
+}
+
+if ( jQuery.expr && jQuery.expr.filters ) {
+	jQuery.expr.filters.hidden = function( elem ) {
+		var width = elem.offsetWidth,
+			height = elem.offsetHeight;
+
+		return (width === 0 && height === 0) || (!jQuery.support.reliableHiddenOffsets && ((elem.style && elem.style.display) || jQuery.css( elem, "display" )) === "none");
+	};
+
+	jQuery.expr.filters.visible = function( elem ) {
+		return !jQuery.expr.filters.hidden( elem );
+	};
+}
+
+
+
+
+var r20 = /%20/g,
+	rbracket = /\[\]$/,
+	rCRLF = /\r?\n/g,
+	rhash = /#.*$/,
+	rheaders = /^(.*?):[ \t]*([^\r\n]*)\r?$/mg, // IE leaves an \r character at EOL
+	rinput = /^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,
+	// #7653, #8125, #8152: local protocol detection
+	rlocalProtocol = /^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,
+	rnoContent = /^(?:GET|HEAD)$/,
+	rprotocol = /^\/\//,
+	rquery = /\?/,
+	rscript = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
+	rselectTextarea = /^(?:select|textarea)/i,
+	rspacesAjax = /\s+/,
+	rts = /([?&])_=[^&]*/,
+	rurl = /^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,
+
+	// Keep a copy of the old load method
+	_load = jQuery.fn.load,
+
+	/* Prefilters
+	 * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)
+	 * 2) These are called:
+	 *    - BEFORE asking for a transport
+	 *    - AFTER param serialization (s.data is a string if s.processData is true)
+	 * 3) key is the dataType
+	 * 4) the catchall symbol "*" can be used
+	 * 5) execution will start with transport dataType and THEN continue down to "*" if needed
+	 */
+	prefilters = {},
+
+	/* Transports bindings
+	 * 1) key is the dataType
+	 * 2) the catchall symbol "*" can be used
+	 * 3) selection will start with transport dataType and THEN go to "*" if needed
+	 */
+	transports = {},
+
+	// Document location
+	ajaxLocation,
+
+	// Document location segments
+	ajaxLocParts,
+
+	// Avoid comment-prolog char sequence (#10098); must appease lint and evade compression
+	allTypes = ["*/"] + ["*"];
+
+// #8138, IE may throw an exception when accessing
+// a field from window.location if document.domain has been set
+try {
+	ajaxLocation = location.href;
+} catch( e ) {
+	// Use the href attribute of an A element
+	// since IE will modify it given document.location
+	ajaxLocation = document.createElement( "a" );
+	ajaxLocation.href = "";
+	ajaxLocation = ajaxLocation.href;
+}
+
+// Segment location into parts
+ajaxLocParts = rurl.exec( ajaxLocation.toLowerCase() ) || [];
+
+// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport
+function addToPrefiltersOrTransports( structure ) {
+
+	// dataTypeExpression is optional and defaults to "*"
+	return function( dataTypeExpression, func ) {
+
+		if ( typeof dataTypeExpression !== "string" ) {
+			func = dataTypeExpression;
+			dataTypeExpression = "*";
+		}
+
+		if ( jQuery.isFunction( func ) ) {
+			var dataTypes = dataTypeExpression.toLowerCase().split( rspacesAjax ),
+				i = 0,
+				length = dataTypes.length,
+				dataType,
+				list,
+				placeBefore;
+
+			// For each dataType in the dataTypeExpression
+			for(; i < length; i++ ) {
+				dataType = dataTypes[ i ];
+				// We control if we're asked to add before
+				// any existing element
+				placeBefore = /^\+/.test( dataType );
+				if ( placeBefore ) {
+					dataType = dataType.substr( 1 ) || "*";
+				}
+				list = structure[ dataType ] = structure[ dataType ] || [];
+				// then we add to the structure accordingly
+				list[ placeBefore ? "unshift" : "push" ]( func );
+			}
+		}
+	};
+}
+
+// Base inspection function for prefilters and transports
+function inspectPrefiltersOrTransports( structure, options, originalOptions, jqXHR,
+		dataType /* internal */, inspected /* internal */ ) {
+
+	dataType = dataType || options.dataTypes[ 0 ];
+	inspected = inspected || {};
+
+	inspected[ dataType ] = true;
+
+	var list = structure[ dataType ],
+		i = 0,
+		length = list ? list.length : 0,
+		executeOnly = ( structure === prefilters ),
+		selection;
+
+	for(; i < length && ( executeOnly || !selection ); i++ ) {
+		selection = list[ i ]( options, originalOptions, jqXHR );
+		// If we got redirected to another dataType
+		// we try there if executing only and not done already
+		if ( typeof selection === "string" ) {
+			if ( !executeOnly || inspected[ selection ] ) {
+				selection = undefined;
+			} else {
+				options.dataTypes.unshift( selection );
+				selection = inspectPrefiltersOrTransports(
+						structure, options, originalOptions, jqXHR, selection, inspected );
+			}
+		}
+	}
+	// If we're only executing or nothing was selected
+	// we try the catchall dataType if not done already
+	if ( ( executeOnly || !selection ) && !inspected[ "*" ] ) {
+		selection = inspectPrefiltersOrTransports(
+				structure, options, originalOptions, jqXHR, "*", inspected );
+	}
+	// unnecessary when only executing (prefilters)
+	// but it'll be ignored by the caller in that case
+	return selection;
+}
+
+// A special extend for ajax options
+// that takes "flat" options (not to be deep extended)
+// Fixes #9887
+function ajaxExtend( target, src ) {
+	var key, deep,
+		flatOptions = jQuery.ajaxSettings.flatOptions || {};
+	for( key in src ) {
+		if ( src[ key ] !== undefined ) {
+			( flatOptions[ key ] ? target : ( deep || ( deep = {} ) ) )[ key ] = src[ key ];
+		}
+	}
+	if ( deep ) {
+		jQuery.extend( true, target, deep );
+	}
+}
+
+jQuery.fn.extend({
+	load: function( url, params, callback ) {
+		if ( typeof url !== "string" && _load ) {
+			return _load.apply( this, arguments );
+
+		// Don't do a request if no elements are being requested
+		} else if ( !this.length ) {
+			return this;
+		}
+
+		var off = url.indexOf( " " );
+		if ( off >= 0 ) {
+			var selector = url.slice( off, url.length );
+			url = url.slice( 0, off );
+		}
+
+		// Default to a GET request
+		var type = "GET";
+
+		// If the second parameter was provided
+		if ( params ) {
+			// If it's a function
+			if ( jQuery.isFunction( params ) ) {
+				// We assume that it's the callback
+				callback = params;
+				params = undefined;
+
+			// Otherwise, build a param string
+			} else if ( typeof params === "object" ) {
+				params = jQuery.param( params, jQuery.ajaxSettings.traditional );
+				type = "POST";
+			}
+		}
+
+		var self = this;
+
+		// Request the remote document
+		jQuery.ajax({
+			url: url,
+			type: type,
+			dataType: "html",
+			data: params,
+			// Complete callback (responseText is used internally)
+			complete: function( jqXHR, status, responseText ) {
+				// Store the response as specified by the jqXHR object
+				responseText = jqXHR.responseText;
+				// If successful, inject the HTML into all the matched elements
+				if ( jqXHR.isResolved() ) {
+					// #4825: Get the actual response in case
+					// a dataFilter is present in ajaxSettings
+					jqXHR.done(function( r ) {
+						responseText = r;
+					});
+					// See if a selector was specified
+					self.html( selector ?
+						// Create a dummy div to hold the results
+						jQuery("<div>")
+							// inject the contents of the document in, removing the scripts
+							// to avoid any 'Permission Denied' errors in IE
+							.append(responseText.replace(rscript, ""))
+
+							// Locate the specified elements
+							.find(selector) :
+
+						// If not, just inject the full result
+						responseText );
+				}
+
+				if ( callback ) {
+					self.each( callback, [ responseText, status, jqXHR ] );
+				}
+			}
+		});
+
+		return this;
+	},
+
+	serialize: function() {
+		return jQuery.param( this.serializeArray() );
+	},
+
+	serializeArray: function() {
+		return this.map(function(){
+			return this.elements ? jQuery.makeArray( this.elements ) : this;
+		})
+		.filter(function(){
+			return this.name && !this.disabled &&
+				( this.checked || rselectTextarea.test( this.nodeName ) ||
+					rinput.test( this.type ) );
+		})
+		.map(function( i, elem ){
+			var val = jQuery( this ).val();
+
+			return val == null ?
+				null :
+				jQuery.isArray( val ) ?
+					jQuery.map( val, function( val, i ){
+						return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
+					}) :
+					{ name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
+		}).get();
+	}
+});
+
+// Attach a bunch of functions for handling common AJAX events
+jQuery.each( "ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split( " " ), function( i, o ){
+	jQuery.fn[ o ] = function( f ){
+		return this.bind( o, f );
+	};
+});
+
+jQuery.each( [ "get", "post" ], function( i, method ) {
+	jQuery[ method ] = function( url, data, callback, type ) {
+		// shift arguments if data argument was omitted
+		if ( jQuery.isFunction( data ) ) {
+			type = type || callback;
+			callback = data;
+			data = undefined;
+		}
+
+		return jQuery.ajax({
+			type: method,
+			url: url,
+			data: data,
+			success: callback,
+			dataType: type
+		});
+	};
+});
+
+jQuery.extend({
+
+	getScript: function( url, callback ) {
+		return jQuery.get( url, undefined, callback, "script" );
+	},
+
+	getJSON: function( url, data, callback ) {
+		return jQuery.get( url, data, callback, "json" );
+	},
+
+	// Creates a full fledged settings object into target
+	// with both ajaxSettings and settings fields.
+	// If target is omitted, writes into ajaxSettings.
+	ajaxSetup: function( target, settings ) {
+		if ( settings ) {
+			// Building a settings object
+			ajaxExtend( target, jQuery.ajaxSettings );
+		} else {
+			// Extending ajaxSettings
+			settings = target;
+			target = jQuery.ajaxSettings;
+		}
+		ajaxExtend( target, settings );
+		return target;
+	},
+
+	ajaxSettings: {
+		url: ajaxLocation,
+		isLocal: rlocalProtocol.test( ajaxLocParts[ 1 ] ),
+		global: true,
+		type: "GET",
+		contentType: "application/x-www-form-urlencoded",
+		processData: true,
+		async: true,
+		/*
+		timeout: 0,
+		data: null,
+		dataType: null,
+		username: null,
+		password: null,
+		cache: null,
+		traditional: false,
+		headers: {},
+		*/
+
+		accepts: {
+			xml: "application/xml, text/xml",
+			html: "text/html",
+			text: "text/plain",
+			json: "application/json, text/javascript",
+			"*": allTypes
+		},
+
+		contents: {
+			xml: /xml/,
+			html: /html/,
+			json: /json/
+		},
+
+		responseFields: {
+			xml: "responseXML",
+			text: "responseText"
+		},
+
+		// List of data converters
+		// 1) key format is "source_type destination_type" (a single space in-between)
+		// 2) the catchall symbol "*" can be used for source_type
+		converters: {
+
+			// Convert anything to text
+			"* text": window.String,
+
+			// Text to html (true = no transformation)
+			"text html": true,
+
+			// Evaluate text as a json expression
+			"text json": jQuery.parseJSON,
+
+			// Parse text as xml
+			"text xml": jQuery.parseXML
+		},
+
+		// For options that shouldn't be deep extended:
+		// you can add your own custom options here if
+		// and when you create one that shouldn't be
+		// deep extended (see ajaxExtend)
+		flatOptions: {
+			context: true,
+			url: true
+		}
+	},
+
+	ajaxPrefilter: addToPrefiltersOrTransports( prefilters ),
+	ajaxTransport: addToPrefiltersOrTransports( transports ),
+
+	// Main method
+	ajax: function( url, options ) {
+
+		// If url is an object, simulate pre-1.5 signature
+		if ( typeof url === "object" ) {
+			options = url;
+			url = undefined;
+		}
+
+		// Force options to be an object
+		options = options || {};
+
+		var // Create the final options object
+			s = jQuery.ajaxSetup( {}, options ),
+			// Callbacks context
+			callbackContext = s.context || s,
+			// Context for global events
+			// It's the callbackContext if one was provided in the options
+			// and if it's a DOM node or a jQuery collection
+			globalEventContext = callbackContext !== s &&
+				( callbackContext.nodeType || callbackContext instanceof jQuery ) ?
+						jQuery( callbackContext ) : jQuery.event,
+			// Deferreds
+			deferred = jQuery.Deferred(),
+			completeDeferred = jQuery.Callbacks( "once memory" ),
+			// Status-dependent callbacks
+			statusCode = s.statusCode || {},
+			// ifModified key
+			ifModifiedKey,
+			// Headers (they are sent all at once)
+			requestHeaders = {},
+			requestHeadersNames = {},
+			// Response headers
+			responseHeadersString,
+			responseHeaders,
+			// transport
+			transport,
+			// timeout handle
+			timeoutTimer,
+			// Cross-domain detection vars
+			parts,
+			// The jqXHR state
+			state = 0,
+			// To know if global events are to be dispatched
+			fireGlobals,
+			// Loop variable
+			i,
+			// Fake xhr
+			jqXHR = {
+
+				readyState: 0,
+
+				// Caches the header
+				setRequestHeader: function( name, value ) {
+					if ( !state ) {
+						var lname = name.toLowerCase();
+						name = requestHeadersNames[ lname ] = requestHeadersNames[ lname ] || name;
+						requestHeaders[ name ] = value;
+					}
+					return this;
+				},
+
+				// Raw string
+				getAllResponseHeaders: function() {
+					return state === 2 ? responseHeadersString : null;
+				},
+
+				// Builds headers hashtable if needed
+				getResponseHeader: function( key ) {
+					var match;
+					if ( state === 2 ) {
+						if ( !responseHeaders ) {
+							responseHeaders = {};
+							while( ( match = rheaders.exec( responseHeadersString ) ) ) {
+								responseHeaders[ match[1].toLowerCase() ] = match[ 2 ];
+							}
+						}
+						match = responseHeaders[ key.toLowerCase() ];
+					}
+					return match === undefined ? null : match;
+				},
+
+				// Overrides response content-type header
+				overrideMimeType: function( type ) {
+					if ( !state ) {
+						s.mimeType = type;
+					}
+					return this;
+				},
+
+				// Cancel the request
+				abort: function( statusText ) {
+					statusText = statusText || "abort";
+					if ( transport ) {
+						transport.abort( statusText );
+					}
+					done( 0, statusText );
+					return this;
+				}
+			};
+
+		// Callback for when everything is done
+		// It is defined here because jslint complains if it is declared
+		// at the end of the function (which would be more logical and readable)
+		function done( status, nativeStatusText, responses, headers ) {
+
+			// Called once
+			if ( state === 2 ) {
+				return;
+			}
+
+			// State is "done" now
+			state = 2;
+
+			// Clear timeout if it exists
+			if ( timeoutTimer ) {
+				clearTimeout( timeoutTimer );
+			}
+
+			// Dereference transport for early garbage collection
+			// (no matter how long the jqXHR object will be used)
+			transport = undefined;
+
+			// Cache response headers
+			responseHeadersString = headers || "";
+
+			// Set readyState
+			jqXHR.readyState = status > 0 ? 4 : 0;
+
+			var isSuccess,
+				success,
+				error,
+				statusText = nativeStatusText,
+				response = responses ? ajaxHandleResponses( s, jqXHR, responses ) : undefined,
+				lastModified,
+				etag;
+
+			// If successful, handle type chaining
+			if ( status >= 200 && status < 300 || status === 304 ) {
+
+				// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
+				if ( s.ifModified ) {
+
+					if ( ( lastModified = jqXHR.getResponseHeader( "Last-Modified" ) ) ) {
+						jQuery.lastModified[ ifModifiedKey ] = lastModified;
+					}
+					if ( ( etag = jqXHR.getResponseHeader( "Etag" ) ) ) {
+						jQuery.etag[ ifModifiedKey ] = etag;
+					}
+				}
+
+				// If not modified
+				if ( status === 304 ) {
+
+					statusText = "notmodified";
+					isSuccess = true;
+
+				// If we have data
+				} else {
+
+					try {
+						success = ajaxConvert( s, response );
+						statusText = "success";
+						isSuccess = true;
+					} catch(e) {
+						// We have a parsererror
+						statusText = "parsererror";
+						error = e;
+					}
+				}
+			} else {
+				// We extract error from statusText
+				// then normalize statusText and status for non-aborts
+				error = statusText;
+				if( !statusText || status ) {
+					statusText = "error";
+					if ( status < 0 ) {
+						status = 0;
+					}
+				}
+			}
+
+			// Set data for the fake xhr object
+			jqXHR.status = status;
+			jqXHR.statusText = "" + ( nativeStatusText || statusText );
+
+			// Success/Error
+			if ( isSuccess ) {
+				deferred.resolveWith( callbackContext, [ success, statusText, jqXHR ] );
+			} else {
+				deferred.rejectWith( callbackContext, [ jqXHR, statusText, error ] );
+			}
+
+			// Status-dependent callbacks
+			jqXHR.statusCode( statusCode );
+			statusCode = undefined;
+
+			if ( fireGlobals ) {
+				globalEventContext.trigger( "ajax" + ( isSuccess ? "Success" : "Error" ),
+						[ jqXHR, s, isSuccess ? success : error ] );
+			}
+
+			// Complete
+			completeDeferred.fireWith( callbackContext, [ jqXHR, statusText ] );
+
+			if ( fireGlobals ) {
+				globalEventContext.trigger( "ajaxComplete", [ jqXHR, s ] );
+				// Handle the global AJAX counter
+				if ( !( --jQuery.active ) ) {
+					jQuery.event.trigger( "ajaxStop" );
+				}
+			}
+		}
+
+		// Attach deferreds
+		deferred.promise( jqXHR );
+		jqXHR.success = jqXHR.done;
+		jqXHR.error = jqXHR.fail;
+		jqXHR.complete = completeDeferred.add;
+
+		// Status-dependent callbacks
+		jqXHR.statusCode = function( map ) {
+			if ( map ) {
+				var tmp;
+				if ( state < 2 ) {
+					for( tmp in map ) {
+						statusCode[ tmp ] = [ statusCode[tmp], map[tmp] ];
+					}
+				} else {
+					tmp = map[ jqXHR.status ];
+					jqXHR.then( tmp, tmp );
+				}
+			}
+			return this;
+		};
+
+		// Remove hash character (#7531: and string promotion)
+		// Add protocol if not provided (#5866: IE7 issue with protocol-less urls)
+		// We also use the url parameter if available
+		s.url = ( ( url || s.url ) + "" ).replace( rhash, "" ).replace( rprotocol, ajaxLocParts[ 1 ] + "//" );
+
+		// Extract dataTypes list
+		s.dataTypes = jQuery.trim( s.dataType || "*" ).toLowerCase().split( rspacesAjax );
+
+		// Determine if a cross-domain request is in order
+		if ( s.crossDomain == null ) {
+			parts = rurl.exec( s.url.toLowerCase() );
+			s.crossDomain = !!( parts &&
+				( parts[ 1 ] != ajaxLocParts[ 1 ] || parts[ 2 ] != ajaxLocParts[ 2 ] ||
+					( parts[ 3 ] || ( parts[ 1 ] === "http:" ? 80 : 443 ) ) !=
+						( ajaxLocParts[ 3 ] || ( ajaxLocParts[ 1 ] === "http:" ? 80 : 443 ) ) )
+			);
+		}
+
+		// Convert data if not already a string
+		if ( s.data && s.processData && typeof s.data !== "string" ) {
+			s.data = jQuery.param( s.data, s.traditional );
+		}
+
+		// Apply prefilters
+		inspectPrefiltersOrTransports( prefilters, s, options, jqXHR );
+
+		// If request was aborted inside a prefiler, stop there
+		if ( state === 2 ) {
+			return false;
+		}
+
+		// We can fire global events as of now if asked to
+		fireGlobals = s.global;
+
+		// Uppercase the type
+		s.type = s.type.toUpperCase();
+
+		// Determine if request has content
+		s.hasContent = !rnoContent.test( s.type );
+
+		// Watch for a new set of requests
+		if ( fireGlobals && jQuery.active++ === 0 ) {
+			jQuery.event.trigger( "ajaxStart" );
+		}
+
+		// More options handling for requests with no content
+		if ( !s.hasContent ) {
+
+			// If data is available, append data to url
+			if ( s.data ) {
+				s.url += ( rquery.test( s.url ) ? "&" : "?" ) + s.data;
+				// #9682: remove data so that it's not used in an eventual retry
+				delete s.data;
+			}
+
+			// Get ifModifiedKey before adding the anti-cache parameter
+			ifModifiedKey = s.url;
+
+			// Add anti-cache in url if needed
+			if ( s.cache === false ) {
+
+				var ts = jQuery.now(),
+					// try replacing _= if it is there
+					ret = s.url.replace( rts, "$1_=" + ts );
+
+				// if nothing was replaced, add timestamp to the end
+				s.url = ret + ( (ret === s.url ) ? ( rquery.test( s.url ) ? "&" : "?" ) + "_=" + ts : "" );
+			}
+		}
+
+		// Set the correct header, if data is being sent
+		if ( s.data && s.hasContent && s.contentType !== false || options.contentType ) {
+			jqXHR.setRequestHeader( "Content-Type", s.contentType );
+		}
+
+		// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
+		if ( s.ifModified ) {
+			ifModifiedKey = ifModifiedKey || s.url;
+			if ( jQuery.lastModified[ ifModifiedKey ] ) {
+				jqXHR.setRequestHeader( "If-Modified-Since", jQuery.lastModified[ ifModifiedKey ] );
+			}
+			if ( jQuery.etag[ ifModifiedKey ] ) {
+				jqXHR.setRequestHeader( "If-None-Match", jQuery.etag[ ifModifiedKey ] );
+			}
+		}
+
+		// Set the Accepts header for the server, depending on the dataType
+		jqXHR.setRequestHeader(
+			"Accept",
+			s.dataTypes[ 0 ] && s.accepts[ s.dataTypes[0] ] ?
+				s.accepts[ s.dataTypes[0] ] + ( s.dataTypes[ 0 ] !== "*" ? ", " + allTypes + "; q=0.01" : "" ) :
+				s.accepts[ "*" ]
+		);
+
+		// Check for headers option
+		for ( i in s.headers ) {
+			jqXHR.setRequestHeader( i, s.headers[ i ] );
+		}
+
+		// Allow custom headers/mimetypes and early abort
+		if ( s.beforeSend && ( s.beforeSend.call( callbackContext, jqXHR, s ) === false || state === 2 ) ) {
+				// Abort if not done already
+				jqXHR.abort();
+				return false;
+
+		}
+
+		// Install callbacks on deferreds
+		for ( i in { success: 1, error: 1, complete: 1 } ) {
+			jqXHR[ i ]( s[ i ] );
+		}
+
+		// Get transport
+		transport = inspectPrefiltersOrTransports( transports, s, options, jqXHR );
+
+		// If no transport, we auto-abort
+		if ( !transport ) {
+			done( -1, "No Transport" );
+		} else {
+			jqXHR.readyState = 1;
+			// Send global event
+			if ( fireGlobals ) {
+				globalEventContext.trigger( "ajaxSend", [ jqXHR, s ] );
+			}
+			// Timeout
+			if ( s.async && s.timeout > 0 ) {
+				timeoutTimer = setTimeout( function(){
+					jqXHR.abort( "timeout" );
+				}, s.timeout );
+			}
+
+			try {
+				state = 1;
+				transport.send( requestHeaders, done );
+			} catch (e) {
+				// Propagate exception as error if not done
+				if ( state < 2 ) {
+					done( -1, e );
+				// Simply rethrow otherwise
+				} else {
+					jQuery.error( e );
+				}
+			}
+		}
+
+		return jqXHR;
+	},
+
+	// Serialize an array of form elements or a set of
+	// key/values into a query string
+	param: function( a, traditional ) {
+		var s = [],
+			add = function( key, value ) {
+				// If value is a function, invoke it and return its value
+				value = jQuery.isFunction( value ) ? value() : value;
+				s[ s.length ] = encodeURIComponent( key ) + "=" + encodeURIComponent( value );
+			};
+
+		// Set traditional to true for jQuery <= 1.3.2 behavior.
+		if ( traditional === undefined ) {
+			traditional = jQuery.ajaxSettings.traditional;
+		}
+
+		// If an array was passed in, assume that it is an array of form elements.
+		if ( jQuery.isArray( a ) || ( a.jquery && !jQuery.isPlainObject( a ) ) ) {
+			// Serialize the form elements
+			jQuery.each( a, function() {
+				add( this.name, this.value );
+			});
+
+		} else {
+			// If traditional, encode the "old" way (the way 1.3.2 or older
+			// did it), otherwise encode params recursively.
+			for ( var prefix in a ) {
+				buildParams( prefix, a[ prefix ], traditional, add );
+			}
+		}
+
+		// Return the resulting serialization
+		return s.join( "&" ).replace( r20, "+" );
+	}
+});
+
+function buildParams( prefix, obj, traditional, add ) {
+	if ( jQuery.isArray( obj ) ) {
+		// Serialize array item.
+		jQuery.each( obj, function( i, v ) {
+			if ( traditional || rbracket.test( prefix ) ) {
+				// Treat each array item as a scalar.
+				add( prefix, v );
+
+			} else {
+				// If array item is non-scalar (array or object), encode its
+				// numeric index to resolve deserialization ambiguity issues.
+				// Note that rack (as of 1.0.0) can't currently deserialize
+				// nested arrays properly, and attempting to do so may cause
+				// a server error. Possible fixes are to modify rack's
+				// deserialization algorithm or to provide an option or flag
+				// to force array serialization to be shallow.
+				buildParams( prefix + "[" + ( typeof v === "object" || jQuery.isArray(v) ? i : "" ) + "]", v, traditional, add );
+			}
+		});
+
+	} else if ( !traditional && obj != null && typeof obj === "object" ) {
+		// Serialize object item.
+		for ( var name in obj ) {
+			buildParams( prefix + "[" + name + "]", obj[ name ], traditional, add );
+		}
+
+	} else {
+		// Serialize scalar item.
+		add( prefix, obj );
+	}
+}
+
+// This is still on the jQuery object... for now
+// Want to move this to jQuery.ajax some day
+jQuery.extend({
+
+	// Counter for holding the number of active queries
+	active: 0,
+
+	// Last-Modified header cache for next request
+	lastModified: {},
+	etag: {}
+
+});
+
+/* Handles responses to an ajax request:
+ * - sets all responseXXX fields accordingly
+ * - finds the right dataType (mediates between content-type and expected dataType)
+ * - returns the corresponding response
+ */
+function ajaxHandleResponses( s, jqXHR, responses ) {
+
+	var contents = s.contents,
+		dataTypes = s.dataTypes,
+		responseFields = s.responseFields,
+		ct,
+		type,
+		finalDataType,
+		firstDataType;
+
+	// Fill responseXXX fields
+	for( type in responseFields ) {
+		if ( type in responses ) {
+			jqXHR[ responseFields[type] ] = responses[ type ];
+		}
+	}
+
+	// Remove auto dataType and get content-type in the process
+	while( dataTypes[ 0 ] === "*" ) {
+		dataTypes.shift();
+		if ( ct === undefined ) {
+			ct = s.mimeType || jqXHR.getResponseHeader( "content-type" );
+		}
+	}
+
+	// Check if we're dealing with a known content-type
+	if ( ct ) {
+		for ( type in contents ) {
+			if ( contents[ type ] && contents[ type ].test( ct ) ) {
+				dataTypes.unshift( type );
+				break;
+			}
+		}
+	}
+
+	// Check to see if we have a response for the expected dataType
+	if ( dataTypes[ 0 ] in responses ) {
+		finalDataType = dataTypes[ 0 ];
+	} else {
+		// Try convertible dataTypes
+		for ( type in responses ) {
+			if ( !dataTypes[ 0 ] || s.converters[ type + " " + dataTypes[0] ] ) {
+				finalDataType = type;
+				break;
+			}
+			if ( !firstDataType ) {
+				firstDataType = type;
+			}
+		}
+		// Or just use first one
+		finalDataType = finalDataType || firstDataType;
+	}
+
+	// If we found a dataType
+	// We add the dataType to the list if needed
+	// and return the corresponding response
+	if ( finalDataType ) {
+		if ( finalDataType !== dataTypes[ 0 ] ) {
+			dataTypes.unshift( finalDataType );
+		}
+		return responses[ finalDataType ];
+	}
+}
+
+// Chain conversions given the request and the original response
+function ajaxConvert( s, response ) {
+
+	// Apply the dataFilter if provided
+	if ( s.dataFilter ) {
+		response = s.dataFilter( response, s.dataType );
+	}
+
+	var dataTypes = s.dataTypes,
+		converters = {},
+		i,
+		key,
+		length = dataTypes.length,
+		tmp,
+		// Current and previous dataTypes
+		current = dataTypes[ 0 ],
+		prev,
+		// Conversion expression
+		conversion,
+		// Conversion function
+		conv,
+		// Conversion functions (transitive conversion)
+		conv1,
+		conv2;
+
+	// For each dataType in the chain
+	for( i = 1; i < length; i++ ) {
+
+		// Create converters map
+		// with lowercased keys
+		if ( i === 1 ) {
+			for( key in s.converters ) {
+				if( typeof key === "string" ) {
+					converters[ key.toLowerCase() ] = s.converters[ key ];
+				}
+			}
+		}
+
+		// Get the dataTypes
+		prev = current;
+		current = dataTypes[ i ];
+
+		// If current is auto dataType, update it to prev
+		if( current === "*" ) {
+			current = prev;
+		// If no auto and dataTypes are actually different
+		} else if ( prev !== "*" && prev !== current ) {
+
+			// Get the converter
+			conversion = prev + " " + current;
+			conv = converters[ conversion ] || converters[ "* " + current ];
+
+			// If there is no direct converter, search transitively
+			if ( !conv ) {
+				conv2 = undefined;
+				for( conv1 in converters ) {
+					tmp = conv1.split( " " );
+					if ( tmp[ 0 ] === prev || tmp[ 0 ] === "*" ) {
+						conv2 = converters[ tmp[1] + " " + current ];
+						if ( conv2 ) {
+							conv1 = converters[ conv1 ];
+							if ( conv1 === true ) {
+								conv = conv2;
+							} else if ( conv2 === true ) {
+								conv = conv1;
+							}
+							break;
+						}
+					}
+				}
+			}
+			// If we found no converter, dispatch an error
+			if ( !( conv || conv2 ) ) {
+				jQuery.error( "No conversion from " + conversion.replace(" "," to ") );
+			}
+			// If found converter is not an equivalence
+			if ( conv !== true ) {
+				// Convert with 1 or 2 converters accordingly
+				response = conv ? conv( response ) : conv2( conv1(response) );
+			}
+		}
+	}
+	return response;
+}
+
+
+
+
+var jsc = jQuery.now(),
+	jsre = /(\=)\?(&|$)|\?\?/i;
+
+// Default jsonp settings
+jQuery.ajaxSetup({
+	jsonp: "callback",
+	jsonpCallback: function() {
+		return jQuery.expando + "_" + ( jsc++ );
+	}
+});
+
+// Detect, normalize options and install callbacks for jsonp requests
+jQuery.ajaxPrefilter( "json jsonp", function( s, originalSettings, jqXHR ) {
+
+	var inspectData = s.contentType === "application/x-www-form-urlencoded" &&
+		( typeof s.data === "string" );
+
+	if ( s.dataTypes[ 0 ] === "jsonp" ||
+		s.jsonp !== false && ( jsre.test( s.url ) ||
+				inspectData && jsre.test( s.data ) ) ) {
+
+		var responseContainer,
+			jsonpCallback = s.jsonpCallback =
+				jQuery.isFunction( s.jsonpCallback ) ? s.jsonpCallback() : s.jsonpCallback,
+			previous = window[ jsonpCallback ],
+			url = s.url,
+			data = s.data,
+			replace = "$1" + jsonpCallback + "$2";
+
+		if ( s.jsonp !== false ) {
+			url = url.replace( jsre, replace );
+			if ( s.url === url ) {
+				if ( inspectData ) {
+					data = data.replace( jsre, replace );
+				}
+				if ( s.data === data ) {
+					// Add callback manually
+					url += (/\?/.test( url ) ? "&" : "?") + s.jsonp + "=" + jsonpCallback;
+				}
+			}
+		}
+
+		s.url = url;
+		s.data = data;
+
+		// Install callback
+		window[ jsonpCallback ] = function( response ) {
+			responseContainer = [ response ];
+		};
+
+		// Clean-up function
+		jqXHR.always(function() {
+			// Set callback back to previous value
+			window[ jsonpCallback ] = previous;
+			// Call if it was a function and we have a response
+			if ( responseContainer && jQuery.isFunction( previous ) ) {
+				window[ jsonpCallback ]( responseContainer[ 0 ] );
+			}
+		});
+
+		// Use data converter to retrieve json after script execution
+		s.converters["script json"] = function() {
+			if ( !responseContainer ) {
+				jQuery.error( jsonpCallback + " was not called" );
+			}
+			return responseContainer[ 0 ];
+		};
+
+		// force json dataType
+		s.dataTypes[ 0 ] = "json";
+
+		// Delegate to script
+		return "script";
+	}
+});
+
+
+
+
+// Install script dataType
+jQuery.ajaxSetup({
+	accepts: {
+		script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"
+	},
+	contents: {
+		script: /javascript|ecmascript/
+	},
+	converters: {
+		"text script": function( text ) {
+			jQuery.globalEval( text );
+			return text;
+		}
+	}
+});
+
+// Handle cache's special case and global
+jQuery.ajaxPrefilter( "script", function( s ) {
+	if ( s.cache === undefined ) {
+		s.cache = false;
+	}
+	if ( s.crossDomain ) {
+		s.type = "GET";
+		s.global = false;
+	}
+});
+
+// Bind script tag hack transport
+jQuery.ajaxTransport( "script", function(s) {
+
+	// This transport only deals with cross domain requests
+	if ( s.crossDomain ) {
+
+		var script,
+			head = document.head || document.getElementsByTagName( "head" )[0] || document.documentElement;
+
+		return {
+
+			send: function( _, callback ) {
+
+				script = document.createElement( "script" );
+
+				script.async = "async";
+
+				if ( s.scriptCharset ) {
+					script.charset = s.scriptCharset;
+				}
+
+				script.src = s.url;
+
+				// Attach handlers for all browsers
+				script.onload = script.onreadystatechange = function( _, isAbort ) {
+
+					if ( isAbort || !script.readyState || /loaded|complete/.test( script.readyState ) ) {
+
+						// Handle memory leak in IE
+						script.onload = script.onreadystatechange = null;
+
+						// Remove the script
+						if ( head && script.parentNode ) {
+							head.removeChild( script );
+						}
+
+						// Dereference the script
+						script = undefined;
+
+						// Callback if not abort
+						if ( !isAbort ) {
+							callback( 200, "success" );
+						}
+					}
+				};
+				// Use insertBefore instead of appendChild  to circumvent an IE6 bug.
+				// This arises when a base node is used (#2709 and #4378).
+				head.insertBefore( script, head.firstChild );
+			},
+
+			abort: function() {
+				if ( script ) {
+					script.onload( 0, 1 );
+				}
+			}
+		};
+	}
+});
+
+
+
+
+var // #5280: Internet Explorer will keep connections alive if we don't abort on unload
+	xhrOnUnloadAbort = window.ActiveXObject ? function() {
+		// Abort all pending requests
+		for ( var key in xhrCallbacks ) {
+			xhrCallbacks[ key ]( 0, 1 );
+		}
+	} : false,
+	xhrId = 0,
+	xhrCallbacks;
+
+// Functions to create xhrs
+function createStandardXHR() {
+	try {
+		return new window.XMLHttpRequest();
+	} catch( e ) {}
+}
+
+function createActiveXHR() {
+	try {
+		return new window.ActiveXObject( "Microsoft.XMLHTTP" );
+	} catch( e ) {}
+}
+
+// Create the request object
+// (This is still attached to ajaxSettings for backward compatibility)
+jQuery.ajaxSettings.xhr = window.ActiveXObject ?
+	/* Microsoft failed to properly
+	 * implement the XMLHttpRequest in IE7 (can't request local files),
+	 * so we use the ActiveXObject when it is available
+	 * Additionally XMLHttpRequest can be disabled in IE7/IE8 so
+	 * we need a fallback.
+	 */
+	function() {
+		return !this.isLocal && createStandardXHR() || createActiveXHR();
+	} :
+	// For all other browsers, use the standard XMLHttpRequest object
+	createStandardXHR;
+
+// Determine support properties
+(function( xhr ) {
+	jQuery.extend( jQuery.support, {
+		ajax: !!xhr,
+		cors: !!xhr && ( "withCredentials" in xhr )
+	});
+})( jQuery.ajaxSettings.xhr() );
+
+// Create transport if the browser can provide an xhr
+if ( jQuery.support.ajax ) {
+
+	jQuery.ajaxTransport(function( s ) {
+		// Cross domain only allowed if supported through XMLHttpRequest
+		if ( !s.crossDomain || jQuery.support.cors ) {
+
+			var callback;
+
+			return {
+				send: function( headers, complete ) {
+
+					// Get a new xhr
+					var xhr = s.xhr(),
+						handle,
+						i;
+
+					// Open the socket
+					// Passing null username, generates a login popup on Opera (#2865)
+					if ( s.username ) {
+						xhr.open( s.type, s.url, s.async, s.username, s.password );
+					} else {
+						xhr.open( s.type, s.url, s.async );
+					}
+
+					// Apply custom fields if provided
+					if ( s.xhrFields ) {
+						for ( i in s.xhrFields ) {
+							xhr[ i ] = s.xhrFields[ i ];
+						}
+					}
+
+					// Override mime type if needed
+					if ( s.mimeType && xhr.overrideMimeType ) {
+						xhr.overrideMimeType( s.mimeType );
+					}
+
+					// X-Requested-With header
+					// For cross-domain requests, seeing as conditions for a preflight are
+					// akin to a jigsaw puzzle, we simply never set it to be sure.
+					// (it can always be set on a per-request basis or even using ajaxSetup)
+					// For same-domain requests, won't change header if already provided.
+					if ( !s.crossDomain && !headers["X-Requested-With"] ) {
+						headers[ "X-Requested-With" ] = "XMLHttpRequest";
+					}
+
+					// Need an extra try/catch for cross domain requests in Firefox 3
+					try {
+						for ( i in headers ) {
+							xhr.setRequestHeader( i, headers[ i ] );
+						}
+					} catch( _ ) {}
+
+					// Do send the request
+					// This may raise an exception which is actually
+					// handled in jQuery.ajax (so no try/catch here)
+					xhr.send( ( s.hasContent && s.data ) || null );
+
+					// Listener
+					callback = function( _, isAbort ) {
+
+						var status,
+							statusText,
+							responseHeaders,
+							responses,
+							xml;
+
+						// Firefox throws exceptions when accessing properties
+						// of an xhr when a network error occured
+						// http://helpful.knobs-dials.com/index.php/Component_returned_failure_code:_0x80040111_(NS_ERROR_NOT_AVAILABLE)
+						try {
+
+							// Was never called and is aborted or complete
+							if ( callback && ( isAbort || xhr.readyState === 4 ) ) {
+
+								// Only called once
+								callback = undefined;
+
+								// Do not keep as active anymore
+								if ( handle ) {
+									xhr.onreadystatechange = jQuery.noop;
+									if ( xhrOnUnloadAbort ) {
+										delete xhrCallbacks[ handle ];
+									}
+								}
+
+								// If it's an abort
+								if ( isAbort ) {
+									// Abort it manually if needed
+									if ( xhr.readyState !== 4 ) {
+										xhr.abort();
+									}
+								} else {
+									status = xhr.status;
+									responseHeaders = xhr.getAllResponseHeaders();
+									responses = {};
+									xml = xhr.responseXML;
+
+									// Construct response list
+									if ( xml && xml.documentElement /* #4958 */ ) {
+										responses.xml = xml;
+									}
+									responses.text = xhr.responseText;
+
+									// Firefox throws an exception when accessing
+									// statusText for faulty cross-domain requests
+									try {
+										statusText = xhr.statusText;
+									} catch( e ) {
+										// We normalize with Webkit giving an empty statusText
+										statusText = "";
+									}
+
+									// Filter status for non standard behaviors
+
+									// If the request is local and we have data: assume a success
+									// (success with no data won't get notified, that's the best we
+									// can do given current implementations)
+									if ( !status && s.isLocal && !s.crossDomain ) {
+										status = responses.text ? 200 : 404;
+									// IE - #1450: sometimes returns 1223 when it should be 204
+									} else if ( status === 1223 ) {
+										status = 204;
+									}
+								}
+							}
+						} catch( firefoxAccessException ) {
+							if ( !isAbort ) {
+								complete( -1, firefoxAccessException );
+							}
+						}
+
+						// Call complete if needed
+						if ( responses ) {
+							complete( status, statusText, responses, responseHeaders );
+						}
+					};
+
+					// if we're in sync mode or it's in cache
+					// and has been retrieved directly (IE6 & IE7)
+					// we need to manually fire the callback
+					if ( !s.async || xhr.readyState === 4 ) {
+						callback();
+					} else {
+						handle = ++xhrId;
+						if ( xhrOnUnloadAbort ) {
+							// Create the active xhrs callbacks list if needed
+							// and attach the unload handler
+							if ( !xhrCallbacks ) {
+								xhrCallbacks = {};
+								jQuery( window ).unload( xhrOnUnloadAbort );
+							}
+							// Add to list of active xhrs callbacks
+							xhrCallbacks[ handle ] = callback;
+						}
+						xhr.onreadystatechange = callback;
+					}
+				},
+
+				abort: function() {
+					if ( callback ) {
+						callback(0,1);
+					}
+				}
+			};
+		}
+	});
+}
+
+
+
+
+var elemdisplay = {},
+	iframe, iframeDoc,
+	rfxtypes = /^(?:toggle|show|hide)$/,
+	rfxnum = /^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,
+	timerId,
+	fxAttrs = [
+		// height animations
+		[ "height", "marginTop", "marginBottom", "paddingTop", "paddingBottom" ],
+		// width animations
+		[ "width", "marginLeft", "marginRight", "paddingLeft", "paddingRight" ],
+		// opacity animations
+		[ "opacity" ]
+	],
+	fxNow;
+
+jQuery.fn.extend({
+	show: function( speed, easing, callback ) {
+		var elem, display;
+
+		if ( speed || speed === 0 ) {
+			return this.animate( genFx("show", 3), speed, easing, callback);
+
+		} else {
+			for ( var i = 0, j = this.length; i < j; i++ ) {
+				elem = this[i];
+
+				if ( elem.style ) {
+					display = elem.style.display;
+
+					// Reset the inline display of this element to learn if it is
+					// being hidden by cascaded rules or not
+					if ( !jQuery._data(elem, "olddisplay") && display === "none" ) {
+						display = elem.style.display = "";
+					}
+
+					// Set elements which have been overridden with display: none
+					// in a stylesheet to whatever the default browser style is
+					// for such an element
+					if ( display === "none" || ( display === ""  && jQuery.css( elem, "display" ) === "none" ) ) {
+						jQuery._data(elem, "olddisplay", defaultDisplay(elem.nodeName));
+					}
+				}
+			}
+
+			// Set the display of most of the elements in a second loop
+			// to avoid the constant reflow
+			for ( i = 0; i < j; i++ ) {
+				elem = this[i];
+
+				if ( elem.style ) {
+					display = elem.style.display;
+
+					if ( display === "" || display === "none" ) {
+						elem.style.display = jQuery._data(elem, "olddisplay") || "";
+					}
+				}
+			}
+
+			return this;
+		}
+	},
+
+	hide: function( speed, easing, callback ) {
+		if ( speed || speed === 0 ) {
+			return this.animate( genFx("hide", 3), speed, easing, callback);
+
+		} else {
+			for ( var i = 0, j = this.length; i < j; i++ ) {
+				if ( this[i].style ) {
+					var display = jQuery.css( this[i], "display" );
+
+					if ( display !== "none" && !jQuery._data( this[i], "olddisplay" ) ) {
+						jQuery._data( this[i], "olddisplay", display );
+					}
+				}
+			}
+
+			// Set the display of the elements in a second loop
+			// to avoid the constant reflow
+			for ( i = 0; i < j; i++ ) {
+				if ( this[i].style ) {
+					this[i].style.display = "none";
+				}
+			}
+
+			return this;
+		}
+	},
+
+	// Save the old toggle function
+	_toggle: jQuery.fn.toggle,
+
+	toggle: function( fn, fn2, callback ) {
+		var bool = typeof fn === "boolean";
+
+		if ( jQuery.isFunction(fn) && jQuery.isFunction(fn2) ) {
+			this._toggle.apply( this, arguments );
+
+		} else if ( fn == null || bool ) {
+			this.each(function() {
+				var state = bool ? fn : jQuery(this).is(":hidden");
+				jQuery(this)[ state ? "show" : "hide" ]();
+			});
+
+		} else {
+			this.animate(genFx("toggle", 3), fn, fn2, callback);
+		}
+
+		return this;
+	},
+
+	fadeTo: function( speed, to, easing, callback ) {
+		return this.filter(":hidden").css("opacity", 0).show().end()
+					.animate({opacity: to}, speed, easing, callback);
+	},
+
+	animate: function( prop, speed, easing, callback ) {
+		var optall = jQuery.speed( speed, easing, callback );
+
+		if ( jQuery.isEmptyObject( prop ) ) {
+			return this.each( optall.complete, [ false ] );
+		}
+
+		// Do not change referenced properties as per-property easing will be lost
+		prop = jQuery.extend( {}, prop );
+
+		function doAnimation() {
+			// XXX 'this' does not always have a nodeName when running the
+			// test suite
+
+			if ( optall.queue === false ) {
+				jQuery._mark( this );
+			}
+
+			var opt = jQuery.extend( {}, optall ),
+				isElement = this.nodeType === 1,
+				hidden = isElement && jQuery(this).is(":hidden"),
+				name, val, p, e,
+				parts, start, end, unit,
+				method;
+
+			// will store per property easing and be used to determine when an animation is complete
+			opt.animatedProperties = {};
+
+			for ( p in prop ) {
+
+				// property name normalization
+				name = jQuery.camelCase( p );
+				if ( p !== name ) {
+					prop[ name ] = prop[ p ];
+					delete prop[ p ];
+				}
+
+				val = prop[ name ];
+
+				// easing resolution: per property > opt.specialEasing > opt.easing > 'swing' (default)
+				if ( jQuery.isArray( val ) ) {
+					opt.animatedProperties[ name ] = val[ 1 ];
+					val = prop[ name ] = val[ 0 ];
+				} else {
+					opt.animatedProperties[ name ] = opt.specialEasing && opt.specialEasing[ name ] || opt.easing || 'swing';
+				}
+
+				if ( val === "hide" && hidden || val === "show" && !hidden ) {
+					return opt.complete.call( this );
+				}
+
+				if ( isElement && ( name === "height" || name === "width" ) ) {
+					// Make sure that nothing sneaks out
+					// Record all 3 overflow attributes because IE does not
+					// change the overflow attribute when overflowX and
+					// overflowY are set to the same value
+					opt.overflow = [ this.style.overflow, this.style.overflowX, this.style.overflowY ];
+
+					// Set display property to inline-block for height/width
+					// animations on inline elements that are having width/height animated
+					if ( jQuery.css( this, "display" ) === "inline" &&
+							jQuery.css( this, "float" ) === "none" ) {
+
+						// inline-level elements accept inline-block;
+						// block-level elements need to be inline with layout
+						if ( !jQuery.support.inlineBlockNeedsLayout || defaultDisplay( this.nodeName ) === "inline" ) {
+							this.style.display = "inline-block";
+
+						} else {
+							this.style.zoom = 1;
+						}
+					}
+				}
+			}
+
+			if ( opt.overflow != null ) {
+				this.style.overflow = "hidden";
+			}
+
+			for ( p in prop ) {
+				e = new jQuery.fx( this, opt, p );
+				val = prop[ p ];
+
+				if ( rfxtypes.test( val ) ) {
+
+					// Tracks whether to show or hide based on private
+					// data attached to the element
+					method = jQuery._data( this, "toggle" + p ) || (val === "toggle" ? hidden ? "show" : "hide" : 0);
+					if ( method ) {
+						jQuery._data( this, "toggle" + p, method === "show" ? "hide" : "show" );
+						e[ method ]();
+					} else {
+						e[ val ]();
+					}
+
+				} else {
+					parts = rfxnum.exec( val );
+					start = e.cur();
+
+					if ( parts ) {
+						end = parseFloat( parts[2] );
+						unit = parts[3] || ( jQuery.cssNumber[ p ] ? "" : "px" );
+
+						// We need to compute starting value
+						if ( unit !== "px" ) {
+							jQuery.style( this, p, (end || 1) + unit);
+							start = ((end || 1) / e.cur()) * start;
+							jQuery.style( this, p, start + unit);
+						}
+
+						// If a +=/-= token was provided, we're doing a relative animation
+						if ( parts[1] ) {
+							end = ( (parts[ 1 ] === "-=" ? -1 : 1) * end ) + start;
+						}
+
+						e.custom( start, end, unit );
+
+					} else {
+						e.custom( start, val, "" );
+					}
+				}
+			}
+
+			// For JS strict compliance
+			return true;
+		}
+
+		return optall.queue === false ?
+			this.each( doAnimation ) :
+			this.queue( optall.queue, doAnimation );
+	},
+
+	stop: function( type, clearQueue, gotoEnd ) {
+		if ( typeof type !== "string" ) {
+			gotoEnd = clearQueue;
+			clearQueue = type;
+			type = undefined;
+		}
+		if ( clearQueue && type !== false ) {
+			this.queue( type || "fx", [] );
+		}
+
+		return this.each(function() {
+			var i,
+				hadTimers = false,
+				timers = jQuery.timers,
+				data = jQuery._data( this );
+
+			// clear marker counters if we know they won't be
+			if ( !gotoEnd ) {
+				jQuery._unmark( true, this );
+			}
+
+			function stopQueue( elem, data, i ) {
+				var runner = data[ i ];
+				jQuery.removeData( elem, i, true );
+				runner.stop( gotoEnd );
+			}
+
+			if ( type == null ) {
+				for ( i in data ) {
+					if ( data[ i ].stop && i.indexOf(".run") === i.length - 4 ) {
+						stopQueue( this, data, i );
+					}
+				}
+			} else if ( data[ i = type + ".run" ] && data[ i ].stop ){
+				stopQueue( this, data, i );
+			}
+
+			for ( i = timers.length; i--; ) {
+				if ( timers[ i ].elem === this && (type == null || timers[ i ].queue === type) ) {
+					if ( gotoEnd ) {
+
+						// force the next step to be the last
+						timers[ i ]( true );
+					} else {
+						timers[ i ].saveState();
+					}
+					hadTimers = true;
+					timers.splice( i, 1 );
+				}
+			}
+
+			// start the next in the queue if the last step wasn't forced
+			// timers currently will call their complete callbacks, which will dequeue
+			// but only if they were gotoEnd
+			if ( !( gotoEnd && hadTimers ) ) {
+				jQuery.dequeue( this, type );
+			}
+		});
+	}
+
+});
+
+// Animations created synchronously will run synchronously
+function createFxNow() {
+	setTimeout( clearFxNow, 0 );
+	return ( fxNow = jQuery.now() );
+}
+
+function clearFxNow() {
+	fxNow = undefined;
+}
+
+// Generate parameters to create a standard animation
+function genFx( type, num ) {
+	var obj = {};
+
+	jQuery.each( fxAttrs.concat.apply([], fxAttrs.slice( 0, num )), function() {
+		obj[ this ] = type;
+	});
+
+	return obj;
+}
+
+// Generate shortcuts for custom animations
+jQuery.each({
+	slideDown: genFx( "show", 1 ),
+	slideUp: genFx( "hide", 1 ),
+	slideToggle: genFx( "toggle", 1 ),
+	fadeIn: { opacity: "show" },
+	fadeOut: { opacity: "hide" },
+	fadeToggle: { opacity: "toggle" }
+}, function( name, props ) {
+	jQuery.fn[ name ] = function( speed, easing, callback ) {
+		return this.animate( props, speed, easing, callback );
+	};
+});
+
+jQuery.extend({
+	speed: function( speed, easing, fn ) {
+		var opt = speed && typeof speed === "object" ? jQuery.extend( {}, speed ) : {
+			complete: fn || !fn && easing ||
+				jQuery.isFunction( speed ) && speed,
+			duration: speed,
+			easing: fn && easing || easing && !jQuery.isFunction( easing ) && easing
+		};
+
+		opt.duration = jQuery.fx.off ? 0 : typeof opt.duration === "number" ? opt.duration :
+			opt.duration in jQuery.fx.speeds ? jQuery.fx.speeds[ opt.duration ] : jQuery.fx.speeds._default;
+
+		// normalize opt.queue - true/undefined/null -> "fx"
+		if ( opt.queue == null || opt.queue === true ) {
+			opt.queue = "fx";
+		}
+
+		// Queueing
+		opt.old = opt.complete;
+
+		opt.complete = function( noUnmark ) {
+			if ( jQuery.isFunction( opt.old ) ) {
+				opt.old.call( this );
+			}
+
+			if ( opt.queue ) {
+				jQuery.dequeue( this, opt.queue );
+			} else if ( noUnmark !== false ) {
+				jQuery._unmark( this );
+			}
+		};
+
+		return opt;
+	},
+
+	easing: {
+		linear: function( p, n, firstNum, diff ) {
+			return firstNum + diff * p;
+		},
+		swing: function( p, n, firstNum, diff ) {
+			return ((-Math.cos(p*Math.PI)/2) + 0.5) * diff + firstNum;
+		}
+	},
+
+	timers: [],
+
+	fx: function( elem, options, prop ) {
+		this.options = options;
+		this.elem = elem;
+		this.prop = prop;
+
+		options.orig = options.orig || {};
+	}
+
+});
+
+jQuery.fx.prototype = {
+	// Simple function for setting a style value
+	update: function() {
+		if ( this.options.step ) {
+			this.options.step.call( this.elem, this.now, this );
+		}
+
+		(jQuery.fx.step[ this.prop ] || jQuery.fx.step._default)( this );
+	},
+
+	// Get the current size
+	cur: function() {
+		if ( this.elem[ this.prop ] != null && (!this.elem.style || this.elem.style[ this.prop ] == null) ) {
+			return this.elem[ this.prop ];
+		}
+
+		var parsed,
+			r = jQuery.css( this.elem, this.prop );
+		// Empty strings, null, undefined and "auto" are converted to 0,
+		// complex values such as "rotate(1rad)" are returned as is,
+		// simple values such as "10px" are parsed to Float.
+		return isNaN( parsed = parseFloat( r ) ) ? !r || r === "auto" ? 0 : r : parsed;
+	},
+
+	// Start an animation from one number to another
+	custom: function( from, to, unit ) {
+		var self = this,
+			fx = jQuery.fx;
+
+		this.startTime = fxNow || createFxNow();
+		this.end = to;
+		this.now = this.start = from;
+		this.pos = this.state = 0;
+		this.unit = unit || this.unit || ( jQuery.cssNumber[ this.prop ] ? "" : "px" );
+
+		function t( gotoEnd ) {
+			return self.step( gotoEnd );
+		}
+
+		t.queue = this.options.queue;
+		t.elem = this.elem;
+		t.saveState = function() {
+			if ( self.options.hide && jQuery._data( self.elem, "fxshow" + self.prop ) === undefined ) {
+				jQuery._data( self.elem, "fxshow" + self.prop, self.start );
+			}
+		};
+
+		if ( t() && jQuery.timers.push(t) && !timerId ) {
+			timerId = setInterval( fx.tick, fx.interval );
+		}
+	},
+
+	// Simple 'show' function
+	show: function() {
+		var dataShow = jQuery._data( this.elem, "fxshow" + this.prop );
+
+		// Remember where we started, so that we can go back to it later
+		this.options.orig[ this.prop ] = dataShow || jQuery.style( this.elem, this.prop );
+		this.options.show = true;
+
+		// Begin the animation
+		// Make sure that we start at a small width/height to avoid any flash of content
+		if ( dataShow !== undefined ) {
+			// This show is picking up where a previous hide or show left off
+			this.custom( this.cur(), dataShow );
+		} else {
+			this.custom( this.prop === "width" || this.prop === "height" ? 1 : 0, this.cur() );
+		}
+
+		// Start by showing the element
+		jQuery( this.elem ).show();
+	},
+
+	// Simple 'hide' function
+	hide: function() {
+		// Remember where we started, so that we can go back to it later
+		this.options.orig[ this.prop ] = jQuery._data( this.elem, "fxshow" + this.prop ) || jQuery.style( this.elem, this.prop );
+		this.options.hide = true;
+
+		// Begin the animation
+		this.custom( this.cur(), 0 );
+	},
+
+	// Each step of an animation
+	step: function( gotoEnd ) {
+		var p, n, complete,
+			t = fxNow || createFxNow(),
+			done = true,
+			elem = this.elem,
+			options = this.options;
+
+		if ( gotoEnd || t >= options.duration + this.startTime ) {
+			this.now = this.end;
+			this.pos = this.state = 1;
+			this.update();
+
+			options.animatedProperties[ this.prop ] = true;
+
+			for ( p in options.animatedProperties ) {
+				if ( options.animatedProperties[ p ] !== true ) {
+					done = false;
+				}
+			}
+
+			if ( done ) {
+				// Reset the overflow
+				if ( options.overflow != null && !jQuery.support.shrinkWrapBlocks ) {
+
+					jQuery.each( [ "", "X", "Y" ], function( index, value ) {
+						elem.style[ "overflow" + value ] = options.overflow[ index ];
+					});
+				}
+
+				// Hide the element if the "hide" operation was done
+				if ( options.hide ) {
+					jQuery( elem ).hide();
+				}
+
+				// Reset the properties, if the item has been hidden or shown
+				if ( options.hide || options.show ) {
+					for ( p in options.animatedProperties ) {
+						jQuery.style( elem, p, options.orig[ p ] );
+						jQuery.removeData( elem, "fxshow" + p, true );
+						// Toggle data is no longer needed
+						jQuery.removeData( elem, "toggle" + p, true );
+					}
+				}
+
+				// Execute the complete function
+				// in the event that the complete function throws an exception
+				// we must ensure it won't be called twice. #5684
+
+				complete = options.complete;
+				if ( complete ) {
+
+					options.complete = false;
+					complete.call( elem );
+				}
+			}
+
+			return false;
+
+		} else {
+			// classical easing cannot be used with an Infinity duration
+			if ( options.duration == Infinity ) {
+				this.now = t;
+			} else {
+				n = t - this.startTime;
+				this.state = n / options.duration;
+
+				// Perform the easing function, defaults to swing
+				this.pos = jQuery.easing[ options.animatedProperties[this.prop] ]( this.state, n, 0, 1, options.duration );
+				this.now = this.start + ( (this.end - this.start) * this.pos );
+			}
+			// Perform the next step of the animation
+			this.update();
+		}
+
+		return true;
+	}
+};
+
+jQuery.extend( jQuery.fx, {
+	tick: function() {
+		var timer,
+			timers = jQuery.timers,
+			i = 0;
+
+		for ( ; i < timers.length; i++ ) {
+			timer = timers[ i ];
+			// Checks the timer has not already been removed
+			if ( !timer() && timers[ i ] === timer ) {
+				timers.splice( i--, 1 );
+			}
+		}
+
+		if ( !timers.length ) {
+			jQuery.fx.stop();
+		}
+	},
+
+	interval: 13,
+
+	stop: function() {
+		clearInterval( timerId );
+		timerId = null;
+	},
+
+	speeds: {
+		slow: 600,
+		fast: 200,
+		// Default speed
+		_default: 400
+	},
+
+	step: {
+		opacity: function( fx ) {
+			jQuery.style( fx.elem, "opacity", fx.now );
+		},
+
+		_default: function( fx ) {
+			if ( fx.elem.style && fx.elem.style[ fx.prop ] != null ) {
+				fx.elem.style[ fx.prop ] = fx.now + fx.unit;
+			} else {
+				fx.elem[ fx.prop ] = fx.now;
+			}
+		}
+	}
+});
+
+// Adds width/height step functions
+// Do not set anything below 0
+jQuery.each([ "width", "height" ], function( i, prop ) {
+	jQuery.fx.step[ prop ] = function( fx ) {
+		jQuery.style( fx.elem, prop, Math.max(0, fx.now) );
+	};
+});
+
+if ( jQuery.expr && jQuery.expr.filters ) {
+	jQuery.expr.filters.animated = function( elem ) {
+		return jQuery.grep(jQuery.timers, function( fn ) {
+			return elem === fn.elem;
+		}).length;
+	};
+}
+
+// Try to restore the default display value of an element
+function defaultDisplay( nodeName ) {
+
+	if ( !elemdisplay[ nodeName ] ) {
+
+		var body = document.body,
+			elem = jQuery( "<" + nodeName + ">" ).appendTo( body ),
+			display = elem.css( "display" );
+
+		elem.remove();
+
+		// If the simple way fails,
+		// get element's real default display by attaching it to a temp iframe
+		if ( display === "none" || display === "" ) {
+			// No iframe to use yet, so create it
+			if ( !iframe ) {
+				iframe = document.createElement( "iframe" );
+				iframe.frameBorder = iframe.width = iframe.height = 0;
+			}
+
+			body.appendChild( iframe );
+
+			// Create a cacheable copy of the iframe document on first call.
+			// IE and Opera will allow us to reuse the iframeDoc without re-writing the fake HTML
+			// document to it; WebKit & Firefox won't allow reusing the iframe document.
+			if ( !iframeDoc || !iframe.createElement ) {
+				iframeDoc = ( iframe.contentWindow || iframe.contentDocument ).document;
+				iframeDoc.write( ( document.compatMode === "CSS1Compat" ? "<!doctype html>" : "" ) + "<html><body>" );
+				iframeDoc.close();
+			}
+
+			elem = iframeDoc.createElement( nodeName );
+
+			iframeDoc.body.appendChild( elem );
+
+			display = jQuery.css( elem, "display" );
+
+			body.removeChild( iframe );
+		}
+
+		// Store the correct default display
+		elemdisplay[ nodeName ] = display;
+	}
+
+	return elemdisplay[ nodeName ];
+}
+
+
+
+
+var rtable = /^t(?:able|d|h)$/i,
+	rroot = /^(?:body|html)$/i;
+
+if ( "getBoundingClientRect" in document.documentElement ) {
+	jQuery.fn.offset = function( options ) {
+		var elem = this[0], box;
+
+		if ( options ) {
+			return this.each(function( i ) {
+				jQuery.offset.setOffset( this, options, i );
+			});
+		}
+
+		if ( !elem || !elem.ownerDocument ) {
+			return null;
+		}
+
+		if ( elem === elem.ownerDocument.body ) {
+			return jQuery.offset.bodyOffset( elem );
+		}
+
+		try {
+			box = elem.getBoundingClientRect();
+		} catch(e) {}
+
+		var doc = elem.ownerDocument,
+			docElem = doc.documentElement;
+
+		// Make sure we're not dealing with a disconnected DOM node
+		if ( !box || !jQuery.contains( docElem, elem ) ) {
+			return box ? { top: box.top, left: box.left } : { top: 0, left: 0 };
+		}
+
+		var body = doc.body,
+			win = getWindow(doc),
+			clientTop  = docElem.clientTop  || body.clientTop  || 0,
+			clientLeft = docElem.clientLeft || body.clientLeft || 0,
+			scrollTop  = win.pageYOffset || jQuery.support.boxModel && docElem.scrollTop  || body.scrollTop,
+			scrollLeft = win.pageXOffset || jQuery.support.boxModel && docElem.scrollLeft || body.scrollLeft,
+			top  = box.top  + scrollTop  - clientTop,
+			left = box.left + scrollLeft - clientLeft;
+
+		return { top: top, left: left };
+	};
+
+} else {
+	jQuery.fn.offset = function( options ) {
+		var elem = this[0];
+
+		if ( options ) {
+			return this.each(function( i ) {
+				jQuery.offset.setOffset( this, options, i );
+			});
+		}
+
+		if ( !elem || !elem.ownerDocument ) {
+			return null;
+		}
+
+		if ( elem === elem.ownerDocument.body ) {
+			return jQuery.offset.bodyOffset( elem );
+		}
+
+		var computedStyle,
+			offsetParent = elem.offsetParent,
+			prevOffsetParent = elem,
+			doc = elem.ownerDocument,
+			docElem = doc.documentElement,
+			body = doc.body,
+			defaultView = doc.defaultView,
+			prevComputedStyle = defaultView ? defaultView.getComputedStyle( elem, null ) : elem.currentStyle,
+			top = elem.offsetTop,
+			left = elem.offsetLeft;
+
+		while ( (elem = elem.parentNode) && elem !== body && elem !== docElem ) {
+			if ( jQuery.offset.supportsFixedPosition && prevComputedStyle.position === "fixed" ) {
+				break;
+			}
+
+			computedStyle = defaultView ? defaultView.getComputedStyle(elem, null) : elem.currentStyle;
+			top  -= elem.scrollTop;
+			left -= elem.scrollLeft;
+
+			if ( elem === offsetParent ) {
+				top  += elem.offsetTop;
+				left += elem.offsetLeft;
+
+				if ( jQuery.offset.doesNotAddBorder && !(jQuery.offset.doesAddBorderForTableAndCells && rtable.test(elem.nodeName)) ) {
+					top  += parseFloat( computedStyle.borderTopWidth  ) || 0;
+					left += parseFloat( computedStyle.borderLeftWidth ) || 0;
+				}
+
+				prevOffsetParent = offsetParent;
+				offsetParent = elem.offsetParent;
+			}
+
+			if ( jQuery.offset.subtractsBorderForOverflowNotVisible && computedStyle.overflow !== "visible" ) {
+				top  += parseFloat( computedStyle.borderTopWidth  ) || 0;
+				left += parseFloat( computedStyle.borderLeftWidth ) || 0;
+			}
+
+			prevComputedStyle = computedStyle;
+		}
+
+		if ( prevComputedStyle.position === "relative" || prevComputedStyle.position === "static" ) {
+			top  += body.offsetTop;
+			left += body.offsetLeft;
+		}
+
+		if ( jQuery.offset.supportsFixedPosition && prevComputedStyle.position === "fixed" ) {
+			top  += Math.max( docElem.scrollTop, body.scrollTop );
+			left += Math.max( docElem.scrollLeft, body.scrollLeft );
+		}
+
+		return { top: top, left: left };
+	};
+}
+
+jQuery.offset = {};
+
+jQuery.each(
+	( "doesAddBorderForTableAndCells doesNotAddBorder " +
+		"doesNotIncludeMarginInBodyOffset subtractsBorderForOverflowNotVisible " +
+		"supportsFixedPosition" ).split(" "), function( i, prop ) {
+
+	jQuery.offset[ prop ] = jQuery.support[ prop ];
+});
+
+jQuery.extend( jQuery.offset, {
+
+	bodyOffset: function( body ) {
+		var top = body.offsetTop,
+			left = body.offsetLeft;
+
+		if ( jQuery.offset.doesNotIncludeMarginInBodyOffset ) {
+			top  += parseFloat( jQuery.css(body, "marginTop") ) || 0;
+			left += parseFloat( jQuery.css(body, "marginLeft") ) || 0;
+		}
+
+		return { top: top, left: left };
+	},
+
+	setOffset: function( elem, options, i ) {
+		var position = jQuery.css( elem, "position" );
+
+		// set position first, in-case top/left are set even on static elem
+		if ( position === "static" ) {
+			elem.style.position = "relative";
+		}
+
+		var curElem = jQuery( elem ),
+			curOffset = curElem.offset(),
+			curCSSTop = jQuery.css( elem, "top" ),
+			curCSSLeft = jQuery.css( elem, "left" ),
+			calculatePosition = (position === "absolute" || position === "fixed") && jQuery.inArray("auto", [curCSSTop, curCSSLeft]) > -1,
+			props = {}, curPosition = {}, curTop, curLeft;
+
+		// need to be able to calculate position if either top or left is auto and position is either absolute or fixed
+		if ( calculatePosition ) {
+			curPosition = curElem.position();
+			curTop = curPosition.top;
+			curLeft = curPosition.left;
+		} else {
+			curTop = parseFloat( curCSSTop ) || 0;
+			curLeft = parseFloat( curCSSLeft ) || 0;
+		}
+
+		if ( jQuery.isFunction( options ) ) {
+			options = options.call( elem, i, curOffset );
+		}
+
+		if (options.top != null) {
+			props.top = (options.top - curOffset.top) + curTop;
+		}
+		if (options.left != null) {
+			props.left = (options.left - curOffset.left) + curLeft;
+		}
+
+		if ( "using" in options ) {
+			options.using.call( elem, props );
+		} else {
+			curElem.css( props );
+		}
+	}
+});
+
+
+jQuery.fn.extend({
+
+	position: function() {
+		if ( !this[0] ) {
+			return null;
+		}
+
+		var elem = this[0],
+
+		// Get *real* offsetParent
+		offsetParent = this.offsetParent(),
+
+		// Get correct offsets
+		offset       = this.offset(),
+		parentOffset = rroot.test(offsetParent[0].nodeName) ? { top: 0, left: 0 } : offsetParent.offset();
+
+		// Subtract element margins
+		// note: when an element has margin: auto the offsetLeft and marginLeft
+		// are the same in Safari causing offset.left to incorrectly be 0
+		offset.top  -= parseFloat( jQuery.css(elem, "marginTop") ) || 0;
+		offset.left -= parseFloat( jQuery.css(elem, "marginLeft") ) || 0;
+
+		// Add offsetParent borders
+		parentOffset.top  += parseFloat( jQuery.css(offsetParent[0], "borderTopWidth") ) || 0;
+		parentOffset.left += parseFloat( jQuery.css(offsetParent[0], "borderLeftWidth") ) || 0;
+
+		// Subtract the two offsets
+		return {
+			top:  offset.top  - parentOffset.top,
+			left: offset.left - parentOffset.left
+		};
+	},
+
+	offsetParent: function() {
+		return this.map(function() {
+			var offsetParent = this.offsetParent || document.body;
+			while ( offsetParent && (!rroot.test(offsetParent.nodeName) && jQuery.css(offsetParent, "position") === "static") ) {
+				offsetParent = offsetParent.offsetParent;
+			}
+			return offsetParent;
+		});
+	}
+});
+
+
+// Create scrollLeft and scrollTop methods
+jQuery.each( ["Left", "Top"], function( i, name ) {
+	var method = "scroll" + name;
+
+	jQuery.fn[ method ] = function( val ) {
+		var elem, win;
+
+		if ( val === undefined ) {
+			elem = this[ 0 ];
+
+			if ( !elem ) {
+				return null;
+			}
+
+			win = getWindow( elem );
+
+			// Return the scroll offset
+			return win ? ("pageXOffset" in win) ? win[ i ? "pageYOffset" : "pageXOffset" ] :
+				jQuery.support.boxModel && win.document.documentElement[ method ] ||
+					win.document.body[ method ] :
+				elem[ method ];
+		}
+
+		// Set the scroll offset
+		return this.each(function() {
+			win = getWindow( this );
+
+			if ( win ) {
+				win.scrollTo(
+					!i ? val : jQuery( win ).scrollLeft(),
+					 i ? val : jQuery( win ).scrollTop()
+				);
+
+			} else {
+				this[ method ] = val;
+			}
+		});
+	};
+});
+
+function getWindow( elem ) {
+	return jQuery.isWindow( elem ) ?
+		elem :
+		elem.nodeType === 9 ?
+			elem.defaultView || elem.parentWindow :
+			false;
+}
+
+
+
+
+// Create width, height, innerHeight, innerWidth, outerHeight and outerWidth methods
+jQuery.each([ "Height", "Width" ], function( i, name ) {
+
+	var type = name.toLowerCase();
+
+	// innerHeight and innerWidth
+	jQuery.fn[ "inner" + name ] = function() {
+		var elem = this[0];
+		return elem ?
+			elem.style ?
+			parseFloat( jQuery.css( elem, type, "padding" ) ) :
+			this[ type ]() :
+			null;
+	};
+
+	// outerHeight and outerWidth
+	jQuery.fn[ "outer" + name ] = function( margin ) {
+		var elem = this[0];
+		return elem ?
+			elem.style ?
+			parseFloat( jQuery.css( elem, type, margin ? "margin" : "border" ) ) :
+			this[ type ]() :
+			null;
+	};
+
+	jQuery.fn[ type ] = function( size ) {
+		// Get window width or height
+		var elem = this[0];
+		if ( !elem ) {
+			return size == null ? null : this;
+		}
+
+		if ( jQuery.isFunction( size ) ) {
+			return this.each(function( i ) {
+				var self = jQuery( this );
+				self[ type ]( size.call( this, i, self[ type ]() ) );
+			});
+		}
+
+		if ( jQuery.isWindow( elem ) ) {
+			// Everyone else use document.documentElement or document.body depending on Quirks vs Standards mode
+			// 3rd condition allows Nokia support, as it supports the docElem prop but not CSS1Compat
+			var docElemProp = elem.document.documentElement[ "client" + name ],
+				body = elem.document.body;
+			return elem.document.compatMode === "CSS1Compat" && docElemProp ||
+				body && body[ "client" + name ] || docElemProp;
+
+		// Get document width or height
+		} else if ( elem.nodeType === 9 ) {
+			// Either scroll[Width/Height] or offset[Width/Height], whichever is greater
+			return Math.max(
+				elem.documentElement["client" + name],
+				elem.body["scroll" + name], elem.documentElement["scroll" + name],
+				elem.body["offset" + name], elem.documentElement["offset" + name]
+			);
+
+		// Get or set width or height on the element
+		} else if ( size === undefined ) {
+			var orig = jQuery.css( elem, type ),
+				ret = parseFloat( orig );
+
+			return jQuery.isNumeric( ret ) ? ret : orig;
+
+		// Set the width or height on the element (default to pixels if value is unitless)
+		} else {
+			return this.css( type, typeof size === "string" ? size : size + "px" );
+		}
+	};
+
+});
+
+
+// Expose jQuery to the global object
+window.jQuery = window.$ = jQuery;
+})(window);
diff --git a/profiles/commons/libraries/modernizr/test/js/lib/jsonselect.js b/profiles/commons/libraries/modernizr/test/js/lib/jsonselect.js
new file mode 100644
index 0000000..84913d0
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/lib/jsonselect.js
@@ -0,0 +1,279 @@
+/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */
+/*
+ * This is the JSONSelect reference implementation, in javascript.
+ */
+(function(exports) {
+
+    var // localize references
+    toString = Object.prototype.toString;
+
+    function jsonParse(str) {
+      try {
+          if(JSON && JSON.parse){
+              return JSON.parse(str);
+          }
+          return (new Function("return " + str))();
+      } catch(e) {
+        te("ijs");
+      }
+    }
+
+    // emitted error codes.
+    var errorCodes = {
+        "ijs": "invalid json string",
+        "mpc": "multiple pseudo classes (:xxx) not allowed",
+        "mepf": "malformed expression in pseudo-function",
+        "nmi": "multiple ids not allowed",
+        "se": "selector expected",
+        "sra": "string required after '.'",
+        "uc": "unrecognized char",
+        "ujs": "unclosed json string",
+        "upc": "unrecognized pseudo class"
+    };
+
+    // throw an error message
+    function te(ec) {
+        throw new Error(errorCodes[ec]);
+    }
+
+    // THE LEXER
+    var toks = {
+        psc: 1, // pseudo class
+        psf: 2, // pseudo class function
+        typ: 3, // type
+        str: 4 // string
+    };
+
+    var pat = /^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/;
+    var exprPat = /^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/;
+    var lex = function (str, off) {
+        if (!off) off = 0;
+        var m = pat.exec(str.substr(off));
+        if (!m) return undefined;
+        off+=m[0].length;
+        var a;
+        if (m[1]) a = [off, " "];
+        else if (m[2]) a = [off, m[0]];
+        else if (m[3]) a = [off, toks.typ, m[0]];
+        else if (m[4]) a = [off, toks.psc, m[0]];
+        else if (m[5]) a = [off, toks.psf, m[0]];
+        else if (m[6]) te("upc");
+        else if (m[7]) a = [off, toks.str, jsonParse(m[0])];
+        else if (m[8]) te("ujs");
+        else if (m[9]) a = [off, toks.str, m[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")];
+        return a;
+    };
+
+    // THE PARSER
+
+    var parse = function (str) {
+        var a = [], off = 0, am;
+
+        while (true) {
+            var s = parse_selector(str, off);
+            a.push(s[1]);
+            s = lex(str, off = s[0]);
+            if (s && s[1] === " ") s = lex(str, off = s[0]);
+            if (!s) break;
+            // now we've parsed a selector, and have something else...
+            if (s[1] === ">") {
+                a.push(">");
+                off = s[0];
+            } else if (s[1] === ",") {
+                if (am === undefined) am = [ ",", a ];
+                else am.push(a);
+                a = [];
+                off = s[0];
+            }
+        }
+        if (am) am.push(a);
+        return am ? am : a;
+    };
+
+    var parse_selector = function(str, off) {
+        var soff = off;
+        var s = { };
+        var l = lex(str, off);
+        // skip space
+        if (l && l[1] === " ") { soff = off = l[0]; l = lex(str, off); }
+        if (l && l[1] === toks.typ) {
+            s.type = l[2];
+            l = lex(str, (off = l[0]));
+        } else if (l && l[1] === "*") {
+            // don't bother representing the universal sel, '*' in the
+            // parse tree, cause it's the default
+            l = lex(str, (off = l[0]));
+        }
+
+        // now support either an id or a pc
+        while (true) {
+            if (l === undefined) {
+                break;
+            } else if (l[1] === ".") {
+                l = lex(str, (off = l[0]));
+                if (!l || l[1] !== toks.str) te("sra");
+                if (s.id) te("nmi");
+                s.id = l[2];
+            } else if (l[1] === toks.psc) {
+                if (s.pc || s.pf) te("mpc");
+                // collapse first-child and last-child into nth-child expressions
+                if (l[2] === ":first-child") {
+                    s.pf = ":nth-child";
+                    s.a = 0;
+                    s.b = 1;
+                } else if (l[2] === ":last-child") {
+                    s.pf = ":nth-last-child";
+                    s.a = 0;
+                    s.b = 1;
+                } else {
+                    s.pc = l[2];
+                }
+            } else if (l[1] === toks.psf) {
+                if (s.pc || s.pf ) te("mpc");
+                s.pf = l[2];
+                var m = exprPat.exec(str.substr(l[0]));
+                if (!m) te("mepf");
+                if (m[5]) {
+                    s.a = 2;
+                    s.b = (m[5] === "odd") ? 1 : 0;
+                } else if (m[6]) {
+                    s.a = 0;
+                    s.b = parseInt(m[6], 10);
+                } else {
+                    s.a = parseInt((m[1] ? m[1] : "+") + (m[2] ? m[2] : "1"),10);
+                    s.b = m[3] ? parseInt(m[3] + m[4],10) : 0;
+                }
+                l[0] += m[0].length;
+            } else {
+                break;
+            }
+            l = lex(str, (off = l[0]));
+        }
+
+        // now if we didn't actually parse anything it's an error
+        if (soff === off) te("se");
+
+        return [off, s];
+    };
+
+    // THE EVALUATOR
+
+    function isArray(o) {
+        return Array.isArray ? Array.isArray(o) : 
+          toString.call(o) === "[object Array]";
+    }
+
+    function mytypeof(o) {
+        if (o === null) return "null";
+        var to = typeof o;
+        if (to === "object" && isArray(o)) to = "array";
+        return to;
+    }
+
+    function mn(node, sel, id, num, tot) {
+        var sels = [];
+        var cs = (sel[0] === ">") ? sel[1] : sel[0];
+        var m = true, mod;
+        if (cs.type) m = m && (cs.type === mytypeof(node));
+        if (cs.id)   m = m && (cs.id === id);
+        if (m && cs.pf) {
+            if (cs.pf === ":nth-last-child") num = tot - num;
+            else num++;
+            if (cs.a === 0) {
+                m = cs.b === num;
+            } else {
+                mod = ((num - cs.b) % cs.a);
+
+                m = (!mod && ((num*cs.a + cs.b) >= 0));
+            }
+        }
+
+        // should we repeat this selector for descendants?
+        if (sel[0] !== ">" && sel[0].pc !== ":root") sels.push(sel);
+
+        if (m) {
+            // is there a fragment that we should pass down?
+            if (sel[0] === ">") { if (sel.length > 2) { m = false; sels.push(sel.slice(2)); } }
+            else if (sel.length > 1) { m = false; sels.push(sel.slice(1)); }
+        }
+
+        return [m, sels];
+    }
+
+    function forEach(sel, obj, fun, id, num, tot) {
+        var a = (sel[0] === ",") ? sel.slice(1) : [sel],
+        a0 = [],
+        call = false,
+        i = 0, j = 0, l = 0, k, x;
+        for (i = 0; i < a.length; i++) {
+            x = mn(obj, a[i], id, num, tot);
+            if (x[0]) {
+                call = true;
+            }
+            for (j = 0; j < x[1].length; j++) {
+                a0.push(x[1][j]);
+            }
+        }
+        if (a0.length && typeof obj === "object") {
+            if (a0.length >= 1) {
+                a0.unshift(",");
+            }
+            if (isArray(obj)) {
+                for (i = 0; i < obj.length; i++) {
+                    forEach(a0, obj[i], fun, undefined, i, obj.length);
+                }
+            } else {
+                // it's a shame to do this for :last-child and other
+                // properties which count from the end when we don't
+                // even know if they're present.  Also, the stream
+                // parser is going to be pissed.
+                l = 0;
+                for (k in obj) {
+                    if (obj.hasOwnProperty(k)) {
+                        l++;
+                    }
+                }
+                i = 0;
+                for (k in obj) {
+                    if (obj.hasOwnProperty(k)) {
+                        forEach(a0, obj[k], fun, k, i++, l);
+                    }
+                }
+            }
+        }
+        if (call && fun) {
+            fun(obj);
+        }
+    }
+
+    function match(sel, obj) {
+        var a = [];
+        forEach(sel, obj, function(x) {
+            a.push(x);
+        });
+        return a;
+    }
+
+    function compile(sel) {
+        return {
+            sel: parse(sel),
+            match: function(obj){
+                return match(this.sel, obj);
+            },
+            forEach: function(obj, fun) {
+                return forEach(this.sel, obj, fun);
+            }
+        };
+    }
+
+    exports._lex = lex;
+    exports._parse = parse;
+    exports.match = function (sel, obj) {
+        return compile(sel).match(obj);
+    };
+    exports.forEach = function(sel, obj, fun) {
+        return compile(sel).forEach(obj, fun);
+    };
+    exports.compile = compile;
+})(typeof exports === "undefined" ? (window.JSONSelect = {}) : exports);
+
diff --git a/profiles/commons/libraries/modernizr/test/js/lib/polyfills.js b/profiles/commons/libraries/modernizr/test/js/lib/polyfills.js
new file mode 100644
index 0000000..4cbb1aa
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/lib/polyfills.js
@@ -0,0 +1,96 @@
+
+// Array.prototype.indexOf  polyfill
+if (!Array.prototype.indexOf){
+  Array.prototype.indexOf = function(searchElement /*, fromIndex */)
+  {
+    "use strict";
+
+    if (this === void 0 || this === null)
+      throw new TypeError();
+
+    var t = Object(this);
+    var len = t.length >>> 0;
+    if (len === 0)
+      return -1;
+
+    var n = 0;
+    if (arguments.length > 0)
+    {
+      n = Number(arguments[1]);
+      if (n !== n) // shortcut for verifying if it's NaN
+        n = 0;
+      else if (n !== 0 && n !== (1 / 0) && n !== -(1 / 0))
+        n = (n > 0 || -1) * Math.floor(Math.abs(n));
+    }
+
+    if (n >= len)
+      return -1;
+
+    var k = n >= 0
+          ? n
+          : Math.max(len - Math.abs(n), 0);
+
+    for (; k < len; k++)
+    {
+      if (k in t && t[k] === searchElement)
+        return k;
+    }
+    return -1;
+  };
+}
+
+
+// Object.keys()
+if (!Object.keys) Object.keys = function(o){
+  if (o !== Object(o)) throw new TypeError('Object.keys called on non-object');
+  var ret=[], p;
+  for (p in o) if(Object.prototype.hasOwnProperty.call(o,p)) ret.push(p);
+  return ret;
+};
+
+
+
+if (!Array.prototype.map)
+{
+  Array.prototype.map = function(fun /*, thisp */)
+  {
+    "use strict";
+
+    if (this === void 0 || this === null)
+      throw new TypeError();
+
+    var t = Object(this);
+    var len = t.length >>> 0;
+    if (typeof fun !== "function")
+      throw new TypeError();
+
+    var res = new Array(len);
+    var thisp = arguments[1];
+    for (var i = 0; i < len; i++)
+    {
+      if (i in t)
+        res[i] = fun.call(thisp, t[i], i, t);
+    }
+
+    return res;
+  };
+}
+
+
+
+
+/*!
+    http://www.JSON.org/json2.js
+    2011-10-19
+
+    Public Domain.
+
+    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.
+
+    See http://www.JSON.org/js.html
+
+    This code should be minified before deployment.
+    See http://javascript.crockford.com/jsmin.html
+
+*/
+var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());
diff --git a/profiles/commons/libraries/modernizr/test/js/lib/uaparser.js b/profiles/commons/libraries/modernizr/test/js/lib/uaparser.js
new file mode 100644
index 0000000..eb70eb9
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/lib/uaparser.js
@@ -0,0 +1,215 @@
+// uaparser by lindsey simon,
+// ported to node by tobie
+// https://github.com/tobie/ua-parser/
+
+// browserized by paul irish
+
+(function(exports){
+
+  exports.uaparse = parse;
+  
+  function parse(ua) {
+    for (var i=0; i < parsers.length; i++) {
+      var result = parsers[i](ua);
+      if (result) { return result; }
+    }
+    return new UserAgent();
+  }
+
+  function UserAgent(family) {
+    this.family = family || 'Other';
+  }
+
+  UserAgent.prototype.toVersionString = function() {
+    var output = '';
+    if (this.major != null) {
+      output += this.major;
+      if (this.minor != null) {
+        output += '.' + this.minor;
+        if (this.patch != null) {
+          output += '.' + this.patch;
+        }
+      }
+    }
+    return output;
+  };
+
+  UserAgent.prototype.toString = function() {
+    var suffix = this.toVersionString();
+    if (suffix) { suffix = ' ' + suffix; }
+    return this.family + suffix;
+  };
+  
+  
+  var regexes = [
+      {"pattern":"^(Opera)/(\\d+)\\.(\\d+) \\(Nintendo Wii",
+       "v1_replacement":null,
+       "family_replacement":"Wii"},
+      {"pattern":"(Namoroka|Shiretoko|Minefield)/(\\d+)\\.(\\d+)\\.(\\d+(?:pre)?)",
+       "v1_replacement":null,
+       "family_replacement":"Firefox ($1)"},
+      {"pattern":"(Namoroka|Shiretoko|Minefield)/(\\d+)\\.(\\d+)([ab]\\d+[a-z]*)?",
+       "v1_replacement":null,
+       "family_replacement":"Firefox ($1)"},
+      {"pattern":"(SeaMonkey|Fennec|Camino)/(\\d+)\\.(\\d+)([ab]?\\d+[a-z]*)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Flock)/(\\d+)\\.(\\d+)(b\\d+?)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Fennec)/(\\d+)\\.(\\d+)(pre)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Navigator)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Netscape"},
+      {"pattern":"(Navigator)/(\\d+)\\.(\\d+)([ab]\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Netscape"},
+      {"pattern":"(Netscape6)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Netscape"},
+      {"pattern":"(MyIBrow)/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"My Internet Browser"},
+      {"pattern":"(Firefox).*Tablet browser (\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"MicroB"},
+      {"pattern":"(Opera)/9.80.*Version\\/(\\d+)\\.(\\d+)(?:\\.(\\d+))?",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Firefox)/(\\d+)\\.(\\d+)\\.(\\d+(?:pre)?) \\(Swiftfox\\)",
+       "v1_replacement":null,
+       "family_replacement":"Swiftfox"},
+      {"pattern":"(Firefox)/(\\d+)\\.(\\d+)([ab]\\d+[a-z]*)? \\(Swiftfox\\)",
+       "v1_replacement":null,
+       "family_replacement":"Swiftfox"},
+      {"pattern":"(konqueror)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Konqueror"},
+      {"pattern":"(Jasmine|ANTGalio|Midori|Fresco|Lobo|Maxthon|Lynx|OmniWeb|Dillo|Camino|Demeter|Fluid|Fennec|Shiira|Sunrise|Chrome|Flock|Netscape|Lunascape|Epiphany|WebPilot|Vodafone|NetFront|Konqueror|SeaMonkey|Kazehakase|Vienna|Iceape|Iceweasel|IceWeasel|Iron|K-Meleon|Sleipnir|Galeon|GranParadiso|Opera Mini|iCab|NetNewsWire|Iron|Iris)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Bolt|Jasmine|Maxthon|Lynx|Arora|IBrowse|Dillo|Camino|Shiira|Fennec|Phoenix|Chrome|Flock|Netscape|Lunascape|Epiphany|WebPilot|Opera Mini|Opera|Vodafone|NetFront|Konqueror|SeaMonkey|Kazehakase|Vienna|Iceape|Iceweasel|IceWeasel|Iron|K-Meleon|Sleipnir|Galeon|GranParadiso|iCab|NetNewsWire|Iron|Space Bison|Stainless|Orca)/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(iRider|Crazy Browser|SkipStone|iCab|Lunascape|Sleipnir|Maemo Browser) (\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(iCab|Lunascape|Opera|Android) (\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(IEMobile) (\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"IE Mobile"},
+      {"pattern":"(Firefox)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Firefox)/(\\d+)\\.(\\d+)(pre|[ab]\\d+[a-z]*)?",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Obigo|OBIGO)[^\\d]*(\\d+)(?:.(\\d+))?",
+       "v1_replacement":null,
+       "family_replacement":"Obigo"},
+      {"pattern":"(MAXTHON|Maxthon) (\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Maxthon"},
+      {"pattern":"(Maxthon|MyIE2|Uzbl|Shiira)",
+       "v1_replacement":"0",
+       "family_replacement":null},
+      {"pattern":"(PLAYSTATION) (\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"PlayStation"},
+      {"pattern":"(PlayStation Portable)[^\\d]+(\\d+).(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(BrowseX) \\((\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Opera)/(\\d+)\\.(\\d+).*Opera Mobi",
+       "v1_replacement":null,
+       "family_replacement":"Opera Mobile"},
+      {"pattern":"(POLARIS)/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Polaris"},
+      {"pattern":"(BonEcho)/(\\d+)\\.(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Bon Echo"},
+      {"pattern":"(iPhone) OS (\\d+)_(\\d+)(?:_(\\d+))?",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Avant)",
+       "v1_replacement":"1",
+       "family_replacement":null},
+      {"pattern":"(Nokia)[EN]?(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Black[bB]erry)(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Blackberry"},
+      {"pattern":"(OmniWeb)/v(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Blazer)/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Palm Blazer"},
+      {"pattern":"(Pre)/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"Palm Pre"},
+      {"pattern":"(Links) \\((\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(QtWeb) Internet Browser/(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(Version)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?.*Safari/",
+       "v1_replacement":null,
+       "family_replacement":"Safari"},
+      {"pattern":"(OLPC)/Update(\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(OLPC)/Update()\\.(\\d+)",
+       "v1_replacement":"0",
+       "family_replacement":null},
+      {"pattern":"(SamsungSGHi560)",
+       "v1_replacement":null,
+       "family_replacement":"Samsung SGHi560"},
+      {"pattern":"^(SonyEricssonK800i)",
+       "v1_replacement":null,
+       "family_replacement":"Sony Ericsson K800i"},
+      {"pattern":"(Teleca Q7)",
+       "v1_replacement":null,
+       "family_replacement":null},
+      {"pattern":"(MSIE) (\\d+)\\.(\\d+)",
+       "v1_replacement":null,
+       "family_replacement":"IE"}
+
+  ];
+  
+  var parsers = regexes.map(function(obj) {
+    var regexp = new RegExp(obj.pattern),
+        famRep = obj.family_replacement,
+        v1Rep = obj.v1_replacement;
+
+    function parser(ua) {
+      var m = ua.match(regexp);
+
+      if (!m) { return null; }
+
+      var familly = famRep ? famRep.replace('$1', m[1]) : m[1];
+
+      var obj = new UserAgent(familly);
+      obj.major = parseInt(v1Rep ? v1Rep : m[2]);
+      obj.minor = m[3] ? parseInt(m[3]) : null;
+      obj.patch = m[4] ? parseInt(m[4]) : null;
+
+      return obj;
+    }
+
+    return parser;
+  });
+  
+  
+})(window);
+
+
diff --git a/profiles/commons/libraries/modernizr/test/js/setup.js b/profiles/commons/libraries/modernizr/test/js/setup.js
new file mode 100644
index 0000000..b194dcd
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/setup.js
@@ -0,0 +1,44 @@
+
+// Avoid `console` errors in browsers that lack a console
+if (!(window.console && console.log)) {
+    (function() {
+        var noop = function() {};
+        var methods = ['assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error', 'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log', 'markTimeline', 'profile', 'profileEnd', 'markTimeline', 'table', 'time', 'timeEnd', 'timeStamp', 'trace', 'warn'];
+        var length = methods.length;
+        var console = window.console = {};
+        while (length--) {
+            console[methods[length]] = noop;
+        }
+    }());
+}
+
+// test helper object
+window.TEST = {
+  // note some unique members of the Modernizr object
+  inputs    : ['input','inputtypes', 'textarea'],
+  audvid    : ['video','audio'],
+  API       : ['addTest', 'mq', 'hasEvent', 'testProp', 'testAllProps', 'testStyles', '_prefixes', '_domPrefixes', '_cssomPrefixes', 'prefixed'],
+  extraclass: ['js'],
+  privates  : ['_enableHTML5','_version','_fontfaceready'],
+  deprecated : [
+                { oldish : 'crosswindowmessaging', newish : 'postmessage'},
+                { oldish : 'historymanagement', newish : 'history'},
+              ],
+
+  // utility methods
+  inArray: function(elem, array) {
+      if (array.indexOf) {
+          return array.indexOf(elem);
+      }
+      for (var i = 0, length = array.length; i < length; i++) {
+          if (array[i] === elem) {
+              return i;
+          }
+      }
+      return -1;
+  },
+  trim : function(str){
+    return str.replace(/^\s*/, "").replace(/\s*$/, "");
+  }
+};
+
diff --git a/profiles/commons/libraries/modernizr/test/js/unit-caniuse.js b/profiles/commons/libraries/modernizr/test/js/unit-caniuse.js
new file mode 100644
index 0000000..78bda30
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/unit-caniuse.js
@@ -0,0 +1,191 @@
+
+
+var myscript = document.createElement('script'),
+    ref = document.getElementsByTagName('script')[0];
+
+myscript.src = 'http://caniuse.com/jsonp.php?callback=caniusecb';
+
+setTimeout(function(){
+  ref.parentNode.insertBefore(myscript, ref);
+}, 100);
+
+// mapping Modernizr terms over to caniuse terms
+var map = {
+  audio : 'audio',
+  borderimage : 'border-image',
+  borderradius : 'border-radius',
+  canvas : 'canvas',
+  canvastext : 'canvas-text',
+  cssanimations : 'css-animation',
+  boxshadow : 'css-boxshadow',
+  cssgradients : 'css-gradients',
+  opacity : 'css-opacity',
+  cssreflections : 'css-reflections',
+  textshadow : 'css-textshadow',
+  csstransitions : 'css-transitions',
+  hsla : 'css3-colors',
+  rgba : 'css3-colors',
+  draganddrop : 'dragndrop',
+  flexbox : 'flexbox',
+  fontface : 'fontface',
+  geolocation : 'geolocation',
+  hashchange : 'hashchange',
+  history : 'history',
+  indexeddb : 'indexeddb',
+  multiplebgs : 'multibackgrounds',
+  csscolumns : 'multicolumn',
+  localstorage : 'namevalue-storage',
+  applicationcache : 'offline-apps',
+  websqldatabase : 'sql-storage',
+  svg : 'svg',
+  touch : 'touch',
+  csstransforms : 'transforms2d',
+  csstransforms3d : 'transforms3d',
+  video: 'video',
+  webgl: 'webgl',
+  websockets : 'websockets',
+  webworkers : 'webworkers',
+  postmessage : 'x-doc-messaging'
+};
+
+window.caniusecb = function(scriptdata) {
+
+  window.doo = scriptdata;
+
+  // quit if JSONSelect didn't make it.
+  if (!window.JSONSelect) return;
+
+  var testdata     = scriptdata.data,
+
+      // parse the current UA with uaparser
+      ua           = uaparse(navigator.userAgent),
+
+      // match the UA from uaparser into the browser used by caniuse
+      browserKey   = JSONSelect.match('.agents .browser', scriptdata).indexOf(ua.family),
+      currBrowser  = Object.keys(scriptdata.agents)[browserKey];
+
+  // So Phantom doesn't kill the caniuse.com matching exit out as it's useless anyway within PhantomJS
+  if(navigator.userAgent.indexOf("PhantomJS") != -1) {
+    return;
+  }
+
+  // translate 'y' 'n' or 'a' into a boolean that Modernizr uses
+  function bool(ciuresult){
+    if (ciuresult == 'y' || ciuresult == 'a') return true;
+    // 'p' is for polyfill
+    if (ciuresult == 'n' || ciuresult == 'p') return false;
+    throw 'unknown return value from can i use';
+  }
+
+  function testify(o){
+
+    var ciubool = bool(o.ciuresult);
+
+    // caniuse says audio/video are yes/no, Modernizr has more detail which we'll dumb down.
+    if (~TEST.audvid.indexOf(o.feature))
+      o.result = !!o.result;
+
+    // if caniuse gave us a 'partial', lets let it pass with a note.
+    if (o.ciuresult == 'a'){
+      return ok(true,
+        o.browser + o.version + ': Caniuse reported partial support for ' + o.ciufeature +
+        '. So.. Modernizr\'s ' + o.result + ' is good enough...'
+      );
+    }
+
+
+    // change the *documented* false positives
+    if ((o.feature == 'textshadow' && o.browser == 'firefox' && o.version == 3)
+        && ciubool == false
+    ) {
+      ciubool = o.fp = true;
+    }
+
+    // where we actually do most our assertions
+    equal(o.result, ciubool,
+      o.browser + o.version + ': Caniuse result for ' + o.ciufeature +
+      ' matches Modernizr\'s ' + (o.fp ? '*false positive*' : 'result') + ' for ' + o.feature
+    );
+  }
+
+
+  module('caniuse.com data matches', {
+      setup:function() {
+      },
+      teardown:function() {
+      }
+  });
+
+
+  test("we match caniuse data", function() {
+
+    for (var feature in Modernizr){
+
+      var ciufeatname = map[feature];
+
+      if (ciufeatname === undefined) continue;
+
+      var ciufeatdata = testdata[ciufeatname];
+
+      if (ciufeatdata === undefined) throw 'unknown key of caniusedata';
+
+      // get results for this feature for all versions of this browser
+      var browserResults = ciufeatdata.stats[currBrowser];
+
+      // let's get our versions in order..
+      var minorver   = ua.minor &&                                  // caniuse doesn't use two digit minors
+                       ua.minor.toString().replace(/(\d)\d$/,'$1'), // but opera does.
+
+          majorminor = (ua.major + '.' + minorver)
+                          // opera gets grouped in some cases by caniuse
+                          .replace(/(9\.(6|5))/ , ua.family == 'opera' ? '9.5-9.6'   : "$1")
+                          .replace(/(10\.(0|1))/, ua.family == 'opera' ? '10.0-10.1' : "$1"),
+
+          mmResult   = browserResults[majorminor],
+          mResult    = browserResults[ua.major];
+
+
+      // check it against the major.minor: eg. FF 3.6
+      if (mmResult && mmResult != 'u'){ // 'y' 'n' or 'a'
+
+        // data ends w/ ` x` if its still prefixed in the imp
+        mmResult = mmResult.replace(' x','');
+
+        // match it against our data.
+        testify({ feature     : feature
+                , ciufeature  : ciufeatname
+                , result      : Modernizr[feature]
+                , ciuresult   : mmResult
+                , browser     : currBrowser
+                , version     : majorminor
+        });
+
+        continue; // don't check the major version
+      }
+
+      // check it against just the major version: eg. FF 3
+      if (mResult){
+
+        // unknown support from caniuse... He would probably like to know our data, though!
+        if (mResult == 'u') continue;
+
+        // data ends w/ ` x` if its still prefixed in the imp
+        mResult = mResult.replace(' x','');
+
+        testify({ feature     : feature
+                , ciufeature  : ciufeatname
+                , result      : Modernizr[feature]
+                , ciuresult   : mResult
+                , browser     : currBrowser
+                , version     : ua.major
+        });
+
+
+      }
+
+    } // for in loop
+
+  }); // eo test()
+
+
+}; // eo caniusecallback()
diff --git a/profiles/commons/libraries/modernizr/test/js/unit.js b/profiles/commons/libraries/modernizr/test/js/unit.js
new file mode 100644
index 0000000..a907ba8
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/js/unit.js
@@ -0,0 +1,669 @@
+QUnit.begin = function() {
+	console.log("Starting test suite");
+	console.log("================================================\n");
+};
+
+QUnit.moduleDone = function(opts) {
+	if(opts.failed === 0) {
+		console.log("\u2714 All tests passed in '"+opts.name+"' module");
+	} else {
+		console.log("\u2716 "+ opts.failed +" tests failed in '"+opts.name+"' module");
+	}
+};
+
+QUnit.done = function(opts) {
+	console.log("\n================================================");
+	console.log("Tests completed in "+opts.runtime+" milliseconds");
+	console.log(opts.passed + " tests of "+opts.total+" passed, "+opts.failed+" failed.");
+};
+
+module('Basics', {
+    setup:function() {
+    },
+    teardown:function() {
+    }
+});
+
+test("globals set up", function() {
+
+	ok(window.Modernizr, 'global modernizr object created');
+
+});
+
+test("bind is implemented", function() {
+
+  ok(Function.prototype.bind, 'bind is a member of Function.prototype');
+
+  var a = function(){
+      return this.modernizr;
+  };
+  a = a.bind({modernizr: 'just awsome'});
+
+  equal("just awsome", a(), 'bind works as expected');
+
+
+  // thank you webkit layoutTests
+
+
+  var result;
+
+  function F(x, y)
+  {
+      result = this + " -> x:" + x + ", y:" + y;
+  }
+
+  G = F.bind("'a'", "'b'");
+  H = G.bind("'Cannot rebind this!'", "'c'");
+
+  G(1,2);
+  equal(result, "\'a\' -> x:\'b\', y:1");
+  H(1,2);
+  equal(result, "\'a\' -> x:\'b\', y:\'c\'");
+
+  var f = new F(1,2);
+  equal(result, "[object Object] -> x:1, y:2");
+  var g = new G(1,2);
+  equal(result, "[object Object] -> x:\'b\', y:1");
+  var h = new H(1,2);
+  equal(result, "[object Object] -> x:\'b\', y:\'c\'");
+
+  ok(f instanceof F, "f instanceof F");
+  ok(g instanceof F, "g instanceof F");
+  ok(h instanceof F, "h instanceof F");
+
+  // Bound functions don't have a 'prototype' property.
+  ok("prototype" in F, '"prototype" in F');
+
+  // The object passed to bind as 'this' must be callable.
+  raises(function(){
+    Function.bind.call(undefined);
+  });
+
+  // Objects that allow call but not construct can be bound, but should throw if used with new.
+  var abcAt = String.prototype.charAt.bind("abc");
+  equal(abcAt(1), "b", 'Objects that allow call but not construct can be bound...');
+
+  equal(1, Function.bind.length, 'it exists');
+
+
+});
+
+
+
+test("document.documentElement is valid and correct",1, function() {
+	equal(document.documentElement,document.getElementsByTagName('html')[0]);
+});
+
+
+test("no-js class is gone.", function() {
+
+	ok(!/(?:^|\s)no-js(?:^|\s)/.test(document.documentElement.className),
+	   'no-js class is gone');
+
+	ok(/(?:^|\s)js(?:^|\s)/.test(document.documentElement.className),
+	   'html.js class is present');
+
+	ok(/(?:^|\s)\+no-js(?:\s|$)/.test(document.documentElement.className),
+	   'html.+no-js class is still present');
+
+	ok(/(?:^|\s)no-js-(?:\s|$)/.test(document.documentElement.className),
+	   'html.no-js- class is still present');
+
+	ok(/(?:^|\s)i-has-no-js(?:\s|$)/.test(document.documentElement.className),
+	   'html.i-has-no-js class is still present');
+
+	if (document.querySelector){
+	  ok(document.querySelector('html.js') == document.documentElement,
+	     "document.querySelector('html.js') matches.");
+	}
+});
+
+test('html shim worked', function(){
+  expect(2);
+
+  // the exact test we use in the script
+  var elem = document.getElementsByTagName("section")[0];
+  elem.id = "html5section";
+
+  ok( elem.childNodes.length === 1 , 'unknown elements dont collapse');
+
+  elem.style.color = 'red';
+  ok( /red|#ff0000/i.test(elem.style.color), 'unknown elements are styleable')
+
+});
+
+
+module('Modernizr classes and bools', {
+    setup:function() {
+    },
+    teardown:function() {
+    }
+});
+
+
+test('html classes are looking good',function(){
+
+  var classes = TEST.trim(document.documentElement.className).split(/\s+/);
+
+  var modprops = Object.keys(Modernizr),
+      newprops = modprops;
+
+  // decrement for the properties that are private
+  for (var i = -1, len = TEST.privates.length; ++i < len; ){
+    var item = TEST.privates[i];
+    equal(-1, TEST.inArray(item, classes), 'private Modernizr object '+ item +'should not have matching classes');
+    equal(-1, TEST.inArray('no-' + item, classes), 'private Modernizr object no-'+item+' should not have matching classes');
+  }
+
+  // decrement for the non-boolean objects
+//  for (var i = -1, len = TEST.inputs.length; ++i < len; ){
+//    if (Modernizr[TEST.inputs[i]] != undefined) newprops--;
+//  }
+
+  // TODO decrement for the extraclasses
+
+  // decrement for deprecated ones.
+  $.each( TEST.deprecated, function(key, val){
+    newprops.splice(  TEST.inArray(item, newprops), 1);
+  });
+
+
+  //equal(classes,newprops,'equal number of classes and global object props');
+
+  if (classes.length !== newprops){
+    //window.console && console.log(classes, newprops);
+
+  }
+
+  for (var i = 0, len = classes.length, aclass; i <len; i++){
+    aclass = classes[i];
+
+    // Skip js related classes.
+    if (/^(?:js|\+no-js|no-js-|i-has-no-js)$/.test(aclass)) continue;
+
+    if (aclass.indexOf('no-') === 0){
+      aclass = aclass.replace('no-','');
+
+      equal(Modernizr[aclass], false,
+            aclass + ' is correctly false in the classes and object')
+
+    } else {
+      equal(Modernizr[aclass], true,
+             aclass + ' is correctly true in the classes and object')
+    }
+  }
+
+
+  for (var i = 0, len = classes.length, aclass; i <len; i++){
+    equal(classes[i],classes[i].toLowerCase(),'all classes are lowerCase.');
+  }
+
+  // Remove fake no-js classes before test.
+  var docElClass = document.documentElement.className;
+  $.each(['\\+no-js', 'no-js-', 'i-has-no-js'], function(i, fakeClass) {
+    docElClass = docElClass.replace(new RegExp('(^|\\s)' + fakeClass + '(\\s|$)', 'g'), '$1$2');
+  });
+  equal(/[^\s]no-/.test(docElClass), false, 'whitespace between all classes.');
+
+
+})
+
+
+test('Modernizr properties are looking good',function(){
+
+  var count  = 0,
+      nobool = TEST.API.concat(TEST.inputs)
+                       .concat(TEST.audvid)
+                       .concat(TEST.privates)
+                       .concat(['textarea']); // due to forms-placeholder.js test
+
+  for (var prop in window.Modernizr){
+    if (Modernizr.hasOwnProperty(prop)){
+
+      if (TEST.inArray(prop,nobool) >= 0) continue;
+
+      ok(Modernizr[prop] === true || Modernizr[prop] === false,
+        'Modernizr.'+prop+' is a straight up boolean');
+
+
+      equal(prop,prop.toLowerCase(),'all properties are lowerCase.')
+    }
+  }
+})
+
+
+
+test('Modernizr.audio and Modernizr.video',function(){
+
+  for (var i = -1, len = TEST.audvid.length; ++i < len;){
+    var prop = TEST.audvid[i];
+
+    if (Modernizr[prop].toString() == 'true'){
+
+      ok(Modernizr[prop],                             'Modernizr.'+prop+' is truthy.');
+      equal(Modernizr[prop] == true,true,            'Modernizr.'+prop+' is == true')
+      equal(typeof Modernizr[prop] === 'object',true,'Moderizr.'+prop+' is truly an object');
+      equal(Modernizr[prop] !== true,true,           'Modernizr.'+prop+' is !== true')
+
+    } else {
+
+      equal(Modernizr[prop] != true,true,            'Modernizr.'+prop+' is != true')
+    }
+  }
+
+
+});
+
+
+test('Modernizr results match expected values',function(){
+
+  // i'm bringing over a few tests from inside Modernizr.js
+  equal(!!document.createElement('canvas').getContext,Modernizr.canvas,'canvas test consistent');
+
+  equal(!!window.Worker,Modernizr.webworkers,'web workers test consistent')
+
+});
+
+
+
+module('Modernizr\'s API methods', {
+    setup:function() {
+    },
+    teardown:function() {
+    }
+});
+
+test('Modernizr.addTest()',22,function(){
+
+  var docEl = document.documentElement;
+
+
+  Modernizr.addTest('testtrue',function(){
+    return true;
+  });
+
+  Modernizr.addTest('testtruthy',function(){
+    return 100;
+  });
+
+  Modernizr.addTest('testfalse',function(){
+    return false;
+  });
+
+  Modernizr.addTest('testfalsy',function(){
+    return undefined;
+  });
+
+  ok(docEl.className.indexOf(' testtrue') >= 0,'positive class added');
+  equal(Modernizr.testtrue,true,'positive prop added');
+
+  ok(docEl.className.indexOf(' testtruthy') >= 0,'positive class added');
+  equal(Modernizr.testtruthy,100,'truthy value is not casted to straight boolean');
+
+  ok(docEl.className.indexOf(' no-testfalse') >= 0,'negative class added');
+  equal(Modernizr.testfalse,false,'negative prop added');
+
+  ok(docEl.className.indexOf(' no-testfalsy') >= 0,'negative class added');
+  equal(Modernizr.testfalsy,undefined,'falsy value is not casted to straight boolean');
+
+
+
+  Modernizr.addTest('testcamelCase',function(){
+     return true;
+   });
+
+  ok(docEl.className.indexOf(' testcamelCase') === -1,
+     'camelCase test name toLowerCase()\'d');
+
+
+  // okay new signature for this API! woo
+
+  Modernizr.addTest('testboolfalse', false);
+
+  ok(~docEl.className.indexOf(' no-testboolfalse'), 'Modernizr.addTest(feature, bool): negative class added');
+  equal(Modernizr.testboolfalse, false, 'Modernizr.addTest(feature, bool): negative prop added');
+
+
+
+  Modernizr.addTest('testbooltrue', true);
+
+  ok(~docEl.className.indexOf(' testbooltrue'), 'Modernizr.addTest(feature, bool): positive class added');
+  equal(Modernizr.testbooltrue, true, 'Modernizr.addTest(feature, bool): positive prop added');
+
+
+
+  Modernizr.addTest({'testobjboolfalse': false,
+                     'testobjbooltrue' : true   });
+
+  ok(~docEl.className.indexOf(' no-testobjboolfalse'), 'Modernizr.addTest({feature: bool}): negative class added');
+  equal(Modernizr.testobjboolfalse, false, 'Modernizr.addTest({feature: bool}): negative prop added');
+
+  ok(~docEl.className.indexOf(' testobjbooltrue'), 'Modernizr.addTest({feature: bool}): positive class added');
+  equal(Modernizr.testobjbooltrue, true, 'Modernizr.addTest({feature: bool}): positive prop added');
+
+
+
+
+  Modernizr.addTest({'testobjfnfalse': function(){ return false },
+                     'testobjfntrue' : function(){ return true }   });
+
+
+  ok(~docEl.className.indexOf(' no-testobjfnfalse'), 'Modernizr.addTest({feature: bool}): negative class added');
+  equal(Modernizr.testobjfnfalse, false, 'Modernizr.addTest({feature: bool}): negative prop added');
+
+  ok(~docEl.className.indexOf(' testobjfntrue'), 'Modernizr.addTest({feature: bool}): positive class added');
+  equal(Modernizr.testobjfntrue, true, 'Modernizr.addTest({feature: bool}): positive prop added');
+
+
+  Modernizr
+    .addTest('testchainone', true)
+    .addTest({ testchaintwo: true })
+    .addTest('testchainthree', function(){ return true; });
+
+  ok( Modernizr.testchainone == Modernizr.testchaintwo == Modernizr.testchainthree, 'addTest is chainable');
+
+
+}); // eo addTest
+
+
+
+
+
+test('Modernizr.mq: media query testing',function(){
+
+  var $html = $('html');
+  $.mobile = {};
+
+  // from jquery mobile
+
+  $.mobile.media = (function() {
+  	// TODO: use window.matchMedia once at least one UA implements it
+  	var cache = {},
+  		testDiv = $( "<div id='jquery-mediatest'>" ),
+  		fakeBody = $( "<body>" ).append( testDiv );
+
+  	return function( query ) {
+  		if ( !( query in cache ) ) {
+  			var styleBlock = document.createElement('style'),
+          		cssrule = "@media " + query + " { #jquery-mediatest { position:absolute; } }";
+  	        //must set type for IE!
+  	        styleBlock.type = "text/css";
+  	        if (styleBlock.styleSheet){
+  	          styleBlock.styleSheet.cssText = cssrule;
+  	        }
+  	        else {
+  	          styleBlock.appendChild(document.createTextNode(cssrule));
+  	        }
+
+  			$html.prepend( fakeBody ).prepend( styleBlock );
+  			cache[ query ] = testDiv.css( "position" ) === "absolute";
+  			fakeBody.add( styleBlock ).remove();
+  		}
+  		return cache[ query ];
+  	};
+  })();
+
+
+  ok(Modernizr.mq,'Modernizr.mq() doesn\' freak out.');
+
+  equal($.mobile.media('only screen'), Modernizr.mq('only screen'),'screen media query matches jQuery mobile\'s result');
+
+  equal(Modernizr.mq('only all'), Modernizr.mq('only all'), 'Cache hit matches');
+
+
+});
+
+
+
+
+test('Modernizr.hasEvent()',function(){
+
+  ok(typeof Modernizr.hasEvent == 'function','Modernizr.hasEvent() is a function');
+
+
+  equal(Modernizr.hasEvent('click'), true,'click event is supported');
+
+  equal(Modernizr.hasEvent('modernizrcustomevent'), false,'random event is definitely not supported');
+
+  /* works fine in webkit but not gecko
+  equal(  Modernizr.hasEvent('resize', window),
+          !Modernizr.hasEvent('resize', document.createElement('div')),
+          'Resize is supported in window but not a div, typically...');
+  */
+
+});
+
+
+
+
+
+test('Modernizr.testStyles()',function(){
+
+  equal(typeof Modernizr.testStyles, 'function','Modernizr.testStyles() is a function');
+
+  var style = '#modernizr{ width: 9px; height: 4px; font-size: 0; color: papayawhip; }';
+
+  Modernizr.testStyles(style, function(elem, rule){
+      equal(style, rule, 'rule passsed back matches what i gave it.')
+      equal(elem.offsetWidth, 9, 'width was set through the style');
+      equal(elem.offsetHeight, 4, 'height was set through the style');
+      equal(elem.id, 'modernizr', 'element is indeed the modernizr element');
+  });
+
+});
+
+
+test('Modernizr._[properties]',function(){
+
+  equal(6, Modernizr._prefixes.length, 'Modernizr._prefixes has 6 items');
+
+  equal(4, Modernizr._domPrefixes.length, 'Modernizr.domPrefixes has 4 items');
+
+});
+
+test('Modernizr.testProp()',function(){
+
+  equal(true, Modernizr.testProp('margin'), 'Everyone supports margin');
+
+  equal(false, Modernizr.testProp('happiness'), 'Nobody supports the happiness style. :(');
+  equal(true, Modernizr.testProp('fontSize'), 'Everyone supports fontSize');
+  equal(false, Modernizr.testProp('font-size'), 'Nobody supports font-size');
+
+  equal('pointerEvents' in  document.createElement('div').style,
+         Modernizr.testProp('pointerEvents'),
+         'results for `pointer-events` are consistent with a homegrown feature test');
+
+});
+
+
+
+test('Modernizr.testAllProps()',function(){
+
+  equal(true, Modernizr.testAllProps('margin'), 'Everyone supports margin');
+
+  equal(false, Modernizr.testAllProps('happiness'), 'Nobody supports the happiness style. :(');
+  equal(true, Modernizr.testAllProps('fontSize'), 'Everyone supports fontSize');
+  equal(false, Modernizr.testAllProps('font-size'), 'Nobody supports font-size');
+
+  equal(Modernizr.csstransitions, Modernizr.testAllProps('transition'), 'Modernizr result matches API result: csstransitions');
+
+  equal(Modernizr.csscolumns, Modernizr.testAllProps('columnCount'), 'Modernizr result matches API result: csscolumns')
+
+});
+
+
+
+
+
+
+test('Modernizr.prefixed() - css and DOM resolving', function(){
+  // https://gist.github.com/523692
+
+  function gimmePrefix(prop, obj){
+    var prefixes = ['Moz','Khtml','Webkit','O','ms'],
+        domPrefixes = ['moz','khtml','webkit','o','ms'],
+        elem     = document.createElement('div'),
+        upper    = prop.charAt(0).toUpperCase() + prop.slice(1);
+
+    if(!obj) {
+      if (prop in elem.style)
+        return prop;
+
+      for (var len = prefixes.length; len--; ){
+        if ((prefixes[len] + upper)  in elem.style)
+          return (prefixes[len] + upper);
+      }
+    } else {
+      if (prop in obj)
+        return prop;
+
+      for (var len = domPrefixes.length; len--; ){
+        if ((domPrefixes[len] + upper)  in obj)
+          return (domPrefixes[len] + upper);
+      }
+    }
+
+
+    return false;
+  }
+
+  var propArr = ['transition', 'backgroundSize', 'boxSizing', 'borderImage',
+                 'borderRadius', 'boxShadow', 'columnCount'];
+
+  var domPropArr = [{ 'prop': 'requestAnimationFrame',  'obj': window },
+                    { 'prop': 'querySelectorAll',       'obj': document },
+                    { 'prop': 'matchesSelector',        'obj': document.createElement('div') }];
+
+  for (var i = -1, len = propArr.length; ++i < len; ){
+    var prop = propArr[i];
+    equal(Modernizr.prefixed(prop), gimmePrefix(prop), 'results for ' + prop + ' match the homebaked prefix finder');
+  }
+
+  for (var i = -1, len = domPropArr.length; ++i < len; ){
+    var prop = domPropArr[i];
+    ok(!!~Modernizr.prefixed(prop.prop, prop.obj, false).toString().indexOf(gimmePrefix(prop.prop, prop.obj)), 'results for ' + prop.prop + ' match the homebaked prefix finder');
+  }
+
+
+
+
+});
+
+
+// FIXME: so a few of these are whitelisting for webkit. i'd like to improve that.
+test('Modernizr.prefixed autobind', function(){
+
+  var rAFName;
+
+  // quick sniff to find the local rAF prefixed name.
+  var vendors = ['ms', 'moz', 'webkit', 'o'];
+  for(var x = 0; x < vendors.length && !rAFName; ++x) {
+    rAFName = window[vendors[x]+'RequestAnimationFrame'] && vendors[x]+'RequestAnimationFrame';
+  }
+
+  if (rAFName){
+    // rAF returns a function
+    equal(
+      'function',
+      typeof Modernizr.prefixed('requestAnimationFrame', window),
+      "Modernizr.prefixed('requestAnimationFrame', window) returns a function")
+
+    // unless we false it to a string
+    equal(
+      rAFName,
+      Modernizr.prefixed('requestAnimationFrame', window, false),
+      "Modernizr.prefixed('requestAnimationFrame', window, false) returns a string (the prop name)")
+
+  }
+
+  if (document.body.webkitMatchesSelector || document.body.mozMatchesSelector){
+
+    var fn = Modernizr.prefixed('matchesSelector', HTMLElement.prototype, document.body);
+
+    //returns function
+    equal(
+      'function',
+      typeof fn,
+      "Modernizr.prefixed('matchesSelector', HTMLElement.prototype, document.body) returns a function");
+
+      // fn scoping
+    equal(
+      true,
+      fn('body'),
+      "Modernizr.prefixed('matchesSelector', HTMLElement.prototype, document.body) is scoped to the body")
+
+  }
+
+  // Webkit only: are there other objects that are prefixed?
+  if (window.webkitNotifications){
+    // should be an object.
+
+    equal(
+      'object',
+      typeof Modernizr.prefixed('Notifications', window),
+      "Modernizr.prefixed('Notifications') returns an object");
+
+  }
+
+  // Webkit only:
+  if (typeof document.webkitIsFullScreen !== 'undefined'){
+    // boolean
+
+    equal(
+      'boolean',
+      typeof Modernizr.prefixed('isFullScreen', document),
+      "Modernizr.prefixed('isFullScreen') returns a boolean");
+  }
+
+
+
+  // Moz only:
+  if (typeof document.mozFullScreen !== 'undefined'){
+    // boolean
+
+    equal(
+      'boolean',
+      typeof Modernizr.prefixed('fullScreen', document),
+      "Modernizr.prefixed('fullScreen') returns a boolean");
+  }
+
+
+  // Webkit-only.. takes advantage of Webkit's mixed case of prefixes
+  if (document.body.style.WebkitAnimation){
+    // string
+
+    equal(
+      'string',
+      typeof Modernizr.prefixed('animation', document.body.style),
+      "Modernizr.prefixed('animation', document.body.style) returns value of that, as a string");
+
+    equal(
+      animationStyle.toLowerCase(),
+      Modernizr.prefixed('animation', document.body.style, false).toLowerCase(),
+      "Modernizr.prefixed('animation', document.body.style, false) returns the (case-normalized) name of the property: webkitanimation");
+
+  }
+
+  equal(
+    false,
+    Modernizr.prefixed('doSomethingAmazing$#$', window),
+    "Modernizr.prefixed('doSomethingAmazing$#$', window) : Gobbledygook with prefixed(str,obj) returns false");
+
+  equal(
+    false,
+    Modernizr.prefixed('doSomethingAmazing$#$', window, document.body),
+    "Modernizr.prefixed('doSomethingAmazing$#$', window) : Gobbledygook with prefixed(str,obj, scope) returns false");
+
+
+  equal(
+    false,
+    Modernizr.prefixed('doSomethingAmazing$#$', window, false),
+    "Modernizr.prefixed('doSomethingAmazing$#$', window) : Gobbledygook with prefixed(str,obj, false) returns false");
+
+
+});
+
+
+
+
+
diff --git a/profiles/commons/libraries/modernizr/test/qunit/qunit.css b/profiles/commons/libraries/modernizr/test/qunit/qunit.css
new file mode 100644
index 0000000..257b224
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/qunit/qunit.css
@@ -0,0 +1,231 @@
+/**
+ * QUnit v1.9.0 - A JavaScript Unit Testing Framework
+ *
+ * http://docs.jquery.com/QUnit
+ *
+ * Copyright (c) 2012 John Resig, Jrn Zaefferer
+ * Dual licensed under the MIT (MIT-LICENSE.txt)
+ * or GPL (GPL-LICENSE.txt) licenses.
+ */
+
+/** Font Family and Sizes */
+
+#qunit-tests, #qunit-header, #qunit-banner, #qunit-testrunner-toolbar, #qunit-userAgent, #qunit-testresult {
+	font-family: "Helvetica Neue Light", "HelveticaNeue-Light", "Helvetica Neue", Calibri, Helvetica, Arial, sans-serif;
+}
+
+#qunit-testrunner-toolbar, #qunit-userAgent, #qunit-testresult, #qunit-tests li { font-size: small; }
+#qunit-tests { font-size: smaller; }
+
+
+/** Resets */
+
+#qunit-tests, #qunit-tests ol, #qunit-header, #qunit-banner, #qunit-userAgent, #qunit-testresult {
+	margin: 0;
+	padding: 0;
+}
+
+
+/** Header */
+
+#qunit-header {
+	padding: 0.5em 0 0.5em 1em;
+
+	color: #8699a4;
+	background-color: #0d3349;
+
+	font-size: 1.5em;
+	line-height: 1em;
+	font-weight: normal;
+
+	border-radius: 5px 5px 0 0;
+	-moz-border-radius: 5px 5px 0 0;
+	-webkit-border-top-right-radius: 5px;
+	-webkit-border-top-left-radius: 5px;
+}
+
+#qunit-header a {
+	text-decoration: none;
+	color: #c2ccd1;
+}
+
+#qunit-header a:hover,
+#qunit-header a:focus {
+	color: #fff;
+}
+
+#qunit-testrunner-toolbar label {
+	display: inline-block;
+	padding: 0 .5em 0 .1em;
+}
+
+#qunit-banner {
+	height: 5px;
+}
+
+#qunit-testrunner-toolbar {
+	padding: 0.5em 0 0.5em 2em;
+	color: #5E740B;
+	background-color: #eee;
+}
+
+#qunit-userAgent {
+	padding: 0.5em 0 0.5em 2.5em;
+	background-color: #2b81af;
+	color: #fff;
+	text-shadow: rgba(0, 0, 0, 0.5) 2px 2px 1px;
+}
+
+
+/** Tests: Pass/Fail */
+
+#qunit-tests {
+	list-style-position: inside;
+}
+
+#qunit-tests li {
+	padding: 0.4em 0.5em 0.4em 2.5em;
+	border-bottom: 1px solid #fff;
+	list-style-position: inside;
+}
+
+#qunit-tests.hidepass li.pass, #qunit-tests.hidepass li.running  {
+	display: none;
+}
+
+#qunit-tests li strong {
+	cursor: pointer;
+}
+
+#qunit-tests li a {
+	padding: 0.5em;
+	color: #c2ccd1;
+	text-decoration: none;
+}
+#qunit-tests li a:hover,
+#qunit-tests li a:focus {
+	color: #000;
+}
+
+#qunit-tests ol {
+	margin-top: 0.5em;
+	padding: 0.5em;
+
+	background-color: #fff;
+
+	border-radius: 5px;
+	-moz-border-radius: 5px;
+	-webkit-border-radius: 5px;
+}
+
+#qunit-tests table {
+	border-collapse: collapse;
+	margin-top: .2em;
+}
+
+#qunit-tests th {
+	text-align: right;
+	vertical-align: top;
+	padding: 0 .5em 0 0;
+}
+
+#qunit-tests td {
+	vertical-align: top;
+}
+
+#qunit-tests pre {
+	margin: 0;
+	white-space: pre-wrap;
+	word-wrap: break-word;
+}
+
+#qunit-tests del {
+	background-color: #e0f2be;
+	color: #374e0c;
+	text-decoration: none;
+}
+
+#qunit-tests ins {
+	background-color: #ffcaca;
+	color: #500;
+	text-decoration: none;
+}
+
+/*** Test Counts */
+
+#qunit-tests b.counts                       { color: black; }
+#qunit-tests b.passed                       { color: #5E740B; }
+#qunit-tests b.failed                       { color: #710909; }
+
+#qunit-tests li li {
+	padding: 5px;
+	background-color: #fff;
+	border-bottom: none;
+	list-style-position: inside;
+}
+
+/*** Passing Styles */
+
+#qunit-tests li li.pass {
+	color: #3c510c;
+	background-color: #fff;
+	border-left: 10px solid #C6E746;
+}
+
+#qunit-tests .pass                          { color: #528CE0; background-color: #D2E0E6; }
+#qunit-tests .pass .test-name               { color: #366097; }
+
+#qunit-tests .pass .test-actual,
+#qunit-tests .pass .test-expected           { color: #999999; }
+
+#qunit-banner.qunit-pass                    { background-color: #C6E746; }
+
+/*** Failing Styles */
+
+#qunit-tests li li.fail {
+	color: #710909;
+	background-color: #fff;
+	border-left: 10px solid #EE5757;
+	white-space: pre;
+}
+
+#qunit-tests > li:last-child {
+	border-radius: 0 0 5px 5px;
+	-moz-border-radius: 0 0 5px 5px;
+	-webkit-border-bottom-right-radius: 5px;
+	-webkit-border-bottom-left-radius: 5px;
+}
+
+#qunit-tests .fail                          { color: #000000; background-color: #EE5757; }
+#qunit-tests .fail .test-name,
+#qunit-tests .fail .module-name             { color: #000000; }
+
+#qunit-tests .fail .test-actual             { color: #EE5757; }
+#qunit-tests .fail .test-expected           { color: green;   }
+
+#qunit-banner.qunit-fail                    { background-color: #EE5757; }
+
+
+/** Result */
+
+#qunit-testresult {
+	padding: 0.5em 0.5em 0.5em 2.5em;
+
+	color: #2b81af;
+	background-color: #D2E0E6;
+
+	border-bottom: 1px solid white;
+}
+#qunit-testresult .module-name {
+	font-weight: bold;
+}
+
+/** Fixture */
+
+#qunit-fixture {
+	position: absolute;
+	top: -10000px;
+	left: -10000px;
+	width: 1000px;
+	height: 1000px;
+}
diff --git a/profiles/commons/libraries/modernizr/test/qunit/qunit.js b/profiles/commons/libraries/modernizr/test/qunit/qunit.js
new file mode 100644
index 0000000..9efedcb
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/qunit/qunit.js
@@ -0,0 +1,1932 @@
+/**
+ * QUnit v1.9.0 - A JavaScript Unit Testing Framework
+ *
+ * http://docs.jquery.com/QUnit
+ *
+ * Copyright (c) 2012 John Resig, Jrn Zaefferer
+ * Dual licensed under the MIT (MIT-LICENSE.txt)
+ * or GPL (GPL-LICENSE.txt) licenses.
+ */
+
+(function( window ) {
+
+var QUnit,
+	config,
+	onErrorFnPrev,
+	testId = 0,
+	fileName = (sourceFromStacktrace( 0 ) || "" ).replace(/(:\d+)+\)?/, "").replace(/.+\//, ""),
+	toString = Object.prototype.toString,
+	hasOwn = Object.prototype.hasOwnProperty,
+	defined = {
+	setTimeout: typeof window.setTimeout !== "undefined",
+	sessionStorage: (function() {
+		var x = "qunit-test-string";
+		try {
+			sessionStorage.setItem( x, x );
+			sessionStorage.removeItem( x );
+			return true;
+		} catch( e ) {
+			return false;
+		}
+	}())
+};
+
+function Test( settings ) {
+	extend( this, settings );
+	this.assertions = [];
+	this.testNumber = ++Test.count;
+}
+
+Test.count = 0;
+
+Test.prototype = {
+	init: function() {
+		var a, b, li,
+        tests = id( "qunit-tests" );
+
+		if ( tests ) {
+			b = document.createElement( "strong" );
+			b.innerHTML = this.name;
+
+			// `a` initialized at top of scope
+			a = document.createElement( "a" );
+			a.innerHTML = "Rerun";
+			a.href = QUnit.url({ testNumber: this.testNumber });
+
+			li = document.createElement( "li" );
+			li.appendChild( b );
+			li.appendChild( a );
+			li.className = "running";
+			li.id = this.id = "qunit-test-output" + testId++;
+
+			tests.appendChild( li );
+		}
+	},
+	setup: function() {
+		if ( this.module !== config.previousModule ) {
+			if ( config.previousModule ) {
+				runLoggingCallbacks( "moduleDone", QUnit, {
+					name: config.previousModule,
+					failed: config.moduleStats.bad,
+					passed: config.moduleStats.all - config.moduleStats.bad,
+					total: config.moduleStats.all
+				});
+			}
+			config.previousModule = this.module;
+			config.moduleStats = { all: 0, bad: 0 };
+			runLoggingCallbacks( "moduleStart", QUnit, {
+				name: this.module
+			});
+		} else if ( config.autorun ) {
+			runLoggingCallbacks( "moduleStart", QUnit, {
+				name: this.module
+			});
+		}
+
+		config.current = this;
+
+		this.testEnvironment = extend({
+			setup: function() {},
+			teardown: function() {}
+		}, this.moduleTestEnvironment );
+
+		runLoggingCallbacks( "testStart", QUnit, {
+			name: this.testName,
+			module: this.module
+		});
+
+		// allow utility functions to access the current test environment
+		// TODO why??
+		QUnit.current_testEnvironment = this.testEnvironment;
+
+		if ( !config.pollution ) {
+			saveGlobal();
+		}
+		if ( config.notrycatch ) {
+			this.testEnvironment.setup.call( this.testEnvironment );
+			return;
+		}
+		try {
+			this.testEnvironment.setup.call( this.testEnvironment );
+		} catch( e ) {
+			QUnit.pushFailure( "Setup failed on " + this.testName + ": " + e.message, extractStacktrace( e, 1 ) );
+		}
+	},
+	run: function() {
+		config.current = this;
+
+		var running = id( "qunit-testresult" );
+
+		if ( running ) {
+			running.innerHTML = "Running: <br/>" + this.name;
+		}
+
+		if ( this.async ) {
+			QUnit.stop();
+		}
+
+		if ( config.notrycatch ) {
+			this.callback.call( this.testEnvironment, QUnit.assert );
+			return;
+		}
+
+		try {
+			this.callback.call( this.testEnvironment, QUnit.assert );
+		} catch( e ) {
+			QUnit.pushFailure( "Died on test #" + (this.assertions.length + 1) + " " + this.stack + ": " + e.message, extractStacktrace( e, 0 ) );
+			// else next test will carry the responsibility
+			saveGlobal();
+
+			// Restart the tests if they're blocking
+			if ( config.blocking ) {
+				QUnit.start();
+			}
+		}
+	},
+	teardown: function() {
+		config.current = this;
+		if ( config.notrycatch ) {
+			this.testEnvironment.teardown.call( this.testEnvironment );
+			return;
+		} else {
+			try {
+				this.testEnvironment.teardown.call( this.testEnvironment );
+			} catch( e ) {
+				QUnit.pushFailure( "Teardown failed on " + this.testName + ": " + e.message, extractStacktrace( e, 1 ) );
+			}
+		}
+		checkPollution();
+	},
+	finish: function() {
+		config.current = this;
+		if ( config.requireExpects && this.expected == null ) {
+			QUnit.pushFailure( "Expected number of assertions to be defined, but expect() was not called.", this.stack );
+		} else if ( this.expected != null && this.expected != this.assertions.length ) {
+			QUnit.pushFailure( "Expected " + this.expected + " assertions, but " + this.assertions.length + " were run", this.stack );
+		} else if ( this.expected == null && !this.assertions.length ) {
+			QUnit.pushFailure( "Expected at least one assertion, but none were run - call expect(0) to accept zero assertions.", this.stack );
+		}
+
+		var assertion, a, b, i, li, ol,
+			test = this,
+			good = 0,
+			bad = 0,
+			tests = id( "qunit-tests" );
+
+		config.stats.all += this.assertions.length;
+		config.moduleStats.all += this.assertions.length;
+
+		if ( tests ) {
+			ol = document.createElement( "ol" );
+
+			for ( i = 0; i < this.assertions.length; i++ ) {
+				assertion = this.assertions[i];
+
+				li = document.createElement( "li" );
+				li.className = assertion.result ? "pass" : "fail";
+				li.innerHTML = assertion.message || ( assertion.result ? "okay" : "failed" );
+				ol.appendChild( li );
+
+				if ( assertion.result ) {
+					good++;
+				} else {
+					bad++;
+					config.stats.bad++;
+					config.moduleStats.bad++;
+				}
+			}
+
+			// store result when possible
+			if ( QUnit.config.reorder && defined.sessionStorage ) {
+				if ( bad ) {
+					sessionStorage.setItem( "qunit-test-" + this.module + "-" + this.testName, bad );
+				} else {
+					sessionStorage.removeItem( "qunit-test-" + this.module + "-" + this.testName );
+				}
+			}
+
+			if ( bad === 0 ) {
+				ol.style.display = "none";
+			}
+
+			// `b` initialized at top of scope
+			b = document.createElement( "strong" );
+			b.innerHTML = this.name + " <b class='counts'>(<b class='failed'>" + bad + "</b>, <b class='passed'>" + good + "</b>, " + this.assertions.length + ")</b>";
+
+			addEvent(b, "click", function() {
+				var next = b.nextSibling.nextSibling,
+					display = next.style.display;
+				next.style.display = display === "none" ? "block" : "none";
+			});
+
+			addEvent(b, "dblclick", function( e ) {
+				var target = e && e.target ? e.target : window.event.srcElement;
+				if ( target.nodeName.toLowerCase() == "span" || target.nodeName.toLowerCase() == "b" ) {
+					target = target.parentNode;
+				}
+				if ( window.location && target.nodeName.toLowerCase() === "strong" ) {
+					window.location = QUnit.url({ testNumber: test.testNumber });
+				}
+			});
+
+			// `li` initialized at top of scope
+			li = id( this.id );
+			li.className = bad ? "fail" : "pass";
+			li.removeChild( li.firstChild );
+			a = li.firstChild;
+			li.appendChild( b );
+			li.appendChild ( a );
+			li.appendChild( ol );
+
+		} else {
+			for ( i = 0; i < this.assertions.length; i++ ) {
+				if ( !this.assertions[i].result ) {
+					bad++;
+					config.stats.bad++;
+					config.moduleStats.bad++;
+				}
+			}
+		}
+
+		runLoggingCallbacks( "testDone", QUnit, {
+			name: this.testName,
+			module: this.module,
+			failed: bad,
+			passed: this.assertions.length - bad,
+			total: this.assertions.length
+		});
+
+		QUnit.reset();
+
+		config.current = undefined;
+	},
+
+	queue: function() {
+		var bad,
+			test = this;
+
+		synchronize(function() {
+			test.init();
+		});
+		function run() {
+			// each of these can by async
+			synchronize(function() {
+				test.setup();
+			});
+			synchronize(function() {
+				test.run();
+			});
+			synchronize(function() {
+				test.teardown();
+			});
+			synchronize(function() {
+				test.finish();
+			});
+		}
+
+		// `bad` initialized at top of scope
+		// defer when previous test run passed, if storage is available
+		bad = QUnit.config.reorder && defined.sessionStorage &&
+						+sessionStorage.getItem( "qunit-test-" + this.module + "-" + this.testName );
+
+		if ( bad ) {
+			run();
+		} else {
+			synchronize( run, true );
+		}
+	}
+};
+
+// Root QUnit object.
+// `QUnit` initialized at top of scope
+QUnit = {
+
+	// call on start of module test to prepend name to all tests
+	module: function( name, testEnvironment ) {
+		config.currentModule = name;
+		config.currentModuleTestEnviroment = testEnvironment;
+	},
+
+	asyncTest: function( testName, expected, callback ) {
+		if ( arguments.length === 2 ) {
+			callback = expected;
+			expected = null;
+		}
+
+		QUnit.test( testName, expected, callback, true );
+	},
+
+	test: function( testName, expected, callback, async ) {
+		var test,
+			name = "<span class='test-name'>" + escapeInnerText( testName ) + "</span>";
+
+		if ( arguments.length === 2 ) {
+			callback = expected;
+			expected = null;
+		}
+
+		if ( config.currentModule ) {
+			name = "<span class='module-name'>" + config.currentModule + "</span>: " + name;
+		}
+
+		test = new Test({
+			name: name,
+			testName: testName,
+			expected: expected,
+			async: async,
+			callback: callback,
+			module: config.currentModule,
+			moduleTestEnvironment: config.currentModuleTestEnviroment,
+			stack: sourceFromStacktrace( 2 )
+		});
+
+		if ( !validTest( test ) ) {
+			return;
+		}
+
+		test.queue();
+	},
+
+	// Specify the number of expected assertions to gurantee that failed test (no assertions are run at all) don't slip through.
+	expect: function( asserts ) {
+		config.current.expected = asserts;
+	},
+
+	start: function( count ) {
+		config.semaphore -= count || 1;
+		// don't start until equal number of stop-calls
+		if ( config.semaphore > 0 ) {
+			return;
+		}
+		// ignore if start is called more often then stop
+		if ( config.semaphore < 0 ) {
+			config.semaphore = 0;
+		}
+		// A slight delay, to avoid any current callbacks
+		if ( defined.setTimeout ) {
+			window.setTimeout(function() {
+				if ( config.semaphore > 0 ) {
+					return;
+				}
+				if ( config.timeout ) {
+					clearTimeout( config.timeout );
+				}
+
+				config.blocking = false;
+				process( true );
+			}, 13);
+		} else {
+			config.blocking = false;
+			process( true );
+		}
+	},
+
+	stop: function( count ) {
+		config.semaphore += count || 1;
+		config.blocking = true;
+
+		if ( config.testTimeout && defined.setTimeout ) {
+			clearTimeout( config.timeout );
+			config.timeout = window.setTimeout(function() {
+				QUnit.ok( false, "Test timed out" );
+				config.semaphore = 1;
+				QUnit.start();
+			}, config.testTimeout );
+		}
+	}
+};
+
+// Asssert helpers
+// All of these must call either QUnit.push() or manually do:
+// - runLoggingCallbacks( "log", .. );
+// - config.current.assertions.push({ .. });
+QUnit.assert = {
+	/**
+	 * Asserts rough true-ish result.
+	 * @name ok
+	 * @function
+	 * @example ok( "asdfasdf".length > 5, "There must be at least 5 chars" );
+	 */
+	ok: function( result, msg ) {
+		if ( !config.current ) {
+			throw new Error( "ok() assertion outside test context, was " + sourceFromStacktrace(2) );
+		}
+		result = !!result;
+
+		var source,
+			details = {
+				result: result,
+				message: msg
+			};
+
+		msg = escapeInnerText( msg || (result ? "okay" : "failed" ) );
+		msg = "<span class='test-message'>" + msg + "</span>";
+
+		if ( !result ) {
+			source = sourceFromStacktrace( 2 );
+			if ( source ) {
+				details.source = source;
+				msg += "<table><tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr></table>";
+			}
+		}
+		runLoggingCallbacks( "log", QUnit, details );
+		config.current.assertions.push({
+			result: result,
+			message: msg
+		});
+	},
+
+	/**
+	 * Assert that the first two arguments are equal, with an optional message.
+	 * Prints out both actual and expected values.
+	 * @name equal
+	 * @function
+	 * @example equal( format( "Received {0} bytes.", 2), "Received 2 bytes.", "format() replaces {0} with next argument" );
+	 */
+	equal: function( actual, expected, message ) {
+		QUnit.push( expected == actual, actual, expected, message );
+	},
+
+	/**
+	 * @name notEqual
+	 * @function
+	 */
+	notEqual: function( actual, expected, message ) {
+		QUnit.push( expected != actual, actual, expected, message );
+	},
+
+	/**
+	 * @name deepEqual
+	 * @function
+	 */
+	deepEqual: function( actual, expected, message ) {
+		QUnit.push( QUnit.equiv(actual, expected), actual, expected, message );
+	},
+
+	/**
+	 * @name notDeepEqual
+	 * @function
+	 */
+	notDeepEqual: function( actual, expected, message ) {
+		QUnit.push( !QUnit.equiv(actual, expected), actual, expected, message );
+	},
+
+	/**
+	 * @name strictEqual
+	 * @function
+	 */
+	strictEqual: function( actual, expected, message ) {
+		QUnit.push( expected === actual, actual, expected, message );
+	},
+
+	/**
+	 * @name notStrictEqual
+	 * @function
+	 */
+	notStrictEqual: function( actual, expected, message ) {
+		QUnit.push( expected !== actual, actual, expected, message );
+	},
+
+	throws: function( block, expected, message ) {
+		var actual,
+			ok = false;
+
+		// 'expected' is optional
+		if ( typeof expected === "string" ) {
+			message = expected;
+			expected = null;
+		}
+
+		config.current.ignoreGlobalErrors = true;
+		try {
+			block.call( config.current.testEnvironment );
+		} catch (e) {
+			actual = e;
+		}
+		config.current.ignoreGlobalErrors = false;
+
+		if ( actual ) {
+			// we don't want to validate thrown error
+			if ( !expected ) {
+				ok = true;
+			// expected is a regexp
+			} else if ( QUnit.objectType( expected ) === "regexp" ) {
+				ok = expected.test( actual );
+			// expected is a constructor
+			} else if ( actual instanceof expected ) {
+				ok = true;
+			// expected is a validation function which returns true is validation passed
+			} else if ( expected.call( {}, actual ) === true ) {
+				ok = true;
+			}
+
+			QUnit.push( ok, actual, null, message );
+		} else {
+			QUnit.pushFailure( message, null, 'No exception was thrown.' );
+		}
+	}
+};
+
+/**
+ * @deprecate since 1.8.0
+ * Kept assertion helpers in root for backwards compatibility
+ */
+extend( QUnit, QUnit.assert );
+
+/**
+ * @deprecated since 1.9.0
+ * Kept global "raises()" for backwards compatibility
+ */
+QUnit.raises = QUnit.assert.throws;
+
+/**
+ * @deprecated since 1.0.0, replaced with error pushes since 1.3.0
+ * Kept to avoid TypeErrors for undefined methods.
+ */
+QUnit.equals = function() {
+	QUnit.push( false, false, false, "QUnit.equals has been deprecated since 2009 (e88049a0), use QUnit.equal instead" );
+};
+QUnit.same = function() {
+	QUnit.push( false, false, false, "QUnit.same has been deprecated since 2009 (e88049a0), use QUnit.deepEqual instead" );
+};
+
+// We want access to the constructor's prototype
+(function() {
+	function F() {}
+	F.prototype = QUnit;
+	QUnit = new F();
+	// Make F QUnit's constructor so that we can add to the prototype later
+	QUnit.constructor = F;
+}());
+
+/**
+ * Config object: Maintain internal state
+ * Later exposed as QUnit.config
+ * `config` initialized at top of scope
+ */
+config = {
+	// The queue of tests to run
+	queue: [],
+
+	// block until document ready
+	blocking: true,
+
+	// when enabled, show only failing tests
+	// gets persisted through sessionStorage and can be changed in UI via checkbox
+	hidepassed: false,
+
+	// by default, run previously failed tests first
+	// very useful in combination with "Hide passed tests" checked
+	reorder: true,
+
+	// by default, modify document.title when suite is done
+	altertitle: true,
+
+	// when enabled, all tests must call expect()
+	requireExpects: false,
+
+	// add checkboxes that are persisted in the query-string
+	// when enabled, the id is set to `true` as a `QUnit.config` property
+	urlConfig: [
+		{
+			id: "noglobals",
+			label: "Check for Globals",
+			tooltip: "Enabling this will test if any test introduces new properties on the `window` object. Stored as query-strings."
+		},
+		{
+			id: "notrycatch",
+			label: "No try-catch",
+			tooltip: "Enabling this will run tests outside of a try-catch block. Makes debugging exceptions in IE reasonable. Stored as query-strings."
+		}
+	],
+
+	// logging callback queues
+	begin: [],
+	done: [],
+	log: [],
+	testStart: [],
+	testDone: [],
+	moduleStart: [],
+	moduleDone: []
+};
+
+// Initialize more QUnit.config and QUnit.urlParams
+(function() {
+	var i,
+		location = window.location || { search: "", protocol: "file:" },
+		params = location.search.slice( 1 ).split( "&" ),
+		length = params.length,
+		urlParams = {},
+		current;
+
+	if ( params[ 0 ] ) {
+		for ( i = 0; i < length; i++ ) {
+			current = params[ i ].split( "=" );
+			current[ 0 ] = decodeURIComponent( current[ 0 ] );
+			// allow just a key to turn on a flag, e.g., test.html?noglobals
+			current[ 1 ] = current[ 1 ] ? decodeURIComponent( current[ 1 ] ) : true;
+			urlParams[ current[ 0 ] ] = current[ 1 ];
+		}
+	}
+
+	QUnit.urlParams = urlParams;
+
+	// String search anywhere in moduleName+testName
+	config.filter = urlParams.filter;
+
+	// Exact match of the module name
+	config.module = urlParams.module;
+
+	config.testNumber = parseInt( urlParams.testNumber, 10 ) || null;
+
+	// Figure out if we're running the tests from a server or not
+	QUnit.isLocal = location.protocol === "file:";
+}());
+
+// Export global variables, unless an 'exports' object exists,
+// in that case we assume we're in CommonJS (dealt with on the bottom of the script)
+if ( typeof exports === "undefined" ) {
+	extend( window, QUnit );
+
+	// Expose QUnit object
+	window.QUnit = QUnit;
+}
+
+// Extend QUnit object,
+// these after set here because they should not be exposed as global functions
+extend( QUnit, {
+	config: config,
+
+	// Initialize the configuration options
+	init: function() {
+		extend( config, {
+			stats: { all: 0, bad: 0 },
+			moduleStats: { all: 0, bad: 0 },
+			started: +new Date(),
+			updateRate: 1000,
+			blocking: false,
+			autostart: true,
+			autorun: false,
+			filter: "",
+			queue: [],
+			semaphore: 0
+		});
+
+		var tests, banner, result,
+			qunit = id( "qunit" );
+
+		if ( qunit ) {
+			qunit.innerHTML =
+				"<h1 id='qunit-header'>" + escapeInnerText( document.title ) + "</h1>" +
+				"<h2 id='qunit-banner'></h2>" +
+				"<div id='qunit-testrunner-toolbar'></div>" +
+				"<h2 id='qunit-userAgent'></h2>" +
+				"<ol id='qunit-tests'></ol>";
+		}
+
+		tests = id( "qunit-tests" );
+		banner = id( "qunit-banner" );
+		result = id( "qunit-testresult" );
+
+		if ( tests ) {
+			tests.innerHTML = "";
+		}
+
+		if ( banner ) {
+			banner.className = "";
+		}
+
+		if ( result ) {
+			result.parentNode.removeChild( result );
+		}
+
+		if ( tests ) {
+			result = document.createElement( "p" );
+			result.id = "qunit-testresult";
+			result.className = "result";
+			tests.parentNode.insertBefore( result, tests );
+			result.innerHTML = "Running...<br/>&nbsp;";
+		}
+	},
+
+	// Resets the test setup. Useful for tests that modify the DOM.
+	// If jQuery is available, uses jQuery's html(), otherwise just innerHTML.
+	reset: function() {
+		var fixture;
+
+		if ( window.jQuery ) {
+			jQuery( "#qunit-fixture" ).html( config.fixture );
+		} else {
+			fixture = id( "qunit-fixture" );
+			if ( fixture ) {
+				fixture.innerHTML = config.fixture;
+			}
+		}
+	},
+
+	// Trigger an event on an element.
+	// @example triggerEvent( document.body, "click" );
+	triggerEvent: function( elem, type, event ) {
+		if ( document.createEvent ) {
+			event = document.createEvent( "MouseEvents" );
+			event.initMouseEvent(type, true, true, elem.ownerDocument.defaultView,
+				0, 0, 0, 0, 0, false, false, false, false, 0, null);
+
+			elem.dispatchEvent( event );
+		} else if ( elem.fireEvent ) {
+			elem.fireEvent( "on" + type );
+		}
+	},
+
+	// Safe object type checking
+	is: function( type, obj ) {
+		return QUnit.objectType( obj ) == type;
+	},
+
+	objectType: function( obj ) {
+		if ( typeof obj === "undefined" ) {
+				return "undefined";
+		// consider: typeof null === object
+		}
+		if ( obj === null ) {
+				return "null";
+		}
+
+		var type = toString.call( obj ).match(/^\[object\s(.*)\]$/)[1] || "";
+
+		switch ( type ) {
+			case "Number":
+				if ( isNaN(obj) ) {
+					return "nan";
+				}
+				return "number";
+			case "String":
+			case "Boolean":
+			case "Array":
+			case "Date":
+			case "RegExp":
+			case "Function":
+				return type.toLowerCase();
+		}
+		if ( typeof obj === "object" ) {
+			return "object";
+		}
+		return undefined;
+	},
+
+	push: function( result, actual, expected, message ) {
+		if ( !config.current ) {
+			throw new Error( "assertion outside test context, was " + sourceFromStacktrace() );
+		}
+
+		var output, source,
+			details = {
+				result: result,
+				message: message,
+				actual: actual,
+				expected: expected
+			};
+
+		message = escapeInnerText( message ) || ( result ? "okay" : "failed" );
+		message = "<span class='test-message'>" + message + "</span>";
+		output = message;
+
+		if ( !result ) {
+			expected = escapeInnerText( QUnit.jsDump.parse(expected) );
+			actual = escapeInnerText( QUnit.jsDump.parse(actual) );
+			output += "<table><tr class='test-expected'><th>Expected: </th><td><pre>" + expected + "</pre></td></tr>";
+
+			if ( actual != expected ) {
+				output += "<tr class='test-actual'><th>Result: </th><td><pre>" + actual + "</pre></td></tr>";
+				output += "<tr class='test-diff'><th>Diff: </th><td><pre>" + QUnit.diff( expected, actual ) + "</pre></td></tr>";
+			}
+
+			source = sourceFromStacktrace();
+
+			if ( source ) {
+				details.source = source;
+				output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr>";
+			}
+
+			output += "</table>";
+		}
+
+		runLoggingCallbacks( "log", QUnit, details );
+
+		config.current.assertions.push({
+			result: !!result,
+			message: output
+		});
+	},
+
+	pushFailure: function( message, source, actual ) {
+		if ( !config.current ) {
+			throw new Error( "pushFailure() assertion outside test context, was " + sourceFromStacktrace(2) );
+		}
+
+		var output,
+			details = {
+				result: false,
+				message: message
+			};
+
+		message = escapeInnerText( message ) || "error";
+		message = "<span class='test-message'>" + message + "</span>";
+		output = message;
+
+		output += "<table>";
+
+		if ( actual ) {
+			output += "<tr class='test-actual'><th>Result: </th><td><pre>" + escapeInnerText( actual ) + "</pre></td></tr>";
+		}
+
+		if ( source ) {
+			details.source = source;
+			output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr>";
+		}
+
+		output += "</table>";
+
+		runLoggingCallbacks( "log", QUnit, details );
+
+		config.current.assertions.push({
+			result: false,
+			message: output
+		});
+	},
+
+	url: function( params ) {
+		params = extend( extend( {}, QUnit.urlParams ), params );
+		var key,
+			querystring = "?";
+
+		for ( key in params ) {
+			if ( !hasOwn.call( params, key ) ) {
+				continue;
+			}
+			querystring += encodeURIComponent( key ) + "=" +
+				encodeURIComponent( params[ key ] ) + "&";
+		}
+		return window.location.pathname + querystring.slice( 0, -1 );
+	},
+
+	extend: extend,
+	id: id,
+	addEvent: addEvent
+	// load, equiv, jsDump, diff: Attached later
+});
+
+/**
+ * @deprecated: Created for backwards compatibility with test runner that set the hook function
+ * into QUnit.{hook}, instead of invoking it and passing the hook function.
+ * QUnit.constructor is set to the empty F() above so that we can add to it's prototype here.
+ * Doing this allows us to tell if the following methods have been overwritten on the actual
+ * QUnit object.
+ */
+extend( QUnit.constructor.prototype, {
+
+	// Logging callbacks; all receive a single argument with the listed properties
+	// run test/logs.html for any related changes
+	begin: registerLoggingCallback( "begin" ),
+
+	// done: { failed, passed, total, runtime }
+	done: registerLoggingCallback( "done" ),
+
+	// log: { result, actual, expected, message }
+	log: registerLoggingCallback( "log" ),
+
+	// testStart: { name }
+	testStart: registerLoggingCallback( "testStart" ),
+
+	// testDone: { name, failed, passed, total }
+	testDone: registerLoggingCallback( "testDone" ),
+
+	// moduleStart: { name }
+	moduleStart: registerLoggingCallback( "moduleStart" ),
+
+	// moduleDone: { name, failed, passed, total }
+	moduleDone: registerLoggingCallback( "moduleDone" )
+});
+
+if ( typeof document === "undefined" || document.readyState === "complete" ) {
+	config.autorun = true;
+}
+
+QUnit.load = function() {
+	runLoggingCallbacks( "begin", QUnit, {} );
+
+	// Initialize the config, saving the execution queue
+	var banner, filter, i, label, len, main, ol, toolbar, userAgent, val, urlConfigCheckboxes,
+		urlConfigHtml = "",
+		oldconfig = extend( {}, config );
+
+	QUnit.init();
+	extend(config, oldconfig);
+
+	config.blocking = false;
+
+	len = config.urlConfig.length;
+
+	for ( i = 0; i < len; i++ ) {
+		val = config.urlConfig[i];
+		if ( typeof val === "string" ) {
+			val = {
+				id: val,
+				label: val,
+				tooltip: "[no tooltip available]"
+			};
+		}
+		config[ val.id ] = QUnit.urlParams[ val.id ];
+		urlConfigHtml += "<input id='qunit-urlconfig-" + val.id + "' name='" + val.id + "' type='checkbox'" + ( config[ val.id ] ? " checked='checked'" : "" ) + " title='" + val.tooltip + "'><label for='qunit-urlconfig-" + val.id + "' title='" + val.tooltip + "'>" + val.label + "</label>";
+	}
+
+	// `userAgent` initialized at top of scope
+	userAgent = id( "qunit-userAgent" );
+	if ( userAgent ) {
+		userAgent.innerHTML = navigator.userAgent;
+	}
+
+	// `banner` initialized at top of scope
+	banner = id( "qunit-header" );
+	if ( banner ) {
+		banner.innerHTML = "<a href='" + QUnit.url({ filter: undefined, module: undefined, testNumber: undefined }) + "'>" + banner.innerHTML + "</a> ";
+	}
+
+	// `toolbar` initialized at top of scope
+	toolbar = id( "qunit-testrunner-toolbar" );
+	if ( toolbar ) {
+		// `filter` initialized at top of scope
+		filter = document.createElement( "input" );
+		filter.type = "checkbox";
+		filter.id = "qunit-filter-pass";
+
+		addEvent( filter, "click", function() {
+			var tmp,
+				ol = document.getElementById( "qunit-tests" );
+
+			if ( filter.checked ) {
+				ol.className = ol.className + " hidepass";
+			} else {
+				tmp = " " + ol.className.replace( /[\n\t\r]/g, " " ) + " ";
+				ol.className = tmp.replace( / hidepass /, " " );
+			}
+			if ( defined.sessionStorage ) {
+				if (filter.checked) {
+					sessionStorage.setItem( "qunit-filter-passed-tests", "true" );
+				} else {
+					sessionStorage.removeItem( "qunit-filter-passed-tests" );
+				}
+			}
+		});
+
+		if ( config.hidepassed || defined.sessionStorage && sessionStorage.getItem( "qunit-filter-passed-tests" ) ) {
+			filter.checked = true;
+			// `ol` initialized at top of scope
+			ol = document.getElementById( "qunit-tests" );
+			ol.className = ol.className + " hidepass";
+		}
+		toolbar.appendChild( filter );
+
+		// `label` initialized at top of scope
+		label = document.createElement( "label" );
+		label.setAttribute( "for", "qunit-filter-pass" );
+		label.setAttribute( "title", "Only show tests and assertons that fail. Stored in sessionStorage." );
+		label.innerHTML = "Hide passed tests";
+		toolbar.appendChild( label );
+
+		urlConfigCheckboxes = document.createElement( 'span' );
+		urlConfigCheckboxes.innerHTML = urlConfigHtml;
+		addEvent( urlConfigCheckboxes, "change", function( event ) {
+			var params = {};
+			params[ event.target.name ] = event.target.checked ? true : undefined;
+			window.location = QUnit.url( params );
+		});
+		toolbar.appendChild( urlConfigCheckboxes );
+	}
+
+	// `main` initialized at top of scope
+	main = id( "qunit-fixture" );
+	if ( main ) {
+		config.fixture = main.innerHTML;
+	}
+
+	if ( config.autostart ) {
+		QUnit.start();
+	}
+};
+
+addEvent( window, "load", QUnit.load );
+
+// `onErrorFnPrev` initialized at top of scope
+// Preserve other handlers
+onErrorFnPrev = window.onerror;
+
+// Cover uncaught exceptions
+// Returning true will surpress the default browser handler,
+// returning false will let it run.
+window.onerror = function ( error, filePath, linerNr ) {
+	var ret = false;
+	if ( onErrorFnPrev ) {
+		ret = onErrorFnPrev( error, filePath, linerNr );
+	}
+
+	// Treat return value as window.onerror itself does,
+	// Only do our handling if not surpressed.
+	if ( ret !== true ) {
+		if ( QUnit.config.current ) {
+			if ( QUnit.config.current.ignoreGlobalErrors ) {
+				return true;
+			}
+			QUnit.pushFailure( error, filePath + ":" + linerNr );
+		} else {
+			QUnit.test( "global failure", function() {
+				QUnit.pushFailure( error, filePath + ":" + linerNr );
+			});
+		}
+		return false;
+	}
+
+	return ret;
+};
+
+function done() {
+	config.autorun = true;
+
+	// Log the last module results
+	if ( config.currentModule ) {
+		runLoggingCallbacks( "moduleDone", QUnit, {
+			name: config.currentModule,
+			failed: config.moduleStats.bad,
+			passed: config.moduleStats.all - config.moduleStats.bad,
+			total: config.moduleStats.all
+		});
+	}
+
+	var i, key,
+		banner = id( "qunit-banner" ),
+		tests = id( "qunit-tests" ),
+		runtime = +new Date() - config.started,
+		passed = config.stats.all - config.stats.bad,
+		html = [
+			"Tests completed in ",
+			runtime,
+			" milliseconds.<br/>",
+			"<span class='passed'>",
+			passed,
+			"</span> tests of <span class='total'>",
+			config.stats.all,
+			"</span> passed, <span class='failed'>",
+			config.stats.bad,
+			"</span> failed."
+		].join( "" );
+
+	if ( banner ) {
+		banner.className = ( config.stats.bad ? "qunit-fail" : "qunit-pass" );
+	}
+
+	if ( tests ) {
+		id( "qunit-testresult" ).innerHTML = html;
+	}
+
+	if ( config.altertitle && typeof document !== "undefined" && document.title ) {
+		// show  for good,  for bad suite result in title
+		// use escape sequences in case file gets loaded with non-utf-8-charset
+		document.title = [
+			( config.stats.bad ? "\u2716" : "\u2714" ),
+			document.title.replace( /^[\u2714\u2716] /i, "" )
+		].join( " " );
+	}
+
+	// clear own sessionStorage items if all tests passed
+	if ( config.reorder && defined.sessionStorage && config.stats.bad === 0 ) {
+		// `key` & `i` initialized at top of scope
+		for ( i = 0; i < sessionStorage.length; i++ ) {
+			key = sessionStorage.key( i++ );
+			if ( key.indexOf( "qunit-test-" ) === 0 ) {
+				sessionStorage.removeItem( key );
+			}
+		}
+	}
+
+	runLoggingCallbacks( "done", QUnit, {
+		failed: config.stats.bad,
+		passed: passed,
+		total: config.stats.all,
+		runtime: runtime
+	});
+}
+
+/** @return Boolean: true if this test should be ran */
+function validTest( test ) {
+	var include,
+		filter = config.filter && config.filter.toLowerCase(),
+		module = config.module && config.module.toLowerCase(),
+		fullName = (test.module + ": " + test.testName).toLowerCase();
+
+	if ( config.testNumber ) {
+		return test.testNumber === config.testNumber;
+	}
+
+	if ( module && ( !test.module || test.module.toLowerCase() !== module ) ) {
+		return false;
+	}
+
+	if ( !filter ) {
+		return true;
+	}
+
+	include = filter.charAt( 0 ) !== "!";
+	if ( !include ) {
+		filter = filter.slice( 1 );
+	}
+
+	// If the filter matches, we need to honour include
+	if ( fullName.indexOf( filter ) !== -1 ) {
+		return include;
+	}
+
+	// Otherwise, do the opposite
+	return !include;
+}
+
+// so far supports only Firefox, Chrome and Opera (buggy), Safari (for real exceptions)
+// Later Safari and IE10 are supposed to support error.stack as well
+// See also https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error/Stack
+function extractStacktrace( e, offset ) {
+	offset = offset === undefined ? 3 : offset;
+
+	var stack, include, i, regex;
+
+	if ( e.stacktrace ) {
+		// Opera
+		return e.stacktrace.split( "\n" )[ offset + 3 ];
+	} else if ( e.stack ) {
+		// Firefox, Chrome
+		stack = e.stack.split( "\n" );
+		if (/^error$/i.test( stack[0] ) ) {
+			stack.shift();
+		}
+		if ( fileName ) {
+			include = [];
+			for ( i = offset; i < stack.length; i++ ) {
+				if ( stack[ i ].indexOf( fileName ) != -1 ) {
+					break;
+				}
+				include.push( stack[ i ] );
+			}
+			if ( include.length ) {
+				return include.join( "\n" );
+			}
+		}
+		return stack[ offset ];
+	} else if ( e.sourceURL ) {
+		// Safari, PhantomJS
+		// hopefully one day Safari provides actual stacktraces
+		// exclude useless self-reference for generated Error objects
+		if ( /qunit.js$/.test( e.sourceURL ) ) {
+			return;
+		}
+		// for actual exceptions, this is useful
+		return e.sourceURL + ":" + e.line;
+	}
+}
+function sourceFromStacktrace( offset ) {
+	try {
+		throw new Error();
+	} catch ( e ) {
+		return extractStacktrace( e, offset );
+	}
+}
+
+function escapeInnerText( s ) {
+	if ( !s ) {
+		return "";
+	}
+	s = s + "";
+	return s.replace( /[\&<>]/g, function( s ) {
+		switch( s ) {
+			case "&": return "&amp;";
+			case "<": return "&lt;";
+			case ">": return "&gt;";
+			default: return s;
+		}
+	});
+}
+
+function synchronize( callback, last ) {
+	config.queue.push( callback );
+
+	if ( config.autorun && !config.blocking ) {
+		process( last );
+	}
+}
+
+function process( last ) {
+	function next() {
+		process( last );
+	}
+	var start = new Date().getTime();
+	config.depth = config.depth ? config.depth + 1 : 1;
+
+	while ( config.queue.length && !config.blocking ) {
+		if ( !defined.setTimeout || config.updateRate <= 0 || ( ( new Date().getTime() - start ) < config.updateRate ) ) {
+			config.queue.shift()();
+		} else {
+			window.setTimeout( next, 13 );
+			break;
+		}
+	}
+	config.depth--;
+	if ( last && !config.blocking && !config.queue.length && config.depth === 0 ) {
+		done();
+	}
+}
+
+function saveGlobal() {
+	config.pollution = [];
+
+	if ( config.noglobals ) {
+		for ( var key in window ) {
+			// in Opera sometimes DOM element ids show up here, ignore them
+			if ( !hasOwn.call( window, key ) || /^qunit-test-output/.test( key ) ) {
+				continue;
+			}
+			config.pollution.push( key );
+		}
+	}
+}
+
+function checkPollution( name ) {
+	var newGlobals,
+		deletedGlobals,
+		old = config.pollution;
+
+	saveGlobal();
+
+	newGlobals = diff( config.pollution, old );
+	if ( newGlobals.length > 0 ) {
+		QUnit.pushFailure( "Introduced global variable(s): " + newGlobals.join(", ") );
+	}
+
+	deletedGlobals = diff( old, config.pollution );
+	if ( deletedGlobals.length > 0 ) {
+		QUnit.pushFailure( "Deleted global variable(s): " + deletedGlobals.join(", ") );
+	}
+}
+
+// returns a new Array with the elements that are in a but not in b
+function diff( a, b ) {
+	var i, j,
+		result = a.slice();
+
+	for ( i = 0; i < result.length; i++ ) {
+		for ( j = 0; j < b.length; j++ ) {
+			if ( result[i] === b[j] ) {
+				result.splice( i, 1 );
+				i--;
+				break;
+			}
+		}
+	}
+	return result;
+}
+
+function extend( a, b ) {
+	for ( var prop in b ) {
+		if ( b[ prop ] === undefined ) {
+			delete a[ prop ];
+
+		// Avoid "Member not found" error in IE8 caused by setting window.constructor
+		} else if ( prop !== "constructor" || a !== window ) {
+			a[ prop ] = b[ prop ];
+		}
+	}
+
+	return a;
+}
+
+function addEvent( elem, type, fn ) {
+	if ( elem.addEventListener ) {
+		elem.addEventListener( type, fn, false );
+	} else if ( elem.attachEvent ) {
+		elem.attachEvent( "on" + type, fn );
+	} else {
+		fn();
+	}
+}
+
+function id( name ) {
+	return !!( typeof document !== "undefined" && document && document.getElementById ) &&
+		document.getElementById( name );
+}
+
+function registerLoggingCallback( key ) {
+	return function( callback ) {
+		config[key].push( callback );
+	};
+}
+
+// Supports deprecated method of completely overwriting logging callbacks
+function runLoggingCallbacks( key, scope, args ) {
+	//debugger;
+	var i, callbacks;
+	if ( QUnit.hasOwnProperty( key ) ) {
+		QUnit[ key ].call(scope, args );
+	} else {
+		callbacks = config[ key ];
+		for ( i = 0; i < callbacks.length; i++ ) {
+			callbacks[ i ].call( scope, args );
+		}
+	}
+}
+
+// Test for equality any JavaScript type.
+// Author: Philippe Rath <prathe@gmail.com>
+QUnit.equiv = (function() {
+
+	// Call the o related callback with the given arguments.
+	function bindCallbacks( o, callbacks, args ) {
+		var prop = QUnit.objectType( o );
+		if ( prop ) {
+			if ( QUnit.objectType( callbacks[ prop ] ) === "function" ) {
+				return callbacks[ prop ].apply( callbacks, args );
+			} else {
+				return callbacks[ prop ]; // or undefined
+			}
+		}
+	}
+
+	// the real equiv function
+	var innerEquiv,
+		// stack to decide between skip/abort functions
+		callers = [],
+		// stack to avoiding loops from circular referencing
+		parents = [],
+
+		getProto = Object.getPrototypeOf || function ( obj ) {
+			return obj.__proto__;
+		},
+		callbacks = (function () {
+
+			// for string, boolean, number and null
+			function useStrictEquality( b, a ) {
+				if ( b instanceof a.constructor || a instanceof b.constructor ) {
+					// to catch short annotaion VS 'new' annotation of a
+					// declaration
+					// e.g. var i = 1;
+					// var j = new Number(1);
+					return a == b;
+				} else {
+					return a === b;
+				}
+			}
+
+			return {
+				"string": useStrictEquality,
+				"boolean": useStrictEquality,
+				"number": useStrictEquality,
+				"null": useStrictEquality,
+				"undefined": useStrictEquality,
+
+				"nan": function( b ) {
+					return isNaN( b );
+				},
+
+				"date": function( b, a ) {
+					return QUnit.objectType( b ) === "date" && a.valueOf() === b.valueOf();
+				},
+
+				"regexp": function( b, a ) {
+					return QUnit.objectType( b ) === "regexp" &&
+						// the regex itself
+						a.source === b.source &&
+						// and its modifers
+						a.global === b.global &&
+						// (gmi) ...
+						a.ignoreCase === b.ignoreCase &&
+						a.multiline === b.multiline;
+				},
+
+				// - skip when the property is a method of an instance (OOP)
+				// - abort otherwise,
+				// initial === would have catch identical references anyway
+				"function": function() {
+					var caller = callers[callers.length - 1];
+					return caller !== Object && typeof caller !== "undefined";
+				},
+
+				"array": function( b, a ) {
+					var i, j, len, loop;
+
+					// b could be an object literal here
+					if ( QUnit.objectType( b ) !== "array" ) {
+						return false;
+					}
+
+					len = a.length;
+					if ( len !== b.length ) {
+						// safe and faster
+						return false;
+					}
+
+					// track reference to avoid circular references
+					parents.push( a );
+					for ( i = 0; i < len; i++ ) {
+						loop = false;
+						for ( j = 0; j < parents.length; j++ ) {
+							if ( parents[j] === a[i] ) {
+								loop = true;// dont rewalk array
+							}
+						}
+						if ( !loop && !innerEquiv(a[i], b[i]) ) {
+							parents.pop();
+							return false;
+						}
+					}
+					parents.pop();
+					return true;
+				},
+
+				"object": function( b, a ) {
+					var i, j, loop,
+						// Default to true
+						eq = true,
+						aProperties = [],
+						bProperties = [];
+
+					// comparing constructors is more strict than using
+					// instanceof
+					if ( a.constructor !== b.constructor ) {
+						// Allow objects with no prototype to be equivalent to
+						// objects with Object as their constructor.
+						if ( !(( getProto(a) === null && getProto(b) === Object.prototype ) ||
+							( getProto(b) === null && getProto(a) === Object.prototype ) ) ) {
+								return false;
+						}
+					}
+
+					// stack constructor before traversing properties
+					callers.push( a.constructor );
+					// track reference to avoid circular references
+					parents.push( a );
+
+					for ( i in a ) { // be strict: don't ensures hasOwnProperty
+									// and go deep
+						loop = false;
+						for ( j = 0; j < parents.length; j++ ) {
+							if ( parents[j] === a[i] ) {
+								// don't go down the same path twice
+								loop = true;
+							}
+						}
+						aProperties.push(i); // collect a's properties
+
+						if (!loop && !innerEquiv( a[i], b[i] ) ) {
+							eq = false;
+							break;
+						}
+					}
+
+					callers.pop(); // unstack, we are done
+					parents.pop();
+
+					for ( i in b ) {
+						bProperties.push( i ); // collect b's properties
+					}
+
+					// Ensures identical properties name
+					return eq && innerEquiv( aProperties.sort(), bProperties.sort() );
+				}
+			};
+		}());
+
+	innerEquiv = function() { // can take multiple arguments
+		var args = [].slice.apply( arguments );
+		if ( args.length < 2 ) {
+			return true; // end transition
+		}
+
+		return (function( a, b ) {
+			if ( a === b ) {
+				return true; // catch the most you can
+			} else if ( a === null || b === null || typeof a === "undefined" ||
+					typeof b === "undefined" ||
+					QUnit.objectType(a) !== QUnit.objectType(b) ) {
+				return false; // don't lose time with error prone cases
+			} else {
+				return bindCallbacks(a, callbacks, [ b, a ]);
+			}
+
+			// apply transition with (1..n) arguments
+		}( args[0], args[1] ) && arguments.callee.apply( this, args.splice(1, args.length - 1 )) );
+	};
+
+	return innerEquiv;
+}());
+
+/**
+ * jsDump Copyright (c) 2008 Ariel Flesler - aflesler(at)gmail(dot)com |
+ * http://flesler.blogspot.com Licensed under BSD
+ * (http://www.opensource.org/licenses/bsd-license.php) Date: 5/15/2008
+ *
+ * @projectDescription Advanced and extensible data dumping for Javascript.
+ * @version 1.0.0
+ * @author Ariel Flesler
+ * @link {http://flesler.blogspot.com/2008/05/jsdump-pretty-dump-of-any-javascript.html}
+ */
+QUnit.jsDump = (function() {
+	function quote( str ) {
+		return '"' + str.toString().replace( /"/g, '\\"' ) + '"';
+	}
+	function literal( o ) {
+		return o + "";
+	}
+	function join( pre, arr, post ) {
+		var s = jsDump.separator(),
+			base = jsDump.indent(),
+			inner = jsDump.indent(1);
+		if ( arr.join ) {
+			arr = arr.join( "," + s + inner );
+		}
+		if ( !arr ) {
+			return pre + post;
+		}
+		return [ pre, inner + arr, base + post ].join(s);
+	}
+	function array( arr, stack ) {
+		var i = arr.length, ret = new Array(i);
+		this.up();
+		while ( i-- ) {
+			ret[i] = this.parse( arr[i] , undefined , stack);
+		}
+		this.down();
+		return join( "[", ret, "]" );
+	}
+
+	var reName = /^function (\w+)/,
+		jsDump = {
+			parse: function( obj, type, stack ) { //type is used mostly internally, you can fix a (custom)type in advance
+				stack = stack || [ ];
+				var inStack, res,
+					parser = this.parsers[ type || this.typeOf(obj) ];
+
+				type = typeof parser;
+				inStack = inArray( obj, stack );
+
+				if ( inStack != -1 ) {
+					return "recursion(" + (inStack - stack.length) + ")";
+				}
+				//else
+				if ( type == "function" )  {
+					stack.push( obj );
+					res = parser.call( this, obj, stack );
+					stack.pop();
+					return res;
+				}
+				// else
+				return ( type == "string" ) ? parser : this.parsers.error;
+			},
+			typeOf: function( obj ) {
+				var type;
+				if ( obj === null ) {
+					type = "null";
+				} else if ( typeof obj === "undefined" ) {
+					type = "undefined";
+				} else if ( QUnit.is( "regexp", obj) ) {
+					type = "regexp";
+				} else if ( QUnit.is( "date", obj) ) {
+					type = "date";
+				} else if ( QUnit.is( "function", obj) ) {
+					type = "function";
+				} else if ( typeof obj.setInterval !== undefined && typeof obj.document !== "undefined" && typeof obj.nodeType === "undefined" ) {
+					type = "window";
+				} else if ( obj.nodeType === 9 ) {
+					type = "document";
+				} else if ( obj.nodeType ) {
+					type = "node";
+				} else if (
+					// native arrays
+					toString.call( obj ) === "[object Array]" ||
+					// NodeList objects
+					( typeof obj.length === "number" && typeof obj.item !== "undefined" && ( obj.length ? obj.item(0) === obj[0] : ( obj.item( 0 ) === null && typeof obj[0] === "undefined" ) ) )
+				) {
+					type = "array";
+				} else {
+					type = typeof obj;
+				}
+				return type;
+			},
+			separator: function() {
+				return this.multiline ?	this.HTML ? "<br />" : "\n" : this.HTML ? "&nbsp;" : " ";
+			},
+			indent: function( extra ) {// extra can be a number, shortcut for increasing-calling-decreasing
+				if ( !this.multiline ) {
+					return "";
+				}
+				var chr = this.indentChar;
+				if ( this.HTML ) {
+					chr = chr.replace( /\t/g, "   " ).replace( / /g, "&nbsp;" );
+				}
+				return new Array( this._depth_ + (extra||0) ).join(chr);
+			},
+			up: function( a ) {
+				this._depth_ += a || 1;
+			},
+			down: function( a ) {
+				this._depth_ -= a || 1;
+			},
+			setParser: function( name, parser ) {
+				this.parsers[name] = parser;
+			},
+			// The next 3 are exposed so you can use them
+			quote: quote,
+			literal: literal,
+			join: join,
+			//
+			_depth_: 1,
+			// This is the list of parsers, to modify them, use jsDump.setParser
+			parsers: {
+				window: "[Window]",
+				document: "[Document]",
+				error: "[ERROR]", //when no parser is found, shouldn"t happen
+				unknown: "[Unknown]",
+				"null": "null",
+				"undefined": "undefined",
+				"function": function( fn ) {
+					var ret = "function",
+						name = "name" in fn ? fn.name : (reName.exec(fn) || [])[1];//functions never have name in IE
+
+					if ( name ) {
+						ret += " " + name;
+					}
+					ret += "( ";
+
+					ret = [ ret, QUnit.jsDump.parse( fn, "functionArgs" ), "){" ].join( "" );
+					return join( ret, QUnit.jsDump.parse(fn,"functionCode" ), "}" );
+				},
+				array: array,
+				nodelist: array,
+				"arguments": array,
+				object: function( map, stack ) {
+					var ret = [ ], keys, key, val, i;
+					QUnit.jsDump.up();
+					if ( Object.keys ) {
+						keys = Object.keys( map );
+					} else {
+						keys = [];
+						for ( key in map ) {
+							keys.push( key );
+						}
+					}
+					keys.sort();
+					for ( i = 0; i < keys.length; i++ ) {
+						key = keys[ i ];
+						val = map[ key ];
+						ret.push( QUnit.jsDump.parse( key, "key" ) + ": " + QUnit.jsDump.parse( val, undefined, stack ) );
+					}
+					QUnit.jsDump.down();
+					return join( "{", ret, "}" );
+				},
+				node: function( node ) {
+					var a, val,
+						open = QUnit.jsDump.HTML ? "&lt;" : "<",
+						close = QUnit.jsDump.HTML ? "&gt;" : ">",
+						tag = node.nodeName.toLowerCase(),
+						ret = open + tag;
+
+					for ( a in QUnit.jsDump.DOMAttrs ) {
+						val = node[ QUnit.jsDump.DOMAttrs[a] ];
+						if ( val ) {
+							ret += " " + a + "=" + QUnit.jsDump.parse( val, "attribute" );
+						}
+					}
+					return ret + close + open + "/" + tag + close;
+				},
+				functionArgs: function( fn ) {//function calls it internally, it's the arguments part of the function
+					var args,
+						l = fn.length;
+
+					if ( !l ) {
+						return "";
+					}
+
+					args = new Array(l);
+					while ( l-- ) {
+						args[l] = String.fromCharCode(97+l);//97 is 'a'
+					}
+					return " " + args.join( ", " ) + " ";
+				},
+				key: quote, //object calls it internally, the key part of an item in a map
+				functionCode: "[code]", //function calls it internally, it's the content of the function
+				attribute: quote, //node calls it internally, it's an html attribute value
+				string: quote,
+				date: quote,
+				regexp: literal, //regex
+				number: literal,
+				"boolean": literal
+			},
+			DOMAttrs: {
+				//attributes to dump from nodes, name=>realName
+				id: "id",
+				name: "name",
+				"class": "className"
+			},
+			HTML: false,//if true, entities are escaped ( <, >, \t, space and \n )
+			indentChar: "  ",//indentation unit
+			multiline: true //if true, items in a collection, are separated by a \n, else just a space.
+		};
+
+	return jsDump;
+}());
+
+// from Sizzle.js
+function getText( elems ) {
+	var i, elem,
+		ret = "";
+
+	for ( i = 0; elems[i]; i++ ) {
+		elem = elems[i];
+
+		// Get the text from text nodes and CDATA nodes
+		if ( elem.nodeType === 3 || elem.nodeType === 4 ) {
+			ret += elem.nodeValue;
+
+		// Traverse everything else, except comment nodes
+		} else if ( elem.nodeType !== 8 ) {
+			ret += getText( elem.childNodes );
+		}
+	}
+
+	return ret;
+}
+
+// from jquery.js
+function inArray( elem, array ) {
+	if ( array.indexOf ) {
+		return array.indexOf( elem );
+	}
+
+	for ( var i = 0, length = array.length; i < length; i++ ) {
+		if ( array[ i ] === elem ) {
+			return i;
+		}
+	}
+
+	return -1;
+}
+
+/*
+ * Javascript Diff Algorithm
+ *  By John Resig (http://ejohn.org/)
+ *  Modified by Chu Alan "sprite"
+ *
+ * Released under the MIT license.
+ *
+ * More Info:
+ *  http://ejohn.org/projects/javascript-diff-algorithm/
+ *
+ * Usage: QUnit.diff(expected, actual)
+ *
+ * QUnit.diff( "the quick brown fox jumped over", "the quick fox jumps over" ) == "the  quick <del>brown </del> fox <del>jumped </del><ins>jumps </ins> over"
+ */
+QUnit.diff = (function() {
+	function diff( o, n ) {
+		var i,
+			ns = {},
+			os = {};
+
+		for ( i = 0; i < n.length; i++ ) {
+			if ( ns[ n[i] ] == null ) {
+				ns[ n[i] ] = {
+					rows: [],
+					o: null
+				};
+			}
+			ns[ n[i] ].rows.push( i );
+		}
+
+		for ( i = 0; i < o.length; i++ ) {
+			if ( os[ o[i] ] == null ) {
+				os[ o[i] ] = {
+					rows: [],
+					n: null
+				};
+			}
+			os[ o[i] ].rows.push( i );
+		}
+
+		for ( i in ns ) {
+			if ( !hasOwn.call( ns, i ) ) {
+				continue;
+			}
+			if ( ns[i].rows.length == 1 && typeof os[i] != "undefined" && os[i].rows.length == 1 ) {
+				n[ ns[i].rows[0] ] = {
+					text: n[ ns[i].rows[0] ],
+					row: os[i].rows[0]
+				};
+				o[ os[i].rows[0] ] = {
+					text: o[ os[i].rows[0] ],
+					row: ns[i].rows[0]
+				};
+			}
+		}
+
+		for ( i = 0; i < n.length - 1; i++ ) {
+			if ( n[i].text != null && n[ i + 1 ].text == null && n[i].row + 1 < o.length && o[ n[i].row + 1 ].text == null &&
+						n[ i + 1 ] == o[ n[i].row + 1 ] ) {
+
+				n[ i + 1 ] = {
+					text: n[ i + 1 ],
+					row: n[i].row + 1
+				};
+				o[ n[i].row + 1 ] = {
+					text: o[ n[i].row + 1 ],
+					row: i + 1
+				};
+			}
+		}
+
+		for ( i = n.length - 1; i > 0; i-- ) {
+			if ( n[i].text != null && n[ i - 1 ].text == null && n[i].row > 0 && o[ n[i].row - 1 ].text == null &&
+						n[ i - 1 ] == o[ n[i].row - 1 ]) {
+
+				n[ i - 1 ] = {
+					text: n[ i - 1 ],
+					row: n[i].row - 1
+				};
+				o[ n[i].row - 1 ] = {
+					text: o[ n[i].row - 1 ],
+					row: i - 1
+				};
+			}
+		}
+
+		return {
+			o: o,
+			n: n
+		};
+	}
+
+	return function( o, n ) {
+		o = o.replace( /\s+$/, "" );
+		n = n.replace( /\s+$/, "" );
+
+		var i, pre,
+			str = "",
+			out = diff( o === "" ? [] : o.split(/\s+/), n === "" ? [] : n.split(/\s+/) ),
+			oSpace = o.match(/\s+/g),
+			nSpace = n.match(/\s+/g);
+
+		if ( oSpace == null ) {
+			oSpace = [ " " ];
+		}
+		else {
+			oSpace.push( " " );
+		}
+
+		if ( nSpace == null ) {
+			nSpace = [ " " ];
+		}
+		else {
+			nSpace.push( " " );
+		}
+
+		if ( out.n.length === 0 ) {
+			for ( i = 0; i < out.o.length; i++ ) {
+				str += "<del>" + out.o[i] + oSpace[i] + "</del>";
+			}
+		}
+		else {
+			if ( out.n[0].text == null ) {
+				for ( n = 0; n < out.o.length && out.o[n].text == null; n++ ) {
+					str += "<del>" + out.o[n] + oSpace[n] + "</del>";
+				}
+			}
+
+			for ( i = 0; i < out.n.length; i++ ) {
+				if (out.n[i].text == null) {
+					str += "<ins>" + out.n[i] + nSpace[i] + "</ins>";
+				}
+				else {
+					// `pre` initialized at top of scope
+					pre = "";
+
+					for ( n = out.n[i].row + 1; n < out.o.length && out.o[n].text == null; n++ ) {
+						pre += "<del>" + out.o[n] + oSpace[n] + "</del>";
+					}
+					str += " " + out.n[i].text + nSpace[i] + pre;
+				}
+			}
+		}
+
+		return str;
+	};
+}());
+
+// for CommonJS enviroments, export everything
+if ( typeof exports !== "undefined" ) {
+	extend(exports, QUnit);
+}
+
+// get at whatever the global object is, like window in browsers
+}( (function() {return this;}.call()) ));
diff --git a/profiles/commons/libraries/modernizr/test/qunit/run-qunit.js b/profiles/commons/libraries/modernizr/test/qunit/run-qunit.js
new file mode 100644
index 0000000..5617ee4
--- /dev/null
+++ b/profiles/commons/libraries/modernizr/test/qunit/run-qunit.js
@@ -0,0 +1,72 @@
+/**
+* Wait until the test condition is true or a timeout occurs. Useful for waiting
+* on a server response or for a ui change (fadeIn, etc.) to occur.
+*
+* @param testFx javascript condition that evaluates to a boolean,
+* it can be passed in as a string (e.g.: "1 == 1" or "$('#bar').is(':visible')" or
+* as a callback function.
+* @param onReady what to do when testFx condition is fulfilled,
+* it can be passed in as a string (e.g.: "1 == 1" or "$('#bar').is(':visible')" or
+* as a callback function.
+* @param timeOutMillis the max amount of time to wait. If not specified, 3 sec is used.
+*/
+function waitFor(testFx, onReady, timeOutMillis) {
+    var maxtimeOutMillis = timeOutMillis ? timeOutMillis : 3001, //< Default Max Timout is 3s
+        start = new Date().getTime(),
+        condition = false,
+        interval = setInterval(function() {
+            if ( (new Date().getTime() - start < maxtimeOutMillis) && !condition ) {
+                // If not time-out yet and condition not yet fulfilled
+                condition = (typeof(testFx) === "string" ? eval(testFx) : testFx()); //< defensive code
+            } else {
+                if(!condition) {
+                    // If condition still not fulfilled (timeout but condition is 'false')
+                    console.log("'waitFor()' timeout");
+                    phantom.exit(1);
+                } else {
+                    // Condition fulfilled (timeout and/or condition is 'true')
+                    typeof(onReady) === "string" ? eval(onReady) : onReady(); //< Do what it's supposed to do once the condition is fulfilled
+                    clearInterval(interval); //< Stop this interval
+                }
+            }
+        }, 100); //< repeat check every 250ms
+};
+
+
+if (phantom.args.length === 0 || phantom.args.length > 2) {
+    console.log('Usage: run-qunit.js URL');
+    phantom.exit();
+}
+
+var page = new WebPage();
+
+// Route "console.log()" calls from within the Page context to the main Phantom context (i.e. current "this")
+page.onConsoleMessage = function(msg) {
+    console.log(msg);
+};
+
+page.open(phantom.args[0], function(status){
+    if (status !== "success") {
+        console.log("Unable to access network");
+        phantom.exit();
+    } else {
+        waitFor(function(){
+            return page.evaluate(function(){
+                var el = document.getElementById('qunit-testresult');
+                if (el && el.innerText.match('completed')) {
+                    return true;
+                }
+                return false;
+            });
+        }, function(){
+            var failedNum = page.evaluate(function(){
+                var el = document.getElementById('qunit-testresult');
+                try {
+                    return el.getElementsByClassName('failed')[0].innerHTML;
+                } catch (e) { }
+                return 10000;
+            });
+            phantom.exit((parseInt(failedNum, 10) > 0) ? 1 : 0);
+        });
+    }
+});
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
index 06c9745..efa2121 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
@@ -2,7 +2,6 @@ name = Commons Activity Page
 description = Allows users to view a stream of site-wide and personalized activity.
 core = 7.x
 package = Commons - Landing pages
-project = commons_activity_page
 dependencies[] = commons_activity_streams
 dependencies[] = commons_featured
 dependencies[] = ctools
@@ -13,9 +12,9 @@ features[ctools][] = page_manager:pages_default:1
 features[features_api][] = api:2
 features[page_manager_pages][] = commons_activity_streams_activity
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
index 0ce83f8..397e98e 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
@@ -1,7 +1,6 @@
 name = Commons Activity Streams
 core = 7.x
 package = Commons - Building blocks
-project = commons_activity_streams
 dependencies[] = commons_follow
 dependencies[] = ctools
 dependencies[] = entity
@@ -14,7 +13,6 @@ dependencies[] = token
 dependencies[] = views
 dependencies[] = views_content
 dependencies[] = views_load_more
-datestamp = 1361203022
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
@@ -40,9 +38,9 @@ features_exclude[field_base][field_target_nodes] = field_target_nodes
 features_exclude[field_base][field_target_comments] = field_target_comments
 features_exclude[views_view][commons_bw_all] = commons_bw_all
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.module b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.module
index d0bc8df..eb73f1c 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.module
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.module
@@ -54,8 +54,12 @@ function commons_activity_streams_node_insert($node) {
 function commons_activity_streams_comment_insert($comment) {
   $account = user_load($comment->uid);
   $node = node_load($comment->nid);
-
-  $message = message_create('commons_activity_streams_comment_created', array('uid' => $account->uid, 'timestamp' => $comment->created));
+  // Allow other modules to change the message type used for this event.
+  $hook = 'comment_insert';
+  $message_type = 'commons_activity_streams_comment_created';
+  drupal_alter('commons_activity_streams_message_selection', $message_type, $hook, $node);
+  $message = message_create($message_type, array('uid' => $account->uid, 'timestamp' => $comment->created));
+  
   // Save reference to the node in the node reference field, and the
   // "publish" state (i.e. if the node is published or unpublished).
   $wrapper = entity_metadata_wrapper('message', $message);
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
index f26d4e6..1401309 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
@@ -2,7 +2,6 @@ name = Commons Activity Streams Groups
 description = Contains Organic Groups integration for Commons Activity Streams
 core = 7.x
 package = Commons - Building blocks
-project = commons_activity_streams_groups
 dependencies[] = commons_activity_streams
 dependencies[] = entity
 dependencies[] = views
@@ -11,9 +10,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[views_view][] = activity_group
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_body/commons_body.info b/profiles/commons/modules/commons/commons_body/commons_body.info
index 62e0002..41baefc 100644
--- a/profiles/commons/modules/commons/commons_body/commons_body.info
+++ b/profiles/commons/modules/commons/commons_body/commons_body.info
@@ -2,16 +2,15 @@ name = Commons Body Field
 description = Provides a simple body field for re-use by various Commons content types
 core = 7.x
 package = Commons - Building blocks
-project = commons_body
 dependencies[] = features
 dependencies[] = field_sql_storage
 dependencies[] = text
 features[features_api][] = api:2
 features[field_base][] = body
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_bw/commons_bw.info b/profiles/commons/modules/commons/commons_bw/commons_bw.info
index c0af0d2..111cfeb 100644
--- a/profiles/commons/modules/commons/commons_bw/commons_bw.info
+++ b/profiles/commons/modules/commons/commons_bw/commons_bw.info
@@ -2,6 +2,7 @@ name = Commons Tabbed Browsing Widget
 core = 7.x
 package = Commons - Building blocks
 dependencies[] = features
+dependencies[] = og
 dependencies[] = quicktabs
 dependencies[] = quicktabs_tabstyles
 dependencies[] = title
@@ -10,9 +11,9 @@ features[field_base][] = title_field
 files[] = includes/views/handlers/commons_bw_handler_node_partial_form.inc
 ; Views handlers
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_bw/commons_bw.module b/profiles/commons/modules/commons/commons_bw/commons_bw.module
index 7ae7e15..0c32197 100644
--- a/profiles/commons/modules/commons/commons_bw/commons_bw.module
+++ b/profiles/commons/modules/commons/commons_bw/commons_bw.module
@@ -8,14 +8,14 @@ function commons_bw_system_info_alter(&$info, $file, $type) {
     foreach (node_type_get_types() as $node_type) {
       $type = $node_type->type;
       if (commons_bw_node_auto_title_instance($type)) {
-        $info['features']['field_instance'][] = "node-$type-title_field";  
+        $info['features']['field_instance'][] = "node-$type-title_field";
       }
     }
   }
 }
 
 /**
- * Implementation of hook_ctools_plugin_directory().
+ * Implements hook_ctools_plugin_directory().
  */
 function commons_bw_ctools_plugin_directory($module, $plugin) {
   if ($module == 'ctools' && $plugin == 'content_types') {
@@ -186,7 +186,7 @@ function commons_bw_partial_node_form($form, &$form_state, $bundle, $group_id =
   // Add the commons_bw after build first, in case other pre-renders needs need
   // to address fields by there CSS ID.
   array_unshift($form['#pre_render'], 'commons_bw_partial_node_form_after_build');
-
+  $form['#validate'][] = 'commons_bw_partial_node_form_validate';
   return $form;
 }
 
@@ -232,6 +232,10 @@ function commons_bw_partial_node_form_validate($form, $form_state) {
   $node = $form['#entity'];
   field_attach_validate('node', $node);
   node_validate($node, $form, $form_state);
+  if ((!module_exists('commons_trusted_contacts') || (module_exists('commons_trusted_contacts') && !module_exists('og_access'))) && empty($form_state['group_id']) && empty($form_state['values'][OG_AUDIENCE_FIELD][LANGUAGE_NONE][0])) {
+    form_set_error(OG_AUDIENCE_FIELD, t('Please enter one or more groups where this content will be posted.'));
+    return FALSE;
+  }
 }
 
 /**
@@ -282,11 +286,22 @@ function commons_bw_form_field_ui_field_edit_form_alter(&$form, &$form_state) {
     return;
   }
 
+  // See if we're building for the first time, or getting pre-saved values.
   $field_name = $form['#field']['field_name'];
+  if(!empty($form_state['field'][$field_name][LANGUAGE_NONE]['instance']['display_in_partial_form'])) {
+    $display_default = $form_state['field'][$field_name][LANGUAGE_NONE]['instance']['display_in_partial_form'];
+  }
+  else if (isset($form_state['build_info']['args'][0]['display_in_partial_form'])) {
+    $display_default = $form_state['build_info']['args'][0]['display_in_partial_form'];
+  }
+  else {
+    $display_default = FALSE;
+  }
+
   $form['instance']['display_in_partial_form'] = array(
     '#type' => 'checkbox',
     '#title' => t('Display in the browsing widget mini-form'),
-    '#default_value' => !empty($form_state['field'][$field_name][LANGUAGE_NONE]['instance']['display_in_partial_form']) ? $form_state['field'][$field_name][LANGUAGE_NONE]['instance']['display_in_partial_form'] : FALSE,
+    '#default_value' => $display_default,
   );
 }
 
@@ -307,7 +322,7 @@ function commons_bw_get_tab_definitions($widget_type = 'group') {
  * Helper function to determine whether Commons_BW should define a title
  * field instance on behalf of a content type.
  */
-function commons_bw_node_auto_title_instance($node_type) {  
+function commons_bw_node_auto_title_instance($node_type) {
   $commons_groups_entity_types = commons_groups_get_group_content_entity_types();
   $return = isset($commons_groups_entity_types['node'][$node_type]['auto_title_instance']) ? $commons_groups_entity_types['node'][$node_type]['auto_title_instance'] : TRUE;
   return $return;
diff --git a/profiles/commons/modules/commons/commons_bw/js/partial_node_form.js b/profiles/commons/modules/commons/commons_bw/js/partial_node_form.js
index 972b3e3..2c4d1a8 100644
--- a/profiles/commons/modules/commons/commons_bw/js/partial_node_form.js
+++ b/profiles/commons/modules/commons/commons_bw/js/partial_node_form.js
@@ -40,13 +40,23 @@ Drupal.behaviors.commonsBwExpandableForm = {
           }).append(toggleText),
           triggerField = form.find('.trigger-field'),
           fullFormLink = form.find('a.full-form'),
-          hideables = form.find('.hideable-field');
+          hideables = form.find('.hideable-field'),
+          errors = form.find('.error');
 
-      // Add the toggle link to the top of the form.
-      form.prepend(toggle).addClass('expandable-form compact-form');
+      // Determine if the form has any errors.
+      if (!errors.length) {
+        // Forms with errors are shown expanded, so only add the toggle link to
+        // the top of forms which are error free.
+        form.prepend(toggle).addClass('expandable-form compact-form');
 
-      // Hide the hidden fields on load.
-      hideables.addClass('element-invisible');
+        // Hide the hidden fields on load.
+        hideables.addClass('element-invisible');
+      }
+      else {
+        // The full form link is only shown on collapsed forms so it is hidden
+        // for consistency.
+        fullFormLink.addClass('element-hidden');
+      }
 
       // Make all hidden fields visible when the trigger field comes into
       // focus.
diff --git a/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info b/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
index 5b496d8..b281b93 100644
--- a/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
+++ b/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
@@ -2,13 +2,11 @@ name = Commons Content moderation
 description = Commons Content moderation
 core = 7.x
 package = Commons - Building Blocks
-project = commons_content_moderation
 dependencies[] = ctools
 dependencies[] = flag
 dependencies[] = flag_abuse
 dependencies[] = strongarm
 dependencies[] = views
-datestamp = 1354747310
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
@@ -20,9 +18,9 @@ features[views_view][] = commons_content_moderation_reported_comments
 features[views_view][] = commons_content_moderation_reported_nodes
 features_exclude[dependencies][features] = features
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_documents/commons_documents.features.field_instance.inc b/profiles/commons/modules/commons/commons_documents/commons_documents.features.field_instance.inc
index c8d7138..008013d 100644
--- a/profiles/commons/modules/commons/commons_documents/commons_documents.features.field_instance.inc
+++ b/profiles/commons/modules/commons/commons_documents/commons_documents.features.field_instance.inc
@@ -83,7 +83,7 @@ function commons_documents_field_default_field_instances() {
     'settings' => array(
       'description_field' => 1,
       'file_directory' => '',
-      'file_extensions' => 'doc docx xls xlsx ppt pptx odt odp ods pdf',
+      'file_extensions' => 'txt doc docx xls xlsx ppt pptx odt odp ods pdf',
       'max_filesize' => '',
       'user_register_form' => FALSE,
     ),
diff --git a/profiles/commons/modules/commons/commons_documents/commons_documents.info b/profiles/commons/modules/commons/commons_documents/commons_documents.info
index 30a7323..be09f3a 100644
--- a/profiles/commons/modules/commons/commons_documents/commons_documents.info
+++ b/profiles/commons/modules/commons/commons_documents/commons_documents.info
@@ -1,7 +1,6 @@
 name = Commons Documents
 core = 7.x
 package = Commons - Content types
-project = commons_documents
 dependencies[] = commons_body
 dependencies[] = commons_groups
 dependencies[] = commons_topics
@@ -46,9 +45,9 @@ features[variable][] = node_preview_document
 features[variable][] = node_submitted_document
 features[views_view][] = commons_bw_documents
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_documents/commons_documents.install b/profiles/commons/modules/commons/commons_documents/commons_documents.install
index 6bfcd2a..65340dd 100644
--- a/profiles/commons/modules/commons/commons_documents/commons_documents.install
+++ b/profiles/commons/modules/commons/commons_documents/commons_documents.install
@@ -43,3 +43,25 @@ function commons_documents_update_7003() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_documents_update_7004() {
+  $revert = array(
+    'commons_documents' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
+
+/**
+ * Add .txt to the list of allowed file extensions.
+ */
+function commons_documents_update_7005() {
+  $revert = array(
+    'commons_documents' => array('field_instance'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_documents/commons_documents.views_default.inc b/profiles/commons/modules/commons/commons_documents/commons_documents.views_default.inc
index 4b21a2d..f5e4abb 100644
--- a/profiles/commons/modules/commons/commons_documents/commons_documents.views_default.inc
+++ b/profiles/commons/modules/commons/commons_documents/commons_documents.views_default.inc
@@ -64,6 +64,7 @@ function commons_documents_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_events/commons_events.info b/profiles/commons/modules/commons/commons_events/commons_events.info
index 20d7109..36ea84e 100644
--- a/profiles/commons/modules/commons/commons_events/commons_events.info
+++ b/profiles/commons/modules/commons/commons_events/commons_events.info
@@ -2,7 +2,6 @@ name = Commons Events
 description = Provides the Event features for Drupal Commons.
 core = 7.x
 package = Commons - Content types
-project = commons_events
 dependencies[] = addressfield
 dependencies[] = addressfield_tokens
 dependencies[] = block
@@ -29,17 +28,14 @@ dependencies[] = og
 dependencies[] = options
 dependencies[] = page_manager
 dependencies[] = radioactivity
-dependencies[] = rdf
 dependencies[] = registration
 dependencies[] = registration_views
-dependencies[] = schemaorg
 dependencies[] = strongarm
 dependencies[] = taxonomy
 dependencies[] = text
 dependencies[] = views
 dependencies[] = views_content
 dependencies[] = views_load_more
-datestamp = 1357735760
 features[ctools][] = page_manager:pages_default:1
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
@@ -104,9 +100,9 @@ files[] = commons_events.strongarm.inc
 files[] = includes/commons_events.forms.inc
 files[] = includes/commons_events.theme.inc
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_events/commons_events.module b/profiles/commons/modules/commons/commons_events/commons_events.module
index f055a12..a8c7d44 100644
--- a/profiles/commons/modules/commons/commons_events/commons_events.module
+++ b/profiles/commons/modules/commons/commons_events/commons_events.module
@@ -85,7 +85,7 @@ function commons_events_theme($existing, $type, $theme, $path) {
         'attributes_end' => array(),
         'rdf_mapping' => NULL,
         'add_rdf' => NULL,
-      )
+      ),
     ),
     'commons_events_date_display_range_simple' => array(
       'variables' => array(
@@ -102,7 +102,7 @@ function commons_events_theme($existing, $type, $theme, $path) {
         'attributes_end' => array(),
         'rdf_mapping' => NULL,
         'add_rdf' => NULL,
-      )
+      ),
     ),
   );
 }
@@ -207,7 +207,7 @@ function commons_events_entity_view_alter(&$build, $type) {
 }
 
 /**
- * Implements hook_form_FORM_ID_alter();
+ * Implements hook_form_FORM_ID_alter().
  */
 function commons_events_form_node_form_alter(&$form, &$form_state) {
   if ($form_state['node']->type == 'event') {
@@ -285,7 +285,7 @@ function commons_events_form_node_form_alter(&$form, &$form_state) {
 }
 
 /**
- * Implements hook_commons_entity_integration.
+ * Implements hook_commons_entity_integration().
  */
 function commons_events_commons_entity_integration() {
   return array(
@@ -481,8 +481,9 @@ function commons_events_block_view($delta = '') {
 }
 
 /**
- * Returns specific HTML for a date element formatted with the event formatter M j Y - g:ia
- * We the do some awesome stuff with regular expressions to take all the different formats available to us and format it pretty.
+ * Returns specific HTML for a date element formatted with the event formatter M j Y - g:ia.
+ * We the do some awesome stuff with regular expressions to take all the
+ * different formats available to us and format it pretty.
  */
 function theme_commons_events_date_display_range_simple($variables) {
   // Use the regular date formatter if we are any other date format than below.
@@ -517,7 +518,8 @@ function theme_commons_events_date_display_single($variables) {
 }
 /**
  * Returns specific HTML for a date element formatted with the event formatter.
- * We parse the date segments and return it at the bottom, or use the simple formatter (above) if parts of the date are too complicated.
+ * We parse the date segments and return it at the bottom, or use the simple
+ * formatter (above) if parts of the date are too complicated.
  */
 function theme_commons_events_date_display_range_advanced($variables) {
   $timezone = $variables['timezone'];
@@ -544,7 +546,7 @@ function theme_commons_events_date_display_range_advanced($variables) {
     $date2 = $variables['dates']['value2']['db']['object']->format($variables['dates']['format'],FALSE);
   }
   else if ($variables['dates']['value']['db']['object']->difference($variables['dates']['value2']['db']['object'], 'days') > 0) {
-    // If the Day is before the month (IE Europe, etc) then switch the granularity
+    // If the Day is before the month (Europe, etc) then switch the granularity.
     if (strpos($variables['dates']['format'],'M') != 0 || strpos($variables['dates']['format'],'m') != 0 ||
        strpos($variables['dates']['format'],'F') != 0 || strpos($variables['dates']['format'],'n') != 0) {
       $variables['dates']['value']['db']['object']->limitGranularity(array('day'));
@@ -557,7 +559,8 @@ function theme_commons_events_date_display_range_advanced($variables) {
     $date1 = $variables['dates']['value']['db']['object']->format($variables['dates']['format'],FALSE);
     $date2 = $variables['dates']['value2']['db']['object']->format($variables['dates']['format'],FALSE);
 
-    // If we are match 'D' or 'l', it means we have a 'day' in there (eg: Monday), we want the whole date because it looks funky otherwise.
+    // If we are match 'D' or 'l', then we have a 'day' in there (eg Monday),
+    // we want the whole date because it looks funky otherwise.
     if (strpbrk($variables['dates']['format'], 'Dl')) {
       return theme('commons_events_date_display_range_simple',$variables);
     }
diff --git a/profiles/commons/modules/commons/commons_events/includes/commons_events.theme.inc b/profiles/commons/modules/commons/commons_events/includes/commons_events.theme.inc
index 4b75e52..0a45515 100644
--- a/profiles/commons/modules/commons/commons_events/includes/commons_events.theme.inc
+++ b/profiles/commons/modules/commons/commons_events/includes/commons_events.theme.inc
@@ -11,9 +11,7 @@ function theme_commons_events_attending_event($variables = array()) {
   global $user;
   $event = $variables['event'];
   $attendee_count = $variables['attendee_count'];
-  if (!registration_status('node', $event->nid, TRUE)) {
-    return "";
-  }
+
   $registration_type = registration_get_entity_registration_type('node', $event);
   $registration = entity_get_controller('registration')->create(array(
     'entity_type' => 'node',
@@ -21,15 +19,18 @@ function theme_commons_events_attending_event($variables = array()) {
     'type' => $registration_type,
     'author_uid' => $user->uid,
   ));
+
   if (!function_exists('commons_events_attend_event_form')
     || !function_exists('commons_events_cancel_event_form')) {
     module_load_include('inc', 'commons_events', 'includes/commons_events.forms');
   }
   if (!registration_is_registered($registration, NULL, $user->uid)
-    && registration_access('create', $registration, $user, $registration->type)) {
+    && registration_access('create', $registration, $user, $registration->type)
+    && registration_status('node', $event->nid, TRUE)) {
     return drupal_get_form('commons_events_attend_event_form_' . $event->nid, $event, $registration, $attendee_count);
   }
-  else if (registration_access('delete', $registration, $user, $registration->type)) {
+  else if (registration_is_registered($registration, NULL, $user->uid) &&
+    registration_access('delete', $registration, $user, $registration->type)) {
     return drupal_get_form('commons_events_cancel_event_form_' . $event->nid, $event);
   }
   return "";
diff --git a/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info b/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
index 11cd4fa..0e354bd 100644
--- a/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
+++ b/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
@@ -2,11 +2,9 @@ name = Commons Events Pages
 description = Provides the panelized Event page feature.
 core = 7.x
 package = Commons - Landing pages
-project = commons_events_pages
 dependencies[] = commons_events
 dependencies[] = panelizer
 dependencies[] = strongarm
-datestamp = 1357735760
 features[ctools][] = panelizer:panelizer:1
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
@@ -15,9 +13,9 @@ features[variable][] = panelizer_defaults_node_event
 files[] = commons_events_pages.features.inc
 files[] = commons_events_pages.strongarm.inc
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info b/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
index 40c7500..b609b64 100644
--- a/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
+++ b/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
@@ -2,7 +2,6 @@ name = Commons Events - Solr
 description = Provides the Solr based faceted search for events
 core = 7.x
 package = Commons - Search
-project = commons_events_solr
 dependencies[] = apachesolr_search
 dependencies[] = commons_events
 dependencies[] = ctools
@@ -21,9 +20,9 @@ features[page_manager_existing_pages][] = solr_events_search
 features[page_manager_handlers][] = pm_existing_pages_solr_events_search_panel_context
 features[variable][] = pm_existing_pages_disabled_solr_events_search
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_featured/commons_featured.info b/profiles/commons/modules/commons/commons_featured/commons_featured.info
index 986ad72..d3b7879 100644
--- a/profiles/commons/modules/commons/commons_featured/commons_featured.info
+++ b/profiles/commons/modules/commons/commons_featured/commons_featured.info
@@ -2,17 +2,15 @@ name = Commons Featured Content
 description = Allows community managers to display certain pieces of content more prominently on the site.
 core = 7.x
 package = Commons - Building blocks
-project = commons_featured
 dependencies[] = views
 dependencies[] = views_content
-datestamp = 1354747305
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[views_view][] = commons_featured
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons-follow-otheruser-flag.tpl.php b/profiles/commons/modules/commons/commons_follow/commons-follow-otheruser-flag.tpl.php
new file mode 100644
index 0000000..7a028bd
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_follow/commons-follow-otheruser-flag.tpl.php
@@ -0,0 +1,3 @@
+<span class="<?php print $flag_wrapper_classes; ?>">
+   <span class="<?php print $flag_classes ?>"><?php print $link_text; ?></span>
+</span>
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow.info b/profiles/commons/modules/commons/commons_follow/commons_follow.info
index 4ab9220..0d4e87e 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow.info
@@ -2,14 +2,12 @@ name = Commons Follow
 description = Views and Field integration for Commons Following functionality.
 core = 7.x
 package = Commons - Building blocks
-project = commons_follow
 dependencies[] = ctools
 dependencies[] = entityreference
 dependencies[] = features
 dependencies[] = field_sql_storage
 dependencies[] = message_subscribe
 dependencies[] = strongarm
-datestamp = 1354747305
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
 features[field_base][] = field_target_comments
@@ -24,10 +22,10 @@ files[] = includes/views/handlers/commons_follow_plugin_argument_default_node.in
 files[] = includes/views/handlers/commons_follow_plugin_argument_default_message.inc
 files[] = includes/views/handlers/commons_follow_user_follow_filter.inc
 files[] = includes/views/handlers/commons_follow_user_follow_filter_message.inc
-
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+files[] = includes/views/handlers/commons_follow_handler_field_ops.inc
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow.module b/profiles/commons/modules/commons/commons_follow/commons_follow.module
index ed60c9a..f6c6c62 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow.module
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow.module
@@ -2,7 +2,22 @@
 
 include_once 'commons_follow.features.inc';
 
-
+/**
+ * Implements hook_theme().
+ */
+function commons_follow_theme() {
+  return array(
+    'commons_follow_otheruser_flag' => array(
+      'variables' => array(
+        'is_flagged' => NULL,
+        'link_text' => NULL,
+        'flag_wrapper_classes' => NULL,
+        'flag_classes' => NULL,
+      ),
+      'template' => 'commons-follow-otheruser-flag',
+    ),
+  );
+}
 
 /**
  * Implements hook_features_pipe_alter().
@@ -198,10 +213,8 @@ function commons_follow_get_subscription_flags_ids($content_type = NULL, $conten
   return $flag_ids;
 }
 
-///////////////////
-
 /**
- * Implementation of hook_views_api().
+ * Implements hook_views_api().
  */
 function commons_follow_views_api() {
   return array(
@@ -283,3 +296,27 @@ function commons_follow_get_followed_message_ids($account = NULL) {
   }
   return $followed_mids;
 }
+
+function commons_follow_views_data_alter(&$data) {
+  $data['flag_content']['ops']['field']['handler'] = 'commons_follow_handler_field_ops';
+}
+
+function commons_follow_views_query_alter(&$view, &$query) {
+  global $user;
+  $prefix = variable_get('message_subscribe_flag_prefix', 'subscribe') . '_';
+  if(strpos($view->name, $prefix) === 0 && isset($view->args[0]) && $user->uid != $view->args[0]) {
+    $flag_content_keys = array_keys($query->table_queue);
+    foreach($flag_content_keys AS $key) {
+      if(strpos($key, 'flag_content') === 0) {
+        //Convert the Send Email Query
+        $join = $query->table_queue[$key]['join'];
+        $join->extra[1] = array(
+          'field' => 'uid',
+          'value' => $view->args[0],
+          'numeric' => TRUE,
+        );
+        $query->table_queue[$key]['join'] = $join;
+      }
+    }
+  }
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info b/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
index 08650cf..ba022fa 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
@@ -2,21 +2,19 @@ name = Commons Follow (Groups)
 description = Lets users follow individual organic groups.
 core = 7.x
 package = Commons - Building blocks
-project = commons_follow
 dependencies[] = ctools
 dependencies[] = flag
 dependencies[] = og
 dependencies[] = strongarm
-datestamp = 1352387638
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
 features[flag][] = commons_follow_group
 features[flag][] = email_group
 features[variable][] = message_subscribe_og
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
index 098d033..71623e6 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
@@ -2,11 +2,9 @@ name = Commons Follow (Individual nodes)
 description = Lets users follow individual nodes.
 core = 7.x
 package = Commons - Building blocks
-project = commons_follow
 dependencies[] = ctools
 dependencies[] = flag
 dependencies[] = views_litepager
-datestamp = 1356630025
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[flag][] = commons_follow_node
@@ -14,9 +12,9 @@ features[flag][] = email_node
 features[views_view][] = commons_follow_node
 features_exclude[dependencies][views] = views
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.install b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.install
index fbbcb99..6d08f0c 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.install
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.install
@@ -6,4 +6,16 @@
 function commons_follow_node_update_3101() {
   features_revert(array('commons_follow_node' => array('flag')));
   return array();
+}
+
+/**
+ * Update profile notification page to show an account's following views
+ * Not the current users following view.
+ */
+function commons_follow_node_update_3501() {
+  $revert = array(
+    'commons_follow_node' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.views_default.inc b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.views_default.inc
index 4598cfc..8db8038 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.views_default.inc
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.views_default.inc
@@ -27,6 +27,7 @@ function commons_follow_node_views_default_views() {
   $handler->display->display_options['access']['type'] = 'perm';
   $handler->display->display_options['cache']['type'] = 'none';
   $handler->display->display_options['query']['type'] = 'views_query';
+  $handler->display->display_options['query']['options']['distinct'] = TRUE;
   $handler->display->display_options['exposed_form']['type'] = 'basic';
   $handler->display->display_options['pager']['type'] = 'lite';
   $handler->display->display_options['pager']['options']['items_per_page'] = '20';
@@ -72,6 +73,7 @@ function commons_follow_node_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel']['table'] = 'node';
   $handler->display->display_options['relationships']['flag_content_rel']['field'] = 'flag_content_rel';
   $handler->display->display_options['relationships']['flag_content_rel']['flag'] = 'commons_follow_node';
+  $handler->display->display_options['relationships']['flag_content_rel']['user_scope'] = 'any';
   /* Relationship: Flags: email_node */
   $handler->display->display_options['relationships']['flag_content_rel_1']['id'] = 'flag_content_rel_1';
   $handler->display->display_options['relationships']['flag_content_rel_1']['table'] = 'node';
@@ -79,6 +81,12 @@ function commons_follow_node_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel_1']['label'] = 'email_flag';
   $handler->display->display_options['relationships']['flag_content_rel_1']['required'] = 0;
   $handler->display->display_options['relationships']['flag_content_rel_1']['flag'] = 'email_node';
+  $handler->display->display_options['relationships']['flag_content_rel_1']['user_scope'] = 'any';
+  /* Relationship: Flags: User */
+  $handler->display->display_options['relationships']['uid']['id'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['table'] = 'flag_content';
+  $handler->display->display_options['relationships']['uid']['field'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['relationship'] = 'flag_content_rel';
   /* Field: Content: Title */
   $handler->display->display_options['fields']['title']['id'] = 'title';
   $handler->display->display_options['fields']['title']['table'] = 'node';
@@ -106,6 +114,19 @@ function commons_follow_node_views_default_views() {
   $handler->display->display_options['sorts']['timestamp']['field'] = 'timestamp';
   $handler->display->display_options['sorts']['timestamp']['relationship'] = 'flag_content_rel';
   $handler->display->display_options['sorts']['timestamp']['order'] = 'DESC';
+  /* Contextual filter: User: Uid */
+  $handler->display->display_options['arguments']['uid']['id'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['table'] = 'users';
+  $handler->display->display_options['arguments']['uid']['field'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['relationship'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['default_action'] = 'default';
+  $handler->display->display_options['arguments']['uid']['default_argument_type'] = 'user';
+  $handler->display->display_options['arguments']['uid']['default_argument_options']['user'] = FALSE;
+  $handler->display->display_options['arguments']['uid']['summary']['number_of_records'] = '0';
+  $handler->display->display_options['arguments']['uid']['summary']['format'] = 'default_summary';
+  $handler->display->display_options['arguments']['uid']['summary_options']['items_per_page'] = '25';
+  $handler->display->display_options['arguments']['uid']['specify_validation'] = TRUE;
+  $handler->display->display_options['arguments']['uid']['validate']['type'] = 'user';
   /* Filter criterion: Content: Published */
   $handler->display->display_options['filters']['status']['id'] = 'status';
   $handler->display->display_options['filters']['status']['table'] = 'node';
@@ -113,6 +134,12 @@ function commons_follow_node_views_default_views() {
   $handler->display->display_options['filters']['status']['value'] = 1;
   $handler->display->display_options['filters']['status']['group'] = 1;
   $handler->display->display_options['filters']['status']['expose']['operator'] = FALSE;
+  /* Filter criterion: Content: Type */
+  $handler->display->display_options['filters']['type']['id'] = 'type';
+  $handler->display->display_options['filters']['type']['table'] = 'node';
+  $handler->display->display_options['filters']['type']['field'] = 'type';
+  $handler->display->display_options['filters']['type']['operator'] = 'not empty';
+  $handler->display->display_options['filters']['type']['value'] = array();
   $translatables['commons_follow_node'] = array(
     t('Master'),
     t('more'),
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
index 60d7d87..b5e1739 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
@@ -2,11 +2,9 @@ name = Commons Follow (Taxonomy terms)
 description = Lets users follow individual taxonomy terms
 core = 7.x
 package = Commons - Building blocks
-project = commons_follow
 dependencies[] = flag
 dependencies[] = views
 dependencies[] = views_litepager
-datestamp = 1356630025
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[flag][] = commons_follow_term
@@ -14,9 +12,9 @@ features[flag][] = email_term
 features[views_view][] = commons_follow_taxonomy_term
 features_exclude[dependencies][ctools] = ctools
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.install b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.install
index 31bda83..77c4c76 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.install
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.install
@@ -15,3 +15,15 @@ function commons_follow_term_update_3102() {
   features_revert(array('commons_follow_term' => array('flag')));
   return array();
 }
+
+/**
+ * Update profile notification page to show an account's following views
+ * Not the current users following view.
+ */
+function commons_follow_term_update_3501() {
+  $revert = array(
+    'commons_follow_term' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.views_default.inc b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.views_default.inc
index be1fa62..21e785a 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.views_default.inc
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.views_default.inc
@@ -72,6 +72,7 @@ function commons_follow_term_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel']['table'] = 'taxonomy_term_data';
   $handler->display->display_options['relationships']['flag_content_rel']['field'] = 'flag_content_rel';
   $handler->display->display_options['relationships']['flag_content_rel']['flag'] = 'commons_follow_term';
+  $handler->display->display_options['relationships']['flag_content_rel']['user_scope'] = 'any';
   /* Relationship: Flags: email_term */
   $handler->display->display_options['relationships']['flag_content_rel_1']['id'] = 'flag_content_rel_1';
   $handler->display->display_options['relationships']['flag_content_rel_1']['table'] = 'taxonomy_term_data';
@@ -79,6 +80,12 @@ function commons_follow_term_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel_1']['label'] = 'email_flag';
   $handler->display->display_options['relationships']['flag_content_rel_1']['required'] = 0;
   $handler->display->display_options['relationships']['flag_content_rel_1']['flag'] = 'email_term';
+  $handler->display->display_options['relationships']['flag_content_rel_1']['user_scope'] = 'any';
+  /* Relationship: Flags: User */
+  $handler->display->display_options['relationships']['uid']['id'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['table'] = 'flag_content';
+  $handler->display->display_options['relationships']['uid']['field'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['relationship'] = 'flag_content_rel';
   /* Field: Taxonomy term: Name */
   $handler->display->display_options['fields']['name']['id'] = 'name';
   $handler->display->display_options['fields']['name']['table'] = 'taxonomy_term_data';
@@ -107,6 +114,7 @@ function commons_follow_term_views_default_views() {
   $handler->display->display_options['sorts']['timestamp']['relationship'] = 'flag_content_rel';
   $handler->display->display_options['sorts']['timestamp']['order'] = 'DESC';
   $translatables['commons_follow_taxonomy_term'] = array(
+  /* Contextual filter: User: Uid */
     t('Master'),
     t('more'),
     t('Apply'),
@@ -127,6 +135,19 @@ function commons_follow_term_views_default_views() {
     t('Topic'),
     t('Send email?'),
   );
+  $handler->display->display_options['arguments']['uid']['id'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['table'] = 'users';
+  $handler->display->display_options['arguments']['uid']['field'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['relationship'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['default_action'] = 'default';
+  $handler->display->display_options['arguments']['uid']['default_argument_type'] = 'user';
+  $handler->display->display_options['arguments']['uid']['default_argument_options']['user'] = FALSE;
+  $handler->display->display_options['arguments']['uid']['summary']['number_of_records'] = '0';
+  $handler->display->display_options['arguments']['uid']['summary']['format'] = 'default_summary';
+  $handler->display->display_options['arguments']['uid']['summary_options']['items_per_page'] = '25';
+  $handler->display->display_options['arguments']['uid']['specify_validation'] = TRUE;
+  $handler->display->display_options['arguments']['uid']['validate']['type'] = 'user';
+  $handler->display->display_options['arguments']['uid']['validate_options']['type'] = 'either';
   $export['commons_follow_taxonomy_term'] = $view;
 
   return $export;
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
index f720ebc..c799b35 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
@@ -6,9 +6,9 @@ dependencies[] = commons_follow
 dependencies[] = message_subscribe_ui
 dependencies[] = quicktabs
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.module b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.module
index f8ebd9b..65ef59c 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.module
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.module
@@ -63,8 +63,8 @@ function commons_follow_ui_commons_utility_links_alter(&$links) {
 }
 
 function commons_follow_ui_notification_settings_form($form, &$form_state, $account) {
+  global $user;
   if (empty($account)) {
-    global $user;
     $account = $user;
   }
   drupal_set_title(t('Notification settings'));
@@ -88,6 +88,9 @@ function commons_follow_ui_notification_settings_form($form, &$form_state, $acco
     '#default_value' => isset($account->message_subscribe_email[LANGUAGE_NONE][0]['value']) ? $account->message_subscribe_email[LANGUAGE_NONE][0]['value'] : FALSE,
     '#weight' => 1,
   );
+  if($account != $user) {
+    $form['message_subscribe_email']['#disabled'] = TRUE;
+  }
 
   $form['submit'] = array(
     '#type' => 'submit',
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
index cae125c..5297d19 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
@@ -2,7 +2,6 @@ name = Commons Follow (Users)
 description = Lets users follow other users.
 core = 7.x
 package = Commons - Building blocks
-project = commons_follow
 dependencies[] = commons_follow
 dependencies[] = entityreference
 dependencies[] = flag
@@ -11,7 +10,6 @@ dependencies[] = views
 dependencies[] = views_content
 dependencies[] = views_litepager
 dependencies[] = views_load_more
-datestamp = 1356630025
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[field_instance][] = message-commons_follow_user_user_followed-field_target_users
@@ -22,9 +20,9 @@ features[views_view][] = commons_follow_user
 features[views_view][] = commons_follow_user_followers
 features[views_view][] = commons_follow_user_following
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.install b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.install
index 157ef4e..e5e35a5 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.install
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.install
@@ -6,4 +6,24 @@
 function commons_follow_user_update_3101() {
   features_revert(array('commons_follow_user' => array('flag')));
   return array();
+}
+
+/**
+ * Correct a typo in the title of the follows view.
+ */
+function commons_follow_user_update_3102() {
+  features_revert(array('commons_follow_user' => array('views_view')));
+  return array();
+}
+
+/**
+ * Update profile notification page to show an account's following views
+ * Not the current users following view.
+ */
+function commons_follow_user_update_3501() {
+  $revert = array(
+    'commons_follow_user' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.views_default.inc b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.views_default.inc
index da6b6cd..fa18e54 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.views_default.inc
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.views_default.inc
@@ -73,6 +73,7 @@ function commons_follow_user_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel']['table'] = 'users';
   $handler->display->display_options['relationships']['flag_content_rel']['field'] = 'flag_content_rel';
   $handler->display->display_options['relationships']['flag_content_rel']['flag'] = 'commons_follow_user';
+  $handler->display->display_options['relationships']['flag_content_rel']['user_scope'] = 'any';
   /* Relationship: Flags: email_user */
   $handler->display->display_options['relationships']['flag_content_rel_1']['id'] = 'flag_content_rel_1';
   $handler->display->display_options['relationships']['flag_content_rel_1']['table'] = 'users';
@@ -80,6 +81,12 @@ function commons_follow_user_views_default_views() {
   $handler->display->display_options['relationships']['flag_content_rel_1']['label'] = 'flag_user';
   $handler->display->display_options['relationships']['flag_content_rel_1']['required'] = 0;
   $handler->display->display_options['relationships']['flag_content_rel_1']['flag'] = 'email_user';
+  $handler->display->display_options['relationships']['flag_content_rel_1']['user_scope'] = 'any';
+  /* Relationship: Flags: User */
+  $handler->display->display_options['relationships']['uid']['id'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['table'] = 'flag_content';
+  $handler->display->display_options['relationships']['uid']['field'] = 'uid';
+  $handler->display->display_options['relationships']['uid']['relationship'] = 'flag_content_rel';
   /* Field: User: Name */
   $handler->display->display_options['fields']['name']['id'] = 'name';
   $handler->display->display_options['fields']['name']['table'] = 'users';
@@ -106,6 +113,20 @@ function commons_follow_user_views_default_views() {
   $handler->display->display_options['sorts']['timestamp']['field'] = 'timestamp';
   $handler->display->display_options['sorts']['timestamp']['relationship'] = 'flag_content_rel';
   $handler->display->display_options['sorts']['timestamp']['order'] = 'DESC';
+  /* Contextual filter: User: Uid */
+  $handler->display->display_options['arguments']['uid']['id'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['table'] = 'users';
+  $handler->display->display_options['arguments']['uid']['field'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['relationship'] = 'uid';
+  $handler->display->display_options['arguments']['uid']['default_action'] = 'default';
+  $handler->display->display_options['arguments']['uid']['default_argument_type'] = 'user';
+  $handler->display->display_options['arguments']['uid']['default_argument_options']['user'] = FALSE;
+  $handler->display->display_options['arguments']['uid']['summary']['number_of_records'] = '0';
+  $handler->display->display_options['arguments']['uid']['summary']['format'] = 'default_summary';
+  $handler->display->display_options['arguments']['uid']['summary_options']['items_per_page'] = '25';
+  $handler->display->display_options['arguments']['uid']['specify_validation'] = TRUE;
+  $handler->display->display_options['arguments']['uid']['validate']['type'] = 'user';
+  $handler->display->display_options['arguments']['uid']['validate_options']['type'] = 'either';
   /* Filter criterion: User: Active */
   $handler->display->display_options['filters']['status']['id'] = 'status';
   $handler->display->display_options['filters']['status']['table'] = 'users';
@@ -369,7 +390,7 @@ function commons_follow_user_views_default_views() {
   /* Display: Page */
   $handler = $view->new_display('page', 'Page', 'page_1');
   $handler->display->display_options['defaults']['title'] = FALSE;
-  $handler->display->display_options['title'] = 'People %1 fllows';
+  $handler->display->display_options['title'] = 'People %1 follows';
   $handler->display->display_options['defaults']['hide_admin_links'] = FALSE;
   $handler->display->display_options['defaults']['use_more'] = FALSE;
   $handler->display->display_options['defaults']['use_more_always'] = FALSE;
@@ -401,7 +422,7 @@ function commons_follow_user_views_default_views() {
     t('more'),
     t('Commons'),
     t('Page'),
-    t('People %1 fllows'),
+    t('People %1 follows'),
     t('Items per page'),
     t('- All -'),
     t('Offset'),
diff --git a/profiles/commons/modules/commons/commons_follow/includes/views/handlers/commons_follow_handler_field_ops.inc b/profiles/commons/modules/commons/commons_follow/includes/views/handlers/commons_follow_handler_field_ops.inc
new file mode 100644
index 0000000..3770782
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_follow/includes/views/handlers/commons_follow_handler_field_ops.inc
@@ -0,0 +1,62 @@
+<?php
+
+/**
+ * @file
+ * Contains the flag Ops field handler.
+ */
+
+/**
+ * Views field handler for the Flag operations links (flag/unflag).
+ *
+ * @ingroup views
+ */
+class commons_follow_handler_field_ops extends flag_handler_field_ops {
+
+  function render($values) {
+    global $user;
+    //If the passed in user doesn't match the current user
+    if(isset($this->view->args[0]) && $user->uid != $this->view->args[0]) {
+
+      if (!($flag = $this->get_flag())) {
+        // get_flag() itself will print a more detailed message.
+        return t('Missing flag');
+      }
+      $content_id = $values->{$this->aliases['content_id']};
+      $is_flagged = $values->{$this->aliases['is_flagged']};
+
+      if (empty($this->flag_applies[$content_id])) {
+        // Flag does not apply to this content.
+        return;
+      }
+
+      if (!empty($this->options['link_type'])) {
+        $flag->link_type = $this->options['link_type'];
+      }
+
+      $variables = array();
+      $action = $is_flagged ? 'unflag' : 'flag';
+      $variables['flag_css_name'] = str_replace('_', '-', $flag->name);
+
+      $flag_wrapper_classes_array = array();
+      $flag_wrapper_classes_array[] = 'flag-wrapper';
+      $flag_wrapper_classes_array[] = 'flag-' . $variables['flag_css_name'];
+      $flag_wrapper_classes_array[] = 'flag-' . $variables['flag_css_name'] . '-' . $content_id;
+      $variables['flag_wrapper_classes'] = implode(' ',$flag_wrapper_classes_array);
+
+      $flag_classes_array = array();
+      $flag_classes_array[] = 'flag';
+      $flag_classes_array[] = $action . '-action';
+      $flag_classes_array[] = 'flag-link-' . $flag->link_type;
+      $variables['flag_classes'] = implode(' ', $flag_classes_array);
+      $variables['is_flagged'] = $action;
+      $variables['link_text'] = $flag->get_label($action . '_short', $content_id);
+
+      return theme('commons_follow_otheruser_flag', $variables);
+    }
+    else {
+      return parent::render($values);
+    }
+
+//    return $flag->theme($is_flagged ? 'unflag' : 'flag', $content_id);
+  }
+}
diff --git a/profiles/commons/modules/commons/commons_groups/commons_groups.info b/profiles/commons/modules/commons/commons_groups/commons_groups.info
index 66a319e..3574b2e 100644
--- a/profiles/commons/modules/commons/commons_groups/commons_groups.info
+++ b/profiles/commons/modules/commons/commons_groups/commons_groups.info
@@ -2,8 +2,6 @@ name = Commons Groups
 description = Commons Organic Groups Functionality
 core = 7.x
 package = Commons - Building blocks
-version = 7.x-3.0
-project = commons_groups
 dependencies[] = commons_body
 dependencies[] = commons_bw
 dependencies[] = commons_topics
@@ -75,9 +73,9 @@ features[views_view][] = commons_groups_user_groups
 features_exclude[field][node-group-group_group] = node-group-group_group
 features_exclude[field][node-group-group_access] = node-group-group_access
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_groups/commons_groups.install b/profiles/commons/modules/commons/commons_groups/commons_groups.install
index f526d52..f4ec12b 100644
--- a/profiles/commons/modules/commons/commons_groups/commons_groups.install
+++ b/profiles/commons/modules/commons/commons_groups/commons_groups.install
@@ -177,3 +177,14 @@ function commons_groups_update_3113() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_groups_update_3114() {
+  $revert = array(
+    'commons_groups' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_groups/commons_groups.module b/profiles/commons/modules/commons/commons_groups/commons_groups.module
index 46e8b15..d28beb2 100644
--- a/profiles/commons/modules/commons/commons_groups/commons_groups.module
+++ b/profiles/commons/modules/commons/commons_groups/commons_groups.module
@@ -62,7 +62,7 @@ function commons_groups_help($path, $arg) {
       }
     }
     if (user_access('edit any group content')) {
-      $message = t("Group privacy settings !updated.", array('!updated' => l('need to be updated', 'admin/content/groups/update'),));
+      $message = t("Group privacy settings !updated.", array('!updated' => l('need to be updated', 'admin/content/groups/update')));
       drupal_set_message($message, 'warning', FALSE);
     }
   }
@@ -97,7 +97,7 @@ function commons_groups_form_group_node_form_alter(&$form, &$form_state) {
   $form['field_og_subscribe_settings'][LANGUAGE_NONE]['#required'] = FALSE;
 
   if (module_exists('og_access')) {
-    // Display the private content checkbox only when "Joining requires approval"
+    // Display private content checkbox only when "Joining requires approval"
     // is selected.
     $form['field_og_access_default_value']['#states'] = array(
       'visible' => array(
@@ -297,7 +297,7 @@ function commons_groups_group_contributors_count_topics($group) {
     $contributors_count = $view->total_rows;
     $output .= l(t('@contributors_count @contributors', array(
       '@contributors_count' => $contributors_count,
-      '@contributors' => format_plural($contributors_count, 'contributor', 'contributors')
+      '@contributors' => format_plural($contributors_count, 'contributor', 'contributors'),
     )), 'node/' . $group->nid . '/contributors');
   }
   // Format the list of topics:
@@ -378,6 +378,22 @@ function commons_groups_form_alter(&$form, &$form_state, $form_id) {
       drupal_set_message(t($message), 'warning');
     }
   }
+  // Hide internal fields that the user should not be able to edit directly.
+  if ($form_id == 'edit_profile_user_profile_form' || substr($form_id, -10) === '_node_form') {
+    $internal_fields = array('field_unread_invitations', 'field_unread_messages', 'user_trusted_contacts', 'og_user_group_ref', 'group_access');
+    foreach ($internal_fields as $field_name) {
+      if(isset($form[$field_name])) {
+        $form[$field_name]['#access'] = FALSE;
+      }
+    }
+  }
+  // Disable Trusted Contacts field if commons_trusted_contacts is disabled.
+  $group_content_entity_types = commons_groups_get_group_content_entity_types();
+  if (isset($form['#node']->type) && isset($group_content_entity_types['node'][$form['#node']->type])) {
+    if (isset($form['og_user_group_ref']) && !module_exists('commons_trusted_contacts')) {
+      $form['og_user_group_ref']['#access'] = FALSE;
+    }
+  }
 }
 
 /**
@@ -583,14 +599,14 @@ function commons_groups_message_partial_default() {
 function commons_groups_related_groups_text($related_groups) {
   // In 1 group: "in the x group"
   if (count($related_groups) == 1) {
-    return t(' in the !group group', array('!group' => l($related_groups[0]->title, 'node/' . $related_groups[0]->nid)));
+    return ' ' . t('in the !group group', array('!group' => l($related_groups[0]->title, 'node/' . $related_groups[0]->nid)));
   }
 
   // In 2 groups: "in the x and y groups"
   if (count($related_groups) == 2) {
-    return t(' in the !group-0 and !group-1 groups', array(
+    return ' ' . t('in the !group-0 and !group-1 groups', array(
       '!group-0' => l($related_groups[0]->title, 'node/' . $related_groups[0]->nid),
-      '!group-1' => l($related_groups[1]->title, 'node/' . $related_groups[1]->nid)
+      '!group-1' => l($related_groups[1]->title, 'node/' . $related_groups[1]->nid),
     ));
   }
 
@@ -674,20 +690,6 @@ function commons_groups_default_rules_configuration_alter(&$configs) {
 }
 
 /**
- * Implements hook_node_validate().
- */
-function commons_groups_node_validate($node, $form, &$form_state) {
-  // Ensure that group content is always posted to one or more groups.
-  // When the Commons Trusted Contacts module is enabled, we defer to its
-  // own form validation which ensures that group content nodes are posted
-  // either to a node group via the og_group_ref field or to a user group
-  // via the og_user_group_ref field.
-  if (!module_exists('commons_truste_contacts') && og_is_group_content_type('node', $node->type) && empty($form_state['values']['og_group_ref'][LANGUAGE_NONE][0]['target_id'])) {
-    form_set_error('og_group_ref', t('Please enter one more groups where this content will be posted.'));
-  }
-}
-
-/**
  * Implements hook_node_presave().
  *
  * When the node's group is private, force the group content to be private.
diff --git a/profiles/commons/modules/commons/commons_groups/commons_groups.views_default.inc b/profiles/commons/modules/commons/commons_groups/commons_groups.views_default.inc
index b123b4f..d7d4671 100644
--- a/profiles/commons/modules/commons/commons_groups/commons_groups.views_default.inc
+++ b/profiles/commons/modules/commons/commons_groups/commons_groups.views_default.inc
@@ -64,6 +64,7 @@ function commons_groups_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
index 34e6643..cbf4a1e 100644
--- a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
+++ b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
@@ -2,7 +2,6 @@ name = Commons Groups Directory
 description = The site-wide directory of groups
 core = 7.x
 package = Commons - Landing pages
-project = commons_groups
 dependencies[] = commons_activity_streams_groups
 dependencies[] = commons_radioactivity_groups
 dependencies[] = ctools
@@ -10,16 +9,15 @@ dependencies[] = page_manager
 dependencies[] = panelizer
 dependencies[] = panels_ipe
 dependencies[] = views_content
-datestamp = 1354346062
 features[ctools][] = page_manager:pages_default:1
 features[ctools][] = panelizer:panelizer:1
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[page_manager_pages][] = groups_directory
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
index 71351c9..d28d17c 100644
--- a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
+++ b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
@@ -2,7 +2,6 @@ name = Commons Group Homepages
 description = Provides a default home page for groups
 core = 7.x
 package = Commons - Landing pages
-project = commons_groups
 dependencies[] = commons_activity_streams
 dependencies[] = commons_bw
 dependencies[] = commons_follow_group
@@ -10,7 +9,6 @@ dependencies[] = commons_radioactivity_groups
 dependencies[] = ctools
 dependencies[] = panelizer
 dependencies[] = strongarm
-datestamp = 1354346062
 features[ctools][] = panelizer:panelizer:1
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
@@ -18,9 +16,9 @@ features[panelizer_defaults][] = node:group:default
 features[panelizer_defaults][] = node:group:default:teaser
 features[variable][] = panelizer_defaults_node_group
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
index df99869..2d9fc6f 100644
--- a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
+++ b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
@@ -30,9 +30,9 @@ features[rules_config][] = rules_commons_kissmetrics_user_registers
 features[rules_config][] = rules_commons_kissmetrics_user_replies_to_private_message_thread
 features[rules_config][] = rules_commons_kissmetrics_user_starts_new_private_message_thread
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.rules_defaults.inc b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.rules_defaults.inc
index 645aef7..7d64ab8 100644
--- a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.rules_defaults.inc
+++ b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.rules_defaults.inc
@@ -12,6 +12,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_collect_referenced_groups'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_collect_referenced_groups" : {
       "LABEL" : "Commons KISSmetrics: Collect Referenced Groups",
       "PLUGIN" : "rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules" ],
       "USES VARIABLES" : {
@@ -45,6 +46,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_adds_a_trusted_contact'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_adds_a_trusted_contact" : {
       "LABEL" : "Commons KISSmetrics: User Adds A Trusted Contact",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "og" ],
       "ON" : { "og_user_insert" : [] },
@@ -61,6 +63,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_approves_a_trusted_contact'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_approves_a_trusted_contact" : {
       "LABEL" : "Commons KISSmetrics: User Approves A Trusted Contact",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "og" ],
       "ON" : { "og_user_approved" : [] },
@@ -77,6 +80,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_creates_content'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_creates_content" : {
       "LABEL" : "Commons KISSmetrics: User Creates Content",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "node_insert" : [] },
@@ -97,6 +101,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_edits_profile'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_edits_profile" : {
       "LABEL" : "Commons KISSmetrics: User Edits Profile",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "user_update" : [] },
@@ -108,6 +113,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_edits_wiki'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_edits_wiki" : {
       "LABEL" : "Commons KISSmetrics: User Edits Wiki",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "node_update" : [] },
@@ -131,6 +137,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_flags_content_as_inappropriate'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_flags_content_as_inappropriate" : {
       "LABEL" : "Commons KISSmetrics: User Flags Content As Inappropriate",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "flag" ],
       "ON" : { "flag_flagged_inappropriate_node" : [] },
@@ -146,6 +153,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_follows_content'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_follows_content" : {
       "LABEL" : "Commons KISSmetrics: User Follows Content",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "flag" ],
       "ON" : { "flag_flagged_commons_follow_node" : [] },
@@ -166,6 +174,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_follows_group'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_follows_group" : {
       "LABEL" : "Commons KISSmetrics: User Follows Group",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "flag" ],
       "ON" : { "flag_flagged_commons_follow_group" : [] },
@@ -181,6 +190,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_follows_topic'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_follows_topic" : {
       "LABEL" : "Commons KISSmetrics: User Follows Topic",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "flag" ],
       "ON" : { "flag_flagged_commons_follow_term" : [] },
@@ -196,6 +206,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_follows_user'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_follows_user" : {
       "LABEL" : "Commons KISSmetrics: User Follows User",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "flag" ],
       "ON" : { "flag_flagged_commons_follow_user" : [] },
@@ -211,6 +222,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_likes_content'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_likes_content" : {
       "LABEL" : "Commons KISSmetrics: User Likes Content",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "voting_rules" ],
       "ON" : { "voting_rules_insert_node" : [] },
@@ -222,6 +234,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_logs_in'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_logs_in" : {
       "LABEL" : "Commons KISSmetrics: User Logs In",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "user_login" : [] },
@@ -233,6 +246,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_logs_out'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_logs_out" : {
       "LABEL" : "Commons KISSmetrics: User Logs Out",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "user_logout" : [] },
@@ -244,6 +258,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_posts_comment'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_posts_comment" : {
       "LABEL" : "Commons KISSmetrics: User Posts Comment",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "comment" ],
       "ON" : { "comment_insert" : [] },
@@ -264,6 +279,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_registers'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_registers" : {
       "LABEL" : "Commons KISSmetrics: User Registers",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics" ],
       "ON" : { "user_insert" : [] },
@@ -275,6 +291,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_replies_to_private_message_thread'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_replies_to_private_message_thread" : {
       "LABEL" : "Commons KISSmetrics: User Replies To Private Message Thread",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "privatemsg_rules" ],
       "ON" : { "privatemsg_insert" : [] },
@@ -293,6 +310,7 @@ function commons_kissmetrics_default_rules_configuration() {
   $items['rules_commons_kissmetrics_user_starts_new_private_message_thread'] = entity_import('rules_config', '{ "rules_commons_kissmetrics_user_starts_new_private_message_thread" : {
       "LABEL" : "Commons KISSmetrics: User Starts New Private Message Thread",
       "PLUGIN" : "reaction rule",
+      "OWNER" : "rules",
       "TAGS" : [ "Commons KISSmetrics" ],
       "REQUIRES" : [ "rules", "kissmetrics", "privatemsg_rules" ],
       "ON" : { "privatemsg_insert" : [] },
diff --git a/profiles/commons/modules/commons/commons_like/commons_like.info b/profiles/commons/modules/commons/commons_like/commons_like.info
index dca692a..bf39558 100644
--- a/profiles/commons/modules/commons/commons_like/commons_like.info
+++ b/profiles/commons/modules/commons/commons_like/commons_like.info
@@ -2,7 +2,6 @@ name = Commons Like
 description = Community members can indicate that they like content and comments.
 core = 7.x
 package = Commons - Building blocks
-project = commons_like
 dependencies[] = entityreference
 dependencies[] = features
 dependencies[] = message
@@ -14,9 +13,9 @@ features[features_api][] = api:2
 features[field_instance][] = message-commons_like_user_likes_node-field_target_nodes
 features[message_type][] = commons_like_user_likes_node
 features[variable][] = rate_widgets
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_location/commons_location.info b/profiles/commons/modules/commons/commons_location/commons_location.info
index f84917c..9144afd 100644
--- a/profiles/commons/modules/commons/commons_location/commons_location.info
+++ b/profiles/commons/modules/commons/commons_location/commons_location.info
@@ -8,9 +8,9 @@ dependencies[] = field_sql_storage
 features[features_api][] = api:2
 features[field_base][] = field_address
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.css b/profiles/commons/modules/commons/commons_media/commons_media.css
new file mode 100644
index 0000000..e8e96ab
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.css
@@ -0,0 +1,22 @@
+video {
+  height: auto;
+  max-width: 100%;
+}
+
+.oembed {
+  height: 0;
+  overflow: hidden;
+  padding-bottom: 56.25%;
+  padding-top: 30px;
+  position: relative;
+}
+
+.oembed iframe,
+.oembed object,
+.oembed embed {
+  height: 100%;
+  left: 0;
+  position: absolute;
+  top: 0;
+  width: 100%;
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.features.field_base.inc b/profiles/commons/modules/commons/commons_media/commons_media.features.field_base.inc
new file mode 100644
index 0000000..3a93532
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.features.field_base.inc
@@ -0,0 +1,45 @@
+<?php
+/**
+ * @file
+ * commons_media.features.field_base.inc
+ */
+
+/**
+ * Implements hook_field_default_field_bases().
+ */
+function commons_media_field_default_field_bases() {
+  $field_bases = array();
+
+  // Exported field_base: 'field_media'
+  $field_bases['field_media'] = array(
+    'active' => 1,
+    'cardinality' => -1,
+    'deleted' => 0,
+    'entity_types' => array(),
+    'field_name' => 'field_media',
+    'foreign keys' => array(
+      'fid' => array(
+        'columns' => array(
+          'fid' => 'fid',
+        ),
+        'table' => 'file_managed',
+      ),
+    ),
+    'indexes' => array(
+      'fid' => array(
+        0 => 'fid',
+      ),
+    ),
+    'locked' => 0,
+    'module' => 'file',
+    'settings' => array(
+      'display_default' => 0,
+      'display_field' => 0,
+      'uri_scheme' => 'public',
+    ),
+    'translatable' => 0,
+    'type' => 'file',
+  );
+
+  return $field_bases;
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc b/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc
new file mode 100644
index 0000000..b8afdfa
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc
@@ -0,0 +1,96 @@
+<?php
+/**
+ * @file
+ * commons_media.features.field_instance.inc
+ */
+
+/**
+ * Implements hook_field_default_field_instances().
+ */
+function commons_media_field_default_field_instances() {
+  $field_instances = array();
+
+  $commons_groups_entity_types = commons_groups_get_group_content_entity_types();
+  if (!empty($commons_groups_entity_types)) {
+    foreach ($commons_groups_entity_types as $entity_type => $bundles) {
+      foreach(array_keys($bundles) as $bundle) {
+        commons_media_field_definition($field_instances, $entity_type, $bundle);
+      }
+    }
+  }
+
+  return $field_instances;
+}
+
+function commons_media_field_definition(&$field_instances, $entity_type, $bundle) {
+  // Exported field_instance: 'entity-bundle-field_media'
+  $field_instances["$entity_type-$bundle-field_media"] = array(
+    'bundle' => $bundle,
+    'deleted' => 0,
+    'description' => 'Attach an image or video.',
+    'display' => array(
+      'default' => array(
+        'label' => 'hidden',
+        'module' => 'file_entity',
+        'settings' => array(
+          'file_view_mode' => 'full',
+        ),
+        'type' => 'file_rendered',
+        'weight' => 0,
+      ),
+      'teaser' => array(
+        'label' => 'hidden',
+        'module' => 'file_entity',
+        'settings' => array(
+          'file_view_mode' => 'teaser',
+        ),
+        'type' => 'file_rendered',
+        'weight' => 0,
+      ),
+    ),
+    'display_in_partial_form' => 1,
+    'entity_type' => 'node',
+    'field_name' => 'field_media',
+    'label' => 'Media',
+    'required' => 0,
+    'settings' => array(
+      'description_field' => 0,
+      'file_directory' => 'media',
+      'file_extensions' => 'jpg jpeg gif png oembed mov mp4 m4v mpeg avi ogv webp webm',
+      'max_filesize' => '',
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'media',
+      'settings' => array(
+        'allowed_schemes' => array(
+          'oembed' => 'oembed',
+          'public' => 'public',
+        ),
+        'allowed_types' => array(
+          'audio' => 0,
+          'document' => 0,
+          'image' => 'image',
+          'video' => 'video',
+        ),
+        'browser_plugins' => array(
+          'media_default--media_browser_1' => 0,
+          'media_default--media_browser_my_files' => 0,
+          'media_internet' => 'media_internet',
+          'upload' => 'upload',
+        ),
+        'progress_indicator' => 'throbber',
+      ),
+      'type' => 'media_generic',
+      'weight' => 2,
+    ),
+  );
+
+  // Translatables
+  // Included for use with string extractors like potx.
+  t('Attach an image or video.');
+  t('Media');
+
+  return $field_instances;
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.features.inc b/profiles/commons/modules/commons/commons_media/commons_media.features.inc
new file mode 100644
index 0000000..b77b46f
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.features.inc
@@ -0,0 +1,14 @@
+<?php
+/**
+ * @file
+ * commons_media.features.inc
+ */
+
+/**
+ * Implements hook_ctools_plugin_api().
+ */
+function commons_media_ctools_plugin_api($module = NULL, $api = NULL) {
+  if ($module == "strongarm" && $api == "strongarm") {
+    return array("version" => "1");
+  }
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.features.user_permission.inc b/profiles/commons/modules/commons/commons_media/commons_media.features.user_permission.inc
new file mode 100644
index 0000000..84af5ff
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.features.user_permission.inc
@@ -0,0 +1,34 @@
+<?php
+/**
+ * @file
+ * commons_media.features.user_permission.inc
+ */
+
+/**
+ * Implements hook_user_default_permissions().
+ */
+function commons_media_user_default_permissions() {
+  $permissions = array();
+
+  // Exported permission: 'add media from remote sources'.
+  $permissions['add media from remote sources'] = array(
+    'name' => 'add media from remote sources',
+    'roles' => array(
+      'administrator' => 'administrator',
+      'authenticated user' => 'authenticated user',
+    ),
+    'module' => 'media_internet',
+  );
+
+  // Exported permission: 'create files'.
+  $permissions['create files'] = array(
+    'name' => 'create files',
+    'roles' => array(
+      'administrator' => 'administrator',
+      'authenticated user' => 'authenticated user',
+    ),
+    'module' => 'file_entity',
+  );
+
+  return $permissions;
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.info b/profiles/commons/modules/commons/commons_media/commons_media.info
new file mode 100644
index 0000000..8d44440
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.info
@@ -0,0 +1,25 @@
+name = Commons Media
+description = Provides media handling capabilities.
+core = 7.x
+package = Commons - Building blocks
+dependencies[] = ctools
+dependencies[] = features
+dependencies[] = file
+dependencies[] = file_entity
+dependencies[] = media
+dependencies[] = media_internet
+dependencies[] = oembed
+dependencies[] = strongarm
+features[ctools][] = strongarm:strongarm:1
+features[features_api][] = api:2
+features[field_base][] = field_media
+features[user_permission][] = add media from remote sources
+features[user_permission][] = create files
+features[variable][] = media__dialog_theme
+
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
+core = "7.x"
+project = "commons"
+datestamp = "1387568907"
+
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.module b/profiles/commons/modules/commons/commons_media/commons_media.module
new file mode 100644
index 0000000..0a6d434
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.module
@@ -0,0 +1,91 @@
+<?php
+/**
+ * @file
+ * Code for the Commons Media feature.
+ */
+
+include_once 'commons_media.features.inc';
+
+/**
+ * Implements hook_system_info_alter().
+ */
+function commons_media_system_info_alter(&$info, $file, $type) {
+  if ($file->name == 'commons_media') {
+    $entity_integrations = module_invoke_all('commons_entity_integration');
+
+    if (!empty($entity_integrations)) {
+      foreach ($entity_integrations as $entity_type => $bundles) {
+        foreach (array_keys($bundles) as $bundle) {
+          $info['features']['field_instance'][] = "$entity_type-$bundle-field_media";
+        }
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_file_view_alter().
+ */
+function commons_media_file_view_alter(&$build) {
+  $file_type = $build['#bundle'];
+
+  // Add responsive CSS to image and video files.
+  if ($file_type == 'image' || $file_type == 'video') {
+    $build['#attached']['css'][] = drupal_get_path('module', 'commons_media') . '/commons_media.css';
+  }
+}
+
+/**
+ * Implements hook_preprocess_oembed().
+ */
+function commons_media_preprocess_oembed(&$variables) {
+  $embed = $variables['embed'];
+
+  // Video and rich type must have HTML content.
+  // Wrap the HTML content in a <div> to allow it to be made responsive.
+  if (in_array($embed['type'], array('video', 'rich'))) {
+    $embed['html'] = '<div class="oembed">' . $embed['html'] . '</div>';
+  }
+
+  $variables['embed'] = $embed;
+}
+
+/**
+ * Implements hook_filter_default_formats_alter().
+ */
+function commons_media_filter_default_formats_alter(&$formats) {
+  if (module_exists('media_wysiwyg')) {
+    // Enable the media filter.
+    $formats['filtered_html']['filters'] += array(
+      'media_filter' => array(
+        'status' => 1,
+        'weight' => 2,
+      ),
+    );
+  }
+}
+
+/**
+ * Implements hook_ckeditor_profile_defaults().
+ */
+function commons_media_ckeditor_profile_defaults_alter(&$profiles) {
+  if (module_exists('media_wysiwyg')) {
+    // Add the media button.
+    $profiles['Advanced']['settings']['toolbar'] = '[
+    [\'Format\'],
+    [\'Bold\',\'Italic\',\'Strike\'],
+    [\'NumberedList\',\'BulletedList\',\'Indent\',\'Outdent\',\'Blockquote\'],
+    [\'Link\',\'Unlink\',\'Media\']
+    ]';
+
+    // Load the media plugin.
+    $profiles['Advanced']['settings']['loadPlugins'] += array(
+      'media' => array(
+        'default' => 'f',
+        'desc' => 'Plugin for inserting images from Drupal media module',
+        'name' => 'media',
+        'path' => '%plugin_dir%media/',
+      ),
+    );
+  }
+}
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.strongarm.inc b/profiles/commons/modules/commons/commons_media/commons_media.strongarm.inc
new file mode 100644
index 0000000..166e05d
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_media/commons_media.strongarm.inc
@@ -0,0 +1,21 @@
+<?php
+/**
+ * @file
+ * commons_media.strongarm.inc
+ */
+
+/**
+ * Implements hook_strongarm().
+ */
+function commons_media_strongarm() {
+  $export = array();
+
+  $strongarm = new stdClass();
+  $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
+  $strongarm->api_version = 1;
+  $strongarm->name = 'media__dialog_theme';
+  $strongarm->value = 'commons_origins';
+  $export['media__dialog_theme'] = $strongarm;
+
+  return $export;
+}
diff --git a/profiles/commons/modules/commons/commons_misc/commons_misc.info b/profiles/commons/modules/commons/commons_misc/commons_misc.info
index 331f532..cd2250e 100644
--- a/profiles/commons/modules/commons/commons_misc/commons_misc.info
+++ b/profiles/commons/modules/commons/commons_misc/commons_misc.info
@@ -2,14 +2,12 @@ name = Commons Miscellaneous Configuration
 description = Various suggested bits of configuration for Commons sites.
 core = 7.x
 package = Commons - Building blocks
-project = commons_misc
 dependencies[] = comment
 dependencies[] = ctools
 dependencies[] = features
 dependencies[] = node
 dependencies[] = strongarm
 dependencies[] = user
-datestamp = 1355530534
 features[ctools][] = page_manager:pages_default:1
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
@@ -25,9 +23,9 @@ features[variable][] = theme_commons_origins_settings
 features[variable][] = user_register
 features_exclude[dependencies][page_manager] = page_manager
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_misc/commons_misc.module b/profiles/commons/modules/commons/commons_misc/commons_misc.module
index 32fbc63..5027494 100644
--- a/profiles/commons/modules/commons/commons_misc/commons_misc.module
+++ b/profiles/commons/modules/commons/commons_misc/commons_misc.module
@@ -44,4 +44,31 @@ function commons_misc_form_system_theme_settings_alter(&$form, &$form_state, $fo
     require_once(drupal_get_path('theme', 'commons_origins') . '/commons_origins.palettes.inc');
     commons_origins_palettes_form($form);
   }
+}
+
+/*
+ * Render a link to the official commons documentation located at
+ * https://docs.acquia.com/commons
+ */
+function commons_misc_navbar() {
+  $items = array();
+
+  $items['documentation'] = array(
+    '#type' => 'navbar_item',
+    'tab' => array(
+      '#type' => 'link',
+      '#title' => t('Documentation'),
+      '#href' => 'https://docs.acquia.com/commons',
+      '#options' => array(
+        'attributes' => array(
+          'title' => t('Commons Documentation'),
+          'class' => array('icon', 'icon-help'),
+          'target' => '_blank',
+        ),
+      ),
+    ),
+    '#weight' => 20,
+  );
+
+  return $items;
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_notices/commons_notices.info b/profiles/commons/modules/commons/commons_notices/commons_notices.info
index 0887cb0..8d44626 100644
--- a/profiles/commons/modules/commons/commons_notices/commons_notices.info
+++ b/profiles/commons/modules/commons/commons_notices/commons_notices.info
@@ -28,9 +28,9 @@ features[variable][] = node_preview_notice
 features[variable][] = node_submitted_notice
 features[views_view][] = commons_notices_latest_notices
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.features.field_instance.inc b/profiles/commons/modules/commons/commons_notify/commons_notify.features.field_instance.inc
index 57ff66e..d03df1f 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.features.field_instance.inc
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.features.field_instance.inc
@@ -211,6 +211,208 @@ function commons_notify_field_default_field_instances() {
     ),
   );
 
+  // Exported field_instance: 'message-commons_notify_comment_created_no_groups-field_message_rendered_body'
+  $field_instances['message-commons_notify_comment_created_no_groups-field_message_rendered_body'] = array(
+    'bundle' => 'commons_notify_comment_created_no_groups',
+    'default_value' => NULL,
+    'deleted' => 0,
+    'description' => '',
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'module' => 'text',
+        'settings' => array(),
+        'type' => 'text_default',
+        'weight' => 2,
+      ),
+      'message_notify_email_body' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 4,
+      ),
+      'message_notify_email_subject' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 4,
+      ),
+    ),
+    'entity_type' => 'message',
+    'field_name' => 'field_message_rendered_body',
+    'label' => 'Body',
+    'required' => 0,
+    'settings' => array(
+      'text_processing' => 0,
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'text',
+      'settings' => array(
+        'rows' => 5,
+      ),
+      'type' => 'text_textarea',
+      'weight' => 6,
+    ),
+  );
+
+  // Exported field_instance: 'message-commons_notify_comment_created_no_groups-field_message_rendered_subject'
+  $field_instances['message-commons_notify_comment_created_no_groups-field_message_rendered_subject'] = array(
+    'bundle' => 'commons_notify_comment_created_no_groups',
+    'default_value' => NULL,
+    'deleted' => 0,
+    'description' => '',
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'module' => 'text',
+        'settings' => array(),
+        'type' => 'text_default',
+        'weight' => 3,
+      ),
+      'message_notify_email_body' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 3,
+      ),
+      'message_notify_email_subject' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 3,
+      ),
+    ),
+    'entity_type' => 'message',
+    'field_name' => 'field_message_rendered_subject',
+    'label' => 'Subject',
+    'required' => FALSE,
+    'settings' => array(
+      'text_processing' => 0,
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'module' => 'text',
+      'settings' => array(
+        'size' => 60,
+      ),
+      'type' => 'text_textfield',
+      'weight' => 8,
+    ),
+  );
+
+
+  // Exported field_instance: 'message-commons_notify_comment_created_no_groups-field_target_comments'
+  $field_instances['message-commons_notify_comment_created_no_groups-field_target_comments'] = array(
+    'bundle' => 'commons_notify_comment_created_no_groups',
+    'default_value' => NULL,
+    'default_value_function' => '',
+    'deleted' => 0,
+    'description' => '',
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'module' => 'entityreference',
+        'settings' => array(
+          'link' => FALSE,
+        ),
+        'type' => 'entityreference_label',
+        'weight' => 1,
+      ),
+      'message_notify_email_body' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 5,
+      ),
+      'message_notify_email_subject' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 5,
+      ),
+    ),
+    'entity_type' => 'message',
+    'field_name' => 'field_target_comments',
+    'label' => 'Target comment',
+    'required' => 1,
+    'settings' => array(
+      'behaviors' => array(
+        'prepopulate' => array(
+          'status' => 0,
+        ),
+      ),
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'entityreference',
+      'settings' => array(
+        'match_operator' => 'CONTAINS',
+        'path' => '',
+        'size' => 60,
+      ),
+      'type' => 'entityreference_autocomplete',
+      'weight' => 4,
+    ),
+  );
+
+  // Exported field_instance: 'message-commons_notify_comment_created_no_groups-field_target_nodes'
+  $field_instances['message-commons_notify_comment_created_no_groups-field_target_nodes'] = array(
+    'bundle' => 'commons_notify_comment_created_no_groups',
+    'default_value' => NULL,
+    'default_value_function' => '',
+    'deleted' => 0,
+    'description' => '',
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'module' => 'entityreference',
+        'settings' => array(
+          'link' => FALSE,
+        ),
+        'type' => 'entityreference_label',
+        'weight' => 0,
+      ),
+      'message_notify_email_body' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 6,
+      ),
+      'message_notify_email_subject' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 6,
+      ),
+    ),
+    'entity_type' => 'message',
+    'field_name' => 'field_target_nodes',
+    'label' => 'Target nodes',
+    'required' => 0,
+    'settings' => array(
+      'behaviors' => array(
+        'prepopulate' => array(
+          'status' => 0,
+        ),
+      ),
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'entityreference',
+      'settings' => array(
+        'match_operator' => 'CONTAINS',
+        'path' => '',
+        'size' => 60,
+      ),
+      'type' => 'entityreference_autocomplete',
+      'weight' => 2,
+    ),
+  );
+
   // Exported field_instance: 'message-commons_notify_node_created-field_message_rendered_body'
   $field_instances['message-commons_notify_node_created-field_message_rendered_body'] = array(
     'bundle' => 'commons_notify_node_created',
@@ -444,61 +646,6 @@ function commons_notify_field_default_field_instances() {
     ),
   );
 
-  // Exported field_instance: 'message-commons_notify_node_created_no_groups-field_target_comments'
-  $field_instances['message-commons_notify_node_created_no_groups-field_target_comments'] = array(
-    'bundle' => 'commons_notify_node_created_no_groups',
-    'default_value' => NULL,
-    'default_value_function' => '',
-    'deleted' => 0,
-    'description' => '',
-    'display' => array(
-      'default' => array(
-        'label' => 'above',
-        'module' => 'entityreference',
-        'settings' => array(
-          'link' => FALSE,
-        ),
-        'type' => 'entityreference_label',
-        'weight' => 3,
-      ),
-      'message_notify_email_body' => array(
-        'label' => 'above',
-        'settings' => array(),
-        'type' => 'hidden',
-        'weight' => 0,
-      ),
-      'message_notify_email_subject' => array(
-        'label' => 'above',
-        'settings' => array(),
-        'type' => 'hidden',
-        'weight' => 0,
-      ),
-    ),
-    'entity_type' => 'message',
-    'field_name' => 'field_target_comments',
-    'label' => 'Target comment',
-    'required' => 0,
-    'settings' => array(
-      'behaviors' => array(
-        'prepopulate' => array(
-          'status' => 0,
-        ),
-      ),
-      'user_register_form' => FALSE,
-    ),
-    'widget' => array(
-      'active' => 1,
-      'module' => 'entityreference',
-      'settings' => array(
-        'match_operator' => 'CONTAINS',
-        'path' => '',
-        'size' => 60,
-      ),
-      'type' => 'entityreference_autocomplete',
-      'weight' => 1,
-    ),
-  );
-
   // Exported field_instance: 'message-commons_notify_node_created_no_groups-field_target_nodes'
   $field_instances['message-commons_notify_node_created_no_groups-field_target_nodes'] = array(
     'bundle' => 'commons_notify_node_created_no_groups',
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.features.inc b/profiles/commons/modules/commons/commons_notify/commons_notify.features.inc
index 58233d0..166d80d 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.features.inc
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.features.inc
@@ -42,6 +42,33 @@ function commons_notify_default_message_type() {
     },
     "rdf_mapping" : []
   }');
+  $items['commons_notify_comment_created_no_groups'] = entity_import('message_type', '{
+    "name" : "commons_notify_comment_created_no_groups",
+    "description" : "Commons Notify: Comment created no groups",
+    "argument_keys" : [],
+    "argument" : [],
+    "category" : "commons_notify",
+    "data" : {
+      "token options" : { "clear" : 0 },
+      "purge" : { "override" : 0, "enabled" : 0, "quota" : "", "days" : "" }
+    },
+    "language" : "",
+    "arguments" : null,
+    "message_text" : { "und" : [
+        {
+          "value" : "New comment on [message:field-target-nodes:0:title] ",
+          "format" : "plain_text",
+          "safe_value" : "\\u003Cp\\u003ENew comment on [message:field-target-nodes:0:title]\\u003C\\/p\\u003E\\n"
+        },
+        {
+          "value" : "Hi [message:user:name],\\r\\n\\r\\n[message:field-target-comments:0:author] commented on [message:field-target-nodes:0:title]:\\r\\n\\r\\n[message:field-target-comments:0:body]\\r\\n\\r\\nRead \\u0026 respond: [message:field-target-comments:0:url]\\r\\nUpdate your notification settings: [site:url]\\/notification-settings",
+          "format" : "plain_text",
+          "safe_value" : "\\u003Cp\\u003EHi [message:user:name],\\u003C\\/p\\u003E\\n\\u003Cp\\u003E[message:field-target-comments:0:author] commented on [message:field-target-nodes:0:title]:\\u003C\\/p\\u003E\\n\\u003Cp\\u003E[message:field-target-comments:0:body]\\u003C\\/p\\u003E\\n\\u003Cp\\u003ERead \\u0026amp; respond: [message:field-target-comments:0:url]\\u003Cbr \\/\\u003E\\nUpdate your notification settings: [site:url]\\/notification-settings\\u003C\\/p\\u003E\\n"
+        }
+      ]
+    },
+    "rdf_mapping" : []
+  }');
   $items['commons_notify_node_created'] = entity_import('message_type', '{
     "name" : "commons_notify_node_created",
     "description" : "The notification sent when a user creates a node.",
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.info b/profiles/commons/modules/commons/commons_notify/commons_notify.info
index 09bab0a..1264b7e 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.info
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.info
@@ -1,7 +1,6 @@
 name = Commons Notify
 core = 7.x
 package = Commons - Building blocks
-project = commons_notify
 dependencies[] = commons_follow
 dependencies[] = ctools
 dependencies[] = entity
@@ -15,7 +14,6 @@ dependencies[] = number
 dependencies[] = options
 dependencies[] = strongarm
 dependencies[] = text
-datestamp = 1354747303
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:2
 features[field_base][] = field_message_rendered_body
@@ -25,20 +23,25 @@ features[field_instance][] = message-commons_notify_comment_created-field_messag
 features[field_instance][] = message-commons_notify_comment_created-field_message_rendered_subject
 features[field_instance][] = message-commons_notify_comment_created-field_target_comments
 features[field_instance][] = message-commons_notify_comment_created-field_target_nodes
+features[field_instance][] = message-commons_notify_comment_created_no_groups-field_message_rendered_body
+features[field_instance][] = message-commons_notify_comment_created_no_groups-field_message_rendered_subject
+features[field_instance][] = message-commons_notify_comment_created_no_groups-field_target_comments
+features[field_instance][] = message-commons_notify_comment_created_no_groups-field_target_nodes
 features[field_instance][] = message-commons_notify_node_created-field_message_rendered_body
 features[field_instance][] = message-commons_notify_node_created-field_message_rendered_subject
 features[field_instance][] = message-commons_notify_node_created-field_target_nodes
 features[field_instance][] = message-commons_notify_node_created_no_groups-field_message_rendered_body
 features[field_instance][] = message-commons_notify_node_created_no_groups-field_message_rendered_subject
-features[field_instance][] = message-commons_notify_node_created_no_groups-field_target_comments
 features[field_instance][] = message-commons_notify_node_created_no_groups-field_target_nodes
 features[field_instance][] = message_type-commons_notify-message_text
 features[field_instance][] = user-user-message_subscribe_email
 features[message_type][] = commons_notify_comment_created
+features[message_type][] = commons_notify_comment_created_no_groups
 features[message_type][] = commons_notify_node_created
 features[message_type][] = commons_notify_node_created_no_groups
 features[message_type_category][] = commons_notify
 features[variable][] = field_bundle_settings_message__commons_notify_comment_created
+features[variable][] = field_bundle_settings_message__commons_notify_comment_created_no_groups
 features[variable][] = field_bundle_settings_message__commons_notify_node_created
 features[variable][] = field_bundle_settings_message__commons_notify_node_created_no_groups
 features[variable][] = message_subscribe_default_notifiers
@@ -46,9 +49,9 @@ features_exclude[field_base][message_text] = message_text
 features_exclude[field_base][field_target_nodes] = field_target_nodes
 features_exclude[field_base][field_target_comments] = field_target_comments
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.install b/profiles/commons/modules/commons/commons_notify/commons_notify.install
index 0db44df..ba5b31a 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.install
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.install
@@ -23,3 +23,11 @@ function commons_notify_update_7303() {
   features_revert(array('commons_notify' => array('message_type')));
   return array();
 }
+
+/**
+ * Add message notify for comments that have no group.
+ */
+function commons_notify_update_7304() {
+  features_revert(array('commons_notify' => array('message_type')));
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.module b/profiles/commons/modules/commons/commons_notify/commons_notify.module
index 7be270c..410a920 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.module
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.module
@@ -12,14 +12,14 @@ include_once 'commons_notify.features.inc';
  * a shutdown function, because node access grants haven not been written
  * by the time hook_node_insert() is invoked. For more background,
  * see https://drupal.org/node/1918666.
- * 
+ *
  */
 function commons_notify_node_insert($node) {
   drupal_register_shutdown_function('commons_notify_send_message_on_shutdown', $node);
 }
 
 /**
- * Send a notification for newly created nodes. 
+ * Send a notification for newly created nodes.
  * This function is registered as a shutdown function
  * in commons_notify_node_insert.
  * Note that shutdown functions run after drupal_set_message() messages are
@@ -38,7 +38,6 @@ function commons_notify_send_message_on_shutdown($node) {
   // the realm to the user, since if no realms are provided then the message
   // is automatically assigned to the user passed in the function, or if no
   // user object is provided, then to the acting user.
-
   $message_type = 'commons_notify_node_created';
   // We need to clear the static loading cache so that the node body will be
   // ready in time for token replacement for the  message.
@@ -76,7 +75,7 @@ function commons_notify_comment_insert($comment) {
   $message_type = 'commons_notify_comment_created';
   $hook = 'comment_insert';
   if (!isset($node->og_group_ref[LANGUAGE_NONE][0]['target_id'])) {
-    $message_type = 'commons_notify_node_created_no_groups';
+    $message_type = 'commons_notify_comment_created_no_groups';
   }
   drupal_alter('commons_notify_message_selection', $message_type, $hook, $comment);
   $message = message_create($message_type, array('uid' => $account->uid, 'timestamp' => $comment->created));
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.strongarm.inc b/profiles/commons/modules/commons/commons_notify/commons_notify.strongarm.inc
index 7e4f9a6..7908a70 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.strongarm.inc
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.strongarm.inc
@@ -47,6 +47,40 @@ function commons_notify_strongarm() {
   $strongarm = new stdClass();
   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
   $strongarm->api_version = 1;
+  $strongarm->name = 'field_bundle_settings_message__commons_notify_comment_created_no_groups';
+  $strongarm->value = array(
+    'view_modes' => array(),
+    'extra_fields' => array(
+      'form' => array(),
+      'display' => array(
+        'message__message_text__0' => array(
+          'message_notify_email_subject' => array(
+            'visible' => TRUE,
+            'weight' => 0,
+          ),
+          'message_notify_email_body' => array(
+            'visible' => FALSE,
+            'weight' => 0,
+          ),
+        ),
+        'message__message_text__1' => array(
+          'message_notify_email_subject' => array(
+            'visible' => FALSE,
+            'weight' => 0,
+          ),
+          'message_notify_email_body' => array(
+            'visible' => TRUE,
+            'weight' => 0,
+          ),
+        ),
+      ),
+    ),
+  );
+  $export['field_bundle_settings_message__commons_notify_comment_created_no_groups'] = $strongarm;
+
+  $strongarm = new stdClass();
+  $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
+  $strongarm->api_version = 1;
   $strongarm->name = 'field_bundle_settings_message__commons_notify_node_created';
   $strongarm->value = array(
     'view_modes' => array(),
diff --git a/profiles/commons/modules/commons/commons_pages/commons_pages.info b/profiles/commons/modules/commons/commons_pages/commons_pages.info
index 0d2971f..fceb2ec 100644
--- a/profiles/commons/modules/commons/commons_pages/commons_pages.info
+++ b/profiles/commons/modules/commons/commons_pages/commons_pages.info
@@ -26,9 +26,9 @@ features[variable][] = node_preview_page
 features[variable][] = node_submitted_page
 features[variable][] = pathauto_node_page_pattern
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.info b/profiles/commons/modules/commons/commons_polls/commons_polls.info
index 590152e..7452a54 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.info
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.info
@@ -2,7 +2,6 @@ name = Commons Polls
 description = Commons poll content type
 core = 7.x
 package = Commons - Content types
-project = commons_polls
 dependencies[] = commons_body
 dependencies[] = commons_topics
 dependencies[] = ctools
@@ -46,9 +45,9 @@ features[variable][] = node_preview_poll
 features[variable][] = node_submitted_poll
 features[views_view][] = commons_bw_polls
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.install b/profiles/commons/modules/commons/commons_polls/commons_polls.install
index e3f1d7b..5e32589 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.install
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.install
@@ -32,3 +32,14 @@ function commons_polls_update_7002() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_polls_update_7003() {
+  $revert = array(
+    'commons_polls' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.module b/profiles/commons/modules/commons/commons_polls/commons_polls.module
index 115fd00..98b89fd 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.module
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.module
@@ -29,6 +29,7 @@ function commons_polls_commons_entity_integration() {
   return array(
     'node' => array(
       'poll' => array(
+        'media' => TRUE,
       ),
     ),
   );
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.views_default.inc b/profiles/commons/modules/commons/commons_polls/commons_polls.views_default.inc
index 1bb05b4..cf8a279 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.views_default.inc
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.views_default.inc
@@ -64,6 +64,7 @@ function commons_polls_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.info b/profiles/commons/modules/commons/commons_posts/commons_posts.info
index 7b9da50..e7cbf4a 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.info
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.info
@@ -2,7 +2,6 @@ name = Commons Posts
 description = Commons Post content type
 core = 7.x
 package = Commons - Content types
-project = commons_posts
 dependencies[] = commons_body
 dependencies[] = commons_bw
 dependencies[] = commons_topics
@@ -52,9 +51,9 @@ features[variable][] = node_preview_post
 features[variable][] = node_submitted_post
 features[views_view][] = commons_bw_posts
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.install b/profiles/commons/modules/commons/commons_posts/commons_posts.install
index 106f277..3c28adb 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.install
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.install
@@ -43,3 +43,14 @@ function commons_posts_update_7003() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_posts_update_7004() {
+  $revert = array(
+    'commons_posts' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.module b/profiles/commons/modules/commons/commons_posts/commons_posts.module
index b51edde..ab59e3f 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.module
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.module
@@ -98,6 +98,7 @@ function commons_posts_commons_entity_integration() {
   return array(
     'node' => array(
       'post' => array(
+        'media' => TRUE,
       ),
     ),
   );
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.views_default.inc b/profiles/commons/modules/commons/commons_posts/commons_posts.views_default.inc
index 06e98bb..62b2a7b 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.views_default.inc
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.views_default.inc
@@ -65,6 +65,7 @@ function commons_posts_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
index fce3c91..f68556b 100644
--- a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
+++ b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
@@ -2,11 +2,8 @@ name = Commons Profile Base
 description = Provides a base set of profile fields for user profiles.
 core = 7.x
 package = Commons - Building blocks
-php = 5.2.4
-project = commons_profile_base
 dependencies[] = features
 dependencies[] = strongarm
-datestamp = 1346372016
 features[ctools][] = strongarm:strongarm:1
 features[features_api][] = api:1
 features[field_base][] = field_bio
@@ -21,9 +18,9 @@ features[variable][] = user_picture_file_size
 features[variable][] = user_picture_style
 features[variable][] = user_pictures
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.install b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.install
new file mode 100644
index 0000000..fa0e2c8
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.install
@@ -0,0 +1,12 @@
+<?php
+
+/**
+ * Revert strongarm varibles related to realname recursion error.
+ */
+function commons_profile_base_update_7000() {
+    $revert = array(
+      'commons_profile_base' => array('variable'),
+  );
+  features_revert($revert);
+  return array();
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.strongarm.inc b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.strongarm.inc
index 8475a47..5c24493 100644
--- a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.strongarm.inc
+++ b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.strongarm.inc
@@ -14,7 +14,7 @@ function commons_profile_base_strongarm() {
   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
   $strongarm->api_version = 1;
   $strongarm->name = 'realname_pattern';
-  $strongarm->value = '[user:field_name_first] [user:field_name_last]';
+  $strongarm->value = '[user:field-name-first] [user:field-name-last]';
   $export['realname_pattern'] = $strongarm;
 
   $strongarm = new stdClass();
diff --git a/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info b/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
index 20579fb..5e15d60 100644
--- a/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
+++ b/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
@@ -2,7 +2,6 @@ name = Commons Profile (Social fields)
 description = Provides a set of link fields to the user's profile for the user's Facebook, Linkedin and Twitter accounts.
 core = 7.x
 package = Commons - Building blocks
-project = commons_profile_social
 dependencies[] = features
 dependencies[] = field_sql_storage
 dependencies[] = link
@@ -13,9 +12,9 @@ features[field_base][] = field_twitter_url
 features[field_instance][] = user-user-field_facebook_url
 features[field_instance][] = user-user-field_linkedin_url
 features[field_instance][] = user-user-field_twitter_url
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.info b/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
index bb9f087..9828ac5 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
@@ -2,7 +2,6 @@ name = Commons Q&A
 description = Allows community members to ask questions and vote for the best answers
 core = 7.x
 package = Commons - Content types
-project = commons_q_a
 dependencies[] = commons_topics
 dependencies[] = ctools
 dependencies[] = entity
@@ -95,9 +94,9 @@ features_exclude[field_instance][og_group_ref] = og_group_ref
 features_exclude[field_instance][node-answer-og_group_ref] = node-answer-og_group_ref
 features_exclude[field_instance][node-question-og_group_ref] = node-question-og_group_ref
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.install b/profiles/commons/modules/commons/commons_q_a/commons_q_a.install
index 7cbfea5..fc5fe6a 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.install
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.install
@@ -103,3 +103,14 @@ function commons_q_a_update_3108() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_q_a_update_3109() {
+  $revert = array(
+    'commons_q_a' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.module b/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
index 39067fa..f27edbe 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
@@ -250,7 +250,9 @@ function commons_q_a_commons_bw_create_all_widget($group) {
 function commons_q_a_commons_entity_integration() {
   return array(
     'node' => array(
-      'question' => array(),
+      'question' => array(
+        'media' => TRUE,
+      ),
       'answer' => array(
         'exclude_topics' => TRUE,
         'exclude_rate' => TRUE,
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.views_default.inc b/profiles/commons/modules/commons/commons_q_a/commons_q_a.views_default.inc
index 1a20238..23814a0 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.views_default.inc
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.views_default.inc
@@ -64,6 +64,7 @@ function commons_q_a_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info b/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
index 2d68157..5b67e27 100644
--- a/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
+++ b/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
@@ -12,9 +12,9 @@ features[panelizer_defaults][] = node:question:default
 features[variable][] = panelizer_defaults_node_answer
 features[variable][] = panelizer_defaults_node_question
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
index af747e9..389cd6c 100644
--- a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
+++ b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
@@ -2,14 +2,12 @@ name = Commons Radioactivity
 description = Helps to identify interesting content by automatically determining a decaying radioactivity value for individual pieces of conte
 core = 7.x
 package = Commons - Building blocks
-project = commons_radioactivity
 dependencies[] = ctools
 dependencies[] = features
 dependencies[] = field_sql_storage
 dependencies[] = radioactivity
 dependencies[] = strongarm
 dependencies[] = views
-datestamp = 1359684043
 features[ctools][] = radioactivity:radioactivity_decay_profile:1
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
@@ -19,9 +17,9 @@ features[radioactivity_decay_profile][] = commons_ra_node
 features[variable][] = commons_radioactivity_entity_types
 features[views_view][] = commons_radioactivity_admin
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.module b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.module
index 720a40e..e367a96 100644
--- a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.module
+++ b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.module
@@ -125,7 +125,7 @@ function commons_radioactivity_incident_node($node, $value) {
   $profile = radioactivity_get_field_profile('node', $node->type, 'field_radioactivity');
 
   // Return if radioactivity doesn't exist or hasn't been created for the node yet
-  if (!isset($node->field_radioactivity)) {
+  if (empty($node->field_radioactivity)) {
     return;
   }
   // Prevent groups from going negative in energy.
diff --git a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
index 7b52dce..b9fe404 100644
--- a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
+++ b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
@@ -2,20 +2,18 @@ name = Commons Radioactivity Groups
 description = Views integration for Group radioactivity
 core = 7.x
 package = Commons - Building Blocks
-project = commons_radioactivity
 dependencies[] = commons_radioactivity
 dependencies[] = og
 dependencies[] = views_content
 dependencies[] = views_field_view
-datestamp = 1350676260
 features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[views_view][] = commons_radioactivity_groups_active_in_group
 features[views_view][] = commons_radioactivity_groups_most_active
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_search/2018929-solr-overidden-3.patch b/profiles/commons/modules/commons/commons_search/2018929-solr-overidden-3.patch
deleted file mode 100644
index 378c572..0000000
--- a/profiles/commons/modules/commons/commons_search/2018929-solr-overidden-3.patch
+++ /dev/null
@@ -1,36 +0,0 @@
-diff --git a/modules/commons_search_solr/commons_search_solr.features.inc b/modules/commons_search_solr/commons_search_solr.features.inc
-index 3117ccf..f927dab 100644
---- a/modules/commons_search_solr/commons_search_solr.features.inc
-+++ b/modules/commons_search_solr/commons_search_solr.features.inc
-@@ -17,6 +17,10 @@ function commons_search_solr_ctools_plugin_api() {
-     return array("version" => "3");
-   }
-   list($module, $api) = func_get_args();
-+  if ($module == "facetapi" && $api == "facetapi_defaults") {
-+    return array("version" => "1");
-+  }
-+  list($module, $api) = func_get_args();
-   if ($module == "page_manager" && $api == "pages_default") {
-     return array("version" => "1");
-   }
-diff --git a/modules/commons_search_solr/commons_search_solr.info b/modules/commons_search_solr/commons_search_solr.info
-index c2c139a..8e29c77 100644
---- a/modules/commons_search_solr/commons_search_solr.info
-+++ b/modules/commons_search_solr/commons_search_solr.info
-@@ -1,6 +1,7 @@
- name = Commons Search Solr
- description = Site search using Apache Solr server.
- core = 7.x
-+php = 5.2.4
- package = Commons - Search
- dependencies[] = apachesolr
- dependencies[] = apachesolr_proximity
-@@ -18,7 +19,7 @@ features[ctools][] = facetapi:facetapi_defaults:1
- features[ctools][] = page_manager:pages_default:1
- features[ctools][] = pm_existing_pages:pm_existing_pages:1
- features[ctools][] = strongarm:strongarm:1
--features[features_api][] = api:1
-+features[features_api][] = api:2
- features[page_manager_existing_pages][] = solr_search
- features[page_manager_handlers][] = pm_existing_pages_solr_search_panel_context
- features[variable][] = apachesolr_search_default_search_page
diff --git a/profiles/commons/modules/commons/commons_search/commons_search.info b/profiles/commons/modules/commons/commons_search/commons_search.info
index b1d7993..2311608 100644
--- a/profiles/commons/modules/commons/commons_search/commons_search.info
+++ b/profiles/commons/modules/commons/commons_search/commons_search.info
@@ -2,7 +2,6 @@ name = Commons Search
 description = Provide the global search block.
 core = 7.x
 package = Commons - Search
-project = commons_search
 dependencies[] = ctools
 dependencies[] = custom_search
 dependencies[] = features
@@ -62,9 +61,9 @@ features[variable][] = custom_search_type_selector_all
 features[variable][] = custom_search_type_selector_label
 features[variable][] = custom_search_type_selector_label_visibility
 features[views_view][] = group_search
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
index b146f9d..d7f2f64 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
@@ -2,8 +2,6 @@ name = Commons Search Core
 description = Core search with facets.
 core = 7.x
 package = Commons - Search
-php = 5.2.4
-project = commons_search_core
 dependencies[] = commons_search
 dependencies[] = date_facets
 dependencies[] = facetapi
@@ -32,9 +30,9 @@ features[variable][] = search_active_modules
 features[variable][] = search_default_module
 features_exclude[dependencies][ctools] = ctools
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/asd.diff b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/asd.diff
deleted file mode 100644
index 3386377..0000000
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/asd.diff
+++ /dev/null
@@ -1,55 +0,0 @@
-diff --git a/modules/commons_search_solr/commons_search_solr.strongarm.inc b/modules/commons_search_solr/commons_search_solr.strongarm.inc
-index 60f2436..6162040 100644
---- a/modules/commons_search_solr/commons_search_solr.strongarm.inc
-+++ b/modules/commons_search_solr/commons_search_solr.strongarm.inc
-@@ -20,6 +20,16 @@ function commons_search_solr_strongarm() {
-   $strongarm = new stdClass();
-   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
-   $strongarm->api_version = 1;
-+  $strongarm->name = 'custom_search_other';
-+  $strongarm->value = array(
-+    'apachesolr_search' => 'apachesolr_search',
-+    'user' => 'user',
-+  );
-+  $export['custom_search_other'] = $strongarm;
-+
-+  $strongarm = new stdClass();
-+  $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
-+  $strongarm->api_version = 1;
-   $strongarm->name = 'page_manager_search_disabled_apachesolr_search';
-   $strongarm->value = TRUE;
-   $export['page_manager_search_disabled_apachesolr_search'] = $strongarm;
-@@ -30,7 +40,7 @@ function commons_search_solr_strongarm() {
-   $strongarm->name = 'pm_existing_pages_disabled_solr_search';
-   $strongarm->value = FALSE;
-   $export['pm_existing_pages_disabled_solr_search'] = $strongarm;
--  
-+
-   $strongarm = new stdClass();
-   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
-   $strongarm->api_version = 1;
-@@ -40,23 +50,13 @@ function commons_search_solr_strongarm() {
-     'user' => 'user',
-   );
-   $export['search_active_modules'] = $strongarm;
--  
-+
-   $strongarm = new stdClass();
-   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
-   $strongarm->api_version = 1;
-   $strongarm->name = 'search_default_module';
-   $strongarm->value = 'apachesolr_search';
-   $export['search_default_module'] = $strongarm;
--  
--  $strongarm = new stdClass();
--  $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
--  $strongarm->api_version = 1;
--  $strongarm->name = 'custom_search_other';
--  $strongarm->value = array(
--    'apachesolr_search' => 'apachesolr_search',
--    'user' => 'user',
--  );
--  $export['custom_search_other'] = $strongarm;
- 
-   return $export;
- }
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
index 733abb9..ac6a790 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
@@ -28,9 +28,9 @@ features[variable][] = pm_existing_pages_disabled_solr_search
 features[variable][] = search_active_modules
 features[variable][] = search_default_module
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
index 6b06dc2..f971cf0 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
@@ -2,8 +2,6 @@ name = Commons Search Solr User
 description = Provides user entity indexing capabilities to Apache Solr, and search functionality
 core = 7.x
 package = Commons - Search
-php = 5.2.4
-project = commons_search_solr_user
 dependencies[] = apachesolr_search
 dependencies[] = apachesolr_user
 dependencies[] = commons_search_solr
@@ -14,9 +12,9 @@ features[apachesolr_search_page][] = user_search
 features[ctools][] = apachesolr_search:apachesolr_search_defaults:3
 features[features_api][] = api:1
 features[menu_links][] = main-menu:people
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info b/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
index f66bf48..19fc718 100644
--- a/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
+++ b/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
@@ -2,7 +2,6 @@ name = Commons Site Homepage
 description = Provides a homepage for the site for anonymous and authenticated users
 core = 7.x
 package = Commons - Landing pages
-project = commons_site_homepage
 dependencies[] = commons_activity_streams
 dependencies[] = commons_events
 dependencies[] = commons_featured
@@ -13,7 +12,6 @@ dependencies[] = page_manager
 dependencies[] = strongarm
 dependencies[] = views
 dependencies[] = views_litepager
-datestamp = 1354747296
 features[ctools][] = page_manager:pages_default:1
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
@@ -23,9 +21,9 @@ features[variable][] = site_frontpage
 features[views_view][] = commons_homepage_content
 features_exclude[dependencies][views_content] = views_content
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info b/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
index c476d0f..101ba03 100644
--- a/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
+++ b/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
@@ -2,7 +2,6 @@ name = Commons Social Sharing
 description = Provide links to share content to external social services such as Facebook and Google+
 core = 7.x
 package = Commons - Building blocks
-project = commons_social_sharing
 dependencies[] = ctools
 dependencies[] = sharethis
 dependencies[] = strongarm
@@ -18,9 +17,9 @@ features[variable][] = sharethis_teaser_option
 features[variable][] = sharethis_weight
 features[variable][] = sharethis_widget_option
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_topics/commons_topics.info b/profiles/commons/modules/commons/commons_topics/commons_topics.info
index 743d2c1..0b7444b 100644
--- a/profiles/commons/modules/commons/commons_topics/commons_topics.info
+++ b/profiles/commons/modules/commons/commons_topics/commons_topics.info
@@ -1,17 +1,15 @@
 name = Commons Topics
 core = 7.x
 package = Commons - Building blocks
-project = commons_topics
 dependencies[] = features
 dependencies[] = taxonomy
-datestamp = 1359684035
 features[features_api][] = api:2
 features[field_base][] = field_topics
 features[taxonomy][] = topics
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_base.inc b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_base.inc
index 559e7bd..3edeb77 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_base.inc
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_base.inc
@@ -319,6 +319,9 @@ function commons_trusted_contacts_field_default_field_bases() {
           ),
         ),
         'membership_type' => 'trusted_contacts',
+        'sort' => array(
+          'type' => 'none',
+        ),
         'target_bundles' => array(),
       ),
       'handler_submit' => 'Change handler',
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_instance.inc b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_instance.inc
index 25a7342..f5be65e 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_instance.inc
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.features.field_instance.inc
@@ -350,7 +350,7 @@ function commons_trusted_contacts_field_default_field_instances() {
             'widget_type' => 'entityreference_autocomplete',
           ),
           'default' => array(
-            'widget_type' => 'options_select',
+            'widget_type' => 'entityreference_autocomplete',
           ),
           'status' => TRUE,
         ),
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
index 6aed2d7..4ce6dae 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
@@ -2,8 +2,6 @@ name = Commons Trusted Contacts
 description = Commons Trusted Contacts Functionality
 core = 7.x
 package = Commons - Building blocks
-version = 7.x-3.0
-project = commons_trusted_contacts
 dependencies[] = commons_groups
 dependencies[] = ctools
 dependencies[] = date
@@ -55,9 +53,9 @@ features_exclude[field][message-trusted_contact_request_approved-field_approving
 features_exclude[field][message-trusted_contact_request_pending-field_requesting_user] = message-trusted_contact_request_pending-field_requesting_user
 files[] = views/handlers/commons_groups_handler_send_message.inc
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.install b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.install
index da23dfd..e20ab9e 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.install
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.install
@@ -49,3 +49,15 @@ function commons_trusted_contacts_update_3100() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Change the background options widget to use autocomplete instead
+ * See https://drupal.org/node/2151637 for more info
+ */
+function commons_trusted_contacts_update_3101() {
+  $revert = array(
+    'commons_trusted_contacts' => array('field_instance', 'field_base'),
+  );
+  features_revert($revert);
+  return array();
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.module b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.module
index e2afe4e..c9ea858 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.module
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.module
@@ -25,7 +25,7 @@ function commons_trusted_contacts_system_info_alter(&$info, $file, $type) {
  *
  */
 function commons_trusted_contacts_user_presave(&$edit, $account, $category) {
-  // Ensure that a value is always set for the user's group_access field, 
+  // Ensure that a value is always set for the user's group_access field,
   // so that the user remains public while content shared with the user's
   // trusted contacts group is private. If the value of $user->group_access
   // is not set, og_access.module will throw an exception in
@@ -187,6 +187,11 @@ function commons_trusted_contacts_module_implements_alter(&$implementations, $ho
     unset($implementations['commons_trusted_contacts']);
     $implementations['commons_trusted_contacts'] = $group;
   }
+  if ($hook == 'node_presave') {
+    $group = $implementations['commons_trusted_contacts'];
+    unset($implementations['commons_trusted_contacts']);
+    $implementations['commons_trusted_contacts'] = $group;
+  }
 }
 
 /**
@@ -213,13 +218,6 @@ function commons_trusted_contacts_form_alter(&$form, &$form_state, $form_id) {
       $form['select']['#access'] = FALSE;
     }
   }
-  // Hide internal fields that the user should not be able to edit directly.
-  if ($form_id == 'edit_profile_user_profile_form' || substr($form_id, -10) === '_node_form') {
-    $internal_fields = array('field_unread_invitations', 'field_unread_messages', 'user_trusted_contacts', 'og_user_group_ref');
-    foreach ($internal_fields as $field_name) {
-      $form[$field_name]['#access'] = FALSE;
-    }
-  }
   if ($form_id == 'privatemsg_list') {
     // Load privatemsg.pages.inc and ensure it is automatically reloaded if
     // this form is rebuilt via AJAX or other means.
@@ -702,9 +700,9 @@ function commons_trusted_contacts_approve_trust(OgMembership $og_membership) {
   // Notify.
 
   // Get approving user.
-  $account = user_load($og_membership->etid);
+  $account = user_load($og_membership->gid);
 
-  $message = message_create('trusted_contact_request_approved', array('uid' => $account->uid));
+  $message = message_create('trusted_contact_request_approved', array('uid' => $og_membership->etid));
 
   $wrapper = entity_metadata_wrapper('message', $message);
   $wrapper->field_approving_user->set($account);
@@ -900,7 +898,7 @@ function commons_trusted_contacts_form_add_privacy_toggle(&$form, &$form_state)
     '#default_value' => empty($form[OG_AUDIENCE_FIELD][LANGUAGE_NONE][0]['default']['#default_value']) ? 'private' : 'custom',
     '#options' => array(
       'custom' => t('Post to specific groups'),
-      'private' => t('Post to contacts (private)'),
+      'private' => t('Post privately to all trusted contacts'),
     ),
     '#weight' => 70,
     '#attributes' => array(
@@ -945,9 +943,6 @@ function commons_trusted_contacts_form_node_form_alter(&$form, &$form_state) {
   if (empty($form[OG_AUDIENCE_FIELD])) {
     $form['group_audience_type']['#options']['custom'] = t('Post site-wide');
   }
-  else {
-    $form['#validate'][] = 'commons_trusted_contacts_partial_node_form_validate';
-  }
 }
 
 /**
@@ -956,7 +951,7 @@ function commons_trusted_contacts_form_node_form_alter(&$form, &$form_state) {
  */
 function commons_trusted_contacts_partial_node_form_validate($form, $form_state) {
   if ($form_state['values']['group_audience_type'] == 'custom' && empty($form_state['values'][OG_AUDIENCE_FIELD][LANGUAGE_NONE][0])) {
-    form_set_error(OG_AUDIENCE_FIELD, t('No groups were selected.'));
+    form_set_error(OG_AUDIENCE_FIELD, t('Please enter one more groups where this content will be posted.'));
     return FALSE;
   }
 }
@@ -995,7 +990,7 @@ function commons_trusted_contacts_node_presave($node) {
     $wrapper->{OG_AUDIENCE_FIELD}->set(array());
   }
   // The content is submitted to specific groups.
-  else {
+  else if (!empty($node->{OG_AUDIENCE_FIELD}[LANGUAGE_NONE])) {
     // Extract group IDs from selection.
     $group_ids = array();
     foreach ($node->{OG_AUDIENCE_FIELD}[LANGUAGE_NONE] as $group) {
@@ -1100,7 +1095,7 @@ function commons_trusted_contacts_messages_popup($form, &$form_state, $account)
 }
 
 /**
- * Helper function to get all of the pending invitations for a given 
+ * Helper function to get all of the pending invitations for a given
  * recipient user. Returns an array of OG memberships.
  */
 function commons_trusted_contacts_get_pending_invitations($uid) {
diff --git a/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info b/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
index b99c1cd..918d953 100644
--- a/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
+++ b/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
@@ -2,7 +2,6 @@ name = Commons User Profile Pages
 description = Exports a default user profile page, powered by the Panels module.
 core = 7.x
 package = Commons - Landing pages
-project = commons_user_profile_pages
 dependencies[] = commons_activity_streams
 dependencies[] = commons_events
 dependencies[] = commons_follow
@@ -14,9 +13,9 @@ features[ctools][] = page_manager:pages_default:1
 features[features_api][] = api:2
 features[page_manager_handlers][] = user_view_panel_context
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info b/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
index 5077060..64fee6d 100644
--- a/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
+++ b/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
@@ -1,9 +1,9 @@
 core = 7.x
 name = Commons Utility links block
 package = "Commons - Building blocks"
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.info b/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
index 91e37e0..b126e6b 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
@@ -2,7 +2,6 @@ name = Commons Wikis
 description = Provides the wiki functionality for Drupal Commons
 core = 7.x
 package = Commons - Content types
-project = commons_wikis
 dependencies[] = commons_body
 dependencies[] = commons_groups
 dependencies[] = commons_topics
@@ -22,7 +21,6 @@ dependencies[] = text
 dependencies[] = views
 dependencies[] = views_content
 dependencies[] = views_litepager
-datestamp = 1359684042
 features[ctools][] = page_manager:pages_default:1
 features[ctools][] = strongarm:strongarm:1
 features[ctools][] = views:views_default:3.0
@@ -64,9 +62,9 @@ features[views_view][] = commons_bw_wikis
 features[views_view][] = commons_wikis_contributor_list
 features_exclude[dependencies][commons_trusted_contacts] = commons_trusted_contacts
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.install b/profiles/commons/modules/commons/commons_wikis/commons_wikis.install
index ca392a2..c2bb6df 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.install
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.install
@@ -72,3 +72,14 @@ function commons_wikis_update_7006() {
   features_revert($revert);
   return array();
 }
+
+/**
+ * Display sticky content at top of lists.
+ */
+function commons_wikis_update_7007() {
+  $revert = array(
+    'commons_wikis' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.module b/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
index 20cf44b..9c571a8 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
@@ -163,6 +163,7 @@ function commons_wikis_commons_entity_integration() {
     'node' => array(
       'wiki' => array(
         'auto_title_instance' => FALSE,
+        'media' => TRUE,
       ),
     ),
   );
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.views_default.inc b/profiles/commons/modules/commons/commons_wikis/commons_wikis.views_default.inc
index 7c69d67..3807929 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.views_default.inc
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.views_default.inc
@@ -85,6 +85,7 @@ function commons_wikis_views_default_views() {
   $handler->display->display_options['sorts']['sticky']['id'] = 'sticky';
   $handler->display->display_options['sorts']['sticky']['table'] = 'node';
   $handler->display->display_options['sorts']['sticky']['field'] = 'sticky';
+  $handler->display->display_options['sorts']['sticky']['order'] = 'DESC';
   /* Sort criterion: Content: Post date */
   $handler->display->display_options['sorts']['created']['id'] = 'created';
   $handler->display->display_options['sorts']['created']['table'] = 'node';
diff --git a/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info b/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
index 79f0db6..96626ca 100644
--- a/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
+++ b/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
@@ -2,7 +2,6 @@ name = Commons Wikis Home
 description = Provides the panelizer feature for Wikis.
 core = 7.x
 package = Commons - Landing pages
-project = commons_wikis_pages
 dependencies[] = commons_wikis
 dependencies[] = ctools
 dependencies[] = panelizer
@@ -13,9 +12,9 @@ features[features_api][] = api:2
 features[panelizer_defaults][] = node:wiki:default
 features[variable][] = panelizer_defaults_node_wiki
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info b/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
index 45af28e..4342429 100644
--- a/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
+++ b/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
@@ -2,21 +2,19 @@ name = Commons WYSIWYG
 description = Provides a rich text editor for content creation.
 core = 7.x
 package = Commons - Building blocks
-project = commons_wysiwyg
 dependencies[] = ckeditor
 dependencies[] = features
 dependencies[] = filter
 dependencies[] = strongarm
-datestamp = 1358798210
 features[ckeditor_profile][] = Advanced
 features[features_api][] = api:2
 features[filter][] = filtered_html
 features[filter][] = full_html
 features[user_permission][] = use text format filtered_html
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/modules/contrib/acquia_connector/acquia_search/search.acquia.com.pem b/profiles/commons/modules/contrib/acquia_connector/acquia_search/search.acquia.com.pem
deleted file mode 100644
index 84f7597..0000000
--- a/profiles/commons/modules/contrib/acquia_connector/acquia_search/search.acquia.com.pem
+++ /dev/null
@@ -1,185 +0,0 @@
-Certificate:
-    Data:
-        Version: 3 (0x2)
-        Serial Number: 927650371 (0x374ad243)
-        Signature Algorithm: sha1WithRSAEncryption
-        Issuer: C=US, O=Entrust.net, OU=www.entrust.net/CPS incorp. by ref. (limits liab.), OU=(c) 1999 Entrust.net Limited, CN=Entrust.net Secure Server Certification Authority
-        Validity
-            Not Before: May 25 16:09:40 1999 GMT
-            Not After : May 25 16:39:40 2019 GMT
-        Subject: C=US, O=Entrust.net, OU=www.entrust.net/CPS incorp. by ref. (limits liab.), OU=(c) 1999 Entrust.net Limited, CN=Entrust.net Secure Server Certification Authority
-        Subject Public Key Info:
-            Public Key Algorithm: rsaEncryption
-            RSA Public Key: (1024 bit)
-                Modulus (1024 bit):
-                    00:cd:28:83:34:54:1b:89:f3:0f:af:37:91:31:ff:
-                    af:31:60:c9:a8:e8:b2:10:68:ed:9f:e7:93:36:f1:
-                    0a:64:bb:47:f5:04:17:3f:23:47:4d:c5:27:19:81:
-                    26:0c:54:72:0d:88:2d:d9:1f:9a:12:9f:bc:b3:71:
-                    d3:80:19:3f:47:66:7b:8c:35:28:d2:b9:0a:df:24:
-                    da:9c:d6:50:79:81:7a:5a:d3:37:f7:c2:4a:d8:29:
-                    92:26:64:d1:e4:98:6c:3a:00:8a:f5:34:9b:65:f8:
-                    ed:e3:10:ff:fd:b8:49:58:dc:a0:de:82:39:6b:81:
-                    b1:16:19:61:b9:54:b6:e6:43
-                Exponent: 3 (0x3)
-        X509v3 extensions:
-            Netscape Cert Type: 
-                SSL CA, S/MIME CA, Object Signing CA
-            X509v3 CRL Distribution Points: 
-                DirName:/C=US/O=Entrust.net/OU=www.entrust.net/CPS incorp. by ref. (limits liab.)/OU=(c) 1999 Entrust.net Limited/CN=Entrust.net Secure Server Certification Authority/CN=CRL1
-                URI:http://www.entrust.net/CRL/net1.crl
-
-            X509v3 Private Key Usage Period: 
-                Not Before: May 25 16:09:40 1999 GMT, Not After: May 25 16:09:40 2019 GMT
-            X509v3 Key Usage: 
-                Certificate Sign, CRL Sign
-            X509v3 Authority Key Identifier: 
-                keyid:F0:17:62:13:55:3D:B3:FF:0A:00:6B:FB:50:84:97:F3:ED:62:D0:1A
-
-            X509v3 Subject Key Identifier: 
-                F0:17:62:13:55:3D:B3:FF:0A:00:6B:FB:50:84:97:F3:ED:62:D0:1A
-            X509v3 Basic Constraints: 
-                CA:TRUE
-            1.2.840.113533.7.65.0: 
-                0
-..V4.0....
-    Signature Algorithm: sha1WithRSAEncryption
-        90:dc:30:02:fa:64:74:c2:a7:0a:a5:7c:21:8d:34:17:a8:fb:
-        47:0e:ff:25:7c:8d:13:0a:fb:e4:98:b5:ef:8c:f8:c5:10:0d:
-        f7:92:be:f1:c3:d5:d5:95:6a:04:bb:2c:ce:26:36:65:c8:31:
-        c6:e7:ee:3f:e3:57:75:84:7a:11:ef:46:4f:18:f4:d3:98:bb:
-        a8:87:32:ba:72:f6:3c:e2:3d:9f:d7:1d:d9:c3:60:43:8c:58:
-        0e:22:96:2f:62:a3:2c:1f:ba:ad:05:ef:ab:32:78:87:a0:54:
-        73:19:b5:5c:05:f9:52:3e:6d:2d:45:0b:f7:0a:93:ea:ed:06:
-        f9:b2
------BEGIN CERTIFICATE-----
-MIIE2DCCBEGgAwIBAgIEN0rSQzANBgkqhkiG9w0BAQUFADCBwzELMAkGA1UEBhMC
-VVMxFDASBgNVBAoTC0VudHJ1c3QubmV0MTswOQYDVQQLEzJ3d3cuZW50cnVzdC5u
-ZXQvQ1BTIGluY29ycC4gYnkgcmVmLiAobGltaXRzIGxpYWIuKTElMCMGA1UECxMc
-KGMpIDE5OTkgRW50cnVzdC5uZXQgTGltaXRlZDE6MDgGA1UEAxMxRW50cnVzdC5u
-ZXQgU2VjdXJlIFNlcnZlciBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTAeFw05OTA1
-MjUxNjA5NDBaFw0xOTA1MjUxNjM5NDBaMIHDMQswCQYDVQQGEwJVUzEUMBIGA1UE
-ChMLRW50cnVzdC5uZXQxOzA5BgNVBAsTMnd3dy5lbnRydXN0Lm5ldC9DUFMgaW5j
-b3JwLiBieSByZWYuIChsaW1pdHMgbGlhYi4pMSUwIwYDVQQLExwoYykgMTk5OSBF
-bnRydXN0Lm5ldCBMaW1pdGVkMTowOAYDVQQDEzFFbnRydXN0Lm5ldCBTZWN1cmUg
-U2VydmVyIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MIGdMA0GCSqGSIb3DQEBAQUA
-A4GLADCBhwKBgQDNKIM0VBuJ8w+vN5Ex/68xYMmo6LIQaO2f55M28Qpku0f1BBc/
-I0dNxScZgSYMVHINiC3ZH5oSn7yzcdOAGT9HZnuMNSjSuQrfJNqc1lB5gXpa0zf3
-wkrYKZImZNHkmGw6AIr1NJtl+O3jEP/9uElY3KDegjlrgbEWGWG5VLbmQwIBA6OC
-AdcwggHTMBEGCWCGSAGG+EIBAQQEAwIABzCCARkGA1UdHwSCARAwggEMMIHeoIHb
-oIHYpIHVMIHSMQswCQYDVQQGEwJVUzEUMBIGA1UEChMLRW50cnVzdC5uZXQxOzA5
-BgNVBAsTMnd3dy5lbnRydXN0Lm5ldC9DUFMgaW5jb3JwLiBieSByZWYuIChsaW1p
-dHMgbGlhYi4pMSUwIwYDVQQLExwoYykgMTk5OSBFbnRydXN0Lm5ldCBMaW1pdGVk
-MTowOAYDVQQDEzFFbnRydXN0Lm5ldCBTZWN1cmUgU2VydmVyIENlcnRpZmljYXRp
-b24gQXV0aG9yaXR5MQ0wCwYDVQQDEwRDUkwxMCmgJ6AlhiNodHRwOi8vd3d3LmVu
-dHJ1c3QubmV0L0NSTC9uZXQxLmNybDArBgNVHRAEJDAigA8xOTk5MDUyNTE2MDk0
-MFqBDzIwMTkwNTI1MTYwOTQwWjALBgNVHQ8EBAMCAQYwHwYDVR0jBBgwFoAU8Bdi
-E1U9s/8KAGv7UISX8+1i0BowHQYDVR0OBBYEFPAXYhNVPbP/CgBr+1CEl/PtYtAa
-MAwGA1UdEwQFMAMBAf8wGQYJKoZIhvZ9B0EABAwwChsEVjQuMAMCBJAwDQYJKoZI
-hvcNAQEFBQADgYEAkNwwAvpkdMKnCqV8IY00F6j7Rw7/JXyNEwr75Ji174z4xRAN
-95K+8cPV1ZVqBLssziY2ZcgxxufuP+NXdYR6Ee9GTxj005i7qIcyunL2POI9n9cd
-2cNgQ4xYDiKWL2KjLB+6rQXvqzJ4h6BUcxm1XAX5Uj5tLUUL9wqT6u0G+bI=
------END CERTIFICATE-----
-Certificate:
-    Data:
-        Version: 3 (0x2)
-        Serial Number: 1116122016 (0x4286aba0)
-        Signature Algorithm: sha1WithRSAEncryption
-        Issuer: C=US, O=Entrust.net, OU=www.entrust.net/CPS incorp. by ref. (limits liab.), OU=(c) 1999 Entrust.net Limited, CN=Entrust.net Secure Server Certification Authority
-        Validity
-            Not Before: Jul 14 17:10:28 2006 GMT
-            Not After : Jul 14 17:40:28 2014 GMT
-        Subject: C=US, O=DigiCert Inc, OU=www.digicert.com, CN=DigiCert Global CA
-        Subject Public Key Info:
-            Public Key Algorithm: rsaEncryption
-            RSA Public Key: (2048 bit)
-                Modulus (2048 bit):
-                    00:c4:3c:bc:cc:ba:ea:62:e6:9e:42:23:af:b4:b2:
-                    11:ae:62:8d:d9:a1:d3:8f:cc:14:72:19:ed:99:f6:
-                    fd:de:5d:bb:59:c0:b0:c2:af:6a:99:52:95:57:0b:
-                    35:ff:e1:86:fa:af:a2:c3:c1:05:65:27:20:76:2f:
-                    0a:54:25:7c:ea:2b:dd:95:41:57:9b:0f:3b:cf:47:
-                    e8:01:06:8c:c5:44:48:fc:07:2e:f3:72:83:30:51:
-                    94:9e:69:3a:83:a9:87:90:14:d9:5e:c4:a2:78:8f:
-                    c1:3e:d4:19:61:0e:1a:e7:dc:1a:95:20:41:be:6f:
-                    17:da:b8:1c:41:ee:98:b0:fa:d7:1d:35:3f:16:a7:
-                    04:28:13:5d:3d:05:75:9a:2e:86:9e:2c:b0:17:87:
-                    20:58:57:ef:e1:ea:55:60:b8:2c:70:21:ac:29:63:
-                    0c:10:fc:60:bc:f9:d5:1c:37:64:d5:b4:fb:1e:ab:
-                    26:39:46:88:a4:cb:cd:30:67:c0:26:79:e5:ca:68:
-                    f9:22:d7:e5:d2:b1:bb:48:4c:9b:0b:98:5b:42:92:
-                    e5:d2:ed:0e:47:30:fa:dd:27:56:63:6a:a5:01:c7:
-                    8e:af:f0:4e:3b:1b:55:15:44:d5:3e:4d:57:1e:e1:
-                    91:ea:b8:a0:8f:ce:3a:63:5f:96:89:ba:08:3e:fe:
-                    44:bb
-                Exponent: 65537 (0x10001)
-        X509v3 extensions:
-            X509v3 Basic Constraints: critical
-                CA:TRUE, pathlen:0
-            X509v3 Certificate Policies: 
-                Policy: 1.2.840.113533.7.75.2
-                  CPS: http://www.entrust.net/cps
-                  User Notice:
-                    Explicit Text: For use solely with SSL and S/MIME certificates issued by Digicert, Inc. to authorized subscribers.
-DOES NOT represent any endorsement by Entrust Inc. or its affiliates as to the identity of any certificate holder.
-
-            X509v3 Extended Key Usage: 
-                TLS Web Server Authentication, TLS Web Client Authentication, E-mail Protection, OCSP Signing
-            X509v3 CRL Distribution Points: 
-                URI:http://crl.entrust.net/server1.crl
-                DirName:/C=US/O=Entrust.net/OU=www.entrust.net/CPS incorp. by ref. (limits liab.)/OU=(c) 1999 Entrust.net Limited/CN=Entrust.net Secure Server Certification Authority/CN=CRL1
-
-            X509v3 Key Usage: 
-                Certificate Sign, CRL Sign
-            X509v3 Authority Key Identifier: 
-                keyid:F0:17:62:13:55:3D:B3:FF:0A:00:6B:FB:50:84:97:F3:ED:62:D0:1A
-
-            X509v3 Subject Key Identifier: 
-                A7:C7:13:A0:7A:01:3C:9D:EF:82:48:82:48:D5:73:51:B6:12:56:2A
-            1.2.840.113533.7.65.0: 
-                0
-..V7.1....
-    Signature Algorithm: sha1WithRSAEncryption
-        4a:f1:b3:ce:68:69:e3:58:a3:61:ed:b6:16:c8:93:b1:18:30:
-        3e:e0:72:df:4f:3d:e2:4d:e1:b8:fc:3f:c1:c9:e3:45:a9:5d:
-        a9:c1:da:a3:e5:36:d7:8e:d6:0f:ad:36:af:6c:bc:44:e6:9a:
-        46:94:a6:11:a0:d0:52:e7:da:55:b0:f6:1c:85:fb:63:52:7b:
-        b6:99:8f:1f:e2:cb:47:64:a2:eb:08:65:e6:51:db:1c:4b:6d:
-        7f:53:9f:1e:0d:31:93:d4:30:5d:1e:6e:01:07:27:60:5d:bb:
-        d3:f4:e3:6c:1d:20:0f:75:2a:33:10:a7:b7:89:d7:a9:17:14:
-        32:03
------BEGIN CERTIFICATE-----
-MIIGJDCCBY2gAwIBAgIEQoaroDANBgkqhkiG9w0BAQUFADCBwzELMAkGA1UEBhMC
-VVMxFDASBgNVBAoTC0VudHJ1c3QubmV0MTswOQYDVQQLEzJ3d3cuZW50cnVzdC5u
-ZXQvQ1BTIGluY29ycC4gYnkgcmVmLiAobGltaXRzIGxpYWIuKTElMCMGA1UECxMc
-KGMpIDE5OTkgRW50cnVzdC5uZXQgTGltaXRlZDE6MDgGA1UEAxMxRW50cnVzdC5u
-ZXQgU2VjdXJlIFNlcnZlciBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTAeFw0wNjA3
-MTQxNzEwMjhaFw0xNDA3MTQxNzQwMjhaMFwxCzAJBgNVBAYTAlVTMRUwEwYDVQQK
-EwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5jb20xGzAZBgNV
-BAMTEkRpZ2lDZXJ0IEdsb2JhbCBDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
-AQoCggEBAMQ8vMy66mLmnkIjr7SyEa5ijdmh04/MFHIZ7Zn2/d5du1nAsMKvaplS
-lVcLNf/hhvqvosPBBWUnIHYvClQlfOor3ZVBV5sPO89H6AEGjMVESPwHLvNygzBR
-lJ5pOoOph5AU2V7EoniPwT7UGWEOGufcGpUgQb5vF9q4HEHumLD61x01PxanBCgT
-XT0FdZouhp4ssBeHIFhX7+HqVWC4LHAhrCljDBD8YLz51Rw3ZNW0+x6rJjlGiKTL
-zTBnwCZ55cpo+SLX5dKxu0hMmwuYW0KS5dLtDkcw+t0nVmNqpQHHjq/wTjsbVRVE
-1T5NVx7hkeq4oI/OOmNflom6CD7+RLsCAwEAAaOCAwUwggMBMBIGA1UdEwEB/wQI
-MAYBAf8CAQAwggEyBgNVHSAEggEpMIIBJTCCASEGCSqGSIb2fQdLAjCCARIwJgYI
-KwYBBQUHAgEWGmh0dHA6Ly93d3cuZW50cnVzdC5uZXQvY3BzMIHnBggrBgEFBQcC
-AjCB2hqB10ZvciB1c2Ugc29sZWx5IHdpdGggU1NMIGFuZCBTL01JTUUgY2VydGlm
-aWNhdGVzIGlzc3VlZCBieSBEaWdpY2VydCwgSW5jLiB0byBhdXRob3JpemVkIHN1
-YnNjcmliZXJzLg0KRE9FUyBOT1QgcmVwcmVzZW50IGFueSBlbmRvcnNlbWVudCBi
-eSBFbnRydXN0IEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMgYXMgdG8gdGhlIGlkZW50
-aXR5IG9mIGFueSBjZXJ0aWZpY2F0ZSBob2xkZXIuMDEGA1UdJQQqMCgGCCsGAQUF
-BwMBBggrBgEFBQcDAgYIKwYBBQUHAwQGCCsGAQUFBwMJMIIBGAYDVR0fBIIBDzCC
-AQswKKAmoCSGImh0dHA6Ly9jcmwuZW50cnVzdC5uZXQvc2VydmVyMS5jcmwwgd6g
-gduggdikgdUwgdIxCzAJBgNVBAYTAlVTMRQwEgYDVQQKEwtFbnRydXN0Lm5ldDE7
-MDkGA1UECxMyd3d3LmVudHJ1c3QubmV0L0NQUyBpbmNvcnAuIGJ5IHJlZi4gKGxp
-bWl0cyBsaWFiLikxJTAjBgNVBAsTHChjKSAxOTk5IEVudHJ1c3QubmV0IExpbWl0
-ZWQxOjA4BgNVBAMTMUVudHJ1c3QubmV0IFNlY3VyZSBTZXJ2ZXIgQ2VydGlmaWNh
-dGlvbiBBdXRob3JpdHkxDTALBgNVBAMTBENSTDEwCwYDVR0PBAQDAgEGMB8GA1Ud
-IwQYMBaAFPAXYhNVPbP/CgBr+1CEl/PtYtAaMB0GA1UdDgQWBBSnxxOgegE8ne+C
-SIJI1XNRthJWKjAZBgkqhkiG9n0HQQAEDDAKGwRWNy4xAwIAgTANBgkqhkiG9w0B
-AQUFAAOBgQBK8bPOaGnjWKNh7bYWyJOxGDA+4HLfTz3iTeG4/D/ByeNFqV2pwdqj
-5TbXjtYPrTavbLxE5ppGlKYRoNBS59pVsPYchftjUnu2mY8f4stHZKLrCGXmUdsc
-S21/U58eDTGT1DBdHm4BBydgXbvT9ONsHSAPdSozEKe3idepFxQyAw==
------END CERTIFICATE-----
diff --git a/profiles/commons/modules/contrib/admin_icons/LICENSE.txt b/profiles/commons/modules/contrib/admin_icons/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/admin_icons/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/admin_icons/admin_icons.info b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
index 851595d..470aef2 100644
--- a/profiles/commons/modules/contrib/admin_icons/admin_icons.info
+++ b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
@@ -4,8 +4,8 @@ core = 7.x
 
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = ""
 project = "admin_icons"
-datestamp = "1382042540"
+datestamp = "1387568925"
 
diff --git a/profiles/commons/modules/contrib/apachesolr/CHANGELOG.txt b/profiles/commons/modules/contrib/apachesolr/CHANGELOG.txt
index fd5ecb3..daa5765 100644
--- a/profiles/commons/modules/contrib/apachesolr/CHANGELOG.txt
+++ b/profiles/commons/modules/contrib/apachesolr/CHANGELOG.txt
@@ -1,6 +1,43 @@
 Apache Solr integration 7.x-1.x, xxxx-xx-xx
 -----------------------------
 
+Apache Solr integration 7.x-1.6, 2013-11-14
+-----------------------------
+#2008832 by Nick_vh, j0rd: Re-apply added Allow turning off 'successful" actions in watchdog.
+REVERTED: #1827868 and releated path changes in #2008832
+
+Apache Solr integration 7.x-1.5, 2013-10-23
+-----------------------------
+#2118947 by Nick_vh: Added Allow mapping to accept multiple index_callbacks().
+#1828014 by ianthomas_uk, Nick_vh, DeFr: Fixed Mass re-indexation can miss (a lot of) content.
+#2106693 by wulff: Fixed Drush help refers to non-existent command.
+#2011492 by ianmthomasuk: Added Remove duplicated indexing code. (2/2)
+#2093031 by Nick_vh: Fixed Speed up indexing process significantly : make use of the filter cache.
+#1925026 by blazindrop: Added Allow modules to modify query used to select nodes for reindexing.
+#2012244 by Nick_vh, joseph.zhao: Added In Drupal 7, using short summary in the teaser.
+#1938976 by ajw, Nick_vh: Fixed Escape sort strings to support function sorts like geodist().
+#1361854 by acbramley, Nick_vh, wiifm: Added Ability to control the 'Did you mean?' by asking Solr for spellcheck.extendedResults.
+#1828134 by ianmthomasuk, Nick_vh: Fixed apachesolr_entity_delete() should apply to all writable environments.
+#2006602 by pwolanin, David_Rothstein: Fixed Documents are deleted from the Solr index in read-only environments.
+#1916558 by jwalz: Fixed Custom Filters are ignored in facet blocks on non-search paths.
+#2008832 by Nick_vh, j0rd: Added Allow to optionally turn off 'successful" actions in watchdog.
+#1952296 by David_Rothstein, zerolab, SamChez: Added Date facet granularity support.
+#1930686 by kevin.dutra: Fixed Multiple search pages can have the same path.
+REVERTED: #1827868 by ianmthomasuk, Nick_vh: Added Improve usability of admin interface when using multiple environments.
+#1433366 by Darren Oh | becw: Added Text field values not mapped in field_apachesolr_field_mappings().
+#1881878 by thsutton: Added Include source field ID in facet admin interface.
+#1365304 by brianV, deviantintegral, Nick_vh: Fixed Date field minimum/maximum range callbacks don't handle some cases; cause Solr exceptions.
+#1834862 by rupl: Improve documentation of hook_apachesolr_query_alter().
+#1825426 by cpliakas: Added an API function apachesolr_get_field_mappings().
+#1827216 by ianmthomasuk, ciss, Nick_vh: Fixed Bundle specific overrides for status callback and document callback ignored.
+#2072211 by pwolanin: Document the behavior of apachesolr_access() relative to hook_node_access().
+#1708200 by ianmthomasuk: Added Improve error reporting for invalid sorts and invalid solr responses.
+#1852088 by pwolanin | brianV: Fixed Apachesolr search results come back with $doc->url starting with 'default'.
+#2089845 by Nick_vh: Fixed When indexing, the module pings solr way too much.
+#2033913 by Nick_vh | epieddy: Fixed Small error in schema.xml.
+#1974124 by Nick_vh: Fixed Allow a more configurable soft commit status so we can start taking advantage of Solr 4."
+#2014067 by David_Rothstein: Fixed File types provided by the File Entity module are not always recognized by Apache Solr.
+
 Apache Solr integration 7.x-1.4, 2013-07-25
 -----------------------------
 #1807552 by pwolanin: further fixes to use the right language field.
diff --git a/profiles/commons/modules/contrib/apachesolr/Drupal_Apache_Solr_Service.php b/profiles/commons/modules/contrib/apachesolr/Drupal_Apache_Solr_Service.php
index e9d1fe4..a99a567 100644
--- a/profiles/commons/modules/contrib/apachesolr/Drupal_Apache_Solr_Service.php
+++ b/profiles/commons/modules/contrib/apachesolr/Drupal_Apache_Solr_Service.php
@@ -39,7 +39,8 @@
 
 /**
  * Additional code Copyright (c) 2008-2011 by Robert Douglass, James McKinney,
- * Jacob Singh, Alejandro Garza, Peter Wolanin, and additional contributors.
+ * Jacob Singh, Alejandro Garza, Peter Wolanin, Nick Veenhof and additional
+ * contributors.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -435,16 +436,62 @@ class DrupalApacheSolrService implements DrupalApacheSolrServiceInterface {
   protected function checkResponse($response) {
     $code = (int) $response->code;
     if ($code != 200) {
-      if ($code >= 400 && $code != 403 && $code != 404) {
-        // Add details, like Solr's exception message.
-        $response->status_message .= $response->data;
-      }
-      throw new Exception('"' . $code . '" Status: ' . $response->status_message);
+      // Report where the user's code called the apachesolr code
+      $caller = $this->findCaller();
+      watchdog(
+        'Apache Solr',
+        t('HTTP Status: %http_status; <br>Message: %status_message; <br>Response: %response; <br>Request: %request; <br>Caller: %function (line %line of %file)'),
+        array(
+          '%http_status' => $code,
+          '%status_message' => $response->status_message,
+          '%response' => $response->data,
+          '%request' => empty($response->request) ? t('Unknown') : $response->request,
+          '%function' => isset($caller['class']) ? $caller['class'].'->'.$caller['function'].'()' : $caller['function'].'()',
+          '%line' => $caller['line'],
+          '%file' => $caller['file'],
+        ),
+        WATCHDOG_ERROR
+      );
+      throw new Exception('HTTP ' . $code . '; ' . $response->status_message);
     }
     return $response;
   }
 
   /**
+   * Determine the routine that called this query.
+   *
+   * We define "the routine that called this query" as the first entry in
+   * the call stack that is not inside /apachesolr/. That makes the climbing
+   * logic very simple, and handles variable stack depth and hook functions.
+   *
+   * Copied from includes/database/log.inc
+   *
+   * @link http://www.php.net/debug_backtrace
+   * @return
+   *   This method returns a stack trace entry similar to that generated by
+   *   debug_backtrace(). However, it flattens the trace entry and the trace
+   *   entry before it so that we get the function and args of the function that
+   *   called into the apachesolr module, not the function and args of the
+   *   Solr call itself.
+   */
+  public function findCaller() {
+    $stack = debug_backtrace();
+    $stack_count = count($stack);
+    for ($i = 0; $i < $stack_count; ++$i) {
+      if (!isset($stack[$i]['file']) || strpos($stack[$i]['file'], DIRECTORY_SEPARATOR . 'apachesolr' . DIRECTORY_SEPARATOR) === FALSE) {
+        return array(
+          'file' => isset($stack[$i]['file']) ? $stack[$i]['file'] : t('Unknown'),
+          'line' => isset($stack[$i]['line']) ? $stack[$i]['line'] : t('Unknown'),
+          'function' => $stack[$i + 1]['function'],
+          'class' => isset($stack[$i + 1]['class']) ? $stack[$i + 1]['class'] : NULL,
+          'type' => isset($stack[$i + 1]['type']) ? $stack[$i + 1]['type'] : NULL,
+          'args' => $stack[$i + 1]['args'],
+        );
+      }
+    }
+  }
+
+  /**
    * Make a request to a servlet (a path) that's not a standard path.
    *
    * @param string $servlet
diff --git a/profiles/commons/modules/contrib/apachesolr/LICENSE.txt b/profiles/commons/modules/contrib/apachesolr/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/apachesolr/README.txt b/profiles/commons/modules/contrib/apachesolr/README.txt
index e32688d..25287c9 100644
--- a/profiles/commons/modules/contrib/apachesolr/README.txt
+++ b/profiles/commons/modules/contrib/apachesolr/README.txt
@@ -110,6 +110,15 @@ Once this module is enabled, enable blocks for facets first at
 Administer > Site configuration > Apache Solr > Enabled filters
 then position them as you like at Administer > Site building > Blocks.
 
+Access Sub-module
+------------
+The included Apache Solr Access module integrates with the node access
+system using node access grants. It does not (and can not) work
+with modules using hook_node_access() to block viewing of nodes because
+it's impossible to apply those dynamic filters to as-yet-unknown search
+results to return the correct number per page.  This same restriction
+applies to any module that does content searching or listing (e.g. Views).
+
 Settings.php
 ------------
 You can override environment settings using the following syntax in your
diff --git a/profiles/commons/modules/contrib/apachesolr/Solr_Base_Query.php b/profiles/commons/modules/contrib/apachesolr/Solr_Base_Query.php
index 46e4ec3..31984d9 100644
--- a/profiles/commons/modules/contrib/apachesolr/Solr_Base_Query.php
+++ b/profiles/commons/modules/contrib/apachesolr/Solr_Base_Query.php
@@ -150,10 +150,11 @@ class SolrFilterSubQuery {
    * @return boolean
    */
   public static function validFilterValue($filter) {
-    $opening = 0;
-    $closing = 0;
     $name = NULL;
     $value = NULL;
+    $matches = array();
+    $datefields = array();
+    $datefield_match = array();
 
     if (preg_match('/(?P<name>[^:]+):(?P<value>.+)?$/', $filter, $matches)) {
       foreach ($matches as $match_id => $match) {
@@ -183,13 +184,15 @@ class SolrFilterSubQuery {
       $valid_brackets = TRUE;
       $brackets['opening']['{'] = substr_count($value, '{');
       $brackets['closing']['}'] = substr_count($value, '}');
-      $valid_brackets = ($brackets['opening']['{'] != $brackets['closing']['}']) ? FALSE : TRUE;
+
+      $valid_brackets = $valid_brackets && ($brackets['opening']['{'] == $brackets['closing']['}']);
       $brackets['opening']['['] = substr_count($value, '[');
       $brackets['closing'][']'] = substr_count($value, ']');
-      $valid_brackets = ($brackets['opening']['['] != $brackets['closing'][']']) ? FALSE : TRUE;
+      $valid_brackets = $valid_brackets && ($brackets['opening']['['] == $brackets['closing'][']']);
       $brackets['opening']['('] = substr_count($value, '(');
       $brackets['closing'][')'] = substr_count($value, ')');
-      $valid_brackets = ($brackets['opening']['('] != $brackets['closing'][')']) ? FALSE : TRUE;
+      $valid_brackets = $valid_brackets && ($brackets['opening']['('] == $brackets['closing'][')']);
+
       if (!$valid_brackets) {
         return FALSE;
       }
@@ -436,6 +439,7 @@ class SolrBaseQuery extends SolrFilterSubQuery implements DrupalSolrQueryInterfa
     $exclude = FALSE;
     $name = NULL;
     $value = NULL;
+    $matches = array();
 
     // Check if we are dealing with an exclude
     if (preg_match('/^-(.*)/', $string, $matches)) {
@@ -566,13 +570,22 @@ class SolrBaseQuery extends SolrFilterSubQuery implements DrupalSolrQueryInterfa
     }
     else {
       // Validate and set sort parameter
-      $fields = implode('|', array_keys($this->available_sorts));
+      $fields = array_keys($this->available_sorts);
+      // Loop through available sorts and escape them, to allow for function sorts like geodist() in the preg_match() below
+      foreach ($fields as $key => $field) {
+        $fields[$key] = preg_quote($field);
+      }
+      // Implode the escaped available sorts together, then preg_match() against the sort string
+      $fields = implode('|', $fields);
       if (preg_match('/^(?:(' . $fields . ') (asc|desc),?)+$/', $sortstring, $matches)) {
         // We only use the last match.
         $this->solrsort['#name'] = $matches[1];
         $this->solrsort['#direction'] = $matches[2];
         $this->params['sort'] = array($sortstring);
       }
+      else {
+        return FALSE;
+      }
     }
   }
 
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr.admin.inc b/profiles/commons/modules/contrib/apachesolr/apachesolr.admin.inc
index 65b71b2..ea0775e 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr.admin.inc
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr.admin.inc
@@ -185,6 +185,18 @@ function apachesolr_environment_edit_form(array $form, array &$form_state, array
     '#options' => array(APACHESOLR_READ_WRITE => t('Read and write (normal)'), APACHESOLR_READ_ONLY => t('Read only')),
     '#description' => t('<em>Read only</em> stops this site from sending updates to this search environment. Useful for development sites.'),
   );
+  $form['conf']['apachesolr_direct_commit'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Commit changes after the index process has submitted them'),
+    '#description' => t('Commits the updates to solr. Uses soft commits where possible'),
+    '#default_value' => isset($environment['conf']['apachesolr_direct_commit']) ? $environment['conf']['apachesolr_direct_commit'] : false,
+  );
+  $form['conf']['apachesolr_soft_commit'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Commit changes to memory.'),
+    '#description' => t(' Reduces the load on your disk. Also known as Soft Commits, recommended for Solr 4.'),
+    '#default_value' => isset($environment['conf']['apachesolr_soft_commit']) ? $environment['conf']['apachesolr_soft_commit'] : false,
+  );
   $form['actions'] = array(
     '#type' => 'actions',
   );
@@ -511,6 +523,13 @@ function apachesolr_settings(array $form, array &$form_state) {
     '#default_value' => variable_get('apachesolr_failure', 'apachesolr:show_error'),
   );
 
+  $form['advanced']['apachesolr_watchdog_successes'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Log successful Apache Solr Search actions'),
+    '#description' => t('Watchdog will log successful adds and indexes.'),
+    '#default_value' => variable_get('apachesolr_watchdog_successes', TRUE),
+  );
+
   return system_settings_form($form);
 }
 
@@ -1084,8 +1103,12 @@ function apachesolr_index_action_form_delete_confirm_submit(array $form, array &
   }
   // Rebuild our tracking table.
   module_load_include('inc', 'apachesolr', 'apachesolr.index');
-  apachesolr_index_delete_index($env_id);
-  drupal_set_message(t('The index has been deleted.'));
+  if (apachesolr_index_delete_index($env_id)) {
+    drupal_set_message(t('The index has been deleted.'));
+  }
+  else {
+    drupal_set_message(t('An error occured while trying to delete the index.'), 'error');
+  }
 }
 
 /**
@@ -1193,6 +1216,7 @@ function apachesolr_index_batch_index_entities($env_id, $total_limit = NULL, &$c
   if ($context['finished']) {
     $context['results']['count'] = $context['sandbox']['progress'];
     $context['results']['submitted'] = $context['sandbox']['submitted'];
+    $context['results']['env_id'] = $env_id;
   }
 }
 
@@ -1214,6 +1238,13 @@ function apachesolr_index_batch_index_finished($success, array $results, array $
     $message .= format_plural($results['submitted'], '1 document successfully sent to Solr.', '@count documents successfully sent to Solr.');
   }
   if ($success) {
+    // Directly process those documents if direct commit was enabled.
+    $direct_commit = apachesolr_environment_variable_get($results['env_id'], 'apachesolr_direct_commit', FALSE);
+    if ($direct_commit) {
+      // Get the $solr object
+      $solr = apachesolr_get_solr($results['env_id']);
+      $solr->commit();
+    }
     $type = 'status';
   }
   else {
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr.api.php b/profiles/commons/modules/contrib/apachesolr/apachesolr.api.php
index 74c9196..3e16721 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr.api.php
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr.api.php
@@ -25,7 +25,7 @@ function hook_apachesolr_default_environment($env_id, $old_env_id) {
  * handles just list fields and taxonomy term reference fields, such as:
  *
  * $mappings['list_text'] = array(
- *   'indexing_callback' => 'apachesolr_fields_list_indexing_callback',
+ *   'indexing_callback' => array('apachesolr_fields_list_indexing_callback'),
  *   'index_type' => 'string',
  *   'map callback' => 'apachesolr_fields_list_display_callback',
  *   'facets' => TRUE,
@@ -53,7 +53,7 @@ function hook_apachesolr_field_mappings() {
   $mappings = array(
     // Example for a field API type. See extensive documentation below
     'number_float' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'index_type' => 'tfloat',
       'facets' => TRUE,
       'query types' => array('term', 'numeric_range'),
@@ -67,7 +67,7 @@ function hook_apachesolr_field_mappings() {
         // REQUIRED FIELDS //
         // Function callback to return the value that will be put in to
         // the solr index
-        'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+        'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
 
         // NON REQUIRED FIELDS //
         // See apachesolr_index_key() for the correct type. Defaults string
@@ -125,7 +125,7 @@ function hook_apachesolr_field_mappings() {
 function hook_apachesolr_field_mappings_alter(array &$mappings, $entity_type) {
   // Enable indexing for text fields
   $mappings['text'] = array(
-    'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+    'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
     'map callback' => '',
     'index_type' => 'string',
     'facets' => TRUE,
@@ -187,6 +187,10 @@ function hook_apachesolr_field_name_map_alter(array &$map) {
  *
  * @param DrupalSolrQueryInterface $query
  *   An object implementing DrupalSolrQueryInterface. No need for &.
+ *
+ * @see /admin/reports/apachesolr
+ * - This report displays the active solr index fields and can help you
+ *   create Solr filters based on the data currently in your system
  */
 function hook_apachesolr_query_alter(DrupalSolrQueryInterface $query) {
   // I only want to see articles by the admin.
@@ -200,6 +204,22 @@ function hook_apachesolr_query_alter(DrupalSolrQueryInterface $query) {
 
   // Only search titles.
   $query->replaceParam('qf', 'label');
+
+  // Restrict results to a single content type (use machine name).
+  $query->addFilter('bundle', 'my_content_type');
+
+  // Exclude results by setting the third argument of addFilter to TRUE.
+  // This filter will return all content types EXCEPT my_content_type nodes.
+  $query->addFilter('bundle', 'my_content_type', TRUE);
+
+  // Restrict results to several content types (use machine names).
+  // You could also solve this using the SolrFilterSubQuery object and append it
+  // to the original query.
+  $content_types = array(
+    'content_type_1',
+    'content_type_2',
+  );
+  $query->addFilter('bundle', '('. implode(' OR ', $content_types) .')');
 }
 
 /**
@@ -424,3 +444,15 @@ function hook_apachesolr_index_document_build_ENTITY_TYPE(ApacheSolrDocument $do
 function hook_apachesolr_index_documents_alter(array &$documents, $entity, $entity_type, $env_id) {
   // Do whatever altering you need here
 }
+
+
+/**
+ * Modify the returned spellings suggestions. The environment is available
+ * as an argument so the search query can be retrieved if necessary
+ *
+ * @param array $suggestions
+ * @param string $env_id
+ */
+function hook_apachesolr_suggestions_alter(&$suggestions, $env_id) {
+  // Modify the suggestions here
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr.index.inc b/profiles/commons/modules/contrib/apachesolr/apachesolr.index.inc
index 2ce31cb..ea7ba10 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr.index.inc
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr.index.inc
@@ -35,9 +35,28 @@
  */
 function apachesolr_index_entities($env_id, $limit) {
   $documents_submitted = 0;
+
+  try {
+    // Get the $solr object
+    $solr = apachesolr_get_solr($env_id);
+    // If there is no server available, don't continue.
+    if (!$solr->ping(variable_get('apachesolr_ping_timeout', 4))) {
+      throw new Exception(t('No Solr instance available during indexing.'));
+    }
+  }
+  catch (Exception $e) {
+    watchdog('Apache Solr', nl2br(check_plain($e->getMessage())), NULL, WATCHDOG_ERROR);
+    return FALSE;
+  }
+
   foreach (entity_get_info() as $entity_type => $info) {
     // With each pass through the callback, retrieve the next group of nids.
     $rows = apachesolr_index_get_entities_to_index($env_id, $entity_type, $limit);
+    // If there are none for this entity type - ignore it and go to the next
+    // entity type.
+    if (!count($rows)) {
+      continue;
+    }
     $documents = array();
     foreach ($rows as $row) {
       $row_documents = apachesolr_index_entities_document($row, $entity_type, $env_id);
@@ -47,20 +66,23 @@ function apachesolr_index_entities($env_id, $limit) {
     $indexed = apachesolr_index_send_to_solr($env_id, $documents);
     if ($indexed !== FALSE) {
       $documents_submitted += count($documents);
-      $index_position = apachesolr_get_last_index_position($env_id, $entity_type);
-      $max_changed = $index_position['last_changed'];
-      $max_entity_id = $index_position['last_entity_id'];
-      foreach ($rows as $row) {
-        if (!empty($row->status)) {
-          if ($row->changed > $max_changed) {
-            $max_changed = $row->changed;
-          }
-          if ($row->entity_id > $max_entity_id) {
-            $max_entity_id = $row->entity_id;
-          }
-        }
+      // Check who's the last in line
+      $last_row = end($rows);
+
+      // set our last position to the entity id and changed value so we can
+      // keep track where we left off
+      if (!empty($last_row->changed) && !empty($last_row->entity_id)) {
+        apachesolr_set_last_index_position($env_id, $entity_type, $last_row->changed, $last_row->entity_id);
+      }
+      else {
+        $message = 'Failure recording indexing progress. Last entity id processed: %entity_id with timestamp %last_changed';
+        $variables = array(
+          '%entity_id' => $last_row->entity_id,
+          '%last_changed' => $last_row->changed,
+        );
+        // Add it to watchdog
+        watchdog('Apache Solr', $message, $variables, WATCHDOG_ERROR);
       }
-      apachesolr_set_last_index_position($env_id, $entity_type, $max_changed, $max_entity_id);
       apachesolr_set_last_index_updated($env_id, REQUEST_TIME);
     }
   }
@@ -138,30 +160,14 @@ function apachesolr_index_status($env_id) {
     }
 
     $table = apachesolr_get_indexer_table($entity_type);
-    $query = db_select($table, 'asn')->condition('asn.status', 1)->condition('asn.bundle', $bundles);
-    $total += $query->countQuery()->execute()->fetchField();
-
-    // Get $last_entity_id and $last_changed.
-    $last_index_position = apachesolr_get_last_index_position($env_id, $entity_type);
-    $last_entity_id = $last_index_position['last_entity_id'];
-    $last_changed = $last_index_position['last_changed'];
-
-    // Find the remaining entities to index for this entity type.
     $query = db_select($table, 'aie')
-      ->condition('aie.bundle', $bundles)
       ->condition('aie.status', 1)
-      ->condition(db_or()
-        ->condition('aie.changed', $last_changed, '>')
-        ->condition(db_and()
-          ->condition('aie.changed', $last_changed, '<=')
-          ->condition('aie.entity_id', $last_entity_id, '>')))
+      ->condition('aie.bundle', $bundles)
       ->addTag('apachesolr_index_' . $entity_type);
 
+    $total += $query->countQuery()->execute()->fetchField();
 
-    if ($table == 'apachesolr_index_entities') {
-      // Other, entity-specific tables don't need this condition.
-      $query->condition('aie.entity_type', $entity_type);
-    }
+    $query = _apachesolr_index_get_next_set_query($env_id, $entity_type);
     $remaining += $query->countQuery()->execute()->fetchField();
   }
   return array('remaining' => $remaining, 'total' => $total);
@@ -274,11 +280,11 @@ function apachesolr_convert_entity_to_documents($entity, $entity_type, $env_id)
   $document = _apachesolr_index_process_entity_get_document($entity, $entity_type);
 
   //Get the callback array to add stuff to the document
-  $callbacks = apachesolr_entity_get_callback($entity_type, 'document callback', $bundle);
+  $document_callbacks = apachesolr_entity_get_callback($entity_type, 'document callback', $bundle);
   $documents = array();
-  foreach ($callbacks as $callback) {
+  foreach ($document_callbacks as $document_callback) {
     // Call a type-specific callback to add stuff to the document.
-    $documents = array_merge($documents, $callback($document, $entity, $entity_type, $env_id));
+    $documents = array_merge($documents, $document_callback($document, $entity, $entity_type, $env_id));
   }
 
   //do this for all possible documents that were returned by the callbacks
@@ -330,33 +336,29 @@ function apachesolr_convert_entity_to_documents($entity, $entity_type, $env_id)
  * @throws Exception
  */
 function apachesolr_index_send_to_solr($env_id, array $documents) {
-  try {
-    // Get the $solr object
-    $solr = apachesolr_get_solr($env_id);
-    // If there is no server available, don't continue.
-    if (!$solr->ping(variable_get('apachesolr_ping_timeout', 4))) {
-      throw new Exception(t('No Solr instance available during indexing.'));
-    }
-  }
-  catch (Exception $e) {
-    watchdog('Apache Solr', nl2br(check_plain($e->getMessage())), NULL, WATCHDOG_ERROR);
-    return FALSE;
-  }
+  // Get the $solr object
+  $solr = apachesolr_get_solr($env_id);
+
   // Do not index when we do not have any documents to send
   // Send TRUE because this is not an error
   if (empty($documents)) {
     return TRUE;
   }
   // Send the document off to Solr.
-  watchdog('Apache Solr', 'Adding @count documents.', array('@count' => count($documents)));
+  $log_success = variable_get('apachesolr_watchdog_successes', TRUE);
+  if ($log_success) {
+    watchdog('Apache Solr', 'Adding @count documents.', array('@count' => count($documents)));
+  }
   try {
     $docs_chunk = array_chunk($documents, 20);
     foreach ($docs_chunk as $docs) {
       $solr->addDocuments($docs);
     }
-    watchdog('Apache Solr', 'Indexing succeeded on @count documents', array(
-      '@count' => count($documents),
-    ), WATCHDOG_INFO);
+    if ($log_success) {
+      watchdog('Apache Solr', 'Indexing succeeded on @count documents', array(
+        '@count' => count($documents),
+      ), WATCHDOG_INFO);
+    }
     return count($documents);
   }
   catch (Exception $e) {
@@ -501,40 +503,20 @@ function apachesolr_index_get_entities_to_index($env_id, $entity_type, $limit) {
     return $rows;
   }
 
-  $table = apachesolr_get_indexer_table($entity_type);
-  // Get $last_entity_id and $last_changed.
-  $last_index_position = apachesolr_get_last_index_position($env_id, $entity_type);
-  $last_entity_id = $last_index_position['last_entity_id'];
-  $last_changed = $last_index_position['last_changed'];
-
-  // Find the next batch of entities to index for this entity type.  Note that
-  // for ordering we're grabbing the oldest first and then ordering by ID so
-  // that we get a definitive order.
-  // Also note that we fetch ALL fields from the indexer table
-  $query = db_select($table, 'aie')
-    ->fields('aie')
-    ->condition('aie.bundle', $bundles)
-    ->condition(db_or()
-      ->condition('aie.changed', $last_changed, '>')
-      ->condition(db_and()
-        ->condition('aie.changed', $last_changed, '<=')
-        ->condition('aie.entity_id', $last_entity_id, '>')))
-    ->orderBy('aie.changed', 'ASC')
-    ->orderBy('aie.entity_id', 'ASC')
-    ->addTag('apachesolr_index_' . $entity_type);
-
-  if ($table == 'apachesolr_index_entities') {
-    // Other, entity-specific tables don't need this condition.
-    $query->condition('aie.entity_type', $entity_type);
-  }
+  // Get next batch of entities to index
+  $query = _apachesolr_index_get_next_set_query($env_id, $entity_type);
+  
   $query->range(0, $limit);
   $records = $query->execute();
 
-  $status_callbacks = apachesolr_entity_get_callback($entity_type, 'status callback');
+  $status_callbacks = array();
   foreach ($records as $record) {
+    if (!isset($status_callbacks[$record->bundle])) {
+      $status_callbacks[$record->bundle] = apachesolr_entity_get_callback($entity_type, 'status callback', $record->bundle);
+    }
     // Check status and status callbacks before sending to the index
-    if (is_array($status_callbacks)) {
-      foreach($status_callbacks as $status_callback) {
+    if (is_array($status_callbacks[$record->bundle])) {
+      foreach ($status_callbacks[$record->bundle] as $status_callback) {
         if (is_callable($status_callback)) {
           // by placing $status in front we prevent calling any other callback
           // after one status callback returned false
@@ -557,8 +539,15 @@ function apachesolr_index_get_entities_to_index($env_id, $entity_type, $limit) {
  * @param string $bundle
  *   (optional) also specify a bundle to remove just the bundle from
  *   the index.
+ *
+ * @return
+ *   TRUE for success, FALSE if an error occured.
  */
 function apachesolr_index_delete_index($env_id, $entity_type = NULL, $bundle = NULL) {
+  if (apachesolr_environment_variable_get($env_id, 'apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
+    watchdog('Apache Solr', 'Trying to update the Solr index while the environment %env_id is read-only in function %function', array('%function' => __FUNCTION__, '%env_id' => $env_id), WATCHDOG_WARNING);
+    return FALSE;
+  }
   // Instantiate a new Solr object.
   try {
     $solr = apachesolr_get_solr($env_id);
@@ -582,9 +571,9 @@ function apachesolr_index_delete_index($env_id, $entity_type = NULL, $bundle = N
     watchdog('Apache Solr', 'Deleted documents from index with query @query', array('@query' => $query), WATCHDOG_INFO);
 
     if (!empty($entity_type)) {
-      $rebuild_callback = apachesolr_entity_get_callback($entity_type, 'reindex callback');
-      if (is_callable($rebuild_callback)) {
-        $rebuild_callback($env_id, $bundle);
+      $reindex_callback = apachesolr_entity_get_callback($entity_type, 'reindex callback');
+      if (is_callable($reindex_callback)) {
+        $reindex_callback($env_id, $bundle);
       }
     }
     else {
@@ -595,7 +584,57 @@ function apachesolr_index_delete_index($env_id, $entity_type = NULL, $bundle = N
   }
   catch (Exception $e) {
     watchdog('Apache Solr', nl2br(check_plain($e->getMessage())), NULL, WATCHDOG_ERROR);
+    return FALSE;
   }
+  return TRUE;
+}
+
+/**
+ * Internal function that identifies entities that are still due to be indexed.
+ *
+ * @param string $env_id Environment ID
+ * @param string $entity_type
+ *
+ * @return SelectQuery
+ */
+function _apachesolr_index_get_next_set_query($env_id, $entity_type) {
+  $table = apachesolr_get_indexer_table($entity_type);
+  // Get $last_entity_id and $last_changed.
+  $last_index_position = apachesolr_get_last_index_position($env_id, $entity_type);
+  $bundles = apachesolr_get_index_bundles($env_id, $entity_type);
+
+  $last_entity_id = $last_index_position['last_entity_id'];
+  $last_changed = $last_index_position['last_changed'];
+
+  // Find the next batch of entities to index for this entity type.  Note that
+  // for ordering we're grabbing the oldest first and then ordering by ID so
+  // that we get a definitive order.
+  // Also note that we fetch ALL fields from the indexer table
+  $query = db_select($table, 'aie')
+    ->fields('aie')
+    ->condition('aie.bundle', $bundles)
+    ->condition('aie.status', 1)
+    ->condition(db_or()
+      ->condition('aie.changed', $last_changed, '>')
+      // Tie breaker for entities that were changed at exactly
+      // the same second as the last indexed entity
+      ->condition(db_and()
+        ->condition('aie.changed', $last_changed, '=')
+        ->condition('aie.entity_id', $last_entity_id, '>')
+      )
+    )
+    // It is important that everything is indexed in order of changed date and
+    // then on entity_id because otherwise the conditions above will not match
+    // correctly
+    ->orderBy('aie.changed', 'ASC')
+    ->orderBy('aie.entity_id', 'ASC')
+    ->addTag('apachesolr_index_' . $entity_type);
+
+  if ($table == 'apachesolr_index_entities') {
+    // Other, entity-specific tables don't need this condition.
+    $query->condition('aie.entity_type', $entity_type);
+  }
+  return $query;
 }
 
 /**
@@ -611,6 +650,10 @@ function apachesolr_index_delete_index($env_id, $entity_type = NULL, $bundle = N
  * @return true on success, false on failure.
  */
 function apachesolr_index_delete_bundles($env_id, $entity_type, array $excluded_bundles) {
+  if (apachesolr_environment_variable_get($env_id, 'apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
+    watchdog('Apache Solr', 'Trying to update the Solr index while the environment %env_id is read-only in function %function', array('%function' => __FUNCTION__, '%env_id' => $env_id), WATCHDOG_WARNING);
+    return FALSE;
+  }
   // Remove newly omitted bundles.
   try {
     $solr = apachesolr_get_solr($env_id);
@@ -655,6 +698,7 @@ function apachesolr_index_delete_entity_from_index($env_id, $entity_type, $entit
     return FALSE;
   }
   if (apachesolr_environment_variable_get($env_id, 'apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
+    watchdog('Apache Solr', 'Trying to update the Solr index while the environment %env_id is read-only in function %function', array('%function' => __FUNCTION__, '%env_id' => $env_id), WATCHDOG_WARNING);
     return FALSE;
   }
   try {
@@ -788,9 +832,13 @@ function apachesolr_index_node_solr_document(ApacheSolrDocument $document, $node
   $document->label = apachesolr_clean_text($node->title);
 
   // Build the node body.
-  $build = node_view($node, 'search_index', !empty($node->language) ? $node->language : LANGUAGE_NONE);
+  $language = !empty($node->language) ? $node->language : LANGUAGE_NONE;
+  $build = node_view($node, 'search_index', $language);
   // Remove useless html crap out of the render.
   unset($build['#theme']);
+  // Allow cache if it's present
+  $build['#cache'] = true;
+  // Render it into html
   $text = drupal_render($build);
   $document->content = apachesolr_clean_text($text);
 
@@ -799,7 +847,15 @@ function apachesolr_index_node_solr_document(ApacheSolrDocument $document, $node
     $document->teaser = apachesolr_clean_text($node->teaser);
   }
   else {
-    $document->teaser = truncate_utf8($document->content, 300, TRUE);
+    // If there is no node teaser we will have to generate the teaser
+    // ourselves. We have to be careful to not leak the author and other
+    // information that is normally also not visible.
+    if (isset($node->body[$language][0]['safe_summary'])) {
+      $document->teaser = apachesolr_clean_text($node->body[$language][0]['safe_summary']);
+    }
+    else {
+      $document->teaser = truncate_utf8($document->content, 300, TRUE);
+    }
   }
 
   // Author information
@@ -1327,12 +1383,12 @@ function apachesolr_index_node_check_table() {
   // We do not check more nodes than double the cron limit per time
   // Update or delete at most this many in each Solr query.
   $limit = variable_get('apachesolr_cron_mass_limit', 500);
-  $query = db_select($table, 'aien')
+  $query = db_select($table, 'aie')
     ->fields('n', array('nid', 'status'))
-    ->where('aien.status <> n.status')
+    ->where('aie.status <> n.status')
     ->range(0, ($limit * 2))
     ->addTag('apachesolr_index_node');
-  $query->innerJoin('node', 'n', 'n.nid = aien.entity_id');
+  $query->innerJoin('node', 'n', 'n.nid = aie.entity_id');
   $nodes = $query->execute()->fetchAllAssoc('nid');
 
   $node_lists = array_chunk($nodes, $limit, TRUE);
@@ -1379,7 +1435,8 @@ function apachesolr_index_nodeapi_mass_update(array $nodes, $table = NULL) {
   }
 
   if (apachesolr_environment_variable_get(apachesolr_default_environment(), 'apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
-    return TRUE;
+    watchdog('Apache Solr', 'Trying to update the Solr index while the environment %env_id is read-only in function %function', array('%function' => __FUNCTION__, '%env_id' => apachesolr_default_environment()), WATCHDOG_WARNING);
+    return FALSE;
   }
 
   $published_ids = array();
@@ -1436,7 +1493,8 @@ function apachesolr_index_nodeapi_mass_delete(array $nodes, $table = NULL) {
   }
 
   if (apachesolr_environment_variable_get(apachesolr_default_environment(), 'apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
-    return TRUE;
+    watchdog('Apache Solr', 'Trying to update the Solr index while the environment %env_id is read-only in function %function', array('%function' => __FUNCTION__, '%env_id' => apachesolr_default_environment()), WATCHDOG_WARNING);
+    return FALSE;
   }
 
   $ids = array();
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr.info b/profiles/commons/modules/contrib/apachesolr/apachesolr.info
index c69e09a..c497f1f 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr.info
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr.info
@@ -24,9 +24,9 @@ files[] = tests/solr_base_query.test
 files[] = tests/solr_base_subquery.test
 files[] = tests/solr_document.test
 
-; Information added by drupal.org packaging script on 2013-07-26
-version = "7.x-1.4"
+; Information added by  packaging script on 2013-11-17
+version = "7.x-1.6"
 core = "7.x"
 project = "apachesolr"
-datestamp = "1374808867"
+datestamp = "1384712308"
 
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr.module b/profiles/commons/modules/contrib/apachesolr/apachesolr.module
index 60f388a..0509cf8 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr.module
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr.module
@@ -380,7 +380,10 @@ function apachesolr_entity_field_facets($entity_type) {
           'label' => check_plain($field_info['display_name']),
           'dependency plugins' => $field_info['dependency plugins'],
           'field api name' => $field_info['field']['field_name'],
-          'description' => t('Filter by field of type @type.', array('@type' => $field_info['field']['type'])),
+          'description' => t('Filter by field @field of type @type.', array(
+            '@type' => $field_info['field']['type'],
+            '@field' => $field_info['field']['field_name'],
+          )),
           'map callback' => $field_info['map callback'],
           'map options' => $field_info,
           'hierarchy callback' => $field_info['hierarchy callback'],
@@ -739,9 +742,9 @@ function apachesolr_node_type_delete($info) {
     apachesolr_index_set_bundles($env_id, 'node', $new_bundles);
   }
   apachesolr_index_delete_bundles($env_id, 'node', array($info->type));
-  $callback = apachesolr_entity_get_callback('node', 'bundles changed callback');
-  if (!empty($callback)) {
-    call_user_func($callback, $env_id, $existing_bundles, $new_bundles);
+  $bundles_changed_callback = apachesolr_entity_get_callback('node', 'bundles changed callback');
+  if (!empty($bundles_changed_callback)) {
+    call_user_func($bundles_changed_callback, $env_id, $existing_bundles, $new_bundles);
   }
   apachesolr_environments_clear_cache();
 }
@@ -1187,6 +1190,10 @@ function apachesolr_get_solr($env_id = NULL) {
       }
       // Takes advantage of auto-loading.
       $solr = new $class($environments[$env_id]['url'], $env_id);
+      $soft_commit = apachesolr_environment_variable_get($env_id, 'apachesolr_soft_commit', FALSE);
+      if ($soft_commit) {
+        $solr->setSoftCommit($soft_commit);
+      }
       $solr_cache[$env_id] = $solr;
     }
     return $solr_cache[$env_id];
@@ -1526,9 +1533,7 @@ function apachesolr_do_query(DrupalSolrQueryInterface $current_query) {
     return array(NULL, array());
   }
 
-
   $keys = $query->getParam('q');
-
   if (strlen($keys) == 0 && ($filters = $query->getFilters())) {
     // Move the fq params to q.alt for better performance. Only suitable
     // when using dismax or edismax, so we keep this out of the query class itself
@@ -1764,8 +1769,15 @@ function apachesolr_index_key($field) {
       $type_prefix = 's'; // String
   }
   $sm = !empty($field['multiple']) ? 'm_' : 's_';
-  // Block deltas are limited to 32 chars.
-  return substr($type_prefix . $sm . $field['name'], 0, 32);
+
+  // Legacy: Block deltas are limited to 32 chars. Keep it like this for backwards compatibility
+  $apachesolr_field_length_limit = variable_get('apachesolr_field_length_limit', '32');
+  if ($apachesolr_field_length_limit <= 0) {
+    return $type_prefix . $sm . $field['name'];
+  }
+  else {
+    return substr($type_prefix . $sm . $field['name'], 0, $apachesolr_field_length_limit);
+  }
 }
 
 /**
@@ -1825,6 +1837,21 @@ function apachesolr_facet_form_validate($form, &$form_state) {
 }
 
 /**
+ * Implements hook_module_implements_alter().
+ */
+function apachesolr_module_implements_alter(&$implementations, $hook) {
+  // This module's hook_entity_info_alter() implementation should run last
+  // since it needs to examine the list of bundles for each entity type, which
+  // may have been changed in earlier hook_entity_info_alter() implementations
+  // (for example, the File Entity module does this for file entities).
+  if ($hook == 'entity_info_alter') {
+    $group = $implementations['apachesolr'];
+    unset($implementations['apachesolr']);
+    $implementations['apachesolr'] = $group;
+  }
+}
+
+/**
  * Implements hook_entity_info_alter().
  */
 function apachesolr_entity_info_alter(&$entity_info) {
@@ -2001,15 +2028,25 @@ function apachesolr_get_indexer_table($type) {
 
 /**
  * Implements hook_entity_delete().
+ * 
+ * Delete the entity's entry from a fictional table of all entities.
  */
 function apachesolr_entity_delete($entity, $entity_type) {
-  $env_id = apachesolr_default_environment();
-
-  // Delete the entity's entry from a fictional table of all entities.
   list($entity_id) = entity_extract_ids($entity_type, $entity);
-  apachesolr_remove_entity($env_id, $entity_type, $entity_id);
+  // Get all environments and delete it from their table and index
+  $environments = apachesolr_load_all_environments();
+  foreach ($environments as $environment) {
+    apachesolr_remove_entity($environment['env_id'], $entity_type, $entity_id);
+  }
 }
 
+/**
+ * Remove a specific entity from a given Solr environment.
+ * 
+ * @param string $env_id
+ * @param string $entity_type
+ * @param string $entity_id
+ */
 function apachesolr_remove_entity($env_id, $entity_type, $entity_id) {
   module_load_include('inc', 'apachesolr', 'apachesolr.index');
 
@@ -2039,34 +2076,8 @@ function apachesolr_entity_fields($entity_type = 'node') {
   if (!isset($fields[$entity_type])) {
     $fields[$entity_type] = array();
 
-    $mappings = module_invoke_all('apachesolr_field_mappings');
-    foreach (array_keys($mappings) as $key) {
-      // Set all values with defaults.
-      $defaults = array(
-          'dependency plugins' => array('bundle', 'role'),
-          'map callback' => FALSE,
-          'name callback' => '',
-          'hierarchy callback' => FALSE,
-          'indexing_callback' => '',
-          'index_type' => 'string',
-          'facets' => FALSE,
-          'facet missing allowed' => FALSE,
-          'facet mincount allowed' => FALSE,
-          // Field API allows any field to be multi-valued.
-          'multiple' => TRUE,
-        );
-      if ($key !== 'per-field') {
-        $mappings[$key] += $defaults;
-      }
-      else {
-        foreach (array_keys($mappings[$key]) as $field_key) {
-          $mappings[$key][$field_key] += $defaults;
-        }
-      }
-    }
-
-    // Allow other modules to add or alter mappings.
-    drupal_alter('apachesolr_field_mappings', $mappings, $entity_type);
+    // Get the field mappings from apachesolr_field_mappings() implementations.
+    $mappings = apachesolr_get_field_mappings($entity_type);
 
     $modules = system_get_info('module');
     $instances = field_info_instances($entity_type);
@@ -2120,6 +2131,79 @@ function apachesolr_entity_fields($entity_type = 'node') {
 }
 
 /**
+ * Gets the Apache Solr field mappings.
+ *
+ * Field mappings define the various callbacks and Facet API keys associated
+ * with field types, i.e. "integer", "date", etc. Mappings are gathered by
+ * invoking hook_apachesolr_field_mappings().
+ *
+ * @param string $entity_type
+ *   The machine name of the entity mappings are being collected for.
+ *
+ * @return array
+ *   An associative array keyed by field type to an array of mappings
+ *   containing:
+ *   - dependency plugins: The Facet API dependency plugins associated with
+ *     fields of this type.
+ *   - map callback: The Facet API map callback that converts the raw values
+ *     stored in the index to something human readable.
+ *   - name callback: Callback used to modify the base name of the field as it
+ *     is stored in Solr. For example, the name callback cound change an integer
+ *     field from "field_foo" to "field_bar" so that it is stored in Solr as
+ *     "i_field_bar".
+ *   - hierarchy callback: The Facet API hierarchy processing callback for
+ *     hierarchical facets.
+ *   - indexing_callback: Callback used to retrieve values for indexing.
+ *   - index_type: The Solr datatype associated with this field type.
+ *   - facets: A boolean flagging whether facets are allowed for this field.
+ *   - facet missing allowed: A boolean flagging whether the Facet API "missing
+ *     facets" setting is supported by fields of this type.
+ *   - facet mincount allowed: A boolean flagging whether the Facet API "minimum
+ *     facet count" setting is supported by fields of this type.
+ *   - multiple: A boolean flagging whether the field contains multiple values.
+ *
+ * @see http://drupal.org/node/1825426
+ */
+function apachesolr_get_field_mappings($entity_type) {
+  $field_mappings = &drupal_static(__FUNCTION__, array());
+  if (!isset($field_mappings[$entity_type])) {
+
+    $field_mappings[$entity_type] = module_invoke_all('apachesolr_field_mappings');
+    $mappings = &$field_mappings[$entity_type];
+
+    foreach (array_keys($mappings) as $key) {
+      // Set all values with defaults.
+      $defaults = array(
+        'dependency plugins' => array('bundle', 'role'),
+        'map callback' => FALSE,
+        'name callback' => '',
+        'hierarchy callback' => FALSE,
+        'indexing_callback' => '',
+        'index_type' => 'string',
+        'facets' => FALSE,
+        'facet missing allowed' => FALSE,
+        'facet mincount allowed' => FALSE,
+        // Field API allows any field to be multi-valued.
+        'multiple' => TRUE,
+      );
+      if ($key !== 'per-field') {
+        $mappings[$key] += $defaults;
+      }
+      else {
+        foreach (array_keys($field_mappings[$key]) as $field_key) {
+          $mappings[$key][$field_key] += $defaults;
+        }
+      }
+    }
+
+    // Allow other modules to add or alter the field mappings.
+    drupal_alter('apachesolr_field_mappings', $mappings, $entity_type);
+  }
+
+  return $field_mappings[$entity_type];
+}
+
+/**
  * Implements hook_apachesolr_index_document_build().
  */
 function field_apachesolr_index_document_build(ApacheSolrDocument $document, $entity, $entity_type) {
@@ -2133,14 +2217,20 @@ function field_apachesolr_index_document_build(ApacheSolrDocument $document, $en
         // See if the node has fields that can be indexed
         if (isset($entity->{$field_name})) {
           // Got a field.
-          $function = $field_info['indexing_callback'];
-          if ($function && function_exists($function)) {
-            // NOTE: This function should always return an array.  One
-            // entity field may be indexed to multiple Solr fields.
-            $fields = $function($entity, $field_name, $index_key, $field_info);
-            foreach ($fields as $field) {
-              // It's fine to use this method also for single value fields.
-              $document->setMultiValue($field['key'], $field['value']);
+          $functions = $field_info['indexing_callback'];
+
+          if (!is_array($functions)) {
+            $functions = array($functions);
+          }
+          foreach ($functions as $function) {
+            if ($function && function_exists($function)) {
+              // NOTE: This function should always return an array.  One
+              // entity field may be indexed to multiple Solr fields.
+              $fields = $function($entity, $field_name, $index_key, $field_info);
+              foreach ($fields as $field) {
+                // It's fine to use this method also for single value fields.
+                $document->setMultiValue($field['key'], $field['value']);
+              }
             }
           }
         }
@@ -2429,7 +2519,7 @@ function apachesolr_hook_info() {
 function field_apachesolr_field_mappings() {
   $mappings = array(
     'list_integer' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'map callback' => 'apachesolr_fields_list_facet_map_callback',
       'index_type' => 'integer',
       'facets' => TRUE,
@@ -2438,7 +2528,7 @@ function field_apachesolr_field_mappings() {
       'facet missing allowed' => TRUE,
     ),
     'list_float' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'map callback' => 'apachesolr_fields_list_facet_map_callback',
       'index_type' => 'float',
       'facets' => TRUE,
@@ -2447,21 +2537,21 @@ function field_apachesolr_field_mappings() {
       'facet missing allowed' => TRUE,
     ),
     'list_text' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'map callback' => 'apachesolr_fields_list_facet_map_callback',
       'index_type' => 'string',
       'facets' => TRUE,
       'facet missing allowed' => TRUE,
     ),
     'list_boolean' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'map callback' => 'apachesolr_fields_list_facet_map_callback',
       'index_type' => 'boolean',
       'facets' => TRUE,
       'facet missing allowed' => TRUE,
     ),
     'number_integer' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'index_type' => 'tint',
       'facets' => TRUE,
       'query types' => array('term', 'numeric_range'),
@@ -2469,7 +2559,7 @@ function field_apachesolr_field_mappings() {
       'facet mincount allowed' => TRUE,
     ),
     'number_decimal' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'index_type' => 'tfloat',
       'facets' => TRUE,
       'query types' => array('term', 'numeric_range'),
@@ -2477,7 +2567,7 @@ function field_apachesolr_field_mappings() {
       'facet mincount allowed' => TRUE,
     ),
     'number_float' => array(
-      'indexing_callback' => 'apachesolr_fields_default_indexing_callback',
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
       'index_type' => 'tfloat',
       'facets' => TRUE,
       'query types' => array('term', 'numeric_range'),
@@ -2487,7 +2577,7 @@ function field_apachesolr_field_mappings() {
     'taxonomy_term_reference' => array(
       'map callback' => 'facetapi_map_taxonomy_terms',
       'hierarchy callback' => 'facetapi_get_taxonomy_hierarchy',
-      'indexing_callback' => 'apachesolr_term_reference_indexing_callback',
+      'indexing_callback' => array('apachesolr_term_reference_indexing_callback'),
       'index_type' => 'integer',
       'facet_block_callback' => 'apachesolr_search_taxonomy_facet_block',
       'facets' => TRUE,
@@ -2495,6 +2585,12 @@ function field_apachesolr_field_mappings() {
       'query type' => 'term',
       'facet mincount allowed' => TRUE,
     ),
+    'text' => array(
+      'indexing_callback' => array('apachesolr_fields_default_indexing_callback'),
+      'index_type' => 'string',
+      'facets' => TRUE,
+      'facet missing allowed' => TRUE,
+    ),
   );
 
   return $mappings;
@@ -2506,7 +2602,7 @@ function field_apachesolr_field_mappings() {
 function date_apachesolr_field_mappings() {
   $mappings = array();
   $default = array(
-    'indexing_callback' => 'apachesolr_date_default_indexing_callback',
+    'indexing_callback' => array('apachesolr_date_default_indexing_callback'),
     'index_type' => 'date',
     'facets' => TRUE,
     'query types' => array('date'),
@@ -2522,7 +2618,7 @@ function date_apachesolr_field_mappings() {
 
   // DATESTAMP fields need a different callback.
   $mappings['datestamp'] = $default;
-  $mappings['datestamp']['indexing_callback'] = 'apachesolr_datestamp_default_indexing_callback';
+  $mappings['datestamp']['indexing_callback'] = array('apachesolr_datestamp_default_indexing_callback');
 
   return $mappings;
 }
@@ -2547,7 +2643,10 @@ function apachesolr_get_min_date(array $facet) {
   $query->addExpression('MIN(' . $column . ')', 'min');
   $query_min = $query->execute()->fetch()->min;
   // Update to unix timestamp if this is an ISO or other format.
-  if (!is_int($query_min)) {
+  if (is_numeric($query_min)) {
+    $return = (int)$query_min;
+  }
+  else {
     $return = strtotime($query_min);
     if ($return === FALSE) {
       // Not a string that strtotime accepts (ex. '0000-00-00T00:00:00').
@@ -2579,7 +2678,10 @@ function apachesolr_get_max_date(array $facet) {
   $query->addExpression('MAX(' . $column . ')', 'max');
   $query_max = $query->execute()->fetch()->max;
   // Update to unix timestamp if this is an ISO or other format.
-  if (!is_int($query_max)) {
+  if (is_numeric($query_max)) {
+    $return = (int)$query_max;
+  }
+  else {
     $return = strtotime($query_max);
     if ($return === FALSE) {
       // Not a string that strtotime accepts (ex. '0000-00-00T00:00:00').
@@ -2597,7 +2699,7 @@ function apachesolr_get_max_date(array $facet) {
 function node_reference_apachesolr_field_mappings() {
   $mappings = array(
     'node_reference' => array(
-      'indexing_callback' => 'apachesolr_nodereference_indexing_callback',
+      'indexing_callback' => array('apachesolr_nodereference_indexing_callback'),
       'index_type' => 'integer',
       'map callback' => 'apachesolr_nodereference_map_callback',
       'facets' => TRUE,
@@ -2614,7 +2716,7 @@ function node_reference_apachesolr_field_mappings() {
 function user_reference_apachesolr_field_mappings() {
   $mappings = array(
     'user_reference' => array(
-      'indexing_callback' => 'apachesolr_userreference_indexing_callback',
+      'indexing_callback' => array('apachesolr_userreference_indexing_callback'),
       'index_type' => 'integer',
       'map callback' => 'apachesolr_userreference_map_callback',
       'facets' => TRUE,
@@ -2630,7 +2732,7 @@ function user_reference_apachesolr_field_mappings() {
 function entityreference_apachesolr_field_mappings() {
   $mappings = array(
     'entityreference' => array(
-      'indexing_callback' => 'apachesolr_entityreference_indexing_callback',
+      'indexing_callback' => array('apachesolr_entityreference_indexing_callback'),
       'map callback' => 'apachesolr_entityreference_facet_map_callback',
       'index_type' => 'string',
       'facets' => TRUE,
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr_access/apachesolr_access.info b/profiles/commons/modules/contrib/apachesolr/apachesolr_access/apachesolr_access.info
index 872f991..cb834a5 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr_access/apachesolr_access.info
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr_access/apachesolr_access.info
@@ -7,9 +7,9 @@ core = 7.x
 files[] = apachesolr_access.module
 files[] = tests/apachesolr_access.test
 
-; Information added by drupal.org packaging script on 2013-07-26
-version = "7.x-1.4"
+; Information added by  packaging script on 2013-11-17
+version = "7.x-1.6"
 core = "7.x"
 project = "apachesolr"
-datestamp = "1374808867"
+datestamp = "1384712308"
 
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.admin.inc b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.admin.inc
index be4a8f7..1a8b159 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.admin.inc
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.admin.inc
@@ -475,6 +475,12 @@ function apachesolr_search_page_settings_form_validate($form, &$form_state) {
   elseif (count(explode('%', $form_state['values']['search_path'])) > 2) {
     form_set_error('search_path', t('Only one % placeholder is allowed.'));
   }
+  // Make sure we cannot get duplicate search page paths
+  foreach (apachesolr_search_load_all_search_pages() as $search_page) {
+    if ($form_state['values']['search_path'] == $search_page['search_path'] && $form_state['values']['page_id'] != $search_page['page_id']) {
+      form_set_error('search_path', t('The search path must be unique. This path is already in use by another search page.'));
+    }
+  }
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.info b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.info
index 6067db7..31402b0 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.info
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.info
@@ -11,9 +11,9 @@ files[] = apachesolr_search.module
 files[] = apachesolr_search.admin.inc
 files[] = apachesolr_search.pages.inc
 
-; Information added by drupal.org packaging script on 2013-07-26
-version = "7.x-1.4"
+; Information added by  packaging script on 2013-11-17
+version = "7.x-1.6"
 core = "7.x"
 project = "apachesolr"
-datestamp = "1374808867"
+datestamp = "1384712308"
 
diff --git a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.module b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.module
index 3f2ba6f..63f30d7 100644
--- a/profiles/commons/modules/contrib/apachesolr/apachesolr_search.module
+++ b/profiles/commons/modules/contrib/apachesolr/apachesolr_search.module
@@ -66,10 +66,12 @@ function apachesolr_search_init() {
           try {
             if (!empty($search_page['search_path'])) {
               $solr = apachesolr_get_solr($search_page['env_id']);
+              $conditions = apachesolr_search_conditions_default($search_page);
+
               // Initializes params for empty query.
               $params = array(
                 'spellcheck' => 'false',
-                'fq' => array(),
+                'fq' => isset($conditions['fq']) ? $conditions['fq'] : array(),
                 'rows' => 1,
               );
               $context['page_id'] = $search_page_id;
@@ -1351,9 +1353,9 @@ function apachesolr_search_process_response($response, DrupalSolrQueryInterface
       );
 
       // Call entity-type-specific callbacks for extra handling.
-      $function = apachesolr_entity_get_callback($doc->entity_type, 'result callback', $bundle);
-      if (is_callable($function)) {
-        $function($doc, $result, $extra);
+      $result_callback = apachesolr_entity_get_callback($doc->entity_type, 'result callback', $bundle);
+      if (is_callable($result_callback)) {
+        $result_callback($doc, $result, $extra);
       }
 
       $result['extra'] = $extra;
@@ -1363,8 +1365,8 @@ function apachesolr_search_process_response($response, DrupalSolrQueryInterface
   }
   // Hook to allow modifications of the retrieved results
   foreach (module_implements('apachesolr_process_results') as $module) {
-    $function = $module . '_apachesolr_process_results';
-    $function($results, $query);
+    $process_results_callback = $module . '_apachesolr_process_results';
+    $process_results_callback($results, $query);
   }
   return $results;
 }
@@ -1383,14 +1385,21 @@ function apachesolr_search_get_search_suggestions($env_id) {
     // Get spellchecker suggestions into an array.
     if (!empty($response->spellcheck->suggestions)) {
       $suggestions = get_object_vars($response->spellcheck->suggestions);
+      // allow the suggestions to be altered before processing
+      drupal_alter('apachesolr_suggestions', $suggestions, $env_id);
+
       if ($suggestions) {
         $replacements = array();
         // Get the original query and retrieve all words with suggestions.
         foreach ($suggestions as $word => $value) {
-          $replacements[$word] = $value->suggestion[0];
+          $suggestion = $value->suggestion;
+          // We need to check if it's an object as setting the spellcheck.extendedResults query parameter to true makes words
+          // objects instead of strings.
+          $replacements[$word] = is_object($suggestion[0]) ? $suggestion[0]->word : $suggestion[0];
         }
         // Replace the keyword with the suggested keyword.
         $suggested_keyword = strtr($keyword, $replacements);
+
         // Show only if suggestion is different than current query.
         if ($keyword != $suggested_keyword) {
           $suggestions_output[] = $suggested_keyword;
diff --git a/profiles/commons/modules/contrib/apachesolr/drush/apachesolr.drush.inc b/profiles/commons/modules/contrib/apachesolr/drush/apachesolr.drush.inc
index 822283d..66ec66c 100644
--- a/profiles/commons/modules/contrib/apachesolr/drush/apachesolr.drush.inc
+++ b/profiles/commons/modules/contrib/apachesolr/drush/apachesolr.drush.inc
@@ -41,7 +41,7 @@ function apachesolr_drush_command() {
   );
   $items['solr-index'] = array(
     'callback' => 'apachesolr_drush_solr_index',
-    'description' => dt('Reindexes content marked for (re)indexing.'),
+    'description' => dt('Reindexes content marked for (re)indexing. You must supply the -l (--uri) parameter if $base_url is not set in settings.php.'),
     'options' => array(
       'environment-id' => 'The environment ID',
       'limit' => 'The total number of documents to index',
@@ -114,7 +114,7 @@ function apachesolr_drush_command() {
   $items['solr-variable-get'] = array(
     'description' => 'Get a list of Apache Solr environment variable names and values.',
     'arguments' => array(
-      'name' => 'A string to filter the variables by. Variables that have any part of their name matching the string will b listed.',
+      'name' => 'A string to filter the variables by. Variables that have any part of their name matching the string will be listed.',
     ),
     'examples' => array(
       'drush solr-vget' => 'List all variables and values.',
@@ -128,7 +128,7 @@ function apachesolr_drush_command() {
     'aliases' => array('solr-vget'),
   );
   $items['solr-variable-set'] = array(
-    'description' => "Set an Apache Solr environment variable.",
+    'description' => 'Set an Apache Solr environment variable.',
     'arguments' => array(
       'name' => 'The name of a variable or the first few letters of its name.',
       'value' => 'The value to assign to the variable. Use \'-\' to read the object from STDIN.',
@@ -148,7 +148,7 @@ function apachesolr_drush_command() {
     'aliases' => array('solr-vset'),
   );
   $items['solr-variable-delete'] = array(
-    'description' => "Delete an Apache Solr environment variable.",
+    'description' => 'Delete an Apache Solr environment variable.',
     'arguments' => array(
       'name' => 'The name of a variable or the first few letters of its name.',
     ),
@@ -162,7 +162,7 @@ function apachesolr_drush_command() {
     ),
     'examples' => array(
       'drush solr-vdel apachesolr_read_only --id=solr2' => 'Delete the apachesolr_read_only variable for the solr2 environment.',
-      'drush solr-vdel apa' => 'Choose from a list of variables beginning with "u" to delete.',
+      'drush solr-vdel apa' => 'Choose from a list of variables beginning with "apa" to delete.',
       'drush solr-vdel -y --exact apachesolr_read_only' => 'Delete variable, skipping confirmation.',
     ),
     'aliases' => array('solr-vdel'),
@@ -195,7 +195,7 @@ function apachesolr_drush_help($section) {
         Reindexing is done on future cron runs.");
     case 'drush:solr-index':
       return dt("Reindexes content marked for (re)indexing. If you want to reindex all content or content
-         of a specific type, use solr-reindex first to mark that content.");
+         of a specific type, use solr-mark-all first to mark that content.");
     case 'drush:solr-search':
       return dt('Executes a search against the site\'s Apache Solr search index and returns the results.');
     case 'error:APACHESOLR_ENV_ID_ERROR':
@@ -224,21 +224,25 @@ function apachesolr_drush_solr_delete_index() {
     foreach ($args as $type) {
       $parts = explode(':', $type);
       if (count($parts) === 1) {
-        apachesolr_index_delete_index($env_id, $type);
+        $success = apachesolr_index_delete_index($env_id, $type);
       }
       elseif (count($parts) == 2) {
-        apachesolr_index_delete_index($env_id, $parts[0], $parts[1]);
+        $success = apachesolr_index_delete_index($env_id, $parts[0], $parts[1]);
       }
       else {
-        drush_set_error('The syntax for each type is either entity or entity:bundle');
+        drush_set_error(dt('The syntax for each type is either entity or entity:bundle'));
       }
     }
   }
   else {
-    apachesolr_index_delete_index($env_id);
+    $success = apachesolr_index_delete_index($env_id);
+  }
+  if ($success) {
+    drush_print(dt('Deleted the Solr index'));
+  }
+  else {
+    drush_set_error(dt('An error occured while trying to delete the index.'));
   }
-
-  drush_print(t('Deleted the Solr index'));
 }
 
 /**
@@ -268,6 +272,13 @@ function apachesolr_drush_solr_mark_for_reindex() {
 function apachesolr_drush_solr_index() {
   module_load_include('inc', 'apachesolr', 'apachesolr.admin');
   module_load_include('inc', 'apachesolr', 'apachesolr.index');
+
+  $front = url(NULL, array('absolute' => TRUE));
+  if ($front == 'http://default') {
+    drush_set_error('APACHESOLR_ERROR', 'You must set the site uri via the -l (or --uri) option so that links are correctly indexed');
+    return;
+  }
+
   $env_id =  drush_get_option('environment-id');
   if (empty($env_id)) {
     $env_id = apachesolr_default_environment();
diff --git a/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/adapter.inc b/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/adapter.inc
index 87f4e3a..b554b36 100644
--- a/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/adapter.inc
+++ b/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/adapter.inc
@@ -146,6 +146,27 @@ class ApacheSolrFacetapiAdapter extends FacetapiAdapter {
    * @param array $form_state
    */
   public function settingsForm(&$form, &$form_state) {
+    if (in_array('date', $form['#facetapi']['facet']['query types']) ) {
+      $granularity = array(
+        FACETAPI_DATE_YEAR => t('Year'),
+        FACETAPI_DATE_MONTH => t('Month'),
+        FACETAPI_DATE_DAY => t('Day'),
+        FACETAPI_DATE_HOUR => t('Hour'),
+        FACETAPI_DATE_MINUTE => t('Minute'),
+      );
+
+      $facet = $form['#facetapi']['facet'];
+      $settings = $this->getFacet($facet)->getSettings()->settings;
+
+      $form['global']['date_granularity'] = array(
+        '#type' => 'select',
+        '#title' => t('Granularity'),
+        '#description' => t('Time intervals smaller than this will not be displayed in the facet.'),
+        '#options' => $granularity,
+        '#default_value' => isset($settings['date_granularity']) ? $settings['date_granularity'] : FACETAPI_DATE_MINUTE,
+      );
+    }
+
     $form['#validate'][] = 'apachesolr_facet_form_validate';
   }
 }
diff --git a/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/query_type_date.inc b/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/query_type_date.inc
index 0b72e4a..ebb26bf 100644
--- a/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/query_type_date.inc
+++ b/profiles/commons/modules/contrib/apachesolr/plugins/facetapi/query_type_date.inc
@@ -155,9 +155,13 @@ class ApacheSolrFacetapiDate extends FacetapiQueryTypeDate implements FacetapiQu
     //$start = (!empty($raw_data['start'])) ? $raw_data['start'] : '';
     $gap = (!empty($raw_data['gap'])) ? $raw_data['gap'] : '';
 
+    $settings = $this->getSettings()->settings;
+    $granularity = isset($settings['date_granularity']) ? $settings['date_granularity'] : FACETAPI_DATE_MINUTE;
+
     // We cannot list anything below a minute (range of 00 seconds till 59
-    // seconds. Milliseconds are not possible)
-    if ($gap != "+1SECOND") {
+    // seconds). Milliseconds are not possible. Also, anything below the set
+    // granularity should not be shown either.
+    if ($gap != "+1" . FACETAPI_DATE_SECOND && (!$gap || strtotime($gap, 0) >= strtotime("+1" . $granularity, 0))) {
       unset($raw_data['start']);
       unset($raw_data['end']);
       unset($raw_data['gap']);
diff --git a/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-3.x/schema.xml b/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-3.x/schema.xml
index 6953ccb..4c9b512 100644
--- a/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-3.x/schema.xml
+++ b/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-3.x/schema.xml
@@ -71,8 +71,8 @@
       so that range queries work correctly.
     -->
     <fieldType name="sint" class="solr.TrieIntField" sortMissingLast="true" omitNorms="true"/>
-    <fieldType name="slong" class="solr.TrieFloatField" sortMissingLast="true" omitNorms="true"/>
-    <fieldType name="sfloat" class="solr.TrieLongField" sortMissingLast="true" omitNorms="true"/>
+    <fieldType name="sfloat" class="solr.TrieFloatField" sortMissingLast="true" omitNorms="true"/>
+    <fieldType name="slong" class="solr.TrieLongField" sortMissingLast="true" omitNorms="true"/>
     <fieldType name="sdouble" class="solr.TrieDoubleField" sortMissingLast="true" omitNorms="true"/>
 
     <!--
diff --git a/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-4.x/schema.xml b/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-4.x/schema.xml
index 6e8e796..34961ae 100644
--- a/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-4.x/schema.xml
+++ b/profiles/commons/modules/contrib/apachesolr/solr-conf/solr-4.x/schema.xml
@@ -71,8 +71,8 @@
       so that range queries work correctly.
     -->
     <fieldType name="sint" class="solr.TrieIntField" sortMissingLast="true" omitNorms="true"/>
-    <fieldType name="slong" class="solr.TrieFloatField" sortMissingLast="true" omitNorms="true"/>
-    <fieldType name="sfloat" class="solr.TrieLongField" sortMissingLast="true" omitNorms="true"/>
+    <fieldType name="sfloat" class="solr.TrieFloatField" sortMissingLast="true" omitNorms="true"/>
+    <fieldType name="slong" class="solr.TrieLongField" sortMissingLast="true" omitNorms="true"/>
     <fieldType name="sdouble" class="solr.TrieDoubleField" sortMissingLast="true" omitNorms="true"/>
 
     <!--
diff --git a/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_base.test b/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_base.test
index f1e0955..6e23b0f 100644
--- a/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_base.test
+++ b/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_base.test
@@ -3,31 +3,31 @@
 abstract class DrupalSolrOfflineWebTestCase extends DrupalWebTestCase {
   function _nestedCompare($a1, $a2) {
     if (count($a1) != count($a2)) {
-      $extra1 = array_diff_key($a1, $a2);
-      $extra2 = array_diff_key($a2, $a1);
-      $extra = '';
-      if ($extra1) {
-        $extra .= ' Extra keys in $a1: ' . implode(', ', array_keys($extra1));
-      }
-      if ($extra2) {
-        $extra .= ' Extra keys in $a2: ' . implode(', ', array_keys($extra2));
-      }
-      debug('count($a1) != count($a2) :' . $extra);
+      //$extra1 = array_diff_key($a1, $a2);
+      //$extra2 = array_diff_key($a2, $a1);
+      //$extra = '';
+      //if ($extra1) {
+      //  $extra .= ' Extra keys in $a1: ' . implode(', ', array_keys($extra1));
+      //}
+      //if ($extra2) {
+      //  $extra .= ' Extra keys in $a2: ' . implode(', ', array_keys($extra2));
+      //}
+      //debug('count($a1) != count($a2) :' . $extra);
       return FALSE;
     }
     foreach ($a1 as $k => $v) {
       if (!isset($a2[$k])) {
-        debug("\$a2[$k] is not set");
+        //debug("\$a2[$k] is not set");
         return FALSE;
       }
       if (is_array($a1[$k]) && is_array($a2[$k])) {
         if (!$this->_nestedCompare($a1[$k], $a2[$k])) {
-          debug("_nestedCompare(\$a1[$k], \$a2[$k]) is false");
+          //debug("_nestedCompare(\$a1[$k], \$a2[$k]) is false");
           return FALSE;
         }
       }
       elseif ($a1[$k] !== $a2[$k]) {
-        debug("\$a1[$k] !== \$a2[$k] : " . var_export($a1[$k], TRUE) . " " . var_export($a2[$k], TRUE));
+        //debug("\$a1[$k] !== \$a2[$k] : " . var_export($a1[$k], TRUE) . " " . var_export($a2[$k], TRUE));
         return FALSE;
       }
     }
@@ -391,7 +391,7 @@ class DrupalSolrNodeTestCase extends DrupalWebTestCase {
 
   public static function getInfo() {
     return array(
-      'name' => 'Solr Node add, deletion, and document building tests',
+      'name' => 'Solr Node add, deletion, indexing and document building tests',
       'description' => 'Tests if we can succesfully add and delete nodes',
       'group' => 'ApacheSolr',
     );
@@ -453,14 +453,26 @@ class DrupalSolrNodeTestCase extends DrupalWebTestCase {
       // check if the entity delete does its work. It should have set the
       // status to 0 so it will be deleted when solr comes online
       $indexer_table = apachesolr_get_indexer_table('node');
-      $query = db_select($indexer_table, 'aien')
+      $nodes_in_tracking_table = db_select($indexer_table, 'aien')
         ->condition('entity_id', $node->nid)
-        ->fields('aien', array('entity_id', 'status'));
-      $db_node = $query->execute()->fetchObject();
+        ->countQuery()
+        ->execute()
+        ->fetchField();
+
+      if ($nodes_in_tracking_table > 0) {
+        $db_node = db_select($indexer_table, 'aien')
+          ->condition('entity_id', $node->nid)
+          ->fields('aien', array('entity_id', 'status'))
+          ->execute()
+          ->fetchObject();
+        $this->assertEqual($db_node->status, 0, t('Node @entity_id has status 0', array('@entity_id' => $db_node->entity_id)));
+      }
+      else {
+        // Check that all of the nodes (should only have 1) have status 0, it
+        // is set as 0 because it is pending to be deleted
+        $this->assertEqual($nodes_in_tracking_table, 0, t('No more nodes in the tracking table'));
+      }
 
-      // Check that all of the nodes (should only have 1) have status 0, it
-      // is set as 0 because it is pending to be deleted
-      $this->assertEqual($db_node->status, 0, t('Node @entity_id has status 0', array('@entity_id' => $db_node->entity_id)));
 
       // Check that all the nodes have been deleted.
       $count = db_select('node', 'n')
@@ -472,6 +484,88 @@ class DrupalSolrNodeTestCase extends DrupalWebTestCase {
     }
   }
 
+  function testApacheSolrNodeReindex() {
+    // Login as basic user to perform initial content creation.
+    // Create an admin user that can bypass revision moderation.
+    $permissions = array(
+      'access content',
+      'search content',
+      'administer nodes',
+      'administer search',
+      'access content overview',
+      'bypass node access',
+    );
+    $admin_user = $this->drupalCreateUser($permissions);
+
+    $this->drupalLogin($admin_user);
+
+    // enable our bundles to be indexed, and clear caches
+    apachesolr_index_set_bundles('solr', 'node', array('page', 'article'));
+    entity_info_cache_clear();
+    apachesolr_environments_clear_cache();
+
+    // Define types of node bundles that we want to index
+    $types = array('page', 'article');
+
+    // Create 20 nodes (10 times 2)
+    foreach ($types as $type) {
+      for ($i = 0; $i < 5; $i++) {
+        $edit = array();
+        // Create a node of the type $type.
+        $edit['uid'] = $admin_user->uid;
+        $edit['type'] = $type;
+        $edit['title'] = $this->randomName(16);
+        $node = $this->drupalCreateNode($edit);
+      }
+    }
+
+    // Set a static timestamp
+    $timestamp = 1382019301;
+
+    $env_id = apachesolr_default_environment();
+
+    // Clear the last timestamp so we know that our nodes have to be indexed.
+    apachesolr_environment_variable_set($env_id, 'apachesolr_index_last', array());
+
+    // Set apachesolr_index_entities_node.changed to the same value
+    // (REQUEST_TIME).
+    $table = apachesolr_get_indexer_table('node');
+    db_update($table)
+        ->fields(array('changed' => $timestamp, 'status' => 1))
+        ->execute();
+    // Fake that we actually indexed before
+    apachesolr_set_last_index_position($env_id, 'node', $timestamp + 1, 10);
+    
+    // Set the changed date to after our previous index cycle
+    db_update($table)
+        ->fields(array('changed' => $timestamp + 10, 'status' => 1))
+        ->condition('entity_id', 9, '<=')
+        ->execute();
+
+    // Get the next 5 entities to index.
+    $set = apachesolr_index_get_entities_to_index($env_id, 'node', 5);
+    $count = count($set);
+    $this->assertEqual($count, 5, t('We found 5 entities to index.'));
+
+    // Mark the last item from that 5 as last indexed.
+    $last_row = end($set);
+    apachesolr_set_last_index_position($env_id, 'node', $last_row->changed, $last_row->entity_id);
+
+    // Get the next batch of 5 and this should be 4 items.
+    $set = apachesolr_index_get_entities_to_index($env_id, 'node', 4);
+    $count = count($set);
+    $this->assertEqual($count, 4, t('We found 4 entities to index.'));
+
+    // Mark the last item from that 4 as last indexed.
+    $last_row = end($set);
+    apachesolr_set_last_index_position($env_id, 'node', $last_row->changed, $last_row->entity_id);
+
+    // Get the next batch of 5 and this should be 0 items
+    $set = apachesolr_index_get_entities_to_index($env_id, 'node', 5);
+    $count = count($set);
+    $this->assertEqual($count, 0, t('We found 0 entities to index.'));
+  }
+
   function testNodeToDocument() {
     // enable our bundles to be indexed, and clear caches
     apachesolr_index_set_bundles('solr', 'node', array('article'));
diff --git a/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_test/apachesolr_test.info b/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_test/apachesolr_test.info
index 7a88957..c576d5b 100644
--- a/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_test/apachesolr_test.info
+++ b/profiles/commons/modules/contrib/apachesolr/tests/apachesolr_test/apachesolr_test.info
@@ -5,9 +5,9 @@ core = 7.x
 hidden = TRUE
 dependencies[] = apachesolr
 
-; Information added by drupal.org packaging script on 2013-07-26
-version = "7.x-1.4"
+; Information added by  packaging script on 2013-11-17
+version = "7.x-1.6"
 core = "7.x"
 project = "apachesolr"
-datestamp = "1374808867"
+datestamp = "1384712308"
 
diff --git a/profiles/commons/modules/contrib/apachesolr/tests/solr_base_query.test b/profiles/commons/modules/contrib/apachesolr/tests/solr_base_query.test
index fec3521..47f588e 100644
--- a/profiles/commons/modules/contrib/apachesolr/tests/solr_base_query.test
+++ b/profiles/commons/modules/contrib/apachesolr/tests/solr_base_query.test
@@ -47,12 +47,24 @@ class SolrBaseQueryTests extends DrupalUnitTestCase {
     $fq = array('tid:3', 'sort_label:hello', 'tid:11', 'tid:1', 'tid:12', 'label:hello');
     // Setup dummy Solr object.
     $query = $this->_apachesolr_drupal_query("apachesolr_tests", array('q' => 'mykeys', 'fq' => $fq), 'sort_label asc', 'search/test');
-    // Check sortsort
+    // Check setSolrSort().
     $this->assertEqual(array('solrsort' => 'sort_label asc'), $query->getSolrsortUrlQuery());
     $query->setSolrsort('sort_name', 'desc');
     $this->assertEqual(array('solrsort' => 'sort_name desc'), $query->getSolrsortUrlQuery());
     $query->setSolrsort('score', 'desc');
     $this->assertEqual(array(), $query->getSolrsortUrlQuery());
+
+    // We cannot set a sort if the sort was not made available.
+    $query->setSolrsort('geodist()', 'asc');
+    $this->assertNotEqual(array('solrsort' => 'geodist() asc'), $query->getSolrsortUrlQuery(), t('Sort was not applied as it was not available'));
+
+    // Set the sort after it was made available.
+    $query->setAvailableSort('geodist()', array('title' => 'Distance', 'default' => 'asc'));
+    $query->setSolrsort('geodist()', 'asc');
+
+    $this->assertEqual(array('solrsort' => 'geodist() asc'), $query->getSolrsortUrlQuery());
+
+    // Check escaping of the setSolrSort functinality
     // Check getPath() functionality
     $this->assertEqual('search/test/mykeys', $query->getPath());
     $this->assertEqual('search/test/newkeys', $query->getPath('newkeys'));
diff --git a/profiles/commons/modules/contrib/apachesolr_og/LICENSE.txt b/profiles/commons/modules/contrib/apachesolr_og/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/apachesolr_og/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
index 5967951..1ce128a 100644
--- a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
+++ b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
@@ -7,9 +7,9 @@ dependencies[] = apachesolr
 dependencies[] = og
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.0+2-dev"
 core = "7.x"
 project = "apachesolr_og"
-datestamp = "1382042573"
+datestamp = "1387568923"
 
diff --git a/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info b/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
index 221b904..20ea65c 100644
--- a/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
+++ b/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
@@ -6,8 +6,8 @@ package = Search Toolkit
 core = 7.x
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = ""
 project = "apachesolr_user"
-datestamp = "1382042547"
+datestamp = "1387568923"
 
diff --git a/profiles/commons/modules/contrib/ckeditor/PATCHES.txt b/profiles/commons/modules/contrib/ckeditor/PATCHES.txt
deleted file mode 100644
index 8f4bb35..0000000
--- a/profiles/commons/modules/contrib/ckeditor/PATCHES.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-The following patches have been applied to this project:
-- http://drupal.org/files/ckeditor-install-lib-1898294-2.patch
-
-This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/ctools/LICENSE.txt b/profiles/commons/modules/contrib/ctools/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/ctools/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info b/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
index 685340e..b9ca129 100644
--- a/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
+++ b/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 package = Chaos tool suite
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools.info b/profiles/commons/modules/contrib/ctools/ctools.info
index 1f49622..4348cbe 100644
--- a/profiles/commons/modules/contrib/ctools/ctools.info
+++ b/profiles/commons/modules/contrib/ctools/ctools.info
@@ -7,9 +7,9 @@ files[] = includes/math-expr.inc
 files[] = includes/stylizer.inc
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info b/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
index c527a2a..60085c2 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
@@ -5,9 +5,9 @@ package = Chaos tool suite
 dependencies[] = ctools
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info b/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
index 7240c10..8789a21 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 core = 7.x
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info b/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
index 9eec1f8..6fb8216 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
@@ -5,9 +5,9 @@ package = Chaos tool suite
 dependencies[] = ctools
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info b/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
index 1990a66..006aa35 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
@@ -8,9 +8,9 @@ dependencies[] = advanced_help
 core = 7.x
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info b/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
index 12d38a4..d82ffcf 100644
--- a/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
+++ b/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 package = Chaos tool suite
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info b/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
index 02461b9..19dd7ae 100644
--- a/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
+++ b/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
@@ -6,9 +6,9 @@ dependencies[] = ctools
 dependencies[] = color
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info b/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
index 2f69c39..7e5bc55 100644
--- a/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
+++ b/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
@@ -8,9 +8,9 @@ hidden = TRUE
 files[] = ctools_export.test
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info b/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
index 64a9d06..c20ee27 100644
--- a/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
+++ b/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
@@ -12,9 +12,9 @@ files[] = math_expression_stack.test
 hidden = TRUE
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/ctools/views_content/views_content.info b/profiles/commons/modules/contrib/ctools/views_content/views_content.info
index 8a556d5..17750e7 100644
--- a/profiles/commons/modules/contrib/ctools/views_content/views_content.info
+++ b/profiles/commons/modules/contrib/ctools/views_content/views_content.info
@@ -10,9 +10,9 @@ files[] = plugins/views/views_content_plugin_display_panel_pane.inc
 files[] = plugins/views/views_content_plugin_style_ctools_context.inc
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1382042546"
+datestamp = "1387568944"
 
diff --git a/profiles/commons/modules/contrib/custom_search/LICENSE.txt b/profiles/commons/modules/contrib/custom_search/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/custom_search/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/custom_search/custom_search.info b/profiles/commons/modules/contrib/custom_search/custom_search.info
index 107b9a6..37cc02f 100644
--- a/profiles/commons/modules/contrib/custom_search/custom_search.info
+++ b/profiles/commons/modules/contrib/custom_search/custom_search.info
@@ -7,9 +7,9 @@ dependencies[] = search
 
 configure = admin/config/search/custom_search
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1382042553"
+datestamp = "1387568932"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
index 58a3980..e630217 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
@@ -8,9 +8,9 @@ dependencies[] = custom_search
 
 configure = admin/config/search/custom_search/blocks
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1382042553"
+datestamp = "1387568932"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
index 2cbd26d..ffc4e11 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
@@ -6,9 +6,9 @@ package = Search
 dependencies[] = custom_search
 dependencies[] = i18n_string
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1382042553"
+datestamp = "1387568932"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
index 1bd5ef3..886d24d 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
@@ -8,9 +8,9 @@ dependencies[] = taxonomy
 
 configure = admin/config/search/custom_search/taxonomy
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1382042553"
+datestamp = "1387568932"
 
diff --git a/profiles/commons/modules/contrib/devel/LICENSE.txt b/profiles/commons/modules/contrib/devel/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/devel/devel.info b/profiles/commons/modules/contrib/devel/devel.info
index 62a1d42..952aeb3 100644
--- a/profiles/commons/modules/contrib/devel/devel.info
+++ b/profiles/commons/modules/contrib/devel/devel.info
@@ -7,9 +7,9 @@ tags[] = developer
 files[] = devel.test
 files[] = devel.mail.inc
 
-; Information added by drupal.org packaging script on 2013-09-30
-version = "7.x-1.3+54-dev"
+; Information added by Drupal.org packaging script on 2013-12-12
+version = "7.x-1.3+59-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1380569319"
+datestamp = "1386892405"
 
diff --git a/profiles/commons/modules/contrib/devel/devel.js b/profiles/commons/modules/contrib/devel/devel.js
index bbf4942..c23cc94 100644
--- a/profiles/commons/modules/contrib/devel/devel.js
+++ b/profiles/commons/modules/contrib/devel/devel.js
@@ -2,11 +2,11 @@
 
 // Explain link in query log
 Drupal.behaviors.devel_explain = {
-  attach: function() {
+  attach: function(context, settings) {
     $('a.dev-explain').click(function () {
       qid = $(this).attr("qid");
       cell = $('#devel-query-' + qid);
-      $('.dev-explain', cell).load(Drupal.settings.basePath + '?q=devel/explain/' + Drupal.settings.devel.request_id + '/' + qid).show();
+      $('.dev-explain', cell).load(settings.basePath + '?q=devel/explain/' + settings.devel.request_id + '/' + qid).show();
       $('.dev-placeholders', cell).hide();
       $('.dev-arguments', cell).hide();
       return false;
@@ -16,11 +16,11 @@ Drupal.behaviors.devel_explain = {
 
 // Arguments link in query log
 Drupal.behaviors.devel_arguments = {
-  attach: function() {
+  attach: function(context, settings) {
     $('a.dev-arguments').click(function () {
       qid = $(this).attr("qid");
       cell = $('#devel-query-' + qid);
-      $('.dev-arguments', cell).load(Drupal.settings.basePath + '?q=devel/arguments/' + Drupal.settings.devel.request_id + '/' + qid).show();
+      $('.dev-arguments', cell).load(settings.basePath + '?q=devel/arguments/' + settings.devel.request_id + '/' + qid).show();
       $('.dev-placeholders', cell).hide();
       $('.dev-explain', cell).hide();
       return false;
@@ -30,7 +30,7 @@ Drupal.behaviors.devel_arguments = {
 
 // Placeholders link in query log
 Drupal.behaviors.devel_placeholders = {
-  attach: function() {
+  attach: function(context, settings) {
     $('a.dev-placeholders').click(function () {
       qid = $(this).attr("qid");
       cell = $('#devel-query-' + qid);
diff --git a/profiles/commons/modules/contrib/devel/devel.module b/profiles/commons/modules/contrib/devel/devel.module
index 98575df..e0f67ea 100644
--- a/profiles/commons/modules/contrib/devel/devel.module
+++ b/profiles/commons/modules/contrib/devel/devel.module
@@ -1774,7 +1774,7 @@ function dd($data, $label = NULL) {
 /**
  * Logs a variable to a drupal_debug.txt in the site's temp directory.
  *
- * @param string $data
+ * @param mixed $data
  *   The variable to log to the drupal_debug.txt log file.
  * @param string $label
  *   (optional) If set, a label to output before $data in the log file.
diff --git a/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info b/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
index 7ef3ad8..7634757 100644
--- a/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
+++ b/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
@@ -6,9 +6,9 @@ tags[] = developer
 configure = admin/config/development/generate
 files[] = devel_generate.test
 
-; Information added by drupal.org packaging script on 2013-09-30
-version = "7.x-1.3+54-dev"
+; Information added by Drupal.org packaging script on 2013-12-12
+version = "7.x-1.3+59-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1380569319"
+datestamp = "1386892405"
 
diff --git a/profiles/commons/modules/contrib/devel/devel_krumo_path.js b/profiles/commons/modules/contrib/devel/devel_krumo_path.js
index cb17cff..d4a578d 100644
--- a/profiles/commons/modules/contrib/devel/devel_krumo_path.js
+++ b/profiles/commons/modules/contrib/devel/devel_krumo_path.js
@@ -7,7 +7,7 @@ Drupal.behaviors.devel = {
   attach: function (context, settings) {
 
     // Add hint to footnote
-    $('.krumo-footnote .krumo-call').once().before('<img style="vertical-align: middle;" title="Click to expand. Double-click to show path." src="' + Drupal.settings.basePath + 'misc/help.png"/>');
+    $('.krumo-footnote .krumo-call').once().before('<img style="vertical-align: middle;" title="Click to expand. Double-click to show path." src="' + settings.basePath + 'misc/help.png"/>');
 
     var krumo_name = [];
     var krumo_type = [];
diff --git a/profiles/commons/modules/contrib/devel/devel_node_access.info b/profiles/commons/modules/contrib/devel/devel_node_access.info
index 4cf9db0..05970dc 100644
--- a/profiles/commons/modules/contrib/devel/devel_node_access.info
+++ b/profiles/commons/modules/contrib/devel/devel_node_access.info
@@ -6,9 +6,9 @@ core = 7.x
 configure = admin/config/development/devel
 tags[] = developer
 
-; Information added by drupal.org packaging script on 2013-09-30
-version = "7.x-1.3+54-dev"
+; Information added by Drupal.org packaging script on 2013-12-12
+version = "7.x-1.3+59-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1380569319"
+datestamp = "1386892405"
 
diff --git a/profiles/commons/modules/contrib/devel/devel_node_access.js b/profiles/commons/modules/contrib/devel/devel_node_access.js
index 60f782c..b790942 100644
--- a/profiles/commons/modules/contrib/devel/devel_node_access.js
+++ b/profiles/commons/modules/contrib/devel/devel_node_access.js
@@ -7,7 +7,7 @@
   /**
    * Perform the access by user ajax request.
    */
-  function devel_node_access_user_ajax(context) {
+  function devel_node_access_user_ajax(context, settings) {
     // Get the cell ID for the first .dna-permission that isn't processed.
     var cell = $('td.dna-permission', context)
                .not('.ajax-processed', context)
@@ -15,7 +15,7 @@
     if (cell !== undefined) {
       // Generate the URI from the basePath, path, data type, cell ID, and a
       // random token to bypass caching.
-      var url = Drupal.settings.basePath
+      var url = settings.basePath
               + "?q="
               + 'devel/node_access/by_user/json/'
               + cell
@@ -25,7 +25,7 @@
       $.getJSON(url, function(data) {
         $('#' + cell, context).html(data).addClass('ajax-processed');
         // Call this function again.
-        devel_node_access_user_ajax(context);
+        devel_node_access_user_ajax(context, settings);
       });
       // Ajax fails silently on error, mark bad requests with an error message.
       // If the request is just slow this will update when the request succeeds.
@@ -42,7 +42,7 @@
               )
               .addClass('ajax-processed');
             // Call this function again.
-            devel_node_access_user_ajax(context);
+            devel_node_access_user_ajax(context, settings);
           }
         },
         3000
@@ -55,10 +55,10 @@
    * Attach the access by user behavior which initiates ajax.
    */
   Drupal.behaviors.develNodeAccessUserAjax = {
-    attach: function(context) {
+    attach: function(context, settings) {
       // Start the ajax.
-      devel_node_access_user_ajax(context);
+      devel_node_access_user_ajax(context, settings);
     }
   };
 
-})(jQuery);
\ No newline at end of file
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/devel/devel_node_access.module b/profiles/commons/modules/contrib/devel/devel_node_access.module
index 0eb5fe0..74e927e 100644
--- a/profiles/commons/modules/contrib/devel/devel_node_access.module
+++ b/profiles/commons/modules/contrib/devel/devel_node_access.module
@@ -1005,7 +1005,12 @@ function devel_node_access_block_view($delta) {
       if (isset($node)) {
         $nid = $node->nid;
         $node_type = node_type_get_type($node);
-        $headers = array(t('username'), '<span title="' . t("Create nodes of the '@Node_type' type.", array('@Node_type' => $node_type->name)) . '">' . t('create') . '</span>', t('view'), t('update'), t('delete'));
+        $variables = array('@Node_type' => ($node_type ? $node_type->name : $node->type));
+        $create_header = '<span title="' . t("Create nodes of the '@Node_type' type.", $variables) . '">' . t('create') . '</span>';
+        if (!$node_type) {
+          $create_header .= '<br /><span class="error">' . t("(missing type: '@Node_type')", $variables) . '</span>';
+        }
+        $headers = array(t('username'), $create_header, t('view'), t('update'), t('delete'));
         $rows = array();
         // Determine whether to use Ajax or prepopulate the tables.
         if ($ajax = variable_get('devel_node_access_user_ajax', FALSE)) {
diff --git a/profiles/commons/modules/contrib/devel/krumo/class.krumo.php b/profiles/commons/modules/contrib/devel/krumo/class.krumo.php
index 70da0b9..fde9e4c 100755
--- a/profiles/commons/modules/contrib/devel/krumo/class.krumo.php
+++ b/profiles/commons/modules/contrib/devel/krumo/class.krumo.php
@@ -604,7 +604,9 @@ This is a list of all the values from the <code><b><?php echo realpath($ini_file
     $_recursion_marker = krumo::_marker();
     if ($hive =& krumo::_hive($dummy)) {
       foreach($hive as $i=>$bee){
-        if (is_object($bee)) {
+        // skip closures set as properties
+        $closure_prototype = function(){};
+        if (is_object($bee) && !($bee instanceof $closure_prototype)) {
           unset($hive[$i]->$_recursion_marker);
           // DEVEL: changed 'else' to 'elseif' below
           } elseif (is_array($bee)) {
diff --git a/profiles/commons/modules/contrib/elements/LICENSE.txt b/profiles/commons/modules/contrib/elements/LICENSE.txt
new file mode 100644
index 0000000..d159169
--- /dev/null
+++ b/profiles/commons/modules/contrib/elements/LICENSE.txt
@@ -0,0 +1,339 @@
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/elements/README.txt b/profiles/commons/modules/contrib/elements/README.txt
new file mode 100644
index 0000000..6ac97ec
--- /dev/null
+++ b/profiles/commons/modules/contrib/elements/README.txt
@@ -0,0 +1,14 @@
+Description
+===========
+Elements intends to become a library that provides complex form elements for developers to use in their modules.
+
+
+Elements provided
+=================
+
+1. emailfield
+2. searchfield
+3. telfield
+4. urlfield
+5. numberfield
+6. rangefield
diff --git a/profiles/commons/modules/contrib/elements/elements.info b/profiles/commons/modules/contrib/elements/elements.info
new file mode 100644
index 0000000..2a73b0c
--- /dev/null
+++ b/profiles/commons/modules/contrib/elements/elements.info
@@ -0,0 +1,12 @@
+name = Elements
+description = Provides a library of Form API elements.
+core = 7.x
+files[] = elements.module
+files[] = elements.theme.inc
+
+; Information added by drupal.org packaging script on 2013-06-08
+version = "7.x-1.4"
+core = "7.x"
+project = "elements"
+datestamp = "1370667652"
+
diff --git a/profiles/commons/modules/contrib/elements/elements.module b/profiles/commons/modules/contrib/elements/elements.module
new file mode 100644
index 0000000..37afef3
--- /dev/null
+++ b/profiles/commons/modules/contrib/elements/elements.module
@@ -0,0 +1,596 @@
+<?php
+
+/**
+ * Implements hook_element_info().
+ */
+function elements_element_info() {
+  $types['emailfield'] = array(
+    '#input' => TRUE,
+    '#size' => 60,
+    '#maxlength' => 128,
+    '#autocomplete_path' => FALSE,
+    '#process' => array('ajax_process_form', 'elements_process_pattern'),
+    '#element_validate' => array('elements_validate_email'),
+    '#theme' => 'emailfield',
+    '#theme_wrappers' => array('form_element'),
+  );
+  $types['searchfield'] = array(
+    '#input' => TRUE,
+    '#size' => 60,
+    '#maxlength' => 128,
+    '#autocomplete_path' => FALSE,
+    '#process' => array('ajax_process_form'),
+    '#theme' => 'searchfield',
+    '#theme_wrappers' => array('form_element'),
+  );
+  $types['telfield'] = array(
+    '#input' => TRUE,
+    '#size' => 20,
+    '#maxlength' => 64,
+    '#process' => array('ajax_process_form', 'elements_process_pattern'),
+    '#theme' => 'telfield',
+    '#theme_wrappers' => array('form_element'),
+  );
+  $types['urlfield'] = array(
+    '#input' => TRUE,
+    '#size' => 80,
+    '#maxlength' => 128,
+    '#autocomplete_path' => FALSE,
+    '#process' => array('ajax_process_form', 'elements_process_pattern'),
+    '#element_validate' => array('elements_validate_url'),
+    '#theme' => 'urlfield',
+    '#theme_wrappers' => array('form_element'),
+  );
+  $types['numberfield'] = array(
+    '#input' => TRUE,
+    '#step' => 1,
+    '#process' => array('ajax_process_form'),
+    '#element_validate' => array('elements_validate_number'),
+    '#theme' => 'numberfield',
+    '#theme_wrappers' => array('form_element'),
+  );
+  $types['rangefield'] = array(
+    '#input' => TRUE,
+    '#step' => 1,
+    '#min' => 0,
+    '#max' => 100,
+    '#process' => array('ajax_process_form'),
+    '#element_validate' => array('elements_validate_number'),
+    '#theme' => 'rangefield',
+    '#theme_wrappers' => array('form_element'),
+  );
+
+  // Backported table element from https://drupal.org/node/80855
+  $types['table'] = array(
+    '#header' => array(),
+    '#rows' => array(),
+    '#empty' => '',
+    // Properties for tableselect support.
+    '#input' => TRUE,
+    '#tree' => TRUE,
+    '#tableselect' => FALSE,
+    '#multiple' => TRUE,
+    '#js_select' => TRUE,
+    '#value_callback' => 'elements_table_value',
+    '#process' => array('elements_table_process'),
+    '#element_validate' => array('elements_table_validate'),
+    // Properties for tabledrag support.
+    // The value is a list of arrays that are passed to drupal_add_tabledrag().
+    // elements_pre_render_table() prepends the HTML ID of the table to each set
+    // of arguments.
+    // @see drupal_add_tabledrag()
+    '#tabledrag' => array(),
+    // Render properties.
+    '#pre_render' => array('elements_pre_render_table'),
+    '#theme' => 'table',
+  );
+
+  return $types;
+}
+
+/**
+ * Implements hook_element_info_alter().
+ */
+function elements_element_info_alter(&$types) {
+  // Add placeholder and pattern support to core form elements.
+  foreach (array_keys($types) as $type) {
+    switch ($type) {
+      case 'textfield':
+      case 'textarea':
+      case 'password':
+        $types[$type]['#process'][] = 'elements_process_placeholder';
+        $types[$type]['#process'][] = 'elements_process_pattern';
+        break;
+    }
+  }
+}
+
+/**
+ * Implements hook_theme().
+ */
+function elements_theme() {
+  return array(
+    'emailfield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+    'searchfield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+    'telfield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+    'urlfield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+    'numberfield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+    'rangefield' => array(
+      'arguments' => array('element' => NULL),
+      'render element' => 'element',
+      'file' => 'elements.theme.inc',
+    ),
+  );
+}
+
+/**
+ * Return the autocompletion HTML for a form element.
+ *
+ * @param $element
+ *   The renderable element to process for autocompletion.
+ *
+ * @return
+ *   The rendered autocompletion element HTML, or an empty string if the field
+ *   has no autocompletion enabled.
+ */
+function elements_add_autocomplete(&$element) {
+  $extra = '';
+
+  if (!empty($element['#autocomplete_path']) && drupal_valid_path($element['#autocomplete_path'])) {
+    drupal_add_library('system', 'drupal.autocomplete');
+    $element['#attributes']['class'][] = 'form-autocomplete';
+
+    $attributes = array();
+    $attributes['type'] = 'hidden';
+    $attributes['id'] = $element['#attributes']['id'] . '-autocomplete';
+    $attributes['value'] = url($element['#autocomplete_path'], array('absolute' => TRUE));
+    $attributes['disabled'] = 'disabled';
+    $attributes['class'][] = 'autocomplete';
+    $extra = '<input' . drupal_attributes($attributes) . ' />';
+  }
+
+  return $extra;
+}
+
+/**
+ * #process callback for #placeholder form element property.
+ *
+ * @param $element
+ *   An associative array containing the properties and children of the
+ *   generic input element.
+ *
+ * @return
+ *   The processed element.
+ */
+function elements_process_placeholder($element) {
+  if (isset($element['#placeholder']) && !isset($element['#attributes']['placeholder'])) {
+    $element['#attributes']['placeholder'] = $element['#placeholder'];
+  }
+
+  return $element;
+}
+
+/**
+ * #process callback for #pattern form element property.
+ *
+ * @param $element
+ *   An associative array containing the properties and children of the
+ *   generic input element.
+ *
+ * @return
+ *   The processed element.
+ *
+ * @see elements_validate_pattern()
+ */
+function elements_process_pattern($element) {
+  if (isset($element['#pattern']) && !isset($element['#attributes']['pattern'])) {
+    $element['#attributes']['pattern'] = $element['#pattern'];
+    $element['#element_validate'][] = 'form_validate_pattern';
+  }
+
+  return $element;
+}
+
+/**
+ * #element_validate callback for #pattern form element property.
+ *
+ * @param $element
+ *   An associative array containing the properties and children of the
+ *   generic form element.
+ * @param $form_state
+ *   The $form_state array for the form this element belongs to.
+ *
+ * @see element_process_pattern()
+ */
+function elements_validate_pattern($element, &$form_state) {
+  if ($element['#value'] !== '') {
+    // The pattern must match the entire string and should have the same
+    // behavior as the RegExp object in ECMA 262.
+    // - Use bracket-style delimiters to avoid introducing a special delimiter
+    //   character like '/' that would have to be escaped.
+    // - Put in brackets so that the pattern can't interfere with what's
+    //   prepended and appended.
+    $pattern = '{^(?:' . $element['#pattern'] . ')$}';
+
+    if (!preg_match($pattern, $element['#value'])) {
+      form_error($element, t('%name field is not in the right format.', array('%name' => $element['#title'])));
+    }
+  }
+}
+
+/**
+ * Form element validation handler for #type 'email'.
+ *
+ * Note that #maxlength and #required is validated by _form_validate() already.
+ */
+function elements_validate_email(&$element, &$form_state) {
+  if ($element['#value'] && !valid_email_address($element['#value'])) {
+    form_error($element, t('The e-mail address %mail is not valid.', array('%mail' => $element['#value'])));
+  }
+}
+
+/**
+ * Form element validation handler for #type 'url'.
+ *
+ * Note that #maxlength and #required is validated by _form_validate() already.
+ */
+function elements_validate_url(&$element, &$form_state) {
+  if ($element['#value'] && !valid_url($element['#value'], TRUE)) {
+    form_error($element, t('The URL %url is not valid.', array('%url' => $element['#value'])));
+  }
+}
+
+/**
+ * Form element validation handler for #type 'number'.
+ *
+ * Note that #required is validated by _form_validate() already.
+ */
+function elements_validate_number(&$element, &$form_state) {
+  $value = $element['#value'];
+  if ($value === '') {
+    return;
+  }
+
+  $name = empty($element['#title']) ? $element['#parents'][0] : $element['#title'];
+
+  // Ensure the input is numeric.
+  if (!is_numeric($value)) {
+    form_error($element, t('%name must be a number.', array('%name' => $name)));
+    return;
+  }
+
+  // Ensure that the input is greater than the #min property, if set.
+  if (isset($element['#min']) && $value < $element['#min']) {
+    form_error($element, t('%name must be higher or equal to %min.', array('%name' => $name, '%min' => $element['#min'])));
+  }
+
+  // Ensure that the input is less than the #max property, if set.
+  if (isset($element['#max']) && $value > $element['#max']) {
+    form_error($element, t('%name must be below or equal to %max.', array('%name' => $name, '%max' => $element['#max'])));
+  }
+
+  if (isset($element['#step']) && strtolower($element['#step']) != 'any') {
+    // Check that the input is an allowed multiple of #step (offset by #min if
+    // #min is set).
+    $offset = isset($element['#min']) ? $element['#min'] : 0.0;
+
+    if (!elements_valid_number_step($value, $element['#step'], $offset)) {
+      form_error($element, t('%name is not a valid number.', array('%name' => $name)));
+    }
+  }
+}
+
+/**
+ * Verifies that a number is a multiple of a given step.
+ *
+ * The implementation assumes it is dealing with IEEE 754 double precision
+ * floating point numbers that are used by PHP on most systems.
+ *
+ * This is based on the number/range verification methods of webkit.
+ *
+ * @param $value
+ *   The value that needs to be checked.
+ * @param $step
+ *   The step scale factor. Must be positive.
+ * @param $offset
+ *   (optional) An offset, to which the difference must be a multiple of the
+ *   given step.
+ *
+ * @return bool
+ *   TRUE if no step mismatch has occured, or FALSE otherwise.
+ *
+ * @see http://opensource.apple.com/source/WebCore/WebCore-1298/html/NumberInputType.cpp
+ */
+function elements_valid_number_step($value, $step, $offset = 0.0) {
+  $double_value = (double) abs($value - $offset);
+
+  // The fractional part of a double has 53 bits. The greatest number that could
+  // be represented with that is 2^53. If the given value is even bigger than
+  // $step * 2^53, then dividing by $step will result in a very small remainder.
+  // Since that remainder can't even be represented with a single precision
+  // float the following computation of the remainder makes no sense and we can
+  // safely ignore it instead.
+  if ($double_value / pow(2.0, 53) > $step) {
+    return TRUE;
+  }
+
+  // Now compute that remainder of a division by $step.
+  $remainder = (double) abs($double_value - $step * round($double_value / $step));
+
+  // $remainder is a double precision floating point number. Remainders that
+  // can't be represented with single precision floats are acceptable. The
+  // fractional part of a float has 24 bits. That means remainders smaller than
+  // $step * 2^-24 are acceptable.
+  $computed_acceptable_error = (double) ($step / pow(2.0, 24));
+
+  return $computed_acceptable_error >= $remainder || $remainder >= ($step - $computed_acceptable_error);
+}
+
+/**
+ * Determines the value of a table form element.
+ *
+ * @param array $element
+ *   The form element whose value is being populated.
+ * @param array|false $input
+ *   The incoming input to populate the form element. If this is FALSE,
+ *   the element's default value should be returned.
+ *
+ * @return array
+ *   The data that will appear in the $form_state['values'] collection
+ *   for this element. Return nothing to use the default.
+ */
+function elements_table_value(array $element, $input = FALSE) {
+  // If #multiple is FALSE, the regular default value of radio buttons is used.
+  if (!empty($element['#tableselect']) && !empty($element['#multiple'])) {
+    // Contrary to #type 'checkboxes', the default value of checkboxes in a
+    // table is built from the array keys (instead of array values) of the
+    // #default_value property.
+    // @todo D8: Remove this inconsistency.
+    if ($input === FALSE) {
+      $element += array('#default_value' => array());
+      return drupal_map_assoc(array_keys(array_filter($element['#default_value'])));
+    }
+    else {
+      return is_array($input) ? drupal_map_assoc($input) : array();
+    }
+  }
+}
+
+/**
+ * Creates checkbox or radio elements to populate a tableselect table.
+ *
+ * @param $element
+ *   An associative array containing the properties and children of the
+ *   tableselect element.
+ *
+ * @return
+ *   The processed element.
+ */
+function elements_table_process($element, &$form_state) {
+  if ($element['#tableselect']) {
+    if ($element['#multiple']) {
+      $value = is_array($element['#value']) ? $element['#value'] : array();
+    }
+    // Advanced selection behaviour makes no sense for radios.
+    else {
+      $element['#js_select'] = FALSE;
+    }
+    // Add a "Select all" checkbox column to the header.
+    // @todo D8: Rename into #select_all?
+    if ($element['#js_select']) {
+      $element['#attached']['js'][] = 'misc/tableselect.js';
+      array_unshift($element['#header'], array('class' => array('select-all')));
+    }
+    // Add an empty header column for radio buttons or when a "Select all"
+    // checkbox is not desired.
+    else {
+      array_unshift($element['#header'], '');
+    }
+
+    if (!isset($element['#default_value']) || $element['#default_value'] === 0) {
+      $element['#default_value'] = array();
+    }
+    // Create a checkbox or radio for each row in a way that the value of the
+    // tableselect element behaves as if it had been of #type checkboxes or
+    // radios.
+    foreach (element_children($element) as $key) {
+      // Do not overwrite manually created children.
+      if (!isset($element[$key]['select'])) {
+        // Determine option label; either an assumed 'title' column, or the
+        // first available column containing a #title or #markup.
+        // @todo Consider to add an optional $element[$key]['#title_key']
+        //   defaulting to 'title'?
+        $title = '';
+        if (!empty($element[$key]['title']['#title'])) {
+          $title = $element[$key]['title']['#title'];
+        }
+        else {
+          foreach (element_children($element[$key]) as $column) {
+            if (isset($element[$key][$column]['#title'])) {
+              $title = $element[$key][$column]['#title'];
+              break;
+            }
+            if (isset($element[$key][$column]['#markup'])) {
+              $title = $element[$key][$column]['#markup'];
+              break;
+            }
+          }
+        }
+        if ($title !== '') {
+          $title = t('Update !title', array('!title' => $title));
+        }
+
+        // Prepend the select column to existing columns.
+        $element[$key] = array('select' => array()) + $element[$key];
+        $element[$key]['select'] += array(
+          '#type' => $element['#multiple'] ? 'checkbox' : 'radio',
+          '#title' => $title,
+          '#title_display' => 'invisible',
+
+          // @todo If rows happen to use numeric indexes instead of string keys,
+          //   this results in a first row with $key === 0, which is always FALSE.
+          '#return_value' => $key,
+          '#attributes' => $element['#attributes'],
+        );
+        $element_parents = array_merge($element['#parents'], array($key));
+        if ($element['#multiple']) {
+          $element[$key]['select']['#default_value'] = isset($value[$key]) ? $key : NULL;
+          $element[$key]['select']['#parents'] = $element_parents;
+        }
+        else {
+          $element[$key]['select']['#default_value'] = ($element['#default_value'] == $key ? $key : NULL);
+          $element[$key]['select']['#parents'] = $element['#parents'];
+          $element[$key]['select']['#id'] = drupal_html_id('edit-' . implode('-', $element_parents));
+        }
+      }
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * #element_validate callback for #type 'table'.
+ *
+ * @param array $element
+ *   An associative array containing the properties and children of the
+ *   table element.
+ * @param array $form_state
+ *   The current state of the form.
+ */
+function elements_table_validate($element, &$form_state) {
+  // Skip this validation if the button to submit the form does not require
+  // selected table row data.
+  if (empty($form_state['triggering_element']['#tableselect'])) {
+    return;
+  }
+  if ($element['#multiple']) {
+    if (!is_array($element['#value']) || !count(array_filter($element['#value']))) {
+      form_error($element, t('No items selected.'));
+    }
+  }
+  elseif (!isset($element['#value']) || $element['#value'] === '') {
+    form_error($element, t('No item selected.'));
+  }
+}
+
+/**
+ * #pre_render callback to transform children of an element into #rows suitable for theme_table().
+ *
+ * This function converts sub-elements of an element of #type 'table' to be
+ * suitable for theme_table():
+ * - The first level of sub-elements are table rows. Only the #attributes
+ *   property is taken into account.
+ * - The second level of sub-elements is converted into columns for the
+ *   corresponding first-level table row.
+ *
+ * Simple example usage:
+ * @code
+ * $form['table'] = array(
+ *   '#type' => 'table',
+ *   '#header' => array(t('Title'), array('data' => t('Operations'), 'colspan' => '1')),
+ *   // Optionally, to add tableDrag support:
+ *   '#tabledrag' => array(
+ *     array('order', 'sibling', 'thing-weight'),
+ *   ),
+ * );
+ * foreach ($things as $row => $thing) {
+ *   $form['table'][$row]['#weight'] = $thing['weight'];
+ *
+ *   $form['table'][$row]['title'] = array(
+ *     '#type' => 'textfield',
+ *     '#default_value' => $thing['title'],
+ *   );
+ *
+ *   // Optionally, to add tableDrag support:
+ *   $form['table'][$row]['#attributes']['class'][] = 'draggable';
+ *   $form['table'][$row]['weight'] = array(
+ *     '#type' => 'textfield',
+ *     '#title' => t('Weight for @title', array('@title' => $thing['title'])),
+ *     '#title_display' => 'invisible',
+ *     '#size' => 4,
+ *     '#default_value' => $thing['weight'],
+ *     '#attributes' => array('class' => array('thing-weight')),
+ *   );
+ *
+ *   // The amount of link columns should be identical to the 'colspan'
+ *   // attribute in #header above.
+ *   $form['table'][$row]['edit'] = array(
+ *     '#type' => 'link',
+ *     '#title' => t('Edit'),
+ *     '#href' => 'thing/' . $row . '/edit',
+ *   );
+ * }
+ * @endcode
+ *
+ * @param array $element
+ *   A structured array containing two sub-levels of elements. Properties used:
+ *   - #tabledrag: The value is a list of arrays that are passed to
+ *     drupal_add_tabledrag(). The HTML ID of the table is prepended to each set
+ *     of arguments.
+ *
+ * @see elements_element_info()
+ * @see theme_table()
+ * @see drupal_process_attached()
+ * @see drupal_add_tabledrag()
+ */
+function elements_pre_render_table(array $element) {
+  foreach (element_children($element) as $first) {
+    $row = array('data' => array());
+    // Apply attributes of first-level elements as table row attributes.
+    if (isset($element[$first]['#attributes'])) {
+      $row += $element[$first]['#attributes'];
+    }
+    // Turn second-level elements into table row columns.
+    // @todo Do not render a cell for children of #type 'value'.
+    // @see http://drupal.org/node/1248940
+    foreach (element_children($element[$first]) as $second) {
+      // Assign the element by reference, so any potential changes to the
+      // original element are taken over.
+      $column = array('data' => &$element[$first][$second]);
+
+      // Apply wrapper attributes of second-level elements as table cell
+      // attributes.
+      //if (isset($element[$first][$second]['#wrapper_attributes'])) {
+      //  $column += $element[$first][$second]['#wrapper_attributes'];
+      //}
+
+      $row['data'][] = $column;
+    }
+    $element['#rows'][] = $row;
+  }
+
+  // Take over $element['#id'] as HTML ID attribute, if not already set.
+  element_set_attributes($element, array('id'));
+
+  // If the custom #tabledrag is set and there is a HTML ID, inject the table's
+  // HTML ID as first callback argument and attach the behavior.
+  if (!empty($element['#tabledrag']) && isset($element['#attributes']['id'])) {
+    foreach ($element['#tabledrag'] as &$args) {
+      array_unshift($args, $element['#attributes']['id']);
+    }
+    $element['#attached']['drupal_add_tabledrag'] = $element['#tabledrag'];
+  }
+
+  return $element;
+}
diff --git a/profiles/commons/modules/contrib/elements/elements.theme.inc b/profiles/commons/modules/contrib/elements/elements.theme.inc
new file mode 100644
index 0000000..fb45aee
--- /dev/null
+++ b/profiles/commons/modules/contrib/elements/elements.theme.inc
@@ -0,0 +1,144 @@
+<?php
+
+/**
+ * @file
+ * The theme include file for the elements module.
+ *
+ * Contains the theme functions for all the elements module elements.
+ */
+
+/**
+ * Returns HTML for an emailfield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #size, #maxlength,
+ *     #placeholder, #required, #attributes, #autocomplete_path.
+ *
+ * @ingroup themeable
+ */
+function theme_emailfield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'email';
+  element_set_attributes($element, array('id', 'name', 'value', 'size', 'maxlength', 'placeholder'));
+  _form_set_class($element, array('form-text', 'form-email'));
+
+  $extra = elements_add_autocomplete($element);
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output . $extra;
+}
+
+/**
+ * Returns HTML for a searchfield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #size, #maxlength,
+ *     #placeholder, #required, #attributes, #autocomplete_path.
+ *
+ * @ingroup themeable
+ */
+function theme_searchfield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'search';
+  element_set_attributes($element, array('id', 'name', 'value', 'size', 'maxlength', 'placeholder'));
+  _form_set_class($element, array('form-text', 'form-search'));
+
+  $extra = elements_add_autocomplete($element);
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output . $extra;
+}
+
+/**
+ * Returns HTML for a telfield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #size, #maxlength,
+ *     #placeholder, #required, #attributes.
+ *
+ * @ingroup themeable
+ */
+function theme_telfield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'tel';
+  element_set_attributes($element, array('id', 'name', 'value', 'size', 'maxlength', 'placeholder'));
+  _form_set_class($element, array('form-text', 'form-tel'));
+
+  $extra = elements_add_autocomplete($element);
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output . $extra;
+}
+
+/**
+ * Returns HTML for an urlfield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #size, #maxlength,
+ *     #placeholder, #required, #attributes, #autocomplete_path.
+ *
+ * @ingroup themeable
+ */
+function theme_urlfield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'url';
+  element_set_attributes($element, array('id', 'name', 'value', 'size', 'maxlength', 'placeholder'));
+  _form_set_class($element, array('form-text', 'form-url'));
+
+  $extra = elements_add_autocomplete($element);
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output . $extra;
+}
+
+/**
+ * Returns HTML for a numberfield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #min, #max, #placeholder,
+ *     #required, #attributes, #step.
+ *
+ * @ingroup themeable
+ */
+function theme_numberfield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'number';
+  element_set_attributes($element, array('id', 'name', 'value', 'step', 'min', 'max', 'placeholder'));
+  _form_set_class($element, array('form-text', 'form-number'));
+
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output;
+}
+
+/**
+ * Returns HTML for a rangefield form element.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - element: An associative array containing the properties of the element.
+ *     Properties used: #title, #value, #description, #min, #max, #attributes,
+ *     #step.
+ *
+ * @ingroup themeable
+ */
+function theme_rangefield($variables) {
+  $element = $variables['element'];
+  $element['#attributes']['type'] = 'range';
+  element_set_attributes($element, array('id', 'name', 'value', 'step', 'min', 'max'));
+  _form_set_class($element, array('form-text', 'form-range'));
+
+  $output = '<input' . drupal_attributes($element['#attributes']) . ' />';
+
+  return $output;
+}
diff --git a/profiles/commons/modules/contrib/entity/PATCHES.txt b/profiles/commons/modules/contrib/entity/PATCHES.txt
deleted file mode 100644
index bf42cb1..0000000
--- a/profiles/commons/modules/contrib/entity/PATCHES.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-The following patches have been applied to this project:
-- http://drupal.org/files/entity-translatable_fields_not_overriding_und_with_empty_values.patch
-
-This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/entity/entity.tpl.php b/profiles/commons/modules/contrib/entity/entity.tpl.php
deleted file mode 100644
index cfe94dd..0000000
--- a/profiles/commons/modules/contrib/entity/entity.tpl.php
+++ /dev/null
@@ -1,48 +0,0 @@
-<?php
-
-/**
- * @file
- * Default theme implementation for entities.
- *
- * Available variables:
- * - $content: An array of comment items. Use render($content) to print them all, or
- *   print a subset such as render($content['field_example']). Use
- *   hide($content['field_example']) to temporarily suppress the printing of a
- *   given element.
- * - $title: The (sanitized) entity label.
- * - $url: Direct url of the current entity if specified.
- * - $page: Flag for the full page state.
- * - $classes: String of classes that can be used to style contextually through
- *   CSS. It can be manipulated through the variable $classes_array from
- *   preprocess functions. By default the following classes are available, where
- *   the parts enclosed by {} are replaced by the appropriate values:
- *   - entity-{ENTITY_TYPE}
- *   - {ENTITY_TYPE}-{BUNDLE}
- *
- * Other variables:
- * - $classes_array: Array of html class attribute values. It is flattened
- *   into a string within the variable $classes.
- *
- * @see template_preprocess()
- * @see template_preprocess_entity()
- * @see template_process()
- */
-?>
-<div class="<?php print $classes; ?> clearfix"<?php print $attributes; ?>>
-
-  <?php if (!$page): ?>
-    <h2<?php print $title_attributes; ?>>
-      <?php if ($url): ?>
-        <a href="<?php print $url; ?>"><?php print $title; ?></a>
-      <?php else: ?>
-        <?php print $title; ?>
-      <?php endif; ?>
-    </h2>
-  <?php endif; ?>
-
-  <div class="content"<?php print $content_attributes; ?>>
-    <?php
-      print render($content);
-    ?>
-  </div>
-</div>
diff --git a/profiles/commons/modules/contrib/entitycache/LICENSE.txt b/profiles/commons/modules/contrib/entitycache/LICENSE.txt
index 2c095c8..d159169 100644
--- a/profiles/commons/modules/contrib/entitycache/LICENSE.txt
+++ b/profiles/commons/modules/contrib/entitycache/LICENSE.txt
@@ -1,274 +1,339 @@
-GNU GENERAL PUBLIC LICENSE
-
-              Version 2, June 1991
-
-Copyright (C) 1989, 1991 Free Software Foundation, Inc. 675 Mass Ave,
-Cambridge, MA 02139, USA. Everyone is permitted to copy and distribute
-verbatim copies of this license document, but changing it is not allowed.
-
-                  Preamble
-
-The licenses for most software are designed to take away your freedom to
-share and change it. By contrast, the GNU General Public License is
-intended to guarantee your freedom to share and change free software--to
-make sure the software is free for all its users. This General Public License
-applies to most of the Free Software Foundation's software and to any other
-program whose authors commit to using it. (Some other Free Software
-Foundation software is covered by the GNU Library General Public License
-instead.) You can apply it to your programs, too.
-
-When we speak of free software, we are referring to freedom, not price. Our
-General Public Licenses are designed to make sure that you have the
-freedom to distribute copies of free software (and charge for this service if
-you wish), that you receive source code or can get it if you want it, that you
-can change the software or use pieces of it in new free programs; and that
-you know you can do these things.
-
-To protect your rights, we need to make restrictions that forbid anyone to
-deny you these rights or to ask you to surrender the rights. These restrictions
-translate to certain responsibilities for you if you distribute copies of the
-software, or if you modify it.
-
-For example, if you distribute copies of such a program, whether gratis or for
-a fee, you must give the recipients all the rights that you have. You must make
-sure that they, too, receive or can get the source code. And you must show
-them these terms so they know their rights.
-
-We protect your rights with two steps: (1) copyright the software, and (2)
-offer you this license which gives you legal permission to copy, distribute
-and/or modify the software.
-
-Also, for each author's protection and ours, we want to make certain that
-everyone understands that there is no warranty for this free software. If the
-software is modified by someone else and passed on, we want its recipients
-to know that what they have is not the original, so that any problems
-introduced by others will not reflect on the original authors' reputations.
-
-Finally, any free program is threatened constantly by software patents. We
-wish to avoid the danger that redistributors of a free program will individually
-obtain patent licenses, in effect making the program proprietary. To prevent
-this, we have made it clear that any patent must be licensed for everyone's
-free use or not licensed at all.
-
-The precise terms and conditions for copying, distribution and modification
-follow.
-
-           GNU GENERAL PUBLIC LICENSE
- TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND
-               MODIFICATION
-
-0. This License applies to any program or other work which contains a notice
-placed by the copyright holder saying it may be distributed under the terms
-of this General Public License. The "Program", below, refers to any such
-program or work, and a "work based on the Program" means either the
-Program or any derivative work under copyright law: that is to say, a work
-containing the Program or a portion of it, either verbatim or with
-modifications and/or translated into another language. (Hereinafter, translation
-is included without limitation in the term "modification".) Each licensee is
-addressed as "you".
-
-Activities other than copying, distribution and modification are not covered
-by this License; they are outside its scope. The act of running the Program is
-not restricted, and the output from the Program is covered only if its contents
-constitute a work based on the Program (independent of having been made
-by running the Program). Whether that is true depends on what the Program
-does.
-
-1. You may copy and distribute verbatim copies of the Program's source
-code as you receive it, in any medium, provided that you conspicuously and
-appropriately publish on each copy an appropriate copyright notice and
-disclaimer of warranty; keep intact all the notices that refer to this License
-and to the absence of any warranty; and give any other recipients of the
-Program a copy of this License along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and you
-may at your option offer warranty protection in exchange for a fee.
-
-2. You may modify your copy or copies of the Program or any portion of it,
-thus forming a work based on the Program, and copy and distribute such
-modifications or work under the terms of Section 1 above, provided that you
-also meet all of these conditions:
-
-a) You must cause the modified files to carry prominent notices stating that
-you changed the files and the date of any change.
-
-b) You must cause any work that you distribute or publish, that in whole or in
-part contains or is derived from the Program or any part thereof, to be
-licensed as a whole at no charge to all third parties under the terms of this
-License.
-
-c) If the modified program normally reads commands interactively when run,
-you must cause it, when started running for such interactive use in the most
-ordinary way, to print or display an announcement including an appropriate
-copyright notice and a notice that there is no warranty (or else, saying that
-you provide a warranty) and that users may redistribute the program under
-these conditions, and telling the user how to view a copy of this License.
-(Exception: if the Program itself is interactive but does not normally print such
-an announcement, your work based on the Program is not required to print
-an announcement.)
-
-These requirements apply to the modified work as a whole. If identifiable
-sections of that work are not derived from the Program, and can be
-reasonably considered independent and separate works in themselves, then
-this License, and its terms, do not apply to those sections when you distribute
-them as separate works. But when you distribute the same sections as part
-of a whole which is a work based on the Program, the distribution of the
-whole must be on the terms of this License, whose permissions for other
-licensees extend to the entire whole, and thus to each and every part
-regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest your rights to
-work written entirely by you; rather, the intent is to exercise the right to
-control the distribution of derivative or collective works based on the
-Program.
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
 
 In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of a
-storage or distribution medium does not bring the other work under the scope
-of this License.
-
-3. You may copy and distribute the Program (or a work based on it, under
-Section 2) in object code or executable form under the terms of Sections 1
-and 2 above provided that you also do one of the following:
-
-a) Accompany it with the complete corresponding machine-readable source
-code, which must be distributed under the terms of Sections 1 and 2 above
-on a medium customarily used for software interchange; or,
-
-b) Accompany it with a written offer, valid for at least three years, to give
-any third party, for a charge no more than your cost of physically performing
-source distribution, a complete machine-readable copy of the corresponding
-source code, to be distributed under the terms of Sections 1 and 2 above on
-a medium customarily used for software interchange; or,
-
-c) Accompany it with the information you received as to the offer to distribute
-corresponding source code. (This alternative is allowed only for
-noncommercial distribution and only if you received the program in object
-code or executable form with such an offer, in accord with Subsection b
-above.)
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
 
 The source code for a work means the preferred form of the work for
-making modifications to it. For an executable work, complete source code
-means all the source code for all modules it contains, plus any associated
-interface definition files, plus the scripts used to control compilation and
-installation of the executable. However, as a special exception, the source
-code distributed need not include anything that is normally distributed (in
-either source or binary form) with the major components (compiler, kernel,
-and so on) of the operating system on which the executable runs, unless that
-component itself accompanies the executable.
-
-If distribution of executable or object code is made by offering access to
-copy from a designated place, then offering equivalent access to copy the
-source code from the same place counts as distribution of the source code,
-even though third parties are not compelled to copy the source along with the
-object code.
-
-4. You may not copy, modify, sublicense, or distribute the Program except as
-expressly provided under this License. Any attempt otherwise to copy,
-modify, sublicense or distribute the Program is void, and will automatically
-terminate your rights under this License. However, parties who have received
-copies, or rights, from you under this License will not have their licenses
-terminated so long as such parties remain in full compliance.
-
-5. You are not required to accept this License, since you have not signed it.
-However, nothing else grants you permission to modify or distribute the
-Program or its derivative works. These actions are prohibited by law if you
-do not accept this License. Therefore, by modifying or distributing the
-Program (or any work based on the Program), you indicate your acceptance
-of this License to do so, and all its terms and conditions for copying,
-distributing or modifying the Program or works based on it.
-
-6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the original
-licensor to copy, distribute or modify the Program subject to these terms and
-conditions. You may not impose any further restrictions on the recipients'
-exercise of the rights granted herein. You are not responsible for enforcing
-compliance by third parties to this License.
-
-7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues), conditions
-are imposed on you (whether by court order, agreement or otherwise) that
-contradict the conditions of this License, they do not excuse you from the
-conditions of this License. If you cannot distribute so as to satisfy
-simultaneously your obligations under this License and any other pertinent
-obligations, then as a consequence you may not distribute the Program at all.
-For example, if a patent license would not permit royalty-free redistribution
-of the Program by all those who receive copies directly or indirectly through
-you, then the only way you could satisfy both it and this License would be to
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
 refrain entirely from distribution of the Program.
 
-If any portion of this section is held invalid or unenforceable under any
-particular circumstance, the balance of the section is intended to apply and
-the section as a whole is intended to apply in other circumstances.
-
-It is not the purpose of this section to induce you to infringe any patents or
-other property right claims or to contest validity of any such claims; this
-section has the sole purpose of protecting the integrity of the free software
-distribution system, which is implemented by public license practices. Many
-people have made generous contributions to the wide range of software
-distributed through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing to
-distribute software through any other system and a licensee cannot impose
-that choice.
-
-This section is intended to make thoroughly clear what is believed to be a
-consequence of the rest of this License.
-
-8. If the distribution and/or use of the Program is restricted in certain
-countries either by patents or by copyrighted interfaces, the original copyright
-holder who places the Program under this License may add an explicit
-geographical distribution limitation excluding those countries, so that
-distribution is permitted only in or among countries not thus excluded. In such
-case, this License incorporates the limitation as if written in the body of this
-License.
-
-9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time. Such new versions will be
-similar in spirit to the present version, but may differ in detail to address new
-problems or concerns.
-
-Each version is given a distinguishing version number. If the Program specifies
-a version number of this License which applies to it and "any later version",
-you have the option of following the terms and conditions either of that
-version or of any later version published by the Free Software Foundation. If
-the Program does not specify a version number of this License, you may
-choose any version ever published by the Free Software Foundation.
-
-10. If you wish to incorporate parts of the Program into other free programs
-whose distribution conditions are different, write to the author to ask for
-permission. For software which is copyrighted by the Free Software
-Foundation, write to the Free Software Foundation; we sometimes make
-exceptions for this. Our decision will be guided by the two goals of
-preserving the free status of all derivatives of our free software and of
-promoting the sharing and reuse of software generally.
-
-               NO WARRANTY
-
-11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE,
-THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT
-PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE
-STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
-OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT
-WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED,
-INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
-OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
-PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND
-PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL
-NECESSARY SERVICING, REPAIR OR CORRECTION.
-
-12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR
-AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR
-ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE
-LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL,
-SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
-ARISING OUT OF THE USE OR INABILITY TO USE THE
-PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA
-OR DATA BEING RENDERED INACCURATE OR LOSSES
-SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE
-PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS), EVEN
-IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF
-THE POSSIBILITY OF SUCH DAMAGES.
-
-          END OF TERMS AND CONDITIONS
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/entitycache/entitycache.info b/profiles/commons/modules/contrib/entitycache/entitycache.info
index 9c2756f..b879b0c 100644
--- a/profiles/commons/modules/contrib/entitycache/entitycache.info
+++ b/profiles/commons/modules/contrib/entitycache/entitycache.info
@@ -9,10 +9,9 @@ files[] = entitycache.comment.inc
 files[] = entitycache.taxonomy.inc
 files[] = entitycache.test
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.1+6-dev"
+; Information added by drupal.org packaging script on 2013-10-31
+version = "7.x-1.2"
 core = "7.x"
 project = "entitycache"
-datestamp = "1382042542"
+datestamp = "1383216926"
 
diff --git a/profiles/commons/modules/contrib/entityreference/LICENSE.txt b/profiles/commons/modules/contrib/entityreference/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/entityreference/entityreference.info b/profiles/commons/modules/contrib/entityreference/entityreference.info
index cf7263a..d6348ef 100644
--- a/profiles/commons/modules/contrib/entityreference/entityreference.info
+++ b/profiles/commons/modules/contrib/entityreference/entityreference.info
@@ -23,10 +23,9 @@ files[] = tests/entityreference.taxonomy.test
 files[] = tests/entityreference.admin.test
 files[] = tests/entityreference.feeds.test
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0+5-dev"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-1.1"
 core = "7.x"
 project = "entityreference"
-datestamp = "1382042543"
+datestamp = "1384973110"
 
diff --git a/profiles/commons/modules/contrib/entityreference/entityreference.module b/profiles/commons/modules/contrib/entityreference/entityreference.module
index 08f5c86..bdcb562 100644
--- a/profiles/commons/modules/contrib/entityreference/entityreference.module
+++ b/profiles/commons/modules/contrib/entityreference/entityreference.module
@@ -980,6 +980,18 @@ function entityreference_autocomplete_access_callback($type, $field_name, $entit
  *   The label of the entity to query by.
  */
 function entityreference_autocomplete_callback($type, $field_name, $entity_type, $bundle_name, $entity_id = '', $string = '') {
+  // If the request has a '/' in the search text, then the menu system will have
+  // split it into multiple arguments and $string will only be a partial. We want
+  //  to make sure we recover the intended $string.
+  $args = func_get_args();
+  // Shift off the $type, $field_name, $entity_type, $bundle_name, and $entity_id args.
+  array_shift($args);
+  array_shift($args);
+  array_shift($args);
+  array_shift($args);
+  array_shift($args);
+  $string = implode('/', $args);
+
   $field = field_info_field($field_name);
   $instance = field_info_instance($entity_type, $field_name, $bundle_name);
 
@@ -1012,7 +1024,9 @@ function entityreference_autocomplete_callback_get_matches($type, $field, $insta
   $entity = NULL;
   if ($entity_id !== 'NULL') {
     $entity = entity_load_single($entity_type, $entity_id);
-    if (!$entity || !entity_access('view', $entity_type, $entity)) {
+    $has_view_access = (entity_access('view', $entity_type, $entity) !== FALSE);
+    $has_update_access = (entity_access('update', $entity_type, $entity) !== FALSE);
+    if (!$entity || !($has_view_access || $has_update_access)) {
       return MENU_ACCESS_DENIED;
     }
   }
@@ -1078,7 +1092,7 @@ function entityreference_field_formatter_info() {
       'description' => t('Display the referenced entities rendered by entity_view().'),
       'field types' => array('entityreference'),
       'settings' => array(
-        'view_mode' => '',
+        'view_mode' => 'default',
         'links' => TRUE,
       ),
     ),
@@ -1102,21 +1116,20 @@ function entityreference_field_formatter_settings_form($field, $instance, $view_
 
   if ($display['type'] == 'entityreference_entity_view') {
     $entity_info = entity_get_info($field['settings']['target_type']);
-    $options = array();
+    $options = array('default' => t('Default'));
     if (!empty($entity_info['view modes'])) {
       foreach ($entity_info['view modes'] as $view_mode => $view_mode_settings) {
         $options[$view_mode] = $view_mode_settings['label'];
       }
     }
 
-    if (count($options) > 1) {
-      $element['view_mode'] = array(
-        '#type' => 'select',
-        '#options' => $options,
-        '#title' => t('View mode'),
-        '#default_value' => $settings['view_mode'],
-      );
-    }
+    $element['view_mode'] = array(
+      '#type' => 'select',
+      '#options' => $options,
+      '#title' => t('View mode'),
+      '#default_value' => $settings['view_mode'],
+      '#access' => count($options) > 1,
+    );
 
     $element['links'] = array(
       '#type' => 'checkbox',
@@ -1143,7 +1156,11 @@ function entityreference_field_formatter_settings_summary($field, $instance, $vi
 
   if ($display['type'] == 'entityreference_entity_view') {
     $entity_info = entity_get_info($field['settings']['target_type']);
-    $summary[] = t('Rendered as @mode', array('@mode' => isset($entity_info['view modes'][$settings['view_mode']]['label']) ? $entity_info['view modes'][$settings['view_mode']]['label'] : $settings['view_mode']));
+    $view_mode_label = $settings['view_mode'] == 'default' ? t('Default') : $settings['view_mode'];
+    if (isset($entity_info['view modes'][$settings['view_mode']]['label'])) {
+      $view_mode_label = $entity_info['view modes'][$settings['view_mode']]['label'];
+    }
+    $summary[] = t('Rendered as @mode', array('@mode' => $view_mode_label));
     $summary[] = !empty($settings['links']) ? t('Display links') : t('Do not display links');
   }
 
@@ -1182,7 +1199,9 @@ function entityreference_field_formatter_prepare_view($entity_type, $entities, $
         // Replace the instance value with the term data.
         $items[$id][$delta]['entity'] = $target_entities[$item['target_id']];
         // Check whether the user has access to the referenced entity.
-        $items[$id][$delta]['access'] = entity_access('view', $field['settings']['target_type'], $target_entities[$item['target_id']]);
+        $has_view_access = (entity_access('view', $field['settings']['target_type'], $target_entities[$item['target_id']]) !== FALSE);
+        $has_update_access = (entity_access('update', $field['settings']['target_type'], $target_entities[$item['target_id']]) !== FALSE);
+        $items[$id][$delta]['access'] = ($has_view_access || $has_update_access);
       }
       // Otherwise, unset the instance value, since the entity does not exist.
       else {
diff --git a/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info b/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
index 9a15a19..88ad7b5 100644
--- a/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
+++ b/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
@@ -4,10 +4,9 @@ core = 7.x
 package = Fields
 dependencies[] = entityreference
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0+5-dev"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-1.1"
 core = "7.x"
 project = "entityreference"
-datestamp = "1382042543"
+datestamp = "1384973110"
 
diff --git a/profiles/commons/modules/contrib/entityreference/plugins/selection/EntityReference_SelectionHandler_Generic.class.php b/profiles/commons/modules/contrib/entityreference/plugins/selection/EntityReference_SelectionHandler_Generic.class.php
index 2d1c5d7..444a74c 100644
--- a/profiles/commons/modules/contrib/entityreference/plugins/selection/EntityReference_SelectionHandler_Generic.class.php
+++ b/profiles/commons/modules/contrib/entityreference/plugins/selection/EntityReference_SelectionHandler_Generic.class.php
@@ -304,7 +304,8 @@ class EntityReference_SelectionHandler_Generic implements EntityReference_Select
    * Implements EntityReferenceHandler::getLabel().
    */
   public function getLabel($entity) {
-    return entity_label($this->field['settings']['target_type'], $entity);
+    $target_type = $this->field['settings']['target_type'];
+    return entity_access('view', $target_type, $entity) ? entity_label($target_type, $entity) : t('- Restricted access -');
   }
 
   /**
@@ -340,7 +341,7 @@ class EntityReference_SelectionHandler_Generic implements EntityReference_Select
     $entity_info = entity_get_info($target_type);
     $id = $entity_info['entity keys']['id'];
     // Return the alias of the table.
-    return $query->innerJoin($target_type, NULL, "$target_type.$id = $alias.entity_id");
+    return $query->innerJoin($target_type, NULL, "%alias.$id = $alias.entity_id");
   }
 }
 
@@ -540,7 +541,7 @@ class EntityReference_SelectionHandler_Generic_taxonomy_term extends EntityRefer
 
     foreach ($bundles as $bundle) {
       if ($vocabulary = taxonomy_vocabulary_machine_name_load($bundle)) {
-        if ($terms = taxonomy_get_tree($vocabulary->vid, 0)) {
+        if ($terms = taxonomy_get_tree($vocabulary->vid, 0, NULL, TRUE)) {
           foreach ($terms as $term) {
             $options[$vocabulary->machine_name][$term->tid] = str_repeat('-', $term->depth) . check_plain($term->name);
           }
diff --git a/profiles/commons/modules/contrib/entityreference/tests/entityreference.handlers.test b/profiles/commons/modules/contrib/entityreference/tests/entityreference.handlers.test
index 03bc54f..b88e106 100644
--- a/profiles/commons/modules/contrib/entityreference/tests/entityreference.handlers.test
+++ b/profiles/commons/modules/contrib/entityreference/tests/entityreference.handlers.test
@@ -84,6 +84,14 @@ class EntityReferenceHandlersTestCase extends DrupalWebTestCase {
         'title' => 'Node unpublished (<&>)',
         'uid' => 1,
       ),
+      // Title purposefully starts with same characters as published1 and
+      // published2 above but contains a slash.
+      'published_withslash' => (object) array(
+        'type' => 'article',
+        'status' => 1,
+        'title' => 'Node pub/lished1',
+        'uid' => 1,
+      ),
     );
 
     $node_labels = array();
@@ -104,6 +112,7 @@ class EntityReferenceHandlersTestCase extends DrupalWebTestCase {
           'article' => array(
             $nodes['published1']->nid => $node_labels['published1'],
             $nodes['published2']->nid => $node_labels['published2'],
+            $nodes['published_withslash']->nid => $node_labels['published_withslash'],
           ),
         ),
       ),
@@ -141,6 +150,18 @@ class EntityReferenceHandlersTestCase extends DrupalWebTestCase {
         ),
         'result' => array(),
       ),
+      // Searching for "Node pub/" should return only the published_withslash node
+      // and not published1 and published2 from above.
+      array(
+        'arguments' => array(
+          array('Node pub/', 'CONTAINS'),
+        ),
+        'result' => array(
+          'article' => array(
+            $nodes['published_withslash']->nid => $node_labels['published_withslash'],
+          ),
+        ),
+      ),
     );
     $this->assertReferencable($field, $referencable_tests, 'Node handler');
 
@@ -156,6 +177,7 @@ class EntityReferenceHandlersTestCase extends DrupalWebTestCase {
           'article' => array(
             $nodes['published1']->nid => $node_labels['published1'],
             $nodes['published2']->nid => $node_labels['published2'],
+            $nodes['published_withslash']->nid => $node_labels['published_withslash'],
             $nodes['unpublished']->nid => $node_labels['unpublished'],
           ),
         ),
@@ -234,7 +256,7 @@ class EntityReferenceHandlersTestCase extends DrupalWebTestCase {
         ),
         'result' => array(
           'user' => array(
-            $users['admin']->uid => $user_labels['admin'],
+            $users['admin']->uid => '- Restricted access -',
             $users['non_admin']->uid => $user_labels['non_admin'],
           ),
         ),
diff --git a/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info b/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
index 11f605e..311ae3f 100644
--- a/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
+++ b/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
@@ -8,10 +8,9 @@ dependencies[] = feeds
 dependencies[] = feeds_ui
 dependencies[] = entityreference
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0+5-dev"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-1.1"
 core = "7.x"
 project = "entityreference"
-datestamp = "1382042543"
+datestamp = "1384973110"
 
diff --git a/profiles/commons/modules/contrib/entityreference/views/entityreference.views.inc b/profiles/commons/modules/contrib/entityreference/views/entityreference.views.inc
index df38395..baa7034 100644
--- a/profiles/commons/modules/contrib/entityreference/views/entityreference.views.inc
+++ b/profiles/commons/modules/contrib/entityreference/views/entityreference.views.inc
@@ -80,6 +80,17 @@ function entityreference_field_views_data_views_data_alter(&$data, $field) {
         'group' => t('Entity Reference'),
         'title' => t('Referencing entity'),
         'help' => t('A bridge to the @entity entity that is referencing @target_entity via !field_name', $replacements),
+        'join_extra' => array(
+          0 => array(
+            'field' => 'entity_type',
+            'value' => $entity_type,
+          ),
+          1 => array(
+            'field' => 'deleted',
+            'value' => 0,
+            'numeric' => TRUE,
+          ),
+        ),
       );
     }
   }
diff --git a/profiles/commons/modules/contrib/entityreference/views/entityreference_plugin_style.inc b/profiles/commons/modules/contrib/entityreference/views/entityreference_plugin_style.inc
index 76c2e81..fadaa9e 100644
--- a/profiles/commons/modules/contrib/entityreference/views/entityreference_plugin_style.inc
+++ b/profiles/commons/modules/contrib/entityreference/views/entityreference_plugin_style.inc
@@ -45,19 +45,17 @@ class entityreference_plugin_style extends views_plugin_style {
 
     // Group the rows according to the grouping field, if specified.
     $sets = $this->render_grouping($this->view->result, $this->options['grouping']);
-
     // Grab the alias of the 'id' field added by entityreference_plugin_display.
     $id_field_alias = $this->display->handler->id_field_alias;
 
     // @todo We don't display grouping info for now. Could be useful for select
     // widget, though.
     $results = array();
-    $this->view->row_index = 0;
     foreach ($sets as $records) {
-      foreach ($records as $values) {
+      foreach ($records as $index => $values) {
+        $this->view->row_index = $index;
         // Sanitize html, remove line breaks and extra whitespace.
         $results[$values->{$id_field_alias}] = filter_xss_admin(preg_replace('/\s\s+/', ' ', str_replace("\n", '', $this->row_plugin->render($values))));
-        $this->view->row_index++;
       }
     }
     unset($this->view->row_index);
diff --git a/profiles/commons/modules/contrib/features/PATCHES.txt b/profiles/commons/modules/contrib/features/PATCHES.txt
deleted file mode 100644
index c1425f4..0000000
--- a/profiles/commons/modules/contrib/features/PATCHES.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-The following patches have been applied to this project:
-- http://drupal.org/files/menu_links_customized-927576-8.patch
-
-This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/features/features.export.inc b/profiles/commons/modules/contrib/features/features.export.inc
index 2ca460d..2f32c95 100644
--- a/profiles/commons/modules/contrib/features/features.export.inc
+++ b/profiles/commons/modules/contrib/features/features.export.inc
@@ -583,7 +583,16 @@ function features_var_export($var, $prefix = '', $init = TRUE, $count = 0) {
     $output = intval($var);
   }
   else if (is_numeric($var)) {
-    $output = floatval($var);
+    $floatval = floatval($var);
+    if (is_string($var) && ((string) $floatval !== $var)) {
+      // Do not convert a string to a number if the string
+      // representation of that number is not identical to the
+      // original value.
+      $output = var_export($var, TRUE);
+    }
+    else {
+      $output = $floatval;
+    }
   }
   else if (is_string($var) && strpos($var, "\n") !== FALSE) {
     // Replace line breaks in strings with a token for replacement
diff --git a/profiles/commons/modules/contrib/features/features.info b/profiles/commons/modules/contrib/features/features.info
index c1e7787..b76c92b 100644
--- a/profiles/commons/modules/contrib/features/features.info
+++ b/profiles/commons/modules/contrib/features/features.info
@@ -6,9 +6,9 @@ files[] = tests/features.test
 
 configure = admin/structure/features/settings
 
-; Information added by drupal.org packaging script on 2013-10-07
-version = "7.x-2.0-rc5"
+; Information added by drupal.org packaging script on 2013-10-17
+version = "7.x-2.0"
 core = "7.x"
 project = "features"
-datestamp = "1381157302"
+datestamp = "1382018758"
 
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.features.field.inc b/profiles/commons/modules/contrib/features/tests/features_test.features.field.inc
deleted file mode 100644
index 6b18fa9..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.features.field.inc
+++ /dev/null
@@ -1,104 +0,0 @@
-<?php
-/**
- * @file
- * features_test.features.field.inc
- */
-
-/**
- * Implements hook_field_default_fields().
- */
-function features_test_field_default_fields() {
-  $fields = array();
-
-  // Exported field: 'node-features_test-field_features_test'
-  $fields['node-features_test-field_features_test'] = array(
-    'field_config' => array(
-      'active' => '1',
-      'cardinality' => '1',
-      'deleted' => '0',
-      'entity_types' => array(),
-      'field_name' => 'field_features_test',
-      'foreign keys' => array(
-        'format' => array(
-          'columns' => array(
-            'format' => 'format',
-          ),
-          'table' => 'filter_format',
-        ),
-      ),
-      'indexes' => array(
-        'format' => array(
-          0 => 'format',
-        ),
-      ),
-      'module' => 'text',
-      'settings' => array(
-        'max_length' => '255',
-      ),
-      'translatable' => '1',
-      'type' => 'text',
-    ),
-    'field_instance' => array(
-      'bundle' => 'features_test',
-      'default_value' => NULL,
-      'deleted' => '0',
-      'description' => '',
-      'display' => array(
-        'default' => array(
-          'label' => 'above',
-          'module' => 'text',
-          'settings' => array(),
-          'type' => 'text_default',
-          'weight' => 0,
-        ),
-        'full' => array(
-          'label' => 'above',
-          'settings' => array(),
-          'type' => 'hidden',
-          'weight' => 0,
-        ),
-        'print' => array(
-          'label' => 'above',
-          'settings' => array(),
-          'type' => 'hidden',
-          'weight' => 0,
-        ),
-        'rss' => array(
-          'label' => 'above',
-          'settings' => array(),
-          'type' => 'hidden',
-          'weight' => 0,
-        ),
-        'teaser' => array(
-          'label' => 'above',
-          'settings' => array(),
-          'type' => 'hidden',
-          'weight' => 0,
-        ),
-      ),
-      'entity_type' => 'node',
-      'field_name' => 'field_features_test',
-      'label' => 'Test',
-      'required' => 0,
-      'settings' => array(
-        'text_processing' => '0',
-        'user_register_form' => FALSE,
-      ),
-      'widget' => array(
-        'active' => 1,
-        'module' => 'text',
-        'settings' => array(
-          'size' => '60',
-        ),
-        'type' => 'text_textfield',
-        'weight' => '-4',
-      ),
-    ),
-  );
-
-  // Translatables
-  // Included for use with string extractors like potx.
-  t('Test');
-
-  return $fields;
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.features.filter.inc b/profiles/commons/modules/contrib/features/tests/features_test.features.filter.inc
deleted file mode 100644
index 6a1db21..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.features.filter.inc
+++ /dev/null
@@ -1,56 +0,0 @@
-<?php
-/**
- * @file
- * features_test.features.filter.inc
- */
-
-/**
- * Implements hook_filter_default_formats().
- */
-function features_test_filter_default_formats() {
-  $formats = array();
-
-  // Exported format: features_test
-  $formats['features_test'] = array(
-    'format' => 'features_test',
-    'name' => 'features_test',
-    'cache' => '1',
-    'status' => '1',
-    'weight' => '0',
-    'filters' => array(
-      'filter_autop' => array(
-        'weight' => '10',
-        'status' => '1',
-        'settings' => array(),
-      ),
-      'filter_html' => array(
-        'weight' => '10',
-        'status' => '1',
-        'settings' => array(
-          'allowed_html' => '<a> <em> <strong> <cite> <blockquote> <code> <ul> <ol> <li> <dl> <dt> <dd>',
-          'filter_html_help' => 1,
-          'filter_html_nofollow' => 0,
-        ),
-      ),
-      'filter_htmlcorrector' => array(
-        'weight' => '10',
-        'status' => '1',
-        'settings' => array(),
-      ),
-      'filter_html_escape' => array(
-        'weight' => '10',
-        'status' => '1',
-        'settings' => array(),
-      ),
-      'filter_url' => array(
-        'weight' => '10',
-        'status' => '1',
-        'settings' => array(
-          'filter_url_length' => '72',
-        ),
-      ),
-    ),
-  );
-
-  return $formats;
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.features.inc b/profiles/commons/modules/contrib/features/tests/features_test.features.inc
deleted file mode 100644
index 2f1ee90..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.features.inc
+++ /dev/null
@@ -1,71 +0,0 @@
-<?php
-/**
- * @file
- * features_test.features.inc
- */
-
-/**
- * Implements hook_ctools_plugin_api().
- */
-function features_test_ctools_plugin_api() {
-  list($module, $api) = func_get_args();
-  if ($module == "strongarm" && $api == "strongarm") {
-    return array("version" => "1");
-  }
-}
-
-/**
- * Implements hook_views_api().
- */
-function features_test_views_api() {
-  return array("version" => "3.0");
-}
-
-/**
- * Implements hook_image_default_styles().
- */
-function features_test_image_default_styles() {
-  $styles = array();
-
-  // Exported image style: features_test
-  $styles['features_test'] = array(
-    'name' => 'features_test',
-    'effects' => array(
-      2 => array(
-        'label' => 'Scale',
-        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
-        'effect callback' => 'image_scale_effect',
-        'dimensions callback' => 'image_scale_dimensions',
-        'form callback' => 'image_scale_form',
-        'summary theme' => 'image_scale_summary',
-        'module' => 'image',
-        'name' => 'image_scale',
-        'data' => array(
-          'width' => '100',
-          'height' => '100',
-          'upscale' => 0,
-        ),
-        'weight' => '1',
-      ),
-    ),
-  );
-
-  return $styles;
-}
-
-/**
- * Implements hook_node_info().
- */
-function features_test_node_info() {
-  $items = array(
-    'features_test' => array(
-      'name' => t('Testing: Features'),
-      'base' => 'node_content',
-      'description' => t('Content type provided for Features tests.'),
-      'has_title' => '1',
-      'title_label' => t('Title'),
-      'help' => '',
-    ),
-  );
-  return $items;
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.features.taxonomy.inc b/profiles/commons/modules/contrib/features/tests/features_test.features.taxonomy.inc
deleted file mode 100644
index ef97842..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.features.taxonomy.inc
+++ /dev/null
@@ -1,36 +0,0 @@
-<?php
-/**
- * @file
- * features_test.features.taxonomy.inc
- */
-
-/**
- * Implements hook_taxonomy_default_vocabularies().
- */
-function features_test_taxonomy_default_vocabularies() {
-  return array(
-    'taxonomy_features_test' => array(
-      'name' => 'Taxonomy Features Test',
-      'machine_name' => 'taxonomy_features_test',
-      'description' => 'Taxonomy vocabulary',
-      'hierarchy' => '0',
-      'module' => 'taxonomy',
-      'weight' => '0',
-      'rdf_mapping' => array(
-        'rdftype' => array(
-          0 => 'skos:ConceptScheme',
-        ),
-        'name' => array(
-          'predicates' => array(
-            0 => 'dc:title',
-          ),
-        ),
-        'description' => array(
-          'predicates' => array(
-            0 => 'rdfs:comment',
-          ),
-        ),
-      ),
-    ),
-  );
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.features.user_permission.inc b/profiles/commons/modules/contrib/features/tests/features_test.features.user_permission.inc
deleted file mode 100644
index e957190..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.features.user_permission.inc
+++ /dev/null
@@ -1,24 +0,0 @@
-<?php
-/**
- * @file
- * features_test.features.user_permission.inc
- */
-
-/**
- * Implements hook_user_default_permissions().
- */
-function features_test_user_default_permissions() {
-  $permissions = array();
-
-  // Exported permission: create features_test content.
-  $permissions['create features_test content'] = array(
-    'name' => 'create features_test content',
-    'roles' => array(
-      0 => 'anonymous user',
-      1 => 'authenticated user',
-    ),
-    'module' => 'node',
-  );
-
-  return $permissions;
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.info b/profiles/commons/modules/contrib/features/tests/features_test.info
deleted file mode 100644
index 033e0aa..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.info
+++ /dev/null
@@ -1,29 +0,0 @@
-name = Features Tests
-description = Test module for Features testing.
-core = 7.x
-package = Testing
-php = 5.2.0
-dependencies[] = features
-dependencies[] = image
-dependencies[] = strongarm
-dependencies[] = taxonomy
-dependencies[] = views
-features[ctools][] = strongarm:strongarm:1
-features[ctools][] = views:views_default:3.0
-features[features_api][] = api:1
-features[field][] = node-features_test-field_features_test
-features[filter][] = features_test
-features[image][] = features_test
-features[node][] = features_test
-features[taxonomy][] = taxonomy_features_test
-features[user_permission][] = create features_test content
-features[views_view][] = features_test
-hidden = TRUE
-
-
-; Information added by drush on 2013-04-04
-version = "7.x-2.0-beta1+5-dev"
-core = "7.x"
-project = "features"
-datestamp = "1365041473"
-
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.module b/profiles/commons/modules/contrib/features/tests/features_test.module
deleted file mode 100644
index 762d6e5..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.module
+++ /dev/null
@@ -1,3 +0,0 @@
-<?php
-
-include_once('features_test.features.inc');
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.views_default.inc b/profiles/commons/modules/contrib/features/tests/features_test.views_default.inc
deleted file mode 100644
index 38725b6..0000000
--- a/profiles/commons/modules/contrib/features/tests/features_test.views_default.inc
+++ /dev/null
@@ -1,37 +0,0 @@
-<?php
-/**
- * @file
- * features_test.views_default.inc
- */
-
-/**
- * Implements hook_views_default_views().
- */
-function features_test_views_default_views() {
-  $export = array();
-
-  $view = new view;
-  $view->name = 'features_test';
-  $view->description = 'Test view provided by Features testing module.';
-  $view->tag = 'testing';
-  $view->base_table = 'node';
-  $view->human_name = '';
-  $view->core = 0;
-  $view->api_version = '3.0';
-  $view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */
-
-  /* Display: Defaults */
-  $handler = $view->new_display('default', 'Defaults', 'default');
-  $handler->display->display_options['title'] = 'Test';
-  $handler->display->display_options['access']['type'] = 'none';
-  $handler->display->display_options['cache']['type'] = 'none';
-  $handler->display->display_options['query']['type'] = 'views_query';
-  $handler->display->display_options['query']['options']['query_comment'] = FALSE;
-  $handler->display->display_options['exposed_form']['type'] = 'basic';
-  $handler->display->display_options['pager']['type'] = 'full';
-  $handler->display->display_options['style_plugin'] = 'default';
-  $handler->display->display_options['row_plugin'] = 'node';
-  $export['features_test'] = $view;
-
-  return $export;
-}
diff --git a/profiles/commons/modules/contrib/features/tests/features_test/features_test.info b/profiles/commons/modules/contrib/features/tests/features_test/features_test.info
index 4581595..ce16e91 100644
--- a/profiles/commons/modules/contrib/features/tests/features_test/features_test.info
+++ b/profiles/commons/modules/contrib/features/tests/features_test/features_test.info
@@ -21,9 +21,9 @@ features[user_permission][] = create features_test content
 features[views_view][] = features_test
 hidden = 1
 
-; Information added by drupal.org packaging script on 2013-10-07
-version = "7.x-2.0-rc5"
+; Information added by drupal.org packaging script on 2013-10-17
+version = "7.x-2.0"
 core = "7.x"
 project = "features"
-datestamp = "1381157302"
+datestamp = "1382018758"
 
diff --git a/profiles/commons/modules/contrib/file_entity/LICENSE.txt b/profiles/commons/modules/contrib/file_entity/LICENSE.txt
new file mode 100644
index 0000000..d159169
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/LICENSE.txt
@@ -0,0 +1,339 @@
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/file_entity/admin_views_default/file.admin-content-file.inc b/profiles/commons/modules/contrib/file_entity/admin_views_default/file.admin-content-file.inc
new file mode 100644
index 0000000..e0c8a74
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/admin_views_default/file.admin-content-file.inc
@@ -0,0 +1,313 @@
+<?php
+
+/**
+ * @file
+ * Default view for user administration.
+ */
+
+$view = new view();
+$view->name = 'admin_views_file';
+$view->description = 'Find and manage files.';
+$view->tag = 'admin';
+$view->base_table = 'file_managed';
+$view->human_name = 'Administration: Files';
+$view->core = 7;
+$view->api_version = '3.0';
+$view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */
+
+/* Display: Master */
+$handler = $view->new_display('default', 'Master', 'default');
+$handler->display->display_options['title'] = 'Files';
+$handler->display->display_options['css_class'] = 'admin-views-view';
+$handler->display->display_options['use_ajax'] = TRUE;
+$handler->display->display_options['use_more_always'] = FALSE;
+$handler->display->display_options['access']['type'] = 'menu';
+$handler->display->display_options['cache']['type'] = 'none';
+$handler->display->display_options['query']['type'] = 'views_query';
+$handler->display->display_options['exposed_form']['type'] = 'basic';
+$handler->display->display_options['exposed_form']['options']['reset_button'] = TRUE;
+$handler->display->display_options['pager']['type'] = 'full';
+$handler->display->display_options['pager']['options']['items_per_page'] = '50';
+$handler->display->display_options['pager']['options']['offset'] = '0';
+$handler->display->display_options['pager']['options']['id'] = '0';
+$handler->display->display_options['pager']['options']['quantity'] = '9';
+$handler->display->display_options['style_plugin'] = 'table';
+$handler->display->display_options['style_options']['columns'] = array(
+  'views_bulk_operations' => 'views_bulk_operations',
+  'filename' => 'filename',
+  'type' => 'type',
+  'name' => 'name',
+  'filesize' => 'filesize',
+  'timestamp' => 'timestamp',
+  'edit' => 'edit',
+  'delete' => 'delete',
+);
+$handler->display->display_options['style_options']['default'] = 'timestamp';
+$handler->display->display_options['style_options']['info'] = array(
+  'views_bulk_operations' => array(
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'filename' => array(
+    'sortable' => 1,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'type' => array(
+    'sortable' => 1,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'name' => array(
+    'sortable' => 1,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'filesize' => array(
+    'sortable' => 1,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'timestamp' => array(
+    'sortable' => 1,
+    'default_sort_order' => 'desc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'edit' => array(
+    'sortable' => 0,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+  'delete' => array(
+    'sortable' => 0,
+    'default_sort_order' => 'asc',
+    'align' => '',
+    'separator' => '',
+    'empty_column' => 0,
+  ),
+);
+$handler->display->display_options['style_options']['sticky'] = TRUE;
+$handler->display->display_options['style_options']['empty_table'] = TRUE;
+/* No results behavior: Global: Unfiltered text */
+$handler->display->display_options['empty']['area_text_custom']['id'] = 'area_text_custom';
+$handler->display->display_options['empty']['area_text_custom']['table'] = 'views';
+$handler->display->display_options['empty']['area_text_custom']['field'] = 'area_text_custom';
+$handler->display->display_options['empty']['area_text_custom']['empty'] = TRUE;
+$handler->display->display_options['empty']['area_text_custom']['content'] = 'No files available.';
+/* Relationship: File: User who uploaded */
+$handler->display->display_options['relationships']['uid']['id'] = 'uid';
+$handler->display->display_options['relationships']['uid']['table'] = 'file_managed';
+$handler->display->display_options['relationships']['uid']['field'] = 'uid';
+$handler->display->display_options['relationships']['uid']['label'] = 'user';
+/* Field: Bulk operations: File */
+$handler->display->display_options['fields']['views_bulk_operations']['id'] = 'views_bulk_operations';
+$handler->display->display_options['fields']['views_bulk_operations']['table'] = 'file_managed';
+$handler->display->display_options['fields']['views_bulk_operations']['field'] = 'views_bulk_operations';
+$handler->display->display_options['fields']['views_bulk_operations']['label'] = '';
+$handler->display->display_options['fields']['views_bulk_operations']['element_label_colon'] = FALSE;
+$handler->display->display_options['fields']['views_bulk_operations']['vbo_settings']['display_type'] = '0';
+$handler->display->display_options['fields']['views_bulk_operations']['vbo_settings']['enable_select_all_pages'] = 1;
+$handler->display->display_options['fields']['views_bulk_operations']['vbo_settings']['force_single'] = 0;
+$handler->display->display_options['fields']['views_bulk_operations']['vbo_settings']['entity_load_capacity'] = '10';
+$handler->display->display_options['fields']['views_bulk_operations']['vbo_operations'] = array(
+  'action::views_bulk_operations_archive_action' => array(
+    'selected' => 1,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 1,
+    'label' => 'Archive',
+    'settings' => array(
+      'scheme' => 'public',
+      'temporary' => 1,
+    ),
+  ),
+  'action::views_bulk_operations_delete_item' => array(
+    'selected' => 1,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 1,
+    'label' => 'Delete',
+  ),
+  'action::views_bulk_operations_script_action' => array(
+    'selected' => 0,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 0,
+    'label' => '',
+  ),
+  'action::views_bulk_operations_modify_action' => array(
+    'selected' => 1,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 1,
+    'override_label' => 1,
+    'label' => 'Change value',
+    'settings' => array(
+      'show_all_tokens' => 1,
+      'display_values' => array(
+        '_all_' => '_all_',
+      ),
+    ),
+  ),
+  'action::views_bulk_operations_argument_selector_action' => array(
+    'selected' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 0,
+    'label' => '',
+    'settings' => array(
+      'url' => '',
+    ),
+  ),
+  'action::system_send_email_action' => array(
+    'selected' => 0,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 0,
+    'label' => '',
+  ),
+  'action::panelizer_set_status_action' => array(
+    'selected' => 0,
+    'postpone_processing' => 0,
+    'skip_confirmation' => 0,
+    'override_label' => 0,
+    'label' => '',
+  ),
+);
+/* Field: File: Name */
+$handler->display->display_options['fields']['filename']['id'] = 'filename';
+$handler->display->display_options['fields']['filename']['table'] = 'file_managed';
+$handler->display->display_options['fields']['filename']['field'] = 'filename';
+/* Field: File: Type */
+$handler->display->display_options['fields']['type']['id'] = 'type';
+$handler->display->display_options['fields']['type']['table'] = 'file_managed';
+$handler->display->display_options['fields']['type']['field'] = 'type';
+$handler->display->display_options['fields']['type']['machine_name'] = 0;
+/* Field: User: Name */
+$handler->display->display_options['fields']['name']['id'] = 'name';
+$handler->display->display_options['fields']['name']['table'] = 'users';
+$handler->display->display_options['fields']['name']['field'] = 'name';
+$handler->display->display_options['fields']['name']['relationship'] = 'uid';
+$handler->display->display_options['fields']['name']['label'] = 'User';
+/* Field: File: Size */
+$handler->display->display_options['fields']['filesize']['id'] = 'filesize';
+$handler->display->display_options['fields']['filesize']['table'] = 'file_managed';
+$handler->display->display_options['fields']['filesize']['field'] = 'filesize';
+/* Field: File: Upload date */
+$handler->display->display_options['fields']['timestamp']['id'] = 'timestamp';
+$handler->display->display_options['fields']['timestamp']['table'] = 'file_managed';
+$handler->display->display_options['fields']['timestamp']['field'] = 'timestamp';
+$handler->display->display_options['fields']['timestamp']['label'] = 'Uploaded';
+$handler->display->display_options['fields']['timestamp']['date_format'] = 'short';
+/* Field: File: Edit link */
+$handler->display->display_options['fields']['edit']['id'] = 'edit';
+$handler->display->display_options['fields']['edit']['table'] = 'file_managed';
+$handler->display->display_options['fields']['edit']['field'] = 'edit';
+$handler->display->display_options['fields']['edit']['label'] = '';
+$handler->display->display_options['fields']['edit']['element_label_colon'] = FALSE;
+/* Field: File: Usage link */
+$handler->display->display_options['fields']['usage']['id'] = 'usage';
+$handler->display->display_options['fields']['usage']['table'] = 'file_managed';
+$handler->display->display_options['fields']['usage']['field'] = 'usage';
+$handler->display->display_options['fields']['usage']['label'] = '';
+$handler->display->display_options['fields']['usage']['element_label_colon'] = FALSE;
+/* Field: File: Delete link */
+$handler->display->display_options['fields']['delete']['id'] = 'delete';
+$handler->display->display_options['fields']['delete']['table'] = 'file_managed';
+$handler->display->display_options['fields']['delete']['field'] = 'delete';
+$handler->display->display_options['fields']['delete']['label'] = '';
+$handler->display->display_options['fields']['delete']['element_label_colon'] = FALSE;
+/* Filter criterion: File: Name */
+$handler->display->display_options['filters']['filename']['id'] = 'filename';
+$handler->display->display_options['filters']['filename']['table'] = 'file_managed';
+$handler->display->display_options['filters']['filename']['field'] = 'filename';
+$handler->display->display_options['filters']['filename']['operator'] = 'contains';
+$handler->display->display_options['filters']['filename']['group'] = 1;
+$handler->display->display_options['filters']['filename']['exposed'] = TRUE;
+$handler->display->display_options['filters']['filename']['expose']['operator_id'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['label'] = 'Name';
+$handler->display->display_options['filters']['filename']['expose']['operator'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['identifier'] = 'filename';
+$handler->display->display_options['filters']['filename']['expose']['remember'] = TRUE;
+$handler->display->display_options['filters']['filename']['expose']['remember_roles'] = array(
+  2 => '2',
+  1 => 0,
+  3 => 0,
+);
+/* Filter criterion: File: Type */
+$handler->display->display_options['filters']['type']['id'] = 'type';
+$handler->display->display_options['filters']['type']['table'] = 'file_managed';
+$handler->display->display_options['filters']['type']['field'] = 'type';
+$handler->display->display_options['filters']['type']['group'] = 1;
+$handler->display->display_options['filters']['type']['exposed'] = TRUE;
+$handler->display->display_options['filters']['type']['expose']['operator_id'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['label'] = 'Type';
+$handler->display->display_options['filters']['type']['expose']['operator'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['identifier'] = 'type';
+$handler->display->display_options['filters']['type']['expose']['remember'] = TRUE;
+$handler->display->display_options['filters']['type']['expose']['remember_roles'] = array(
+  2 => '2',
+  1 => 0,
+  3 => 0,
+);
+/* Filter criterion: User: Name */
+$handler->display->display_options['filters']['uid']['id'] = 'uid';
+$handler->display->display_options['filters']['uid']['table'] = 'users';
+$handler->display->display_options['filters']['uid']['field'] = 'uid';
+$handler->display->display_options['filters']['uid']['relationship'] = 'uid';
+$handler->display->display_options['filters']['uid']['value'] = '';
+$handler->display->display_options['filters']['uid']['group'] = 1;
+$handler->display->display_options['filters']['uid']['exposed'] = TRUE;
+$handler->display->display_options['filters']['uid']['expose']['operator_id'] = 'uid_op';
+$handler->display->display_options['filters']['uid']['expose']['label'] = 'User';
+$handler->display->display_options['filters']['uid']['expose']['operator'] = 'uid_op';
+$handler->display->display_options['filters']['uid']['expose']['identifier'] = 'uid';
+$handler->display->display_options['filters']['uid']['expose']['remember'] = TRUE;
+$handler->display->display_options['filters']['uid']['expose']['remember_roles'] = array(
+  2 => '2',
+  1 => 0,
+  3 => 0,
+);
+
+/* Display: System */
+$handler = $view->new_display('system', 'System', 'system_1');
+$handler->display->display_options['defaults']['hide_admin_links'] = FALSE;
+$handler->display->display_options['hide_admin_links'] = TRUE;
+$handler->display->display_options['defaults']['access'] = FALSE;
+$handler->display->display_options['path'] = 'admin/content/file';
+$translatables['admin_views_file'] = array(
+  t('Master'),
+  t('Files'),
+  t('more'),
+  t('Apply'),
+  t('Reset'),
+  t('Sort by'),
+  t('Asc'),
+  t('Desc'),
+  t('Items per page'),
+  t('- All -'),
+  t('Offset'),
+  t(' first'),
+  t(' previous'),
+  t('next '),
+  t('last '),
+  t('No files available.'),
+  t('user'),
+  t('Name'),
+  t('Type'),
+  t('User'),
+  t('Size'),
+  t('Uploaded'),
+  t('System'),
+);
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.admin.inc b/profiles/commons/modules/contrib/file_entity/file_entity.admin.inc
new file mode 100644
index 0000000..43ef475
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.admin.inc
@@ -0,0 +1,1120 @@
+<?php
+/**
+ * @file
+ * File administration and module settings UI.
+ */
+
+require_once dirname(__FILE__) . '/file_entity.pages.inc';
+
+/**
+ * List file administration filters that can be applied.
+ */
+function file_filters() {
+  $visible_steam_wrappers = file_get_stream_wrappers(STREAM_WRAPPERS_VISIBLE);
+  $options = array();
+  foreach ($visible_steam_wrappers as $scheme => $information) {
+    $options[$scheme] = check_plain($information['name']);
+  }
+  $filters['uri'] = array(
+    'title' => t('scheme'),
+    'options' => array(
+      '[any]' => t('any'),
+    ) + $options,
+  );
+  $filters['type'] = array(
+    'title' => t('type'),
+    'options' => array(
+      '[any]' => t('any'),
+    ) + file_entity_type_get_names(),
+  );
+  return $filters;
+}
+
+/**
+ * Apply filters for file administration filters based on session.
+ *
+ * @param object $query
+ *   A SelectQuery to which the filters should be applied.
+ */
+function file_entity_build_filter_query(SelectQueryInterface $query) {
+  // Build query.
+  $filter_data = isset($_SESSION['file_entity_overview_filter']) ? $_SESSION['file_entity_overview_filter'] : array();
+  foreach ($filter_data as $index => $filter) {
+    list($key, $value) = $filter;
+    switch ($key) {
+      case 'uri':
+        $query->condition('fm.' . $key, $value . '%', 'LIKE');
+        break;
+
+      case 'type':
+        $query->condition('fm.' . $key, $value);
+        break;
+
+    }
+  }
+}
+
+/**
+ * Return form for file administration filters.
+ */
+function file_entity_filter_form() {
+  $session = isset($_SESSION['file_entity_overview_filter']) ? $_SESSION['file_entity_overview_filter'] : array();
+  $filters = file_filters();
+
+  $i = 0;
+  $form['filters'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Show only items where'),
+    '#theme' => 'exposed_filters__file_entity',
+  );
+  foreach ($session as $filter) {
+    list($type, $value) = $filter;
+    if ($type == 'term') {
+      // Load term name from DB rather than search and parse options array.
+      $value = module_invoke('taxonomy', 'term_load', $value);
+      $value = $value->name;
+    }
+    else {
+      $value = $filters[$type]['options'][$value];
+    }
+    $t_args = array('%property' => $filters[$type]['title'], '%value' => $value);
+    if ($i++) {
+      $form['filters']['current'][] = array('#markup' => t('and where %property is %value', $t_args));
+    }
+    else {
+      $form['filters']['current'][] = array('#markup' => t('where %property is %value', $t_args));
+    }
+    if (in_array($type, array('type', 'uri'))) {
+      // Remove the option if it is already being filtered on.
+      unset($filters[$type]);
+    }
+  }
+
+  $form['filters']['status'] = array(
+    '#type' => 'container',
+    '#attributes' => array('class' => array('clearfix')),
+    '#prefix' => ($i ? '<div class="additional-filters">' . t('and where') . '</div>' : ''),
+  );
+  $form['filters']['status']['filters'] = array(
+    '#type' => 'container',
+    '#attributes' => array('class' => array('filters')),
+  );
+  foreach ($filters as $key => $filter) {
+    $form['filters']['status']['filters'][$key] = array(
+      '#type' => 'select',
+      '#options' => $filter['options'],
+      '#title' => $filter['title'],
+      '#default_value' => '[any]',
+    );
+  }
+
+  $form['filters']['status']['actions'] = array(
+    '#type' => 'actions',
+    '#attributes' => array('class' => array('container-inline')),
+  );
+  if (count($filters)) {
+    $form['filters']['status']['actions']['submit'] = array(
+      '#type' => 'submit',
+      '#value' => count($session) ? t('Refine') : t('Filter'),
+    );
+  }
+  if (count($session)) {
+    $form['filters']['status']['actions']['undo'] = array('#type' => 'submit', '#value' => t('Undo'));
+    $form['filters']['status']['actions']['reset'] = array('#type' => 'submit', '#value' => t('Reset'));
+  }
+
+  drupal_add_js('misc/form.js');
+
+  return $form;
+}
+
+/**
+ * Process result from file administration filter form.
+ */
+function file_entity_filter_form_submit($form, &$form_state) {
+  $filters = file_filters();
+  switch ($form_state['values']['op']) {
+    case t('Filter'):
+    case t('Refine'):
+      // Apply every filter that has a choice selected other than 'any'.
+      foreach ($filters as $filter => $options) {
+        if (isset($form_state['values'][$filter]) && $form_state['values'][$filter] != '[any]') {
+          // Flatten the options array to accommodate hierarchical/nested
+          // options.
+          $flat_options = form_options_flatten($filters[$filter]['options']);
+          // Only accept valid selections offered on the dropdown, block bad
+          // input.
+          if (isset($flat_options[$form_state['values'][$filter]])) {
+            $_SESSION['file_entity_overview_filter'][] = array($filter, $form_state['values'][$filter]);
+          }
+        }
+      }
+      break;
+
+    case t('Undo'):
+      array_pop($_SESSION['file_entity_overview_filter']);
+      break;
+
+    case t('Reset'):
+      $_SESSION['file_entity_overview_filter'] = array();
+      break;
+
+  }
+}
+
+/**
+ * Make mass update of files.
+ *
+ * Change all files in the $files array to update them with the field values in
+ * $updates.
+ *
+ * IMPORTANT NOTE: This function is intended to work when called
+ * from a form submit handler. Calling it outside of the form submission
+ * process may not work correctly.
+ *
+ * @param array $files
+ *   Array of file fids to update.
+ * @param array $updates
+ *   Array of key/value pairs with file field names and the
+ *   value to update that field to.
+ */
+function file_entity_mass_update($files, $updates) {
+  // We use batch processing to prevent timeout when updating a large number
+  // of files.
+  if (count($files) > 10) {
+    $batch = array(
+      'operations' => array(
+        array(
+          '_file_entity_mass_update_batch_process',
+          array($files, $updates),
+        ),
+      ),
+      'finished' => '_file_entity_mass_update_batch_finished',
+      'title' => t('Processing'),
+      // We use a single multi-pass operation, so the default
+      // 'Remaining x of y operations' message will be confusing here.
+      'progress_message' => '',
+      'error_message' => t('The update has encountered an error.'),
+      // The operations do not live in the .module file, so we need to
+      // tell the batch engine which file to load before calling them.
+      'file' => drupal_get_path('module', 'file_entity') . '/file_entity.admin.inc',
+    );
+    batch_set($batch);
+  }
+  else {
+    foreach ($files as $fid) {
+      _file_entity_mass_update_helper($fid, $updates);
+    }
+    drupal_set_message(t('The update has been performed.'));
+  }
+}
+
+/**
+ * File Mass Update - helper function.
+ */
+function _file_entity_mass_update_helper($fid, $updates) {
+  $file = file_load($fid);
+  // For efficiency manually save the original file before applying any changes.
+  $file->original = clone $file;
+  foreach ($updates as $name => $value) {
+    $file->$name = $value;
+  }
+  file_save($file);
+  return $file;
+}
+
+/**
+ * File Mass Update Batch operation.
+ */
+function _file_entity_mass_update_batch_process($files, $updates, &$context) {
+  if (!isset($context['sandbox']['progress'])) {
+    $context['sandbox']['progress'] = 0;
+    $context['sandbox']['max'] = count($files);
+    $context['sandbox']['files'] = $files;
+  }
+
+  // Process files by groups of 5.
+  $count = min(5, count($context['sandbox']['files']));
+  for ($i = 1; $i <= $count; $i++) {
+    // For each fid, load the file, reset the values, and save it.
+    $fid = array_shift($context['sandbox']['files']);
+    $file = _file_entity_mass_update_helper($fid, $updates);
+
+    // Store result for post-processing in the finished callback.
+    $context['results'][] = l($file->filename, 'file/' . $file->fid);
+
+    // Update our progress information.
+    $context['sandbox']['progress']++;
+  }
+
+  // Inform the batch engine that we are not finished,
+  // and provide an estimation of the completion level we reached.
+  if ($context['sandbox']['progress'] != $context['sandbox']['max']) {
+    $context['finished'] = $context['sandbox']['progress'] / $context['sandbox']['max'];
+  }
+}
+
+/**
+ * File Mass Update Batch 'finished' callback.
+ */
+function _file_entity_mass_update_batch_finished($success, $results, $operations) {
+  if ($success) {
+    drupal_set_message(t('The update has been performed.'));
+  }
+  else {
+    drupal_set_message(t('An error occurred and processing did not complete.'), 'error');
+    $message = format_plural(count($results), '1 item successfully processed:', '@count items successfully processed:');
+    $message .= theme('item_list', array('items' => $results));
+    drupal_set_message($message);
+  }
+}
+
+/**
+ * Menu callback: file administration.
+ */
+function file_entity_admin_file($form, $form_state) {
+  if (isset($form_state['values']['operation']) && $form_state['values']['operation'] == 'delete') {
+    return file_entity_multiple_delete_confirm($form, $form_state, array_filter($form_state['values']['files']));
+  }
+  $form['filter'] = file_entity_filter_form();
+  $form['#submit'][] = 'file_entity_filter_form_submit';
+  $form['admin'] = file_entity_admin_files();
+
+  return $form;
+}
+
+/**
+ * Form builder: Builds the file administration overview.
+ */
+function file_entity_admin_files() {
+  $admin_access = user_access('administer files');
+
+  // Build the 'Update options' form.
+  $form['options'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Update options'),
+    '#attributes' => array('class' => array('container-inline')),
+    '#access' => $admin_access,
+  );
+  $options = array();
+  foreach (module_invoke_all('file_operations') as $operation => $array) {
+    $options[$operation] = $array['label'];
+  }
+  $form['options']['operation'] = array(
+    '#type' => 'select',
+    '#title' => t('Operation'),
+    '#title_display' => 'invisible',
+    '#options' => $options,
+    '#default_value' => 'approve',
+  );
+  $form['options']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Update'),
+    '#validate' => array('file_entity_admin_files_validate'),
+    '#submit' => array('file_entity_admin_files_submit'),
+  );
+
+  // Build the sortable table header.
+  $header = array(
+    'title' => array('data' => t('Title'), 'field' => 'fm.filename'),
+    'type' => array('data' => t('Type'), 'field' => 'fm.type'),
+    'size' => array('data' => t('Size'), 'field' => 'fm.filesize'),
+    'author' => t('Author'),
+    'timestamp' => array(
+      'data' => t('Updated'),
+      'field' => 'fm.timestamp',
+      'sort' => 'desc'),
+    'usage' => array('data' => t('Used in'), 'field' => 'total_count'),
+    'operations' => array('data' => t('Operations')),
+  );
+
+  $query = db_select('file_managed', 'fm')->extend('PagerDefault')->extend('TableSort');
+  $query->leftJoin('file_usage', 'fu', 'fm.fid = fu.fid');
+  $query->groupBy('fm.fid');
+  $query->addExpression('SUM(fu.count)', 'total_count');
+  file_entity_build_filter_query($query);
+
+  $result = $query
+    ->fields('fm', array('fid', 'uid'))
+    ->limit(50)
+    ->orderByHeader($header)
+    ->addTag('file_access')
+    ->execute()
+    ->fetchAllAssoc('fid');
+  $files = file_load_multiple(array_keys($result));
+
+  $uids = array();
+  foreach ($files as $file) {
+    $uids[] = $file->uid;
+  }
+  $accounts = !empty($uids) ? user_load_multiple(array_unique($uids)) : array();
+
+  // Prepare the list of files.
+  $destination = drupal_get_destination();
+  $options = array();
+  foreach ($files as $file) {
+    $file_type = file_type_load($file->type);
+    $options[$file->fid] = array(
+      'title' => array(
+        'data' => array(
+          '#type' => 'link',
+          '#title' => $file->filename,
+          '#href' => 'file/' . $file->fid,
+        ),
+      ),
+      'type' => $file_type ? check_plain($file_type->label) : FILE_TYPE_NONE,
+      'size' => format_size($file->filesize),
+      'author' => theme('username', array('account' => $accounts[$file->uid])),
+      'timestamp' => format_date($file->timestamp, 'short'),
+      'usage' => format_plural((int) $result[$file->fid]->total_count, '1 place', '@count places'),
+    );
+
+    // Show a warning for files that do not exist.
+    if (@!is_file($file->uri)) {
+      $options[$file->fid]['#attributes']['class'][] = 'error';
+      if (!file_stream_wrapper_get_instance_by_uri($file->uri)) {
+        $options[$file->fid]['#attributes']['title'] = t('The stream wrapper for @scheme files is missing.', array('@scheme' => file_uri_scheme($file->uri)));
+      }
+      else {
+        $options[$file->fid]['#attributes']['title'] = t('The file does not exist.');
+      }
+    }
+
+    // Build a list of all the accessible operations for the current file.
+    $operations = array();
+    if (file_entity_access('update', $file)) {
+      // Convert the usage count to a link.
+      $options[$file->fid]['usage'] = l($options[$file->fid]['usage'], 'file/' . $file->fid . '/usage');
+      $operations['edit'] = array(
+        'title' => t('Edit'),
+        'href' => 'file/' . $file->fid . '/edit',
+        'query' => $destination,
+      );
+    }
+    if (file_entity_access('delete', $file)) {
+      $operations['delete'] = array(
+        'title' => t('Delete'),
+        'href' => 'file/' . $file->fid . '/delete',
+        'query' => $destination,
+      );
+    }
+    $options[$file->fid]['operations'] = array();
+    if (count($operations) > 1) {
+      // Render an unordered list of operations links.
+      $options[$file->fid]['operations'] = array(
+        'data' => array(
+          '#theme' => 'links__file_entity_operations',
+          '#links' => $operations,
+          '#attributes' => array('class' => array('links', 'inline')),
+        ),
+      );
+    }
+    elseif (!empty($operations)) {
+      // Render the first and only operation as a link.
+      $link = reset($operations);
+      $options[$file->fid]['operations'] = array(
+        'data' => array(
+          '#type' => 'link',
+          '#title' => $link['title'],
+          '#href' => $link['href'],
+          '#options' => array('query' => $link['query']),
+        ),
+      );
+    }
+  }
+
+  // Only use a tableselect when the current user is able to perform any
+  // operations.
+  if ($admin_access) {
+    $form['files'] = array(
+      '#type' => 'tableselect',
+      '#header' => $header,
+      '#options' => $options,
+      '#empty' => t('No files available.'),
+    );
+  }
+  // Otherwise, use a simple table.
+  else {
+    $form['files'] = array(
+      '#theme' => 'table',
+      '#header' => $header,
+      '#rows' => $options,
+      '#empty' => t('No files available.'),
+    );
+  }
+
+  $form['pager'] = array('#markup' => theme('pager'));
+  return $form;
+}
+
+/**
+ * Validate file_entity_admin_files form submissions.
+ *
+ * Check if any files have been selected to perform the chosen
+ * 'Update option' on.
+ */
+function file_entity_admin_files_validate($form, &$form_state) {
+  // Error if there are no items to select.
+  if (!is_array($form_state['values']['files']) || !count(array_filter($form_state['values']['files']))) {
+    form_set_error('', t('No items selected.'));
+  }
+}
+
+/**
+ * Process file_entity_admin_files form submissions.
+ *
+ * Execute the chosen 'Update option' on the selected files.
+ */
+function file_entity_admin_files_submit($form, &$form_state) {
+  $operations = module_invoke_all('file_operations');
+  $operation = $operations[$form_state['values']['operation']];
+  // Filter out unchecked files.
+  $files = array_filter($form_state['values']['files']);
+  if ($function = $operation['callback']) {
+    // Add in callback arguments if present.
+    if (isset($operation['callback arguments'])) {
+      $args = array_merge(array($files), $operation['callback arguments']);
+    }
+    else {
+      $args = array($files);
+    }
+    call_user_func_array($function, $args);
+
+    cache_clear_all();
+  }
+  else {
+    // We need to rebuild the form to go to a second step. For example, to
+    // show the confirmation form for the deletion of files.
+    $form_state['rebuild'] = TRUE;
+  }
+}
+
+/**
+ * File entity delete confirmation.
+ */
+function file_entity_multiple_delete_confirm($form, &$form_state, $files) {
+  $form['files'] = array(
+    '#prefix' => '<ul>',
+    '#suffix' => '</ul>',
+    '#tree' => TRUE,
+  );
+  // array_filter returns only elements with TRUE values.
+  foreach ($files as $fid => $value) {
+    $filename = db_query('SELECT filename FROM {file_managed} WHERE fid = :fid', array(':fid' => $fid))->fetchField();
+    $form['files'][$fid] = array(
+      '#type' => 'hidden',
+      '#value' => $fid,
+      '#prefix' => '<li>',
+      '#suffix' => check_plain($filename) . "</li>\n",
+    );
+  }
+  $form['operation'] = array('#type' => 'hidden', '#value' => 'delete');
+  $form['#submit'][] = 'file_entity_multiple_delete_confirm_submit';
+  $confirm_question = format_plural(count($files),
+                                  'Are you sure you want to delete this item?',
+                                  'Are you sure you want to delete these items?');
+  return confirm_form($form,
+                    $confirm_question,
+                    'admin/content/file', t('This action cannot be undone.'),
+                    t('Delete'), t('Cancel'));
+}
+
+/**
+ * Submit handler for delete confirmation.
+ */
+function file_entity_multiple_delete_confirm_submit($form, &$form_state) {
+  if ($form_state['values']['confirm']) {
+    file_delete_multiple(array_keys($form_state['values']['files']));
+    $count = count($form_state['values']['files']);
+    watchdog('file_entity', 'Deleted @count files.', array('@count' => $count));
+    drupal_set_message(format_plural($count, 'Deleted 1 file.', 'Deleted @count files.'));
+  }
+  $form_state['redirect'] = 'admin/content/file';
+}
+
+/**
+ * Displays the file type admin overview page.
+ */
+function file_entity_list_types_page() {
+  $file_entity_info = entity_get_info('file');
+  $field_ui = module_exists('field_ui');
+  $colspan = $field_ui ? 5 : 3;
+  $header = array(
+    array('data' => t('Name')),
+    array('data' => t('Operations'), 'colspan' => $colspan),
+    array('data' => t('Status')),
+  );
+  $rows = array();
+  $weight = 0;
+  $types = file_type_load_all(TRUE);
+  $count = count($types);
+  foreach ($types as $type) {
+    $weight++;
+    $row = array(
+      array(
+        'data' => theme('file_entity_file_type_overview',
+          array(
+            'label' => $type->label,
+            'description' => $type->description,
+          )
+        ),
+      ),
+    );
+    $path = isset($file_entity_info['bundles'][$type->type]['admin']['real path']) ? $file_entity_info['bundles'][$type->type]['admin']['real path'] : NULL;
+
+    if (empty($type->disabled) && isset($path)) {
+      $row[] = array('data' => l(t('edit file type'), $path . '/edit'));
+      if ($field_ui) {
+        $row[] = array('data' => l(t('manage fields'), $path . '/fields'));
+        $row[] = array('data' => l(t('manage display'), $path . '/display'));
+      }
+      $row[] = array('data' => l(t('manage file display'), $path . '/file-display'));
+    }
+    else {
+      $row += array_fill(1, $colspan - 1, '');
+    }
+
+    $admin_path = 'admin/structure/file-types/manage/' . $type->type;
+    switch ($type->ctools_type) {
+      // Configuration is in code.
+      case 'Default':
+        if (!empty($type->disabled)) {
+          $row[] = l(t('enable'), $admin_path . '/enable');
+        }
+        else {
+          $row[] = l(t('disable'), $admin_path . '/disable');
+        }
+        break;
+
+      // Configuration is in DB.
+      case 'Normal':
+        if (!empty($type->disabled)) {
+          $status = l(t('enable'), $admin_path . '/enable');
+        }
+        else {
+          $status = l(t('disable'), $admin_path . '/disable');
+        }
+        $row[] = $status . ' | ' . l(t('delete'), $admin_path . '/delete');
+        break;
+
+      // Configuration is in code, but overridden in DB.
+      case 'Overridden':
+        if (!empty($type->disabled)) {
+          $row[] = l(t('enable'), $admin_path . '/enable');
+        }
+        else {
+          $row[] = l(t('disable'), $admin_path . '/disable') . ' | ' . l(t('revert'), $admin_path . '/revert');
+        }
+        break;
+    }
+
+    if (!empty($type->disabled)) {
+      $row[] = t('Disabled');
+      $rows[$weight + $count] = array('data' => $row, 'class' => array('ctools-export-ui-disabled'));
+    }
+    else {
+      $row[] = $type->ctools_type;
+      $rows[$weight] = array('data' => $row);
+    }
+  }
+
+  // Move disabled items to the bottom.
+  ksort($rows);
+
+  $build['file_type_table'] = array(
+    '#theme' => 'table',
+    '#header' => $header,
+    '#rows' => $rows,
+    '#empty' => t('No file types available.'),
+    '#attached' => array(
+      'css' => array(drupal_get_path('module', 'ctools') . '/css/export-ui-list.css'),
+    ),
+  );
+
+  return $build;
+}
+
+/**
+ * Form callback; presents file display settings for a given view mode.
+ */
+function file_entity_file_display_form($form, &$form_state, $file_type, $view_mode) {
+  $form['#file_type'] = $file_type->type;
+  $form['#view_mode'] = $view_mode;
+  $form['#tree'] = TRUE;
+  $form['#attached']['js'][] = drupal_get_path('module', 'file_entity') . '/file_entity.admin.js';
+
+  // Retrieve available formatters for this file type and load all configured
+  // filters for existing text formats.
+  $formatters = file_info_formatter_types();
+  foreach ($formatters as $name => $formatter) {
+    if (!empty($formatter['hidden'])) {
+      unset($formatters[$name]);
+    }
+    if (isset($formatter['mime types'])) {
+      if (file_entity_match_mimetypes($formatter['mime types'], $file_type->mimetypes)) {
+        continue;
+      }
+      unset($formatters[$name]);
+    }
+  }
+  $current_displays = file_displays_load($file_type->type, $view_mode, TRUE);
+  foreach ($current_displays as $name => $display) {
+    $current_displays[$name] = (array) $display;
+  }
+
+  // Formatter status.
+  $form['displays']['status'] = array(
+    '#type' => 'item',
+    '#title' => t('Enabled displays'),
+    '#prefix' => '<div id="file-displays-status-wrapper">',
+    '#suffix' => '</div>',
+  );
+  $i = 0;
+  foreach ($formatters as $name => $formatter) {
+    $form['displays']['status'][$name] = array(
+      '#type' => 'checkbox',
+      '#title' => check_plain($formatter['label']),
+      '#default_value' => !empty($current_displays[$name]['status']),
+      '#description' => isset($formatter['description']) ? filter_xss($formatter['description']) : NULL,
+      '#parents' => array('displays', $name, 'status'),
+      '#weight' => (isset($formatter['weight']) ? $formatter['weight'] : 0) + ($i / 1000),
+    );
+    $i++;
+  }
+
+  // Formatter order (tabledrag).
+  $form['displays']['order'] = array(
+    '#type' => 'item',
+    '#title' => t('Display precedence order'),
+    '#theme' => 'file_entity_file_display_order',
+  );
+  foreach ($formatters as $name => $formatter) {
+    $form['displays']['order'][$name]['label'] = array(
+      '#markup' => check_plain($formatter['label']),
+    );
+    $form['displays']['order'][$name]['weight'] = array(
+      '#type' => 'weight',
+      '#title' => t('Weight for @title', array('@title' => $formatter['label'])),
+      '#title_display' => 'invisible',
+      '#delta' => 50,
+      '#default_value' => isset($current_displays[$name]['weight']) ? $current_displays[$name]['weight'] : 0,
+      '#parents' => array('displays', $name, 'weight'),
+    );
+    $form['displays']['order'][$name]['#weight'] = $form['displays']['order'][$name]['weight']['#default_value'];
+  }
+
+  // Formatter settings.
+  $form['display_settings_title'] = array(
+    '#type' => 'item',
+    '#title' => t('Display settings'),
+  );
+  $form['display_settings'] = array(
+    '#type' => 'vertical_tabs',
+  );
+  $i = 0;
+  foreach ($formatters as $name => $formatter) {
+    if (isset($formatter['settings callback']) && ($function = $formatter['settings callback']) && function_exists($function)) {
+      $defaults = !empty($formatter['default settings']) ? $formatter['default settings'] : array();
+      $settings = !empty($current_displays[$name]['settings']) ? $current_displays[$name]['settings'] : array();
+      $settings += $defaults;
+      $settings_form = $function($form, $form_state, $settings, $name, $file_type->type, $view_mode);
+      if (!empty($settings_form)) {
+        $form['displays']['settings'][$name] = array(
+          '#type' => 'fieldset',
+          '#title' => check_plain($formatter['label']),
+          '#parents' => array('displays', $name, 'settings'),
+          '#group' => 'display_settings',
+          '#weight' => (isset($formatter['weight']) ? $formatter['weight'] : 0) + ($i / 1000),
+        ) + $settings_form;
+      }
+    }
+    $i++;
+  }
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save configuration'),
+  );
+
+  return $form;
+}
+
+/**
+ * Process file display settings form submissions.
+ */
+function file_entity_file_display_form_submit($form, &$form_state) {
+  $file_type = $form['#file_type'];
+  $view_mode = $form['#view_mode'];
+  $displays = isset($form_state['values']['displays']) ? $form_state['values']['displays'] : array();
+  $displays_original = file_displays_load($file_type, $view_mode, TRUE);
+  foreach ($displays as $formatter_name => $display) {
+    $display_original = isset($displays_original[$formatter_name]) ? $displays_original[$formatter_name] : file_display_new($file_type, $view_mode, $formatter_name);
+    $display += (array) $display_original;
+    file_display_save((object) $display);
+  }
+  drupal_set_message(t('Your settings have been saved.'));
+}
+
+/**
+ * Returns HTML for the file type overview page.
+ *
+ * Specifically, this returns HTML for a file type label and description.
+ */
+function theme_file_entity_file_type_overview($variables) {
+  return check_plain($variables['label']) . '<div class="description">' . $variables['description'] . '</div>';
+}
+
+/**
+ * Returns HTML for a file display's display order table.
+ */
+function theme_file_entity_file_display_order($variables) {
+  $element = $variables['element'];
+
+  $rows = array();
+  foreach (element_children($element, TRUE) as $name) {
+    $element[$name]['weight']['#attributes']['class'][] = 'file-display-order-weight';
+    $rows[] = array(
+      'data' => array(
+        drupal_render($element[$name]['label']),
+        drupal_render($element[$name]['weight']),
+      ),
+      'class' => array('draggable'),
+    );
+  }
+  $output = drupal_render_children($element);
+  $output .= theme('table', array('rows' => $rows, 'attributes' => array('id' => 'file-displays-order')));
+  drupal_add_tabledrag('file-displays-order', 'order', 'sibling', 'file-display-order-weight', NULL, NULL, TRUE);
+
+  return $output;
+}
+
+/**
+ * Form constructor for the file type settings form.
+ *
+ * @param object $type
+ *   The file type.
+ *
+ * @see file_entity_file_type_form_validate()
+ * @see file_entity_file_type_form_submit()
+ */
+function file_entity_file_type_form($form, &$form_state, $type = NULL) {
+  if (!isset($type->type)) {
+    // This is a new type.
+    $type = (object) array(
+      'type' => '',
+      'label' => '',
+      'description' => '',
+      'mimetypes' => array(),
+    );
+  }
+  $form['#file_type'] = $type;
+
+  $form['label'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Name'),
+    '#description' => t('This is the human readable name of the file type.'),
+    '#required' => TRUE,
+    '#default_value' => $type->label,
+  );
+
+  $form['type'] = array(
+    '#type' => 'machine_name',
+    '#default_value' => $type->type,
+    '#maxlength' => 255,
+    '#disabled' => (bool) $type->type,
+    '#machine_name' => array(
+      'exists' => 'file_type_load',
+      'source' => array('label'),
+    ),
+    '#description' => t('A unique machine-readable name for this file type. It must only contain lowercase letters, numbers, and underscores.'),
+  );
+
+  $form['description'] = array(
+    '#type' => 'textarea',
+    '#title' => t('Description'),
+    '#description' => t('This is the description of the file type.'),
+    '#default_value' => $type->description,
+  );
+
+  $form['mimetypes'] = array(
+    '#type' => 'textarea',
+    '#title' => t('Mimetypes'),
+    '#description' => t('Enter one mimetype per line.'),
+    '#default_value' => implode("\n", $type->mimetypes),
+  );
+
+  include_once DRUPAL_ROOT . '/includes/file.mimetypes.inc';
+  $mimetypes = file_mimetype_mapping();
+
+  $form['mimetype_mapping'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Mimetype List'),
+    '#collapsible' => TRUE,
+    '#collapsed' => TRUE,
+  );
+  $form['mimetype_mapping']['mapping'] = array(
+    '#theme' => 'item_list',
+    '#items' => $mimetypes['mimetypes'],
+  );
+
+  $form['actions'] = array('#type' => 'actions');
+
+  $form['actions']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save'),
+  );
+  if (!empty($type->type)) {
+    $form['actions']['delete'] = array(
+      '#type' => 'submit',
+      '#value' => t('Delete'),
+    );
+  }
+
+  return $form;
+}
+
+/**
+ * Form validation handler for file_entity_file_type_form().
+ *
+ * @see file_entity_file_type_form_submit()
+ */
+function file_entity_file_type_form_validate($form, &$form_state) {
+  include_once DRUPAL_ROOT . '/includes/file.mimetypes.inc';
+  $mimetype_mapping = file_mimetype_mapping();
+
+  $valid_mimetypes = $mimetype_mapping['mimetypes'];
+  $submitted_mimetypes = array_filter(array_map('trim', explode("\n", $form_state['values']['mimetypes'])));
+
+  $invalid_mimetypes = array();
+  foreach ($submitted_mimetypes as $mimetype) {
+    if (!file_entity_match_mimetypes($mimetype, $valid_mimetypes)) {
+      $invalid_mimetypes[] = $mimetype;
+    }
+  }
+
+  foreach ($invalid_mimetypes as $mimetype) {
+    form_set_error('mimetypes', t('The mimetype %mimetype is not a valid mimetype.', array('%mimetype' => $mimetype)));
+  }
+}
+
+/**
+ * Form submission handler for file_entity_file_type_form().
+ *
+ * @see file_entity_file_type_form_validate()
+ */
+function file_entity_file_type_form_submit($form, &$form_state) {
+  if (!empty($form['#file_type']->type)) {
+    $type = file_type_load($form['#file_type']->type);
+  }
+  else {
+    $type = (object) array(
+      'type' => $form_state['values']['type'],
+    );
+  }
+  if ($form_state['values']['op'] == t('Delete')) {
+    $form_state['redirect'] = 'admin/structure/file-types/manage/' . $type->type . '/delete';
+    return;
+  }
+  $type->label = $form_state['values']['label'];
+  $type->description = $form_state['values']['description'];
+  $type->mimetypes = array_filter(array_map('trim', explode("\n", $form_state['values']['mimetypes'])));
+
+  file_type_save($type);
+
+  drupal_set_message(t('The file type %type has been updated.', array('%type' => $type->label)));
+  $form_state['redirect'] = 'admin/structure/file-types';
+}
+
+
+/**
+ * Menu callback; disable a single file type.
+ */
+function file_entity_type_enable_confirm($form, &$form_state, $type) {
+  $form['type'] = array('#type' => 'value', '#value' => $type->type);
+  $form['label'] = array('#type' => 'value', '#value' => $type->label);
+  $message = t('Are you sure you want to enable the file type %type?', array('%type' => $type->label));
+  return confirm_form($form, $message, 'admin/structure/file-types', '', t('Enable'));
+}
+
+
+/**
+ * Process file type disable confirm submissions.
+ */
+function file_entity_type_enable_confirm_submit($form, &$form_state) {
+  file_type_enable($form_state['values']['type']);
+  $t_args = array('%label' => $form_state['values']['label']);
+  drupal_set_message(t('The file type %label has been enabled.', $t_args));
+  watchdog('file_entity', 'Enabled file type %label.', $t_args, WATCHDOG_NOTICE);
+  $form_state['redirect'] = 'admin/structure/file-types';
+  return;
+}
+
+
+/**
+ * Menu callback; disable a single file type.
+ */
+function file_entity_type_disable_confirm($form, &$form_state, $type) {
+  $form['type'] = array('#type' => 'value', '#value' => $type->type);
+  $form['label'] = array('#type' => 'value', '#value' => $type->label);
+
+  $message = t('Are you sure you want to disable the file type %type?', array('%type' => $type->label));
+  $caption = '';
+
+  $num_files = db_query("SELECT COUNT(*) FROM {file_managed} WHERE type = :type", array(':type' => $type->type))->fetchField();
+  if ($num_files) {
+    $caption .= '<p>' . format_plural($num_files, '%type is used by 1 file on
+      your site. If you disable this file type, you will not be able to edit
+      the %type file and it may not display correctly.', '%type is used by
+      @count files on your site. If you remove %type, you will not be able to
+      edit the %type file and it may not display correctly.',
+    array('%type' => $type->label)) . '</p>';
+  }
+
+  return confirm_form($form, $message, 'admin/structure/file-types', $caption, t('Disable'));
+}
+
+
+/**
+ * Process file type disable confirm submissions.
+ */
+function file_entity_type_disable_confirm_submit($form, &$form_state) {
+  file_type_disable($form_state['values']['type']);
+  $t_args = array('%label' => $form_state['values']['label']);
+  drupal_set_message(t('The file type %label has been disabled.', $t_args));
+  watchdog('file_entity', 'Disabled file type %label.', $t_args, WATCHDOG_NOTICE);
+  $form_state['redirect'] = 'admin/structure/file-types';
+  return;
+}
+
+
+/**
+ * Menu callback; revert a single file type.
+ */
+function file_entity_type_revert_confirm($form, &$form_state, $type) {
+  $form['type'] = array('#type' => 'value', '#value' => $type->type);
+  $form['label'] = array('#type' => 'value', '#value' => $type->label);
+  $message = t('Are you sure you want to revert the file type %type?', array('%type' => $type->label));
+  return confirm_form($form, $message, 'admin/structure/file-types', '', t('Revert'));
+}
+
+
+/**
+ * Process file type delete confirm submissions.
+ */
+function file_entity_type_revert_confirm_submit($form, &$form_state) {
+  // @NOTE deleting the file_type from the DB actually reverts it to code.
+  file_type_delete($form_state['values']['type']);
+  $t_args = array('%label' => $form_state['values']['label']);
+  drupal_set_message(t('The file type %label has been reverted.', $t_args));
+  watchdog('file_entity', 'Reverted file type %label.', $t_args, WATCHDOG_NOTICE);
+  $form_state['redirect'] = 'admin/structure/file-types';
+  return;
+}
+
+
+/**
+ * Menu callback; delete a single file type.
+ */
+function file_entity_type_delete_confirm($form, &$form_state, $type) {
+  $form['type'] = array('#type' => 'value', '#value' => $type->type);
+  $form['label'] = array('#type' => 'value', '#value' => $type->label);
+
+  $message = t('Are you sure you want to delete the file type %type?', array('%type' => $type->label));
+  $caption = '';
+
+  $num_files = db_query("SELECT COUNT(*) FROM {file_managed} WHERE type = :type", array(':type' => $type->type))->fetchField();
+  if ($num_files) {
+    $caption .= '<p>' . format_plural($num_files, '%type is used by 1 file on your site. If you remove this file type, you will not be able to edit the %type file and it may not display correctly.', '%type is used by @count pieces of file on your site. If you remove %type, you will not be able to edit the %type file and it may not display correctly.', array('%type' => $type->label)) . '</p>';
+  }
+
+  $caption .= '<p>' . t('This action cannot be undone.') . '</p>';
+
+  return confirm_form($form, $message, 'admin/structure/file-types', $caption, t('Delete'));
+}
+
+/**
+ * Process file type delete confirm submissions.
+ */
+function file_entity_type_delete_confirm_submit($form, &$form_state) {
+  file_type_delete($form_state['values']['type']);
+
+  $t_args = array('%label' => $form_state['values']['label']);
+  drupal_set_message(t('The file type %label has been deleted.', $t_args));
+  watchdog('file_entity', 'Deleted file type %label.', $t_args, WATCHDOG_NOTICE);
+
+  $form_state['redirect'] = 'admin/structure/file-types';
+  return;
+}
+
+/**
+ * Form callback for file_entity settings.
+ */
+function file_entity_settings_form($form, &$form_state) {
+  $form['file_entity_max_filesize'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Maximum upload size'),
+    '#default_value' => variable_get('file_entity_max_filesize', ''),
+    '#description' => t('Enter a value like "512" (bytes), "80 KB" (kilobytes) or "50 MB" (megabytes) in order to restrict the allowed file size. If left empty the file sizes will be limited only by PHP\'s maximum post and file upload sizes (current max limit <strong>%limit</strong>).', array('%limit' => format_size(file_upload_max_size()))),
+    '#size' => 10,
+    '#element_validate' => array('_file_generic_settings_max_filesize'),
+  );
+
+  $form['file_entity_default_allowed_extensions'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Default allowed file extensions'),
+    '#default_value' => variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'),
+    '#description' => t('Separate extensions with a space or comma and do not include the leading dot.'),
+  );
+
+  $form['file_entity_alt'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Alt attribute'),
+    '#description' => t('The text to use as value for the <em>img</em> tag <em>alt</em> attribute.'),
+    '#default_value' => variable_get('file_entity_alt', '[file:field_file_image_alt_text]'),
+  );
+  $form['file_entity_title'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Title attribute'),
+    '#description' => t('The text to use as value for the <em>img</em> tag <em>title</em> attribute.'),
+    '#default_value' => variable_get('file_entity_title', '[file:field_file_image_title_text]'),
+  );
+
+  // Provide default token values.
+  if (module_exists('token')) {
+    $form['token_help'] = array(
+      '#theme' => 'token_tree',
+      '#token_types' => array('file'),
+      '#dialog' => TRUE,
+    );
+    $form['file_entity_alt']['#description'] .= t('This field supports tokens.');
+    $form['file_entity_title']['#description'] .= t('This field supports tokens.');
+  }
+  $form['file_upload_wizard'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('File upload wizard'),
+    '#collapsible' => TRUE,
+    '#collapsed' => FALSE,
+    '#description' => t('Configure the steps available when uploading a new file.'),
+  );
+  $form['file_upload_wizard']['file_entity_file_upload_wizard_skip_file_type'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Skip filetype selection.'),
+    '#default_value' => variable_get('file_entity_file_upload_wizard_skip_file_type', FALSE),
+    '#description' => t('The file type selection step is only available if the uploaded file falls into two or more file types. If this step is skipped, files with no available file type or two or more file types will not be assigned a file type.'),
+  );
+  $form['file_upload_wizard']['file_entity_file_upload_wizard_skip_scheme'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Skip scheme selection.'),
+    '#default_value' => variable_get('file_entity_file_upload_wizard_skip_scheme', FALSE),
+    '#description' => t('The scheme selection step is only available if two or more file destinations, such as public local files served by the webserver and private local files served by Drupal, are available. If this step is skipped, files will automatically be saved using the default download method.'),
+  );
+  $form['file_upload_wizard']['file_entity_file_upload_wizard_skip_fields'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Skip available fields.'),
+    '#default_value' => variable_get('file_entity_file_upload_wizard_skip_fields', FALSE),
+    '#description' => t('The field selection step is only available if the file type the file belongs to has any available fields. If this step is skipped, any fields on the file will be left blank.'),
+  );
+
+  return system_settings_form($form);
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.admin.js b/profiles/commons/modules/contrib/file_entity/file_entity.admin.js
new file mode 100644
index 0000000..a8f83d9
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.admin.js
@@ -0,0 +1,44 @@
+(function ($) {
+
+Drupal.behaviors.fileDisplayStatus = {
+  attach: function (context, settings) {
+    $('#file-displays-status-wrapper input.form-checkbox', context).once('display-status', function () {
+      var $checkbox = $(this);
+      // Retrieve the tabledrag row belonging to this display.
+      var $row = $('#' + $checkbox.attr('id').replace(/-status$/, '-weight'), context).closest('tr');
+      // Retrieve the vertical tab belonging to this display.
+      var tab = $('#' + $checkbox.attr('id').replace(/-status$/, '-settings'), context).data('verticalTab');
+
+      // Bind click handler to this checkbox to conditionally show and hide the
+      // display's tableDrag row and vertical tab pane.
+      $checkbox.bind('click.displayStatusUpdate', function () {
+        if ($checkbox.is(':checked')) {
+          $row.show();
+          if (tab) {
+            tab.tabShow().updateSummary();
+          }
+        }
+        else {
+          $row.hide();
+          if (tab) {
+            tab.tabHide().updateSummary();
+          }
+        }
+        // Restripe table after toggling visibility of table row.
+        Drupal.tableDrag['file-displays-order'].restripeTable();
+      });
+
+      // Attach summary for configurable displays (only for screen-readers).
+      if (tab) {
+        tab.fieldset.drupalSetSummary(function (tabContext) {
+          return $checkbox.is(':checked') ? Drupal.t('Enabled') : Drupal.t('Disabled');
+        });
+      }
+
+      // Trigger our bound click handler to update elements to initial state.
+      $checkbox.triggerHandler('click.displayStatusUpdate');
+    });
+  }
+};
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.api.php b/profiles/commons/modules/contrib/file_entity/file_entity.api.php
new file mode 100644
index 0000000..9827446
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.api.php
@@ -0,0 +1,396 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by the File Entity module.
+ */
+
+/**
+ * Declare that your module provides default file types.
+ *
+ * Your module may already implement this hook for other CTools plugin types.
+ * If so, copy the body of this function into the existing hook.
+ */
+function hook_ctools_plugin_api($owner, $api) {
+  if ($owner == 'file_entity' && $api == 'file_type') {
+    return array('version' => 1);
+  }
+}
+
+/**
+ * Define default file types.
+ *
+ * File types are implemented as CTools exportables, so modules can alter the
+ * defaults via hook_file_default_types_alter(), and the administrator can
+ * save overridden and custom types to the {file_type} database table.
+ *
+ * @return array
+ *   An array whose keys are file type names and whose values are objects
+ *   representing the file type, with the following key/value pairs:
+ *   - api_version: The version of this data.
+ *   - type: The file type name.
+ *   - label: The human-readable name of the file type.
+ *   - description: The description of this file type.
+ *   - mimetypes: An array of mimetypes that this file type will map to.
+ */
+function hook_file_default_types() {
+  return array(
+    'image' => (object) array(
+      'api_version' => 1,
+      'type' => 'image',
+      'label' => t('Image'),
+      'description' => t("An <em>Image</em> is a two-dimensional picture that has a similar appearance to some subject, usually a physical object or a person."),
+      'mimetypes' => array(
+        'image/*',
+      ),
+    ),
+  );
+}
+
+/**
+ * Alter default file types.
+ *
+ * @see hook_file_default_types()
+ */
+function hook_file_default_types_alter(&$types) {
+  $types['image']->mimetypes[] = 'image/svg+xml';
+}
+
+/**
+ * Define file formatters.
+ *
+ * @return array
+ *   An array whose keys are file formatter names and whose values are arrays
+ *   describing the formatter.
+ *
+ * @todo Document key/value pairs that comprise a formatter.
+ *
+ * @see hook_file_formatter_info_alter()
+ */
+function hook_file_formatter_info() {
+  // @todo Add example.
+}
+
+/**
+ * Perform alterations on file formatters.
+ *
+ * @param array $info
+ *   Array of information on file formatters exposed by
+ *   hook_file_formatter_info() implementations.
+ */
+function hook_file_formatter_info_alter(&$info) {
+  // @todo Add example.
+}
+
+/**
+ * @todo Add documentation.
+ *
+ * Note: This is not really a hook. The function name is manually specified via
+ * 'view callback' in hook_file_formatter_info(), with this recommended callback
+ * name pattern.
+ */
+function hook_file_formatter_FORMATTER_view($file, $display, $langcode) {
+}
+
+/**
+ * @todo Add documentation.
+ *
+ * Note: This is not really a hook. The function name is manually specified via
+ * 'settings callback' in hook_file_formatter_info(), with this recommended
+ * callback name pattern.
+ */
+function hook_file_formatter_FORMATTER_settings($form, &$form_state, $settings) {
+}
+
+/**
+ * @todo Add documentation.
+ */
+function hook_file_displays_alter($displays, $file, $view_mode) {
+}
+
+/**
+ * @todo Add documentation.
+ */
+function hook_file_view($file, $view_mode, $langcode) {
+}
+
+/**
+ * @todo Add documentation.
+ */
+function hook_file_view_alter($build, $type) {
+}
+
+/**
+ * Add mass file operations.
+ *
+ * This hook enables modules to inject custom operations into the mass
+ * operations dropdown found at admin/content/file, by associating a callback
+ * function with the operation, which is called when the form is submitted. The
+ * callback function receives one initial argument, which is an array of the
+ * checked files.
+ *
+ * @return array
+ *   An array of operations. Each operation is an associative array that may
+ *   contain the following key-value pairs:
+ *   - 'label': Required. The label for the operation, displayed in the dropdown
+ *     menu.
+ *   - 'callback': Required. The function to call for the operation.
+ *   - 'callback arguments': Optional. An array of additional arguments to pass
+ *     to the callback function.
+ */
+function hook_file_operations() {
+  $operations = array(
+    'delete' => array(
+      'label' => t('Delete selected files'),
+      'callback' => NULL,
+    ),
+  );
+  return $operations;
+}
+
+/**
+ * Control access to a file.
+ *
+ * Modules may implement this hook if they want to have a say in whether or not
+ * a given user has access to perform a given operation on a file.
+ *
+ * The administrative account (user ID #1) always passes any access check,
+ * so this hook is not called in that case. Users with the "bypass file access"
+ * permission may always view and edit files through the administrative
+ * interface.
+ *
+ * Note that not all modules will want to influence access on all
+ * file types. If your module does not want to actively grant or
+ * block access, return FILE_ENTITY_ACCESS_IGNORE or simply return nothing.
+ * Blindly returning FALSE will break other file access modules.
+ *
+ * @param string $op
+ *   The operation to be performed. Possible values:
+ *   - "create"
+ *   - "delete"
+ *   - "update"
+ *   - "view"
+ *   - "download"
+ * @param object $file
+ *   The file on which the operation is to be performed, or, if it does
+ *   not yet exist, the type of file to be created.
+ * @param object $account
+ *   A user object representing the user for whom the operation is to be
+ *   performed.
+ *
+ * @return string|NULL
+ *   FILE_ENTITY_ACCESS_ALLOW if the operation is to be allowed;
+ *   FILE_ENTITY_ACCESS_DENY if the operation is to be denied;
+ *   FILE_ENTITY_ACCESS_IGNORE to not affect this operation at all.
+ *
+ * @ingroup file_entity_access
+ */
+function hook_file_entity_access($op, $file, $account) {
+  $type = is_string($file) ? $file : $file->type;
+
+  if ($op !== 'create' && (REQUEST_TIME - $file->timestamp) < 3600) {
+    // If the file was uploaded in the last hour, deny access to it.
+    return FILE_ENTITY_ACCESS_DENY;
+  }
+
+  // Returning nothing from this function would have the same effect.
+  return FILE_ENTITY_ACCESS_IGNORE;
+}
+
+/**
+ * Control access to listings of files.
+ *
+ * @param object $query
+ *   A query object describing the composite parts of a SQL query related to
+ *   listing files.
+ *
+ * @see hook_query_TAG_alter()
+ * @ingroup file_entity_access
+ */
+function hook_query_file_entity_access_alter(QueryAlterableInterface $query) {
+  // Only show files that have been uploaded more than an hour ago.
+  $query->condition('timestamp', REQUEST_TIME - 3600, '<=');
+}
+
+/**
+ * Act on a file being displayed as a search result.
+ *
+ * This hook is invoked from file_entity_search_execute(), after file_load()
+ * and file_view() have been called.
+ *
+ * @param object $file
+ *   The file being displayed in a search result.
+ *
+ * @return array
+ *   Extra information to be displayed with search result. This information
+ *   should be presented as an associative array. It will be concatenated
+ *   with the file information (filename) in the default search result theming.
+ *
+ * @see template_preprocess_search_result()
+ * @see search-result.tpl.php
+ *
+ * @ingroup file_entity_api_hooks
+ */
+function hook_file_entity_search_result($file) {
+  $file_usage_count = db_query('SELECT count FROM {file_usage} WHERE fid = :fid', array('fid' => $file->fid))->fetchField();
+  return array(
+    'file_usage_count' => format_plural($file_usage_count, '1 use', '@count uses'),
+  );
+}
+
+/**
+ * Act on a file being indexed for searching.
+ *
+ * This hook is invoked during search indexing, after file_load(), and after
+ * the result of file_view() is added as $file->rendered to the file object.
+ *
+ * @param object $file
+ *   The file being indexed.
+ *
+ * @return string
+ *   Additional file information to be indexed.
+ *
+ * @ingroup file_entity_api_hooks
+ */
+function hook_file_update_index($file) {
+  $text = '';
+  $uses = db_query('SELECT module, count FROM {file_usage} WHERE fid = :fid', array(':fid' => $file->fid));
+  foreach ($uses as $use) {
+    $text .= '<h2>' . check_plain($use->module) . '</h2>' . check_plain($use->count);
+  }
+  return $text;
+}
+
+/**
+ * Provide additional methods of scoring for core search results for files.
+ *
+ * A file's search score is used to rank it among other files matched by the
+ * search, with the highest-ranked files appearing first in the search listing.
+ *
+ * For example, a module allowing users to vote on files could expose an
+ * option to allow search results' rankings to be influenced by the average
+ * voting score of a file.
+ *
+ * All scoring mechanisms are provided as options to site administrators, and
+ * may be tweaked based on individual sites or disabled altogether if they do
+ * not make sense. Individual scoring mechanisms, if enabled, are assigned a
+ * weight from 1 to 10. The weight represents the factor of magnification of
+ * the ranking mechanism, with higher-weighted ranking mechanisms having more
+ * influence. In order for the weight system to work, each scoring mechanism
+ * must return a value between 0 and 1 for every file. That value is then
+ * multiplied by the administrator-assigned weight for the ranking mechanism,
+ * and then the weighted scores from all ranking mechanisms are added, which
+ * brings about the same result as a weighted average.
+ *
+ * @return array
+ *   An associative array of ranking data. The keys should be strings,
+ *   corresponding to the internal name of the ranking mechanism, such as
+ *   'recent', or 'usage'. The values should be arrays themselves, with the
+ *   following keys available:
+ *   - "title": the human readable name of the ranking mechanism. Required.
+ *   - "join": part of a query string to join to any additional necessary
+ *     table. This is not necessary if the table required is already joined to
+ *     by the base query, such as for the {file_managed} table. Other tables
+ *     should use the full table name as an alias to avoid naming collisions.
+ *     Optional.
+ *   - "score": part of a query string to calculate the score for the ranking
+ *     mechanism based on values in the database. This does not need to be
+ *     wrapped in parentheses, as it will be done automatically; it also does
+ *     not need to take the weighted system into account, as it will be done
+ *     automatically. It does, however, need to calculate a decimal between
+ *     0 and 1; be careful not to cast the entire score to an integer by
+ *     inadvertently introducing a variable argument. Required.
+ *   - "arguments": if any arguments are required for the score, they can be
+ *     specified in an array here.
+ *
+ * @ingroup file_entity_api_hooks
+ */
+function hook_file_ranking() {
+  // If voting is disabled, we can avoid returning the array, no hard feelings.
+  if (variable_get('vote_file_enabled', TRUE)) {
+    return array(
+      'vote_average' => array(
+        'title' => t('Average vote'),
+        // Note that we use i.sid, the search index's search item id, rather
+        // than fm.fid.
+        'join' => 'LEFT JOIN {vote_file_data} vote_file_data ON vote_file_data.fid = i.sid',
+        // The highest possible score should be 1,
+        // and the lowest possible score, always 0, should be 0.
+        'score' => 'vote_file_data.average / CAST(%f AS DECIMAL)',
+        // Pass in the highest possible voting score as a decimal argument.
+        'arguments' => array(variable_get('vote_score_max', 5)),
+      ),
+    );
+  }
+}
+
+/**
+ * Alter file download headers.
+ *
+ * @param array $headers
+ *   Array of download headers.
+ * @param object $file
+ *   File object.
+ */
+function hook_file_download_headers_alter(array &$headers, $file) {
+  // Instead of being powered by PHP, tell the world this resource was powered
+  // by your custom module!
+  $headers['X-Powered-By'] = 'My Module';
+}
+
+/**
+ * Decides which file type (bundle) should be assigned to a file entity.
+ *
+ * @param object $file
+ *   File object.
+ *
+ * @return array
+ *   Array of file type machine names that can be assigned to a given file type.
+ *   If there are more proposed file types the one, that was returned the first,
+ *   wil be chosen. This can be, however, changed in alter hook.
+ *
+ * @see hook_file_type_alter()
+ */
+function hook_file_type($file) {
+  // Assign all files uploaded by anonymous users to a special file type.
+  if (user_is_anonymous()) {
+    return array('untrusted_files');
+  }
+}
+
+/**
+ * Alters list of file types that can be assigned to a file.
+ *
+ * @param array $types
+ *   List of proposed types.
+ * @param object $file
+ *   File object.
+ */
+function hook_file_type_alter(&$types, $file) {
+  // Choose a specific, non-first, file type.
+  $types = array($types[4]);
+}
+
+/**
+ * Provides metadata information.
+ *
+ * @todo Add documentation.
+ *
+ * @return array
+ *   An array of metadata information.
+ */
+function hook_file_metadata_info() {
+
+}
+
+/**
+ * Alters metadata information.
+ *
+ * @todo Add documentation.
+ *
+ * @return array
+ *   an array of metadata information.
+ */
+function hook_file_metadata_info_alter() {
+
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.field.inc b/profiles/commons/modules/contrib/file_entity/file_entity.field.inc
new file mode 100644
index 0000000..97f3c28
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.field.inc
@@ -0,0 +1,397 @@
+<?php
+
+/**
+ * @file
+ * Field API integration for the file_entity module.
+ */
+
+/**
+ * Implements hook_field_formatter_info().
+ */
+function file_entity_field_formatter_info() {
+  $info['file_rendered'] = array(
+    'label' => t('Rendered file'),
+    'description' => t('Display the file in a specific view mode'),
+    'field types' => array('file', 'image'),
+    'settings' => array(
+      'file_view_mode' => 'default',
+    ),
+    'file formatter' => array(
+      'hidden' => TRUE,
+    ),
+  );
+  $info['file_download_link'] = array(
+    'label' => t('Download link'),
+    'description' => t('Displays a link that will force the browser to download the file.'),
+    'field types' => array('file', 'image'),
+    'settings' => array(
+      'text' => t('Download [file:name]'),
+    ),
+  );
+  $info['file_audio'] = array(
+    'label' => t('Audio'),
+    'description' => t('Render the file using an HTML5 audio tag.'),
+    'field types' => array('file'),
+    'settings' => array(
+      'controls' => TRUE,
+      'autoplay' => FALSE,
+      'loop' => FALSE,
+      'multiple_file_behavior' => 'tags',
+    ),
+    'file formatter' => array(
+      'mime types' => array('audio/*'),
+    ),
+  );
+  $info['file_video'] = array(
+    'label' => t('Video'),
+    'description' => t('Render the file using an HTML5 video tag.'),
+    'field types' => array('file'),
+    'settings' => array(
+      'controls' => TRUE,
+      'autoplay' => FALSE,
+      'loop' => FALSE,
+      'muted' => FALSE,
+      'width' => NULL,
+      'height' => NULL,
+      'multiple_file_behavior' => 'tags',
+    ),
+    'file formatter' => array(
+      'mime types' => array('video/*'),
+    ),
+  );
+  return $info;
+}
+
+/**
+ * Implements hook_field_formatter_info_alter().
+ */
+function file_entity_field_formatter_info_alter(&$info) {
+  // Add descriptions to core formatters.
+  $descriptions = array(
+    'file_default' => t('Create a simple link to the file. The link is prefixed by a file type icon and the name of the file is used as the link text'),
+    'file_table' => t('Build a two-column table where the first column contains a generic link to the file and the second column displays the size of the file.'),
+    'file_url_plain' => t('Display a plain text URL to the file.'),
+    'image' => t('Format the file as an image. The image can be displayed using an image style and can optionally be linked to the image file itself or its parent content.'),
+  );
+  foreach ($descriptions as $key => $description) {
+    if (isset($info[$key]) && empty($info[$key]['description'])) {
+      $info[$key]['description'] = $description;
+    }
+  }
+
+  // Formatters that can be used for images but not files, should have a
+  // default mimetype restriction added to the image/* mime type for use with
+  // file formatters.
+  foreach ($info as &$formatter) {
+    if (!isset($formatter['file formatter']) && in_array('image', $formatter['field types']) && !in_array('file', $formatter['field types'])) {
+      $formatter['file formatter']['mime types'] = array('image/*');
+    }
+  }
+}
+
+/**
+ * Implements hook_field_formatter_settings_form().
+ */
+function file_entity_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+  $element = array();
+
+  if ($display['type'] == 'file_rendered') {
+    $element['file_view_mode'] = array(
+      '#title'   => t('View mode'),
+      '#type'    => 'select',
+      '#options' => file_entity_view_mode_labels(),
+      '#default_value' => $settings['file_view_mode'],
+      // Never empty, so no #empty_option
+    );
+  }
+  elseif ($display['type'] == 'file_download_link') {
+    $element['text'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Link text'),
+      '#description' => t('This field support tokens.'),
+      '#default_value' => $settings['text'],
+      '#required' => TRUE,
+    );
+  }
+  elseif ($display['type'] == 'file_audio') {
+    $element['controls'] = array(
+      '#title' => t('Show audio controls'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['controls'],
+    );
+    $element['autoplay'] = array(
+      '#title' => t('Autoplay'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['autoplay'],
+    );
+    $element['loop'] = array(
+      '#title' => t('Loop'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['loop'],
+    );
+    $element['multiple_file_behavior'] = array(
+      '#title' => t('Display of multiple files'),
+      '#type' => 'radios',
+      '#options' => array(
+        'tags' => t('Use multiple @tag tags, each with a single source', array('@tag' => '<audio>')),
+        'sources' => t('Use multiple sources within a single @tag tag', array('@tag' => '<audio>')),
+      ),
+      '#default_value' => $settings['multiple_file_behavior'],
+      // Hide this setting in the manage file display configuration.
+      '#access' => !empty($field),
+    );
+
+  }
+  elseif ($display['type'] == 'file_video') {
+    $element['controls'] = array(
+      '#title' => t('Show video controls'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['controls'],
+    );
+    $element['autoplay'] = array(
+      '#title' => t('Autoplay'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['autoplay'],
+    );
+    $element['loop'] = array(
+      '#title' => t('Loop'),
+      '#type' => 'checkbox',
+      '#default_value' => $settings['loop'],
+    );
+    $element['width'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Width'),
+      '#default_value' => $settings['width'],
+      '#size' => 5,
+      '#maxlength' => 5,
+      '#field_suffix' => t('pixels'),
+    );
+    $element['height'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Height'),
+      '#default_value' => $settings['height'],
+      '#size' => 5,
+      '#maxlength' => 5,
+      '#field_suffix' => t('pixels'),
+    );
+    $element['multiple_file_behavior'] = array(
+      '#title' => t('Display of multiple files'),
+      '#type' => 'radios',
+      '#options' => array(
+        'tags' => t('Use multiple @tag tags, each with a single source', array('@tag' => '<video>')),
+        'sources' => t('Use multiple sources within a single @tag tag', array('@tag' => '<video>')),
+      ),
+      '#default_value' => $settings['multiple_file_behavior'],
+      // Hide this setting in the manage file display configuration.
+      '#access' => !empty($field),
+    );
+  }
+
+  return $element;
+}
+
+/**
+ * Implements hook_field_formatter_settings_summary().
+ */
+function file_entity_field_formatter_settings_summary($field, $instance, $view_mode) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+  $summary = array();
+
+  if ($display['type'] === 'file_rendered') {
+    $view_mode_label = file_entity_view_mode_label($settings['file_view_mode'], t('Unknown'));
+    $summary[] = t('View mode: %mode', array('%mode' => $view_mode_label));
+  }
+  elseif ($display['type'] == 'file_download_link') {
+    $summary[] = t('Link text: %text', array('%text' => $settings['text']));
+  }
+  elseif ($display['type'] === 'file_audio') {
+    if (isset($settings['controls'])) {
+      $summary[] = t('Controls: %controls', array('%controls' => $settings['controls'] ? 'visible' : 'hidden'));
+    }
+    if (isset($settings['autoplay'])) {
+      $summary[] = t('Autoplay: %autoplay', array('%autoplay' => $settings['autoplay'] ? t('yes') : t('no')));
+    }
+    if (isset($settings['loop'])) {
+      $summary[] = t('Loop: %loop', array('%loop' => $settings['loop'] ? t('yes') : t('no')));
+    }
+    if (isset($settings['multiple_file_behavior'])) {
+      $summary[] = t('Multiple files: %multiple', array('%multiple' => $settings['multiple_file_behavior']));
+    }
+
+  }
+  elseif ($display['type'] === 'file_video') {
+    $summary_items = array();
+    if (isset($settings['controls'])) {
+      $summary[] = t('Controls: %controls', array('%controls' => $settings['controls'] ? 'visible' : 'hidden'));
+    }
+    if (isset($settings['autoplay'])) {
+      $summary[] = t('Autoplay: %autoplay', array('%autoplay' => $settings['autoplay'] ? t('yes') : t('no')));
+    }
+    if (isset($settings['loop'])) {
+      $summary[] = t('Loop: %loop', array('%loop' => $settings['loop'] ? t('yes') : t('no')));
+    }
+    if (isset($settings['muted'])) {
+      $summary[] = t('Muted: %muted', array('%muted' => $settings['muted'] ? t('yes') : t('no')));
+    }
+    if ($settings['width'] && $settings['height']) {
+      $summary[] = t('Size: %width x %height', array('%width' => $settings['width'], '%height' => $settings['height']));
+    }
+    if (isset($settings['multiple_file_behavior'])) {
+      $summary[] = t('Multiple files: %multiple', array('%multiple' => $settings['multiple_file_behavior']));
+    }
+  }
+
+  return implode('<br />', $summary);
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ */
+function file_entity_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $settings = $display['settings'];
+  $element = array();
+
+  if ($display['type'] == 'file_rendered') {
+    $view_mode = $settings['file_view_mode'];
+
+    // To prevent infinite recursion caused by reference cycles, we store
+    // diplayed nodes in a recursion queue.
+    $recursion_queue = &drupal_static(__FUNCTION__, array());
+
+    // If no 'referencing entity' is set, we are starting a new 'reference
+    // thread' and need to reset the queue.
+    // @todo Bug: $entity->referencing_entity on files referenced in a different
+    // thread on the page.
+    // E.g: 1 references 1+2 / 2 references 1+2 / visit homepage.
+    // We'd need a more accurate way...
+    if (!isset($entity->referencing_entity)) {
+      $recursion_queue = array();
+    }
+
+    // The recursion queue only needs to track files.
+    if ($entity_type == 'file') {
+      list($id) = entity_extract_ids($entity_type, $entity);
+      $recursion_queue[$id] = $id;
+    }
+
+    // Prevent 'empty' fields from causing a WSOD.
+    $items = array_filter($items);
+
+    // Check the recursion queue to determine which nodes should be fully
+    // displayed, and which nodes will only be displayed as a title.
+    $files_display = array();
+    foreach ($items as $delta => $item) {
+      if (!isset($recursion_queue[$item['fid']])) {
+        $files_display[$item['fid']] = file_load($item['fid']);
+      }
+    }
+
+    // Load and build the fully displayed nodes.
+    if ($files_display) {
+      foreach ($files_display as $fid => $file) {
+        $files_display[$fid]->referencing_entity = $entity;
+        $files_display[$fid]->referencing_field = $field['field_name'];
+      }
+      $output = file_view_multiple($files_display, $view_mode);
+      // Remove the first level from the output array.
+      $files_built = reset($output);
+    }
+
+    // Assemble the render array.
+    foreach ($items as $delta => $item) {
+      if (isset($files_built[$item['fid']])) {
+        $element[$delta] = $files_built[$item['fid']];
+      }
+    }
+  }
+  elseif ($display['type'] == 'file_download_link') {
+    foreach ($items as $delta => $item) {
+      $file = (object) $item;
+      if (file_entity_access('download', $file)) {
+        $element[$delta] = array(
+          '#theme' => 'file_entity_download_link',
+          '#file' => $file,
+          '#text' => $settings['text'],
+        );
+      }
+    }
+  }
+  elseif ($display['type'] == 'file_audio') {
+    $multiple_file_behavior = $settings['multiple_file_behavior'];
+
+    // Prevent 'empty' fields from causing a WSOD.
+    $items = array_filter($items);
+
+    // Build an array of sources for each <audio> element.
+    $source_lists = array();
+    if ($multiple_file_behavior == 'tags') {
+      foreach ($items as $delta => $item) {
+        if ($item['type'] == 'audio') {
+          $source_lists[] = array($item);
+        }
+      }
+    }
+    else {
+      foreach ($items as $delta => $item) {
+        if ($item['type'] == 'audio') {
+          $source_lists[0][] = $item;
+        }
+      }
+    }
+
+    // Render each source list as an <audio> element.
+    foreach ($source_lists as $delta => $sources) {
+      $element[$delta] = array(
+        '#theme' => 'file_entity_file_audio',
+        '#files' => $sources,
+        '#controls' => $settings['controls'],
+        '#autoplay' => $settings['autoplay'],
+        '#loop' => $settings['loop'],
+      );
+    }
+  }
+  elseif ($display['type'] == 'file_video') {
+    $multiple_file_behavior = $settings['multiple_file_behavior'];
+
+    // Prevent 'empty' fields from causing a WSOD.
+    $items = array_filter($items);
+
+    // Build an array of sources for each <video> element.
+    $source_lists = array();
+    if ($multiple_file_behavior == 'tags') {
+      foreach ($items as $delta => $item) {
+        if ($item['type'] == 'video') {
+          $source_lists[] = array($item);
+        }
+      }
+    }
+    else {
+      foreach ($items as $delta => $item) {
+        if ($item['type'] == 'video') {
+          $source_lists[0][] = $item;
+        }
+      }
+    }
+
+    // Render each source list as an <video> element.
+    foreach ($source_lists as $delta => $sources) {
+      $width = $settings['width'];
+      $height = $settings['height'];
+      $element[$delta] = array(
+        '#theme' => 'file_entity_file_video',
+        '#files' => $sources,
+        '#controls' => $settings['controls'],
+        '#autoplay' => $settings['autoplay'],
+        '#loop' => $settings['loop'],
+        '#muted' => $settings['muted'],
+        '#width' => ($width && $height) ? $width : NULL,
+        '#height' => ($width && $height) ? $height : NULL,
+      );
+    }
+  }
+
+  return $element;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.file.inc b/profiles/commons/modules/contrib/file_entity/file_entity.file.inc
new file mode 100644
index 0000000..d5cfadc
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.file.inc
@@ -0,0 +1,313 @@
+<?php
+
+/**
+ * @file
+ * File hooks implemented by the File entity module.
+ */
+
+/**
+ * Implements hook_file_presave().
+ */
+function file_entity_file_presave($file) {
+  // Always ensure the filemime property is current.
+  if (!empty($file->original) || empty($file->filemime)) {
+    $file->filemime = file_get_mimetype($file->uri);
+  }
+
+  // The file type is used as a bundle key, and therefore, must not be NULL.
+  // It defaults to FILE_TYPE_NONE when loaded via file_load(), but in case
+  // file_save() is called on a new file object, default it here too.
+  if (!isset($file->type)) {
+    $file->type = FILE_TYPE_NONE;
+  }
+
+  // If the file isn't already assigned a real type, determine what type should
+  // be assigned to it.
+  if ($file->type === FILE_TYPE_NONE) {
+    $type = file_get_type($file);
+    if (isset($type)) {
+      $file->type = $type;
+    }
+  }
+
+  field_attach_presave('file', $file);
+
+  // Fetch image dimensions.
+  file_entity_metadata_fetch_image_dimensions($file);
+}
+
+/**
+ * Implements hook_file_type().
+ */
+function file_entity_file_type($file) {
+  $types = array();
+  foreach (file_type_get_enabled_types() as $type) {
+    if (file_entity_match_mimetypes($type->mimetypes, $file->filemime)) {
+      $types[] = $type->type;
+    }
+  }
+
+  return $types;
+}
+
+/**
+ * Implements hook_file_insert().
+ */
+function file_entity_file_insert($file) {
+  // Ensure field data is saved since file_save() does not in Drupal 7.
+  field_attach_insert('file', $file);
+
+  // Save file metadata.
+  if (!empty($file->metadata)) {
+    foreach ($file->metadata as $name => $value) {
+      db_merge('file_metadata')
+        ->fields(array(
+          'value' => serialize($value),
+        ))
+        ->key(array(
+          'fid' => $file->fid,
+          'name' => $name,
+        ))
+        ->execute();
+    }
+  }
+
+  // Clear any related field caches.
+  file_entity_invalidate_field_caches($file);
+}
+
+/**
+ * Implements hook_file_update().
+ */
+function file_entity_file_update($file) {
+  // Ensure field data is saved since file_save() does not in Drupal 7.
+  field_attach_update('file', $file);
+
+  // Save file metadata.
+  if (!empty($file->metadata)) {
+    foreach ($file->metadata as $name => $value) {
+      db_merge('file_metadata')
+        ->fields(array(
+          'value' => serialize($value),
+        ))
+        ->key(array(
+          'fid' => $file->fid,
+          'name' => $name,
+        ))
+        ->execute();
+    }
+  }
+
+  // Save file metadata.
+  db_delete('file_metadata')->condition('fid', $file->fid);
+  if (!empty($file->metadata)) {
+    foreach ($file->metadata as $name => $value) {
+      db_merge('file_metadata')
+        ->fields(array(
+          'value' => serialize($value),
+        ))
+        ->key(array(
+          'fid' => $file->fid,
+          'name' => $name,
+        ))
+        ->execute();
+    }
+  }
+
+  if (file_entity_file_get_mimetype_type($file) == 'image' && module_exists('image')) {
+    // If the image dimensions have changed, update any image field references
+    // to this file and flush image style derivatives.
+    if ($file->metadata['width'] != $file->metadata['width'] || $file->metadata['height'] != $file->metadata['height']) {
+      _file_entity_update_image_field_dimensions($file);
+    }
+
+    // Flush image style derivatives whenever an image is updated.
+    image_path_flush($file->uri);
+  }
+
+  // Clear any related field caches.
+  file_entity_invalidate_field_caches($file);
+}
+
+/**
+ * Implements hook_file_delete().
+ */
+function file_entity_file_delete($file) {
+  field_attach_delete('file', $file);
+
+  // This is safe to call since the file's records from the usage table have
+  // not yet been deleted.
+  file_entity_invalidate_field_caches($file);
+
+  // Remove file metadata.
+  db_delete('file_metadata')->condition('fid', $file->fid)->execute();
+
+  // Remove this file from the search index if needed.
+  // This code is implemented in file entity module rather than in search
+  // module because file entity is implementing search module's API, not the
+  // other way around.
+  if (module_exists('search')) {
+    search_reindex($file->fid, 'file');
+  }
+}
+
+/**
+ * Implements hook_file_mimetype_mapping_alter().
+ */
+function file_entity_file_mimetype_mapping_alter(&$mapping) {
+  // Add support for mka and mkv.
+  // @todo Remove when http://drupal.org/node/1443070 is fixed in core.
+  $new_mappings['mka'] = 'audio/x-matroska';
+  $new_mappings['mkv'] = 'video/x-matroska';
+
+  // Add support for weba, webm, and webp.
+  // @todo Remove when http://drupal.org/node/1443070 is fixed in core.
+  $new_mappings['weba'] = 'audio/webm';
+  $new_mappings['webm'] = 'video/webm';
+  $new_mappings['webp'] = 'image/webp';
+
+  foreach ($new_mappings as $extension => $mime_type) {
+    if (!in_array($mime_type, $mapping['mimetypes'])) {
+      // If the mime type does not already exist, add it.
+      $mapping['mimetypes'][] = $mime_type;
+    }
+
+    // Get the index of the mime type and assign the extension to that key.
+    $index = array_search($mime_type, $mapping['mimetypes']);
+    $mapping['extensions'][$extension] = $index;
+  }
+}
+
+/**
+ * Implements hook_file_load().
+ */
+function file_entity_file_load($files) {
+  $alt = variable_get('file_entity_alt', '[file:field_file_image_alt_text]');
+  $title = variable_get('file_entity_title', '[file:field_file_image_title_text]');
+
+  $replace_options = array(
+    'clear' => TRUE,
+    'sanitize' => FALSE,
+  );
+
+  foreach ($files as $file) {
+    $file->metadata = array();
+
+    // Load alt and title text from fields.
+    if (!empty($alt)) {
+      $file->alt = token_replace($alt, array('file' => $file), $replace_options);
+    }
+    if (!empty($title)) {
+      $file->title = token_replace($title, array('file' => $file), $replace_options);
+    }
+  }
+
+  // Load and unserialize metadata.
+  $results = db_query("SELECT * FROM {file_metadata} WHERE fid IN (:fids)", array(':fids' => array_keys($files)));
+  foreach ($results as $result) {
+    $files[$result->fid]->metadata[$result->name] = unserialize($result->value);
+  }
+}
+
+/**
+ * Fetch the dimensions of an image and store them in the file metadata array.
+ */
+function file_entity_metadata_fetch_image_dimensions($file) {
+  // Prevent PHP notices when trying to read empty files.
+  // @see http://drupal.org/node/681042
+  if (!$file->filesize) {
+    return;
+  }
+
+  // Do not bother proceeding if this file does not have an image mime type.
+  if (file_entity_file_get_mimetype_type($file) != 'image') {
+    return;
+  }
+
+  // We have a non-empty image file.
+  $image_info = image_get_info($file->uri);
+  if ($image_info) {
+    $file->metadata['width'] = $image_info['width'];
+    $file->metadata['height'] = $image_info['height'];
+  }
+  else {
+    // Fallback to NULL values.
+    $file->metadata['width'] = NULL;
+    $file->metadata['height'] = NULL;
+  }
+}
+
+/**
+ * Update the image dimensions stored in any image fields for a file.
+ *
+ * @param object $file
+ *   A file object that is an image.
+ *
+ * @see http://drupal.org/node/1448124
+ */
+function _file_entity_update_image_field_dimensions($file) {
+  // Do not bother proceeding if this file does not have an image mime type.
+  if (file_entity_file_get_mimetype_type($file) != 'image') {
+    return;
+  }
+
+  // Find all image field enabled on the site.
+  $image_fields = _file_entity_get_fields_by_type('image');
+
+  foreach ($image_fields as $image_field) {
+    $query = new EntityFieldQuery();
+    $query->fieldCondition($image_field, 'fid', $file->fid);
+    $results = $query->execute();
+
+    foreach ($results as $entity_type => $entities) {
+      $entities = entity_load($entity_type, array_keys($entities));
+      foreach ($entities as $entity) {
+        foreach ($entity->{$image_field} as $langcode => $items) {
+          foreach ($items as $delta => $item) {
+            if ($item['fid'] == $file->fid) {
+              $entity->{$image_field}[$langcode][$delta]['width'] = $file->metadata['width'];
+              $entity->{$image_field}[$langcode][$delta]['height'] = $file->metadata['height'];
+            }
+          }
+        }
+
+        // Save the updated field column values.
+        _file_entity_entity_fields_update($entity_type, $entity);
+      }
+    }
+  }
+}
+
+/**
+ * Update an entity's field values without changing anything on the entity.
+ */
+function _file_entity_entity_fields_update($entity_type, $entity) {
+  list($id) = entity_extract_ids($entity_type, $entity);
+  if (empty($id)) {
+    throw new Exception(t('Cannot call _file_entity_update_entity_fields() on a new entity.'));
+  }
+
+  // Some modules use the original property.
+  if (!isset($entity->original)) {
+    $entity->original = $entity;
+  }
+
+  // Ensure that file_field_update() will not trigger additional usage.
+  unset($entity->revision);
+
+  // Invoke the field presave and update hooks.
+  field_attach_presave($entity_type, $entity);
+  field_attach_update($entity_type, $entity);
+
+  // Clear the cache for this entity now.
+  entity_get_controller($entity_type)->resetCache(array($id));
+}
+
+/**
+ * Implements hook_file_metadata_info().
+ */
+function file_entity_file_metadata_info() {
+  $info['width'] = array('label' => t('Width'), 'type' => 'integer');
+  $info['height'] = array('label' => t('Height'), 'type' => 'integer');
+  return $info;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.file_api.inc b/profiles/commons/modules/contrib/file_entity/file_entity.file_api.inc
new file mode 100644
index 0000000..9baa1a4
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.file_api.inc
@@ -0,0 +1,764 @@
+<?php
+
+/**
+ * @file
+ * API extensions of Drupal core's file.inc.
+ */
+
+/**
+ * The {file_managed}.type value when the file type has not yet been determined.
+ */
+define('FILE_TYPE_NONE', 'undefined');
+
+/**
+ * Returns information about file formatters from hook_file_formatter_info().
+ *
+ * @param string $formatter_type
+ *   (optional) A file formatter type name. If ommitted, all file formatter
+ *   will be returned.
+ *
+ * @return string|array
+ *   Either a file formatter description, as provided by
+ *   hook_file_formatter_info(), or an array of all existing file formatters,
+ *   keyed by formatter type name.
+ */
+function file_info_formatter_types($formatter_type = NULL) {
+  $info = &drupal_static(__FUNCTION__);
+  if (!isset($info)) {
+    $info = module_invoke_all('file_formatter_info');
+    drupal_alter('file_formatter_info', $info);
+    uasort($info, '_file_entity_sort_weight_label');
+  }
+  if ($formatter_type) {
+    if (isset($info[$formatter_type])) {
+      return $info[$formatter_type];
+    }
+  }
+  else {
+    return $info;
+  }
+}
+
+/**
+ * Clears caches that are related to file entity.
+ *
+ * Clears all cached configuration related to file types, formatters, and
+ * display settings.
+ */
+function file_info_cache_clear() {
+  // Clear the CTools managed caches.
+  ctools_include('export');
+  ctools_export_load_object_reset('file_type');
+  ctools_export_load_object_reset('file_display');
+
+  // Clear the formatter type cache, managed by file_info_formatter_types().
+  drupal_static_reset('file_info_formatter_types');
+
+  // Clear file type caches.
+  drupal_static_reset('file_type_get_names');
+}
+
+/**
+ * Construct a drupal_render() style array from an array of loaded files.
+ *
+ * @param array $files
+ *   An array of files as returned by file_load_multiple().
+ * @param string $view_mode
+ *   View mode.
+ * @param int $weight
+ *   An integer representing the weight of the first file in the list.
+ * @param string $langcode
+ *   A string indicating the language field values are to be shown in. If no
+ *   language is provided the current content language is used.
+ *
+ * @return array
+ *   An array in the format expected by drupal_render().
+ */
+function file_view_multiple($files, $view_mode = 'full', $weight = 0, $langcode = NULL) {
+  if (empty($files)) {
+    return array();
+  }
+
+  field_attach_prepare_view('file', $files, $view_mode, $langcode);
+  entity_prepare_view('file', $files, $langcode);
+
+  $build = array();
+  foreach ($files as $file) {
+    $build['files'][$file->fid] = file_view($file, $view_mode, $langcode);
+    $build['files'][$file->fid]['#weight'] = $weight;
+    $weight++;
+  }
+  $build['files']['#sorted'] = TRUE;
+
+  return $build;
+}
+
+/**
+ * Generate an array for rendering the given file.
+ *
+ * @param object $file
+ *   A file object.
+ * @param string $view_mode
+ *   View mode.
+ * @param string $langcode
+ *   (optional) A language code to use for rendering. Defaults to the global
+ *   content language of the current request.
+ *
+ * @return array
+ *   An array as expected by drupal_render().
+ */
+function file_view($file, $view_mode = 'full', $langcode = NULL) {
+  if (!isset($langcode)) {
+    $langcode = $GLOBALS['language_content']->language;
+  }
+
+  // Populate $file->content with a render() array.
+  file_build_content($file, $view_mode, $langcode);
+
+  $build = $file->content;
+  // We don't need duplicate rendering info in $file->content.
+  unset($file->content);
+
+  $build += array(
+    '#theme' => 'file_entity',
+    '#file' => $file,
+    '#view_mode' => $view_mode,
+    '#language' => $langcode,
+  );
+
+  // Add contextual links for this file, except when the file is already being
+  // displayed on its own page. Modules may alter this behavior (for example,
+  // to restrict contextual links to certain view modes) by implementing
+  // hook_file_view_alter().
+  if (!empty($file->fid) && !($view_mode == 'full' && file_entity_is_page($file))) {
+    $build['#contextual_links']['file'] = array('file', array($file->fid));
+  }
+
+  // Allow modules to modify the structured file.
+  $type = 'file';
+  drupal_alter(array('file_view', 'entity_view'), $build, $type);
+
+  return $build;
+}
+
+/**
+ * Builds a structured array representing the file's content.
+ *
+ * @param object $file
+ *   A file object.
+ * @param string $view_mode
+ *   View mode, e.g. 'default', 'full', etc.
+ * @param string $langcode
+ *   (optional) A language code to use for rendering. Defaults to the global
+ *   content language of the current request.
+ */
+function file_build_content($file, $view_mode = 'full', $langcode = NULL) {
+  if (!isset($langcode)) {
+    $langcode = $GLOBALS['language_content']->language;
+  }
+
+  // Remove previously built content, if exists.
+  $file->content = array();
+
+  // Build the actual file display.
+  // @todo Figure out how to clean this crap up.
+  $file->content['file'] = file_view_file($file, $view_mode, $langcode);
+  if (isset($file->content['file'])) {
+    if (isset($file->content['file']['#theme']) && $file->content['file']['#theme'] != 'file_link') {
+      unset($file->content['file']['#file']);
+    }
+    unset($file->content['file']['#view_mode']);
+    unset($file->content['file']['#language']);
+  }
+  else {
+    unset($file->content['file']);
+  }
+
+  // Build fields content.
+  // In case of a multiple view, file_view_multiple() already ran the
+  // 'prepare_view' step. An internal flag prevents the operation from running
+  // twice.
+  field_attach_prepare_view('file', array($file->fid => $file), $view_mode, $langcode);
+  entity_prepare_view('file', array($file->fid => $file), $langcode);
+  $file->content += field_attach_view('file', $file, $view_mode, $langcode);
+
+  $links = array();
+  $file->content['links'] = array(
+    '#theme' => 'links__file',
+    '#pre_render' => array('drupal_pre_render_links'),
+    '#attributes' => array('class' => array('links', 'inline')),
+  );
+  $file->content['links']['file'] = array(
+    '#theme' => 'links__file__file',
+    '#links' => $links,
+    '#attributes' => array('class' => array('links', 'inline')),
+  );
+
+  // Allow modules to make their own additions to the file.
+  module_invoke_all('file_view', $file, $view_mode, $langcode);
+  module_invoke_all('entity_view', $file, 'file', $view_mode, $langcode);
+}
+
+/**
+ * Generate an array for rendering just the file portion of a file entity.
+ *
+ * @param object $file
+ *   A file object.
+ * @param string|array $displays
+ *   Can be either:
+ *   - the name of a view mode;
+ *   - or an array of custom display settings, as returned by file_displays().
+ * @param string $langcode
+ *   (optional) A language code to use for rendering. Defaults to the global
+ *   content language of the current request.
+ *
+ * @return array
+ *   An array as expected by drupal_render().
+ */
+function file_view_file($file, $displays = 'full', $langcode = NULL) {
+  if (!isset($langcode)) {
+    $langcode = $GLOBALS['language_content']->language;
+  }
+
+  // Prepare incoming display specifications.
+  if (is_string($displays)) {
+    $view_mode = $displays;
+    $displays = file_displays($file->type, $view_mode);
+  }
+  else {
+    $view_mode = '_custom_display';
+  }
+  drupal_alter('file_displays', $displays, $file, $view_mode);
+  _file_sort_array_by_weight($displays);
+
+  // Attempt to display the file with each of the possible displays. Stop after
+  // the first successful one. See file_displays() for details.
+  $element = NULL;
+  foreach ($displays as $formatter_type => $display) {
+    if (!empty($display['status'])) {
+      $formatter_info = file_info_formatter_types($formatter_type);
+      // Under normal circumstances, the UI prevents enabling formatters for
+      // incompatible MIME types. In case this was somehow circumvented (for
+      // example, a module updated its formatter definition without updating
+      // existing display settings), perform an extra check here.
+      if (isset($formatter_info['mime types'])) {
+        if (!file_entity_match_mimetypes($formatter_info['mime types'], $file->filemime)) {
+          continue;
+        }
+      }
+      if (isset($formatter_info['view callback']) && ($function = $formatter_info['view callback']) && function_exists($function)) {
+        $display['type'] = $formatter_type;
+        if (!empty($formatter_info['default settings'])) {
+          if (empty($display['settings'])) {
+            $display['settings'] = array();
+          }
+          $display['settings'] += $formatter_info['default settings'];
+        }
+        $element = $function($file, $display, $langcode);
+        if (isset($element)) {
+          break;
+        }
+      }
+    }
+  }
+
+  // As a last resort, fall back to showing a link to the file.
+  if (!isset($element)) {
+    $element = array(
+      '#theme' => 'file_link',
+      '#file' => $file,
+    );
+  }
+
+  // Add defaults and return the element.
+  $element += array(
+    '#file' => $file,
+    '#view_mode' => $view_mode,
+    '#language' => $langcode,
+  );
+
+  return $element;
+}
+
+/**
+ * @defgroup file_displays File displays API
+ * @{
+ * Functions to load and save information about file displays.
+ */
+
+/**
+ * Returns an array of displays to use for a file type in a given view mode.
+ *
+ * It is common for a site to be configured with broadly defined file types
+ * (e.g., 'video'), and to have different files of this type require different
+ * displays (for example, the code required to display a YouTube video is
+ * different than the code required to display a local QuickTime video).
+ * Therefore, the site administrator can configure multiple displays for a given
+ * file type. This function returns all of the displays that the administrator
+ * enabled for the given file type in the given view mode. file_view_file() then
+ * invokes each of these, and passes the specific file to display. Each display
+ * implementation can inspect the file, and either return a render array (if it
+ * is capable of displaying the file), or return nothing (if it is incapable of
+ * displaying the file). The first render array returned is the one used.
+ *
+ * @param string $file_type
+ *   The type of file.
+ * @param string $view_mode
+ *   The view mode.
+ *
+ * @return array
+ *   An array keyed by the formatter type name. Each item in the array contains
+ *   the following key/value pairs:
+ *   - status: Whether this display is enabled. If not TRUE, file_view_file()
+ *     skips over it.
+ *   - weight: An integer that determines the order of precedence within the
+ *     returned array. The lowest weight display capable of displaying the file
+ *     is used.
+ *   - settings: An array of key/value pairs specific to the formatter type. See
+ *     hook_file_formatter_info() for details.
+ *
+ * @see hook_file_formatter_info()
+ * @see file_view_file()
+ */
+function file_displays($file_type, $view_mode) {
+  $cache = &drupal_static(__FUNCTION__, array());
+
+  // If the requested view mode isn't configured to use a custom display for its
+  // fields, then don't use a custom display for its file either.
+  if ($view_mode != 'default') {
+    $view_mode_settings = field_view_mode_settings('file', $file_type);
+    $view_mode = !empty($view_mode_settings[$view_mode]['custom_settings']) ? $view_mode : 'default';
+  }
+
+  if (!isset($cache[$file_type][$view_mode])) {
+    // Load the display configurations for the file type and view mode. If none
+    // exist for the view mode, use the default view mode.
+    $displays = file_displays_load($file_type, $view_mode, TRUE);
+    if (empty($displays) && $view_mode != 'default') {
+      $cache[$file_type][$view_mode] = file_displays($file_type, 'default');
+    }
+    else {
+      // Convert the display objects to arrays and remove unnecessary keys.
+      foreach ($displays as $formatter_name => $display) {
+        $displays[$formatter_name] = array_intersect_key((array) $display, drupal_map_assoc(array('status', 'weight', 'settings')));
+      }
+      $cache[$file_type][$view_mode] = $displays;
+    }
+  }
+
+  return $cache[$file_type][$view_mode];
+}
+
+/**
+ * Returns an array of {file_display} objects for the file type and view mode.
+ */
+function file_displays_load($file_type, $view_mode, $key_by_formatter_name = FALSE) {
+  ctools_include('export');
+
+  $display_names = array();
+  $prefix = $file_type . '__' . $view_mode . '__';
+  foreach (array_keys(file_info_formatter_types()) as $formatter_name) {
+    $display_names[] = $prefix . $formatter_name;
+  }
+  $displays = ctools_export_load_object('file_display', 'names', $display_names);
+
+  if ($key_by_formatter_name) {
+    $prefix_length = strlen($prefix);
+    $rekeyed_displays = array();
+    foreach ($displays as $name => $display) {
+      $rekeyed_displays[substr($name, $prefix_length)] = $display;
+    }
+    $displays = $rekeyed_displays;
+  }
+
+  return $displays;
+}
+
+/**
+ * Saves a {file_display} object to the database.
+ */
+function file_display_save($display) {
+  ctools_include('export');
+  ctools_export_crud_save('file_display', $display);
+  file_info_cache_clear();
+}
+
+/**
+ * Creates a new {file_display} object.
+ */
+function file_display_new($file_type, $view_mode, $formatter_name) {
+  ctools_include('export');
+  $display = ctools_export_crud_new('file_display');
+  file_info_cache_clear();
+  $display->name = implode('__', array($file_type, $view_mode, $formatter_name));
+  return $display;
+}
+
+/**
+ * @} End of "defgroup file_displays".
+ */
+
+/**
+ * @defgroup file_types File types API
+ * @{
+ * Functions to load and save information about file types.
+ */
+
+/**
+ * Load a file type configuration object.
+ *
+ * @param string $name
+ *   The file type machine name to load.
+ *
+ * @return object
+ *   The file type object, or FALSE if it does not exist.
+ */
+function file_type_load($name) {
+  ctools_include('export');
+  $type = ctools_export_crud_load('file_type', $name);
+  return isset($type) ? $type : FALSE;
+}
+
+/**
+ * Load multiple file type configuration objects.
+ *
+ * @param array $names
+ *   An array of file type machine names to load.
+ *
+ * @return array
+ *   An array of file type objects, keyed by machine name.
+ */
+function file_type_load_multiple(array $names) {
+  ctools_include('export');
+  return ctools_export_crud_load_multiple('file_type', $names);
+}
+
+/**
+ * Load all file type configuration objects.
+ *
+ * This includes all enabled and disabled file types.
+ *
+ * @param bool $reset
+ *   If TRUE, the static cache of all file types will be flushed prior to
+ *   loading. This can be important on listing pages where file types might
+ *   have changed on the page load.
+ *
+ * @return array
+ *   An array of file type objects, keyed by machine name.
+ *
+ * @see file_type_get_enabled_types()
+ * @see file_type_get_disabled_types()
+ */
+function file_type_load_all($reset = FALSE) {
+  ctools_include('export');
+  return ctools_export_crud_load_all('file_type', $reset);
+}
+
+/**
+ * Returns an array of enabled file types.
+ */
+function file_type_get_enabled_types() {
+  $types = file_type_load_all();
+  return array_filter($types, 'file_type_is_enabled');
+}
+
+/**
+ * Returns an array of disabled file types.
+ */
+function file_type_get_disabled_types() {
+  $types = file_type_load_all();
+  return array_filter($types, 'file_type_is_disabled');
+}
+
+/**
+ * Returns TRUE if a file type is enabled, FALSE otherwise.
+ */
+function file_type_is_enabled($type) {
+  return empty($type->disabled);
+}
+
+/**
+ * Returns TRUE if a file type is disabled, FALSE otherwise.
+ */
+function file_type_is_disabled($type) {
+  return !empty($type->disabled);
+}
+
+/**
+ * Updates an existing file type or creates a new one.
+ *
+ * This function can be called on its own, or via the CTools exportables
+ * 'save callback' for {file_type} objects.
+ */
+function file_type_save($type) {
+  // Get the old type object, so we now can issue the correct insert/update
+  // queries.
+  if (!empty($type->old_type) && $type->old_type != $type->type) {
+    $rename_bundle = TRUE;
+    $old_type = file_type_load($type->old_type);
+  }
+  else {
+    $rename_bundle = FALSE;
+    $old_type = file_type_load($type->type);
+  }
+
+  // The type and label fields are required, but description is optional.
+  if (!isset($type->description)) {
+    $type->description = '';
+  }
+  $fields = array(
+    'type' => $type->type,
+    'label' => $type->label,
+    'description' => $type->description,
+    'mimetypes' => serialize($type->mimetypes),
+  );
+
+  // Update an existing type object, whether with a modified 'type' property or
+  // not.
+  if ($old_type) {
+    if ($old_type->export_type & EXPORT_IN_DATABASE) {
+      db_update('file_type')
+        ->fields($fields)
+        ->condition('type', $old_type->type)
+        ->execute();
+    }
+    else {
+      db_insert('file_type')
+        ->fields($fields)
+        ->execute();
+    }
+    if ($rename_bundle) {
+      field_attach_rename_bundle('file', $old_type->type, $type->type);
+    }
+    module_invoke_all('file_type_update', $type);
+    $status = SAVED_UPDATED;
+  }
+  // Insert a new type object.
+  else {
+    db_insert('file_type')
+      ->fields($fields)
+      ->execute();
+    field_attach_create_bundle('file', $type->type);
+    module_invoke_all('file_type_insert', $type);
+    $status = SAVED_NEW;
+  }
+
+  // Clear the necessary caches.
+  file_info_cache_clear();
+
+  // Ensure the type has the correct export_type in case the $type parameter
+  // continues to be used by the calling function after this function completes.
+  if (empty($type->export_type)) {
+    $type->export_type = 0;
+  }
+  $type->export_type |= EXPORT_IN_DATABASE;
+
+  return $status;
+}
+
+/**
+ * Deletes a file type from the database.
+ *
+ * This function can be called on its own, or via the CTools exportables
+ * 'delete callback' for {file_type} objects.
+ *
+ * @param object|string $type
+ *   Either a loaded file type object or the machine-name of the type.
+ */
+function file_type_delete($type) {
+  $type = is_string($type) ? file_type_load($type) : $type;
+
+  db_delete('file_type')
+    ->condition('type', $type->type)
+    ->execute();
+
+  // Remove this type from CToolS status variable.
+  $status = variable_get('default_file_type', array());
+  unset($status[$type->type]);
+  variable_set('default_file_type', $status);
+
+  file_info_cache_clear();
+
+  // After deleting from the database, check if the type still exists as a
+  // code-provided default type. If not, consider the type fully deleted and
+  // invoke the needed hooks.
+  if (!file_type_load($type->type)) {
+    field_attach_delete_bundle('file', $type->type);
+    module_invoke_all('file_type_delete', $type);
+  }
+}
+
+
+/**
+ * Enable a file type.
+ *
+ * @param string $type
+ *   Type of the file_type to disable
+ */
+function file_type_enable($type) {
+  ctools_export_crud_enable('file_type', $type);
+}
+
+
+/**
+ * Disable a file type.
+ *
+ * @param string $type
+ *   Type of the file_type to disable
+ */
+function file_type_disable($type) {
+  ctools_export_crud_disable('file_type', $type);
+}
+
+
+/**
+ * Determines file type for a given file.
+ *
+ * @param object $file
+ *   File object.
+ *
+ * @return string
+ *   Machine name of file type that should be used for given file.
+ */
+function file_get_type($file) {
+  $types = module_invoke_all('file_type', $file);
+  drupal_alter('file_type', $types, $file);
+
+  return empty($types) ? NULL : reset($types);
+}
+
+/**
+ * @} End of "defgroup file_types".
+ */
+
+/**
+ * Sorts an array by weight.
+ *
+ * Helper function to sort an array by the value of each item's 'weight' key,
+ * while preserving relative order of items that have equal weight.
+ */
+function _file_sort_array_by_weight(&$a) {
+  $i = 0;
+  foreach ($a as $key => $item) {
+    if (!isset($a[$key]['weight'])) {
+      $a[$key]['weight'] = 0;
+    }
+    $original_weight[$key] = $a[$key]['weight'];
+    $a[$key]['weight'] += $i / 1000;
+    $i++;
+  }
+  uasort($a, 'drupal_sort_weight');
+  foreach ($a as $key => $item) {
+    $a[$key]['weight'] = $original_weight[$key];
+  }
+}
+
+/**
+ * User sort function to sort by weight, then label/name.
+ */
+function _file_entity_sort_weight_label($a, $b) {
+  $a_weight = isset($a['weight']) ? $a['weight'] : 0;
+  $b_weight = isset($b['weight']) ? $b['weight'] : 0;
+  if ($a_weight == $b_weight) {
+    $a_label = isset($a['label']) ? $a['label'] : '';
+    $b_label = isset($b['label']) ? $b['label'] : '';
+    return strcasecmp($a_label, $b_label);
+  }
+  else {
+    return $a_weight < $b_weight ? -1 : 1;
+  }
+}
+
+/**
+ * Returns a file object which can be passed to file_save().
+ *
+ * @param string $uri
+ *   A string containing the URI, path, or filename.
+ * @param bool $use_existing
+ *   (Optional) If TRUE and there's an existing file in the {file_managed}
+ *   table with the passed in URI, then that file object is returned.
+ *   Otherwise, a new file object is returned. Default is TRUE.
+ *
+ * @return object|bool
+ *   A file object, or FALSE on error.
+ *
+ * @todo This should probably be named
+ *   file_load_by_uri($uri, $create_if_not_exists).
+ * @todo Remove this function when http://drupal.org/node/685818 is fixed.
+ */
+function file_uri_to_object($uri, $use_existing = TRUE) {
+  $file = FALSE;
+  $uri = file_stream_wrapper_uri_normalize($uri);
+
+  if ($use_existing) {
+    // We should always attempt to re-use a file if possible.
+    $files = entity_load('file', FALSE, array('uri' => $uri));
+    $file = !empty($files) ? reset($files) : FALSE;
+  }
+
+  if (empty($file)) {
+    $file = new stdClass();
+    $file->uid = $GLOBALS['user']->uid;
+    $file->filename = basename($uri);
+    $file->uri = $uri;
+    $file->filemime = file_get_mimetype($uri);
+    // This is gagged because some uris will not support it.
+    $file->filesize = @filesize($uri);
+    $file->timestamp = REQUEST_TIME;
+    $file->status = FILE_STATUS_PERMANENT;
+  }
+
+  return $file;
+}
+
+/**
+ * Delete multiple files.
+ *
+ * Unlike core's file_delete(), this function does not care about file usage
+ * or skip on invalid URIs. Just deletes the damn file like it should.
+ *
+ * @param array $fids
+ *   An array of file IDs.
+ */
+function file_delete_multiple(array $fids) {
+  $transaction = db_transaction();
+  if (!empty($fids) && $files = file_load_multiple($fids)) {
+    try {
+      foreach ($files as $fid => $file) {
+        module_invoke_all('file_delete', $file);
+        module_invoke_all('entity_delete', $file, 'file');
+        // Skip calling field_attach_delete as file_entity_file_delete()
+        // does this.
+        // field_attach_delete('file', $file);
+        // Remove this file from the search index if needed.
+        // This code is implemented in file_entity module rather than in search
+        // module, because node module is implementing search module's API,
+        // not the other way around.
+        if (module_exists('search')) {
+          search_reindex($fid, 'file');
+        }
+
+        // Make sure the file is deleted before removing its row from the
+        // database, so UIs can still find the file in the database.
+        if (file_valid_uri($file->uri)) {
+          file_unmanaged_delete($file->uri);
+        }
+      }
+
+      db_delete('file_managed')
+        ->condition('fid', $fids, 'IN')
+        ->execute();
+      db_delete('file_usage')
+        ->condition('fid', $fids, 'IN')
+        ->execute();
+    }
+    catch (Exception $e) {
+      $transaction->rollback();
+      watchdog_exception('file', $e);
+      throw $e;
+    }
+
+    // Clear the page and block and file_load_multiple caches.
+    entity_get_controller('file')->resetCache();
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.file_default_displays.inc b/profiles/commons/modules/contrib/file_entity/file_entity.file_default_displays.inc
new file mode 100644
index 0000000..c96f6a1
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.file_default_displays.inc
@@ -0,0 +1,135 @@
+<?php
+
+/**
+ * @file
+ * Default display configuration for the default file types.
+ */
+
+/**
+ * Implements hook_file_default_displays().
+ */
+function file_entity_file_default_displays() {
+  $file_displays = array();
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__default__file_field_file_audio';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'controls' => 1,
+    'autoplay' => 0,
+    'loop' => 0,
+    'multiple_file_behavior' => 'tags',
+  );
+  $file_displays['audio__default__file_field_file_audio'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__preview__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['audio__preview__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__teaser__file_field_file_audio';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'controls' => 1,
+    'autoplay' => 0,
+    'loop' => 0,
+    'multiple_file_behavior' => 'tags',
+  );
+  $file_displays['audio__teaser__file_field_file_audio'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__default__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['document__default__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__preview__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['document__preview__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__teaser__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['document__teaser__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__default__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['image__default__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__preview__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['image__preview__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__teaser__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['image__teaser__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__default__file_field_file_video';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'controls' => 1,
+    'autoplay' => 0,
+    'loop' => 0,
+    'width' => '',
+    'height' => '',
+    'multiple_file_behavior' => 'tags',
+  );
+  $file_displays['video__default__file_field_file_video'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__preview__file_field_file_default';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['video__preview__file_field_file_default'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__teaser__file_field_file_video';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'controls' => 1,
+    'autoplay' => 0,
+    'loop' => 0,
+    'width' => '',
+    'height' => '',
+    'multiple_file_behavior' => 'tags',
+  );
+  $file_displays['video__teaser__file_field_file_video'] = $file_display;
+
+  return $file_displays;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.info b/profiles/commons/modules/contrib/file_entity/file_entity.info
new file mode 100644
index 0000000..623ae37
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.info
@@ -0,0 +1,32 @@
+name = File entity
+description = "Extends Drupal file entities to be fieldable and viewable."
+package = Media
+core = 7.x
+dependencies[] = field
+dependencies[] = file
+dependencies[] = ctools
+dependencies[] = system (>=7.9)
+files[] = views/views_handler_argument_file_type.inc
+files[] = views/views_handler_field_file_rendered.inc
+files[] = views/views_handler_field_file_type.inc
+files[] = views/views_handler_filter_file_type.inc
+files[] = views/views_handler_field_file_filename.inc
+files[] = views/views_handler_field_file_link.inc
+files[] = views/views_handler_field_file_link_edit.inc
+files[] = views/views_handler_field_file_link_delete.inc
+files[] = views/views_handler_field_file_link_download.inc
+files[] = views/views_handler_field_file_link_usage.inc
+files[] = views/views_plugin_row_file_rss.inc
+files[] = views/views_plugin_row_file_view.inc
+files[] = file_entity.test
+configure = admin/config/media/file-settings
+
+; We have to add a fake version so Git checkouts do not fail Media dependencies
+version = 7.x-2.x-dev
+
+; Information added by drupal.org packaging script on 2013-10-25
+version = "7.x-2.0-alpha3"
+core = "7.x"
+project = "file_entity"
+datestamp = "1382744726"
+
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.install b/profiles/commons/modules/contrib/file_entity/file_entity.install
new file mode 100644
index 0000000..ca4ab06
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.install
@@ -0,0 +1,1073 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the file_entity module.
+ */
+
+/**
+ * Implements hook_schema().
+ */
+function file_entity_schema() {
+  $schema['file_type'] = array(
+    'description' => 'Stores the settings for file types.',
+    'fields' => array(
+      'type' => array(
+        'description' => 'The machine name of the file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+      'label' => array(
+        'description' => 'The human readable name of the file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+        'translatable' => TRUE,
+      ),
+      'description' => array(
+        'description' => 'A brief description of this file type.',
+        'type' => 'text',
+        'not null' => TRUE,
+        'size' => 'medium',
+        'translatable' => TRUE,
+      ),
+      'mimetypes' => array(
+        'description' => 'Mimetypes mapped to this file type.',
+        'type' => 'blob',
+        'size' => 'big',
+        'not null' => FALSE,
+        'serialize' => TRUE,
+      ),
+    ),
+    'primary key' => array('type'),
+    'export' => array(
+      'key' => 'type',
+      'key name' => 'Type',
+      'primary key' => 'type',
+      'default hook' => 'file_default_types',
+      'identifier' => 'file_type',
+      'export type string' => 'ctools_type',
+      'save callback' => 'file_type_save',
+      'delete callback' => 'file_type_delete',
+      'api' => array(
+        'owner' => 'file_entity',
+        'api' => 'file_type',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+  );
+  $schema['file_display'] = array(
+    'description' => 'Stores configuration options for file displays.',
+    'fields' => array(
+      // @todo Can be refactored as a compond primary key after
+      //   http://drupal.org/node/924236 is implemented.
+      'name' => array(
+        'description' => 'A combined string (FILE_TYPE__VIEW_MODE__FILE_FORMATTER) identifying a file display configuration. For integration with CTools Exportables, stored as a single string rather than as a compound primary key.',
+        'type' => 'varchar',
+        'length' => '255',
+        'not null' => TRUE,
+      ),
+      'weight' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'Weight of formatter within the display chain for the associated file type and view mode. A file is rendered using the lowest weighted enabled display configuration that matches the file type and view mode and that is capable of displaying the file.',
+      ),
+      'status' => array(
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+        'size' => 'tiny',
+        'description' => 'The status of the display. (1 = enabled, 0 = disabled)',
+      ),
+      'settings' => array(
+        'type' => 'blob',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+        'description' => 'A serialized array of name value pairs that store the formatter settings for the display.',
+      ),
+    ),
+    'primary key' => array('name'),
+    // Exportable support via CTools.
+    'export' => array(
+      'key' => 'name',
+      'key name' => 'Name',
+      'primary key' => 'name',
+      // The {file_display}.status field is used to control whether the display
+      // is active in the display chain. CTools-level disabling is something
+      // different, and it's not yet clear how to interpret it for file
+      // displays. Until that's figured out, prevent CTools-level disabling.
+      'can disable' => FALSE,
+      'default hook' => 'file_default_displays',
+      'identifier' => 'file_display',
+      'api' => array(
+        'owner' => 'file_entity',
+        'api' => 'file_default_displays',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+  );
+  $schema['file_metadata'] = array(
+    'description' => 'Cache images dimensions.',
+    'fields' => array(
+      'fid' => array(
+        'description' => 'The {file_managed}.fid of the metadata.',
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+      ),
+      'name' => array(
+        'description' => "The name of the metadata (e.g. 'width').",
+        'type' => 'varchar',
+        'length' => '255',
+        'not null' => TRUE,
+      ),
+      'value' => array(
+        'description' => "The value of the metadata (e.g. '200px').",
+        'type' => 'blob',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+      ),
+    ),
+    'primary key' => array('fid', 'name'),
+    'foreign keys' => array(
+      'file_managed' => array(
+        'table' => 'file_managed',
+        'columns' => array('fid' => 'fid'),
+      ),
+    ),
+  );
+  return $schema;
+}
+
+/**
+ * Implements hook_schema_alter().
+ */
+function file_entity_schema_alter(&$schema) {
+  $schema['file_managed']['fields']['type'] = array(
+    'description' => 'The type of this file.',
+    'type' => 'varchar',
+    'length' => 50,
+    'not null' => TRUE,
+    // If the FILE_TYPE_NONE constant ever changes, then change the value here
+    // too, and add an update function to deal with existing records. The
+    // constant isn't used here, because there may be cases where this function
+    // runs without the module file loaded.
+    'default' => 'undefined',
+  );
+  $schema['file_managed']['indexes']['file_type'] = array('type');
+}
+
+
+/**
+ * Implements hook_install().
+ */
+function file_entity_install() {
+  $schema = array();
+  file_entity_schema_alter($schema);
+  $spec = $schema['file_managed']['fields']['type'];
+  $indexes_new = array('indexes' => $schema['file_managed']['indexes']);
+
+  // If another module (e.g., Media) had added a {file_managed}.type field,
+  // then change it to the expected specification. Otherwise, add the field.
+  if (db_field_exists('file_managed', 'type')) {
+    // db_change_field() will fail if any records have type=NULL, so update
+    // them to the new default value.
+    db_update('file_managed')->fields(array('type' => $spec['default']))->isNull('type')->execute();
+
+    // Indexes using a field being changed must be dropped prior to calling
+    // db_change_field(). However, the database API doesn't provide a way to do
+    // this without knowing what the old indexes are. Therefore, it is the
+    // responsibility of the module that added them to drop them prior to
+    // allowing this module to be installed.
+    db_change_field('file_managed', 'type', 'type', $spec, $indexes_new);
+  }
+  else {
+    db_add_field('file_managed', 'type', $spec, $indexes_new);
+  }
+
+  // Set permissions.
+  $roles = user_roles();
+  foreach ($roles as $rid => $role) {
+    user_role_grant_permissions($rid, array('view files'));
+  }
+
+  // Create the title and alt text fields.
+  _file_entity_create_alt_title_fields();
+
+  // Configure default pathauto variables if it is currently installed.
+  if (module_exists('pathauto')) {
+    variable_set('pathauto_file_pattern', 'file/[file:name]');
+  }
+
+  // Classify existing files according to the currently defined file types.
+  // Queue all files to be classified during cron runs using the Queue API.
+  $queue = DrupalQueue::get('file_entity_type_determine');
+  $result = db_query('SELECT fid FROM {file_managed}');
+  foreach ($result as $record) {
+    $queue->createItem($record->fid);
+  }
+
+  // Warn users that existing files will not have a file type until the queue
+  // has been processed.
+  if ($queue->numberOfItems()) {
+    drupal_set_message(t('Existing files must be classified according to the currently defined file types. These files have been queued for processing and will have their file type determined during cron runs.'));
+  }
+}
+
+/**
+ * Implements hook_uninstall().
+ */
+function file_entity_uninstall() {
+  drupal_load('module', 'file_entity');
+  foreach (file_type_load_all(TRUE) as $type) {
+    file_type_delete($type);
+  }
+
+  // Remove the added column to the core {file_managed} table.
+  db_drop_field('file_managed', 'type');
+
+  // Remove variables.
+  variable_del('file_entity_max_filesize');
+  variable_del('file_entity_default_allowed_extensions');
+  variable_del('file_entity_alt');
+  variable_del('file_entity_title');
+  variable_del('file_entity_allow_insecure_download');
+  variable_del('file_entity_file_upload_wizard_skip_file_type');
+  variable_del('file_entity_file_upload_wizard_skip_scheme');
+  variable_del('file_entity_file_upload_wizard_skip_fields');
+}
+
+/**
+ * Create the {file_display} database table.
+ */
+function file_entity_update_7000() {
+  if (db_table_exists('file_display')) {
+    return t('The table {file_display} already exists.');
+  }
+
+  $schema['file_display'] = array(
+    'description' => 'Stores configuration options for file displays.',
+    'fields' => array(
+      'name' => array(
+        'description' => 'A combined string (FILE_TYPE__VIEW_MODE__FILE_FORMATTER) identifying a file display configuration. For integration with CTools Exportables, stored as a single string rather than as a compound primary key.',
+        'type' => 'varchar',
+        'length' => '255',
+        'not null' => TRUE,
+      ),
+      'weight' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'Weight of formatter within the display chain for the associated file type and view mode. A file is rendered using the lowest weighted enabled display configuration that matches the file type and view mode and that is capable of displaying the file.',
+      ),
+      'status' => array(
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+        'size' => 'tiny',
+        'description' => 'The status of the display. (1 = enabled, 0 = disabled)',
+      ),
+      'settings' => array(
+        'type' => 'blob',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+        'description' => 'A serialized array of name value pairs that store the formatter settings for the display.',
+      ),
+    ),
+    'primary key' => array('name'),
+  );
+  db_create_table('file_display', $schema['file_display']);
+}
+
+/**
+ * Move file display configurations.
+ *
+ * Move file display configurations from the 'file_displays' variable to the
+ * {file_display} database table.
+ */
+function file_entity_update_7001() {
+  $file_displays = variable_get('file_displays');
+  if (!empty($file_displays)) {
+    foreach ($file_displays as $file_type => $file_type_displays) {
+      if (!empty($file_type_displays)) {
+        foreach ($file_type_displays as $view_mode => $view_mode_displays) {
+          if (!empty($view_mode_displays)) {
+            foreach ($view_mode_displays as $formatter_name => $display) {
+              if (!empty($display)) {
+                db_merge('file_display')
+                  ->key(array(
+                    'name' => implode('__', array($file_type, $view_mode, $formatter_name)),
+                  ))
+                  ->fields(array(
+                    'status' => isset($display['status']) ? $display['status'] : 0,
+                    'weight' => isset($display['weight']) ? $display['weight'] : 0,
+                    'settings' => isset($display['settings']) ? serialize($display['settings']) : NULL,
+                  ))
+                  ->execute();
+              }
+            }
+          }
+        }
+      }
+    }
+  }
+  variable_del('file_displays');
+}
+
+/**
+ * Empty update function to trigger a theme registry rebuild.
+ */
+function file_entity_update_7100() { }
+
+/**
+ * Update all files with empty types to use the first part of filemime.
+ *
+ * For example, an png image with filemime 'image/png' will be assigned a file
+ * type of 'image'.
+ */
+function file_entity_update_7101() {
+  db_update('file_managed')
+    ->expression('type', "SUBSTRING_INDEX(filemime, '/', 1)")
+    ->condition('type', '')
+    ->execute();
+}
+
+/**
+ * Empty update function to trigger an entity cache rebuild.
+ */
+function file_entity_update_7102() {
+}
+
+/**
+ * Empty update function.
+ */
+function file_entity_update_7103() {
+}
+
+/**
+ * Assign view file permission when updating without the Media module.
+ */
+function file_entity_update_7104() {
+  if (!module_exists('media')) {
+    $roles = user_roles(FALSE, 'view file');
+    if (empty($roles)) {
+      // Set permissions.
+      $roles = user_roles();
+      foreach ($roles as $rid => $role) {
+        // Do not use user_role_grant_permission() since it relies on
+        // hook_permission(), which will not run for file entity module if it
+        // is disabled or the permission is renamed or removed.
+        db_merge('role_permission')
+          ->fields(array(
+            'rid' => $rid,
+            'permission' => 'view file',
+            'module' => 'file_entity',
+          ))
+          ->execute();
+      }
+    }
+  }
+}
+
+/**
+ * Create the {image_dimensions} database table.
+ */
+function file_entity_update_7200() {
+  if (db_table_exists('image_dimensions')) {
+    return t('The table {image_dimensions} already exists.');
+  }
+
+  $schema['image_dimensions'] = array(
+    'description' => 'Cache images dimensions.',
+    'fields' => array(
+      'fid' => array(
+        'description' => 'File ID.',
+        'type' => 'serial',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+      ),
+      'height' => array(
+        'description' => 'The height of the image in pixels.',
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+      ),
+      'width' => array(
+        'description' => 'The width of the image in pixels..',
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+      ),
+    ),
+    'primary key' => array('fid'),
+    'foreign keys' => array(
+      'file_managed' => array(
+        'table' => 'file_managed',
+        'columns' => array('fid' => 'fid'),
+      ),
+    ),
+  );
+  db_create_table('image_dimensions', $schema['image_dimensions']);
+}
+
+/**
+ * Add the {file_type}, {file_type_mimetypes} tables.
+ */
+function file_entity_update_7201() {
+  $schema = array(
+    'description' => 'Stores the settings for file types.',
+    'fields' => array(
+      'type' => array(
+        'description' => 'The machine name of the file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+      'label' => array(
+        'description' => 'The human readable name of the file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+        'translatable' => TRUE,
+      ),
+      'description' => array(
+        'description' => 'A brief description of this file type.',
+        'type' => 'text',
+        'not null' => TRUE,
+        'size' => 'medium',
+        'translatable' => TRUE,
+      ),
+    ),
+    'primary key' => array('type'),
+    'export' => array(
+      'key' => 'type',
+      'key name' => 'Type',
+      'primary key' => 'type',
+      'default hook' => 'file_default_types',
+      'identifier' => 'file_type',
+      'export type string' => 'ctools_type',
+      'subrecords callback' => 'file_type_load_subrecords',
+      'save callback' => 'file_type_save',
+      'delete callback' => 'file_type_delete',
+      'api' => array(
+        'owner' => 'file_entity',
+        'api' => 'file_type',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+  );
+  if (!db_table_exists('file_type')) {
+    db_create_table('file_type', $schema);
+  }
+
+  $schema = array(
+    'description' => 'Maps mimetypes to file types.',
+    'fields' => array(
+      'type' => array(
+        'description' => 'The machine name of the file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+      'mimetype' => array(
+        'description' => 'Mimetypes mapped to this file type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+    ),
+    'indexes' => array(
+      'file_type' => array('type'),
+      'file_type_mimetype' => array('mimetype'),
+    ),
+  );
+  if (!db_table_exists('file_type_mimetypes')) {
+    db_create_table('file_type_mimetypes', $schema);
+  }
+}
+
+/**
+ * Update empty {file_managed}.type records to 'undefined'.
+ *
+ * Drupal 7.8 disallows empty string as the value for a bundle key, so update
+ * empty {file_managed}.type records to 'undefined' instead.
+ */
+function file_entity_update_7202() {
+  db_update('file_managed')
+    // Using 'undefined' instead of FILE_TYPE_NONE, because update functions can
+    // run for disabled modules.
+    ->fields(array('type' => 'undefined'))
+    ->condition('type', '')
+    ->execute();
+}
+
+/**
+ * Update permission names.
+ */
+function file_entity_update_7203() {
+  $permissions = array(
+    'view file' => 'view files',
+    'edit file' => 'edit any files',
+  );
+  foreach ($permissions as $old => $new) {
+    db_update('role_permission')
+      ->fields(array('permission' => $new))
+      ->condition('permission', $old)
+      ->execute();
+  }
+}
+
+
+/**
+ * Add title and alt text to image file types.
+ */
+function file_entity_update_7204() {
+  _file_entity_create_alt_title_fields();
+}
+
+/**
+ * Function to create the title and alt text fields and instances.
+ */
+function _file_entity_create_alt_title_fields() {
+  $t = get_t();
+  // Create the alt text field and instance.
+  // Define the alt text field.
+  $alt_text_field = array(
+    'active' => '1',
+    'cardinality' => '1',
+    'deleted' => '0',
+    'entity_types' => array(),
+    'field_name' => 'field_file_image_alt_text',
+    'foreign keys' => array(
+      'format' => array(
+        'columns' => array(
+          'format' => 'format',
+        ),
+        'table' => 'filter_format',
+      ),
+    ),
+    'indexes' => array(
+      'format' => array(
+        0 => 'format',
+      ),
+    ),
+    'module' => 'text',
+    'settings' => array(
+      'max_length' => '255',
+    ),
+    'translatable' => '0',
+    'type' => 'text',
+  );
+
+  // As long as the alt text field doesn't already exist create it.
+  if (!field_info_field($alt_text_field['field_name'])) {
+    field_create_field($alt_text_field);
+  }
+
+  // Define the alt text instance.
+  $alt_text_instance = array(
+    'bundle' => 'image',
+    'default_value' => NULL,
+    'deleted' => '0',
+    'description' => $t('Alternative text is used by screen readers, search engines, and when the image cannot be loaded. By adding alt text you improve accessibility and search engine optimization.'),
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'full' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'preview' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'teaser' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+    ),
+    'entity_type' => 'file',
+    'field_name' => 'field_file_image_alt_text',
+    'label' => 'Alt Text',
+    'required' => 0,
+    'settings' => array(
+      'text_processing' => '0',
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'text',
+      'settings' => array(
+        'size' => '60',
+      ),
+      'type' => 'text_textfield',
+      'weight' => '-4',
+    ),
+  );
+
+  // For sites that updated from Media 1.x, continue to provide these deprecated
+  // view modes.
+  // @see http://drupal.org/node/1051090
+  if (variable_get('media__show_deprecated_view_modes')) {
+    $alt_text_instance['display'] += array(
+      'media_link' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'media_original' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+    );
+  }
+
+  // As long as the alt text instance doesn't already exist create it.
+  if (!field_info_instance($alt_text_instance['entity_type'], $alt_text_instance['field_name'], $alt_text_instance['bundle'])) {
+    field_create_instance($alt_text_instance);
+  }
+
+  // Create the title text field and instance.
+  // Define the title text field.
+  $title_text_field = array(
+    'active' => '1',
+    'cardinality' => '1',
+    'deleted' => '0',
+    'entity_types' => array(),
+    'field_name' => 'field_file_image_title_text',
+    'foreign keys' => array(
+      'format' => array(
+        'columns' => array(
+          'format' => 'format',
+        ),
+        'table' => 'filter_format',
+      ),
+    ),
+    'indexes' => array(
+      'format' => array(
+        0 => 'format',
+      ),
+    ),
+    'module' => 'text',
+    'settings' => array(
+      'max_length' => '255',
+    ),
+    'translatable' => '0',
+    'type' => 'text',
+  );
+
+  // As long as the title text field doesn't exist create it.
+  if (!field_info_field($title_text_field['field_name'])) {
+    field_create_field($title_text_field);
+  }
+
+  // Define the title text instance.
+  $title_text_instance = array(
+    'bundle' => 'image',
+    'default_value' => NULL,
+    'deleted' => '0',
+    'description' => $t('Title text is used in the tool tip when a user hovers their mouse over the image. Adding title text makes it easier to understand the context of an image and improves usability.'),
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 1,
+      ),
+      'full' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'preview' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'teaser' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+    ),
+    'entity_type' => 'file',
+    'field_name' => 'field_file_image_title_text',
+    'label' => 'Title Text',
+    'required' => 0,
+    'settings' => array(
+      'text_processing' => '0',
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'text',
+      'settings' => array(
+        'size' => '60',
+      ),
+      'type' => 'text_textfield',
+      'weight' => '-3',
+    ),
+  );
+
+  // For sites that updated from Media 1.x, continue to provide these deprecated
+  // view modes.
+  // @see http://drupal.org/node/1051090
+  if (variable_get('media__show_deprecated_view_modes')) {
+    $title_text_instance['display'] += array(
+      'media_link' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+      'media_original' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+    );
+  }
+
+  // As long as the title text instance doesn't already exist create it.
+  if (!field_info_instance($title_text_instance['entity_type'], $title_text_instance['field_name'], $title_text_instance['bundle'])) {
+    field_create_instance($title_text_instance);
+  }
+}
+
+/**
+ * Fix broken indexes caused by incorrect index definitions in update 7201.
+ */
+function file_entity_update_7205() {
+  // Drop broken file type indexes. These may not exist if the broken version
+  // of update 7201 was never run.
+  if (db_index_exists('file_type_mimetypes', 0)) {
+    db_drop_index('file_type_mimetypes', 0);
+  }
+  if (db_index_exists('file_type_mimetypes', 1)) {
+    db_drop_index('file_type_mimetypes', 1);
+  }
+
+  // Add file type indexes. These may already exist if the fixed version of
+  // update 7201 was run.
+  if (!db_index_exists('file_type_mimetypes', 'file_type')) {
+    db_add_index('file_type_mimetypes', 'file_type', array('type'));
+  }
+  if (!db_index_exists('file_type_mimetypes', 'file_type_mimetype')) {
+    db_add_index('file_type_mimetypes', 'file_type_mimetype', array('mimetype'));
+  }
+}
+
+/**
+ * Configure default pathauto variables if it is currently installed.
+ */
+function file_entity_update_7206() {
+  if (module_exists('pathauto')) {
+    variable_set('pathauto_file_pattern', 'file/[file:name]');
+  }
+}
+
+/**
+ * Remove the administration files limit variable.
+ */
+function file_entity_update_7207() {
+  variable_del('file_entity_admin_files_limit');
+}
+
+/**
+ * Add expanded file type permissions to roles with existing file permissions.
+ */
+function file_entity_update_7208() {
+  foreach (array('edit own files', 'edit any files', 'delete own files', 'delete any files', 'download own files', 'download any files') as $old_permission) {
+    $roles = user_roles(FALSE, $old_permission);
+
+    foreach ($roles as $rid => $name) {
+      $new_permissions = array();
+
+      foreach (file_type_get_enabled_types() as $type => $info) {
+        switch ($old_permission) {
+          case 'edit own files':
+            $new_permissions[] = 'edit own ' . $type . ' files';
+            break;
+
+          case 'edit any files':
+            $new_permissions[] = 'edit any ' . $type . ' files';
+            break;
+
+          case 'delete own files':
+            $new_permissions[] = 'delete own ' . $type . ' files';
+            break;
+
+          case 'delete any files':
+            $new_permissions[] = 'delete any ' . $type . ' files';
+            break;
+
+          case 'download own files':
+            $new_permissions[] = 'download own ' . $type . ' files';
+            break;
+
+          case 'download any files':
+            $new_permissions[] = 'download any ' . $type . ' files';
+            break;
+        }
+      }
+
+      if (!empty($new_permissions)) {
+        // Grant new permissions for the role.
+        foreach ($new_permissions as $name) {
+          db_merge('role_permission')
+            ->key(array(
+              'rid' => $rid,
+              'permission' => $name,
+            ))
+            ->fields(array(
+              'module' => 'file_entity',
+            ))
+            ->execute();
+        }
+      }
+
+      // Remove old permission from the role.
+      db_delete('role_permission')
+        ->condition('rid', $rid)
+        ->condition('permission', $old_permission)
+        ->condition('module', 'file_entity')
+        ->execute();
+    }
+  }
+}
+
+/**
+ * Remove the {file_type_streams} table if it exists.
+ */
+function file_entity_update_7209() {
+  if (db_table_exists('file_type_streams')) {
+    db_drop_table('file_type_streams');
+  }
+}
+
+/**
+ * Merge MIME types into the {file_type} table.
+ */
+function file_entity_update_7210() {
+  // Add the new mimetypes field if it doesn't already exist.
+  if (!db_field_exists('file_type', 'mimetypes')) {
+    $field = array(
+      'description' => 'Mimetypes mapped to this file type.',
+      'type' => 'blob',
+      'size' => 'big',
+      'not null' => FALSE,
+      'serialize' => TRUE,
+    );
+
+    db_add_field('file_type', 'mimetypes', $field);
+  }
+
+  // Migrate any existing MIME type information into {file_type}.
+  if (db_table_exists('file_type_mimetypes')) {
+    foreach (file_type_load_all(TRUE) as $type) {
+      $mimetypes = array();
+      $result = db_select('file_type_mimetypes', 'ftm')
+        ->fields('ftm', array('mimetype'))
+        ->condition('type', $type->type, '=')
+        ->execute();
+
+      foreach ($result as $record) {
+        $mimetypes[] = $record->mimetype;
+      }
+
+      if (!empty($mimetypes)) {
+        $type->mimetypes = $mimetypes;
+        file_type_save($type);
+      }
+    }
+
+    // Remove {file_type_mimetypes} after the information is migrated.
+    db_drop_table('file_type_mimetypes');
+  }
+}
+
+/**
+ * Create the {file_metadata} table.
+ */
+function file_entity_update_7211() {
+  $schema = array(
+    'description' => 'Stores file metadata in a key/value store.',
+    'fields' => array(
+      'fid' => array(
+        'description' => 'The {file_managed}.fid of the metadata.',
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => TRUE,
+        'default' => 0,
+      ),
+      'name' => array(
+        'description' => "The name of the metadata (e.g. 'width').",
+        'type' => 'varchar',
+        'length' => '255',
+        'not null' => TRUE,
+      ),
+      'value' => array(
+        'description' => "The value of the metadata (e.g. '200px').",
+        'type' => 'blob',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+      ),
+    ),
+    'primary key' => array('fid', 'name'),
+    'foreign keys' => array(
+      'file_managed' => array(
+        'table' => 'file_managed',
+        'columns' => array('fid' => 'fid'),
+      ),
+    ),
+  );
+  db_create_table('file_metadata', $schema);
+}
+
+/**
+ * Migrate the image_dimensions table to the new file_metadata table.
+ */
+function file_entity_update_7212(&$sandbox) {
+  if (!db_table_exists('image_dimensions')) {
+    return;
+  }
+
+  if (!isset($sandbox['progress'])) {
+    $sandbox['progress'] = 0;
+    $sandbox['current_fid'] = 0;
+    $sandbox['max'] = db_query('SELECT COUNT(DISTINCT fid) FROM {image_dimensions}')->fetchField();
+  }
+
+  $results = db_query_range("SELECT fid, width, height FROM {image_dimensions} WHERE fid > :fid ORDER BY fid ASC", 0, 20, array(':fid' => $sandbox['current_fid']))->fetchAllAssoc('fid');
+
+  // Clear any existing records in the metadata table in case they exist
+  // because we only want to do one insert.
+  if (!empty($results)) {
+    db_delete('file_metadata')
+      ->condition('fid', array_keys($results), 'IN')
+      ->condition(db_or()
+        ->condition('name', 'width')
+        ->condition('name', 'height')
+      )
+      ->execute();
+  }
+
+  $values = array();
+  foreach ($results as $result) {
+    foreach (array('width', 'height') as $key) {
+      $values[] = array(
+        'fid' => $result->fid,
+        'name' => $key,
+        'value' => serialize((int) $result->{$key}),
+      );
+    }
+    $sandbox['progress'] += count($results);
+    $sandbox['current_fid'] = $result->fid;
+  }
+
+  if (!empty($values)) {
+    $query = db_insert('file_metadata');
+    $query->fields(array('fid', 'name', 'value'));
+    foreach ($values as $value) {
+      $query->values($value);
+    }
+    $query->execute();
+  }
+
+  $sandbox['#finished'] = empty($sandbox['max']) ? 1 : ($sandbox['progress'] / $sandbox['max']);
+
+  if ($sandbox['#finished'] >= 1) {
+    db_drop_table('image_dimensions');
+  }
+}
+
+/**
+ * Update default alt text and title image field descriptions.
+ */
+function file_entity_update_7213() {
+  if ($title_text_instance = field_info_instance('file', 'field_file_image_title_text', 'image')) {
+    if ($title_text_instance['description'] == 'Title text attribute') {
+      $title_text_instance['description'] = t('Title text is used in the tool tip when a user hovers their mouse over the image. Adding title text makes it easier to understand the context of an image and improves usability.');
+      field_update_instance($title_text_instance);
+    }
+  }
+
+  if ($alt_text_instance = field_info_instance('file', 'field_file_image_alt_text', 'image')) {
+    if ($alt_text_instance['description'] == '') {
+      $alt_text_instance['description'] = t('Alternative text is used by screen readers, search engines, and when the image cannot be loaded. By adding alt text you improve accessibility and search engine optimization.');
+      field_update_instance($alt_text_instance);
+    }
+  }
+}
+
+/**
+ * Fix the default value in {file_managed}.type to match the field schema.
+ */
+function file_entity_update_7214() {
+  db_drop_index('file_managed', 'file_type');
+  db_change_field('file_managed', 'type', 'type', array(
+    'description' => 'The type of this file.',
+    'type' => 'varchar',
+    'length' => 50,
+    'not null' => TRUE,
+    'default' => 'undefined',
+  ));
+  db_add_index('file_managed', 'file_type', array('type'));
+}
+
+/**
+ * Fix the {file_metadata}.fid schema.
+ */
+function file_entity_update_7215() {
+  // When changing a primary key serial field to an int, we need to add a
+  // temporary index to make this update work.
+  // @see https://drupal.org/node/190027
+  db_add_index('file_metadata', 'temp', array('fid'));
+  db_drop_primary_key('file_metadata');
+  db_change_field('file_metadata', 'fid', 'fid', array(
+    'description' => 'The {file_managed}.fid of the metadata.',
+    'type' => 'int',
+    'unsigned' => TRUE,
+    'not null' => TRUE,
+    'default' => 0,
+  ));
+  db_add_primary_key('file_metadata', array('fid', 'name'));
+  db_drop_index('file_metadata', 'temp');
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.js b/profiles/commons/modules/contrib/file_entity/file_entity.js
new file mode 100644
index 0000000..e70eac5
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.js
@@ -0,0 +1,16 @@
+(function ($) {
+
+Drupal.behaviors.fileFieldsetSummaries = {
+  attach: function (context) {
+    $('fieldset.file-form-destination', context).drupalSetSummary(function (context) {
+      var scheme = $('.form-item-scheme input:checked', context).parent().text();
+      return Drupal.t('Destination: @scheme', { '@scheme': scheme });
+    });
+    $('fieldset.file-form-user', context).drupalSetSummary(function (context) {
+      var name = $('.form-item-name input', context).val() || Drupal.settings.anonymous;
+      return Drupal.t('Associated with @name', { '@name': name });
+    });
+  }
+};
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.module b/profiles/commons/modules/contrib/file_entity/file_entity.module
new file mode 100644
index 0000000..3ca0bb7
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.module
@@ -0,0 +1,2571 @@
+<?php
+
+/**
+ * @file
+ * Extends Drupal file entities to be fieldable and viewable.
+ */
+
+/**
+ * Modules should return this value from hook_file_entity_access() to allow
+ * access to a file.
+ */
+define('FILE_ENTITY_ACCESS_ALLOW', 'allow');
+
+/**
+ * Modules should return this value from hook_file_entity_access() to deny
+ * access to a file.
+ */
+define('FILE_ENTITY_ACCESS_DENY', 'deny');
+
+/**
+ * Modules should return this value from hook_file_entity_access() to not affect
+ * file access.
+ */
+define('FILE_ENTITY_ACCESS_IGNORE', NULL);
+
+/**
+ * As part of extending Drupal core's file entity API, this module adds some
+ * functions to the 'file' namespace. For organization, those are kept in the
+ * 'file_entity.file_api.inc' file.
+ */
+require_once dirname(__FILE__) . '/file_entity.file_api.inc';
+
+// @todo Remove when http://drupal.org/node/977052 is fixed.
+require_once dirname(__FILE__) . '/file_entity.field.inc';
+
+/**
+ * Implements hook_hook_info().
+ */
+function file_entity_hook_info() {
+  $hooks = array(
+    'file_operation_info',
+    'file_operation_info_alter',
+    'file_type_info',
+    'file_type_info_alter',
+    'file_formatter_info',
+    'file_formatter_info_alter',
+    'file_view',
+    'file_view_alter',
+    'file_displays_alter',
+    'file_type',
+    'file_type_alter',
+    'file_download_headers_alter',
+    'file_entity_access',
+  );
+
+  return array_fill_keys($hooks, array('group' => 'file'));
+}
+
+/**
+ * Implements hook_hook_info_alter().
+ *
+ * Add support for existing core hooks to be located in modulename.file.inc.
+ */
+function file_entity_hook_info_alter(&$info) {
+  $hooks = array(
+    // File API hooks
+    'file_copy',
+    'file_move',
+    'file_validate',
+    // File access
+    'file_download',
+    'file_download_access',
+    'file_download_access_alter',
+    // File entity hooks
+    'file_load',
+    'file_presave',
+    'file_insert',
+    'file_update',
+    'file_delete',
+    // Miscellaneous hooks
+    'file_mimetype_mapping_alter',
+    'file_url_alter',
+  );
+  $info += array_fill_keys($hooks, array('group' => 'file'));
+}
+
+/**
+ * Implements hook_help().
+ */
+function file_entity_help($path, $arg) {
+  switch ($path) {
+    case 'admin/structure/file-types':
+      $output = '<p>' . t('When a file is uploaded to this website, it is assigned one of the following types, based on what kind of file it is.') . '</p>';
+      return $output;
+    case 'admin/structure/file-types/manage/%/display/preview':
+    case 'admin/structure/file-types/manage/%/file-display/preview':
+      drupal_set_message(t('Some modules rely on the Preview view mode to function correctly. Changing these settings may break parts of your site.'), 'warning');
+      break;
+  }
+}
+
+/**
+ * Implements hook_menu().
+ */
+function file_entity_menu() {
+  // File Configuration
+  // @todo Move this back to admin/config/media/file-types in Drupal 8 if
+  // MENU_MAX_DEPTH is increased to a value higher than 9.
+  $items['admin/structure/file-types'] = array(
+    'title' => 'File types',
+    'description' => 'Manage settings for the type of files used on your site.',
+    'page callback' => 'file_entity_list_types_page',
+    'access arguments' => array('administer file types'),
+    'file' => 'file_entity.admin.inc',
+  );
+  $items['admin/structure/file-types/add'] = array(
+    'title' => 'Add file type',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_file_type_form'),
+    'access arguments' => array('administer file types'),
+    'type' => MENU_LOCAL_ACTION,
+    'file' => 'file_entity.admin.inc',
+  );
+  $items['admin/structure/file-types/manage/%file_type'] = array(
+    'title' => 'Manage file types',
+    'description' => 'Manage settings for the type of files used on your site.',
+  );
+  $items['admin/structure/file-types/manage/%file_type/enable'] = array(
+    'title' => 'Enable',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_type_enable_confirm', 4),
+    'access arguments' => array('administer file types'),
+    'file' => 'file_entity.admin.inc',
+    'type' => MENU_CALLBACK,
+  );
+  $items['admin/structure/file-types/manage/%file_type/disable'] = array(
+    'title' => 'Disable',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_type_disable_confirm', 4),
+    'access arguments' => array('administer file types'),
+    'file' => 'file_entity.admin.inc',
+    'type' => MENU_CALLBACK,
+  );
+  $items['admin/structure/file-types/manage/%file_type/revert'] = array(
+    'title' => 'Revert',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_type_revert_confirm', 4),
+    'access arguments' => array('administer file types'),
+    'file' => 'file_entity.admin.inc',
+    'type' => MENU_CALLBACK,
+  );
+  $items['admin/structure/file-types/manage/%file_type/delete'] = array(
+    'title' => 'Delete',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_type_delete_confirm', 4),
+    'access arguments' => array('administer file types'),
+    'file' => 'file_entity.admin.inc',
+    'type' => MENU_CALLBACK,
+  );
+
+  $items['admin/content/file'] = array(
+    'title' => 'Files',
+    'description' => 'Manage files used on your site.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_admin_file'),
+    'access arguments' => array('administer files'),
+    'type' => MENU_LOCAL_TASK | MENU_NORMAL_ITEM,
+    'file' => 'file_entity.admin.inc',
+  );
+  $items['admin/content/file/list'] = array(
+    'title' => 'List',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+  );
+
+  // general view, edit, delete for files
+  $items['file/add'] = array(
+    'title' => 'Add file',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_add_upload', array()),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('create'),
+    'file' => 'file_entity.pages.inc',
+  );
+  if (module_exists('plupload') && module_exists('multiform')) {
+    $items['file/add']['page arguments'] = array('file_entity_add_upload_multiple');
+  }
+  $items['file/add/upload'] = array(
+    'title' => 'Upload',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+    'weight' => -10,
+  );
+  $items['file/%file'] = array(
+    'title callback' => 'entity_label',
+    'title arguments' => array('file', 1),
+    // The page callback also invokes drupal_set_title() in case
+    // the menu router's title is overridden by a menu link.
+    'page callback' => 'file_entity_view_page',
+    'page arguments' => array(1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('view', 1),
+    'file' => 'file_entity.pages.inc',
+  );
+  $items['file/%file/view'] = array(
+    'title' => 'View',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+    'weight' => -10,
+  );
+  $items['file/%file/usage'] = array(
+    'title' => 'Usage',
+    'page callback' => 'file_entity_usage_page',
+    'page arguments' => array(1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('update', 1),
+    'type' => MENU_LOCAL_TASK,
+    'context' => MENU_CONTEXT_PAGE,
+    'file' => 'file_entity.pages.inc',
+  );
+  $items['file/%file/download'] = array(
+    'title' => 'Download',
+    'page callback' => 'file_entity_download_page',
+    'page arguments' => array(1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('download', 1),
+    'file' => 'file_entity.pages.inc',
+    'type' => MENU_CALLBACK,
+  );
+  $items['file/%file/edit'] = array(
+    'title' => 'Edit',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_edit', 1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('update', 1),
+    'weight' => 0,
+    'type' => MENU_LOCAL_TASK,
+    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
+    'file' => 'file_entity.pages.inc',
+  );
+  $items['file/%file/delete'] = array(
+    'title' => 'Delete',
+    'page callback' => 'drupal_get_form',
+    'page arguments'  => array('file_entity_delete_form', 1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('delete', 1),
+    'weight' => 1,
+    'type' => MENU_LOCAL_TASK,
+    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
+    'file' => 'file_entity.pages.inc',
+  );
+
+  // Attach a "Manage file display" tab to each file type in the same way that
+  // Field UI attaches "Manage fields" and "Manage display" tabs. Note that
+  // Field UI does not have to be enabled; we're just using the same IA pattern
+  // here for attaching the "Manage file display" page.
+  $entity_info = entity_get_info('file');
+  foreach ($entity_info['bundles'] as $file_type => $bundle_info) {
+    if (isset($bundle_info['admin'])) {
+      // Get the base path and access.
+      $path = $bundle_info['admin']['path'];
+      $access = array_intersect_key($bundle_info['admin'], drupal_map_assoc(array('access callback', 'access arguments')));
+      $access += array(
+        'access callback' => 'user_access',
+        'access arguments' => array('administer file types'),
+      );
+
+      // The file type must be passed to the page callbacks. It might be
+      // configured as a wildcard (multiple file types sharing the same menu
+      // router path).
+      $file_type_argument = isset($bundle_info['admin']['bundle argument']) ? $bundle_info['admin']['bundle argument'] : $file_type;
+
+      $items[$path] = array(
+        'title' => 'Edit file type',
+        'title callback' => 'file_entity_type_get_name',
+        'title arguments' => array(4),
+        'page callback' => 'drupal_get_form',
+        'page arguments' => array('file_entity_file_type_form', $file_type_argument),
+        'file' => 'file_entity.admin.inc',
+      ) + $access;
+
+      // Add the 'File type settings' tab.
+      $items["$path/edit"] = array(
+        'title' => 'Edit',
+        'type' => MENU_DEFAULT_LOCAL_TASK,
+      );
+
+      // Add the 'Manage file display' tab.
+      $items["$path/file-display"] = array(
+        'title' => 'Manage file display',
+        'page callback' => 'drupal_get_form',
+        'page arguments' => array('file_entity_file_display_form', $file_type_argument, 'default'),
+        'type' => MENU_LOCAL_TASK,
+        'weight' => 3,
+        'file' => 'file_entity.admin.inc',
+      ) + $access;
+
+      // Add a secondary tab for each view mode.
+      $weight = 0;
+      $view_modes = array('default' => array('label' => t('Default'))) + $entity_info['view modes'];
+      foreach ($view_modes as $view_mode => $view_mode_info) {
+        $items["$path/file-display/$view_mode"] = array(
+          'title' => $view_mode_info['label'],
+          'page arguments' => array('file_entity_file_display_form', $file_type_argument, $view_mode),
+          'type' => ($view_mode == 'default' ? MENU_DEFAULT_LOCAL_TASK : MENU_LOCAL_TASK),
+          'weight' => ($view_mode == 'default' ? -10 : $weight++),
+          'file' => 'file_entity.admin.inc',
+          // View modes for which the 'custom settings' flag isn't TRUE are
+          // disabled via this access callback. This needs to extend, rather
+          // than override normal $access rules.
+          'access callback' => '_file_entity_view_mode_menu_access',
+          'access arguments' => array_merge(array($file_type_argument, $view_mode, $access['access callback']), $access['access arguments']),
+        );
+      }
+    }
+  }
+
+  $items['admin/config/media/file-settings'] = array(
+    'title' => 'File settings',
+    'description' => 'Configure allowed file extensions, default alt and title sources, and the file upload wizard.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_settings_form'),
+    'access arguments' => array('administer site configuration'),
+    'file' => 'file_entity.admin.inc',
+  );
+
+  // Optional devel module integration
+  if (module_exists('devel')) {
+    $items['file/%file/devel'] = array(
+      'title' => 'Devel',
+      'page callback' => 'devel_load_object',
+      'page arguments' => array('file', 1),
+      'access arguments' => array('access devel information'),
+      'type' => MENU_LOCAL_TASK,
+      'file' => 'devel.pages.inc',
+      'file path' => drupal_get_path('module', 'devel'),
+      'weight' => 100,
+    );
+    $items['file/%file/devel/load'] = array(
+      'title' => 'Load',
+      'type' => MENU_DEFAULT_LOCAL_TASK,
+    );
+    $items['file/%file/devel/render'] = array(
+      'title' => 'Render',
+      'page callback' => 'devel_render_object',
+      'page arguments' => array('file', 1),
+      'access arguments' => array('access devel information'),
+      'file' => 'devel.pages.inc',
+      'file path' => drupal_get_path('module', 'devel'),
+      'type' => MENU_LOCAL_TASK,
+      'weight' => 100,
+    );
+    if (module_exists('token')) {
+      $items['file/%file/devel/token'] = array(
+        'title' => 'Tokens',
+        'page callback' => 'token_devel_token_object',
+        'page arguments' => array('file', 1),
+        'access arguments' => array('access devel information'),
+        'type' => MENU_LOCAL_TASK,
+        'file' => 'token.pages.inc',
+        'file path' => drupal_get_path('module', 'token'),
+        'weight' => 5,
+      );
+    }
+  }
+
+  return $items;
+}
+
+/**
+ * Implements hook_menu_local_tasks_alter().
+ */
+function file_entity_menu_local_tasks_alter(&$data, $router_item, $root_path) {
+  // Add action link to 'file/add' on 'admin/content/file' page.
+  if ($root_path == 'admin/content/file') {
+    $item = menu_get_item('file/add');
+    if (!empty($item['access'])) {
+      $data['actions']['output'][] = array(
+        '#theme' => 'menu_local_action',
+        '#link' => $item,
+        '#weight' => $item['weight'],
+      );
+    }
+  }
+}
+
+/**
+ * Implement hook_permission().
+ */
+function file_entity_permission() {
+  $permissions = array(
+    'bypass file access' => array(
+      'title' => t('Bypass file access control'),
+      'description' => t('View, edit and delete all files regardless of permission restrictions.'),
+      'restrict access' => TRUE,
+    ),
+    'administer file types' => array(
+      'title' => t('Administer file types'),
+      'restrict access' => TRUE,
+    ),
+    'administer files' => array(
+      'title' => t('Administer files'),
+      'restrict access' => TRUE,
+    ),
+    'create files' => array(
+      'title' => t('Add and upload new files'),
+    ),
+    'view own private files' => array(
+      'title' => t('View own private files'),
+    ),
+    'view own files' => array(
+      'title' => t('View own files'),
+    ),
+    'view private files' => array(
+      'title' => t('View private files'),
+      'restrict access' => TRUE,
+    ),
+    'view files' => array(
+      'title' => t('View files'),
+    ),
+  );
+
+  // Add description for the 'View file details' and 'View own private file
+  // details' permissions to show which stream wrappers they apply to.
+  $wrappers = file_entity_get_public_and_private_stream_wrapper_names();
+  $wrappers += array('public' => array(t('None')), 'private' => array(t('None')));
+
+  $permissions['view files']['description'] = t('Includes the following stream wrappers: %wrappers.', array('%wrappers' => implode(', ', $wrappers['public'])));
+  $permissions['view own private files']['description'] = t('Includes the following stream wrappers: %wrappers.', array('%wrappers' => implode(', ', $wrappers['private'])));
+
+  // Generate standard file permissions for all applicable file types.
+  foreach (file_entity_permissions_get_configured_types() as $type) {
+    $permissions += file_entity_list_permissions($type);
+  }
+
+  return $permissions;
+}
+
+/*
+ * Implements hook_cron_queue_info().
+ */
+function file_entity_cron_queue_info() {
+  $queues['file_entity_type_determine'] = array(
+    'worker callback' => 'file_entity_type_determine',
+  );
+  return $queues;
+}
+
+/*
+ * Determines file type for a given file ID and saves the file.
+ *
+ * @param $fid
+ *   A file ID.
+ */
+function file_entity_type_determine($fid) {
+  if ($file = file_load($fid)) {
+    // The file type will be automatically determined when saving the file.
+    file_save($file);
+  }
+}
+
+/**
+ * Gather the rankings from the the hook_ranking implementations.
+ *
+ * @param $query
+ *   A query object that has been extended with the Search DB Extender.
+ */
+function _file_entity_rankings(SelectQueryExtender $query) {
+  if ($ranking = module_invoke_all('file_ranking')) {
+    $tables = &$query->getTables();
+    foreach ($ranking as $rank => $values) {
+      if ($file_rank = variable_get('file_entity_rank_' . $rank, 0)) {
+        // If the table defined in the ranking isn't already joined, then add it.
+        if (isset($values['join']) && !isset($tables[$values['join']['alias']])) {
+          $query->addJoin($values['join']['type'], $values['join']['table'], $values['join']['alias'], $values['join']['on']);
+        }
+        $arguments = isset($values['arguments']) ? $values['arguments'] : array();
+        $query->addScore($values['score'], $arguments, $file_rank);
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_search_info().
+ */
+function file_entity_search_info() {
+  return array(
+    'title' => 'Files',
+    'path' => 'file',
+  );
+}
+
+/**
+ * Implements hook_search_access().
+ */
+function file_entity_search_access() {
+  return user_access('view own private files') || user_access('view own files') || user_access('view private files') || user_access('view files');
+}
+
+/**
+ * Implements hook_search_reset().
+ */
+function file_entity_search_reset() {
+  db_update('search_dataset')
+    ->fields(array('reindex' => REQUEST_TIME))
+    ->condition('type', 'file')
+    ->execute();
+}
+
+/**
+ * Implements hook_search_status().
+ */
+function file_entity_search_status() {
+  $total = db_query('SELECT COUNT(*) FROM {file_managed}')->fetchField();
+  $remaining = db_query("SELECT COUNT(*) FROM {file_managed} fm LEFT JOIN {search_dataset} d ON d.type = 'file' AND d.sid = fm.fid WHERE d.sid IS NULL OR d.reindex <> 0")->fetchField();
+  return array('remaining' => $remaining, 'total' => $total);
+}
+
+/**
+ * Implements hook_search_admin().
+ */
+function file_entity_search_admin() {
+  // Output form for defining rank factor weights.
+  $form['file_ranking'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('File ranking'),
+  );
+  $form['file_ranking']['#theme'] = 'file_entity_search_admin';
+  $form['file_ranking']['info'] = array(
+    '#value' => '<em>' . t('The following numbers control which properties the file search should favor when ordering the results. Higher numbers mean more influence, zero means the property is ignored. Changing these numbers does not require the search index to be rebuilt. Changes take effect immediately.') . '</em>'
+  );
+
+  // Note: reversed to reflect that higher number = higher ranking.
+  $options = drupal_map_assoc(range(0, 10));
+  foreach (module_invoke_all('file_ranking') as $var => $values) {
+    $form['file_ranking']['factors']['file_entity_rank_' . $var] = array(
+      '#title' => $values['title'],
+      '#type' => 'select',
+      '#options' => $options,
+      '#default_value' => variable_get('file_entity_rank_' . $var, 0),
+    );
+  }
+  return $form;
+}
+
+/**
+ * Implements hook_search_execute().
+ */
+function file_entity_search_execute($keys = NULL, $conditions = NULL) {
+  global $user;
+
+  // Build matching conditions
+  $query = db_select('search_index', 'i', array('target' => 'slave'))->extend('SearchQuery')->extend('PagerDefault');
+  $query->join('file_managed', 'fm', 'fm.fid = i.sid');
+  $query->searchExpression($keys, 'file');
+
+  // Insert special keywords.
+  $query->setOption('type', 'fm.type');
+  if ($query->setOption('term', 'ti.tid')) {
+    $query->join('taxonomy_index', 'ti', 'fm.fid = ti.fid');
+  }
+  // Only continue if the first pass query matches.
+  if (!$query->executeFirstPass()) {
+    return array();
+  }
+
+  // Add the ranking expressions.
+  _file_entity_rankings($query);
+
+  // Load results.
+  $find = $query
+    ->limit(10)
+    ->addTag('file_access')
+    ->execute();
+  $results = array();
+  foreach ($find as $item) {
+    // Render the file.
+    $file = file_load($item->sid);
+    $build = file_view($file, 'search_result');
+    unset($build['#theme']);
+    $file->rendered = drupal_render($build);
+
+    $extra = module_invoke_all('file_entity_search_result', $file);
+
+    $types = file_entity_type_get_names();
+
+    $uri = entity_uri('file', $file);
+    $results[] = array(
+      'link' => url($uri['path'], array_merge($uri['options'], array('absolute' => TRUE))),
+      'type' => check_plain($types[$file->type]),
+      'title' => $file->filename,
+      'user' => theme('username', array('account' => user_load($file->uid))),
+      'date' => $file->timestamp,
+      'file' => $file,
+      'extra' => $extra,
+      'score' => $item->calculated_score,
+      'snippet' => search_excerpt($keys, $file->rendered),
+      'language' => function_exists('entity_language') ? entity_language('file', $file) : NULL,
+    );
+  }
+  return $results;
+}
+
+/**
+ * Implements hook_file_ranking().
+ */
+function file_entity_file_ranking() {
+  // Create the ranking array and add the basic ranking options.
+  $ranking = array(
+    'relevance' => array(
+      'title' => t('Keyword relevance'),
+      // Average relevance values hover around 0.15
+      'score' => 'i.relevance',
+    ),
+  );
+
+  // Add relevance based on creation date.
+  if ($file_cron_last = variable_get('file_entity_cron_last', 0)) {
+    $ranking['timestamp'] = array(
+      'title' => t('Recently posted'),
+      // Exponential decay with half-life of 6 months, starting at last indexed file
+      'score' => 'POW(2.0, (fm.timestamp - :file_cron_last) * 6.43e-8)',
+      'arguments' => array(':file_cron_last' => $file_cron_last),
+    );
+  }
+  return $ranking;
+}
+
+/**
+ * Returns HTML for the file ranking part of the search settings admin page.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - form: A render element representing the form.
+ *
+ * @ingroup themeable
+ */
+function theme_file_entity_search_admin($variables) {
+  $form = $variables['form'];
+
+  $output = drupal_render($form['info']);
+
+  $header = array(t('Factor'), t('Weight'));
+  foreach (element_children($form['factors']) as $key) {
+    $row = array();
+    $row[] = $form['factors'][$key]['#title'];
+    $form['factors'][$key]['#title_display'] = 'invisible';
+    $row[] = drupal_render($form['factors'][$key]);
+    $rows[] = $row;
+  }
+  $output .= theme('table', array('header' => $header, 'rows' => $rows));
+
+  $output .= drupal_render_children($form);
+  return $output;
+}
+
+/**
+ * Implements hook_update_index().
+ */
+function file_entity_update_index() {
+  $limit = (int)variable_get('search_cron_limit', 100);
+
+  $result = db_query_range("SELECT fm.fid FROM {file_managed} fm LEFT JOIN {search_dataset} d ON d.type = 'file' AND d.sid = fm.fid WHERE d.sid IS NULL OR d.reindex <> 0 ORDER BY d.reindex ASC, fm.fid ASC", 0, $limit, array(), array('target' => 'slave'));
+
+  foreach ($result as $file) {
+    _file_entity_index_file($file);
+  }
+}
+
+/**
+ * Index a single file.
+ *
+ * @param $file
+ *   The file to index.
+ */
+function _file_entity_index_file($file) {
+  $file = file_load($file->fid);
+
+  // Save the creation time of the most recent indexed file, for the search
+  // results half-life calculation.
+  variable_set('file_entity_cron_last', $file->timestamp);
+
+  // Render the file.
+  $build = file_view($file, 'search_index');
+  unset($build['#theme']);
+  $file->rendered = drupal_render($build);
+
+  $text = '<h1>' . check_plain($file->filename) . '</h1>' . $file->rendered;
+
+  // Fetch extra data normally not visible
+  $extra = module_invoke_all('file_entity_update_index', $file);
+  foreach ($extra as $t) {
+    $text .= $t;
+  }
+
+  // Update index
+  search_index($file->fid, 'file', $text);
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ */
+function file_entity_form_search_form_alter(&$form, $form_state) {
+  if (isset($form['module']) && $form['module']['#value'] == 'file_entity' && user_access('use advanced search')) {
+    // Keyword boxes:
+    $form['advanced'] = array(
+      '#type' => 'fieldset',
+      '#title' => t('Advanced search'),
+      '#collapsible' => TRUE,
+      '#collapsed' => TRUE,
+      '#attributes' => array('class' => array('search-advanced')),
+    );
+    $form['advanced']['keywords'] = array(
+      '#prefix' => '<div class="criterion">',
+      '#suffix' => '</div>',
+    );
+    $form['advanced']['keywords']['or'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Containing any of the words'),
+      '#size' => 30,
+      '#maxlength' => 255,
+    );
+    $form['advanced']['keywords']['phrase'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Containing the phrase'),
+      '#size' => 30,
+      '#maxlength' => 255,
+    );
+    $form['advanced']['keywords']['negative'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Containing none of the words'),
+      '#size' => 30,
+      '#maxlength' => 255,
+    );
+
+    // File types:
+    $types = array_map('check_plain', file_entity_type_get_names());
+    $form['advanced']['type'] = array(
+      '#type' => 'checkboxes',
+      '#title' => t('Only of the type(s)'),
+      '#prefix' => '<div class="criterion">',
+      '#suffix' => '</div>',
+      '#options' => $types,
+    );
+    $form['advanced']['submit'] = array(
+      '#type' => 'submit',
+      '#value' => t('Advanced search'),
+      '#prefix' => '<div class="action">',
+      '#suffix' => '</div>',
+      '#weight' => 100,
+    );
+
+    $form['#validate'][] = 'file_entity_search_validate';
+  }
+}
+
+/**
+ * Form API callback for the search form. Registered in file_entity_form_alter().
+ */
+function file_entity_search_validate($form, &$form_state) {
+  // Initialize using any existing basic search keywords.
+  $keys = $form_state['values']['processed_keys'];
+
+  // Insert extra restrictions into the search keywords string.
+  if (isset($form_state['values']['type']) && is_array($form_state['values']['type'])) {
+    // Retrieve selected types - Form API sets the value of unselected
+    // checkboxes to 0.
+    $form_state['values']['type'] = array_filter($form_state['values']['type']);
+    if (count($form_state['values']['type'])) {
+      $keys = search_expression_insert($keys, 'type', implode(',', array_keys($form_state['values']['type'])));
+    }
+  }
+
+  if (isset($form_state['values']['term']) && is_array($form_state['values']['term']) && count($form_state['values']['term'])) {
+    $keys = search_expression_insert($keys, 'term', implode(',', $form_state['values']['term']));
+  }
+  if ($form_state['values']['or'] != '') {
+    if (preg_match_all('/ ("[^"]+"|[^" ]+)/i', ' ' . $form_state['values']['or'], $matches)) {
+      $keys .= ' ' . implode(' OR ', $matches[1]);
+    }
+  }
+  if ($form_state['values']['negative'] != '') {
+    if (preg_match_all('/ ("[^"]+"|[^" ]+)/i', ' ' . $form_state['values']['negative'], $matches)) {
+      $keys .= ' -' . implode(' -', $matches[1]);
+    }
+  }
+  if ($form_state['values']['phrase'] != '') {
+    $keys .= ' "' . str_replace('"', ' ', $form_state['values']['phrase']) . '"';
+  }
+  if (!empty($keys)) {
+    form_set_value($form['basic']['processed_keys'], trim($keys), $form_state);
+  }
+}
+
+/**
+ * Implements hook_admin_paths().
+ */
+function file_entity_admin_paths() {
+  $paths = array(
+    'file/add' => TRUE,
+    'file/add/*' => TRUE,
+    'file/*/edit' => TRUE,
+    'file/*/usage' => TRUE,
+    'file/*/delete' => TRUE,
+  );
+  return $paths;
+}
+
+/**
+ * Implements hook_action_info_alter().
+ */
+function file_entity_action_info_alter(&$actions) {
+  if (module_exists('pathauto')) {
+    $actions['pathauto_file_update_action'] = array(
+      'type' => 'file',
+      'label' => t('Update file alias'),
+      'configurable' => FALSE,
+    );
+  }
+}
+
+/**
+ * Implements hook_theme().
+ */
+function file_entity_theme() {
+  return array(
+    'file_entity' => array(
+      'render element' => 'elements',
+      'template' => 'file_entity',
+    ),
+    'file_entity_search_admin' => array(
+      'render element' => 'form',
+    ),
+    'file_entity_file_type_overview' => array(
+      'variables' => array('label' => NULL, 'description' => NULL),
+      'file' => 'file_entity.admin.inc',
+    ),
+    'file_entity_file_display_order' => array(
+      'render element' => 'element',
+      'file' => 'file_entity.admin.inc',
+    ),
+    'file_entity_file_link' => array(
+      'variables' => array('file' => NULL, 'icon_directory' => NULL),
+      'file' => 'file_entity.theme.inc',
+    ),
+    'file_entity_download_link' => array(
+      'variables' => array('file' => NULL, 'icon_directory' => NULL, 'text' => NULL),
+      'file' => 'file_entity.theme.inc',
+    ),
+    'file_entity_file_audio' => array(
+      'variables' => array(
+        'files' => array(),
+        'controls' => TRUE,
+        'autoplay' => FALSE,
+        'loop' => FALSE,
+      ),
+      'file' => 'file_entity.theme.inc',
+    ),
+    'file_entity_file_video' => array(
+      'variables' => array(
+        'files' => array(),
+        'controls' => TRUE,
+        'autoplay' => FALSE,
+        'loop' => FALSE,
+        'muted' => FALSE,
+        'width' => NULL,
+        'height' => NULL,
+      ),
+      'file' => 'file_entity.theme.inc',
+    ),
+  );
+}
+
+/**
+ * Implements hook_entity_info_alter().
+ *
+ * Extends the core file entity to be fieldable. The file type is used as the
+ * bundle key. File types are implemented as CTools exportables, so modules can
+ * define default file types via hook_file_default_types(), and the
+ * administrator can override the default types or add custom ones via
+ * admin/structure/file-types.
+ */
+function file_entity_entity_info_alter(&$entity_info) {
+  $entity_info['file']['fieldable'] = TRUE;
+  $entity_info['file']['entity keys']['bundle'] = 'type';
+  $entity_info['file']['bundle keys']['bundle'] = 'type';
+  $entity_info['file']['bundles'] = array();
+  $entity_info['file']['uri callback'] = 'file_entity_uri';
+  $entity_info['file']['view modes']['teaser'] = array(
+    'label' => t('Teaser'),
+    'custom settings' => TRUE,
+  );
+  $entity_info['file']['view modes']['full'] = array(
+    'label' => t('Full content'),
+    'custom settings' => FALSE,
+  );
+  $entity_info['file']['view modes']['preview'] = array(
+    'label' => t('Preview'),
+    'custom settings' => TRUE,
+  );
+  $entity_info['file']['view modes']['rss'] = array(
+    'label' => t('RSS'),
+    'custom settings' => FALSE,
+  );
+
+  // Search integration is provided by file_entity.module, so search-related
+  // view modes for files are defined here and not in search.module.
+  if (module_exists('search')) {
+    $entity_info['file']['view modes']['search_index'] = array(
+      'label' => t('Search index'),
+      'custom settings' => FALSE,
+    );
+    $entity_info['file']['view modes']['search_result'] = array(
+      'label' => t('Search result'),
+      'custom settings' => FALSE,
+    );
+  }
+
+  foreach (file_type_get_enabled_types() as $type) {
+    $entity_info['file']['bundles'][$type->type] = array(
+      'label' => $type->label,
+      'admin' => array(
+        'path' => 'admin/structure/file-types/manage/%file_type',
+        'real path' => 'admin/structure/file-types/manage/' . $type->type,
+        'bundle argument' => 4,
+      ),
+    );
+  }
+
+  // Enable Metatag support.
+  $entity_info['file']['metatags'] = TRUE;
+
+  // Ensure some of the Entity API callbacks are supported.
+  $entity_info['file']['creation callback'] = 'entity_metadata_create_object';
+  $entity_info['file']['view callback'] = 'file_view_multiple';
+  $entity_info['file']['edit callback'] = 'file_entity_metadata_form_file';
+  $entity_info['file']['access callback'] = 'file_entity_access';
+
+  // Add integration with the Title module for file name replacement support.
+  $entity_info['file']['field replacement'] = array(
+    'filename' => array(
+      'field' => array(
+        'type' => 'text',
+        'cardinality' => 1,
+        'translatable' => TRUE,
+      ),
+      'instance' => array(
+        'label' => t('File name'),
+        'description' => t('A field replacing file name.'),
+        'required' => TRUE,
+        'settings' => array(
+          'text_processing' => 0,
+        ),
+        'widget' => array(
+          'weight' => -5,
+        ),
+        'display' => array(
+          'default' => array(
+            'type' => 'hidden',
+          ),
+        ),
+      ),
+      'preprocess_key' => 'filename',
+    ),
+  );
+}
+
+/**
+ * Implements hook_entity_property_info().
+ */
+function file_entity_entity_property_info() {
+  $info['file']['properties']['type'] = array(
+    'label' => t('File type'),
+    'type' => 'token',
+    'description' => t('The type of the file.'),
+    'setter callback' => 'entity_property_verbatim_set',
+    'setter permission' => 'administer files',
+    'options list' => 'file_entity_type_get_names',
+    'required' => TRUE,
+    'schema field' => 'type',
+  );
+
+  return $info;
+}
+
+/**
+ * Implements hook_field_display_ENTITY_TYPE_alter().
+ */
+function file_entity_field_display_file_alter(&$display, $context) {
+  // Hide field labels in search index.
+  if ($context['view_mode'] == 'search_index') {
+    $display['label'] = 'hidden';
+  }
+}
+
+/**
+ * URI callback for file entities.
+ */
+function file_entity_uri($file) {
+  $uri['path'] = 'file/' . $file->fid;
+  return $uri;
+}
+
+/**
+ * Entity API callback to get the form of a file entity.
+ */
+function file_entity_metadata_form_file($file) {
+  // Pre-populate the form-state with the right form include.
+  $form_state['build_info']['args'] = array($file);
+  form_load_include($form_state, 'inc', 'file_entity', 'file_entity.pages');
+  return drupal_build_form('file_entity_edit', $form_state);
+}
+
+/**
+ * Implements hook_ctools_plugin_directory().
+ */
+
+function file_entity_ctools_plugin_directory($module, $type) {
+  if ($module == 'ctools' && $type == 'content_types') {
+    return 'plugins/' . $type;
+  }
+}
+
+/**
+ * Implements hook_field_extra_fields().
+ *
+ * Adds 'file' as an extra field, so that its display and form component can be
+ * weighted relative to the fields that are added to file entity bundles.
+ */
+function file_entity_field_extra_fields() {
+  $info = array();
+
+  if ($file_type_names = file_entity_type_get_names()) {
+    foreach ($file_type_names as $type => $name) {
+      $info['file'][$type]['form']['filename'] = array(
+        'label' => t('File name'),
+        'description' => t('File name'),
+        'weight' => -10,
+      );
+      $info['file'][$type]['form']['preview'] = array(
+        'label' => t('File'),
+        'description' => t('File preview'),
+        'weight' => -5,
+      );
+      $info['file'][$type]['display']['file'] = array(
+        'label' => t('File'),
+        'description' => t('File display'),
+        'weight' => 0,
+      );
+    }
+  }
+
+  return $info;
+}
+
+/**
+ * Implements hook_file_formatter_info().
+ */
+function file_entity_file_formatter_info() {
+  $formatters = array();
+
+  // Allow file field formatters to be reused for displaying the file entity's
+  // file pseudo-field.
+  foreach (field_info_formatter_types() as $key => $formatter) {
+    if (array_intersect($formatter['field types'], array('file', 'image'))) {
+      $key = 'file_field_' . $key;
+      $formatters[$key] = array(
+        'label' => $formatter['label'],
+        'description' => !empty($formatter['description']) ? $formatter['description'] : '',
+        'view callback' => 'file_entity_file_formatter_file_field_view',
+      );
+      if (!empty($formatter['settings'])) {
+        $formatters[$key] += array(
+          'default settings' => $formatter['settings'],
+          'settings callback' => 'file_entity_file_formatter_file_field_settings',
+        );
+      }
+      if (!empty($formatter['file formatter'])) {
+        $formatters[$key] += $formatter['file formatter'];
+      }
+    }
+  }
+
+  // Add a simple file formatter for displaying an image in a chosen style.
+  if (module_exists('image')) {
+    $formatters['file_image'] = array(
+      'label' => t('Image'),
+      'default settings' => array(
+        'image_style' => '',
+        'alt' => '[file:field_file_image_alt_text]',
+        'title' => '[file:field_file_image_title_text]'
+      ),
+      'view callback' => 'file_entity_file_formatter_file_image_view',
+      'settings callback' => 'file_entity_file_formatter_file_image_settings',
+      'hidden' => TRUE,
+      'mime types' => array('image/*'),
+    );
+  }
+
+  return $formatters;
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_view().
+ *
+ * This function provides a bridge to the field formatter API, so that file
+ * field formatters can be reused for displaying the file entity's file
+ * pseudo-field.
+ */
+function file_entity_file_formatter_file_field_view($file, $display, $langcode) {
+  if (strpos($display['type'], 'file_field_') === 0) {
+    $field_formatter_type = substr($display['type'], strlen('file_field_'));
+    $field_formatter_info = field_info_formatter_types($field_formatter_type);
+    if (isset($field_formatter_info['module'])) {
+      // Set $display['type'] to what hook_field_formatter_*() expects.
+      $display['type'] = $field_formatter_type;
+
+      // Set $items to what file field formatters expect. See file_field_load(),
+      // and note that, here, $file is already a fully loaded entity.
+      $items = array((array) $file);
+
+      // Invoke hook_field_formatter_prepare_view() and
+      // hook_field_formatter_view(). Note that we are reusing field formatter
+      // functions, but we are not displaying a Field API field, so we set
+      // $field and $instance accordingly, and do not invoke
+      // hook_field_prepare_view(). This assumes that the formatter functions do
+      // not rely on $field or $instance. A module that implements formatter
+      // functions that rely on $field or $instance (and therefore, can only be
+      // used for real fields) can prevent this formatter from being used on the
+      // pseudo-field by removing it within hook_file_formatter_info_alter().
+      $field = $instance = NULL;
+      if (($function = ($field_formatter_info['module'] . '_field_formatter_prepare_view')) && function_exists($function)) {
+        $fid = $file->fid;
+        // hook_field_formatter_prepare_view() alters $items by reference.
+        $grouped_items = array($fid => &$items);
+        $function('file', array($fid => $file), $field, array($fid => $instance), $langcode, $grouped_items, array($fid => $display));
+      }
+      if (($function = ($field_formatter_info['module'] . '_field_formatter_view')) && function_exists($function)) {
+        $element = $function('file', $file, $field, $instance, $langcode, $items, $display);
+        // We passed the file as $items[0], so return the corresponding element.
+        if (isset($element[0])) {
+          return $element[0];
+        }
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_settings().
+ *
+ * This function provides a bridge to the field formatter API, so that file
+ * field formatters can be reused for displaying the file entity's file
+ * pseudo-field.
+ */
+function file_entity_file_formatter_file_field_settings($form, &$form_state, $settings, $formatter_type, $file_type, $view_mode) {
+  if (strpos($formatter_type, 'file_field_') === 0) {
+    $field_formatter_type = substr($formatter_type, strlen('file_field_'));
+    $field_formatter_info = field_info_formatter_types($field_formatter_type);
+
+    // Invoke hook_field_formatter_settings_form(). We are reusing field
+    // formatter functions, but we are not working with a Field API field, so
+    // set $field accordingly. Unfortunately, the API is for $settings to be
+    // transfered via the $instance parameter, so we must mock it.
+    if (isset($field_formatter_info['module']) && ($function = ($field_formatter_info['module'] . '_field_formatter_settings_form')) && function_exists($function)) {
+      $field = NULL;
+      $mock_instance = array(
+        'display' => array(
+          $view_mode => array(
+            'type' => $field_formatter_type,
+            'settings' => $settings,
+          ),
+        ),
+        'entity_type' => 'file',
+        'bundle' => $file_type,
+      );
+      return $function($field, $mock_instance, $view_mode, $form, $form_state);
+    }
+  }
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_view().
+ *
+ * Returns a drupal_render() array to display an image of the chosen style.
+ *
+ * This formatter is only capable of displaying local images. If the passed in
+ * file is either not local or not an image, nothing is returned, so that
+ * file_view_file() can try another formatter.
+ */
+function file_entity_file_formatter_file_image_view($file, $display, $langcode) {
+  // Prevent PHP notices when trying to read empty files.
+  // @see http://drupal.org/node/681042
+  if (!$file->filesize) {
+    return;
+  }
+
+  // Do not bother proceeding if this file does not have an image mime type.
+  if (file_entity_file_get_mimetype_type($file) != 'image') {
+    return;
+  }
+
+  if (file_entity_file_is_readable($file)) {
+    // We don't sanitize here.
+    // @see http://drupal.org/node/1553094#comment-6257382
+    // Theme function will take care of escaping.
+    if (!isset($file->metadata)) {
+      $file->metadata = array();
+    }
+    $file->metadata += array('width' => NULL, 'height' => NULL);
+    $replace_options = array(
+      'clear' => TRUE,
+      'sanitize' => FALSE,
+    );
+    if (!empty($display['settings']['image_style'])) {
+      $element = array(
+        '#theme' => 'image_style',
+        '#style_name' => $display['settings']['image_style'],
+        '#path' => $file->uri,
+        '#width' => isset($file->override['attributes']['width']) ? $file->override['attributes']['width'] : $file->metadata['width'],
+        '#height' => isset($file->override['attributes']['height']) ? $file->override['attributes']['height'] : $file->metadata['height'],
+        '#alt' => token_replace($display['settings']['alt'], array('file' => $file), $replace_options),
+        '#title' => token_replace($display['settings']['title'], array('file' => $file), $replace_options),
+      );
+    }
+    else {
+      $element = array(
+        '#theme' => 'image',
+        '#path' => $file->uri,
+        '#width' => isset($file->override['attributes']['width']) ? $file->override['attributes']['width'] : $file->metadata['width'],
+        '#height' => isset($file->override['attributes']['height']) ? $file->override['attributes']['height'] : $file->metadata['height'],
+        '#alt' => token_replace($display['settings']['alt'], array('file' => $file), $replace_options),
+        '#title' => token_replace($display['settings']['title'], array('file' => $file), $replace_options),
+      );
+    }
+    return $element;
+  }
+}
+
+/**
+ * Check if a file entity is readable or not.
+ *
+ * @param object $file
+ *   A file entity object from file_load().
+ *
+ * @return boolean
+ *   TRUE if the file is using a readable stream wrapper, or FALSE otherwise.
+ */
+function file_entity_file_is_readable($file) {
+  $scheme = file_uri_scheme($file->uri);
+  $wrappers = file_get_stream_wrappers(STREAM_WRAPPERS_READ);
+  return !empty($wrappers[$scheme]);
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_settings().
+ *
+ * Returns form elements for configuring the 'file_image' formatter.
+ */
+function file_entity_file_formatter_file_image_settings($form, &$form_state, $settings) {
+  $element = array();
+  $element['image_style'] = array(
+    '#title' => t('Image style'),
+    '#type' => 'select',
+    '#options' => image_style_options(FALSE),
+    '#default_value' => $settings['image_style'],
+    '#empty_option' => t('None (original image)'),
+  );
+
+  // For image files we allow the alt attribute (required in HTML).
+  $element['alt'] = array(
+    '#title' => t('Alt attribute'),
+    '#description' => t('The text to use as value for the <em>img</em> tag <em>alt</em> attribute.'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['alt'],
+  );
+
+  // Allow the setting of the title attribute.
+  $element['title'] = array(
+    '#title' => t('Title attribute'),
+    '#description' => t('The text to use as value for the <em>img</em> tag <em>title</em> attribute.'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['title'],
+  );
+
+  if (module_exists('token')) {
+    $element['alt']['#description'] .= t('This field supports tokens.');
+    $element['title']['#description'] .= t('This field supports tokens.');
+    $element['tokens'] = array(
+      '#theme' => 'token_tree',
+      '#token_types' => array('file'),
+      '#dialog' => TRUE,
+    );
+  }
+
+  return $element;
+}
+
+/**
+ * Menu access callback for the 'view mode file display settings' pages.
+ *
+ * Based on _field_ui_view_mode_menu_access(), but the Field UI module might not
+ * be enabled.
+ */
+function _file_entity_view_mode_menu_access($file_type, $view_mode, $access_callback) {
+  // Deny access if the view mode isn't configured to use custom display
+  // settings.
+  $view_mode_settings = field_view_mode_settings('file', $file_type->type);
+  $visibility = ($view_mode == 'default') || !empty($view_mode_settings[$view_mode]['custom_settings']);
+  if (!$visibility) {
+    return FALSE;
+  }
+
+  // Otherwise, continue to an $access_callback check.
+  $args = array_slice(func_get_args(), 3);
+  $callback = empty($access_callback) ? 0 : trim($access_callback);
+  if (is_numeric($callback)) {
+    return (bool) $callback;
+  }
+  elseif (function_exists($access_callback)) {
+    return call_user_func_array($access_callback, $args);
+  }
+}
+
+/**
+ * Implements hook_modules_enabled().
+ */
+function file_entity_modules_enabled($modules) {
+  file_info_cache_clear();
+}
+
+/**
+ * Implements hook_modules_disabled().
+ */
+function file_entity_modules_disabled($modules) {
+  file_info_cache_clear();
+}
+
+/**
+ * Implements hook_views_api().
+ */
+function file_entity_views_api() {
+  return array(
+    'api' => 3,
+  );
+}
+
+/**
+ * Returns whether the current page is the full page view of the passed-in file.
+ *
+ * @param $file
+ *   A file object.
+ */
+function file_entity_is_page($file) {
+  $page_file = menu_get_object('file', 1);
+  return (!empty($page_file) ? $page_file->fid == $file->fid : FALSE);
+}
+
+/**
+ * Process variables for file_entity.tpl.php
+ *
+ * The $variables array contains the following arguments:
+ * - $file
+ * - $view_mode
+ *
+ * @see file_entity.tpl.php
+ */
+function template_preprocess_file_entity(&$variables) {
+  $view_mode = $variables['view_mode'] = $variables['elements']['#view_mode'];
+  $variables['file'] = $variables['elements']['#file'];
+  $file = $variables['file'];
+
+  $variables['id'] = drupal_html_id('file-'. $file->fid);
+  $variables['date']      = format_date($file->timestamp);
+  $account = user_load($file->uid);
+  $variables['name']      = theme('username', array('account' => $account));
+
+  $uri = entity_uri('file', $file);
+  $variables['file_url']  = url($uri['path'], $uri['options']);
+  $label = entity_label('file', $file);
+  $variables['label']     = check_plain($label);
+  $variables['page']      = $view_mode == 'full' && file_entity_is_page($file);
+
+  // Hide the file name from being displayed until we can figure out a better
+  // way to control this. We cannot simply not output the title since
+  // contextual links require $title_suffix to be output in the template.
+  // @see http://drupal.org/node/1245266
+  if (!$variables['page']) {
+    $variables['title_attributes_array']['class'][] = 'element-invisible';
+  }
+
+  // Flatten the file object's member fields.
+  $variables = array_merge((array) $file, $variables);
+
+  // Helpful $content variable for templates.
+  $variables += array('content' => array());
+  foreach (element_children($variables['elements']) as $key) {
+    $variables['content'][$key] = $variables['elements'][$key];
+  }
+
+  // Make the field variables available with the appropriate language.
+  field_attach_preprocess('file', $file, $variables['content'], $variables);
+
+  // Attach the file object to the content element.
+  $variables['content']['file']['#file'] = $file;
+
+  // Display post information only on certain file types.
+  if (variable_get('file_submitted_' . $file->type, FALSE)) {
+    $variables['display_submitted'] = TRUE;
+    $variables['submitted'] = t('Uploaded by !username on !datetime', array('!username' => $variables['name'], '!datetime' => $variables['date']));
+    $variables['user_picture'] = theme_get_setting('toggle_file_user_picture') ? theme('user_picture', array('account' => $account)) : '';
+  }
+  else {
+    $variables['display_submitted'] = FALSE;
+    $variables['submitted'] = '';
+    $variables['user_picture'] = '';
+  }
+
+  // Gather file classes.
+  $variables['classes_array'][] = drupal_html_class('file-' . $file->type);
+  $variables['classes_array'][] = drupal_html_class('file-' . $file->filemime);
+  if ($file->status != FILE_STATUS_PERMANENT) {
+    $variables['classes_array'][] = 'file-temporary';
+  }
+
+  // Change the 'file-entity' class into 'file'
+  if ($variables['classes_array'][0] == 'file-entity') {
+    $variables['classes_array'][0] = 'file';
+  }
+
+  // Clean up name so there are no underscores.
+  $variables['theme_hook_suggestions'][] = 'file__' . $file->type;
+  $variables['theme_hook_suggestions'][] = 'file__' . $file->type . '__' . $view_mode;
+  $variables['theme_hook_suggestions'][] = 'file__' . str_replace(array('/', '-'), array('__', '_'), $file->filemime);
+  $variables['theme_hook_suggestions'][] = 'file__' . str_replace(array('/', '-'), array('__', '_'), $file->filemime) . '__' . $view_mode;
+  $variables['theme_hook_suggestions'][] = 'file__' . $file->fid;
+  $variables['theme_hook_suggestions'][] = 'file__' . $file->fid . '__' . $view_mode;
+}
+
+/**
+ * Returns the file type name of the passed file or file type string.
+ *
+ * @param $file
+ *   A file object or string that indicates the file type to return.
+ *
+ * @return
+ *   The file type name or FALSE if the file type is not found.
+ */
+function file_entity_type_get_name($file) {
+  $type = is_object($file) ? $file->type : $file;
+  $info = entity_get_info('file');
+  return isset($info['bundles'][$type]['label']) ? $info['bundles'][$type]['label'] : FALSE;
+}
+
+/**
+ * Returns a list of available file type names.
+ *
+ * @return
+ *   An array of file type names, keyed by the type.
+ */
+function file_entity_type_get_names() {
+  $names = &drupal_static(__FUNCTION__);
+
+  if (!isset($names)) {
+    $info = entity_get_info('file');
+    foreach ($info['bundles'] as $bundle => $bundle_info) {
+      $names[$bundle] = $bundle_info['label'];
+    }
+  }
+
+  return $names;
+}
+
+/**
+ * Return an array of available view modes for file entities.
+ */
+function file_entity_view_mode_labels() {
+  $labels = &drupal_static(__FUNCTION__);
+
+  if (!isset($options)) {
+    $entity_info = entity_get_info('file');
+    $labels = array('default' => t('Default'));
+    foreach ($entity_info['view modes'] as $machine_name => $mode) {
+      $labels[$machine_name] = $mode['label'];
+    }
+  }
+
+  return $labels;
+}
+
+/**
+ * Return the label for a specific file entity view mode.
+ */
+function file_entity_view_mode_label($view_mode, $default = FALSE) {
+  $labels = file_entity_view_mode_labels();
+  return isset($labels[$view_mode]) ? $labels[$view_mode] : $default;
+}
+
+/**
+ * Helper function to get a list of hidden stream wrappers.
+ *
+ * This is used in several places to filter queries for media so that files in
+ * temporary:// don't show up.
+ */
+function file_entity_get_hidden_stream_wrappers() {
+  return array_diff_key(file_get_stream_wrappers(STREAM_WRAPPERS_ALL), file_get_stream_wrappers(STREAM_WRAPPERS_VISIBLE));
+}
+
+/**
+ * Return a specific stream wrapper's registry information.
+ *
+ * @param $scheme
+ *   A URI scheme, a stream is referenced as "scheme://target".
+ *
+ * @see file_get_stream_wrappers()
+ */
+function file_entity_get_stream_wrapper($scheme) {
+  $wrappers = file_get_stream_wrappers();
+  return isset($wrappers[$scheme]) ? $wrappers[$scheme] : FALSE;
+}
+
+/**
+ * Implements hook_stream_wrappers_alter().
+ */
+function file_entity_stream_wrappers_alter(&$wrappers) {
+  if (isset($wrappers['private'])) {
+    $wrappers['private']['private'] = TRUE;
+  }
+  if (isset($wrappers['temporary'])) {
+    $wrappers['temporary']['private'] = TRUE;
+  }
+}
+
+/**
+ * Implements hook_ctools_plugin_api().
+ */
+function file_entity_ctools_plugin_api($owner, $api) {
+  if ($owner == 'file_entity' && $api == 'file_type') {
+    return array('version' => 1);
+  }
+  if ($owner == 'file_entity' && $api == 'file_default_displays') {
+    return array('version' => 1);
+  }
+}
+
+/**
+ * @defgroup file_entity_access File access rights
+ * @{
+ * The file access system determines who can do what to which files.
+ *
+ * In determining access rights for a file, file_entity_access() first checks
+ * whether the user has the "bypass file access" permission. Such users have
+ * unrestricted access to all files. user 1 will always pass this check.
+ *
+ * Next, all implementations of hook_file_entity_access() will be called. Each
+ * implementation may explicitly allow, explicitly deny, or ignore the access
+ * request. If at least one module says to deny the request, it will be rejected.
+ * If no modules deny the request and at least one says to allow it, the request
+ * will be permitted.
+ *
+ * There is no access grant system for files.
+ *
+ * In file listings, the process above is followed except that
+ * hook_file_entity_access() is not called on each file for performance reasons
+ * and for proper functioning of the pager system. When adding a filelisting to
+ * your module, be sure to use a dynamic query created by db_select()
+ * and add a tag of "file_entity_access". This will allow modules dealing
+ * with file access to ensure only files to which the user has access
+ * are retrieved, through the use of hook_query_TAG_alter().
+ *
+ * Note: Even a single module returning FILE_ENTITY_ACCESS_DENY from
+ * hook_file_entity_access() will block access to the file. Therefore,
+ * implementers should take care to not deny access unless they really intend to.
+ * Unless a module wishes to actively deny access it should return
+ * FILE_ENTITY_ACCESS_IGNORE (or simply return nothing)
+ * to allow other modules to control access.
+ *
+ * Stream wrappers that are considered private should implement a 'private'
+ * flag equal to TRUE in hook_stream_wrappers().
+ */
+
+/**
+ * Determine if a user may perform the given operation on the specified file.
+ *
+ * @param $op
+ *   The operation to be performed on the file. Possible values are:
+ *   - "view"
+ *   - "download"
+ *   - "update"
+ *   - "delete"
+ *   - "create"
+ * @param $file
+ *   The file object on which the operation is to be performed, or file type
+ *   (e.g. 'image') for "create" operation.
+ * @param $account
+ *   Optional, a user object representing the user for whom the operation is to
+ *   be performed. Determines access for a user other than the current user.
+ *
+ * @return
+ *   TRUE if the operation may be performed, FALSE otherwise.
+ */
+function file_entity_access($op, $file = NULL, $account = NULL) {
+  $rights = &drupal_static(__FUNCTION__, array());
+
+  if (!$file && !in_array($op, array('view', 'download', 'update', 'delete', 'create'), TRUE)) {
+    // If there was no file to check against, and the $op was not one of the
+    // supported ones, we return access denied.
+    return FALSE;
+  }
+
+  // If no user object is supplied, the access check is for the current user.
+  if (empty($account)) {
+    $account = $GLOBALS['user'];
+  }
+
+  // $file may be either an object or a file type. Since file types cannot be
+  // an integer, use either fid or type as the static cache id.
+  $cache_id = is_object($file) ? $file->fid : $file;
+
+  // If we've already checked access for this file, user and op, return from
+  // cache.
+  if (isset($rights[$account->uid][$cache_id][$op])) {
+    return $rights[$account->uid][$cache_id][$op];
+  }
+
+  if (user_access('bypass file access', $account)) {
+    return $rights[$account->uid][$cache_id][$op] = TRUE;
+  }
+
+  // We grant access to the file if both of the following conditions are met:
+  // - No modules say to deny access.
+  // - At least one module says to grant access.
+  $access = module_invoke_all('file_entity_access', $op, $file, $account);
+  if (in_array(FILE_ENTITY_ACCESS_DENY, $access, TRUE)) {
+    return $rights[$account->uid][$cache_id][$op] = FALSE;
+  }
+  elseif (in_array(FILE_ENTITY_ACCESS_ALLOW, $access, TRUE)) {
+    return $rights[$account->uid][$cache_id][$op] = TRUE;
+  }
+
+
+  // Fall back to default behaviors on view.
+  if ($op == 'view' && is_object($file)) {
+    $scheme = file_uri_scheme($file->uri);
+    $wrapper = file_entity_get_stream_wrapper($scheme);
+
+    if (!empty($wrapper['private'])) {
+      // For private files, users can view private files if the
+      // user has the 'view private files' permission.
+      if (user_access('view private files', $account)) {
+        return $rights[$account->uid][$cache_id][$op] = TRUE;
+      }
+
+      // For private files, users can view their own private files if the
+      // user is not anonymous, and has the 'view own private files' permission.
+      if (!empty($account->uid) && $file->uid == $account->uid && user_access('view own private files', $account)) {
+        return $rights[$account->uid][$cache_id][$op] = TRUE;
+      }
+    }
+    elseif ($file->status == FILE_STATUS_PERMANENT && $file->uid == $account->uid && user_access('view own files', $account)) {
+      // For non-private files, allow to see if user owns the file.
+      return $rights[$account->uid][$cache_id][$op] = TRUE;
+    }
+    elseif ($file->status == FILE_STATUS_PERMANENT && user_access('view files', $account)) {
+      // For non-private files, users can view if they have the 'view files'
+      // permission.
+      return $rights[$account->uid][$cache_id][$op] = TRUE;
+    }
+  }
+
+  return FALSE;
+}
+
+/**
+ * Implements hook_file_entity_access().
+ */
+function file_entity_file_entity_access($op, $file, $account) {
+  // If the file URI is invalid, deny access.
+  if (is_object($file) && !file_valid_uri($file->uri)) {
+    return FILE_ENTITY_ACCESS_DENY;
+  }
+
+  if ($op == 'create') {
+    if (user_access('create files')) {
+      return FILE_ENTITY_ACCESS_ALLOW;
+    }
+  }
+
+  if (!empty($file)) {
+    $type = is_string($file) ? $file : $file->type;
+
+    if (in_array($type, file_entity_permissions_get_configured_types())) {
+      if ($op == 'download') {
+        if (user_access('download any ' . $type . ' files', $account) || is_object($file) && user_access('download own ' . $type . ' files', $account) && ($account->uid == $file->uid)) {
+          return FILE_ENTITY_ACCESS_ALLOW;
+        }
+      }
+
+      if ($op == 'update') {
+        if (user_access('edit any ' . $type . ' files', $account) || (is_object($file) && user_access('edit own ' . $type . ' files', $account) && ($account->uid == $file->uid))) {
+          return FILE_ENTITY_ACCESS_ALLOW;
+        }
+      }
+
+      if ($op == 'delete') {
+        if (user_access('delete any ' . $type . ' files', $account) || (is_object($file) && user_access('delete own ' . $type . ' files', $account) && ($account->uid == $file->uid))) {
+          return FILE_ENTITY_ACCESS_ALLOW;
+        }
+      }
+    }
+  }
+
+  return FILE_ENTITY_ACCESS_IGNORE;
+}
+
+/**
+ * Implements hook_query_TAG_alter().
+ *
+ * This is the hook_query_alter() for queries tagged with 'file_access'. It adds
+ * file access checks for the user account given by the 'account' meta-data (or
+ * global $user if not provided).
+ */
+function file_entity_query_file_access_alter(QueryAlterableInterface $query) {
+  _file_entity_query_file_entity_access_alter($query, 'file');
+}
+
+/**
+ * Implements hook_query_TAG_alter().
+ *
+ * This function implements the same functionality as
+ * file_entity_query_file_access_alter() for the SQL field storage engine. File
+ * access conditions are added for field values belonging to files only.
+ */
+function file_entity_query_entity_field_access_alter(QueryAlterableInterface $query) {
+  //_file_entity_query_file_entity_access_alter($query, 'entity');
+}
+
+/**
+ * Helper for file entity access functions.
+ *
+ * @param $query
+ *   The query to add conditions to.
+ * @param $type
+ *   Either 'file' or 'entity' depending on what sort of query it is. See
+ *   file_entity_query_file_entity_access_alter() and
+ *   file_entity_query_entity_field_access_alter() for more.
+ */
+function _file_entity_query_file_entity_access_alter($query, $type) {
+  global $user;
+
+  // Read meta-data from query, if provided.
+  if (!$account = $query->getMetaData('account')) {
+    $account = $user;
+  }
+
+  // If $account can bypass file access, we don't need to alter the query.
+  if (user_access('bypass file access', $account)) {
+    return;
+  }
+
+  $tables = $query->getTables();
+  $base_table = $query->getMetaData('base_table');
+  // If no base table is specified explicitly, search for one.
+  if (!$base_table) {
+    $fallback = '';
+    foreach ($tables as $alias => $table_info) {
+      if (!($table_info instanceof SelectQueryInterface)) {
+        $table = $table_info['table'];
+        // If the file_managed table is in the query, it wins immediately.
+        if ($table == 'file_managed') {
+          $base_table = $table;
+          break;
+        }
+        // Check whether the table has a foreign key to file_managed.fid. If it
+        // does, do not run this check again as we found a base table and only
+        // file_managed can triumph that.
+        if (!$base_table) {
+          // The schema is cached.
+          $schema = drupal_get_schema($table);
+          if (isset($schema['fields']['fid'])) {
+            if (isset($schema['foreign keys'])) {
+              foreach ($schema['foreign keys'] as $relation) {
+                if ($relation['table'] === 'file_managed' && $relation['columns'] === array('fid' => 'fid')) {
+                  $base_table = $table;
+                }
+              }
+            }
+            else {
+              // At least it's a fid. A table with a field called fid is very
+              // very likely to be a file_managed.fid in a file access query.
+              $fallback = $table;
+            }
+          }
+        }
+      }
+    }
+    // If there is nothing else, use the fallback.
+    if (!$base_table) {
+      if ($fallback) {
+        watchdog('security', 'Your file listing query is using @fallback as a base table in a query tagged for file access. This might not be secure and might not even work. Specify foreign keys in your schema to file_managed.fid ', array('@fallback' => $fallback), WATCHDOG_WARNING);
+        $base_table = $fallback;
+      }
+      else {
+        throw new Exception(t('Query tagged for file access but there is no fid. Add foreign keys to file_managed.fid in schema to fix.'));
+      }
+    }
+  }
+
+  if ($type == 'entity') {
+    // The original query looked something like:
+    // @code
+    //  SELECT fid FROM sometable s
+    //  WHERE ($file_access_conditions)
+    // @endcode
+    //
+    // Our query will look like:
+    // @code
+    //  SELECT entity_type, entity_id
+    //  FROM field_data_something s
+    //  WHERE (entity_type = 'file' AND $file_access_conditions) OR (entity_type <> 'file')
+    // @endcode
+    //
+    // So instead of directly adding to the query object, we need to collect
+    // all of the file access conditions in a separate db_and() object and
+    // then add it to the query at the end.
+    $file_conditions = db_and();
+  }
+  foreach ($tables as $falias => $tableinfo) {
+    $table = $tableinfo['table'];
+    if (!($table instanceof SelectQueryInterface) && $table == $base_table) {
+      $subquery = db_select('file_managed', 'fm_access')->fields('fm_access', array('fid'));
+      $subquery_conditions = db_or();
+
+      $wrappers = file_entity_get_public_and_private_stream_wrapper_names();
+      if (!empty($wrappers['public'])) {
+        if (user_access('view files', $account)) {
+          foreach (array_keys($wrappers['public']) as $wrapper) {
+            $subquery_conditions->condition('fm_access.uri', $wrapper . '%', 'LIKE');
+          }
+        }
+        elseif (user_access('view own files', $account)) {
+          foreach (array_keys($wrappers['public']) as $wrapper) {
+            $subquery_conditions->condition(db_and()
+              ->condition('fm_access.uri', $wrapper . '%', 'LIKE')
+              ->condition('fm_access.uid', $account->uid)
+            );
+          }
+        }
+      }
+      if (!empty($wrappers['private'])) {
+        if (user_access('view private files', $account)) {
+          foreach (array_keys($wrappers['private']) as $wrapper) {
+            $subquery_conditions->condition('fm_access.uri', $wrapper . '%', 'LIKE');
+          }
+        }
+        elseif (user_access('view own private files', $account)) {
+          foreach (array_keys($wrappers['private']) as $wrapper) {
+            $subquery_conditions->condition(db_and()
+              ->condition('fm_access.uri', $wrapper . '%', 'LIKE')
+              ->condition('fm_access.uid', $account->uid)
+            );
+          }
+        }
+      }
+
+      if ($subquery_conditions->count()) {
+        $subquery->condition($subquery_conditions);
+
+        $field = 'fid';
+        // Now handle entities.
+        if ($type == 'entity') {
+          // Set a common alias for entities.
+          $base_alias = $falias;
+          $field = 'entity_id';
+        }
+        $subquery->where("$falias.$field = fm_access.fid");
+
+        // For an entity query, attach the subquery to entity conditions.
+        if ($type == 'entity') {
+          $file_conditions->exists($subquery);
+        }
+        // Otherwise attach it to the node query itself.
+        else {
+          $query->exists($subquery);
+        }
+      }
+    }
+  }
+
+  if ($type == 'entity' && $file_conditions->count()) {
+    // All the file access conditions are only for field values belonging to
+    // files.
+    $file_conditions->condition("$base_alias.entity_type", 'file');
+    $or = db_or();
+    $or->condition($file_conditions);
+    // If the field value belongs to a non-file entity type then this function
+    // does not do anything with it.
+    $or->condition("$base_alias.entity_type", 'file', '<>');
+    // Add the compiled set of rules to the query.
+    $query->condition($or);
+  }
+}
+
+/**
+ * Implements hook_file_download().
+ */
+function file_entity_file_download($uri) {
+  // Load the file from the URI.
+  $file = file_uri_to_object($uri);
+
+  // An existing file wasn't found, so we don't control access.
+  // E.g. image derivatives will fall here.
+  if (empty($file->fid)) {
+    return NULL;
+  }
+
+  // Allow the user to download the file if they have appropriate permissions.
+  if (file_entity_access('view', $file)) {
+    return file_get_content_headers($file);
+  }
+
+  return NULL;
+}
+
+/**
+ * Helper function to generate standard file permission list for a given type.
+ *
+ * @param $type
+ *   The machine-readable name of the file type.
+ * @return array
+ *   An array of permission names and descriptions.
+ */
+function file_entity_list_permissions($type) {
+  $info = file_type_load($type);
+
+  // Build standard list of file permissions for this type.
+  $permissions = array(
+    "edit own $type files" => array(
+      'title' => t('%type_name: Edit own files', array('%type_name' => $info->label)),
+    ),
+    "edit any $type files" => array(
+      'title' => t('%type_name: Edit any files', array('%type_name' => $info->label)),
+    ),
+    "delete own $type files" => array(
+      'title' => t('%type_name: Delete own files', array('%type_name' => $info->label)),
+    ),
+    "delete any $type files" => array(
+      'title' => t('%type_name: Delete any files', array('%type_name' => $info->label)),
+    ),
+    "download own $type files" => array(
+      'title' => t('%type_name: Download own files', array('%type_name' => $info->label)),
+    ),
+    "download any $type files" => array(
+      'title' => t('%type_name: Download any files', array('%type_name' => $info->label)),
+    ),
+  );
+
+  return $permissions;
+}
+
+/**
+ * Returns an array of file types that should be managed by permissions.
+ *
+ * By default, this will include all file types in the system. To exclude a
+ * specific file from getting permissions defined for it, set the
+ * file_entity_permissions_$type variable to 0. File entity does not provide an
+ * interface for doing so, however, contrib modules may exclude their own files
+ * in hook_install(). Alternatively, contrib modules may configure all file
+ * types at once, or decide to apply some other hook_file_entity_access()
+ * implementation to some or all file types.
+ *
+ * @return
+ *   An array of file types managed by this module.
+ */
+function file_entity_permissions_get_configured_types() {
+
+  $configured_types = array();
+
+  foreach (file_type_get_enabled_types() as $type => $info) {
+    if (variable_get('file_entity_permissions_' . $type, 1)) {
+      $configured_types[] = $type;
+    }
+  }
+
+  return $configured_types;
+}
+
+/**
+ * @} End of "defgroup file_entity_access".
+ *
+ * Implements hook_file_default_types().
+ */
+function file_entity_file_default_types() {
+  $types = array();
+
+  // Image.
+  $types['image'] = (object) array(
+    'api_version' => 1,
+    'type' => 'image',
+    'label' => t('Image'),
+    'description' => t('An <em>Image</em> file is a still visual.'),
+    'mimetypes' => array(
+      'image/*',
+    ),
+  );
+
+  // Video.
+  $types['video'] = (object) array(
+    'api_version' => 1,
+    'type' => 'video',
+    'label' => t('Video'),
+    'description' => t('A <em>Video</em> file is a moving visual recording.'),
+    'mimetypes' => array(
+      'video/*',
+    ),
+  );
+
+  // Audio.
+  $types['audio'] = (object) array(
+    'api_version' => 1,
+    'type' => 'audio',
+    'label' => t('Audio'),
+    'description' => t('An <em>Audio</em> file is a sound recording.'),
+    'mimetypes' => array(
+      'audio/*',
+    ),
+  );
+
+  // Document.
+  $types['document'] = (object) array(
+    'api_version' => 1,
+    'type' => 'document',
+    'label' => t('Document'),
+    'description' => t('A <em>Document</em> file is written information.'),
+    'mimetypes' => array(
+      'text/plain',
+      'application/msword',
+      'application/vnd.ms-excel',
+      'application/pdf',
+      'application/vnd.ms-powerpoint',
+      'application/vnd.oasis.opendocument.text',
+      'application/vnd.oasis.opendocument.spreadsheet',
+      'application/vnd.oasis.opendocument.presentation',
+      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
+      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
+      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
+    ),
+  );
+
+  return $types;
+}
+
+/**
+ * Implements hook_file_operations().
+ */
+function file_entity_file_operations() {
+  $operations = array(
+    'permanent' => array(
+      'label' => t('Indicate that the selected files are permanent and should not be deleted'),
+      'callback' => 'file_entity_mass_update',
+      'callback arguments' => array('updates' => array('status' => FILE_STATUS_PERMANENT)),
+    ),
+    'temporary' => array(
+      'label' => t('Indicate that the selected files are temporary and should be removed during cron runs'),
+      'callback' => 'file_entity_mass_update',
+      'callback arguments' => array('updates' => array('status' => 0)),
+    ),
+    'delete' => array(
+      'label' => t('Delete selected files'),
+      'callback' => NULL,
+    ),
+  );
+  return $operations;
+}
+
+/**
+ * Clear the field cache for any entities referencing a specific file.
+ *
+ * @param object $file
+ *   A file object.
+ */
+function file_entity_invalidate_field_caches($file) {
+  $entity_types = &drupal_static(__FUNCTION__);
+
+  // Gather the list of entity types which support field caching.
+  if (!isset($entity_types)) {
+    $entity_types = array();
+    foreach (entity_get_info() as $entity_type => $entity_info) {
+      if (!empty($entity_info['fieldable']) && !empty($entity_info['field cache'])) {
+        $entity_types[] = $entity_type;
+      }
+    }
+  }
+
+  // If no entity types support field caching, then there is no work to be done.
+  if (empty($entity_types)) {
+    return;
+  }
+
+  $records = db_query("SELECT DISTINCT type, id FROM {file_usage} WHERE fid = :fid AND type IN (:types) AND id > 0", array(':fid' => $file->fid, ':types' => $entity_types))->fetchAll();
+  if (!empty($records)) {
+    $cids = array();
+    foreach ($records as $record) {
+      $cids[] = 'field:' . $record->type . ':' . $record->id;
+    }
+    cache_clear_all($cids, 'cache_field');
+  }
+}
+
+/**
+ * Check if a file entity is considered local or not.
+ *
+ * @param object $file
+ *   A file entity object from file_load().
+ *
+ * @return
+ *   TRUE if the file is using a local stream wrapper, or FALSE otherwise.
+ */
+function file_entity_file_is_local($file) {
+  $scheme = file_uri_scheme($file->uri);
+  $wrappers = file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL);
+  return !empty($wrappers[$scheme]) && empty($wrappers[$scheme]['remote']);
+}
+
+/**
+ * Check if a file entity is considered writeable or not.
+ *
+ * @param object $file
+ *   A file entity object from file_load().
+ *
+ * @return
+ *   TRUE if the file is using a visible, readable and writeable stream wrapper,
+ *   or FALSE otherwise.
+ */
+function file_entity_file_is_writeable($file) {
+  $scheme = file_uri_scheme($file->uri);
+  $wrappers = file_get_stream_wrappers(STREAM_WRAPPERS_WRITE_VISIBLE);
+  return !empty($wrappers[$scheme]);
+}
+
+/**
+ * Pre-render callback for adding validation descriptions to file upload fields.
+ */
+function file_entity_upload_validators_pre_render($element) {
+  if (!empty($element['#upload_validators'])) {
+    if (!isset($element['#description'])) {
+      $element['#description'] = '';
+    }
+    if ($element['#description'] !== FALSE) {
+      $element['#description'] = theme('file_upload_help', array('description' => $element['#description'], 'upload_validators' => $element['#upload_validators']));
+    }
+  }
+  return $element;
+}
+
+/**
+ * Implements hook_file_default_displays_alter() on behalf of image.module.
+ */
+function image_file_default_displays_alter(&$file_displays) {
+  // Images should be displayed as unstyled images by default.
+  if (isset($file_displays['image__default__file_field_file_default'])) {
+    $file_displays['image__default__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__default__file_field_image';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'image_style' => '',
+    'image_link' => '',
+  );
+  $file_displays['image__default__file_field_image'] = $file_display;
+
+  // Image previews should be displayed as image thumbnails by default.
+  if (isset($file_displays['image__preview__file_field_file_default'])) {
+    $file_displays['image__preview__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__preview__file_field_image';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'image_style' => 'thumbnail',
+    'image_link' => '',
+  );
+  $file_displays['image__preview__file_field_image'] = $file_display;
+
+  // Image teasers should be displayed as medium images by default.
+  if (isset($file_displays['image__teaser__file_field_file_default'])) {
+    $file_displays['image__teaser__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__teaser__file_field_image';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'image_style' => 'medium',
+    'image_link' => 'content',
+  );
+  $file_displays['image__teaser__file_field_image'] = $file_display;
+}
+
+/**
+ * @name pathauto_file Pathauto integration for the core file module.
+ * @{
+ */
+
+/**
+ * Implements hook_file_insert() on behalf of pathauto.module.
+ */
+function pathauto_file_insert($file) {
+  pathauto_file_update_alias($file, 'insert');
+}
+
+/**
+ * Implements hook_file_update() on behalf of pathauto.module.
+ */
+function pathauto_file_update($file) {
+  pathauto_file_update_alias($file, 'update');
+}
+
+/**
+ * Implements hook_file_delete() on behalf of pathauto.module.
+ */
+function pathauto_file_delete($file) {
+  pathauto_entity_path_delete_all('file', $file, "file/{$file->fid}");
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter() on behalf of pathauto.module.
+ *
+ * Add the Pathauto settings to the file form.
+ */
+function pathauto_form_file_entity_edit_alter(&$form, &$form_state, $form_id) {
+  $file = $form_state['file'];
+  $langcode = pathauto_entity_language('file', $file);
+  pathauto_field_attach_form('file', $file, $form, $form_state, $langcode);
+}
+
+/**
+ * Implements hook_file_operations() on behalf of pathauto.module.
+ */
+function pathauto_file_operations() {
+  $operations['pathauto_update_alias'] = array(
+    'label' => t('Update URL alias'),
+    'callback' => 'pathauto_file_update_alias_multiple',
+    'callback arguments' => array('bulkupdate', array('message' => TRUE)),
+  );
+  return $operations;
+}
+
+/**
+ * Update the URL aliases for an individual file.
+ *
+ * @param $file
+ *   A file object.
+ * @param $op
+ *   Operation being performed on the file ('insert', 'update' or 'bulkupdate').
+ * @param $options
+ *   An optional array of additional options.
+ */
+function pathauto_file_update_alias(stdClass $file, $op, array $options = array()) {
+  // Skip processing if the user has disabled pathauto for the file.
+  if (isset($file->path['pathauto']) && empty($file->path['pathauto'])) {
+    return;
+  }
+
+  $options += array('language' => pathauto_entity_language('file', $file));
+
+  // Skip processing if the file has no pattern.
+  if (!pathauto_pattern_load_by_entity('file', $file->type, $options['language'])) {
+    return;
+  }
+
+  module_load_include('inc', 'pathauto');
+  $uri = entity_uri('file', $file);
+  pathauto_create_alias('file', $op, $uri['path'], array('file' => $file), $file->type, $options['language']);
+}
+
+/**
+ * Update the URL aliases for multiple files.
+ *
+ * @param $fids
+ *   An array of file IDs.
+ * @param $op
+ *   Operation being performed on the files ('insert', 'update' or
+ *   'bulkupdate').
+ * @param $options
+ *   An optional array of additional options.
+ */
+function pathauto_file_update_alias_multiple(array $fids, $op, array $options = array()) {
+  $options += array('message' => FALSE);
+
+  $files = file_load_multiple($fids);
+  foreach ($files as $file) {
+    pathauto_file_update_alias($file, $op, $options);
+  }
+
+  if (!empty($options['message'])) {
+    drupal_set_message(format_plural(count($fids), 'Updated URL alias for 1 file.', 'Updated URL aliases for @count files.'));
+  }
+}
+
+/**
+ * Update action wrapper for pathauto_file_update_alias().
+ */
+function pathauto_file_update_action($file, $context = array()) {
+  pathauto_file_update_alias($file, 'bulkupdate', array('message' => TRUE));
+}
+
+/**
+ * @} End of "name pathauto_file".
+ */
+
+/**
+ * Implements hook_form_FORM_ID_alter() for file_entity_edit() on behalf of path.module.
+ */
+function path_form_file_entity_edit_alter(&$form, $form_state) {
+  // Make sure this does not show up on the delete confirmation form.
+  if (empty($form_state['confirm_delete'])) {
+    $file = $form_state['file'];
+    $langcode = function_exists('entity_language') ? entity_language('file', $file) : NULL;
+    $langcode = !empty($langcode) ? $langcode : LANGUAGE_NONE;
+    $conditions = array('source' => 'file/' . $file->fid, 'language' => $langcode);
+    $path = (isset($file->fid) ? path_load($conditions) : array());
+    if ($path === FALSE) {
+      $path = array();
+    }
+    $path += array(
+      'pid' => NULL,
+      'source' => isset($file->fid) ? 'file/' . $file->fid : NULL,
+      'alias' => '',
+      'language' => $langcode,
+    );
+    $form['path'] = array(
+      '#type' => 'fieldset',
+      '#title' => t('URL path settings'),
+      '#collapsible' => TRUE,
+      '#collapsed' => empty($path['alias']),
+      '#group' => 'additional_settings',
+      '#attributes' => array(
+        'class' => array('path-form'),
+      ),
+      '#attached' => array(
+        'js' => array(drupal_get_path('module', 'path') . '/path.js'),
+      ),
+      '#access' => user_access('create url aliases') || user_access('administer url aliases'),
+      '#weight' => 30,
+      '#tree' => TRUE,
+      '#element_validate' => array('path_form_element_validate'),
+    );
+    $form['path']['alias'] = array(
+      '#type' => 'textfield',
+      '#title' => t('URL alias'),
+      '#default_value' => $path['alias'],
+      '#maxlength' => 255,
+      '#description' => t('Optionally specify an alternative URL by which this file can be accessed. For example, type "about" when writing an about page. Use a relative path and don\'t add a trailing slash or the URL alias won\'t work.'),
+    );
+    $form['path']['pid'] = array('#type' => 'value', '#value' => $path['pid']);
+    $form['path']['source'] = array('#type' => 'value', '#value' => $path['source']);
+    $form['path']['language'] = array('#type' => 'value', '#value' => $path['language']);
+  }
+}
+
+/**
+ * Implements hook_file_insert() on behalf of path.module.
+ */
+function path_file_insert($file) {
+  if (isset($file->path)) {
+    $path = $file->path;
+    $path['alias'] = trim($path['alias']);
+    // Only save a non-empty alias.
+    if (!empty($path['alias'])) {
+      // Ensure fields for programmatic executions.
+      $path['source'] = 'file/' . $file->fid;
+      // Core does not provide a way to store the file language but contrib
+      // modules can do it so we need to take this into account.
+      $langcode = entity_language('file', $file);
+      $path['language'] = !empty($langcode) ? $langcode : LANGUAGE_NONE;
+      path_save($path);
+    }
+  }
+}
+
+/**
+ * Implements hook_file_update() on behalf of path.module.
+ */
+function path_file_update($file) {
+  if (isset($file->path)) {
+    $path = $file->path;
+    $path['alias'] = trim($path['alias']);
+    // Delete old alias if user erased it.
+    if (!empty($path['fid']) && empty($path['alias'])) {
+      path_delete($path['fid']);
+    }
+    // Only save a non-empty alias.
+    if (!empty($path['alias'])) {
+      // Ensure fields for programmatic executions.
+      $path['source'] = 'file/' . $file->fid;
+      // Core does not provide a way to store the file language but contrib
+      // modules can do it so we need to take this into account.
+      $langcode = entity_language('file', $file);
+      $path['language'] = !empty($langcode) ? $langcode : LANGUAGE_NONE;
+      path_save($path);
+    }
+  }
+}
+
+/**
+ * Implements hook_file_delete() on behalf of path.module.
+ */
+function path_file_delete($file) {
+  // Delete all aliases associated with this file.
+  path_delete(array('source' => 'file/' . $file->fid));
+}
+
+/**
+ * Checks if pattern(s) match mimetype(s).
+ */
+function file_entity_match_mimetypes($needle, $haystack) {
+  $needle = is_array($needle) ? $needle : array($needle);
+  $haystack = is_array($haystack) ? $haystack : array($haystack);
+
+  foreach ($haystack as $mimetype) {
+    foreach ($needle as $search) {
+      if (file_entity_fnmatch($search, $mimetype) || file_entity_fnmatch($mimetype, $search)) {
+        return TRUE;
+      }
+    }
+  }
+
+  return FALSE;
+}
+
+/**
+ * A wrapper function for the PHP function fnmatch().
+ *
+ * We include this, because Windows servers do not implement fnmatch() until
+ * PHP Version 5.3. See: http://php.net/manual/en/function.fnmatch.php
+ */
+function file_entity_fnmatch($pattern, $string) {
+  if (!function_exists('fnmatch')) {
+    return preg_match("#^" . strtr(preg_quote($pattern, '#'), array('\*' => '.*', '\?' => '.', '\[' => '[', '\]' => ']')) . "$#", $string);
+  }
+  return fnmatch($pattern, $string);
+}
+
+/**
+ * Return an URI for a file download.
+ */
+function file_entity_download_uri($file) {
+  $uri = array('path' => "file/{$file->fid}/download", 'options' => array());
+  if (!variable_get('file_entity_allow_insecure_download', FALSE)) {
+    $uri['options']['query']['token'] = file_entity_get_download_token($file);
+  }
+  return $uri;
+}
+
+function file_entity_file_get_mimetype_type($file) {
+  list($type, $subtype) = explode('/', $file->filemime, 2);
+  return $type;
+}
+
+/**
+ * Implements hook_admin_menu_map().
+ */
+function file_entity_admin_menu_map() {
+  if (!user_access('administer file types')) {
+    return;
+  }
+  $map['admin/structure/file-types/manage/%file_type'] = array(
+    'parent' => 'admin/structure/file-types',
+    'arguments' => array(
+      array('%file_type' => array_keys(file_entity_type_get_names())),
+    ),
+  );
+  return $map;
+}
+
+/*
+ * Generate a file download CSRF token.
+ *
+ * This is essentially a duplicate of drupal_get_token, that attempts to still
+ * work if the user is anonymous, by using ip_address() as the identifier
+ * rather than session_id().
+ *
+ * @param object $file
+ *   A file entity object.
+ *
+ * @return string
+ *   A CSRF token string.
+ */
+function file_entity_get_download_token($file) {
+  $identifier = !empty($GLOBALS['user']->uid) ? session_id() : ip_address();
+  return drupal_hmac_base64("file/$file->fid/download", $identifier . drupal_get_private_key() . drupal_get_hash_salt());
+}
+
+/**
+ * Find all fields that are of a certain field type.
+ *
+ * @param string $field_type
+ *   A field type.
+ *
+ * @return array
+ *   An array of field names that match the type $field_type.
+ */
+function _file_entity_get_fields_by_type($field_type) {
+  $return = array();
+  if (function_exists('field_info_field_map')) {
+    foreach (field_info_field_map() as $field_name => $field) {
+      if ($field['type'] == $field_type) {
+        $return[$field_name] = $field_name;
+      }
+    }
+  }
+  else {
+    foreach (field_info_fields() as $field_name => $field) {
+      if ($field['type'] == $field_type) {
+        $return[$field_name] = $field_name;
+      }
+    }
+  }
+  return $return;
+}
+
+/**
+ * Implements hook_field_attach_load().
+ */
+function file_entity_field_attach_load($entity_type, $entities, $age, $options) {
+  // Loop over all the entities looking for entities with attached images.
+  foreach ($entities as $entity) {
+    list(, , $bundle) = entity_extract_ids($entity_type, $entity);
+    // Examine every image field instance attached to this entity's bundle.
+    $instances = array_intersect_key(field_info_instances($entity_type, $bundle), _file_entity_get_fields_by_type('image'));
+    foreach ($instances as $field_name => $instance) {
+      if (!empty($entity->{$field_name})) {
+        foreach ($entity->{$field_name} as $langcode => $items) {
+          foreach ($items as $delta => $item) {
+            // If alt and title text is not specified, fall back to alt and
+            // title text on the file.
+            if (empty($item['alt']) || empty($item['title'])) {
+              $file = file_load($item['fid']);
+              foreach (array('alt', 'title') as $key) {
+                if (empty($item[$key]) && !empty($file->{$key})) {
+                  $entity->{$field_name}[$langcode][$delta][$key] = $file->{$key};
+                }
+              }
+            }
+          }
+        }
+      }
+    }
+  }
+}
+
+function file_entity_get_public_and_private_stream_wrapper_names($flag = STREAM_WRAPPERS_VISIBLE) {
+  $wrappers = array();
+  foreach (file_get_stream_wrappers($flag) as $key => $wrapper) {
+    if (empty($wrapper['private'])) {
+      $wrappers['public'][$key] = $wrapper['name'];
+    }
+    else {
+      $wrappers['private'][$key] = $wrapper['name'];
+    }
+  }
+  return $wrappers;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.pages.inc b/profiles/commons/modules/contrib/file_entity/file_entity.pages.inc
new file mode 100644
index 0000000..31d0d76
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.pages.inc
@@ -0,0 +1,986 @@
+<?php
+
+/**
+ * @file
+ * Supports file operations including View, Edit, and Delete.
+ */
+
+/**
+ * Menu callback; view a single file entity.
+ */
+function file_entity_view_page($file) {
+  drupal_set_title($file->filename);
+
+  $uri = entity_uri('file', $file);
+  // Set the file path as the canonical URL to prevent duplicate content.
+  drupal_add_html_head_link(array('rel' => 'canonical', 'href' => url($uri['path'], $uri['options'])), TRUE);
+  // Set the non-aliased path as a default shortlink.
+  drupal_add_html_head_link(array('rel' => 'shortlink', 'href' => url($uri['path'], array_merge($uri['options'], array('alias' => TRUE)))), TRUE);
+
+  return file_view($file, 'full');
+}
+
+/**
+ * Menu callback; download a single file entity.
+ */
+function file_entity_download_page($file) {
+  // Ensure there is a valid token to download this file.
+  if (!variable_get('file_entity_allow_insecure_download', FALSE)) {
+    if (!isset($_GET['token']) || $_GET['token'] !== file_entity_get_download_token($file)) {
+      return MENU_ACCESS_DENIED;
+    }
+  }
+
+  // If the file does not exist it can cause problems with file_transfer().
+  if (!is_file($file->uri)) {
+    return MENU_NOT_FOUND;
+  }
+
+  $headers = array(
+    'Content-Type' => 'force-download',
+    'Content-Disposition' => 'attachment; filename="' . $file->filename . '"',
+    'Content-Length' => $file->filesize,
+    'Content-Transfer-Encoding' => 'binary',
+    'Pragma' => 'no-cache',
+    'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',
+    'Expires' => '0',
+    'Accept-Ranges' => 'bytes',
+  );
+
+  // Let other modules alter the download headers.
+  drupal_alter('file_download_headers', $headers, $file);
+
+  file_transfer($file->uri, $headers);
+}
+
+/**
+ * Form callback for adding a file via an upload form.
+ *
+ * This is a multi step form which has 1-3 pages:
+ * - Upload file
+ * - Choose filetype
+ *   If there is only one candidate (based on mimetype) we will skip this step.
+ * - Edit fields
+ *   Skip this step if there are no fields on this entity type.
+ */
+function file_entity_add_upload($form, &$form_state, array $options = array()) {
+  $step = (isset($form_state['step']) && in_array($form_state['step'], array(1, 2, 3, 4))) ? $form_state['step'] : 1;
+  $form['#step'] = $step;
+  switch ($step) {
+    case 1:
+      return file_entity_add_upload_step_upload($form, $form_state, $options);
+
+    case 2:
+      return file_entity_add_upload_step_filetype($form, $form_state, $options);
+
+    case 3:
+      return file_entity_add_upload_step_scheme($form, $form_state, $options);
+
+    case 4:
+      return file_entity_add_upload_step_fields($form, $form_state, $options);
+
+  }
+}
+
+/**
+ * Generate form fields for the first step in the add file wizard.
+ */
+function file_entity_add_upload_step_upload($form, &$form_state, array $options = array()) {
+  $form['upload'] = array(
+    '#type' => 'managed_file',
+    '#title' => t('Upload a new file'),
+    '#upload_location' => file_entity_upload_destination_uri($options),
+    '#upload_validators' => file_entity_get_upload_validators($options),
+    '#progress_indicator' => 'bar',
+    '#required' => TRUE,
+    '#pre_render' => array('file_managed_file_pre_render', 'file_entity_upload_validators_pre_render'),
+    '#default_value' => isset($form_state['storage']['upload']) ? $form_state['storage']['upload'] : NULL,
+  );
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['next'] = array(
+    '#type' => 'submit',
+    '#value' => t('Next'),
+  );
+
+  form_load_include($form_state, 'inc', 'file_entity', 'file_entity.pages');
+
+  return $form;
+}
+
+/**
+ * Generate form fields for the second step in the add file wizard.
+ */
+function file_entity_add_upload_step_filetype($form, &$form_state, array $options = array()) {
+  $file = file_load($form_state['storage']['upload']);
+
+  $form['type'] = array(
+    '#type' => 'radios',
+    '#title' => t('File type'),
+    '#options' => file_entity_get_filetype_candidates($file),
+    '#default_value' => isset($form_state['storage']['type']) ? $form_state['storage']['type'] : NULL,
+    '#required' => TRUE,
+  );
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['previous'] = array(
+    '#type' => 'submit',
+    '#value' => t('Previous'),
+    '#limit_validation_errors' => array(),
+    '#submit' => array('file_entity_add_upload_submit'),
+  );
+  $form['actions']['next'] = array(
+    '#type' => 'submit',
+    '#value' => t('Next'),
+  );
+
+  return $form;
+}
+
+/**
+ * Generate form fields for the third step in the add file wizard.
+ */
+function file_entity_add_upload_step_scheme($form, &$form_state, array $options = array()) {
+  $file = file_load($form_state['storage']['upload']);
+
+  $options = array();
+  foreach (file_get_stream_wrappers(STREAM_WRAPPERS_WRITE_VISIBLE) as $scheme => $info) {
+    $options[$scheme] = check_plain($info['description']);
+  }
+
+  $form['scheme'] = array(
+    '#type' => 'radios',
+    '#title' => t('Destination'),
+    '#options' => $options,
+    '#default_value' => isset($form_state['storage']['scheme']) ? $form_state['storage']['scheme'] : file_default_scheme(),
+    '#required' => TRUE,
+  );
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['previous'] = array(
+    '#type' => 'submit',
+    '#value' => t('Previous'),
+    '#limit_validation_errors' => array(),
+    '#submit' => array('file_entity_add_upload_submit'),
+  );
+  $form['actions']['next'] = array(
+    '#type' => 'submit',
+    '#value' => t('Next'),
+  );
+
+  return $form;
+}
+
+/**
+ * Generate form fields for the fourth step in the add file wizard.
+ */
+function file_entity_add_upload_step_fields($form, &$form_state, array $options = array()) {
+  // Load the file and overwrite the filetype set on the previous screen.
+  $file = file_load($form_state['storage']['upload']);
+  $file->type = $form_state['storage']['type'];
+
+  // Add fields.
+  field_attach_form('file', $file, $form, $form_state);
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['previous'] = array(
+    '#type' => 'submit',
+    '#value' => t('Previous'),
+    '#limit_validation_errors' => array(),
+    '#submit' => array('file_entity_add_upload_submit'),
+  );
+  $form['actions']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save'),
+  );
+
+  return $form;
+}
+
+/**
+ * Page callback to show file usage information.
+ */
+function file_entity_usage_page($file) {
+  $rows = array();
+  $occured_entities = array();
+
+  foreach (file_usage_list($file) as $module => $usage) {
+    $info = system_get_info('module', $module);
+
+    // There are cases, where actual entitiy doesen't exist.
+    // We have to handle this.
+    foreach ($usage as $entity_type => $entity_ids) {
+      $entity_info = entity_get_info($entity_type);
+      $entities = empty($entity_info) ? NULL : entity_load($entity_type, array_keys($entity_ids));
+
+      foreach ($entity_ids as $entity_id => $count) {
+        // If some other module already added this entity just sum all counts.
+        if (isset($occured_entities[$entity_type][$entity_id])) {
+          $rows[$occured_entities[$entity_type][$entity_id]][2] += $count;
+          continue;
+        }
+
+        $label = empty($entities[$entity_id]) ? $module : entity_label($entity_type, $entities[$entity_id]);
+        $entity_uri = empty($entities[$entity_id]) ? NULL : entity_uri($entity_type, $entities[$entity_id]);
+
+        // Some entities do not have URL.
+        if (empty($entity_uri)) {
+          $rows[] = array(check_plain($label), $entity_type, $module, $count);
+        }
+        else {
+          $uri = $entity_uri['path'];
+          $rows[] = array(l($label, $uri), $entity_type, $module, $count);
+        }
+
+        $occured_entities[$entity_type][$entity_id] = count($rows) - 1;
+      }
+    }
+  }
+  $header[] = array(
+    'data' => t('Entity'),
+  );
+  $header[] = array(
+    'data' => t('Entity type'),
+  );
+  $header[] = array(
+    'data' => t('Registering module'),
+  );
+  $header[] = array(
+    'data' => t('Use count'),
+  );
+  $build['usage_table'] = array(
+    '#theme' => 'table',
+    '#header' => $header,
+    '#rows' => $rows,
+    '#caption' => t('This table lists all of the places where @filename is used.',
+    array('@filename' => $file->filename)),
+    '#empty' => t('This file is not currently used.'),
+  );
+  return $build;
+}
+
+/**
+ * Get the candidate filetypes for a given file.
+ *
+ * Only filetypes for which the user has access to create entities are returned.
+ *
+ * @param array $file
+ *   An upload file array from form_state.
+ *
+ * @return array
+ *   An array of file type bundles that support the file's mime type.
+ */
+function file_entity_get_filetype_candidates($file) {
+  $types = module_invoke_all('file_type', $file);
+  drupal_alter('file_type', $types, $file);
+  $candidates = array();
+  foreach ($types as $type) {
+    $file->type = $type;
+    if (file_entity_access('create', $file)) {
+      $candidates[$type] = file_entity_type_get_name($file);
+    }
+  }
+  return $candidates;
+}
+
+/**
+ * Submit handler for the add file form.
+ */
+function file_entity_add_upload_submit($form, &$form_state) {
+  $form_state['storage'] = isset($form_state['storage']) ? $form_state['storage'] : array();
+  $form_state['storage'] = array_merge($form_state['storage'], $form_state['values']);
+
+  // This var is set to TRUE when we are ready to save the file.
+  $save = FALSE;
+  $trigger = $form_state['triggering_element']['#id'];
+
+  $steps_to_check = array(2, 3);
+  if ($trigger == 'edit-previous') {
+    // If the previous button was hit,
+    // the step checking order should be reversed 3, 2.
+    $steps_to_check = array_reverse($steps_to_check);
+  }
+
+  foreach ($steps_to_check as $step) {
+    // Check if we can skip step 2 and 3.
+    if (($form['#step'] == $step - 1 && $trigger == 'edit-next') || ($form['#step'] == $step + 1 && $trigger == 'edit-previous')) {
+      $file = file_load($form_state['storage']['upload']);
+      if ($step == 2) {
+        // Check if we can skip step 2.
+        $candidates = file_entity_get_filetype_candidates($file);
+        if (count($candidates) == 1) {
+          $candidates_keys = array_keys($candidates);
+          // There is only one possible filetype for this file.
+          // Skip the second page.
+          $form['#step'] += ($trigger == 'edit-previous') ? -1 : 1;
+          $form_state['storage']['type'] = reset($candidates_keys);
+        }
+        elseif (variable_get('file_entity_file_upload_wizard_skip_file_type', FALSE)) {
+          // Do not assign the file a file type.
+          $form['#step'] += ($trigger == 'edit-previous') ? -1 : 1;
+          $form_state['storage']['type'] = FILE_TYPE_NONE;
+        }
+      }
+      else {
+        // Check if we can skip step 3.
+        $schemes = file_get_stream_wrappers(STREAM_WRAPPERS_WRITE_VISIBLE);
+        if (count($schemes) == 1) {
+          // There is only one possible stream wrapper for this file.
+          // Skip the third page.
+          $form['#step'] += ($trigger == 'edit-previous') ? -1 : 1;
+          $form_state['storage']['scheme'] = key($schemes);
+        }
+        elseif (variable_get('file_entity_file_upload_wizard_skip_scheme', FALSE)) {
+          // Assign the file the default scheme.
+          $form['#step'] += ($trigger == 'edit-previous') ? -1 : 1;
+          $form_state['storage']['scheme'] = file_default_scheme();
+        }
+      }
+    }
+  }
+
+  // We have the filetype, check if we can skip step 4.
+  if (($form['#step'] == 3 && $trigger == 'edit-next')) {
+    $file = file_load($form_state['storage']['upload']);
+    if (!field_info_instances('file', $form_state['storage']['type'])) {
+      // This filetype doesn't have fields, save the file.
+      $save = TRUE;
+    }
+    elseif (variable_get('file_entity_file_upload_wizard_skip_fields', FALSE)) {
+      // Save the file with blanks fields.
+      $save = TRUE;
+    }
+  }
+
+  // Form id's can vary depending on how many other forms are displayed, so we
+  // need to do string comparissons. e.g edit-submit--2.
+  if (strpos($trigger, 'edit-next') !== FALSE) {
+    $form_state['step'] = $form['#step'] + 1;
+  }
+  elseif (strpos($trigger, 'edit-previous') !== FALSE) {
+    $form_state['step'] = $form['#step'] - 1;
+  }
+  elseif (strpos($trigger, 'edit-submit') !== FALSE) {
+    $save = TRUE;
+  }
+
+  if ($save) {
+    $file = file_load($form_state['storage']['upload']);
+    if ($file) {
+      if (file_uri_scheme($file->uri) != $form_state['storage']['scheme']) {
+        if ($moved_file = file_move($file, $form_state['storage']['scheme'] . '://' . file_uri_target($file->uri), FILE_EXISTS_RENAME)) {
+          // Only re-assign the file object if file_move() did not fail.
+          $file = $moved_file;
+        }
+      }
+      $file->type = $form_state['storage']['type'];
+      $file->display = TRUE;
+
+      // Change the file from temporary to permanent.
+      $file->status = FILE_STATUS_PERMANENT;
+
+      // Save the form fields.
+      // Keep in mind that the values for the Field API fields must be in
+      // $form_state['values'] and not in ['storage']. This is true as long as
+      // the fields are on the last page of the multi step form.
+      entity_form_submit_build_entity('file', $file, $form, $form_state);
+
+      file_save($file);
+      $form_state['file'] = $file;
+      drupal_set_message(t('@type %name was uploaded.', array('@type' => file_entity_type_get_name($file), '%name' => $file->filename)));
+    }
+    else {
+      drupal_set_message(t('An error occurred and no file was uploaded.'), 'error');
+      return;
+    }
+
+    // Figure out destination.
+    if (isset($_GET['destination'])) {
+      $destination = drupal_get_destination();
+      unset($_GET['destination']);
+    }
+    elseif (user_access('administer files')) {
+      $destination = array('destination' => 'admin/content/file');
+    }
+    else {
+      $destination = array('destination' => 'file/' . $file->fid);
+    }
+    $form_state['redirect'] = $destination['destination'];
+  }
+  else {
+    $form_state['rebuild'] = TRUE;
+  }
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Determines the upload location for the file add upload form.
+ *
+ * @param array $params
+ *   An array of parameters from the media browser.
+ * @param array $data
+ *   (optional) An array of token objects to pass to token_replace().
+ *
+ * @return string
+ *   A file directory URI with tokens replaced.
+ *
+ * @see token_replace()
+ */
+function file_entity_upload_destination_uri(array $params, array $data = array()) {
+  $params += array(
+    'uri_scheme' => file_default_scheme(),
+    'file_directory' => '',
+  );
+
+  $destination = trim($params['file_directory'], '/');
+
+  // Replace tokens.
+  $destination = token_replace($destination, $data);
+
+  return $params['uri_scheme'] . '://' . $destination;
+}
+
+/**
+ * Form for uploading multiple files.
+ */
+function file_entity_add_upload_multiple($form, &$form_state, $params = array()) {
+  $form = file_entity_add_upload($form, $form_state, $params);
+  unset($form['upload']['#title']);
+  // The validators will be set from plupload anyway. This isn't pretty,
+  // but don't allow it to show up twice.
+  unset($form['upload']['#description']);
+
+  $form['upload']['#type'] = 'plupload';
+
+  // Ensure that we call the plupload_element_pre_render function.
+  // If it isn't called, it doesn't set the JS settings that transfers the
+  // list of allowed file extentions to the PLUpload widget.
+  // We override the 'file_entity_upload_validators_pre_render' setting if it
+  // exists, because both pre-render hooks adds the upload-help with list of
+  // allowed file extensions.
+  $index = array_search('file_entity_upload_validators_pre_render', $form['upload']['#pre_render']);
+  if ($index !== FALSE) {
+    $form['upload']['#pre_render'][$index] = 'plupload_element_pre_render';
+  }
+  else {
+    $form['upload']['#pre_render'][] = 'plupload_element_pre_render';
+  }
+
+  $form['submit']['#value'] = t('Start upload');
+  return $form;
+}
+
+/**
+ * Submit handler for the multiple upload form.
+ */
+function file_entity_add_upload_multiple_submit($form, &$form_state) {
+  $upload_location = !empty($form['upload']['#upload_location']) ?
+    $form['upload']['#upload_location'] . '/' :
+    variable_get('file_default_scheme', 'public') . '://';
+
+  // We can't use file_save_upload() because of
+  // http://www.jacobsingh.name/content/tight-coupling-no-not.
+  foreach ($form_state['values']['upload'] as $uploaded_file) {
+    if ($uploaded_file['status'] == 'done') {
+      $source = $uploaded_file['tmppath'];
+      $destination = file_stream_wrapper_uri_normalize($upload_location . $uploaded_file['name']);
+      // Rename it to its original name, and put it in its final home.
+      // Note - not using file_move here because if we call file_get_mime
+      // (in file_uri_to_object) while it has a .tmp extension, it horks.
+      $destination = file_unmanaged_move($source, $destination, FILE_EXISTS_RENAME);
+
+      $file = file_uri_to_object($destination);
+      $file->status = FILE_STATUS_PERMANENT;
+      file_save($file);
+
+      $saved_files[] = $file;
+      $form_state['files'][$file->fid] = $file;
+    }
+    else {
+      // @todo: move this to element validate or something.
+      form_set_error('pud', t('The specified file %name could not be uploaded.', array('%name' => $uploaded_file['name'])));
+    }
+  }
+
+  // Redirect to the file edit page.
+  if (file_entity_access('update', $file) && module_exists('multiform') && module_exists('media')) {
+    $destination = array();
+    if (isset($_GET['destination'])) {
+      $destination = drupal_get_destination();
+      unset($_GET['destination']);
+    }
+    elseif (user_access('administer files')) {
+      $destination = array('destination' => 'admin/content/file');
+    }
+    $form_state['redirect'] = array('admin/content/file/edit-multiple/' . implode(' ', array_keys($form_state['files'])), array('query' => $destination));
+  }
+  else {
+    $form_state['redirect'] = user_access('administer files') ? 'admin/content/file' : '<front>';
+  }
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Page callback: Form constructor for the file edit form.
+ *
+ * Path: file/%file/edit
+ *
+ * @param object $file
+ *   A file object from file_load().
+ *
+ * @see file_entity_menu()
+ *
+ * @todo Rename this form to file_edit_form to ease into core.
+ */
+function file_entity_edit($form, &$form_state, $file) {
+  drupal_set_title(t('<em>Edit @type</em> @title', array('@type' => $file->type, '@title' => $file->filename)), PASS_THROUGH);
+
+  $form_state['file'] = $file;
+
+  $form['#attributes']['class'][] = 'file-form';
+  if (!empty($file->type)) {
+    $form['#attributes']['class'][] = 'file-' . $file->type . '-form';
+  }
+
+  // Basic file information.
+  // These elements are just values so they are not even sent to the client.
+  foreach (array('fid', 'type', 'uid', 'timestamp') as $key) {
+    $form[$key] = array(
+      '#type' => 'value',
+      '#value' => isset($file->$key) ? $file->$key : NULL,
+    );
+  }
+
+  $form['filename'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Name'),
+    '#default_value' => $file->filename,
+    '#required' => TRUE,
+    '#maxlength' => 255,
+    '#weight' => -10,
+  );
+
+  // Add a 'replace this file' upload field if the file is writeable.
+  if (file_entity_file_is_writeable($file)) {
+    // Set up replacement file validation.
+    $replacement_options = array();
+    // The replacement file must have the same extension as the original file.
+    $replacement_options['file_extensions'] = pathinfo($file->uri, PATHINFO_EXTENSION);
+
+    $form['replace_upload'] = array(
+      '#type' => 'file',
+      '#title' => t('Replace file'),
+      '#description' => t('This file will replace the existing file. This action cannot be undone.'),
+      '#upload_validators' => file_entity_get_upload_validators($replacement_options),
+      '#pre_render' => array('file_entity_upload_validators_pre_render'),
+    );
+  }
+
+  $form['preview'] = file_view_file($file, 'preview');
+
+  $form['additional_settings'] = array(
+    '#type' => 'vertical_tabs',
+    '#weight' => 99,
+  );
+
+  // File destination information for administrators.
+  $form['destination'] = array(
+    '#type' => 'fieldset',
+    '#access' => user_access('administer files') && file_entity_file_is_writeable($file),
+    '#title' => t('Destination'),
+    '#collapsible' => TRUE,
+    '#collapsed' => TRUE,
+    '#group' => 'additional_settings',
+    '#attributes' => array(
+      'class' => array('file-form-destination'),
+    ),
+    '#attached' => array(
+      'js' => array(
+        drupal_get_path('module', 'file_entity') . '/file_entity.js',
+      ),
+    ),
+  );
+
+  $options = array();
+  foreach (file_get_stream_wrappers(STREAM_WRAPPERS_WRITE_VISIBLE) as $scheme => $info) {
+    $options[$scheme] = check_plain($info['name']);
+  }
+
+  $form['destination']['scheme'] = array(
+    '#type' => 'radios',
+    '#title' => t('Destination'),
+    '#options' => $options,
+    '#default_value' => file_uri_scheme($file->uri),
+  );
+
+  // File user information for administrators.
+  $form['user'] = array(
+    '#type' => 'fieldset',
+    '#access' => user_access('administer files'),
+    '#title' => t('User information'),
+    '#collapsible' => TRUE,
+    '#collapsed' => TRUE,
+    '#group' => 'additional_settings',
+    '#attributes' => array(
+      'class' => array('file-form-user'),
+    ),
+    '#attached' => array(
+      'js' => array(
+        drupal_get_path('module', 'file_entity') . '/file_entity.js',
+        array(
+          'type' => 'setting',
+          'data' => array('anonymous' => variable_get('anonymous', t('Anonymous'))),
+        ),
+      ),
+    ),
+    '#weight' => 90,
+  );
+  $form['user']['name'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Associated with'),
+    '#maxlength' => 60,
+    '#autocomplete_path' => 'user/autocomplete',
+    '#default_value' => !empty($file->uid) ? user_load($file->uid)->name : '',
+    '#weight' => -1,
+    '#description' => t('Leave blank for %anonymous.', array('%anonymous' => variable_get('anonymous', t('Anonymous')))),
+  );
+
+  // Add the buttons.
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save'),
+    '#weight' => 5,
+    '#submit' => array('file_entity_edit_submit'),
+  );
+  $form['actions']['delete'] = array(
+    '#type' => 'submit',
+    '#value' => t('Delete'),
+    '#weight' => 10,
+    '#submit' => array('file_entity_edit_delete_submit'),
+    '#access' => file_entity_access('delete', $file),
+  );
+
+  // Build the URL for the cancel button taking into account that there might be
+  // a "destination" that includes query string variables.
+  $parameters = drupal_get_query_parameters();
+  $destination = isset($parameters['destination']) ? $parameters['destination'] : 'file/' . $file->fid;
+  $url = drupal_parse_url($destination);
+
+  $form['actions']['cancel'] = array(
+    '#type' => 'link',
+    '#title' => t('Cancel'),
+    '#href' => $url['path'],
+    '#options' => array('query' => $url['query']),
+    '#weight' => 15,
+  );
+
+  $langcode = function_exists('entity_language') ? entity_language('file', $file) : NULL;
+  field_attach_form('file', $file, $form, $form_state, $langcode);
+
+  return $form;
+}
+
+/**
+ * Form validation handler for file_entity_edit().
+ */
+function file_entity_edit_validate($form, &$form_state) {
+  $file = (object) $form_state['values'];
+
+  // Validate the "associated user" field.
+  if (!empty($file->name) && !($account = user_load_by_name($file->name))) {
+    // The use of empty() is mandatory in the context of usernames
+    // as the empty string denotes the anonymous user. In case we
+    // are dealing with an anonymous user we set the user ID to 0.
+    form_set_error('name', t('The username %name does not exist.', array('%name' => $file->name)));
+  }
+
+  // Handle the replacement file if uploaded.
+  if (isset($form_state['values']['replace_upload'])) {
+    // Save the file as a temporary file.
+    $file = file_save_upload('replace_upload', $form['replace_upload']['#upload_validators']);
+    if (!empty($file)) {
+      // Put the temporary file in form_values so we can save it on submit.
+      $form_state['values']['replace_upload'] = $file;
+    }
+    elseif ($file === FALSE) {
+      // File uploaded failed.
+      form_set_error('replace_upload', t('The replacement file could not be uploaded.'));
+    }
+  }
+
+  // Run entity form validation.
+  entity_form_field_validate('file', $form, $form_state);
+}
+
+/**
+ * Form submission handler for the 'Save' button for file_entity_edit().
+ */
+function file_entity_edit_submit($form, &$form_state) {
+  $file = $form_state['file'];
+
+  // Check if a replacement file has been uploaded.
+  if (!empty($form_state['values']['replace_upload'])) {
+    $replacement = $form_state['values']['replace_upload'];
+    // Move file from temp to permanent home.
+    file_unmanaged_copy($replacement->uri, $file->uri, FILE_EXISTS_REPLACE);
+  }
+
+  // Run entity form submit handling and save the file.
+  entity_form_submit_build_entity('file', $file, $form, $form_state);
+
+  // A user might assign the associated user by entering a user name in the file
+  // edit form, which we then need to translate to a user ID.
+  if (isset($file->name)) {
+    // The use of isset() is mandatory in the context of user IDs, because
+    // user ID 0 denotes the anonymous user.
+    if ($user = user_load_by_name($file->name)) {
+      $file->uid = $user->uid;
+    }
+    else {
+      // Anonymous user.
+      $file->uid = 0;
+    }
+  }
+  elseif ($file->uid) {
+    $user = user_load($file->uid);
+    $file->name = $user->name;
+  }
+
+  if (file_uri_scheme($file->uri) != $form_state['values']['scheme']) {
+    if ($moved_file = file_move($file, $form_state['values']['scheme'] . '://' . file_uri_target($file->uri), FILE_EXISTS_RENAME)) {
+      // Only re-assign the file object if file_move() did not fail.
+      $file = $moved_file;
+    }
+  }
+
+  file_save($file);
+
+  $args = array(
+    '@type' => file_entity_type_get_name($file),
+    '%title' => entity_label('file', $file),
+  );
+  watchdog('file', '@type: updated %title.', $args);
+  drupal_set_message(t('@type %title has been updated.', $args));
+
+  $form_state['redirect'] = 'file/' . $file->fid;
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Form submission handler for the 'Delete' button for file_entity_edit().
+ */
+function file_entity_edit_delete_submit($form, &$form_state) {
+  $fid = $form_state['values']['fid'];
+  $destination = array();
+  if (isset($_GET['destination'])) {
+    $destination = drupal_get_destination();
+    unset($_GET['destination']);
+  }
+  $form_state['redirect'] = array('file/' . $fid . '/delete', array('query' => $destination));
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Page callback: Form constructor for the file deletion confirmation form.
+ *
+ * Path: file/%file/delete
+ *
+ * @param object $file
+ *   A file object from file_load().
+ *
+ * @see file_entity_menu()
+ */
+function file_entity_delete_form($form, &$form_state, $file) {
+  $form_state['file'] = $file;
+
+  $form['fid'] = array(
+    '#type' => 'value',
+    '#value' => $file->fid,
+  );
+
+  $description = t('This action cannot be undone.');
+  if ($references = file_usage_list($file)) {
+    $description .= ' ' . t('This file is currently in use and may cause problems if deleted.');
+  }
+
+  return confirm_form($form,
+    t('Are you sure you want to delete the file %title?', array(
+      '%title' => entity_label('file', $file),
+    )),
+    'file/' . $file->fid,
+    $description,
+    t('Delete')
+  );
+}
+
+/**
+ * Form submission handler for file_entity_delete_form().
+ */
+function file_entity_delete_form_submit($form, &$form_state) {
+  if ($form_state['values']['confirm'] && $file = file_load($form_state['values']['fid'])) {
+    // Use file_delete_multiple() rather than file_delete() since we want to
+    // avoid unwanted validation and usage checking.
+    file_delete_multiple(array($file->fid));
+
+    $args = array(
+      '@type' => file_entity_type_get_name($file),
+      '%title' => entity_label('file', $file),
+    );
+    watchdog('file', '@type: deleted %title.', $args);
+    drupal_set_message(t('@type %title has been deleted.', $args));
+  }
+
+  $form_state['redirect'] = '<front>';
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Form constructor for file deletion confirmation form.
+ *
+ * @param array $files
+ *   An array of file objects.
+ */
+function file_entity_multiple_delete_form($form, &$form_state, array $files) {
+  $form['files'] = array(
+    '#prefix' => '<ul>',
+    '#suffix' => '</ul>',
+    '#tree' => TRUE,
+  );
+
+  $files_have_usage = FALSE;
+  foreach ($files as $fid => $file) {
+    $title = entity_label('file', $file);
+    $usage = file_usage_list($file);
+    if (!empty($usage)) {
+      $files_have_usage = TRUE;
+      $title = t('@title (in use)', array('@title' => $title));
+    }
+    else {
+      $title = check_plain($title);
+    }
+    $form['files'][$fid] = array(
+      '#type' => 'hidden',
+      '#value' => $fid,
+      '#prefix' => '<li>',
+      '#suffix' => $title . "</li>\n",
+    );
+  }
+
+  $form['operation'] = array(
+    '#type' => 'hidden',
+    '#value' => 'delete',
+  );
+
+  $description = t('This action cannot be undone.');
+  if ($files_have_usage) {
+    $description .= ' ' . t('Some of the files are currently in use and may cause problems if deleted.');
+  }
+
+  return confirm_form(
+    $form,
+    format_plural(count($files), 'Are you sure you want to delete this file?', 'Are you sure you want to delete these files?'),
+    'admin/content/file',
+    $description,
+    t('Delete')
+  );
+}
+
+/**
+ * Form submission handler for file_entity_multiple_delete_form().
+ */
+function file_entity_multiple_delete_form_submit($form, &$form_state) {
+  if ($form_state['values']['confirm'] && $fids = array_keys($form_state['values']['files'])) {
+    file_delete_multiple($fids);
+    $count = count($fids);
+    watchdog('file', 'Deleted @count files.', array('@count' => $count));
+    drupal_set_message(format_plural($count, 'Deleted one file.', 'Deleted @count files.'));
+  }
+  $form_state['redirect'] = 'admin/content/file';
+
+  // Clear the page and block caches.
+  cache_clear_all();
+}
+
+/**
+ * Page callback for the file edit form.
+ *
+ * @deprecated
+ *   Use drupal_get_form('file_entity_edit')
+ */
+function file_entity_page_edit($file) {
+  return drupal_get_form('file_entity_edit', $file);
+}
+
+/**
+ * Page callback for the file deletion confirmation form.
+ *
+ * @deprecated
+ *   Use drupal_get_form('file_entity_delete_form')
+ */
+function file_entity_page_delete($file) {
+  return drupal_get_form('file_entity_delete_form');
+}
+
+/**
+ * Retrieves the upload validators for a file.
+ *
+ * @param array $options
+ *   (optional) An array of options for file validation.
+ *
+ * @return array
+ *   An array suitable for passing to file_save_upload() or for a managed_file
+ *   or upload element's '#upload_validators' property.
+ */
+function file_entity_get_upload_validators(array $options = array()) {
+  // Set up file upload validators.
+  $validators = array();
+
+  // Validate file extensions. If there are no file extensions in $params and
+  // there are no Media defaults, there is no file extension validation.
+  if (!empty($options['file_extensions'])) {
+    $validators['file_validate_extensions'] = array($options['file_extensions']);
+  }
+  else {
+    $validators['file_validate_extensions'] = array(variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'));
+  }
+
+  // Cap the upload size according to the system or user defined limit.
+  $max_filesize = parse_size(file_upload_max_size());
+  $file_entity_max_filesize = parse_size(variable_get('file_entity_max_filesize', ''));
+
+  // If the user defined a size limit, use the smaller of the two.
+  if (!empty($file_entity_max_filesize)) {
+    $max_filesize = min($max_filesize, $file_entity_max_filesize);
+  }
+
+  if (!empty($options['max_filesize']) && $options['max_filesize'] < $max_filesize) {
+    $max_filesize = parse_size($options['max_filesize']);
+  }
+
+  // There is always a file size limit due to the PHP server limit.
+  $validators['file_validate_size'] = array($max_filesize);
+
+  // Add image validators.
+  $options += array('min_resolution' => 0, 'max_resolution' => 0);
+  if ($options['min_resolution'] || $options['max_resolution']) {
+    $validators['file_validate_image_resolution'] = array($options['max_resolution'], $options['min_resolution']);
+  }
+
+  // Add other custom upload validators from options.
+  if (!empty($options['upload_validators'])) {
+    $validators += $options['upload_validators'];
+  }
+
+  return $validators;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.pathauto.inc b/profiles/commons/modules/contrib/file_entity/file_entity.pathauto.inc
new file mode 100644
index 0000000..3b3d695
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.pathauto.inc
@@ -0,0 +1,84 @@
+<?php
+
+/**
+ * @file
+ * Pathauto integration for files.
+ *
+ * @ingroup pathauto
+ */
+
+/**
+ * Implements hook_path_alias_types().
+ */
+function file_entity_path_alias_types() {
+  $objects['file/'] = t('Files');
+
+  return $objects;
+}
+
+/**
+ * Implements hook_pathauto().
+ */
+function file_entity_pathauto($op) {
+  switch ($op) {
+    case 'settings':
+      $settings = array();
+      $settings['module'] = 'file';
+      $settings['token_type'] = 'file';
+      $settings['groupheader'] = t('File paths');
+      $settings['patterndescr'] = t('Default path pattern (applies to all file types with blank patterns below)');
+      $settings['patterndefault'] = 'files/[file:name]';
+      $settings['batch_update_callback'] = 'file_entity_pathauto_bulk_update_batch_process';
+      $settings['batch_file'] = drupal_get_path('module', 'file_entity') . '/file_entity.pathauto.inc';
+
+      foreach (file_type_get_enabled_types() as $file_type => $type) {
+        $settings['patternitems'][$file_type] = t('Pattern for all @file_type paths.', array('@file_type' => $type->label));
+      }
+      return (object) $settings;
+
+    default:
+      break;
+  }
+}
+
+/**
+ * Batch processing callback; Generate aliases for files.
+ */
+function file_entity_pathauto_bulk_update_batch_process(&$context) {
+  if (!isset($context['sandbox']['current'])) {
+    $context['sandbox']['count'] = 0;
+    $context['sandbox']['current'] = 0;
+  }
+
+  $query = db_select('file_managed', 'fm');
+  $query->leftJoin('url_alias', 'ua', "CONCAT('file/', fm.fid) = ua.source");
+  $query->addField('fm', 'fid');
+  $query->isNull('ua.source');
+  $query->condition('fm.fid', $context['sandbox']['current'], '>');
+  $query->orderBy('fm.fid');
+  $query->addTag('pathauto_bulk_update');
+  $query->addMetaData('entity', 'file');
+
+  // Get the total amount of items to process.
+  if (!isset($context['sandbox']['total'])) {
+    $context['sandbox']['total'] = $query->countQuery()->execute()->fetchField();
+
+    // If there are no files to update, the stop immediately.
+    if (!$context['sandbox']['total']) {
+      $context['finished'] = 1;
+      return;
+    }
+  }
+
+  $query->range(0, 25);
+  $fids = $query->execute()->fetchCol();
+
+  pathauto_file_update_alias_multiple($fids, 'bulkupdate');
+  $context['sandbox']['count'] += count($fids);
+  $context['sandbox']['current'] = max($fids);
+  $context['message'] = t('Updated alias for file @fid.', array('@fid' => end($fids)));
+
+  if ($context['sandbox']['count'] != $context['sandbox']['total']) {
+    $context['finished'] = $context['sandbox']['count'] / $context['sandbox']['total'];
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.test b/profiles/commons/modules/contrib/file_entity/file_entity.test
new file mode 100644
index 0000000..acc1092
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.test
@@ -0,0 +1,1258 @@
+<?php
+
+/**
+ * @file
+ * Test integration for the file_entity module.
+ */
+
+class FileEntityTestHelper extends DrupalWebTestCase {
+  protected $files = array();
+
+  function setUp() {
+    $modules = func_get_args();
+    if (isset($modules[0]) && is_array($modules[0])) {
+      $modules = $modules[0];
+    }
+    $modules[] = 'file_entity';
+    parent::setUp($modules);
+  }
+
+  protected function setUpFiles() {
+    $types = array('text', 'image');
+    foreach ($types as $type) {
+      foreach ($this->drupalGetTestFiles($type) as $file) {
+        $this->files[$type][] = file_save($file);
+      }
+    }
+  }
+
+  protected function createFileType($overrides = array()) {
+    $type = new stdClass();
+    $type->type = 'test';
+    $type->label = "Test";
+    $type->description = '';
+    $type->mimetypes = array('image/jpeg', 'image/gif', 'image/png', 'image/tiff');
+
+    foreach ($overrides as $k => $v) {
+      $type->$k = $v;
+    }
+
+    file_type_save($type);
+    return $type;
+  }
+
+  /**
+   * Helper for testFileEntityPrivateDownloadAccess() test.
+   *
+   * Defines several cases for accesing private files.
+   *
+   * @return array
+   *   Array of associative arrays, each one having the next keys:
+   *   - "message" string with the assertion message.
+   *   - "permissions" array of permissions or NULL for anonymous user.
+   *   - "expect" expected HTTP response code.
+   *   - "owner" Optional boolean indicating if the user is a file owner.
+   */
+  protected function getPrivateDownloadAccessCases() {
+    return array(
+      array(
+        'message' => "File owners cannot download their own files unless they are granted the 'view own private files' permission.",
+        'permissions' => array(),
+        'expect' => 403,
+        'owner' => TRUE,
+      ),
+      array(
+        'message' => "File owners can download their own files as they have been granted the 'view own private files' permission.",
+        'permissions' => array('view own private files'),
+        'expect' => 200,
+        'owner' => TRUE,
+      ),
+      array(
+        'message' => "Anonymous users cannot download private files.",
+        'permissions' => NULL,
+        'expect' => 403,
+      ),
+      array(
+        'message' => "Authenticated users cannot download each other's private files.",
+        'permissions' => array(),
+        'expect' => 403,
+      ),
+      array(
+        'message' => "Users who can view public files are not able to download private files.",
+        'permissions' => array('view files'),
+        'expect' => 403,
+      ),
+      array(
+        'message' => "Users who bypass file access can download any file.",
+        'permissions' => array('bypass file access'),
+        'expect' => 200,
+      ),
+    );
+  }
+
+  /**
+   * Retrieves a sample file of the specified type.
+   */
+  function getTestFile($type_name, $size = NULL) {
+    // Get a file to upload.
+    $file = current($this->drupalGetTestFiles($type_name, $size));
+
+    // Add a filesize property to files as would be read by file_load().
+    $file->filesize = filesize($file->uri);
+
+    return $file;
+  }
+
+  /**
+   * Get a file from the database based on its filename.
+   *
+   * @param $filename
+   *   A file filename, usually generated by $this->randomName().
+   * @param $reset
+   *   (optional) Whether to reset the internal file_load() cache.
+   *
+   * @return
+   *   A file object matching $filename.
+   */
+  function getFileByFilename($filename, $reset = FALSE) {
+    $files = file_load_multiple(array(), array('filename' => $filename), $reset);
+    // Load the first file returned from the database.
+    $returned_file = reset($files);
+    return $returned_file;
+  }
+
+  protected function createFileEntity($settings = array()) {
+    $file = new stdClass();
+
+    // Populate defaults array.
+    $settings += array(
+      'filepath' => '   ' . $this->randomName(), // Prefix with non-latin characters to ensure that all file-related tests work with international filenames.
+      'filemime' => 'text/plain',
+      'uid' => 1,
+      'timestamp' => REQUEST_TIME,
+      'status' => FILE_STATUS_PERMANENT,
+      'contents' => "file_put_contents() doesn't seem to appreciate empty strings so let's put in some data.",
+      'scheme' => file_default_scheme(),
+      'type' => NULL,
+    );
+
+    $filepath = $settings['scheme'] . '://' . $settings['filepath'];
+
+    file_put_contents($filepath, $settings['contents']);
+    $this->assertTrue(is_file($filepath), t('The test file exists on the disk.'), 'Create test file');
+
+    $file = new stdClass();
+    $file->uri = $filepath;
+    $file->filename = drupal_basename($file->uri);
+    $file->filemime = $settings['filemime'];
+    $file->uid = $settings['uid'];
+    $file->timestamp = $settings['timestamp'];
+    $file->filesize = filesize($file->uri);
+    $file->status = $settings['status'];
+    $file->type = $settings['type'];
+
+    // The file type is used as a bundle key, and therefore, must not be NULL.
+    if (!isset($file->type)) {
+      $file->type = FILE_TYPE_NONE;
+    }
+
+    // If the file isn't already assigned a real type, determine what type should
+    // be assigned to it.
+    if ($file->type === FILE_TYPE_NONE) {
+      $type = file_get_type($file);
+      if (isset($type)) {
+        $file->type = $type;
+      }
+    }
+
+    // Write the record directly rather than calling file_save() so we don't
+    // invoke the hooks.
+    $this->assertNotIdentical(drupal_write_record('file_managed', $file), FALSE, t('The file was added to the database.'), 'Create test file');
+
+    return $file;
+  }
+
+  /**
+   * Overrides DrupalWebTestCase::drupalGetToken() to support the hash salt.
+   *
+   * @todo Remove when http://drupal.org/node/1555862 is fixed in core.
+   */
+  protected function drupalGetToken($value = '') {
+    $private_key = drupal_get_private_key();
+    return drupal_hmac_base64($value, $this->session_id . $private_key . drupal_get_hash_salt());
+  }
+}
+
+class FileEntityFileTypeClassificationTestCase extends DrupalWebTestCase {
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity classification',
+      'description' => 'Test existing file entity classification functionality.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+  }
+
+  /**
+   * Get the file type of a given file.
+   *
+   * @param $file
+   *   A file object.
+   *
+   * @return
+   *   The file's file type as a string.
+   */
+  function getFileType($file) {
+    $type = db_select('file_managed', 'fm')
+      ->fields('fm', array('type'))
+      ->condition('fid', $file->fid, '=')
+      ->execute()
+      ->fetchAssoc();
+
+    return $type;
+  }
+
+  /**
+   * Test that existing files are properly classified by file type.
+   */
+  function testFileTypeClassification() {
+    // Get test text and image files.
+    $file = current($this->drupalGetTestFiles('text'));
+    $text_file = file_save($file);
+    $file = current($this->drupalGetTestFiles('image'));
+    $image_file = file_save($file);
+
+    // Enable file entity which adds adds a file type property to files and
+    // queues up existing files for classification.
+    module_enable(array('file_entity'));
+
+    // Existing files have yet to be classified and should have an undefined
+    // file type.
+    $file_type = $this->getFileType($text_file);
+    $this->assertEqual($file_type['type'], 'undefined', t('The text file has an undefined file type.'));
+    $file_type = $this->getFileType($image_file);
+    $this->assertEqual($file_type['type'], 'undefined', t('The image file has an undefined file type.'));
+
+    // The classification queue is processed during cron runs. Run cron to
+    // trigger the classification process.
+    $this->cronRun();
+
+    // The classification process should assign a file type to any file whose
+    // MIME type is assigned to a file type. Check to see if each file was
+    // assigned a proper file type.
+    $file_type = $this->getFileType($text_file);
+    $this->assertEqual($file_type['type'], 'document', t('The text file was properly assigned the Document file type.'));
+    $file_type = $this->getFileType($image_file);
+    $this->assertEqual($file_type['type'], 'image', t('The image file was properly assigned the Image file type.'));
+  }
+}
+
+class FileEntityUnitTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity unit tests',
+      'description' => 'Test basic file entity functionality.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    parent::setUpFiles();
+  }
+
+  /**
+   * Regression tests for core issue http://drupal.org/node/1239376.
+   */
+  function testMimeTypeMappings() {
+    $tests = array(
+      'public://test.ogg' => 'audio/ogg',
+      'public://test.mkv' => 'video/x-m4v',
+      'public://test.mka' => 'audio/x-matroska',
+      'public://test.mkv' => 'video/x-matroska',
+      'public://test.webp' => 'image/webp',
+    );
+    foreach ($tests as $input => $expected) {
+      $this->assertEqual(file_get_mimetype($input), $expected);
+    }
+  }
+
+  function testFileEntity() {
+    $file = reset($this->files['text']);
+
+    // Test entity ID, revision ID, and bundle.
+    $ids = entity_extract_ids('file', $file);
+    $this->assertIdentical($ids, array($file->fid, NULL, 'document'));
+
+    // Test the entity URI callback.
+    $uri = entity_uri('file', $file);
+    $this->assertEqual($uri['path'], "file/{$file->fid}");
+  }
+
+  function testImageDimensions() {
+    $files = array();
+    $text_fids = array();
+    // Test hook_file_insert().
+    // Files have been saved as part of setup (in FileEntityTestHelper::setUpFiles).
+    foreach ($this->files['image'] as $file) {
+      $files[$file->fid] = $file->metadata;
+      $this->assertTrue(isset($file->metadata['height']), 'Image height retrieved on file_save() for an image file.');
+      $this->assertTrue(isset($file->metadata['width']), 'Image width retrieved on file_save() for an image file.');
+    }
+    foreach ($this->files['text'] as $file) {
+      $text_fids[] = $file->fid;
+      $this->assertFalse(isset($file->metadata['height']), 'No image height retrieved on file_save() for an text file.');
+      $this->assertFalse(isset($file->metadata['width']), 'No image width retrieved on file_save() for an text file.');
+    }
+
+    // Test hook_file_load().
+    // Clear the cache and load fresh files objects to test file_load behavior.
+    entity_get_controller('file')->resetCache();
+    foreach (file_load_multiple(array_keys($files)) as $file) {
+      $this->assertTrue(isset($file->metadata['height']), 'Image dimensions retrieved on file_load() for an image file.');
+      $this->assertTrue(isset($file->metadata['width']), 'Image dimensions retrieved on file_load() for an image file.');
+      $this->assertEqual($file->metadata['height'], $files[$file->fid]['height'], 'Loaded image height is equal to saved image height.');
+      $this->assertEqual($file->metadata['width'], $files[$file->fid]['width'], 'Loaded image width is equal to saved image width.');
+    }
+    foreach (file_load_multiple($text_fids) as $file) {
+      $this->assertFalse(isset($file->metadata['height']), 'No image height retrieved on file_load() for an text file.');
+      $this->assertFalse(isset($file->metadata['width']), 'No image width retrieved on file_load() for an text file.');
+    }
+
+    // Test hook_file_update().
+    // Load the first image file and resize it.
+    $image_files = array_keys($files);
+    $file = file_load(reset($image_files));
+    $image = image_load($file->uri);
+    image_resize($image, $file->metadata['width'] / 2, $file->metadata['height'] / 2);
+    image_save($image);
+    file_save($file);
+    $this->assertEqual($file->metadata['height'], $files[$file->fid]['height'] / 2, 'Image file height updated by file_save().');
+    $this->assertEqual($file->metadata['width'], $files[$file->fid]['width'] / 2, 'Image file width updated by file_save().');
+    // Clear the cache and reload the file.
+    entity_get_controller('file')->resetCache();
+    $file = file_load($file->fid);
+    $this->assertEqual($file->metadata['height'], $files[$file->fid]['height'] / 2, 'Updated image height retrieved by file_load().');
+    $this->assertEqual($file->metadata['width'], $files[$file->fid]['width'] / 2, 'Updated image width retrieved by file_load().');
+
+    //Test hook_file_delete().
+    file_delete($file, TRUE);
+    $this->assertFalse(db_query('SELECT COUNT(*) FROM {file_metadata} WHERE fid = :fid', array(':fid' => 'fid'))->fetchField(), 'Row deleted in {file_dimensions} on file_delete().');
+  }
+}
+
+class FileEntityEditTestCase extends FileEntityTestHelper {
+  protected $web_user;
+  protected $admin_user;
+
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity edit',
+      'description' => 'Create a file and test file edit functionality.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+
+    $this->web_user = $this->drupalCreateUser(array('edit own document files', 'create files'));
+    $this->admin_user = $this->drupalCreateUser(array('bypass file access', 'administer files'));
+  }
+
+  /**
+   * Check file edit functionality.
+   */
+  function testFileEntityEdit() {
+    $this->drupalLogin($this->web_user);
+
+    $test_file = $this->getTestFile('text');
+    $name_key = "filename";
+
+    // Create file to edit.
+    $edit = array();
+    $edit['files[upload]'] = drupal_realpath($test_file->uri);
+    $this->drupalPost('file/add', $edit, t('Next'));
+    if ($this->xpath('//input[@name="scheme"]')) {
+      $this->drupalPost(NULL, array(), t('Next'));
+    }
+
+    // Check that the file exists in the database.
+    $file = $this->getFileByFilename($test_file->filename);
+    $this->assertTrue($file, t('File found in database.'));
+
+    // Check that "edit" link points to correct page.
+    $this->clickLink(t('Edit'));
+    $edit_url = url("file/$file->fid/edit", array('absolute' => TRUE));
+    $actual_url = $this->getURL();
+    $this->assertEqual($edit_url, $actual_url, t('On edit page.'));
+
+    // Check that the name field is displayed with the correct value.
+    $active = '<span class="element-invisible">' . t('(active tab)') . '</span>';
+    $link_text = t('!local-task-title!active', array('!local-task-title' => t('Edit'), '!active' => $active));
+    $this->assertText(strip_tags($link_text), 0, t('Edit tab found and marked active.'));
+    $this->assertFieldByName($name_key, $file->filename, t('Name field displayed.'));
+
+    // The user does not have "delete" permissions so no delete button should be found.
+    $this->assertNoFieldByName('op', t('Delete'), 'Delete button not found.');
+
+    // Edit the content of the file.
+    $edit = array();
+    $edit[$name_key] = $this->randomName(8);
+    // Stay on the current page, without reloading.
+    $this->drupalPost(NULL, $edit, t('Save'));
+
+    // Check that the name field is displayed with the updated values.
+    $this->assertText($edit[$name_key], t('Name displayed.'));
+  }
+
+  /**
+   * Check changing file associated user fields.
+   */
+  function testFileEntityAssociatedUser() {
+    $this->drupalLogin($this->admin_user);
+
+    // Create file to edit.
+    $test_file = $this->getTestFile('text');
+    $name_key = "filename";
+    $edit = array();
+    $edit['files[upload]'] = drupal_realpath($test_file->uri);
+    $this->drupalPost('file/add', $edit, t('Next'));
+
+    // Check that the file was associated with the currently logged in user.
+    $file = $this->getFileByFilename($test_file->filename);
+    $this->assertIdentical($file->uid, $this->admin_user->uid, 'File associated with admin user.');
+
+    // Try to change the 'associated user' field to an invalid user name.
+    $edit = array(
+      'name' => 'invalid-name',
+    );
+    $this->drupalPost('file/' . $file->fid . '/edit', $edit, t('Save'));
+    $this->assertText('The username invalid-name does not exist.');
+
+    // Change the associated user field to an empty string, which should assign
+    // association to the anonymous user (uid 0).
+    $edit['name'] = '';
+    $this->drupalPost('file/' . $file->fid . '/edit', $edit, t('Save'));
+    $file = file_load($file->fid);
+    $this->assertIdentical($file->uid, '0', 'File associated with anonymous user.');
+
+    // Change the associated user field to another user's name (that is not
+    // logged in).
+    $edit['name'] = $this->web_user->name;
+    $this->drupalPost('file/' . $file->fid . '/edit', $edit, t('Save'));
+    $file = file_load($file->fid);
+    $this->assertIdentical($file->uid, $this->web_user->uid, 'File associated with normal user.');
+
+    // Check that normal users cannot change the associated user information.
+    $this->drupalLogin($this->web_user);
+    $this->drupalGet('file/' . $file->fid . '/edit');
+    $this->assertNoFieldByName('name');
+  }
+}
+
+class FileEntityCreationTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity creation',
+      'description' => 'Create a file and test saving it.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+
+    $web_user = $this->drupalCreateUser(array('create files', 'edit own document files'));
+    $this->drupalLogin($web_user);
+  }
+
+  /**
+   * Create a "document" file and verify its consistency in the database.
+   */
+  function testFileEntityCreation() {
+    $test_file = $this->getTestFile('text');
+    // Create a file.
+    $edit = array();
+    $edit['files[upload]'] = drupal_realpath($test_file->uri);
+    $this->drupalPost('file/add', $edit, t('Next'));
+
+    // Step 2: Scheme selection
+    if ($this->xpath('//input[@name="scheme"]')) {
+      $this->drupalPost(NULL, array(), t('Next'));
+    }
+
+    // Check that the document file has been uploaded.
+    $this->assertRaw(t('!type %name was uploaded.', array('!type' => 'Document', '%name' => $test_file->filename)), t('Document file uploaded.'));
+
+    // Check that the file exists in the database.
+    $file = $this->getFileByFilename($test_file->filename);
+    $this->assertTrue($file, t('File found in database.'));
+  }
+}
+
+/**
+ * Test file administration page functionality.
+ */
+class FileEntityAdminTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File administration',
+      'description' => 'Test file administration page functionality.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+
+    // Remove the "view files" permission which is set
+    // by default for all users so we can test this permission
+    // correctly.
+    $roles = user_roles();
+    foreach ($roles as $rid => $role) {
+      user_role_revoke_permissions($rid, array('view files'));
+    }
+
+    $this->admin_user = $this->drupalCreateUser(array('administer files', 'bypass file access'));
+    $this->base_user_1 = $this->drupalCreateUser(array('administer files'));
+    $this->base_user_2 = $this->drupalCreateUser(array('administer files', 'view own private files'));
+    $this->base_user_3 = $this->drupalCreateUser(array('administer files', 'view private files'));
+    $this->base_user_4 = $this->drupalCreateUser(array('administer files', 'edit any document files', 'delete any document files', 'edit any image files', 'delete any image files'));
+  }
+
+  /**
+   * Tests that the table sorting works on the files admin pages.
+   */
+  function testFilesAdminSort() {
+    $this->drupalLogin($this->admin_user);
+    $i = 0;
+    foreach (array('dd', 'aa', 'DD', 'bb', 'cc', 'CC', 'AA', 'BB') as $prefix) {
+      $this->createFileEntity(array('filepath' => $prefix . $this->randomName(6), 'timestamp' => $i));
+      $i++;
+    }
+
+    // Test that the default sort by file_managed.timestamp DESC actually fires properly.
+    $files_query = db_select('file_managed', 'fm')
+      ->fields('fm', array('fid'))
+      ->orderBy('timestamp', 'DESC')
+      ->execute()
+      ->fetchCol();
+
+    $files_form = array();
+    $this->drupalGet('admin/content/file');
+    foreach ($this->xpath('//table/tbody/tr/td/div/input/@value') as $input) {
+      $files_form[] = $input;
+    }
+    $this->assertEqual($files_query, $files_form, 'Files are sorted in the form according to the default query.');
+
+    // Compare the rendered HTML node list to a query for the files ordered by
+    // filename to account for possible database-dependent sort order.
+    $files_query = db_select('file_managed', 'fm')
+      ->fields('fm', array('fid'))
+      ->orderBy('filename')
+      ->execute()
+      ->fetchCol();
+
+    $files_form = array();
+    $this->drupalGet('admin/content/file', array('query' => array('sort' => 'asc', 'order' => 'Title')));
+    foreach ($this->xpath('//table/tbody/tr/td/div/input/@value') as $input) {
+      $files_form[] = $input;
+    }
+    $this->assertEqual($files_query, $files_form, 'Files are sorted in the form the same as they are in the query.');
+  }
+
+  /**
+   * Tests files overview with different user permissions.
+   */
+  function testFilesAdminPages() {
+    $this->drupalLogin($this->admin_user);
+
+    $files['public_image'] = $this->createFileEntity(array('scheme' => 'public', 'uid' => $this->base_user_1->uid, 'type' => 'image'));
+    $files['public_document'] = $this->createFileEntity(array('scheme' => 'public', 'uid' => $this->base_user_2->uid, 'type' => 'document'));
+    $files['private_image'] = $this->createFileEntity(array('scheme' => 'private', 'uid' => $this->base_user_1->uid, 'type' => 'image'));
+    $files['private_document'] = $this->createFileEntity(array('scheme' => 'private', 'uid' => $this->base_user_2->uid, 'type' => 'document'));
+
+    // Verify view, edit, and delete links for any file.
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+    foreach ($files as $file) {
+      $this->assertLinkByHref('file/' . $file->fid);
+      $this->assertLinkByHref('file/' . $file->fid . '/edit');
+      $this->assertLinkByHref('file/' . $file->fid . '/delete');
+      // Verify tableselect.
+      $this->assertFieldByName('files[' . $file->fid . ']', '', t('Tableselect found.'));
+    }
+
+    // Verify no operation links are displayed for regular users.
+    $this->drupalLogout();
+    $this->drupalLogin($this->base_user_1);
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+    $this->assertLinkByHref('file/' . $files['public_image']->fid);
+    $this->assertLinkByHref('file/' . $files['public_document']->fid);
+    $this->assertNoLinkByHref('file/' . $files['public_image']->fid . '/edit');
+    $this->assertNoLinkByHref('file/' . $files['public_image']->fid . '/delete');
+    $this->assertNoLinkByHref('file/' . $files['public_document']->fid . '/edit');
+    $this->assertNoLinkByHref('file/' . $files['public_document']->fid . '/delete');
+
+    // Verify no tableselect.
+    $this->assertNoFieldByName('files[' . $files['public_image']->fid . ']', '', t('No tableselect found.'));
+
+    // Verify private file is displayed with permission.
+    $this->drupalLogout();
+    $this->drupalLogin($this->base_user_2);
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+    $this->assertLinkByHref('file/' . $files['private_document']->fid);
+    // Verify no operation links are displayed.
+    $this->assertNoLinkByHref('file/' . $files['private_document']->fid . '/edit');
+    $this->assertNoLinkByHref('file/' . $files['private_document']->fid . '/delete');
+
+    // Verify user cannot see private file of other users.
+    $this->assertNoLinkByHref('file/' . $files['private_image']->fid);
+    $this->assertNoLinkByHref('file/' . $files['private_image']->fid . '/edit');
+    $this->assertNoLinkByHref('file/' . $files['private_image']->fid . '/delete');
+
+    // Verify no tableselect.
+    $this->assertNoFieldByName('files[' . $files['private_document']->fid . ']', '', t('No tableselect found.'));
+
+    // Verify private file is displayed with permission.
+    $this->drupalLogout();
+    $this->drupalLogin($this->base_user_3);
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+
+    // Verify user can see private file of other users.
+    $this->assertLinkByHref('file/' . $files['private_document']->fid);
+    $this->assertLinkByHref('file/' . $files['private_image']->fid);
+
+    // Verify operation links are displayed for users with appropriate permission.
+    $this->drupalLogout();
+    $this->drupalLogin($this->base_user_4);
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+    foreach ($files as $file) {
+      $this->assertLinkByHref('file/' . $file->fid);
+      $this->assertLinkByHref('file/' . $file->fid . '/edit');
+      $this->assertLinkByHref('file/' . $file->fid . '/delete');
+    }
+
+    // Verify file access can be bypassed.
+    $this->drupalLogout();
+    $this->drupalLogin($this->admin_user);
+    $this->drupalGet('admin/content/file');
+    $this->assertResponse(200);
+    foreach ($files as $file) {
+      $this->assertLinkByHref('file/' . $file->fid);
+      $this->assertLinkByHref('file/' . $file->fid . '/edit');
+      $this->assertLinkByHref('file/' . $file->fid . '/delete');
+    }
+  }
+}
+
+class FileEntityReplaceTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File replacement',
+      'description' => 'Test file replace functionality.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    parent::setUpFiles();
+  }
+
+  /**
+   * @todo Test image dimensions for an image field are reset when a file is replaced.
+   * @todo Test image styles are cleared when an image is updated.
+   */
+  function testReplaceFile() {
+    // Select the first text test file to use.
+    $file = reset($this->files['text']);
+
+    // Create a user with file edit permissions.
+    $user = $this->drupalCreateUser(array('edit any document files'));
+    $this->drupalLogin($user);
+
+    // Test that the Upload widget appears for a local file.
+    $this->drupalGet('file/' . $file->fid . '/edit');
+    $this->assertFieldByName('files[replace_upload]');
+
+    // Test that file saves without uploading a file.
+    $this->drupalPost(NULL, array(), t('Save'));
+    $this->assertText(t('Document @file has been updated.', array('@file' => $file->filename)), 'File was updated without file upload.');
+
+    // Get the next text file to use as a replacement.
+    $original = clone $file;
+    $replacement = next($this->files['text']);
+
+    // Test that the file saves when uploading a replacement file.
+    $edit = array();
+    $edit['files[replace_upload]'] = drupal_realpath($replacement->uri);
+    $this->drupalPost('file/' . $file->fid . '/edit', $edit, t('Save'));
+    $this->assertText(t('Document @file has been updated.', array('@file' => $file->filename)), 'File was updated with file upload.');
+
+    // Re-load the file from the database.
+    $file = file_load($file->fid);
+
+    // Test how file properties changed after the file has been replaced.
+    $this->assertEqual($file->filename, $original->filename, 'Updated file name did not change.');
+    $this->assertNotEqual($file->filesize, $original->filesize, 'Updated file size changed from previous file.');
+    $this->assertEqual($file->filesize, $replacement->filesize, 'Updated file size matches uploaded file.');
+    $this->assertEqual(file_get_contents($replacement->uri), file_get_contents($file->uri), 'Updated file contents matches uploaded file.');
+
+    // Get an image file.
+    $image = reset($this->files['image']);
+    $edit['files[replace_upload]'] = drupal_realpath($image->uri);
+
+    // Test that validation works by uploading a non-text file as a replacement.
+    $this->drupalPost('file/' . $file->fid . '/edit', $edit, t('Save'));
+    $this->assertRaw(t('The specified file %file could not be uploaded. Only files with the following extensions are allowed:', array('%file' => $image->filename)), 'File validation works, upload failed correctly.');
+
+    // Create a non-local file record.
+    $file2 = new stdClass();
+    $file2->uri = 'oembed://' . $this->randomName();
+    $file2->filename = drupal_basename($file2->uri);
+    $file2->filemime = 'image/oembed';
+    $file2->type = 'image';
+    $file2->uid = 1;
+    $file2->timestamp = REQUEST_TIME;
+    $file2->filesize = 0;
+    $file2->status = 0;
+    // Write the record directly rather than calling file_save() so we don't
+    // invoke the hooks.
+    $this->assertTrue(drupal_write_record('file_managed', $file2), 'Non-local file was added to the database.');
+
+    // Test that Upload widget does not appear for non-local file.
+    $this->drupalGet('file/' . $file2->fid . '/edit');
+    $this->assertNoFieldByName('files[replace_upload]');
+  }
+}
+
+class FileEntityTokenTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity tokens',
+      'description' => 'Test the file entity tokens.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    parent::setUpFiles();
+  }
+
+  function testFileEntityTokens() {
+    $tokens = array(
+      'type' => 'Document',
+      'type:name' => 'Document',
+      'type:machine-name' => 'document',
+      'type:count' => count($this->files['text']),
+    );
+    $this->assertTokens('file', array('file' => $this->files['text'][0]), $tokens);
+
+    $tokens = array(
+      'type' => 'Image',
+      'type:name' => 'Image',
+      'type:machine-name' => 'image',
+      'type:count' => count($this->files['image']),
+    );
+    $this->assertTokens('file', array('file' => $this->files['image'][0]), $tokens);
+  }
+
+  function assertTokens($type, array $data, array $tokens, array $options = array()) {
+    $token_input = drupal_map_assoc(array_keys($tokens));
+    $values = token_generate($type, $token_input, $data, $options);
+    foreach ($tokens as $token => $expected) {
+      if (!isset($expected)) {
+        $this->assertTrue(!isset($values[$token]), t("Token value for [@type:@token] was not generated.", array('@type' => $type, '@token' => $token)));
+      }
+      elseif (!isset($values[$token])) {
+        $this->fail(t("Token value for [@type:@token] was not generated.", array('@type' => $type, '@token' => $token)));
+      }
+      elseif (!empty($options['regex'])) {
+        $this->assertTrue(preg_match('/^' . $expected . '$/', $values[$token]), t("Token value for [@type:@token] was '@actual', matching regular expression pattern '@expected'.", array('@type' => $type, '@token' => $token, '@actual' => $values[$token], '@expected' => $expected)));
+      }
+      else {
+        $this->assertIdentical($values[$token], $expected, t("Token value for [@type:@token] was '@actual', expected value '@expected'.", array('@type' => $type, '@token' => $token, '@actual' => $values[$token], '@expected' => $expected)));
+      }
+    }
+
+    return $values;
+  }
+}
+
+class FileEntityTypeTestCase extends FileEntityTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity types',
+      'description' => 'Test the file entity types.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    parent::setUpFiles();
+  }
+
+  /**
+   * Test admin pages access and functionality.
+   */
+  function testAdminPages() {
+    // Create a user with file type administration access.
+    $user = $this->drupalCreateUser(array('administer file types'));
+    $this->drupalLogin($user);
+
+    $this->drupalGet('admin/structure/file-types');
+    $this->assertResponse(200, 'File types admin page is accessible');
+  }
+
+  /**
+   * Test creating a new type. Basic CRUD.
+   */
+  function testCreate() {
+    $type_machine_type = 'foo';
+    $type_machine_label = 'foobar';
+    $type = $this->createFileType(array('type' => $type_machine_type, 'label' => $type_machine_label));
+    $loaded_type = file_type_load($type_machine_type);
+    $this->assertEqual($loaded_type->label, $type_machine_label, "Was able to create a type and retreive it.");
+  }
+
+
+  /**
+   * Ensures that the weight is respected when types are created.
+   * @return unknown_type
+   */
+  function testOrder() {
+//    $type = $this->createFileType(array('name' => 'last', 'label' => 'Last', 'weight' => 100));
+//    $type = $this->createFileType(array('name' => 'first', 'label' => 'First'));
+//    $types = media_type_get_types();
+//    $keys = array_keys($types);
+//    $this->assertTrue(isset($types['last']) && isset($types['first']), "Both types saved");
+//    $this->assertTrue(array_search('last', $keys) > array_search('first', $keys), 'Type which was supposed to be first came first');
+  }
+
+  /**
+   * Test view mode assignment.  Currently fails, don't know why.
+   * @return unknown_type
+   */
+  function testViewModesAssigned() {
+  }
+
+  /**
+   * Make sure candidates are presented in the case of multiple
+   * file types.
+   */
+  function testTypeWithCandidates() {
+    // Create multiple file types with the same mime types.
+    $types = array(
+      'image1' => $this->createFileType(array('type' => 'image1', 'label' => 'Image 1')),
+      'image2' => $this->createFileType(array('type' => 'image2', 'label' => 'Image 2'))
+    );
+
+    // Attach a text field to one of the file types.
+    $field = array(
+      'field_name' => drupal_strtolower($this->randomName()),
+      'type' => 'text',
+      'settings' => array(
+        'max_length' => 255,
+      )
+    );
+    field_create_field($field);
+    $instance = array(
+      'field_name' => $field['field_name'],
+      'entity_type' => 'file',
+      'bundle' => 'image2',
+      'widget' => array(
+        'type' => 'text_textfield',
+      ),
+      'display' => array(
+        'default' => array(
+          'type' => 'text_default',
+        ),
+      ),
+    );
+    field_create_instance($instance);
+
+    // Create a user with file creation access.
+    $user = $this->drupalCreateUser(array('create files'));
+    $this->drupalLogin($user);
+
+    // Step 1: Upload file
+    $file = reset($this->files['image']);
+    $edit = array();
+    $edit['files[upload]'] = drupal_realpath($file->uri);
+    $this->drupalPost('file/add', $edit, t('Next'));
+
+    // Step 2: Select file type candidate
+    $this->assertText('Image 1', 'File type candidate list item found.');
+    $this->assertText('Image 2', 'File type candidate list item found.');
+    $edit = array();
+    $edit['type'] = 'image2';
+    $this->drupalPost(NULL, $edit, t('Next'));
+
+    // Step 3: Select file scheme candidate
+    $this->assertText('Public local files served by the webserver.', 'File scheme candidate list item found.');
+    $this->assertText('Private local files served by Drupal.', 'File scheme candidate list item found.');
+    $edit = array();
+    $edit['scheme'] = 'public';
+    $this->drupalPost(NULL, $edit, t('Next'));
+
+    // Step 4: Complete field widgets
+    $langcode = LANGUAGE_NONE;
+    $edit = array();
+    $edit["{$field['field_name']}[$langcode][0][value]"] = $this->randomName();
+    $this->drupalPost(NULL, $edit, t('Save'));
+    $this->assertRaw(t('!type %name was uploaded.', array('!type' => 'Image 2', '%name' => $file->filename)), t('Image 2 file updated.'));
+    $this->assertText($field['field_name'], 'File text field was found.');
+  }
+
+  /**
+   * Make sure no candidates appear when only one mime type is available.
+   * NOTE: Depends on file_entity.module default 'image' type.
+   */
+  function testTypeWithoutCandidates() {
+    // Attach a text field to the default image file type.
+    $field = array(
+      'field_name' => drupal_strtolower($this->randomName()),
+      'type' => 'text',
+      'settings' => array(
+        'max_length' => 255,
+      )
+    );
+    field_create_field($field);
+    $instance = array(
+      'field_name' => $field['field_name'],
+      'entity_type' => 'file',
+      'bundle' => 'image',
+      'widget' => array(
+        'type' => 'text_textfield',
+      ),
+      'display' => array(
+        'default' => array(
+          'type' => 'text_default',
+        ),
+      ),
+    );
+    field_create_instance($instance);
+
+    // Create a user with file creation access.
+    $user = $this->drupalCreateUser(array('create files'));
+    $this->drupalLogin($user);
+
+    // Step 1: Upload file
+    $file = reset($this->files['image']);
+    $edit = array();
+    $edit['files[upload]'] = drupal_realpath($file->uri);
+    $this->drupalPost('file/add', $edit, t('Next'));
+
+    // Step 2: Scheme selection
+    if ($this->xpath('//input[@name="scheme"]')) {
+      $this->drupalPost(NULL, array(), t('Next'));
+    }
+
+    // Step 3: Complete field widgets
+    $langcode = LANGUAGE_NONE;
+    $edit = array();
+    $edit["{$field['field_name']}[$langcode][0][value]"] = $this->randomName();
+    $this->drupalPost(NULL, $edit, t('Save'));
+    $this->assertRaw(t('!type %name was uploaded.', array('!type' => 'Image', '%name' => $file->filename)), t('Image file uploaded.'));
+    $this->assertText($field['field_name'], 'File text field was found.');
+  }
+
+  /**
+   * Test file types CRUD UI.
+   */
+  function testTypesCrudUi() {
+    $this->drupalGet('admin/structure/file-types');
+    $this->assertResponse(403, 'File types UI page is not accessible to unauthorized users.');
+
+    $user = $this->drupalCreateUser(array('administer file types'));
+    $this->drupalLogin($user);
+
+    $this->drupalGet('admin/structure/file-types');
+    $this->assertResponse(200, 'File types UI page is accessible to users with adequate permission.');
+
+    // Create new file type.
+    $edit = array(
+      'label' => t('Test type'),
+      'type' => 'test_type',
+      'description' => t('This is dummy file type used just for testing.'),
+      'mimetypes' => 'image/png',
+    );
+    $this->drupalGet('admin/structure/file-types/add');
+    $this->drupalPost(NULL, $edit, t('Save'));
+    $this->assertText(t('The file type @type has been updated.', array('@type' => $edit['label'])), 'New file type successfully created.');
+    $this->assertText($edit['label'], 'New file type created: label found.');
+    $this->assertText($edit['description'], 'New file type created: description found.');
+    $this->assertFieldByXPath("//table//tr[1]//td[7]", t('Normal'), 'Newly created file type is stored in DB.');
+    $this->assertLink(t('disable'), 0, 'Able to disable newly created file type.');
+    $this->assertLink(t('delete'), 0, 'Able to delete newly created file type.');
+    $this->assertLinkByHref('admin/structure/file-types/manage/' . $edit['type'] . '/disable', 0, 'Disable link points to disable confirmation page.');
+    $this->assertLinkByHref('admin/structure/file-types/manage/' . $edit['type'] . '/delete', 0, 'Delete link points to delete confirmation page.');
+
+    // Edit file type.
+    $this->drupalGet('admin/structure/file-types/manage/' . $edit['type'] . '/edit');
+    $this->assertRaw(t('Save'), 'Save button found on edit page.');
+    $this->assertRaw(t('Delete'), 'Delete button found on edit page.');
+    $this->assertRaw($edit['label'], 'Label found on file type edit page');
+    $this->assertText($edit['description'], 'Description found on file type edit page');
+    $this->assertText($edit['mimetypes'], 'Mime-type configuration found on file type edit page');
+    $this->assertText(t('Mimetype List'), 'Mimetype list present on edit form.');
+
+    // Modify file type.
+    $edit['label'] = t('New type label');
+    $this->drupalPost(NULL, array('label' => $edit['label']), t('Save'));
+    $this->assertText(t('The file type @type has been updated.', array('@type' => $edit['label'])), 'File type was modified.');
+    $this->assertText($edit['label'], 'Modified label found on file types list.');
+
+    // Disable and re-enable file type.
+    $this->drupalGet('admin/structure/file-types/manage/' . $edit['type'] . '/disable');
+    $this->assertText(t('Are you sure you want to disable the file type @type?', array('@type' => $edit['label'])), 'Disable confirmation page found.');
+    $this->drupalPost(NULL, array(), t('Disable'));
+    $this->assertText(t('The file type @type has been disabled.', array('@type' => $edit['label'])), 'Disable confirmation message found.');
+    $this->assertFieldByXPath("//table//tr[5]//td[1]", $edit['label'], 'Disabled type moved to the tail of the list.');
+    $this->assertLink(t('enable'), 0, 'Able to re-enable newly created file type.');
+    $this->assertLinkByHref('admin/structure/file-types/manage/' . $edit['type'] . '/enable', 0, 'Enable link points to enable confirmation page.');
+    $this->drupalGet('admin/structure/file-types/manage/' . $edit['type'] . '/enable');
+    $this->assertText(t('Are you sure you want to enable the file type @type?', array('@type' => $edit['label'])), 'Enable confirmation page found.');
+    $this->drupalPost(NULL, array(), t('Enable'));
+    $this->assertText(t('The file type @type has been enabled.', array('@type' => $edit['label'])), 'Enable confirmation message found.');
+    $this->assertFieldByXPath("//table//tr[1]//td[1]", $edit['label'], 'Enabled type moved to the top of the list.');
+
+    // Delete newly created type.
+    $this->drupalGet('admin/structure/file-types/manage/' . $edit['type'] . '/delete');
+    $this->assertText(t('Are you sure you want to delete the file type @type?', array('@type' => $edit['label'])), 'Delete confirmation page found.');
+    $this->drupalPost(NULL, array(), t('Delete'));
+    $this->assertText(t('The file type @type has been deleted.', array('@type' => $edit['label'])), 'Delete confirmation message found.');
+    $this->drupalGet('admin/structure/file-types');
+    $this->assertNoText($edit['label'], 'File type successfully deleted.');
+
+    // Edit exported file type.
+    $this->drupalGet('admin/structure/file-types/manage/image/edit');
+    $this->assertRaw(t('Image'), 'Label found on file type edit page');
+    $this->assertText("image/*", 'Mime-type configuration found on file type edit page');
+    $this->drupalPost(NULL, array('label' => t('Funky images')), t('Save'));
+    $this->assertText(t('The file type @type has been updated.', array('@type' => t('Funky images'))), 'File type was modified.');
+    $this->assertText(t('Funky image'), 'Modified label found on file types list.');
+    $this->assertFieldByXPath("//table//tr[1]//td[7]", t('Overridden'), 'Modified type overrides configuration from code.');
+    $this->assertLink(t('revert'), 0, 'Able to revert overridden file type.');
+    $this->assertLinkByHref('admin/structure/file-types/manage/image/revert', 0, 'Revert link points to revert confirmation page.');
+
+    // Revert file type.
+    $this->drupalGet('admin/structure/file-types/manage/image/revert');
+    $this->assertText(t('Are you sure you want to revert the file type @type?', array('@type' => t('Funky images'))), 'Revert confirmation page found.');
+    $this->drupalPost(NULL, array(), t('Revert'));
+    $this->assertText(t('The file type @type has been reverted.', array('@type' => t('Funky images'))), 'Revert confirmation message found.');
+    $this->assertText(t('Image'), 'Reverted file type found in list.');
+    $this->assertFieldByXPath("//table//tr[1]//td[7]", t('Default'), 'Reverted file type shows correct state.');
+  }
+}
+
+class FileEntityAccessTestCase extends FileEntityTestHelper {
+
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity access',
+      'description' => 'Test the access aspects of file entity.',
+      'group' => 'File entity',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    parent::setUpFiles();
+  }
+
+  /**
+   * Asserts file_entity_access correctly grants or denies access.
+   */
+  function assertFileEntityAccess($ops, $file, $account) {
+    foreach ($ops as $op => $result) {
+      $msg = t("file_entity_access returns @result with operation '@op'.", array('@result' => $result ? 'true' : 'false', '@op' => $op));
+      $this->assertEqual($result, file_entity_access($op, $file, $account), $msg);
+    }
+  }
+
+  /**
+   * Runs basic tests for file_entity_access function.
+   */
+  function testFileEntityAccess() {
+    $file = reset($this->files['image']);
+
+    // Ensures user with 'bypass file access' permission can do everything.
+    $web_user = $this->drupalCreateUser(array('bypass file access'));
+    $this->assertFileEntityAccess(array('create' => TRUE), NULL, $web_user);
+    $this->assertFileEntityAccess(array('view' => TRUE, 'download' => TRUE, 'update' => TRUE, 'delete' => TRUE), $file, $web_user);
+
+    // A user with 'administer files' should not access CRUD operations.
+    $web_user = $this->drupalCreateUser(array('administer files'));
+    $this->assertFileEntityAccess(array('view' => FALSE, 'download' => FALSE, 'update' => FALSE, 'delete' => FALSE), $file, $web_user);
+
+    // User cannot 'view files'.
+    $web_user = $this->drupalCreateUser(array('create files'));
+    $this->assertFileEntityAccess(array('view' => FALSE), $file, $web_user);
+    // But can upload new ones.
+    $this->assertFileEntityAccess(array('create' => TRUE), NULL, $web_user);
+
+    // User can view own files but no other files.
+    $web_user = $this->drupalCreateUser(array('create files', 'view own files'));
+    $this->assertFileEntityAccess(array('view' => FALSE), $file, $web_user);
+    $file->uid = $web_user->uid;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+    $this->assertFileEntityAccess(array('view' => TRUE), $file, $web_user);
+
+    // User can download own files but no other files.
+    $web_user = $this->drupalCreateUser(array('create files', 'download own image files'));
+    $this->assertFileEntityAccess(array('download' => FALSE), $file, $web_user);
+    $file->uid = $web_user->uid;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+    $this->assertFileEntityAccess(array('download' => TRUE), $file, $web_user);
+
+    // User can update own files but no other files.
+    $web_user = $this->drupalCreateUser(array('create files', 'view own files', 'edit own image files'));
+    $this->assertFileEntityAccess(array('update' => FALSE), $file, $web_user);
+    $file->uid = $web_user->uid;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+    $this->assertFileEntityAccess(array('update' => TRUE), $file, $web_user);
+
+    // User can delete own files but no other files.
+    $web_user = $this->drupalCreateUser(array('create files', 'view own files', 'edit own image files', 'delete own image files'));
+    $this->assertFileEntityAccess(array('delete' => FALSE), $file, $web_user);
+    $file->uid = $web_user->uid;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+    $this->assertFileEntityAccess(array('delete' => TRUE), $file, $web_user);
+
+    // User can view any file.
+    $web_user = $this->drupalCreateUser(array('create files', 'view files'));
+    $this->assertFileEntityAccess(array('view' => TRUE), $file, $web_user);
+
+    // User can download any file.
+    $web_user = $this->drupalCreateUser(array('create files', 'download any image files'));
+    $this->assertFileEntityAccess(array('download' => TRUE), $file, $web_user);
+
+    // User can edit any file.
+    $web_user = $this->drupalCreateUser(array('create files', 'view files', 'edit any image files'));
+    $this->assertFileEntityAccess(array('update' => TRUE), $file, $web_user);
+
+    // User can delete any file.
+    $web_user = $this->drupalCreateUser(array('create files', 'view files', 'edit any image files', 'delete any image files'));
+    $this->assertFileEntityAccess(array('delete' => TRUE), $file, $web_user);
+  }
+
+  /**
+   * Test to see if we have access to view files when granted the permissions.
+   * In this test we aim to prove the permissions work in the following pages:
+   *  file/add
+   *  file/%/view
+   *  file/%/download
+   *  file/%/edit
+   *  file/%/delete
+   */
+  function testFileEntityPageAccess() {
+    $web_user = $this->drupalCreateUser(array());
+    $this->drupalLogin($web_user);
+    $this->drupalGet('file/add');
+    $this->assertResponse(403, 'Users without access can not access the file add page');
+    $web_user = $this->drupalCreateUser(array('create files'));
+    $this->drupalLogin($web_user);
+    $this->drupalGet('file/add');
+    $this->assertResponse(200, 'Users with access can access the file add page');
+
+    $file = reset($this->files['text']);
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+
+    // This fails.. No clue why but, tested manually and works as should.
+    //$web_user = $this->drupalCreateUser(array('view own files'));
+    //$this->drupalLogin($web_user);
+    //$this->drupalGet("file/{$file->fid}/view");
+    //$this->assertResponse(403, 'Users without access can not access the file view page');
+    $web_user = $this->drupalCreateUser(array('view files'));
+    $this->drupalLogin($web_user);
+    $this->drupalGet("file/{$file->fid}/view");
+    $this->assertResponse(200, 'Users with access can access the file view page');
+
+    $url = "file/{$file->fid}/download";
+    $web_user = $this->drupalCreateUser(array());
+    $this->drupalLogin($web_user);
+    $this->drupalGet($url, array('query' => array('token' => $this->drupalGetToken($url))));
+    $this->assertResponse(403, 'Users without access can not download the file');
+    $web_user = $this->drupalCreateUser(array('download any document files'));
+    $this->drupalLogin($web_user);
+    $this->drupalGet($url, array('query' => array('token' => $this->drupalGetToken($url))));
+    $this->assertResponse(200, 'Users with access can download the file');
+    $this->drupalGet($url, array('query' => array('token' => 'invalid-token')));
+    $this->assertResponse(403, 'Cannot download file with in invalid token.');
+    $this->drupalGet($url);
+    $this->assertResponse(403, 'Cannot download file without a token.');
+
+    $web_user = $this->drupalCreateUser(array());
+    $this->drupalLogin($web_user);
+    $this->drupalGet("file/{$file->fid}/edit");
+    $this->assertResponse(403, 'Users without access can not access the file edit page');
+    $web_user = $this->drupalCreateUser(array('edit any document files'));
+    $this->drupalLogin($web_user);
+    $this->drupalGet("file/{$file->fid}/edit");
+    $this->assertResponse(200, 'Users with access can access the file add page');
+
+    $web_user = $this->drupalCreateUser(array());
+    $this->drupalLogin($web_user);
+    $this->drupalGet("file/{$file->fid}/delete");
+    $this->assertResponse(403, 'Users without access can not access the file view page');
+    $web_user = $this->drupalCreateUser(array('delete any document files'));
+    $this->drupalLogin($web_user);
+    $this->drupalGet("file/{$file->fid}/delete");
+    $this->assertResponse(200, 'Users with access can access the file add page');
+  }
+
+  /**
+   * Test to see if we have access to download private files when granted the permissions.
+   */
+  function testFileEntityPrivateDownloadAccess() {
+    foreach ($this->getPrivateDownloadAccessCases() as $case) {
+      // Create users and login only if non-anonymous.
+      $authenticated_user = !is_null($case['permissions']);
+      if ($authenticated_user) {
+        $account = $this->drupalCreateUser($case['permissions']);
+        $this->drupalLogin($account);
+      }
+
+      // Create private, permanent files owned by this user only he's an owner.
+      if (!empty($case['owner'])) {
+        $file = next($this->files['text']);
+        $file->status = FILE_STATUS_PERMANENT;
+        $file->uid = $account->uid;
+        file_save($file);
+        $file = file_move($file, 'private://');
+
+        // Check if the physical file is there.
+        $arguments = array('%name' => $file->filename, '%username' => $account->name, '%uri' => $file->uri);
+        $this->assertTrue(is_file($file->uri), format_string('File %name owned by %username successfully created at %uri.', $arguments));
+        $url = file_create_url($file->uri);
+        $message_file_info = ' ' . format_string('File %uri was checked.', array('%uri' => $file->uri));
+      }
+
+      // Try to download the file.
+      $this->drupalGet($url);
+      $this->assertResponse($case['expect'], $case['message'] . $message_file_info);
+
+      // Logout authenticated users.
+      if ($authenticated_user) {
+        $this->drupalLogout();
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.theme.inc b/profiles/commons/modules/contrib/file_entity/file_entity.theme.inc
new file mode 100644
index 0000000..123b83e
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.theme.inc
@@ -0,0 +1,160 @@
+<?php
+
+/**
+ * @file
+ * Theme callbacks for the file entity module.
+ */
+
+/**
+ * Copy of theme_file_file_link() for linking to the view file page.
+ *
+ * @see theme_file_file_link()
+ */
+function theme_file_entity_file_link($variables) {
+  $file = $variables['file'];
+  $icon_directory = $variables['icon_directory'];
+
+  $url = 'file/' . $file->fid;
+  $icon = theme('file_icon', array('file' => $file, 'icon_directory' => $icon_directory));
+
+  // Set options as per anchor format described at
+  // http://microformats.org/wiki/file-format-examples
+  $options = array(
+    'attributes' => array(
+      'type' => $file->filemime . '; length=' . $file->filesize,
+    ),
+  );
+
+  // Use the description as the link text if available.
+  if (empty($file->description)) {
+    $link_text = $file->filename;
+  }
+  else {
+    $link_text = $file->description;
+    $options['attributes']['title'] = check_plain($file->filename);
+  }
+
+  return '<span class="file">' . $icon . ' ' . l($link_text, $url, $options) . '</span>';
+}
+
+/**
+ * Copy of theme_file_file_link() for linking to the file download URL.
+ *
+ * @see theme_file_file_link()
+ */
+function theme_file_entity_download_link($variables) {
+  $file = $variables['file'];
+  $icon_directory = $variables['icon_directory'];
+
+  $uri = file_entity_download_uri($file);
+  $icon = theme('file_icon', array('file' => $file, 'icon_directory' => $icon_directory));
+
+  // Set options as per anchor format described at
+  // http://microformats.org/wiki/file-format-examples
+  $uri['options']['attributes']['type'] = $file->filemime . '; length=' . $file->filesize;
+
+  // Provide the default link text.
+  if (!isset($variables['text'])) {
+    $variables['text'] = t('Download [file:name]');
+  }
+
+  // Peform unsanitized token replacement if $uri['options']['html'] is empty
+  // since then l() will escape the link text.
+  $variables['text'] = token_replace($variables['text'], array('file' => $file), array('clear' => TRUE, 'sanitize' => empty($uri['options']['html'])));
+
+  $output = '<span class="file">' . $icon . ' ' . l($variables['text'], $uri['path'], $uri['options']);
+  $output .= ' ' . '<span class="file-size">(' . format_size($file->filesize) . ')</span>';
+  $output .= '</span>';
+
+  return $output;
+}
+
+/**
+ * Returns HTML for displaying an HTML5 <audio> tag.
+ *
+ * @param array $variables
+ *   An associative array containing:
+ *   - file: Associative array of file data, which must include "uri".
+ *   - controls: Boolean indicating whether or not controls should be displayed.
+ *   - autoplay: Boolean indicating whether or not the audio should start
+ *     playing automatically.
+ *   - loop: Boolean indicating whether or not the audio should loop.
+ *
+ * @ingroup themeable
+ */
+function theme_file_entity_file_audio($variables) {
+  $files = $variables['files'];
+  $output = '';
+
+  $audio_attributes = array();
+  if ($variables['controls']) {
+    $audio_attributes['controls'] = 'controls';
+  }
+  if ($variables['autoplay']) {
+    $audio_attributes['autoplay'] = 'autoplay';
+  }
+  if ($variables['loop']) {
+    $audio_attributes['loop'] = 'loop';
+  }
+
+  $output .= '<audio' . drupal_attributes($audio_attributes) . '>';
+  foreach ($files as $delta => $file) {
+    $source_attributes = array(
+      'src' => file_create_url($file['uri']),
+      'type' => $file['filemime'],
+    );
+    $output .= '<source' . drupal_attributes($source_attributes) . ' />';
+  }
+  $output .= '</audio>';
+  return $output;
+}
+
+/**
+ * Returns HTML for displaying an HTML5 <video> tag.
+ *
+ * @param array $variables
+ *   An associative array containing:
+ *   - file: Associative array of file data, which must include "uri".
+ *   - controls: Boolean indicating whether or not controls should be displayed.
+ *   - autoplay: Boolean indicating whether or not the video should start
+ *     playing automatically.
+ *   - loop: Boolean indicating whether or not the video should loop.
+ *   - muted: Boolean indicating whether or not the sound should be muted.
+ *   - width: Width, in pixels, of the video player.
+ *   - height: Height, in pixels, of the video player.
+ *
+ * @ingroup themeable
+ */
+function theme_file_entity_file_video($variables) {
+  $files = $variables['files'];
+  $output = '';
+
+  $video_attributes = array();
+  if ($variables['controls']) {
+    $video_attributes['controls'] = 'controls';
+  }
+  if ($variables['autoplay']) {
+    $video_attributes['autoplay'] = 'autoplay';
+  }
+  if ($variables['loop']) {
+    $video_attributes['loop'] = 'loop';
+  }
+  if ($variables['muted']) {
+    $video_attributes['muted'] = 'muted';
+  }
+  if ($variables['width'] && $variables['height']) {
+    $video_attributes['width'] = $variables['width'];
+    $video_attributes['height'] = $variables['height'];
+  }
+
+  $output .= '<video' . drupal_attributes($video_attributes) . '>';
+  foreach ($files as $delta => $file) {
+    $source_attributes = array(
+      'src' => file_create_url($file['uri']),
+      'type' => $file['filemime'],
+    );
+    $output .= '<source' . drupal_attributes($source_attributes) . ' />';
+  }
+  $output .= '</video>';
+  return $output;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.tokens.inc b/profiles/commons/modules/contrib/file_entity/file_entity.tokens.inc
new file mode 100644
index 0000000..d3d1a30
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.tokens.inc
@@ -0,0 +1,133 @@
+<?php
+
+/**
+ * @file
+ * Token integration for the file_entity module.
+ */
+
+/**
+ * Implements hook_token_info().
+ */
+function file_entity_token_info() {
+  // File type tokens.
+  $info['types']['file-type'] = array(
+    'name' => t('File type'),
+    'description' => t('Tokens associated with file types.'),
+    'needs-data' => 'file_type',
+  );
+  $info['tokens']['file-type']['name'] = array(
+    'name' => t('Name'),
+    'description' => t('The name of the file type.'),
+  );
+  $info['tokens']['file-type']['machine-name'] = array(
+    'name' => t('Machine-readable name'),
+    'description' => t('The unique machine-readable name of the file type.'),
+  );
+  $info['tokens']['file-type']['count'] = array(
+    'name' => t('File count'),
+    'description' => t('The number of files belonging to the file type.'),
+  );
+  $info['tokens']['file-type']['edit-url'] = array(
+    'name' => t('Edit URL'),
+    'description' => t("The URL of the file type's edit page."),
+  );
+
+  // File tokens.
+  $info['tokens']['file']['type'] = array(
+    'name' => t('File type'),
+    'description' => t('The file type of the file.'),
+    'type' => 'file-type',
+  );
+  $info['tokens']['file']['download-url'] = array(
+    'name' => t('Download URL'),
+    'description' => t('The URL to download the file directly.'),
+    'type' => 'url',
+  );
+
+  return $info;
+}
+
+/**
+ * Implements hook_token_info_alter().
+ */
+function file_entity_token_info_alter(&$info) {
+  $info['tokens']['file']['name']['description'] = t('The name of the file.');
+}
+
+/**
+ * Implements hook_tokens().
+ */
+function file_entity_tokens($type, $tokens, array $data = array(), array $options = array()) {
+  $replacements = array();
+
+  $url_options = array('absolute' => TRUE);
+  if (isset($options['language'])) {
+    $url_options['language'] = $options['language'];
+    $language_code = $options['language']->language;
+  }
+  else {
+    $language_code = NULL;
+  }
+
+  $sanitize = !empty($options['sanitize']);
+
+  // File tokens.
+  if ($type == 'file' && !empty($data['file'])) {
+    $file = $data['file'];
+
+    foreach ($tokens as $name => $original) {
+      switch ($name) {
+        case 'type':
+          if ($file_type = file_type_load($file->type)) {
+            $replacements[$original] = $sanitize ? check_plain($file_type->label) : $file_type->label;
+          }
+          break;
+
+        case 'download-url':
+          $uri = file_entity_download_uri($file);
+          $replacements[$original] = url($uri['path'], $uri['options'] + $url_options);
+          break;
+      }
+    }
+
+    // Chained token relationships.
+    if (($file_type_tokens = token_find_with_prefix($tokens, 'type')) && $file_type = file_type_load($file->type)) {
+      $replacements += token_generate('file-type', $file_type_tokens, array('file_type' => $file_type), $options);
+    }
+    if ($download_url_tokens = token_find_with_prefix($tokens, 'download-url')) {
+      $replacements += token_generate('url', $download_url_tokens, file_entity_download_uri($file), $options);
+    }
+  }
+
+  // File type tokens.
+  if ($type == 'file-type' && !empty($data['file_type'])) {
+    $file_type = $data['file_type'];
+
+    foreach ($tokens as $name => $original) {
+      switch ($name) {
+        case 'name':
+          $replacements[$original] = $sanitize ? check_plain($file_type->label) : $file_type->label;
+          break;
+
+        case 'machine-name':
+          // This is a machine name so does not ever need to be sanitized.
+          $replacements[$original] = $file_type->type;
+          break;
+
+        case 'count':
+          $query = db_select('file_managed');
+          $query->condition('type', $file_type->type);
+          $query->addTag('file_type_file_count');
+          $count = $query->countQuery()->execute()->fetchField();
+          $replacements[$original] = (int) $count;
+          break;
+
+        case 'edit-url':
+          $replacements[$original] = url('admin/structure/file-types/manage/' . $file_type->type . '/fields', $url_options);
+          break;
+      }
+    }
+  }
+
+  return $replacements;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.tpl.php b/profiles/commons/modules/contrib/file_entity/file_entity.tpl.php
new file mode 100644
index 0000000..cc12db7
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.tpl.php
@@ -0,0 +1,95 @@
+<?php
+
+/**
+ * @file
+ * Default theme implementation to display a file.
+ *
+ * Available variables:
+ * - $label: the (sanitized) file name of the file.
+ * - $content: An array of file items. Use render($content) to print them all,
+ *   or print a subset such as render($content['field_example']). Use
+ *   hide($content['field_example']) to temporarily suppress the printing of a
+ *   given element.
+ * - $user_picture: The file owner's picture from user-picture.tpl.php.
+ * - $date: Formatted added date. Preprocess functions can reformat it by
+ *   calling format_date() with the desired parameters on the $timestamp
+ *   variable.
+ * - $name: Themed username of file owner output from theme_username().
+ * - $file_url: Direct URL of the current file.
+ * - $display_submitted: Whether submission information should be displayed.
+ * - $submitted: Submission information created from $name and $date during
+ *   template_preprocess_file().
+ * - $classes: String of classes that can be used to style contextually through
+ *   CSS. It can be manipulated through the variable $classes_array from
+ *   preprocess functions. The default values can be one or more of the
+ *   following:
+ *   - file-entity: The current template type, i.e., "theming hook".
+ *   - file-[type]: The current file type. For example, if the file is a
+ *     "Image" file it would result in "file-image". Note that the machine
+ *     name will often be in a short form of the human readable label.
+ *   - file-[mimetype]: The current file's MIME type. For exampe, if the file
+ *     is a PNG image, it would result in "file-image-png"
+ * - $title_prefix (array): An array containing additional output populated by
+ *   modules, intended to be displayed in front of the main title tag that
+ *   appears in the template.
+ * - $title_suffix (array): An array containing additional output populated by
+ *   modules, intended to be displayed after the main title tag that appears in
+ *   the template.
+ *
+ * Other variables:
+ * - $file: Full file object. Contains data that may not be safe.
+ * - $type: File type, i.e. image, audio, video, etc.
+ * - $uid: User ID of the file owner.
+ * - $timestamp: Time the file was added formatted in Unix timestamp.
+ * - $classes_array: Array of html class attribute values. It is flattened
+ *   into a string within the variable $classes.
+ * - $zebra: Outputs either "even" or "odd". Useful for zebra striping in
+ *   listings.
+ * - $id: Position of the file. Increments each time it's output.
+ *
+ * File status variables:
+ * - $view_mode: View mode, e.g. 'default', 'full', etc.
+ * - $page: Flag for the full page state.
+ * - $is_front: Flags true when presented in the front page.
+ * - $logged_in: Flags true when the current user is a logged-in member.
+ * - $is_admin: Flags true when the current user is an administrator.
+ *
+ * Field variables: for each field instance attached to the file a corresponding
+ * variable is defined, e.g. $file->caption becomes $caption. When needing to
+ * access a field's raw values, developers/themers are strongly encouraged to
+ * use these variables. Otherwise they will have to explicitly specify the
+ * desired field language, e.g. $file->caption['en'], thus overriding any
+ * language negotiation rule that was previously applied.
+ *
+ * @see template_preprocess()
+ * @see template_preprocess_file_entity()
+ * @see template_process()
+ *
+ * @ingroup themeable
+ */
+?>
+<div id="<?php print $id; ?>" class="<?php print $classes ?>"<?php print $attributes; ?>>
+
+  <?php print render($title_prefix); ?>
+  <?php if (!$page): ?>
+    <h2<?php print $title_attributes; ?>><a href="<?php print $file_url; ?>"><?php print $label; ?></a></h2>
+  <?php endif; ?>
+  <?php print render($title_suffix); ?>
+
+  <?php if ($display_submitted): ?>
+    <div class="submitted">
+      <?php print $submitted; ?>
+    </div>
+  <?php endif; ?>
+
+  <div class="content"<?php print $content_attributes; ?>>
+    <?php
+      // We hide the links now so that we can render them later.
+      hide($content['links']);
+      print render($content);
+    ?>
+  </div>
+
+  <?php print render($content['links']); ?>
+
+</div>
diff --git a/profiles/commons/modules/contrib/file_entity/file_entity.views.inc b/profiles/commons/modules/contrib/file_entity/file_entity.views.inc
new file mode 100644
index 0000000..ea8b5a1
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/file_entity.views.inc
@@ -0,0 +1,150 @@
+<?php
+
+/**
+ * @file
+ * Views integration for the file_entity module.
+ */
+
+/**
+ * Implements hook_views_data().
+ */
+function file_entity_views_data() {
+  // File type.
+  $data['file_managed']['type'] = array(
+    'title' => t('Type'),
+    'help' => t('The type of the file (for example, "audio", "image", "video", etc).'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_type',
+      'click sortable' => TRUE,
+    ),
+    'sort' => array(
+      'handler' => 'views_handler_sort',
+    ),
+    'filter' => array(
+      'handler' => 'views_handler_filter_file_type',
+    ),
+    'argument' => array(
+      'handler' => 'views_handler_argument_file_type',
+    ),
+  );
+  // Rendered file.
+  $data['file_managed']['rendered'] = array(
+    'title' => t('Rendered'),
+    'help' => t('Display the file in a specific view mode.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_rendered',
+      'click sortable' => TRUE,
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  // View link.
+  $data['file_managed']['link'] = array(
+    'title' => t('Link'),
+    'help' => t('Provide a simple link to the file entity.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_link',
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  // Edit link.
+  $data['file_managed']['edit'] = array(
+    'title' => t('Edit link'),
+    'help' => t('Provide a simple link to edit the file entity.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_link_edit',
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  // Delete link.
+  $data['file_managed']['delete'] = array(
+    'title' => t('Delete link'),
+    'help' => t('Provide a simple link to delete the file entity.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_link_delete',
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  // Download link.
+  $data['file_managed']['download'] = array(
+    'title' => t('Download link'),
+    'help' => t('Provide a simple link to download the file entity.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_link_download',
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  // Usage link.
+  $data['file_managed']['usage'] = array(
+    'title' => t('Usage link'),
+    'help' => t('Provide a simple link to view the usage of the file entity.'),
+    'field' => array(
+      'handler' => 'views_handler_field_file_link_usage',
+      'real field' => 'fid',
+      'additional fields' => array(
+        'fid',
+      ),
+    ),
+  );
+
+  return $data;
+}
+
+/**
+ * Implements hook_views_data_alter().
+ */
+function file_entity_views_data_alter(&$data) {
+  // Add access tag for all queries against file_managed.
+  $data['file_managed']['table']['base']['access query tag'] = 'file_access';
+  // Override the filename field handler.
+  $data['file_managed']['filename']['field']['handler'] = 'views_handler_field_file_filename';
+}
+
+/**
+ * Implements hook_views_plugins().
+ */
+function file_entity_views_plugins() {
+  return array(
+    'module' => 'views', // This just tells our themes are elsewhere.
+    'row' => array(
+      'file' => array(
+        'title' => t('File'),
+        'help' => t('Display the file with standard file view.'),
+        'handler' => 'views_plugin_row_file_view',
+        'base' => array('file_managed'), // only works with 'file' as base.
+        'uses options' => TRUE,
+        'type' => 'normal',
+        'help topic' => 'style-file',
+      ),
+      'file_rss' => array(
+        'title' => t('File'),
+        'help' => t('Display the file with standard file view.'),
+        'handler' => 'views_plugin_row_file_rss',
+        'theme' => 'views_view_row_rss',
+        'base' => array('file_managed'), // only works with 'file' as base.
+        'uses options' => TRUE,
+        'type' => 'feed',
+        'help topic' => 'style-file-rss',
+      ),
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_content.inc b/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_content.inc
new file mode 100644
index 0000000..7895307
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_content.inc
@@ -0,0 +1,92 @@
+<?php
+
+/**
+ * Plugins are described by creating a $plugin array which will be used
+ * by the system that includes this file.
+ */
+$plugin = array(
+  'single' => TRUE,
+  'title' => t('File content'),
+  'description' => t('Display a full file with a view mode.'),
+  'required context' => new ctools_context_required(t('File'), 'entity:file'),
+  'category' => t('File'),
+  'defaults' => array(
+    'link' => FALSE,
+    'view_mode' => 'teaser',
+  ),
+);
+
+/**
+ * Render the node content.
+ */
+function file_entity_file_content_content_type_render($subtype, $conf, $panel_args, $context) {
+  if (!empty($context) && empty($context->data)) {
+    return;
+  }
+
+  $file = isset($context->data) ? clone($context->data) : NULL;
+  $block = new stdClass();
+  $block->module = 'file_entity';
+  $block->delta  = $file->fid;
+
+  if (empty($file)) {
+    $block->delta   = 'placeholder';
+    $block->title = t('File title.');
+    $block->content = t('File content goes here.');
+  }
+  else {
+    if (!empty($conf['identifier'])) {
+      $node->ctools_template_identifier = $conf['identifier'];
+    }
+
+    $block->title = $file->filename;
+    $block->content = file_build_content($file, $conf['view_mode']);
+  }
+
+  if (!empty($conf['link']) && $file) {
+    $block->title_link = entity_uri('file', $file);
+  }
+
+  return $block;
+}
+
+/**
+ * Returns an edit form for this plugin.
+ */
+function file_entity_file_content_content_type_edit_form($form, &$form_state) {
+  $conf = $form_state['conf'];
+
+  $form['link'] = array(
+    '#title' => t('Link title to file'),
+    '#type' => 'checkbox',
+    '#default_value' => $conf['link'],
+    '#description' => t('Check this to make the title link to the file.'),
+  );
+
+  $entity_info = entity_get_info('file');
+  $build_mode_options = array();
+  foreach ($entity_info['view modes'] as $mode => $option) {
+    $build_mode_options[$mode] = $option['label'];
+  }
+
+  $form['view_mode'] = array(
+    '#title' => t('View mode'),
+    '#type' => 'select',
+    '#description' => t('Select a view mode for this node.'),
+    '#options' => $build_mode_options,
+    '#default_value' => $conf['view_mode'],
+  );
+
+  return $form;
+}
+
+function file_entity_file_content_content_type_edit_form_submit($form, &$form_state) {
+  // Copy everything from our defaults.
+  foreach (array_keys($form_state['plugin']['defaults']) as $key) {
+    $form_state['conf'][$key] = $form_state['values'][$key];
+  }
+}
+
+function file_entity_file_content_content_type_admin_title($subtype, $conf, $context) {
+  return t('"@s" content', array('@s' => $context->identifier));
+}
diff --git a/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_display.inc b/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_display.inc
new file mode 100644
index 0000000..8133a3b
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/plugins/content_types/file_display.inc
@@ -0,0 +1,142 @@
+<?php
+
+/**
+ * Plugins are described by creating a $plugin array which will be used
+ * by the system that includes this file.
+ */
+$plugin = array(
+  'single' => TRUE,
+  'title' => t('File display'),
+  'description' => t('Displays the file with a configurable style.'),
+  'required context' => new ctools_context_required(t('File'), 'entity:file'),
+  'category' => t('File'),
+  'defaults' => array(
+    'displays' => array(),
+  ),
+);
+
+/**
+ * Render the node content.
+ */
+function file_entity_file_display_content_type_render($subtype, $conf, $panel_args, $context) {
+  if (!empty($context) && empty($context->data)) {
+    return;
+  }
+  $file = isset($context->data) ? clone($context->data) : NULL;
+  $block = new stdClass();
+  $block->module = 'file_entity';
+  $block->delta  = $file->fid;
+
+  if (empty($file)) {
+    $block->delta   = 'placeholder';
+    $block->title = t('File display');
+    $block->content = t('File display goes here.');
+  }
+  else {
+    if (!empty($conf['identifier'])) {
+      $file->ctools_template_identifier = $conf['identifier'];
+    }
+
+    $block->title = $file->filename;
+    $block->content = file_view_file($file, $conf['displays']);
+  }
+
+  if (!empty($conf['link']) && $file) {
+    $block->title_link = entity_uri('file', $file);
+  }
+
+  return $block;
+}
+
+/**
+ * Edit form for this plugin.
+ */
+function file_entity_file_display_content_type_edit_form($form, &$form_state) {
+  $conf = $form_state['conf'];
+  $form['#tree'] = TRUE;
+  $form['#attached']['js'][] = drupal_get_path('module', 'file_entity') . '/file_entity.admin.js';
+
+  // Retrieve available formatters for this file. We can load all file types
+  // since we don't know which type the file is at this point.
+  $formatters = file_info_formatter_types();
+
+  // Formatter status.
+  $form['displays']['status'] = array(
+    '#type' => 'item',
+    '#title' => t('Enabled displays'),
+    '#prefix' => '<div id="file-displays-status-wrapper">',
+    '#suffix' => '</div>',
+  );
+  $i=0;
+  foreach ($formatters as $name => $formatter) {
+    $form['displays']['status'][$name] = array(
+      '#type' => 'checkbox',
+      '#title' => check_plain($formatter['label']),
+      '#default_value' => !empty($conf['displays'][$name]['status']),
+      '#description' => isset($formatter['description']) ? filter_xss($formatter['description']) : NULL,
+      '#parents' => array('displays', $name, 'status'),
+      '#weight' => (isset($formatter['weight']) ? $formatter['weight'] : 0) + ($i / 1000),
+    );
+    $i++;
+  }
+  // Formatter order (tabledrag).
+  $form['displays']['order'] = array(
+    '#type' => 'item',
+    '#title' => t('Display precedence order'),
+    '#theme' => 'file_entity_file_display_order',
+  );
+  foreach ($formatters as $name => $formatter) {
+    $form['displays']['order'][$name]['label'] = array(
+      '#markup' => check_plain($formatter['label']),
+    );
+    $form['displays']['order'][$name]['weight'] = array(
+      '#type' => 'weight',
+      '#title' => t('Weight for @title', array('@title' => $formatter['label'])),
+      '#title_display' => 'invisible',
+      '#delta' => 50,
+      '#default_value' => isset($conf['displays'][$name]['weight']) ? $conf['displays'][$name]['weight'] : 0,
+      '#parents' => array('displays', $name, 'weight'),
+    );
+    $form['displays']['order'][$name]['#weight'] = $form['displays']['order'][$name]['weight']['#default_value'];
+  }
+
+  // Formatter settings.
+  $form['display_settings_title'] = array(
+    '#type' => 'item',
+    '#title' => t('Display settings'),
+  );
+  $form['display_settings'] = array(
+    '#type' => 'vertical_tabs',
+  );
+  $i=0;
+  foreach ($formatters as $name => $formatter) {
+    if (isset($formatter['settings callback']) && ($function = $formatter['settings callback']) && function_exists($function)) {
+      $defaults = !empty($formatter['default settings']) ? $formatter['default settings'] : array();
+      $settings = !empty($conf['displays'][$name]['settings']) ? $conf['displays'][$name]['settings'] : array();
+      $settings += $defaults;
+      $settings_form = $function($form, $form_state, $settings, $name, $file_type, $view_mode);
+      if (!empty($settings_form)) {
+        $form['displays']['settings'][$name] = array(
+          '#type' => 'fieldset',
+          '#title' => check_plain($formatter['label']),
+          '#parents' => array('displays', $name, 'settings'),
+          '#group' => 'display_settings',
+          '#weight' => (isset($formatter['weight']) ? $formatter['weight'] : 0) + ($i / 1000),
+        ) + $settings_form;
+      }
+    }
+    $i++;
+  }
+  return $form;
+}
+
+function file_entity_file_display_content_type_edit_form_submit($form, &$form_state) {
+  // Copy everything from our defaults.
+  foreach (array_keys($form_state['plugin']['defaults']) as $key) {
+    $form_state['conf'][$key] = $form_state['values'][$key];
+  }
+}
+
+function file_entity_file_display_content_type_admin_title($subtype, $conf, $context) {
+  return t('"@s" content', array('@s' => $context->identifier));
+}
diff --git a/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.info b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.info
new file mode 100644
index 0000000..39040fb
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.info
@@ -0,0 +1,13 @@
+name = "File Entity Test"
+description = "Support module for File Entity tests."
+package = Testing
+core = 7.x
+dependencies[] = file_entity
+hidden = TRUE
+
+; Information added by drupal.org packaging script on 2013-10-25
+version = "7.x-2.0-alpha3"
+core = "7.x"
+project = "file_entity"
+datestamp = "1382744726"
+
diff --git a/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.module b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.module
new file mode 100644
index 0000000..c6b1dfd
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.module
@@ -0,0 +1,15 @@
+<?php
+
+/**
+ * @file
+ * File Entity Test
+ */
+
+/**
+ * Implements hook_menu().
+ */
+function file_entity_test_menu() {
+  $items = array();
+
+  return $items;
+}
diff --git a/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.pages.inc b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.pages.inc
new file mode 100644
index 0000000..4b608f7
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/tests/file_entity_test.pages.inc
@@ -0,0 +1,6 @@
+<?php
+
+/**
+ * @file
+ * Test pages for the File Entity Test module.
+ */
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_argument_file_type.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_argument_file_type.inc
new file mode 100644
index 0000000..3eb2fa5
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_argument_file_type.inc
@@ -0,0 +1,39 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_argument_file_type.
+ */
+
+/**
+ * Argument handler to accept a file type.
+ */
+class views_handler_argument_file_type extends views_handler_argument_string {
+
+  /**
+   * Override the behavior of summary_name(). Get the user friendly version
+   * of the file type.
+   */
+  function summary_name($data) {
+    return $this->file_type($data->{$this->name_alias});
+  }
+
+  /**
+   * Override the behavior of title(). Get the user friendly version of the
+   * file type.
+   */
+  function title() {
+    return $this->file_type($this->argument);
+  }
+
+  /**
+   * Helper function to return the human-readable type of the file.
+   */
+  function file_type($type) {
+    $output = file_entity_type_get_name($type);
+    if (empty($output)) {
+      $output = t('Unknown file type');
+    }
+    return check_plain($output);
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_filename.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_filename.inc
new file mode 100644
index 0000000..7f3a992
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_filename.inc
@@ -0,0 +1,52 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_filename.
+ */
+
+/**
+ * Field handler to provide simple renderer that allows linking to a file.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_filename extends views_handler_field_file {
+  /**
+   * Constructor to provide additional field to add.
+   */
+  function init(&$view, &$options) {
+    if (!empty($this->options['link_to_file'])) {
+      $this->additional_fields['fid'] = 'fid';
+    }
+    parent::init($view, $options);
+  }
+
+  function option_definition() {
+    $options = parent::option_definition();
+    $options['link_to_file'] = array('default' => TRUE, 'bool' => TRUE);
+    return $options;
+  }
+
+  /**
+   * Provide link to file option
+   */
+  function options_form(&$form, &$form_state) {
+    parent::options_form($form, $form_state);
+    $form['link_to_file']['#title'] = t('Link this field to the original file');
+  }
+
+  /**
+   * Render whatever the data is as a link to the file.
+   *
+   * Data should be made XSS safe prior to calling this function.
+   */
+  function render_link($data, $values) {
+    if (!empty($this->options['link_to_file']) && !empty($this->additional_fields['fid'])) {
+      if ($data !== NULL && $data !== '') {
+        $this->options['alter']['make_link'] = TRUE;
+        $this->options['alter']['path'] = 'file/' . $this->get_value($values, 'fid');
+      }
+    }
+    return $data;
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link.inc
new file mode 100644
index 0000000..2e5df5f
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link.inc
@@ -0,0 +1,48 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_link.
+ */
+
+/**
+ * Field handler to present a link to the file.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_link extends views_handler_field_entity {
+
+  function option_definition() {
+    $options = parent::option_definition();
+    $options['text'] = array('default' => '', 'translatable' => TRUE);
+    return $options;
+  }
+
+  function options_form(&$form, &$form_state) {
+    $form['text'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Text to display'),
+      '#default_value' => $this->options['text'],
+    );
+    parent::options_form($form, $form_state);
+
+    // The path is set by render_link function so don't allow to set it.
+    $form['alter']['path'] = array('#access' => FALSE);
+    $form['alter']['external'] = array('#access' => FALSE);
+  }
+
+  function render($values) {
+    if ($entity = $this->get_value($values)) {
+      return $this->render_link($entity, $values);
+    }
+  }
+
+  function render_link($file, $values) {
+    if (file_entity_access('view', $file)) {
+      $this->options['alter']['make_link'] = TRUE;
+      $this->options['alter']['path'] = "file/$file->fid";
+      $text = !empty($this->options['text']) ? $this->options['text'] : t('View');
+      return $text;
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_delete.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_delete.inc
new file mode 100644
index 0000000..49e195e
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_delete.inc
@@ -0,0 +1,31 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_link_delete.
+ */
+
+/**
+ * Field handler to present a link to delete a file.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_link_delete extends views_handler_field_file_link {
+
+  /**
+   * Renders the link.
+   */
+  function render_link($file, $values) {
+    // Ensure user has access to delete this file.
+    if (!file_entity_access('delete', $file)) {
+      return;
+    }
+
+    $this->options['alter']['make_link'] = TRUE;
+    $this->options['alter']['path'] = "file/$file->fid/delete";
+    $this->options['alter']['query'] = drupal_get_destination();
+
+    $text = !empty($this->options['text']) ? $this->options['text'] : t('Delete');
+    return $text;
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_download.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_download.inc
new file mode 100644
index 0000000..088d18c
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_download.inc
@@ -0,0 +1,32 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_link_download.
+ */
+
+/**
+ * Field handler to present a link to download a file.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_link_download extends views_handler_field_file_link {
+
+  /**
+   * Renders the link.
+   */
+  function render_link($file, $values) {
+    // Ensure user has access to download this file.
+    if (!file_entity_access('download', $file)) {
+      return;
+    }
+
+    $this->options['alter']['make_link'] = TRUE;
+    $uri = file_entity_download_uri($file);
+    $this->options['alter']['path'] = $uri['path'];
+    $this->options['alter'] += $uri['options'];
+
+    $text = !empty($this->options['text']) ? $this->options['text'] : t('Download');
+    return $text;
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_edit.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_edit.inc
new file mode 100644
index 0000000..993b9dd
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_edit.inc
@@ -0,0 +1,31 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_link_edit.
+ */
+
+/**
+ * Field handler to present a link file edit.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_link_edit extends views_handler_field_file_link {
+
+  /**
+   * Renders the link.
+   */
+  function render_link($file, $values) {
+    // Ensure user has access to edit this file.
+    if (!file_entity_access('update', $file)) {
+      return;
+    }
+
+    $this->options['alter']['make_link'] = TRUE;
+    $this->options['alter']['path'] = "file/$file->fid/edit";
+    $this->options['alter']['query'] = drupal_get_destination();
+
+    $text = !empty($this->options['text']) ? $this->options['text'] : t('Edit');
+    return $text;
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_usage.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_usage.inc
new file mode 100644
index 0000000..f4f64c2
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_link_usage.inc
@@ -0,0 +1,31 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_link_usage.
+ */
+
+/**
+ * Field handler to present a link to view the usage of a file.
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_link_usage extends views_handler_field_file_link {
+
+  /**
+   * Renders the link.
+   */
+  function render_link($file, $values) {
+    // Ensure user has access to update this file.
+    if (!file_entity_access('update', $file)) {
+      return;
+    }
+
+    $this->options['alter']['make_link'] = TRUE;
+    $this->options['alter']['path'] = "file/$file->fid/usage";
+    $this->options['alter']['query'] = drupal_get_destination();
+
+    $text = !empty($this->options['text']) ? $this->options['text'] : t('Usage');
+    return $text;
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_rendered.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_rendered.inc
new file mode 100644
index 0000000..d677374
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_rendered.inc
@@ -0,0 +1,45 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_rendered.
+ */
+
+/**
+ * Field handler to render a file with a view mode using file_view_file().
+ *
+ * @ingroup views_field_handlers
+ */
+class views_handler_field_file_rendered extends views_handler_field_entity {
+  function option_definition() {
+    $options = parent::option_definition();
+    $options['file_view_mode'] = array('default' => 'default');
+    return $options;
+  }
+
+  /**
+   * Provide file_view_mode option for to file display.
+   */
+  function options_form(&$form, &$form_state) {
+    parent::options_form($form, $form_state);
+
+    $entity_info = entity_get_info('file');
+    $options = array('default' => t('Default'));
+    foreach ($entity_info['view modes'] as $file_view_mode => $file_view_mode_info) {
+      $options[$file_view_mode] = $file_view_mode_info['label'];
+    }
+
+    $form['file_view_mode'] = array(
+      '#title' => t('File view mode'),
+      '#description' => t('Select a view mode. Note that only the file will be rendered and not any of its fields.'),
+      '#type' => 'select',
+      '#default_value' => $this->options['file_view_mode'],
+      '#options' => $options,
+    );
+  }
+
+  function render($values) {
+    $file = $this->get_value($values);
+    return file_view_file($file, $this->options['file_view_mode']);
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_type.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_type.inc
new file mode 100644
index 0000000..92e12fe
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_field_file_type.inc
@@ -0,0 +1,48 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_field_file_type.
+ */
+
+/**
+ * Field handler to translate a file type into its readable form.
+ */
+class views_handler_field_file_type extends views_handler_field_file {
+  function option_definition() {
+    $options = parent::option_definition();
+    $options['machine_name'] = array('default' => FALSE);
+
+    return $options;
+  }
+
+  /**
+   * Provide machine_name option for to file type display.
+   */
+  function options_form(&$form, &$form_state) {
+    parent::options_form($form, $form_state);
+
+    $form['machine_name'] = array(
+      '#title' => t('Output machine name'),
+      '#description' => t('Display field as the file type machine name.'),
+      '#type' => 'checkbox',
+      '#default_value' => !empty($this->options['machine_name']),
+      '#fieldset' => 'more',
+    );
+  }
+
+  /**
+    * Render file type as human readable name, unless using machine_name option.
+    */
+  function render_name($data, $values) {
+    if ($this->options['machine_name'] != 1 && $data !== NULL && $data !== '') {
+      return t($this->sanitize_value(file_entity_type_get_name($data)));
+    }
+    return $this->sanitize_value($data);
+  }
+
+  function render($values) {
+    $value = $this->get_value($values);
+    return $this->render_link($this->render_name($value, $values), $values);
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_handler_filter_file_type.inc b/profiles/commons/modules/contrib/file_entity/views/views_handler_filter_file_type.inc
new file mode 100644
index 0000000..6bca816
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_handler_filter_file_type.inc
@@ -0,0 +1,23 @@
+<?php
+
+/**
+ * @file
+ * Definition of views_handler_filter_file_type.
+ */
+
+/**
+ * Filter by file type
+ */
+class views_handler_filter_file_type extends views_handler_filter_in_operator {
+  function get_value_options() {
+    if (!isset($this->value_options)) {
+      $this->value_title = t('File types');
+      $options = array();
+      foreach (file_entity_type_get_names() as $type => $name) {
+        $options[$type] = t($name);
+      }
+      asort($options);
+      $this->value_options = $options;
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_rss.inc b/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_rss.inc
new file mode 100644
index 0000000..4a39024
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_rss.inc
@@ -0,0 +1,175 @@
+<?php
+
+/**
+ * @file
+ * Contains the file RSS row style plugin.
+ */
+
+/**
+ * Plugin which performs a file_view on the resulting object
+ * and formats it as an RSS item.
+ */
+class views_plugin_row_file_rss extends views_plugin_row {
+  // Basic properties that let the row style follow relationships.
+  var $base_table = 'file_managed';
+  var $base_field = 'fid';
+
+  // Stores the files loaded with pre_render.
+  var $files = array();
+
+  function option_definition() {
+    $options = parent::option_definition();
+
+    $options['item_length'] = array('default' => 'default');
+    $options['links'] = array('default' => FALSE, 'bool' => TRUE);
+
+    return $options;
+  }
+
+  /**
+   * Override init function to convert fulltext view-mode to full.
+   */
+  function init(&$view, &$display, $options = NULL) {
+    parent::init($view, $display, $options);
+
+    if ($this->options['item_length'] == 'fulltext') {
+      $this->options['item_length'] = 'full';
+    }
+  }
+
+  function options_form(&$form, &$form_state) {
+    parent::options_form($form, $form_state);
+
+    $form['item_length'] = array(
+      '#type' => 'select',
+      '#title' => t('Display type'),
+      '#options' => $this->options_form_summary_options(),
+      '#default_value' => $this->options['item_length'],
+    );
+    $form['links'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Display links'),
+      '#default_value' => $this->options['links'],
+    );
+  }
+
+  /**
+   * Return the main options, which are shown in the summary title.
+   */
+  function options_form_summary_options() {
+    $entity_info = entity_get_info('file');
+    $options = array();
+    if (!empty($entity_info['view modes'])) {
+      foreach ($entity_info['view modes'] as $mode => $settings) {
+        $options[$mode] = $settings['label'];
+      }
+    }
+    $options['title'] = t('Title only');
+    $options['default'] = t('Use site default RSS settings');
+    return $options;
+  }
+
+  function summary_title() {
+    $options = $this->options_form_summary_options();
+    return check_plain($options[$this->options['item_length']]);
+  }
+
+
+  function pre_render($values) {
+    $fids = array();
+    foreach ($values as $row) {
+      $fids[] = $row->{$this->field_alias};
+    }
+    if (!empty($fids)) {
+      $this->files = file_load_multiple($fids);
+    }
+  }
+
+  function render($row) {
+    // For the most part, this code is taken from node_feed() in node.module
+    global $base_url;
+
+    $fid = $row->{$this->field_alias};
+    if (!is_numeric($fid)) {
+      return;
+    }
+
+    $display_mode = $this->options['item_length'];
+    if ($display_mode == 'default') {
+      $display_mode = variable_get('feed_item_length', 'teaser');
+    }
+
+    // Load the specified file:
+    $file = $this->files[$fid];
+    if (empty($file)) {
+      return;
+    }
+
+    $item_text = '';
+
+    $uri = entity_uri('file', $file);
+    $user = user_load($file->uid);
+    $file->link = url($uri['path'], $uri['options'] + array('absolute' => TRUE));
+    $file->rss_namespaces = array();
+    $file->rss_elements = array(
+      array(
+        'key' => 'pubDate',
+        'value' => gmdate('r', $file->timestamp),
+      ),
+      array(
+        'key' => 'dc:creator',
+        'value' => $user->name,
+      ),
+      array(
+        'key' => 'guid',
+        'value' => $file->fid . ' at ' . $base_url,
+        'attributes' => array('isPermaLink' => 'false'),
+      ),
+    );
+
+    // The file gets built and modules add to or modify $file->rss_elements
+    // and $file->rss_namespaces.
+
+    $build_mode = $display_mode;
+
+    $build = file_view($file, $build_mode);
+    unset($build['#theme']);
+
+    if (!empty($file->rss_namespaces)) {
+      $this->view->style_plugin->namespaces = array_merge($this->view->style_plugin->namespaces, $file->rss_namespaces);
+    }
+    elseif (function_exists('rdf_get_namespaces')) {
+      // Merge RDF namespaces in the XML namespaces in case they are used
+      // further in the RSS content.
+      $xml_rdf_namespaces = array();
+      foreach (rdf_get_namespaces() as $prefix => $uri) {
+        $xml_rdf_namespaces['xmlns:' . $prefix] = $uri;
+      }
+      $this->view->style_plugin->namespaces += $xml_rdf_namespaces;
+    }
+
+    // Hide the links if desired.
+    if (!$this->options['links']) {
+      hide($build['links']);
+    }
+
+    if ($display_mode != 'title') {
+      // We render file contents and force links to be last.
+      $build['links']['#weight'] = 1000;
+      $item_text .= drupal_render($build);
+    }
+
+    $item = new stdClass();
+    $item->description = $item_text;
+    $item->title = $file->filename;
+    $item->link = $file->link;
+    $item->elements = $file->rss_elements;
+    $item->fid = $file->fid;
+
+    return theme($this->theme_functions(), array(
+      'view' => $this->view,
+      'options' => $this->options,
+      'row' => $item
+    ));
+  }
+}
diff --git a/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_view.inc b/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_view.inc
new file mode 100644
index 0000000..7b5fe82
--- /dev/null
+++ b/profiles/commons/modules/contrib/file_entity/views/views_plugin_row_file_view.inc
@@ -0,0 +1,65 @@
+<?php
+
+/**
+ * @file
+ * Contains the file view row style plugin.
+ */
+
+/**
+ * Plugin which performs a file_view on the resulting object.
+ *
+ * Most of the code on this object is in the theme function.
+ */
+class views_plugin_row_file_view extends views_plugin_row {
+  // Basic properties that let the row style follow relationships.
+  var $base_table = 'file_managed';
+  var $base_field = 'fid';
+
+  // Stores the files loaded with pre_render.
+  var $files = array();
+
+  function option_definition() {
+    $options = parent::option_definition();
+
+    $options['view_mode'] = array('default' => 'default');
+    $options['links'] = array('default' => TRUE);
+    return $options;
+  }
+
+  function options_form(&$form, &$form_state) {
+    parent::options_form($form, $form_state);
+
+    $form['view_mode'] = array(
+      '#type' => 'select',
+      '#options' => file_entity_view_mode_labels(),
+      '#title' => t('View mode'),
+      '#default_value' => $this->options['view_mode'],
+    );
+    $form['links'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Display links'),
+      '#default_value' => $this->options['links'],
+    );
+  }
+
+  function summary_title() {
+    $view_mode_label = file_entity_view_mode_label($this->options['view_mode'], t('Unknown'));
+    return check_plain($view_mode_label);
+  }
+
+  function pre_render($values) {
+    $fids = array();
+    foreach ($values as $row) {
+      $fids[] = $row->{$this->field_alias};
+    }
+    $this->files = file_load_multiple($fids);
+  }
+
+  function render($row) {
+    $file = $this->files[$row->{$this->field_alias}];
+    $file->view = $this->view;
+    $build = file_view($file, $this->options['view_mode']);
+
+    return drupal_render($build);
+  }
+}
diff --git a/profiles/commons/modules/contrib/i18nviews/i18nviews.info b/profiles/commons/modules/contrib/i18nviews/i18nviews.info
index 4caf548..ce4e439 100644
--- a/profiles/commons/modules/contrib/i18nviews/i18nviews.info
+++ b/profiles/commons/modules/contrib/i18nviews/i18nviews.info
@@ -27,8 +27,8 @@ files[] = includes/i18nviews_handler_filter_term_node_tid_depth.inc
 files[] = includes/i18nviews_plugin_argument_validate_i18n_taxonomy_term.inc
 files[] = includes/i18nviews_plugin_localization_i18nstrings.inc
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = ""
 project = "i18nviews"
-datestamp = "1382042539"
+datestamp = "1387568919"
 
diff --git a/profiles/commons/modules/contrib/lingotek/LICENSE.txt b/profiles/commons/modules/contrib/lingotek/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/lingotek/README.md b/profiles/commons/modules/contrib/lingotek/README.md
new file mode 100644
index 0000000..70d2535
--- /dev/null
+++ b/profiles/commons/modules/contrib/lingotek/README.md
@@ -0,0 +1,9 @@
+Drupal Integration
+===================
+
+![Lingotek Translation in Drupal](http://devzone.lingotek.com/wp-content/uploads/2013/10/lingotek-chevrons-blue-small.png)
+
+Lingotek Translation Module
+----------------------------
+
+This is a mirror of the git.drupal.org repository for Lingotek Translation. Changes will not be pulled, if you want to contibute, go to the [Lingotek Translation](http://drupal.org/project/lingotek) project page on Drupal.org.
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/lingotek/README.txt b/profiles/commons/modules/contrib/lingotek/README.txt
index 572d950..5aa70ab 100644
--- a/profiles/commons/modules/contrib/lingotek/README.txt
+++ b/profiles/commons/modules/contrib/lingotek/README.txt
@@ -1,5 +1,6 @@
 
--- SUMMARY --
+SUMMARY
+--------
 
 Translates your nodes, comments, and the rest of your site using the Lingotek
 Translation Management System.
@@ -10,7 +11,8 @@ To submit bug reports and feature suggestions, or to track changes:
   http://drupal.org/project/issues/lingotek
 
 
--- REQUIREMENTS --
+REQUIREMENTS
+-------------
 
 Dependencies:
   Chaos Tools
@@ -27,14 +29,16 @@ Modules that we integrate with (optional):
   Workbench Moderation
 
 
--- INSTALLATION --
+INSTALLATION
+-------------
 
-* Install as usual, see http://drupal.org/node/70151 for further information.
+* Install as usual, see https://drupal.org/documentation/install/modules-themes/modules-7 for further information.
 
 For detailed step by step instructions see
 http://www.drupaltranslation.com/drupal_translation_module_installation.
 
 
--- CONFIGURATION --
+CONFIGURATION
+--------------
 
 There is setup wizard that helps you to get started, go to admin/config/lingotek/setup.
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/lingotek/js/lingotek.admin.js b/profiles/commons/modules/contrib/lingotek/js/lingotek.admin.js
index 8dbd2ef..e2323aa 100644
--- a/profiles/commons/modules/contrib/lingotek/js/lingotek.admin.js
+++ b/profiles/commons/modules/contrib/lingotek/js/lingotek.admin.js
@@ -38,6 +38,8 @@ Drupal.behaviors.lingotekAdminForm = {
         })
         if(count == 0) {
           row.find('td:first-child .form-checkbox').attr('checked',false);
+          row.find('.form-select').val('DISABLED');
+          row.find('.form-select').trigger('change');
         }
       }
     });
diff --git a/profiles/commons/modules/contrib/lingotek/js/lingotek.bulk_grid.js b/profiles/commons/modules/contrib/lingotek/js/lingotek.bulk_grid.js
index 90f0ddd..0bc7296 100644
--- a/profiles/commons/modules/contrib/lingotek/js/lingotek.bulk_grid.js
+++ b/profiles/commons/modules/contrib/lingotek/js/lingotek.bulk_grid.js
@@ -48,6 +48,8 @@ function lingotek_perform_action(nid, action) {
           lingotekTriggerModal('#reset-translations-link');
         } else if(val == 'edit') {
           lingotekTriggerModal('#edit-settings-link');
+        } else if(val == 'workflow') {
+          lingotekTriggerModal('#change-workflow-link');
         } else  {
           $('input#edit-actions-submit.form-submit').trigger('click');
         }
diff --git a/profiles/commons/modules/contrib/lingotek/js/lingotek.form.js b/profiles/commons/modules/contrib/lingotek/js/lingotek.form.js
index 0997b30..366de52 100644
--- a/profiles/commons/modules/contrib/lingotek/js/lingotek.form.js
+++ b/profiles/commons/modules/contrib/lingotek/js/lingotek.form.js
@@ -58,13 +58,6 @@ lingotek.forms = lingotek.forms || {};
             var autoUpload = $('#edit-lingotek-create-lingotek-document').is(":checked");
             var autoDownload = $('#edit-lingotek-sync-method').is(":checked");
             var custom = $('#edit-lingotek-profile').val() == 'CUSTOM';
-                        
-            if(custom) {
-              summaryMessages.push( autoUpload ? Drupal.t("auto-upload") : Drupal.t("manual upload"));
-              summaryMessages.push( autoDownload ? Drupal.t("auto-download") : Drupal.t("manual download"));
-            } else {
-              summaryMessages.push($('#edit-lingotek-profile option:selected').text());
-            }
             
             // Source language set or not
             if (sourceLanguageSet) {
@@ -76,6 +69,7 @@ lingotek.forms = lingotek.forms || {};
             }
             else {
                 //summaryMessages.push(Drupal.t("source language unset"));
+                $('#edit-lingotek-profile').val('DISABLED');
                 $('#edit-lingotek-note').show();
                 $('#edit-lingotek-content').hide();
                 $('#edit-lingotek-lingotek-note').hide();
@@ -87,6 +81,13 @@ lingotek.forms = lingotek.forms || {};
               $('#edit-lingotek-content').hide();
               $('#edit-lingotek-advanced').hide();
             }
+
+            if(custom) {
+              summaryMessages.push( autoUpload ? Drupal.t("auto-upload") : Drupal.t("manual upload"));
+              summaryMessages.push( autoDownload ? Drupal.t("auto-download") : Drupal.t("manual download"));
+            } else {
+              summaryMessages.push($('#edit-lingotek-profile option:selected').text());
+            }
         }
         
         var extraDetails = summaryMessages.slice(1).join(', ');
diff --git a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekApi.php b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekApi.php
index 14b9059..00b11f9 100644
--- a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekApi.php
+++ b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekApi.php
@@ -741,7 +741,8 @@ class LingotekApi {
         'externalId' => $externalId
       );
 
-      if ($output = $this->request('getWorkbenchLink', $params)) {
+      $output = $this->request('getWorkbenchLink', $params);
+      if ($output && isset($output->url)) {
         $links[$static_id] = $url = $output->url;
       }
       else {
@@ -785,14 +786,15 @@ class LingotekApi {
    * Gets available Lingotek Workflows.
    * 
    * @param $reset
-   *   A boolean value to determin whether we need to query the API
+   *   A boolean value to determine whether we need to query the API
+   * @param $include_public
+   *   A boolean value to determine whether to show public workflows
    * 
    * @return array
    *   An array of available Workflows with workflow IDs as keys, workflow labels as values.
    */
-  public function listWorkflows($reset = FALSE) {
+  public function listWorkflows($reset = FALSE, $include_public = FALSE) {
     $workflows = variable_get('lingotek_workflow_defaults', array());
-
     if (!empty($workflows) && $reset == FALSE) {
       return $workflows;
     }
@@ -800,6 +802,8 @@ class LingotekApi {
     if ($workflows_raw = $this->request('listWorkflows')) {
       $workflows = array();
       foreach ($workflows_raw->workflows as $workflow) {
+        if ($include_public || (!$workflow->is_public 
+            && $workflow->owner != LINGOTEK_DEFAULT_WORKFLOW_TEMPLATE))
         $workflows[$workflow->id] = $workflow->name;
       }
       variable_set('lingotek_workflow_defaults', $workflows);
@@ -850,6 +854,32 @@ class LingotekApi {
   }
 
   /**
+   * Updates one or more nids to belong to a given workflow
+   * 
+   * @param array $document_ids
+   *   An array of document IDs
+   * @param string $workflow_id
+   *   A string containing the desired workflow_id
+   * @param string $prefillPhase
+   *   An optional parameter specifying the prefill phase
+   * 
+   * @return bool
+   *   TRUE on success, FALSE on failure.
+   */
+  public function changeWorkflow($document_ids, $workflow_id, $prefillPhase=NULL) {
+    $parameters = array(
+      'documentId' => $document_ids,
+      'workflowId' => $workflow_id,
+      'preserveTargets' => 'true',
+    );
+    if ($prefillPhase) {
+      $parameters['prefillPhase'] = $prefillPhase;
+    }
+
+    return ($this->request('resetDocument', $parameters) ? TRUE : FALSE);
+  }
+
+  /**
    * Marks a phase as complete.
    *
    * @param int $phase_id
@@ -1068,6 +1098,7 @@ class LingotekApi {
   public function createCommunity($parameters = array(), $callback_url = NULL) {
     $credentials = array('consumer_key' => LINGOTEK_AP_OAUTH_KEY, 'consumer_secret' => LINGOTEK_AP_OAUTH_SECRET);
     if (isset($callback_url)) {
+      $parameters['projectName'] = lingotek_get_site_name(); 
       $parameters['callbackUrl'] = $callback_url;
     }
     $response = $this->request('autoProvisionCommunity', $parameters, 'POST', $credentials);
diff --git a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekConfigChunk.php b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekConfigChunk.php
index cd4a508..a99c49b 100644
--- a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekConfigChunk.php
+++ b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekConfigChunk.php
@@ -553,48 +553,6 @@ class LingotekConfigChunk implements LingotekTranslatableEntity {
   }
 
   /**
-   * Wrap placeholder tags in specific tags that will be ignored by Lingotek
-   *
-   * @param $segment_text
-   *   a string containing the segment to be translated
-   *
-   * @return string
-   *   the original input plus any additional reference tags to be ignored.
-   */
-  public static function filterPlaceholders($segment_text) {
-    // NOTE: This regex is only a generalization of the variable names possible using
-    // the t-function's variable interpolation.  This finds all sets of word
-    // characters (A-Z, a-z, - or _) that begin with either !, @, or %, that do not
-    // fall between angle brackets (which would indicate being on the inside
-    // of an HTML tag).  It also protects everything inside square brackets
-    // that do not fall inside angle brackets.
-    $patterns = array(
-      '/(\[[!@%\w\s_-]+\]\s*)(?![^<]*\>)/', // wrap everything in square brackets
-      '/([!@%][\w_-]+\s*)(?![^<]*\>)/', // wrap everything beginning with !,@,%
-    );
-    $replacement = '<drupalvar>${1}</drupalvar>';
-    foreach ($patterns as $p) {
-      $segment_text = preg_replace($p, $replacement, $segment_text);
-    }
-    return $segment_text;
-  }
-
-  /**
-   * Unwrap placeholder tags in specific tags that will be ignored by Lingotek
-   *
-   * @param $segment_text
-   *   a string containing the segment that potentially contains drupal variables
-   *
-   * @return string
-   *   the original input less any additional reference tags added prior to upload
-   */
-  public static function unfilterPlaceholders($segment_text) {
-    $pattern = '/<\/?drupalvar>/';
-    $replacement = '';
-    return preg_replace($pattern, $replacement, $segment_text);
-  }
-
-  /**
    * Gets the contents of this item formatted as XML to be sent to Lingotek.
    *
    * @return string
@@ -610,7 +568,7 @@ class LingotekConfigChunk implements LingotekTranslatableEntity {
 
     $content = '';
     foreach ($translatable as $field) {
-      $text = self::filterPlaceholders($this->source_data[$field]);
+      $text = lingotek_filter_placeholders($this->source_data[$field], TRUE);
 
       if ($text) {
         $current_field = '<' . self::TAG_PREFIX . $field . '>';
@@ -852,7 +810,7 @@ class LingotekConfigChunk implements LingotekTranslatableEntity {
       $lid = self::getLidFromTag($drupal_field_name);
       if (!in_array($lid, $non_lingotek_locales_targets)) {
         $content = (string) $xml_obj->element;
-        $content = self::unfilterPlaceholders(decode_entities($content));
+        $content = lingotek_unfilter_placeholders(decode_entities($content));
         $plural_lid = array_key_exists($lid, $plural_mapping);
         $rows += array(
           ":l_$icount" => $lid,
diff --git a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekSync.php b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekSync.php
index 2005c6f..68705c9 100644
--- a/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekSync.php
+++ b/profiles/commons/modules/contrib/lingotek/lib/Drupal/lingotek/LingotekSync.php
@@ -15,7 +15,7 @@ class LingotekSync {
   const STATUS_PENDING = 'PENDING';  // The target translation is awaiting to receive updated content from Lingotek
   const STATUS_READY = 'READY';      // The target translation is complete and ready for download
   const STATUS_DISABLED = 'DISABLED';    // A disabled node should neither be uploaded nor downloaded by Lingotek
-  const STATUS_TARGET = 'TARGET';    // A target node is being used to store a translation and should be ignored by Lingotek
+  const STATUS_TARGET = 'TARGET';    // A target node is being used to store a translation and should be ignored by Lingotek (used for node storage)
 
   const PROFILE_CUSTOM = 'CUSTOM';
   const PROFILE_DISABLED = 'DISABLED';
@@ -110,9 +110,13 @@ class LingotekSync {
     $subquery = db_select('node', 'n')->fields('n', array('nid'));
     $subquery->condition('language', $drupal_language_code);
 
+    $subquery2 = db_select('lingotek', 'l2')->fields('l2', array('nid'));
+    $subquery2->condition('lingokey', 'target_sync_status_' . $lingotek_locale); //already has status
+
     $query = db_select('lingotek', 'l')->fields('l');
     $query->condition('lingokey', 'node_sync_status');
     $query->condition('nid', $subquery, 'NOT IN'); // exclude adding to nodes where this locale is the source
+    $query->condition('nid', $subquery2, 'NOT IN'); // exclude nodes that already have this language as a target
     $result = $query->execute();
 
     while ($record = $result->fetchAssoc()) {
@@ -902,13 +906,19 @@ class LingotekSync {
     return $found;
   }
 
-  public static function getDocIdsFromNodeIds($drupal_node_ids) {
-
+  public static function getDocIdsFromNodeIds($drupal_node_ids, $associate = FALSE) {
     $query = db_select('lingotek', 'l')
-        ->fields('l', array('lingovalue'))
         ->condition('nid', $drupal_node_ids, 'IN')
         ->condition('lingokey', 'document_id');
-    $result = $query->execute()->fetchCol();
+    $query->addField('l', 'lingovalue', 'doc_id');
+
+    if ($associate) {
+      $query->addField('l', 'nid');
+      $result = $query->execute()->fetchAllAssoc('nid');
+    }
+    else {
+      $result = $query->execute()->fetchCol();
+    }
 
     return $result;
   }
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.admin.inc b/profiles/commons/modules/contrib/lingotek/lingotek.admin.inc
index 436d77a..1722880 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.admin.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.admin.inc
@@ -165,7 +165,7 @@ function lingotek_admin_node_translation_settings_form($form, &$form_state, $ent
       if (array_search($field_type, $translatable_field_types)) {
         $fr[$field_machine_name] = array(
           '#type' => 'checkbox',
-          '#title' => $field_label,
+          '#title' => check_plain($field_label),
           '#attributes' => array(
             'id' => array('edit-form-item-' . $bundle_name . '-seperator-' . $field_machine_name),
             'name' => $bundle_name . '_SEPERATOR_' . $field_machine_name,
@@ -366,13 +366,26 @@ function lingotek_admin_profile_usage($id) {
   return $query->countQuery()->execute()->fetchField();
 }
 
+function lingotek_admin_get_nids_by_profile($id) {
+  $query = db_select('node', 'n');
+  $query->fields('n', array('nid'));
+  $query->leftJoin('lingotek', 'l_profile', 'n.nid = l_profile.nid  and l_profile.lingokey = \'profile\'');
+  $query->leftJoin('lingotek', 'l_auto_upload', 'n.nid = l_auto_upload.nid  and l_auto_upload.lingokey = \'create_lingotek_document\'');
+  $query->leftJoin('lingotek', 'l_status', 'n.nid = l_status.nid  and l_status.lingokey = \'node_sync_status\'');
+  $query->condition('l_status.lingovalue', 'TARGET', '<>');
+  $or = lingotek_profile_condition('n', 'l_auto_upload', 'l_profile' , $id);
+  $query->condition($or);
+
+  return $query->execute()->fetchCol();
+}
+
 function lingotek_admin_profile_usage_by_types($id) {
   $profile_mapping = variable_get('lingotek_entity_profiles');
   $profile_mapping_associations = isset($profile_mapping['node']) ? $profile_mapping['node'] : array();
   $profile_usage = array_count_values($profile_mapping_associations);
   $node_info = entity_get_info('node');
   $node_bundles = array_keys($node_info['bundles']);
-  if(!isset($profile_usage['DISABLED'])) {
+  if (!isset($profile_usage['DISABLED'])) {
     $profile_usage['DISABLED'] = 0;
   }
   foreach ($node_bundles as $bundle) {
@@ -601,7 +614,8 @@ function lingotek_admin_additional_translation_settings_form_submit($form, &$for
 
   if ($lingotek_use_translation_from_drupal) {
     variable_set('l10n_update_rebuild_projects', 1);
-  } else {
+  }
+  else {
     variable_del('l10n_update_rebuild_projects');
   }
 
@@ -949,16 +963,7 @@ function lingotek_admin_advanced_parsing_form($form, &$form_state, $show_fieldse
   $form['advanced-parsing'] = array(
     '#type' => $show_fieldset ? 'fieldset' : 'item',
     '#title' => t('Advanced Content Parsing'),
-    '#collapsible' => TRUE,
-    '#collapsed' => TRUE,
     '#group' => 'administrative_settings',
-    'actions' => array(
-      '#type' => 'actions',
-      'submit' => array(
-        '#type' => 'submit',
-        '#value' => t('Save')
-      )
-    ),
     '#submit' => array('lingotek_admin_advanced_parsing_form_submit')
   );
 
@@ -991,12 +996,32 @@ function lingotek_admin_advanced_parsing_form($form, &$form_state, $show_fieldse
 
     $form['advanced-parsing']['#submit'][] = 'lingotek_handle_advanced_xml_upgrade';
   }
+
+  $form['advanced-parsing']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save'),
+  );
+
+  $form['advanced-parsing']['reset'] = array(
+    '#type' => 'submit',
+    '#value' => t('Reset to Defaults'),
+    '#attributes' => array(
+      'onclick' => 'return confirm("' . t('Are you sure?\n\nAll of your configuration settings will be reset to system defaults.') . '")',
+      ),
+  );
+
   return $form;
 }
 
-function lingotek_admin_advanced_parsing_form_submit($form, &$form_state) {
-  system_settings_form_submit($form, $form_state);
-}
+function lingotek_admin_advanced_parsing_form_submit(&$form, &$form_state) {
+  if (isset($form_state['values']['op']) && $form_state['values']['op'] == 'Reset to Defaults') {
+    lingotek_set_default_advanced_xml(TRUE);
+    drupal_set_message(t('The configuration settings have been reset to system defaults.'));
+  }
+  else {
+    system_settings_form_submit($form, $form_state);
+  }
+ }
 
 /**
  * Lingotek prefs Form
@@ -1131,18 +1156,18 @@ function lingotek_admin_prefs_form($form, &$form_state, $show_fieldset = FALSE)
     '#default_value' => variable_get('lingotek_hide_tlmi', 0),
   );
 
-  $form[$fkey]['lingotek_views_edit_links'] = array(
+  $form[$fkey]['lingotek_show_language_label'] = array(
     '#type' => 'checkbox',
-    '#title' => t('Show links to edit translations in views'),
-    '#default_value' => variable_get('lingotek_views_edit_links'),
-    '#description' => t('The user must have the "Translation" or "Manage Projects" permission'),
+    '#title' => t('Show language label on node pages'),
+    '#default_value' => variable_get('lingotek_show_language_label'),
+    '#description' => t('If checked, language labels will be displayed for nodes that have the \'language selection\' field set to be visible.'),
   );
 
   $form[$fkey]['lingotek_account_plan_type'] = array(
     '#type' => 'checkbox',
     '#title' => t('Enable Enterprise Features'),
     '#default_value' => (variable_get('lingotek_account_plan_type') == 'enterprise' ? 1 : 0),
-    '#description' => t('Some features may not be available without an ') . '&nbsp;<a href="http://www.lingotek.com/drupal_pricing" target="_blank">enterprise license</a>&nbsp;' . t(' of the Lingotek TMS. Call 801.331.7777 for details.'),
+    '#description' => t('Some features may not be available without an') . '&nbsp;<a href="http://www.lingotek.com/drupal_pricing" target="_blank">Enterprise license</a>&nbsp;' . t('for the Lingotek TMS. Call 801.331.7777 for details.'),
   );
 
   return $form;
@@ -1247,7 +1272,7 @@ function lingotek_admin_connection_form($form, &$form_state, $show_fieldset = FA
       '#markup' => theme('table', array('header' => array(), 'rows' => array(
           array('TMS:', LINGOTEK_API_SERVER),
           array('GMC:', LINGOTEK_GMC_SERVER),
-          array('Billing:', LINGOTEK_BILLING_SERVER),
+        //array('Billing:', LINGOTEK_BILLING_SERVER),
         //array('AP Key:', LINGOTEK_AP_OAUTH_KEY),
         //array('AP Secret:', LINGOTEK_AP_OAUTH_SECRET),
     )))
@@ -1392,23 +1417,10 @@ function lingotek_admin_profile_form($form, &$form_state, $show_fieldset = FALSE
     '#default_value' => $form_state['values']['name'],
   );
 
-  $form['defaults']['lingotek_nodes_translation_method'] = array(
-    '#type' => 'radios',
-    '#title' => t('Translation Storage'),
-    '#options' => array(
-      'field' => '<strong>Field Translation</strong> (Recommended) - all translations are stored in a single node',
-      'node' => '<strong>Node Translation</strong>  - create a new node per language ',
-    ),
-    'field' => array(
-      '#description' => 'A newer and recommended method. Newer versions of Drupal are expected to use this method.',
-    ),
-    'node' => array(
-      '#description' => 'The classical method. Use for backwards compatibility.',
-    ),
-
-    '#default_value' => isset($form_state['values']['lingotek_nodes_translation_method']) ? $form_state['values']['lingotek_nodes_translation_method'] : 'field',
+  $form['defaults']['current_future_note'] = array(
+    '#type' => 'markup',
+    '#markup' => '<h3>' . t('Profile settings impacting all nodes (new and existing)') . '</h3><hr />',
   );
-
   // Upload
   $form['defaults']['create_lingotek_document'] = array(
     '#type' => 'checkbox',
@@ -1525,7 +1537,78 @@ function lingotek_admin_profile_form($form, &$form_state, $show_fieldset = FALSE
       '#options' => lingotek_get_url_alias_translations(),
       '#default_value' => $form_state['values']['url_alias_translation'],
     );
+  }
+  
+  
+  // Workflows
+  $workflows = $api->listWorkflows();
+  if ($workflows && count($workflows) > 1) {
+    $profiles = variable_get('lingotek_profiles');
+    $profile_id = (isset($form['defaults']['profile_id']['#value']) ? $form['defaults']['profile_id']['#value'] : -1);
+    $curr_workflow_id = (isset($profiles[$profile_id]['workflow_id']) ? $profiles[$profile_id]['workflow_id'] : '');
+
+    $form['defaults']['workflow_id'] = array(
+      '#type' => 'select',
+      '#title' => t('Default Workflow'),
+      '#description' => t('The default Workflow to use when translating content.'),
+      '#default_value' => $curr_workflow_id,
+      '#options' => $workflows,
+      '#ajax' => array(
+        'callback' => 'lingotek_profile_default_workflow_form_callback',
+        'wrapper' => 'prefill-phases-div',
+        'method' => 'replace',
+        'effect' => 'fade',
+      ),
+      '#prefix' => '<div id="prefill-phases-div">',
+    );
+    $form['defaults']['prefill_phases_checkbox'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Change all current content in this profile (@total in total) to use the new workflow', array('@total' => lingotek_admin_profile_usage($profile_id))),
+      '#default_value' => FALSE,
+      '#description' => t('All current translations will be removed and recreated using the new workflow, with translations pulled from the previous workflow'),
+      '#states' => array(
+        'invisible' => array(':input[name="workflow_id"]' => array('value' => $curr_workflow_id)),
+      )
+    );
+
+    $form['defaults']['prefill_phase_select'] = array(
+      '#title' => t("Desired Prefill Phase"),
+      '#description' => t('Please select the highest phase which should be prefilled for the new workflow'),
+      '#type' => 'select',
+      '#states' => array(
+          'visible' => array(':input[name="workflow_id"]' => array('!value' => $curr_workflow_id),
+                             ':input[name="prefill_phases_checkbox"]' => array('checked' => true)
+                        ),
+        ),
+      '#suffix' => '</div>',
+    );
+    $form['defaults']['prefill_phase_select']['#options'] = lingotek_get_phases_by_workflow_id($form_state['values']['workflow_id']);
+  }
+
+  // FUTURE-ONLY STUFF
+  $form['defaults']['future_only_note'] = array(
+    '#type' => 'markup',
+    '#markup' => '<h3>' . t('Profile settings impacting only new nodes') . '</h3><hr />',
+  );
+  
+  $form['defaults']['lingotek_nodes_translation_method'] = array(
+    '#type' => 'radios',
+    '#title' => t('Translation Storage'),
+    '#options' => array(
+      'field' => '<strong>Field Translation</strong> (Recommended) - all translations are stored in a single node',
+      'node' => '<strong>Node Translation</strong>  - create a new node per language ',
+    ),
+    'field' => array(
+      '#description' => 'A newer and recommended method. Newer versions of Drupal are expected to use this method.',
+    ),
+    'node' => array(
+      '#description' => 'The classical method. Use for backwards compatibility.',
+    ),
+
+    '#default_value' => isset($form_state['values']['lingotek_nodes_translation_method']) ? $form_state['values']['lingotek_nodes_translation_method'] : 'field',
+  );
 
+  if ($is_enterprise) {
 
     // Projects
     $projects = (class_exists('LingotekApi')) ? $api->listProjects() : array();
@@ -1551,19 +1634,6 @@ function lingotek_admin_profile_form($form, &$form_state, $show_fieldset = FALSE
       '#default_value' => isset($form_state['values']['project_id']) ? $form_state['values']['project_id'] : $id,
     );
 
-
-    // Workflows
-    if ($workflows = $api->listWorkflows()) {
-      $form['defaults']['workflow_id'] = array(
-        '#type' => 'select',
-        '#title' => t('Default Workflow'),
-        '#description' => t('The default Workflow to use when translating content.'),
-        '#default_value' => isset($form_state['values']['workflow_id']) ? $form_state['values']['workflow_id'] : '',
-        '#options' => $workflows,
-      );
-    }
-
-
     $vaults = $api->listVaults();
     $current_vault_id = variable_get('lingotek_vault', '');
     $personal_vault_count = ( isset($vaults['Personal Vaults']) ) ? count($vaults['Personal Vaults']) : 0;
@@ -1615,6 +1685,15 @@ function lingotek_admin_profile_form($form, &$form_state, $show_fieldset = FALSE
   return $form;
 }
 
+function lingotek_profile_default_workflow_form_callback($form, $form_state) {
+  return array(
+    $form['defaults']['workflow_id'],
+    $form['defaults']['prefill_phases_checkbox'],
+    $form['defaults']['prefill_phase_select'],
+
+  );
+}
+
 function lingotek_admin_profile_form_submit($form, &$form_state) {
   if ($form_state['values']['op'] == 'Save') {
     $profiles = variable_get('lingotek_profiles');
@@ -1639,6 +1718,31 @@ function lingotek_admin_profile_form_submit($form, &$form_state) {
         }
       }
     }
+    
+    // If the workflow has changed and if current translations should be changed,
+    // then pull all nodes associated with this profile and update the workflow
+    // on TMS, including the correct phase.
+    if (isset($form_state['values']['profile_id'])
+        && isset($form_state['values']['prefill_phases_checkbox']) 
+        && $form_state['values']['prefill_phases_checkbox']) {
+      $profile_id = $form_state['values']['profile_id'];
+      $workflow_id = $form_state['values']['workflow_id'];
+      $prefill_phase = $form_state['values']['prefill_phase_select'];
+
+      $nids = lingotek_admin_get_nids_by_profile($profile_id);
+      $document_ids = LingotekSync::getDocIdsFromNodeIds($nids);
+      if (!$document_ids) {
+        return;
+      }
+      $api = LingotekApi::instance();
+      $api->changeWorkflow($document_ids, $workflow_id, $prefill_phase);
+
+      // CREATE/UPDATE WORKFLOW ENTRIES IN THE LINGOTEK METADATA TABLE
+      foreach ($nids as $nid) {
+        lingotek_lingonode($nid, 'workflow_id', $workflow_id);
+      }
+
+    }
 
     $profiles[$form_state['values']['profile_id']] = $profile;
 
@@ -1736,7 +1840,7 @@ function lingotek_admin_utilities_form($form, &$form_state, $show_fieldset = FAL
       array('data' => array(
           '#type' => 'markup',
           '#prefix' => t('Disassociate All Translations') . ' <i>' . t('(use with caution)') . '</i>' . '<div class="description">',
-          '#markup' => t("Disassociates all locally-published translations from their counterparts on Lingotek's servers. This allows for your Drupal content to be re-uploaded to Lingotek, so that it can be retranslated entirely using the currently-defined workflow. Also resets the translation management settings for all nodes to those defined in the Content Defaults Settings."),
+          '#markup' => t("Should only be used to change the Lingotek project or TM vault associated with the nodes translation. Disassociates node translations on Lingoteks servers from the copies downloaded to Drupal. Additional translation using Lingotek will require re-uploading the nodes content to restart the translation process."),
           '#suffix' => '</div>'
         )),
       array('data' => $btn_disassociate_translations)
@@ -1869,13 +1973,15 @@ function lingotek_admin_configuration_view($form_short_id = NULL, $show_fieldset
       $output['lingotek'][] = lingotek_wrap_in_fieldset($entity_settings, t('Translate @types', array('@type' => $entity_type['label'])));
     }
 
-    $arr['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_advanced_parsing_form', TRUE), 'Advanced Content Parsing');
-
     //$output['lingotek'][] = lingotek_wrap_in_fieldset($arr, 'Translate Content');
     
     $output['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_comment_translation_settings_form', $show_fieldset), 'Translate Comments');
     $output['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_additional_translation_settings_form', $show_fieldset), 'Translate Configuration');
     $output['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_profiles_form', $show_fieldset), 'Translation Profiles');
+    if ($is_enterprise) {
+      $output['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_advanced_parsing_form', TRUE), 'Content Parsing (Advanced)');
+    }
+   
     $output['lingotek'][] = lingotek_wrap_in_fieldset(drupal_get_form('lingotek_admin_prefs_form', $show_fieldset), 'Preferences');
 
     $logging_utilities = array(
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.api.inc b/profiles/commons/modules/contrib/lingotek/lingotek.api.inc
index 31e1c4e..7a24721 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.api.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.api.inc
@@ -50,9 +50,9 @@ function lingotek_get_translated_node($node, $drupal_language_code) {
     foreach ($lingotek_fields['node'][$localized_node->type] as $field_name) {
       $field = $node->$field_name;
       $f = array();
-      if(isset($field[$node->language])) {
+      if (isset($field[$node->language])) {
         foreach ($field[$node->language] as $key => $value) {
-          if(isset($value['format']))
+          if (isset($value['format']))
             $f[$drupal_language_code][$key]['format'] = $value['format'];
         }
       }
@@ -114,7 +114,8 @@ function lingotek_download_document(&$source_node, $lingotek_locale, $sync_succe
 
   if ($node_method == 'node') { //node-based translations
     $node = lingotek_get_translated_node($source_node, $drupal_language_code);
-  } else {
+  }
+  else {
     $node = $source_node;
   }
 
@@ -127,6 +128,12 @@ function lingotek_download_document(&$source_node, $lingotek_locale, $sync_succe
 
   LingotekSync::setTargetStatus($source_node->nid, $lingotek_locale, $sync_success_status); //slightly pre-emptive, but certainly more cohesive
   $node->lingotek_upload_override = 0; // ensure that no upload to lingotek is triggered on node update (in lingotek_node_update)
+
+  //Add entries for entity translation, if applicable
+  if (module_exists('entity_translation') && lingotek_managed_by_entity_translation($node->type)) {
+    lingotek_entity_translation_save_status($node, array($drupal_language_code));
+  }
+
   //Fix for workbench_moderation changing node state after translation download
   if (module_exists('workbench_moderation')) {
     if (isset($node->workbench_moderation)) {
@@ -233,7 +240,7 @@ function lingotek_process_entity_xml($xml, $node, $entity_type, $drupal_language
             }
             $array_key = $target_key[$index];
             $db_field_name = $field['field_name'] . '_' . $array_key;
-            $insert_array[$db_field_name] = decode_entities($text);
+            $insert_array[$db_field_name] = lingotek_unfilter_placeholders(decode_entities($text));
             //$node_field[$drupal_language_code][$delta][$array_key] = decode_entities($text);
             if (isset($node->language) && array_key_exists($node->language, $node_field)) {
               if (array_key_exists('format', $node_field[$node->language][0])) {
@@ -270,6 +277,8 @@ function lingotek_process_entity_xml($xml, $node, $entity_type, $drupal_language
           }
         }
 
+        /* removed conversion of field collection leaves from und to the default language
+         * in favor of using load and presave hooks to sync und and default-language translations
         if ($entity_type == 'field_collection_item') {
           $field_names = array('field_revision_' . $field['field_name'], 'field_data_' . $field['field_name']);
           foreach ($field_names as $table) {
@@ -282,6 +291,8 @@ function lingotek_process_entity_xml($xml, $node, $entity_type, $drupal_language
                 ->execute();
           }
         }
+         * 
+         */
       }
 
       cache_clear_all('field:' . $entity_type . ':' . $node->nid, 'cache_field');
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.batch.inc b/profiles/commons/modules/contrib/lingotek/lingotek.batch.inc
index a92cab6..f0305e9 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.batch.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.batch.inc
@@ -258,14 +258,35 @@ function lingotek_batch_identify_content($front = FALSE) {
   $existing_nids = $result->fetchCol();
   $operations = array();
 
+  global $language;
+  $existing_languages = language_list();
+  unset($existing_languages[$language->language]);
+
   foreach (lingotek_get_content_types() as $type) {
 
     $nodes = node_load_multiple(array(), array('type' => $type));
 
+    $nodes_in_language_field = array();
+    $nodes_in_language_node = array();
+
+    foreach ($existing_languages as $lang) {
+      $nodes_in_language_field[$lang->language] = lingotek_list_entities_with_language('node', $type, $lang->language);
+      $nodes_in_language_node[$lang->language] = lingotek_list_nodes_translated_in_language($type, $lang->language);
+    }
+
     foreach ($nodes as $node) {
       if (!in_array($node->nid, $existing_nids)) {
-        // Add content nodes to lingotek table, to indicate that they are machine translatable nodes
-        $operations[] = array('LingotekSync::setNodeStatus', array($node->nid, LingotekSync::STATUS_EDITED));
+        if ($node->tnid == 0 || $node->tnid == $node->nid) { //skip node translation target nodes
+          // Add content nodes to lingotek table, to indicate that they are machine translatable nodes
+          $operations[] = array('LingotekSync::setNodeStatus', array($node->nid, LingotekSync::STATUS_EDITED));
+
+          foreach ($existing_languages as $lang) {
+            if (in_array($node->nid, $nodes_in_language_field[$lang->language]) || in_array($node->nid, $nodes_in_language_node[$lang->language])) {
+              $lingotek_locale = Lingotek::convertDrupal2Lingotek($lang->language);
+              lingotek_lingonode($node->nid, 'target_sync_status_' . $lingotek_locale, LingotekSync::STATUS_CURRENT);
+            }
+          }
+        }
       };
     }
   }
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.bulk_grid.inc b/profiles/commons/modules/contrib/lingotek/lingotek.bulk_grid.inc
index 6ab8019..94c66a9 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.bulk_grid.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.bulk_grid.inc
@@ -13,12 +13,13 @@ function lingotek_bulk_grid_form($form, $form_state) {
    * Here we store or retrieve the GET parameters so that the state of the table is maintained when leaving and coming back
    * Also makes it so the state is not lost when performing bulk actions
    */
-  if(count($_GET) == 1 && isset($_SESSION['grid_custom_parameters']) && !empty($_SESSION['grid_custom_parameters'])) {
+  if (count($_GET) == 1 && isset($_SESSION['grid_custom_parameters']) && !empty($_SESSION['grid_custom_parameters'])) {
     $_SESSION['grid_custom_parameters']['preventloop'] = TRUE;
     drupal_goto('admin/settings/lingotek/manage/list', array('query' => $_SESSION['grid_custom_parameters']));
-  } else {
+  }
+  else {
     $_SESSION['grid_custom_parameters'] = $_GET;
-    if($_SESSION['grid_custom_parameters']['q']) {
+    if ($_SESSION['grid_custom_parameters']['q']) {
       unset($_SESSION['grid_custom_parameters']['q']);
     }
   }
@@ -48,6 +49,7 @@ function lingotek_bulk_grid_form($form, $form_state) {
     'reset' => t('Disassociate Translations'),
 //    'delete' => t('Delete Nodes'),
     'edit' => t('Edit Translation Settings'),
+    'workflow' => t('Change Workflow'),
     'Download' => array('download_all' => t('Download All Translations')),
   );
 
@@ -68,32 +70,38 @@ function lingotek_bulk_grid_form($form, $form_state) {
   $page = pager_find_page(); // Get current page from url
   
   $form['customize'] = array(
-    '#markup' => l('<i class="icon-list-alt icon-2x" ></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/customize', array('html' => TRUE, 'attributes' => array('title' => 'Customize Table', 'class' => array('ctools-use-modal', 'ctools-modal-customize-table', 'lingotek-action')))),
+    '#markup' => l('<i class="fa fa-list-alt fa-2x" ></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/customize', array('html' => TRUE, 'attributes' => array('title' => t('Customize Table'), 'class' => array('ctools-use-modal', 'ctools-modal-customize-table', 'lingotek-action')))),
   );
   /*$form['filter_popup'] = array(
-    '#markup' => l('<i class="icon-search icon-2x"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters', array('html' => TRUE, 'attributes' => array('title' => 'Set Filters', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters', 'lingotek-action')))),
+    '#markup' => l('<i class="fa-search fa-2x"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters', array('html' => TRUE, 'attributes' => array('title' => 'Set Filters', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters', 'lingotek-action')))),
   );*/
   $last_updated = variable_get('lingotek_pending_last_updated', NULL);
   $message = t('Check in-progress translation statuses (Last checked @time)', array('@time' => $last_updated ? lingotek_human_readable_timestamp($last_updated) . ' ago' : 'Never'));
   $form['refresh'] = array(
-    '#markup' => l('<i class="icon-refresh icon-2x ltk-refresh"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/update', array('html' => TRUE, 'attributes' => array('class' => 'lingotek-action', 'title' => $message))),
+    '#markup' => l('<i class="fa fa-refresh fa-2x ltk-refresh"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/update', array('html' => TRUE, 'attributes' => array('class' => 'lingotek-action', 'title' => $message))),
   );
   $form['lingotek_update'] = array(
-    '#markup' => l('<i class="icon-cloud-download icon-2x ltk-download"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/download-ready', array('html' => TRUE, 'attributes' => array('title' => 'Download complete translations', 'class' => array('lingotek-action')))),
+    '#markup' => l('<i class="fa fa-cloud-download fa-2x ltk-download"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/download-ready', array('html' => TRUE, 'attributes' => array('title' => t('Download complete translations'), 'class' => array('lingotek-action')))),
   );
   
   $form['edit_settings'] = array(
-    '#markup' => l('Edit Settings', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/edit', array('attributes' => array('id' => 'edit-settings-link', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters')))),
+    '#markup' => l(t('Edit Settings'), LINGOTEK_MENU_MAIN_BASE_URL . '/manage/edit', array('attributes' => array('id' => 'edit-settings-link', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters')))),
 
   );
   $form['disassociate_translations'] = array(
-    '#markup' => l('Disassociate Translations', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/reset', array('attributes' => array('id' => 'reset-translations-link', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters')))),
+    '#markup' => l(t('Disassociate Translations'), LINGOTEK_MENU_MAIN_BASE_URL . '/manage/reset', array('attributes' => array('id' => 'reset-translations-link', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters')))),
   );
+
+  if (LingotekAccount::instance()->isEnterprise()) {
+    $form['change_workflow'] = array(
+      '#markup' => l(t('Change Workflow'), LINGOTEK_MENU_MAIN_BASE_URL . '/manage/change-workflow', array('attributes' => array('id' => 'change-workflow-link', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters')))),
+    );
+  }
   
   $form['search'] = array(
     '#type' => 'textfield',
     '#default_value' => isset($_SESSION['grid_filters']['search']) ? $_SESSION['grid_filters']['search'] : '',
-    '#title' => l('<i class="icon-search"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters', array('html' => TRUE, 'attributes' => array('title' => 'Advanced Search', 'class' => array('ctools-use-modal', 'ctools-modal-set-filters','ltk-action')))) . ' ' . t('Search') . ': ',
+    '#title' => l('<i class="fa fa-search"></i>', LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters', array('html' => TRUE, 'attributes' => array('title' => t('Advanced Search'), 'class' => array('ctools-use-modal', 'ctools-modal-set-filters', 'ltk-action')))) . ' ' . t('Search') . ': ',
     '#size' => 30,
   );
 
@@ -117,28 +125,30 @@ function lingotek_bulk_grid_form($form, $form_state) {
     
   $filter_set = FALSE;
   
-  if(isset($_SESSION['grid_filters'])) {  
-    foreach($_SESSION['grid_filters'] as $key => $value) {
-      if(is_array($value)) {
+  if (isset($_SESSION['grid_filters'])) {  
+    foreach ($_SESSION['grid_filters'] as $key => $value) {
+      if (is_array($value)) {
         $keys = array_keys($value);
-        if(count($keys) == 1) {
-          if($keys[0] != ''  && $keys[0]  != 'all') {
+        if (count($keys) == 1) {
+          if ($keys[0] != ''  && $keys[0]  != 'all') {
             $filter_set = TRUE;
           }
-        } elseif(count($keys) > 1) {
+        }
+        elseif (count($keys) > 1) {
           $filter_set = TRUE;
         }
-      } else {
-        if(!empty($value) && $value != 'all') {
+      }
+      else {
+        if (!empty($value) && $value != 'all') {
           $filter_set = TRUE;
         }
       }
     }
   }
   
-  if($filter_set) {
+  if ($filter_set) {
     $form['filter_message'] = array(
-      '#markup' => t('') .' ' . l('<i class="icon-remove"></i> ' . t('Clear Filters'), LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters/clear', array('html' => TRUE)) . '',
+      '#markup' => ' ' . l('<i class="fa fa-times" style="margin-right: 5px;"></i>' . t('Clear Filters'), LINGOTEK_MENU_MAIN_BASE_URL . '/manage/filters/clear', array('html' => TRUE)) . '',
     );
   }
   
@@ -146,7 +156,7 @@ function lingotek_bulk_grid_form($form, $form_state) {
   $form['actions_select'] = array(
     '#type' => 'select',
     '#options' => $action_options,
-    '#title' => '<i class="icon-asterisk ltk-muted"></i>' . ' ' . t('Actions') . ': ',
+    '#title' => '<i class="fa fa-asterisk ltk-muted"></i>' . ' ' . t('Actions') . ': ',
   );
 
   // Actions submit button
@@ -162,7 +172,7 @@ function lingotek_bulk_grid_form($form, $form_state) {
     '#type' => 'container',
     '#attached' => array(
       'css' => array(
-        '//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css' => array(
+        '//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css' => array(
           'type' => 'external',
         ),
       ),
@@ -228,11 +238,11 @@ function lingotek_bulk_grid_form($form, $form_state) {
     );
   }
 
-  if(count($table_data) >= 10) {
+  if (count($table_data) >= 10) {
     $form['limit_select'] = array(
       '#type' => 'select',
       '#prefix' => '<div id="page-limit">',
-      '#suffix' =>  t(' results per page') . '</div>',
+      '#suffix' =>  ' ' . t('results per page') . '</div>',
       '#options' => array(
         10 => '10',
         25 => '25',
@@ -288,7 +298,7 @@ function lingotek_filters_popup() {
   
   $form = array();
   $form_state = array(
-    'ajax' => true,
+    'ajax' => TRUE,
   );
   $output = ctools_modal_form_wrapper('lingotek_filters_popup_form', $form_state);
   
@@ -343,7 +353,7 @@ function lingotek_grid_customize() {
   ctools_include('ajax');
   
   $form_state = array(
-    'ajax' => true,
+    'ajax' => TRUE,
   );
   $output = ctools_modal_form_wrapper('lingotek_grid_customize_form', $form_state);
   
@@ -363,9 +373,10 @@ function lingotek_grid_customize() {
 
 function lingotek_grid_filter_inline_submit($form, $form_state) {
   $_SESSION['grid_filters']['search_type'] = $form_state['values']['search_type'];
-  if(!empty($form_state['values']['search'])) {
+  if (!empty($form_state['values']['search'])) {
     $_SESSION['grid_filters']['search'] = $form_state['values']['search'];
-  } else {
+  }
+  else {
     unset($_SESSION['grid_filters']['search']);
     unset($_SESSION['grid_filters']['search_type']);
   }
@@ -374,11 +385,11 @@ function lingotek_grid_filter_inline_submit($form, $form_state) {
   if ($form_state['values']['search_type'] == 'title') {
     $_SESSION['grid_filters']['title'] = $form_state['values']['search'];
   }
-  else if ($form_state['values']['search_type'] == 'body') {
+  elseif ($form_state['values']['search_type'] == 'body') {
     $_SESSION['grid_filters']['body'] = $form_state['values']['search'];
   }
 
-  if(isset($form_state['values']['limit_select'])) {
+  if (isset($form_state['values']['limit_select'])) {
     $_SESSION['limit_select'] = $form_state['values']['limit_select'];
   }
 }
@@ -462,16 +473,16 @@ function lingotek_grid_action_submit($form, $form_state) {
       elseif (substr($action, 0, 8) == 'download') { // If downloading all targets
         $lang = substr($action, 9, 10);
         $target_locales = ($lang == 'all') ? lingotek_get_target_locales() : array($lang);
-        $document_ids = LingotekSync::getDocIdsFromNodeIds($nids);
+        $document_ids_map = LingotekSync::getDocIdsFromNodeIds($nids, $associate = TRUE);
         $complete_targets = array();
         $incomplete_targets = array();
         
         // We need to check all pending nodes to see if they are READY so that in the end the status is correct.
         $pending_document_ids = array();
-        foreach ($document_ids as $doc_id) {
-          $status = lingotek_lingonode($doc_id, 'node_sync_status');
+        foreach ($document_ids_map as $nid => $nid_obj) {
+          $status = lingotek_lingonode($nid, 'node_sync_status');
           if ($status != LingotekSync::STATUS_CURRENT && $status != LingotekSync::STATUS_READY) {
-            $pending_document_ids[] = $doc_id;
+            $pending_document_ids[] = $nid_obj->doc_id;
           }
         }
         lingotek_get_and_update_target_progress($pending_document_ids);
@@ -483,7 +494,8 @@ function lingotek_grid_action_submit($form, $form_state) {
           if (!empty($complete_nids)) {
             $complete_doc_ids = LingotekSync::getDocIdsFromNodeIds($complete_nids);
           }
-          foreach ($document_ids as $doc_id) {
+          foreach ($document_ids_map as $nid_obj) {
+            $doc_id = $nid_obj->doc_id;
             if (in_array($doc_id, $complete_doc_ids)) { // If workflow completed, create target json
               $complete_targets[] = (object) array('document_id' => $doc_id, 'locale' => $language);
             }
@@ -518,6 +530,10 @@ function lingotek_grid_action_submit($form, $form_state) {
         $_SESSION['lingotek_edit_nodes'] = $nids;
         drupal_goto('admin/settings/lingotek/manage/edit/'); // Redirect to the edit Lingotek node settings form - for multiple nodes, form defaults are global defaults
       }
+      elseif ($action == 'workflow') { // If changing the workflow
+        $_SESSION['lingotek_change_workflow'] = $nids;
+        drupal_goto('admin/settings/lingotek/manage/change-workflow/'); // Redirect to the change-workflow settings form - for multiple nodes, form defaults are global defaults
+      }
       elseif ($action == 'sync') { // If syncing the progress
         $_SESSION['lingotek_sync_nodes'] = count($nids);
         lingotek_update_target_progress_batch_create($nids); // Run batch operations to get the progress report from Lingotek
@@ -575,6 +591,11 @@ function lingotek_grid_build_column_checkboxes($form_state) {
       '#title' => t('Translation Progress'),
       '#default_value' => isset($_SESSION['grid_custom'][$prefix . 'translation_progress' . $suffix]) ? $_SESSION['grid_custom'][$prefix . 'translation_progress' . $suffix] : in_array('translation_progress', $columns['defaults']),
     ),
+    'workflow' => array(
+      '#type' => 'checkbox',
+      '#title' => t('Workflow'),
+      '#default_value' => isset($_SESSION['grid_custom'][$prefix . 'workflow' . $suffix]) ? $_SESSION['grid_custom'][$prefix . 'workflow' . $suffix] : in_array('workflow', $columns['defaults']),
+    ),
     'changed' => array(
       '#type' => 'checkbox',
       '#title' => t('Last Modified'),
@@ -636,14 +657,14 @@ function lingotek_grid_download_ready() {
   if (!empty($targets)) {
 
     $nids = array();
-    foreach($targets as $target){
+    foreach ($targets as $target) {
       $nids[] = $target['nid'];
     }
     $nodes = node_load_multiple($nids);
     
     $operations = array();
     foreach ($targets as $target) {
-      if($nodes[$target['nid']]->lingotek['profile'] != LingotekSync::PROFILE_DISABLED) { // exclude nodes with PROFILE_DISABLED
+      if ($nodes[$target['nid']]->lingotek['profile'] != LingotekSync::PROFILE_DISABLED) { // exclude nodes with PROFILE_DISABLED
         $operations[] = array('lingotek_sync_download_node_target', array($target['nid'], $target['locale'], $sync_success_target, FALSE));
       }
     }
@@ -721,6 +742,7 @@ function lingotek_grid_define_columns() {
       'translations',
       'configuration',
       'document_id',
+      'workflow',
       'changed',
       'last_uploaded',
       'translation_progress_percent',
@@ -750,7 +772,7 @@ function lingotek_grid_define_columns() {
 function lingotek_grid_build_filters($form_state) {
   $languages = language_list();
   $source_languages = array('all' => 'All Languages');
-  foreach($languages as $code => $language) {
+  foreach ($languages as $code => $language) {
     $source_languages[$code] = $language->name . ' (' . $language->lingotek_locale . ')';
   }
   
@@ -760,7 +782,7 @@ function lingotek_grid_build_filters($form_state) {
   $profiles[LingotekSync::PROFILE_DISABLED] = 'Disabled';
   
   $profile_defaults = lingotek_get_profiles();
-  foreach($profile_defaults as $key => $p) {
+  foreach ($profile_defaults as $key => $p) {
     $profiles[$key] = $p['name'];
   }
   
@@ -986,11 +1008,12 @@ function lingotek_grid_get_rows($form, &$form_state) {
 
   $header = array(// Define the tentative source header
     'nid' => array('data' => t('Node ID'), 'field' => 'n.nid'),
-    'content_type' => array('data' => t('Content Type'), 'field' => 'n.type'),
     'title' => array('data' => t('Title'), 'field' => 'n.title'),
+    'content_type' => array('data' => t('Content Type'), 'field' => 'n.type'),
     'language' => array('data' => t('Source Uploaded'), 'field' => 'upload_status'),
     'translations' => array('data' => t('Translations'), 'field' => 't_current_c'),
     'configuration' => array('data' => t('Profile')),
+    'workflow' => array('data' => t('Workflow'), 'field' => 'workflow'),
     'document_id' => array('data' => t('Doc ID'), 'field' => 'document_id'),
     'changed' => array('data' => t('Last Modified'), 'field' => 'changed', 'sort' => 'desc'),
     'last_uploaded' => array('data' => t('Last Uploaded'), 'field' => 'last_uploaded'),
@@ -998,7 +1021,6 @@ function lingotek_grid_get_rows($form, &$form_state) {
     'actions' => array('data' => t('Actions')),
     'translation_status' => array('data' => t('Translation Status')),
     'translation_progress' => array('data' => t('Translation Progress')),
-    //    'workflow' => array('data' => 'Workflow', 'field' => 'workflow'),
     'locale_progress_percent' => array('data' => t('Target Progress'), 'field' => 'locale_progress_percent'),
     'progress_updated' => array('data' => t('Progress Updated'), 'field' => 'progress_updated'),
     'last_downloaded' => array('data' => t('Last Downloaded'), 'field' => 'last_downloaded'),
@@ -1015,6 +1037,9 @@ function lingotek_grid_get_rows($form, &$form_state) {
   $query = db_select('node', 'n')
       ->extend('PagerDefault')
       ->extend('TableSort');
+
+  $query->innerJoin('node', 'node2', '(n.nid = node2.nid) AND (node2.tnid = 0 OR node2.tnid = node2.nid)');
+
   $query->limit($limit);
   $query->orderByHeader($form_state['values']['grid_header']);
 
@@ -1043,7 +1068,7 @@ function lingotek_grid_get_rows($form, &$form_state) {
   $query->addField('lingo_document_id', 'lingovalue', 'document_id');
 
   // Node Upload Status
-  $query->leftJoin('lingotek', 'lingo_upload_status', 'lingo_upload_status.nid = n.nid and lingo_upload_status.lingokey = \'node_sync_status\' and lingo_upload_status.lingovalue <> \''. LingotekSync::STATUS_TARGET . '\'');
+  $query->leftJoin('lingotek', 'lingo_upload_status', 'lingo_upload_status.nid = n.nid and lingo_upload_status.lingokey = \'node_sync_status\' and lingo_upload_status.lingovalue <> \'' . LingotekSync::STATUS_TARGET . '\'');
   //$query->leftJoin('lingotek', 'lingo_upload_status', 'lingo_upload_status.nid = n.nid and lingo_upload_status.lingokey = \'node_sync_status\'');
   //$query->condition('lingo_upload_status.lingovalue', LingotekSync::STATUS_TARGET, '<>');
   $query->addField('lingo_upload_status', 'lingovalue', 'upload_status');
@@ -1162,7 +1187,6 @@ function lingotek_grid_get_rows($form, &$form_state) {
 
   if (isset($filters['profile']) && $filters['profile'] != 'all') {
     $or = lingotek_profile_condition('n', 'lingo_auto_upload', 'lingo_profile', $filters['profile']);
-
     $query->condition($or);
   }
 
@@ -1281,55 +1305,37 @@ function lingotek_grid_get_rows($form, &$form_state) {
   $languages = language_list();
   $profiles = lingotek_get_profiles();
   
+  $api = LingotekApi::instance();
+  $workflows = $api->listWorkflows();
+  
   $types = _node_types_build()->types;
 
   // Parse returned objects and make them arrays keyed by the Node ID for clean use in The Grid.
   foreach ($table_data_raw as $row) {
     // RENAMING
-    $title_truncate_length = 70;
+    $title_truncate_length = 55;
     if (strlen($row->title) > $title_truncate_length) { // very long title names make The Grid look messy, so we truncate them.
       $dots = '...';
       $dots_length = strlen($dots);
       $row->title = substr($row->title, 0, $title_truncate_length - $dots_length) . $dots;
     }
-    $translation_progress = NULL;
     $icon = '';
     if ($row->lingotek['profile'] == LingotekSync::PROFILE_DISABLED) {
       $row->upload_status = LingotekSync::STATUS_DISABLED;
     }
-    if (!is_null($row->upload_status)) {
-      if (isset($row->upload_status)) {
-        $translation_status = $row->upload_status;
-        if ($row->upload_status == LingotekSync::STATUS_EDITED) {
-          $icon = '<i class="icon-check-empty" title="Needs to be uploaded"></i>';
-        }
-        elseif ($row->upload_status == LingotekSync::STATUS_CURRENT) {
-          $icon = '<i class="icon-check" title="Uploaded to Lingotek"></i>';
-        }
-        elseif ($row->upload_status == LingotekSync::STATUS_DISABLED) {
-          $icon = '<i class="icon-lock" title="Document is locked"></i>';
-        }
-        else {
-          
-        }
-      }
-//        if ($translation_status == LingotekSync::STATUS_EDITED) {
-//            $translation_progress = l('Source Needs Upload', 'node/' . $row->nid . '/lingotek_pm', array('attributes' => array('target' => '_blank')));
-//        }
-//        elseif (!is_null($row->translation_status)) {
-//          if ($row->translation_status == LingotekSync::STATUS_PENDING) {
-//            $translation_progress = l('In Progress', 'node/' . $row->nid . '/lingotek_pm', array('attributes' => array('target' => '_blank')));
-//          }
-//          elseif ($row->translation_status == LingotekSync::STATUS_READY) {
-//            $translation_progress = l('Ready for Download', 'node/' . $row->nid . '/lingotek_pm', array('attributes' => array('target' => '_blank')));
-//          }
-//          elseif ($row->translation_status == LingotekSync::STATUS_CURRENT) {
-//            $translation_progress = t('Complete');
-//          }
-//          elseif ($row->translation_status == LingotekSync::STATUS_DISABLED) {
-//            $translation_progress = t('Disabled');
-//          }
-//        }
+    switch ($row->upload_status) {
+      case LingotekSync::STATUS_EDITED:
+        $icon = '<i class="fa fa-square-o" title="Needs to be uploaded"></i>';
+        break;
+      case LingotekSync::STATUS_CURRENT:
+        $icon = '<i class="fa fa-check-square" title="Uploaded to Lingotek"></i>';
+        break;
+      case LingotekSync::STATUS_DISABLED:
+        $icon = '<i class="fa fa-minus-square" style="color: #999;" title="Lingotek is disabled"></i>';
+        break;
+      default:
+        $icon = '<i class="fa fa-minus-square" style="color: #999;" title="Unknown upload status"></i>';
+        break;
     }
 
     $list_statuses = array('pending', 'ready', 'current', 'edited');
@@ -1356,19 +1362,19 @@ function lingotek_grid_get_rows($form, &$form_state) {
     $disabled = $row->upload_status == LingotekSync::STATUS_DISABLED ? ' lingotek-disabled' : '';
 
     if ($row->lingotek['create_lingotek_document']) {
-      $configuration .= '<i class="icon-arrow-up' . $disabled . '" title="Automatic Upload"></i> ';
+      $configuration .= '<i class="fa fa-arrow-up' . $disabled . '" title="Automatic Upload"></i> ';
     }
     if ($row->lingotek['sync_method']) {
-      $configuration .= '<i class="icon-arrow-down' . $disabled . '" title="Automatic Download"></i> ';
+      $configuration .= '<i class="fa fa-arrow-down' . $disabled . '" title="Automatic Download"></i> ';
     }
     if ($row->lingotek['allow_community_translation']) {
-      $configuration .= '<i class="icon-globe' . $disabled . '" title="Crowdsourcing Enabled"></i> ';
+      $configuration .= '<i class="fa fa-globe' . $disabled . '" title="Crowdsourcing Enabled"></i> ';
     }
 
     if ($row->lingotek['profile'] == LingotekSync::PROFILE_CUSTOM) {
       $configuration = t('Custom') . ' <span class="node-configuration">' . $configuration . '</span>';
     }
-    else if ($row->lingotek['profile'] == LingotekSync::PROFILE_DISABLED) {
+    elseif ($row->lingotek['profile'] == LingotekSync::PROFILE_DISABLED) {
       $configuration = t('Disabled');
     }
     else {
@@ -1382,19 +1388,19 @@ function lingotek_grid_get_rows($form, &$form_state) {
     }
 
 
-    $source = '<span class="lingotek-language-source" style="white-space: nowrap;">' . $icon . ' ' . ($row->language == 'und' ? 'Language Undefined' : $languages[$row->language]->name) . '</span>';
+    $source = '<span class="lingotek-language-source" style="white-space: nowrap;">' . $icon . ' ' . ($row->language == 'und' ? t('None') : $languages[$row->language]->name) . '</span>';
 
     if (empty($row->upload_status) || $row->upload_status == LingotekSync::STATUS_EDITED) {
-      $source = '<span title="Upload Now" class="upload-button lingotek-language-source" onclick="lingotek_perform_action(' . $row->nid . ',\'upload\')">' . $source . '</span>';
+      $source = '<span title="Upload Now" class="ltk-upload-button lingotek-language-source" onclick="lingotek_perform_action(' . $row->nid . ',\'upload\')">' . $source . '</span>';
     }
 
-    $pm_icon = ' <i title="View Translations" class="icon-tasks' . $disabled . '"></i>';
+    $pm_icon = ' <i title="' . t('View Translations') . '" class="fa fa-tasks' . $disabled . '"></i>';
     $pm_link = ' ' . l($pm_icon, 'node/' . $row->nid . '/lingotek_pm', array('html' => TRUE, 'attributes' => array('target' => '_blank')));
 
     $actions = '';
-    $actions .= l('<i title="Edit Node" class="icon-edit"></i>', 'node/' . $row->nid . '/edit', array('html' => TRUE, 'attributes' => array('target' => '_blank')));
+    $actions .= l('<i title="' . t('Edit Node') . '" class="fa fa-edit"></i>', 'node/' . $row->nid . '/edit', array('html' => TRUE, 'attributes' => array('target' => '_blank')));
+    $actions .= ' ' . l('<i title="' . t('Set Lingotek Settings') . '" class="fa fa-gear"></i>', '', array('html' => TRUE, 'attributes' => array('onclick' => 'lingotek_perform_action(' . $row->nid . ',"edit"); return false;')));
     $actions .= empty($disabled) ? $pm_link : $pm_icon;
-    $actions .= ' ' . l('<i title="Set Lingotek Settings" class="icon-gear"></i>', '', array('html' => TRUE, 'attributes' => array('onclick' => 'lingotek_perform_action(' . $row->nid . ',"edit"); return false;')));
 
     $no_localized_title = (language_default()->language != $language->language) && $row->localized_title == '';
 
@@ -1414,6 +1420,7 @@ function lingotek_grid_get_rows($form, &$form_state) {
 //        'locale_progress_percent' => $row->locale_progress_percent ? lingotek_grid_create_progress_bar($row->locale_progress_percent) : lingotek_grid_create_progress_bar(0),
 //        'progress_updated' => $row->progress_updated ? t('@time ago', array('@time' => lingotek_human_readable_timestamp($row->progress_updated))) : t('Never'),
 //        'last_downloaded' => $row->last_downloaded ? t('@time ago', array('@time' => lingotek_human_readable_timestamp($row->last_downloaded))) : t('Never'),
+      'workflow' => ($row->workflow ? check_plain($workflows[$row->workflow]) : ''),
       'actions' => '<span class="lingotek-node-actions">' . $actions . '</span>',
     );
 
@@ -1482,7 +1489,7 @@ function lingotek_grid_create_progress_bar($progress) {
 function lingotek_disassociate_nodes($nids) {
   $second_run = !empty($form_state['executed']);
   
-  $nids = explode(',',$nids);
+  $nids = explode(',', $nids);
   
   if (count($nids) > 1 && !$second_run) {
     drupal_set_message(t('You will be disassociating translations for @number nodes.', array('@number' => count($nids))), 'warning');
@@ -1493,7 +1500,7 @@ function lingotek_disassociate_nodes($nids) {
   ctools_include('ajax');
   
   $form_state = array(
-    'ajax' => true,
+    'ajax' => TRUE,
     'nids' => $nids,
   );
   $output = ctools_modal_form_wrapper('lingotek_node_disassociate_form', $form_state);
@@ -1525,7 +1532,7 @@ function lingotek_edit_nodes($nids) {
   ctools_include('ajax');
     
   $form_state = array(
-    'ajax' => true,
+    'ajax' => TRUE,
     'nids' => $nids,
   );
   $output = ctools_modal_form_wrapper('lingotek_get_node_settings_form', $form_state);
@@ -1541,3 +1548,35 @@ function lingotek_edit_nodes($nids) {
     
   print ajax_render($output);
 }
+
+/**
+ * Callback function to change workflow for multiple nodes at a time
+ *
+ * Node IDs are passed through the $_SESSION variable at $_SESSION['lingotek_change_workflow']
+ *
+ * Returns a fully rendered html form
+ */
+function lingotek_change_workflow($nids) {
+  $nids = explode(',', $nids);
+
+  ctools_include('node.pages', 'node', '');
+  ctools_include('modal');
+  ctools_include('ajax');
+    
+  $form_state = array(
+    'ajax' => TRUE,
+    'nids' => $nids,
+  );
+  $output = ctools_modal_form_wrapper('lingotek_get_change_workflow_form', $form_state);
+  
+  if (!empty($form_state['executed'])) {
+    // Create ajax command array, dismiss the modal window.
+    $commands = array();
+    $commands[] = ctools_modal_command_dismiss();
+    $commands[] = ctools_ajax_command_reload();
+    print ajax_render($commands);
+    drupal_exit();
+  }
+    
+  print ajax_render($output);
+}
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.define.inc b/profiles/commons/modules/contrib/lingotek/lingotek.define.inc
index 25cf61a..e53bc8e 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.define.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.define.inc
@@ -75,4 +75,5 @@ lingotek_define('STDERR', fopen('php://stderr', 'w'));
 /**
  * Define file-processing timeout
  */
-lingotek_define('LINGOTEK_FILE_PROCESS_TIMEOUT', 120);
\ No newline at end of file
+lingotek_define('LINGOTEK_FILE_PROCESS_TIMEOUT', 120);
+lingotek_define('LINGOTEK_DEFAULT_WORKFLOW_TEMPLATE', 2);
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.info b/profiles/commons/modules/contrib/lingotek/lingotek.info
index 5b0b609..739f76c 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.info
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.info
@@ -41,16 +41,15 @@ files[] = lib/Drupal/lingotek/LingotekTranslatableEntity.php
 
 files[] = tests/lingotek.base.test
 files[] = tests/lingotek.access.test
-files[] = tests/lingotek.advanced_parsing.test
 files[] = tests/lingotek.setup.test
 
 files[] = lingotek_views_handler_workbench_link.inc
 
 stylesheets[all][] = style/base.css
 
-; Information added by drupal.org packaging script on 2013-10-15
-version = "7.x-4.06"
+; Information added by  packaging script on 2013-11-28
+version = "7.x-4.10"
 core = "7.x"
 project = "lingotek"
-datestamp = "1381859891"
+datestamp = "1385597617"
 
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.install b/profiles/commons/modules/contrib/lingotek/lingotek.install
index 6a7a940..dad8241 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.install
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.install
@@ -514,19 +514,19 @@ function lingotek_update_7401(&$sandbox) {
  */
 function lingotek_update_7403(&$sandbox) {
   $translate_fields = variable_get('lingotek_translate_fields');
-  if(empty($translate_fields)) {
+  if (empty($translate_fields)) {
 
     $types = _node_types_build()->types;
     $translate_fields = array();
 
-    foreach($types as $t) {
+    foreach ($types as $t) {
       $translation_setting = variable_get('language_content_type_' . $t->type);
-      if($translation_setting == 'lingotek') {
+      if ($translation_setting == 'lingotek') {
         variable_set('language_content_type_' . $t->type, "1");
         $fields = field_info_instances("node", $t->type);
-        foreach($fields as $field_name => $instance) {
+        foreach ($fields as $field_name => $instance) {
           $field = field_info_field($field_name);
-          if($field['translatable'] && $field['lingotek_translatable'] == 1) {
+          if ($field['translatable'] && $field['lingotek_translatable'] == 1) {
             $translate_fields[$t->type][] = $field_name;
           }
         }
@@ -557,7 +557,7 @@ function lingotek_update_7404(&$sandbox) {
   }
 
   $entity_profiles = variable_get('lingotek_entity_profiles');
-  if(empty($entity_profiles)) {
+  if (empty($entity_profiles)) {
     $fields = variable_get('lingotek_translate_fields');
 
     $entity_profiles = array();
@@ -580,4 +580,30 @@ function lingotek_update_7406(&$sandbox) {
 
   variable_set('lingotek_enabled_fields', $enabled_fields);
   variable_del('lingotek_translate_fields');
-}
\ No newline at end of file
+}
+
+/**
+ * Creates an upgrade path for existing translated content to be inserted into entity_translation module table if necessary
+ */
+function lingotek_update_7408(&$sandbox) {
+  if (module_exists('entity_translation')) {
+    $nid_list = array();
+    $results = db_select('lingotek', 'l')
+      ->fields('l', array('nid', 'lingokey'))
+      ->condition('lingokey', 'target_sync_status_%', 'LIKE')
+      ->condition('lingovalue', LingotekSync::STATUS_CURRENT)
+      ->execute();
+    foreach ($results as $r) {
+      $nid_list[$r->nid] = str_replace('target_sync_status_', '', $r->lingokey);
+    }
+    
+    foreach ($nid_list as $nid => $locale) {
+      $node = lingotek_node_load_default($nid, NULL, TRUE);
+      if ($node) {
+        if (lingotek_managed_by_entity_translation($node->type)) {
+          lingotek_entity_translation_save_status($node, array(Lingotek::convertLingotek2Drupal($locale)));
+        }
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.module b/profiles/commons/modules/contrib/lingotek/lingotek.module
index 1f5fe85..b2cadf4 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.module
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.module
@@ -258,6 +258,14 @@ function lingotek_menu() {
     'type' => MENU_CALLBACK,
   );
 
+  $items[LINGOTEK_MENU_MAIN_BASE_URL . '/manage/change-workflow/%'] = array(
+    'access arguments' => array('administer lingotek'),
+    'file' => 'lingotek.bulk_grid.inc',
+    'page callback' => 'lingotek_change_workflow',
+    'page arguments' => array(5),
+    'type' => MENU_CALLBACK,
+  );
+
   $items[LINGOTEK_MENU_MAIN_BASE_URL . '/manage/reset/%'] = array(
     'access arguments' => array('administer lingotek'),
     'file' => 'lingotek.page.inc',
@@ -337,12 +345,12 @@ function lingotek_menu() {
     'access arguments' => array('administer lingotek')
   );
 
-  $items['admin/config/lingotek/community-settings-select'] = array(
+  $items['admin/config/lingotek/project-vault-select'] = array(
     'title' => 'Choose Your Project, Workflow, and TM Vault',
-    'description' => 'Select project, workflow, and TM vault to use.',
+    'description' => 'Select project, workflow, and translation memory vault to use.',
     'file' => 'lingotek.setup.inc',
     'page callback' => 'drupal_get_form',
-    'page arguments' => array('lingotek_community_settings_select_form'),
+    'page arguments' => array('lingotek_project_vault_select_form'),
     'type' => MENU_CALLBACK,
     'access arguments' => array('administer lingotek')
   );
@@ -582,25 +590,13 @@ function lingotek_form_node_form_alter(&$form, $form_state, $form_id) {
   }
   $is_enterprise = LingotekAccount::instance()->isEnterprise();
 
-  //$translation_edit_link = l(lingotek_language_field_lookup('native', $lingotek_locale), '', array('attributes' => array('onclick' => 'window.open(\'' . lingotek_get_workbench_url($node, $lingotek_locale) . '\'); return false;')));
-
-
-  $node = lingotek_empty_node();
-  $document_id = FALSE;
   if (isset($form['nid']['#value'])) {
     $nid = $form['nid']['#value'];
     $node = lingotek_node_load_default($nid);
-    $document_id = isset($node->lingotek['document_id']) ? $node->lingotek['document_id'] : '';
   }
   else {
     $node = $form['#node'];
-    $profile_default = lingotek_load_profile_defaults('node');
-    $node->lingotek = lingotek_get_global_profile();
-    if(isset($profile_default[$node->type])) {
-      $node->lingotek = array_merge($node->lingotek, $profile_default[$node->type]);
-    } else {
-      $node->lingotek['profile'] = LingotekSync::PROFILE_DISABLED;
-    }
+    lingotek_node_load(array($node), array());
   }
     
   global $language;
@@ -622,12 +618,65 @@ function lingotek_form_node_form_alter(&$form, $form_state, $form_id) {
   }
 
   $form = array_merge($form, lingotek_get_node_settings_form($form, $form_state, $node));
-      
+ 
+  $api = LingotekApi::instance();
+
+  // show workflow-change option only if there are more than one workflow and if it's an existing node
+  $workflows = $api->listWorkflows();
+  if ($workflows && count($workflows) > 1) {
+    $form['lingotek']['workflow_id'] = array(
+      '#type' => 'select',
+      '#title' => t('Workflow'),
+      '#prefix' => '<div id="prefill-phases-div">',
+      '#description' => t('Choose the Workflow to associate with this content item.'),
+      '#default_value' => $node->lingotek['workflow_id'],
+      '#options' => $workflows,
+      '#empty_option' => '(select one)',
+    );
+    if (!$nid) { // don't show prefill stuff on new nodes 
+      $form['lingotek']['workflow_id']['#suffix'] = '</div>';
+    }
+    else {
+      // add the callback and checkbox and phase-select
+      $form['lingotek']['workflow_id']['#ajax'] = array(
+        'callback' => 'lingotek_get_change_workflow_form_callback',
+        'wrapper' => 'prefill-phases-div',
+        'method' => 'replace',
+        'effect' => 'fade',
+      );
+      $form['lingotek']['prefill_phases_checkbox'] = array(
+        '#type' => 'checkbox',
+        '#title' => t('Restore to a phase in the new workflow'),
+        '#default_value' => TRUE,
+        '#description' => t('Prefill the new workflow with translations from the previous workflow'),
+        '#states' => array(
+          'invisible' => array(':input[name="lingotek[workflow_id]"]' => array('value' => $node->lingotek['workflow_id'])),
+        )
+      );
+
+      $form['lingotek']['prefill_phase_select'] = array(
+        '#title' => t("Desired Prefill Phase"),
+        '#description' => t('Please select the highest phase which should be prefilled for the new workflow'),
+        '#type' => 'select',
+        '#states' => array(
+            'visible' => array(':input[name="lingotek[workflow_id]"]' => array('!value' => $node->lingotek['workflow_id']),
+                           array(':input[name="lingotek[prefill_phases_checkbox]"]' => array('checked' => TRUE))),
+          ),
+        '#suffix' => '</div>',
+      );
+      if (isset($form_state['values']['lingotek']['workflow_id']) && $form_state['values']['lingotek']['workflow_id'] != NULL) {
+        $form['lingotek']['prefill_phase_select']['#options'] = lingotek_get_phases_by_workflow_id($form_state['values']['lingotek']['workflow_id']);
+      }
+      else {
+        $form['lingotek']['prefill_phase_select']['#options'] = array('-1' => '(first choose a workflow)');
+        $form['lingotek']['prefill_phase_select']['#disabled'] = TRUE;
+      }
+    }
+  }    
+  
   if ($is_enterprise) {
     // Only show these options if the Lingotek document hasn't yet been created.
-    if (!$document_id && class_exists('LingotekApi')) {
-
-      $api = LingotekApi::instance();
+    if (!$node->lingotek['document_id'] && class_exists('LingotekApi')) {
 
       // Available projects.
       if ($projects = $api->listProjects()) {
@@ -641,17 +690,6 @@ function lingotek_form_node_form_alter(&$form, $form_state, $form_id) {
         );
       }
 
-      // Workflows.
-      if ($workflows = $api->listWorkflows()) {
-        $form['lingotek']['workflow_id'] = array(
-          '#type' => 'select',
-          '#title' => t('Workflow'),
-          '#description' => t('Choose the Workflow to associate with this content item.'),
-          '#default_value' => $node->lingotek['workflow_id'],
-          '#options' => $workflows,
-        );
-      }
-
       // Translation Memory (TM) Vault.
       if ($vaults = $api->listVaults()) {
         $form['lingotek']['vault_id'] = array(
@@ -681,7 +719,7 @@ function lingotek_form_node_form_alter(&$form, $form_state, $form_id) {
     '#type' => 'textfield',
     '#title' => t('Document Id'),
     '#description' => t("Read/Overwrite the document ID associated with the document.  This can break the translation process but can also be used to help figure out if something is wrong."),
-    '#default_value' => ($document_id === False) ? '' : $document_id,
+    '#default_value' => $node->lingotek['document_id'],
   );
   $form['lingotek']['advanced']['current_lingonode'] = array(
     '#type' => 'textarea',
@@ -707,7 +745,7 @@ function lingotek_get_node_settings_form($form, &$form_state, $node = NULL) {
       $node = lingotek_node_load_default(reset($nids));
     }
     else {
-      if(!$second_run) {
+      if (!$second_run) {
         drupal_set_message(t('You will be changing the settings for @number nodes.', array('@number' => count($nids))), 'warning');
       }
       $node = new stdClass();
@@ -783,7 +821,7 @@ function lingotek_get_node_settings_form($form, &$form_state, $node = NULL) {
     '#default_value' => $node->lingotek['profile'],
   );
   
-  if($node->lingotek['node_sync_status'] == LingotekSync::STATUS_DISABLED) {
+  if ($node->lingotek['node_sync_status'] == LingotekSync::STATUS_DISABLED) {
     $form['lingotek']['profile']['#default_value'] = LingotekSync::PROFILE_DISABLED;
   }
   
@@ -916,6 +954,10 @@ function lingotek_get_node_settings_form($form, &$form_state, $node = NULL) {
  */
 function lingotek_node_save($node) {
 
+  if (!isset($node->lingotek)) {
+    // load default lingotek settings when alternate node creation paths are employed (e.g., commons)
+    lingotek_node_load(array($node), array());
+  }
   $has_not_been_uploaded = !isset($node->lingotek['document_id']) || empty($node->lingotek['document_id']);
   
   $disabled_selected = ($node->lingotek['profile'] == LingotekSync::PROFILE_DISABLED);
@@ -923,7 +965,7 @@ function lingotek_node_save($node) {
   if ($disabled_selected && !$disabled) {
     LingotekSync::setNodeEnabled($node->nid, FALSE);
   }
-  else if (!$disabled_selected && $disabled) {
+  elseif (!$disabled_selected && $disabled) {
     LingotekSync::setNodeEnabled($node->nid, TRUE);
   }
   
@@ -936,7 +978,14 @@ function lingotek_node_save($node) {
     ->execute();
 
   if ($node->lingotek['profile'] == LingotekSync::PROFILE_CUSTOM) {
-    $ignore = array('et_content', 'lingotek_push_once', 'lingotek_disabled', 'advanced', 'node_sync_status', 'document_id');
+    $ignore = array('et_content', 
+                    'lingotek_push_once', 
+                    'lingotek_disabled', 
+                    'advanced', 
+                    'node_sync_status', 
+                    'document_id',
+                    'prefill_phases_checkbox',
+                    'prefill_phase_select');
     $query = db_insert('lingotek')->fields(array('nid', 'lingokey', 'lingovalue'));
     
     foreach ($node->lingotek as $key => $value) {
@@ -945,13 +994,28 @@ function lingotek_node_save($node) {
       }
     }
     $query->execute();
+    
+    // check for a workflow change
+    if (isset($node->lingotek['workflow_id']) && isset($node->lingotek['advanced']['document_id'])) {
+      $curr_workflow = $node->lingotek['workflow_id'];
+      $document_id = $node->lingotek['advanced']['document_id'];
+      if (!isset($node->original->lingotek['workflow_id']) ||
+          $node->original->lingotek['workflow_id'] != $curr_workflow) {
+        $api = LingotekApi::instance();
+        $prefill_checked = (isset($node->lingotek['prefill_phases_checkbox']) ? $node->lingotek['prefill_phases_checkbox'] : NULL);
+        $prefill_phase = ($prefill_checked ? $node->lingotek['prefill_phase_select'] : NULL);
+        $result = $api->changeWorkflow(array($document_id), $curr_workflow, $prefill_phase);
+        LingotekSync::setAllTargetStatus($node->nid, LingotekSync::STATUS_PENDING);
+        }
+    }
   }
   else { // Specific Profile
     $node_defaults = lingotek_load_profile_defaults('node');
     $profile_overridden = (!isset($node_defaults[$node->type]['profile']) || $node_defaults[$node->type]['profile'] != $node->lingotek['profile']);
-    if($profile_overridden) {
+    if ($profile_overridden) {
       lingotek_lingonode($node->nid, 'profile', $node->lingotek['profile']);
-    } else {
+    }
+    else {
       lingotek_lingonode_variable_delete($node->nid, 'profile');
     }
   }
@@ -976,43 +1040,41 @@ function lingotek_node_save_readonly($node) {
 function lingotek_get_node_settings_form_submit($form, $form_state) {
   if (isset($form_state['nids']) && !empty($form_state['nids'])) {
     $nids = $form_state['nids'];
+
+    // YOU LEFT OFF HERE, SEND UP THE CALL TO UPDATE THE WORKFLOW_ID FOR EACH NODE ALREADY UPLOADED
     
-    foreach($nids as $nid) {
+    foreach ($nids as $nid) {
       $node = node_load($nid);
       $node->lingotek = array_replace($node->lingotek, $form_state['values']['lingotek']);
       node_save($node);
     }
-    
-//    $operations = array();
-//    foreach ($nids as $nid) {
-//      $operations[] = array('lingotek_update_node_settings', array($form_state['values']['lingotek'], array($nid)));
-//      $operations[] = array('LingotekSync::setNodeEnabled', array($nid, $enabled));
-//    }
+  }
+}
 
-  /*  $segment = array(); // This way is almost twice as fast, but doesn't show how many nodes are being operated on.
-    $offset = 0;
-    do {
-      $segment = array_slice($nids, $offset, 100, TRUE);
-      $operations[] = array('lingotek_update_node_settings', array($settings, $segment));
-      $offset += 100;
-    } while (count($segment) >= 100);
-*/
-    
-//    $batch = array(
-//      'title' => t('Updating Lingotek Node Settings'),
-//      'operations' => $operations,
-//    );
-//
-//    $redirect = 'admin/settings/lingotek/grid';
-
-//    batch_set($batch);
-//    batch_process($redirect);
-    
-    //We cannot do batch operations here anymore because it is now in modal window, so we will emulate the process.
-    //As long as we aren't affecting hundreds of nodes we should be fine.
-//    foreach ($operations as $op) {
-//      call_user_func_array($op[0], $op[1]);
-//    }
+function lingotek_get_change_workflow_form_submit($form, $form_state) {
+  if (isset($form_state['nids']) && !empty($form_state['nids'])) {
+    $nids = $form_state['nids'];
+    $workflow_id = $form_state['values']['lingotek']['workflow_id'];
+    if (isset($form_state['values']['lingotek']['prefill_phases_checkbox']) && $form_state['values']['lingotek']['prefill_phases_checkbox']) {
+      $prefill_phase = $form_state['values']['lingotek']['prefill_phase_select'];
+    }
+    else {
+      $prefill_phase = NULL;
+    }
+
+    // SUBMIT THE WORKFLOW CHANGES TO TMS
+    $document_ids = LingotekSync::getDocIdsFromNodeIds($nids);
+    if (!$document_ids) {
+      return;
+    }
+    $api = LingotekApi::instance();
+    $api->changeWorkflow($document_ids, $workflow_id, $prefill_phase);
+
+    // CREATE/UPDATE WORKFLOW ENTRIES IN THE LINGOTEK METADATA TABLE
+    foreach ($nids as $nid) {
+      lingotek_lingonode($nid, 'workflow_id', $workflow_id);
+      LingotekSync::setAllTargetStatus($nid, LingotekSync::STATUS_PENDING);
+    }
   }
 }
 
@@ -1067,7 +1129,7 @@ function lingotek_node_view($node, $view_mode) {
     if ($language->language != $node->language) {
       $link = lingotek_get_workbench_url($node->lingotek['document_id'], $language->lingotek_locale, t('Help make it better.'));
       if ($link != '') {
-        $message = t('The translation of @title is still being worked on.', array('@title' => '"' . $node->title . '"')) . " ";
+        $message = t('The translation of this page is still being worked on.') . " ";
         $message .= $link . '&nbsp;';
         if (lingotek_access($node, 'manage projects')) {
           $message .= '<span style="font-size: 80%">[' . l(t('progress'), 'node/' . $node->nid . '/lingotek_pm', array('html' => TRUE)) . ']</span>';
@@ -1118,7 +1180,8 @@ function lingotek_node_delete($node) {
 function lingotek_entity_load_single($entity_type, $entity_id) {
   if ($entity_type == 'node') {
     $entity = lingotek_node_load_default($entity_id);
-  } else {
+  }
+  else {
     $entities = entity_load($entity_type, array($entity_id));
     $entity = $entities[$entity_id];
   }
@@ -1169,11 +1232,11 @@ function lingotek_node_load($nodes, $types) {
       $node->lingotek = array_merge($node->lingotek, $node_profile_defaults[$node->type]);
     }
     // Step 3: add node-specific profile
-    if (isset($node_lingovalues[$node->nid]['profile']) && is_numeric($node_lingovalues[$node->nid]['profile'])) {
+    if (isset($node->nid) && isset($node_lingovalues[$node->nid]['profile']) && is_numeric($node_lingovalues[$node->nid]['profile'])) {
       $node->lingotek = array_merge($node->lingotek, $profiles_list[$node_lingovalues[$node->nid]['profile']]);
     }
     // Step 4: add node-specific overrides
-    if (isset($node_lingovalues[$node->nid])) {
+    if (isset($node->nid) && isset($node_lingovalues[$node->nid])) {
       $node->lingotek = array_merge($node->lingotek, $node_lingovalues[$node->nid]);
     }
     // Step 5: if no profile, then disabled.
@@ -1214,7 +1277,7 @@ function lingotek_node_update($node) {
     return;
   }
   //check to make sure it is not a target node
-  if(!empty($node->tnid) && ($node->nid != $node->tnid)) {
+  if (!empty($node->tnid) && ($node->nid != $node->tnid)) {
     return;
   }
   
@@ -1223,7 +1286,8 @@ function lingotek_node_update($node) {
   if (module_exists('workbench_moderation') && isset($node->workbench_moderation)) {
     if (isset($node->is_new) && $node->is_new) {
       lingotek_workbench_moderation_transition($node, $node->workbench_moderation['current']->from_state, $node->workbench_moderation['current']->state);
-    } else {
+    }
+    else {
       return;
     }
   }
@@ -1248,7 +1312,7 @@ function lingotek_upload_document($node) {
     lingotek_lingonode($node->nid, 'hash', $hash);
     $diff = strcmp($hash, $oldhash);
 
-    if($diff == 0 && $node->lingotek['node_sync_status'] == 'CURRENT') {
+    if ($diff == 0 && $node->lingotek['node_sync_status'] == 'CURRENT') {
       return; //node has no changes.
     }
   }
@@ -1475,7 +1539,7 @@ function lingotek_is_config_missing() {
         return 'admin/config/lingotek/community-select';
       }
       elseif ($required_variable == 'lingotek_project' || $required_variable == 'lingotek_workflow' || $required_variable == 'lingotek_vault') {
-        return 'admin/config/lingotek/community-settings-select';
+        return 'admin/config/lingotek/project-vault-select';
       }
       elseif ($required_variable == 'lingotek_enabled_fields') {
         return 'admin/config/lingotek/node-translation-settings';
@@ -1614,19 +1678,46 @@ function lingotek_entity_info_alter(&$entity_info) {
   }
 }
 
+function lingotek_normalize_field_collection_language($entity, $from_language_none = TRUE) {
+    $host = $entity->hostEntity();
+    $max_field_collection_depth = 10;
+    // bubble up to the true parent to get its language,
+    // which adds support for deeply nested entity collections
+    for ($i = 0; $i < $max_field_collection_depth; $i++) {
+      if ($host instanceof FieldCollectionItemEntity) {
+        $host = $host->hostEntity();
+      }
+    }
+    foreach ($entity as $key => $value) {
+      if (is_array($value) && array_key_exists(LANGUAGE_NONE, $value)) {
+        if ($from_language_none) {
+          $entity->{$key}[$host->language] = $value[LANGUAGE_NONE];
+        }
+        elseif (isset($value[$host->language])) {
+          $entity->{$key}[LANGUAGE_NONE] = $value[$host->language];
+        }
+      }
+    }
+}
+
+/**
+ * Implements hook_entity_load().
+  */
+function lingotek_entity_load($entities, $type) {
+  if ($type == 'field_collection_item') {
+    foreach ($entities as $e) {
+      lingotek_normalize_field_collection_language($e);
+    }
+  }
+}
+
 /**
  * Implements hook_entity_presave().
   */
 function lingotek_entity_presave($entity, $type) {
-  /*global $language;
   if ($type == 'field_collection_item') {
-    foreach ($entity as $key => $value) {
-      if (is_array($value) && array_key_exists('und', $value)) {
-        $entity->{$key}[$language->language] = $value['und'];
-        unset($entity->{$key}['und']);
-      }
-    }
-  }*/
+    lingotek_normalize_field_collection_language($entity, FALSE);
+  }
 }
 
 /**
@@ -1951,40 +2042,177 @@ function lingotek_cron() {
   LingotekLog::trace(__METHOD__ . ' ran');
 }
 
-function lingotek_views_post_execute(&$view) {
-  global $language;
-  
-  if ((user_access('manage projects') || user_access('translation')) && variable_get('lingotek_views_edit_links')) {
-    $included = FALSE;
+/*
+ * Implements hook_l10n_update
+ */
+function lingotek_l10n_update_projects_alter(&$projects) {
+  if (variable_get('lingotek_use_translation_from_drupal', 0) != 1) {
+    $projects = array();
+  }
+}
 
- 
-    foreach ($view->result as &$row) {
-      if (isset($row->nid)) {
-        foreach ($row as $name => &$field) {
-          if (substr($name, 0, 5) == 'field' && !is_string($field) && isset($field[0])) {
-            $included = TRUE;
-            $text = '<img src="' . base_path() . drupal_get_path('module', 'lingotek') . '/images/ico_chevs_dd.png" >'; 
-            $url = 'node/' . $row->{$view->base_field} . '/lingotekworkbench/' . Lingotek::convertDrupal2Lingotek($language->language);
-            $tooltip = 'Edit this translation';
-            $edit = l($text, $url, array('attributes' => array('target' => '_blank', 'title' => $tooltip, 'class' => array('translation-link')), 'html' => TRUE));
-            $field[0]['rendered']['#markup'] = $edit . $field[0]['rendered']['#markup'];
-            break;
-          }
-        }
+/*
+ * Implements hook_node_view_alter
+ */
+function lingotek_node_view_alter(&$info) {
+  if (!variable_get('lingotek_show_language_label', 0)) {
+    if (isset($info['language'])) {
+      unset($info['language']);
+    }
+  }
+}
+
+
+function lingotek_get_change_workflow_form($form, &$form_state, $node = NULL) {  
+  $second_run = isset($form_state['triggering_element']);
+  
+  $bulk_grid = FALSE;
+  $multiple = FALSE;
+  
+  if (isset($form_state['nids'])) {
+    $nids = $form_state['nids'];
+    $bulk_grid = TRUE;
+    $multiple = count($nids) > 1;
+    if (!$multiple) {
+      $node = lingotek_node_load_default(reset($nids));
+    }
+    else {
+      if (!$second_run) {
+        drupal_set_message(t('You will be changing the workflow for @number nodes.', array('@number' => count($nids))), 'warning');
       }
+      $node = new stdClass();
+      $node->lingotek = lingotek_get_global_profile();
+      $node->lingotek['profile'] = LingotekSync::PROFILE_DISABLED;// Note: Consider making this default 'Automatic' (after it is a fixed profile; can't be deleted)
     }
+  }
+  
+  drupal_add_css(drupal_get_path('module', 'lingotek') . '/style/form.css');
+
+  $title = t('Change Workflow');
+
+  // Vertical Tab.
+  $form['lingotek'] = array(
+    '#title' => t('Change Workflow'),
+    '#type' => 'fieldset',
+    '#collapsible' => !$bulk_grid,
+    '#collapsed' => !$bulk_grid,
+    '#group' => 'additional_settings',
+    '#attributes' => array('id' => array('lingotek_fieldset')),
+    '#attached' => array(
+      'js' => array(drupal_get_path('module', 'lingotek') . '/js/lingotek.form.js'),
+    ),
+    '#modal' => TRUE,
+    '#tree' => TRUE,
+  );
+    
+  if (isset($node->tnid) && $node->tnid != 0 && $node->tnid != $node->nid) {
+    $form['lingotek']['note'] = array(
+      '#markup' => t('This is a target node for the language code: @lang. To change
+        the Lingotek settings please edit the source node.', array('@lang' => $node->language)),
+    );
+    
+    return $form; //this is a target node and thus should not have lingotek settings
+  }
+
+  if (isset($nids)) {
+    $form['lingotek']['nids'] = array(
+      '#type' => 'hidden',
+      '#default_value' => json_encode($nids),
+    );
+  }
+  
+  $form['lingotek']['lingotek_note'] = array(
+    '#type' => 'item',
+    '#title' => $title,
+    '#description' => t("This option allows you to replace the current workflow with a new workflow. This will result in the removal of any existing translations. You can optionally restore those translations to a phase in the new workflow."),
+  );
+  
+  $api = LingotekApi::instance();
+
 
-    if ($included) {
-      drupal_add_css(drupal_get_path('module', 'lingotek') . '/style/workbench-link.css', array('group' => CSS_DEFAULT));
+  if ($workflows = $api->listWorkflows()) {
+    if (!isset($form_state['values']['workflow_id'])) {
+      $keys = array_keys($workflows);
+      $form_state['values']['workflow_id'] = $keys[0];
+    }
+    
+    $form['lingotek']['workflow_id'] = array(
+      '#type' => 'select',
+      '#title' => t('Workflow'),
+      '#description' => t('Choose the Workflow'),
+      '#options' => $workflows,
+      '#empty_option' => '(select one)',
+      '#ajax' => array(
+        'callback' => 'lingotek_get_change_workflow_form_callback',
+        'wrapper' => 'prefill-phases-div',
+        'method' => 'replace',
+        'effect' => 'fade',
+        ),
+      '#prefix' => '<div id="prefill-phases-div">',
+    );
+    if (isset($node)) {
+     $form['lingotek']['workflow_id']['#default_value'] = $node->lingotek['workflow_id'];
+    }
+    
+    $form['lingotek']['prefill_phases_checkbox'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Restore to a phase in the new workflow'),
+      '#default_value' => TRUE,
+      '#description' => t('Prefill the new workflow with translations from the previous workflow'),
+    );
+    
+    $form['lingotek']['prefill_phase_select'] = array(
+      '#title' => t("Desired Prefill Phase"),
+      '#description' => t('Please select the highest phase which should be prefilled for the new workflow'),
+      '#type' => 'select',
+      '#states' => array(
+          'invisible' => array(':input[name="lingotek[prefill_phases_checkbox]"]' => array('checked' => FALSE)),
+        ),
+      '#suffix' => '</div>',
+    );
+    if (isset($form_state['values']['lingotek']['workflow_id']) && $form_state['values']['lingotek']['workflow_id'] != NULL) {
+      $form['lingotek']['prefill_phase_select']['#options'] = lingotek_get_phases_by_workflow_id($form_state['values']['lingotek']['workflow_id']);
+    }
+    else {
+      $form['lingotek']['prefill_phase_select']['#options'] = array('-1' => '(first choose a workflow)');
+      $form['lingotek']['prefill_phase_select']['#disabled'] = TRUE;
     }
   }
+
+  if ($bulk_grid) {
+    $form['submit'] = array(
+      '#type' => 'submit',
+      '#value' => t('Submit'),
+      '#submit' => array('lingotek_get_change_workflow_form_submit'),
+    );
+  }
+
+  return $form;
 }
 
-/*
- * Implements hook_l10n_update
- */
-function lingotek_l10n_update_projects_alter(&$projects) {
-  if (variable_get('lingotek_use_translation_from_drupal', 0) != 1) {
-    $projects = array();
+function lingotek_get_change_workflow_form_callback($form, $form_state) {
+  if (isset($form_state['values']['lingotek']['prefill_phases_checkbox']) 
+      && $form_state['values']['lingotek']['prefill_phases_checkbox']) {
+    return array(
+      $form['lingotek']['prefill_phase_select'], 
+      $form['lingotek']['prefill_phases_checkbox'],
+      $form['lingotek']['workflow_id'],
+    );
+  }
+  return $form['lingotek']['workflow_id'];
+}
+
+function lingotek_get_phases_by_workflow_id($workflow_id) {
+  $api = LingotekApi::instance();
+  $response = $api->request('getWorkflow', array('id' => $workflow_id));
+  $phases = array();
+  $excluded_phases = array('Project Setup', 'Workflow Completion');
+  if (isset($response->workflow->steps)) {
+    foreach ($response->workflow->steps as $id => $phase_obj) {
+      if (!in_array($phase_obj->name, $excluded_phases)) {
+        $phases[$id] = $phase_obj->name;
+      }
+    }
   }
-}
\ No newline at end of file
+  return $phases;
+}
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.page.inc b/profiles/commons/modules/contrib/lingotek/lingotek.page.inc
index 1200847..424e03b 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.page.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.page.inc
@@ -17,12 +17,13 @@ function lingotek_download_translations_form($form, $form_state, $node, $documen
 
   $document_progress = $document->getProgress();
 
+  $sum_progress = 0;
   if ($document_progress->results == 'success') {
 
     $rows = array();
-
     foreach ($document_progress->translationTargets as $target) {
       $current_phase = $document->currentPhase($target->id);
+      $marked_complete = FALSE;
 
       $phase_complete_percent = is_object($current_phase) ? $current_phase->percentComplete : 0;
       if (empty($phase_complete_percent)) {
@@ -34,7 +35,7 @@ function lingotek_download_translations_form($form, $form_state, $node, $documen
       $row = array(
         'column_1' => array('data' => $language_link, 'width' => '40%'),
         'column_2' => array('data' => lingotek_grid_create_progress_bar($target->percentComplete), 'width' => '40%'),
-        'column_3' => array('data' => ''),//$target->percentComplete == 100 ? '<i class="icon-check-sign ltk-complete-check" title="'.t('Workflow complete').'"></i>' : '<i class="icon-check-empty ltk-complete-check"></i>', 'width' => '20%'
+        'column_3' => array('data' => ''),//$target->percentComplete == 100 ? '<i class="fa fa-check-sign ltk-complete-check" title="'.t('Workflow complete').'"></i>' : '<i class="fa fa-check-empty ltk-complete-check"></i>', 'width' => '20%'
         '#attributes' => array('class' => array('bold-row')),
       );
 
@@ -44,11 +45,28 @@ function lingotek_download_translations_form($form, $form_state, $node, $documen
         $row = array(
           'column_1' => $phase->name,
           'column_2' => lingotek_grid_create_progress_bar($phase->percentComplete),
-          'column_3' => $phase->isMarkedComplete ? '<i class="icon-check-sign ltk-complete-check" title="'.t('Phase complete').'"></i>':'<i class="icon-check-empty ltk-complete-check"></i>',
+          'column_3' => $phase->isMarkedComplete ? '<i class="fa fa-check-sign ltk-complete-check" title="' . t('Phase complete') . '"></i>' : '<i class="fa fa-check-empty ltk-complete-check"></i>',
           '#attributes' => array('class' => array('no-checkbox-row')),
         );
         $rows[$target->language . '_' . $phase->name] = $row;
+        $marked_complete = $phase->isMarkedComplete;
+      }
+
+      // update progress
+      $lingotek_locale = $target->language;
+      $progress_percentage = empty($target->percentComplete) ? 0 : $target->percentComplete;
+      $sum_progress += $progress_percentage;
+      $target_status_local = lingotek_lingonode($node->nid, 'target_sync_status_' . $lingotek_locale);
+      if ($target_status_local === LingotekSync::STATUS_PENDING) {
+        $target_status = ($marked_complete) ? LingotekSync::STATUS_READY : LingotekSync::STATUS_PENDING;
+        lingotek_lingonode($node->nid, 'target_sync_status_' . $lingotek_locale, $target_status);
       }
+      lingotek_lingonode($node->nid, 'target_sync_progress_' . $lingotek_locale, $progress_percentage);
+      lingotek_lingonode($node->nid, 'target_sync_last_progress_updated_' . $lingotek_locale, time());
+    }
+    $count = count($document_progress->translationTargets);
+    if ($count) {
+      lingotek_lingonode($node->nid, 'translation_progress', $sum_progress/$count);// unused
     }
 
     $form['fieldset'] = array(
@@ -137,7 +155,7 @@ function lingotek_push_form($form, $form_state, $node) {
   $form['content_push'] = array(
     '#type' => 'fieldset',
     '#title' => t('Upload'),
-    '#description' => t("Upload this node's content to Lingotek for translation.") . $last_uploaded_message,
+    '#description' => t("Upload this node's content to Lingotek for translation. @last_uploaded_message", array('@last_uploaded_message' => $last_uploaded_message)),
     '#collapsible' => TRUE,
     '#collapsed' => FALSE,
   );
@@ -202,7 +220,7 @@ function lingotek_node_disassociate_form($form, $form_state, $nids = array(), $c
   $form['disassociate_translations'] = array(
     '#type' => 'fieldset',
     '#title' => t('Disassociate Translations'),
-    '#description' => t("Disassociates the node's locally-published translations from their counterparts on Lingotek's servers. This allows for your Drupal content to be re-uploaded to Lingotek, so that it can be retranslated entirely using the currently-defined workflow. Also resets the node's translation management settings to their defaults."),
+    '#description' => t("Should only be used to change the Lingotek project or TM vault associated with the nodes translation. Disassociates node translations on Lingoteks servers from the copies downloaded to Drupal. Additional translation using Lingotek will require re-uploading the nodes content to restart the translation process."),
     '#collapsible' => $collapse_fieldset,
     '#collapsed' => $collapse_fieldset,
   );
@@ -324,25 +342,10 @@ function lingotek_publish_form($form, $form_state, $node) {
 function lingotek_publish_form_submit($form, $form_state) {
   if (module_exists('entity_translation')) {
     $node = lingotek_node_load_default($form_state['values']['node_id']);
-
     $status_request = $form_state['triggering_element']['#id'] == 'publish' ? 1 : 0;
-    $handler = entity_translation_get_handler('node', $node);
-
     $language_codes = $form_state['values']['languages'];
-    $languages_updated = array();
-    $updates = 0;
-    foreach ($language_codes as $langcode) {
-      if ($langcode !== 0) {
-        // set node (source or target as specified) flag (in the entity_translation table) as published or unpublished
-        $handler->setTranslation(array(
-          'language' => $langcode,
-          'status' => $status_request
-        ));
-        $languages_updated[$langcode] = lingotek_language_name($langcode);
-        $updates++;
-      }
-    }
-    $handler->saveTranslations();
+
+    list($languages_updated, $updates) = lingotek_entity_translation_save_status($node, $language_codes, $status_request);
 
     $publish_status_text = $status_request ? 'published' : 'unpublished';
     $languages_updated_html = "<ul><li>" . implode("</li><li>", $languages_updated) . "</li></ul>";
@@ -383,7 +386,7 @@ function lingotek_pm($node) {
   // node translation support
   if ($node->tnid != 0 && $node->tnid != $node->nid) {
     $output[] = array(
-      '#markup' => 'This is a translated node. Go to the ' . l('source node', 'node/' . $node->tnid . '/lingotek_pm') . ' to manage the translations.'
+      '#markup' => t('This is a translated node. Go to the @link to manage the translations.', array('@link' => l('source node', 'node/' . $node->tnid . '/lingotek_pm'))),
     );
     return $output;
   }
@@ -436,7 +439,7 @@ function lingotek_pm($node) {
         // Import Status (check and report on import status)
         $status = $document->getImportStatus();
 
-        $message = ' <i>' . check_plain($status) . '</i> ' . l('<i class="icon-refresh"></i> ' . t('Refresh'), '', array('html' => TRUE, 'attributes' => array('class' => 'ltk-icon', 'title' => t('Refresh'), 'onclick' => array('location.reload();return false;'))));
+        $message = ' <i>' . check_plain($status) . '</i> ' . l('<i class="fa fa-refresh"></i> ' . t('Refresh'), '', array('html' => TRUE, 'attributes' => array('class' => 'ltk-icon', 'title' => t('Refresh'), 'onclick' => array('location.reload();return false;'))));
         drupal_set_message(t('Content Import Status:') . $message, 'status');
 
         $output['import_status'] = array(
@@ -449,10 +452,12 @@ function lingotek_pm($node) {
       
       }
       
+      /* REMOVE DISASSOCIATE_TRANSLTIONS FORM FROM THE TRANSLATE PAGE, FOR NOW
       $disassociate_translations_form = drupal_get_form('lingotek_node_disassociate_form', $node->nid);
       $output['disassociate_translations'] = array(
         '#markup' => drupal_render($disassociate_translations_form),
       );
+      */
     }
   }
   else {
@@ -582,10 +587,7 @@ function lingotek_mark_phases_complete($form, $form_state, $node, $document = NU
         $language = Lingotek::convertLingotek2Drupal($target->language);
         $current_phase = $document->currentPhase($target->id);
 
-        $phase_complete_percent = $current_phase->percentComplete;
-        if (empty($phase_complete_percent)) {
-          $phase_complete_percent = 0;
-        }
+        $phase_complete_percent = empty($current_phase->percentComplete) ? 0 : $current_phase->percentComplete;
 
         if ($current_phase && $current_phase->canBeMarkedComplete()) {
           $phase_link = l($current_phase->name, '', array('attributes' => array(
@@ -724,7 +726,8 @@ function lingotek_workbench_redirect($entity_type, $id, $lingotek_locale) {
       $translation_edit_link = lingotek_get_workbench_url($node->lingotek['document_id'], $lingotek_locale);
       drupal_goto($translation_edit_link);
     }
-  } else if ($entity_type == 'comment') {
+  }
+  elseif ($entity_type == 'comment') {
     $comment = comment_load($id);
     if ($comment->language == $drupal_language_code) {
       drupal_goto('comment/' . $comment->cid . '/edit');
@@ -733,7 +736,7 @@ function lingotek_workbench_redirect($entity_type, $id, $lingotek_locale) {
       $lingotek_comment = LingotekComment::load($comment);
       
       $translation_edit_link = lingotek_get_workbench_url($lingotek_comment->lingotekDocumentId(), $lingotek_locale);
-      if(!empty($translation_edit_link)) {
+      if (!empty($translation_edit_link)) {
         drupal_goto($translation_edit_link);
       }
       else {
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.reference.inc b/profiles/commons/modules/contrib/lingotek/lingotek.reference.inc
index 9350020..1a32ea4 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.reference.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.reference.inc
@@ -9,205 +9,204 @@ include_once(DRUPAL_ROOT . '/includes/iso.inc');
 /*
  * Language code conversion: drupal => lingotek  (this mapping should be 1-to-1)
  */
-static $_lingotek_locale = array
-(
-'aa' => 'aa_DJ',
- 'ab' => 'ab_GE',
- 'af' => 'af_ZA',
- 'ak' => 'ak_GH',
- 'am' => 'am_ET',
- 'apa' => 'apa_US',
- 'ar' => 'ar',
- 'as' => 'as_IN',
- 'ast' => 'ast_ES',
- 'ay' => 'ay_BO',
- 'az' => 'az_AZ',
- 'ba' => 'ba_RU',
- 'be' => 'be_BY',
- 'bg' => 'bg_BG',
- 'bi' => 'bi_VU',
- 'bik' => 'bik_PH',
- 'bm' => 'bm_ML',
- 'bn' => 'bn_BD',
- 'bo' => 'bo_CN',
- 'br' => 'br_FR',
- 'bs' => 'bs_BA',
- 'ca' => 'ca_ES',
- 'ce' => 'ce_RU',
- 'ceb' => 'ceb_PH',
- 'ch' => 'ch_GU',
- 'chr' => 'chr_US',
- 'chy' => 'chy_US',
- 'co' => 'co_FR',
- 'cpe' => 'cpe_US',
- 'cpf' => 'cpf_MU',
- 'cpp' => 'cpp_BR',
- 'cs' => 'cs_CZ',
- 'cy' => 'cy_GB',
- 'da' => 'da_DK',
- 'de' => 'de_DE',
- 'dik' => 'dik_SD',
- 'dv' => 'dv_MV',
- 'dz' => 'dz_BT',
- 'ee' => 'ee_GH',
- 'efi' => 'efi_NG',
- 'el' => 'el_GR',
- 'en' => 'en_US',
- 'en-gb' => 'en_GB',
- 'eo' => 'eo_FR',
- 'es' => 'es_ES',
- 'es-cl' => 'es_CL',
- 'es-co' => 'es_CO',
- 'es-ar' => 'es_AR',
- 'es-ve' => 'es_VE',
- 'et' => 'et_EE',
- 'eu' => 'eu_ES',
- 'fa' => 'fa_IR',
- 'fat' => 'fat_GH',
- 'fi' => 'fi_FI',
- 'fj' => 'fj_FJ',
- 'fon' => 'fon_BJ',
- 'fr' => 'fr_FR',
- 'ga' => 'ga_IE',
- 'gaa' => 'gaa_GH',
- 'gbz' => 'gbz_IR',
- 'gd' => 'gd_GB',
- 'gil' => 'gil_KI',
- 'gl' => 'gl_ES',
- 'gn' => 'gn_BO',
- 'gu' => 'gu_IN',
- 'ha' => 'ha_NG',
- 'haw' => 'haw_US',
- 'he' => 'he_IL',
- 'hi' => 'hi_IN',
- 'hil' => 'hil_PH',
- 'hmn' => 'hmn_LA',
- 'hr' => 'hr_HR',
- 'ht' => 'ht_HT',
- 'hu' => 'hu_HU',
- 'hy' => 'hy_AM',
- 'id' => 'id_ID',
- 'ig' => 'ig_NG',
- 'Ilo' => 'Ilo_PH',
- 'is' => 'is_IS',
- 'it' => 'it_IT',
- 'ja' => 'ja_JP',
- 'jv' => 'jv_ID',
- 'ka' => 'ka_GE',
- 'kek' => 'kek_GT',
- 'kg' => 'kg_CD',
- 'ki' => 'kik_KE',
- 'kin' => 'kin_RW',
- 'kj' => 'kj_AO',
- 'kk' => 'kk_KZ',
- 'km' => 'km_KH',
- 'kn' => 'kn_IN',
- 'ko' => 'ko_KR',
- 'kos' => 'kos_FM',
- 'ks' => 'ks_IN',
- 'ku' => 'ku_IQ',
- 'kw' => 'kw_GB',
- 'ky' => 'ky_KG',
- 'la' => 'la_VA',
- 'lb' => 'lb_LU',
- 'lg' => 'lg_UG',
- 'ln' => 'ln_CD',
- 'lo' => 'lo_LA',
- 'lt' => 'lt_LT',
- 'lu' => 'lu_CD',
- 'lv' => 'lv_LV',
- 'mg' => 'mg_MG',
- 'mh' => 'mh_MH',
- 'mi' => 'mi_NZ',
- 'mk' => 'mk_MK',
- 'ml' => 'ml_IN',
- 'mn' => 'mn_MN',
- 'mo' => 'mo_MD',
- 'mr' => 'mr_IN',
- 'ms' => 'ms_MY',
- 'mt' => 'mt_MT',
- 'my' => 'my_MM',
- 'na' => 'na_NR',
- 'nb' => 'nb_NO',
- 'nd' => 'nd_ZW',
- 'ne' => 'ne_NP',
- 'ng' => 'ng_NA',
- 'niu' => 'niu_NU',
- 'nl' => 'nl_NL',
- 'nn' => 'nn_NO',
- 'no' => 'no_NO',
- 'nr' => 'nr_ZA',
- 'nso' => 'nso_ZA',
- 'nv' => 'nv_US',
- 'ny' => 'ny_MW',
- 'om' => 'om_ET',
- 'or' => 'or_IN',
- 'pa' => 'pa_IN',
- 'pag' => 'pag_PH',
- 'pap' => 'pap_AN',
- 'pau' => 'pau_PW',
- 'pl' => 'pl_PL',
- 'ps' => 'ps_AF',
- //'pt' => 'pt_PT',
-'pt-pt' => 'pt_PT',
- 'pt-br' => 'pt_BR',
- 'qu' => 'qu_BO',
- 'rar' => 'rar_CK',
- 'rn' => 'rn_BI',
- 'ro' => 'ro_RO',
- 'ru' => 'ru_RU',
- 'sa' => 'sa_IN',
- 'sc' => 'sc_IT',
- 'scn' => 'scn_IT',
- 'sd' => 'sd_PK',
- 'sg' => 'sg_CF',
- 'si' => 'si_LK',
- 'sk' => 'sk_SK',
- 'sl' => 'sl_SI',
- 'sm' => 'sm_WS',
- 'sn' => 'sn_ZW',
- 'so' => 'so_SO',
- 'sq' => 'sq_SQ',
- 'sr' => 'sr_CS',
- 'ss' => 'ss_SZ',
- 'st' => 'st_LS',
- 'su' => 'su_ID',
- 'sv' => 'sv_SE',
- 'sw' => 'sw_TZ',
- 'ta' => 'ta_IN',
- 'te' => 'te_IN',
- 'tg' => 'tg_TJ',
- 'th' => 'th_TH',
- 'ti' => 'ti_ER',
- 'tk' => 'tk_TM',
- 'fil' => 'tl_PH',
- //'tl' => 'tl_PH', // philipines
-'tn' => 'tn_BW',
- 'to' => 'to_TO',
- 'tpi' => 'tpi_PG',
- 'tr' => 'tr_TR',
- 'ts' => 'ts_ZA',
- 'tum' => 'tum_MW',
- 'tvl' => 'tvl_TV',
- 'tw' => 'tw_GH',
- 'ty' => 'ty_PF',
- 'ug' => 'ug_CN',
- 'uk' => 'uk_UA',
- 'um' => 'um_AO',
- 'ur' => 'ur_PK',
- 'uz' => 'uz_UZ',
- 've' => 've_ZA',
- 'vi' => 'vi_VN',
- 'war' => 'war_PH',
- 'wo' => 'wo_SN',
- 'xh' => 'xh_ZA',
- 'yap' => 'yap_FM',
- 'yi' => 'yi_IL',
- 'yo' => 'yo_NG',
- //'zh' => 'zh_TW',
-'zh-hans' => 'zh_CN',
- 'zh-hant' => 'zh_TW',
- 'zu' => 'zu_ZA',
+static $_lingotek_locale = array(
+  'aa' => 'aa_DJ',
+  'ab' => 'ab_GE',
+  'af' => 'af_ZA',
+  'ak' => 'ak_GH',
+  'am' => 'am_ET',
+  'apa' => 'apa_US',
+  'ar' => 'ar',
+  'as' => 'as_IN',
+  'ast' => 'ast_ES',
+  'ay' => 'ay_BO',
+  'az' => 'az_AZ',
+  'ba' => 'ba_RU',
+  'be' => 'be_BY',
+  'bg' => 'bg_BG',
+  'bi' => 'bi_VU',
+  'bik' => 'bik_PH',
+  'bm' => 'bm_ML',
+  'bn' => 'bn_BD',
+  'bo' => 'bo_CN',
+  'br' => 'br_FR',
+  'bs' => 'bs_BA',
+  'ca' => 'ca_ES',
+  'ce' => 'ce_RU',
+  'ceb' => 'ceb_PH',
+  'ch' => 'ch_GU',
+  'chr' => 'chr_US',
+  'chy' => 'chy_US',
+  'co' => 'co_FR',
+  'cpe' => 'cpe_US',
+  'cpf' => 'cpf_MU',
+  'cpp' => 'cpp_BR',
+  'cs' => 'cs_CZ',
+  'cy' => 'cy_GB',
+  'da' => 'da_DK',
+  'de' => 'de_DE',
+  'dik' => 'dik_SD',
+  'dv' => 'dv_MV',
+  'dz' => 'dz_BT',
+  'ee' => 'ee_GH',
+  'efi' => 'efi_NG',
+  'el' => 'el_GR',
+  'en' => 'en_US',
+  'en-gb' => 'en_GB',
+  'eo' => 'eo_FR',
+  'es' => 'es_ES',
+  'es-cl' => 'es_CL',
+  'es-co' => 'es_CO',
+  'es-ar' => 'es_AR',
+  'es-ve' => 'es_VE',
+  'et' => 'et_EE',
+  'eu' => 'eu_ES',
+  'fa' => 'fa_IR',
+  'fat' => 'fat_GH',
+  'fi' => 'fi_FI',
+  'fj' => 'fj_FJ',
+  'fon' => 'fon_BJ',
+  'fr' => 'fr_FR',
+  'ga' => 'ga_IE',
+  'gaa' => 'gaa_GH',
+  'gbz' => 'gbz_IR',
+  'gd' => 'gd_GB',
+  'gil' => 'gil_KI',
+  'gl' => 'gl_ES',
+  'gn' => 'gn_BO',
+  'gu' => 'gu_IN',
+  'ha' => 'ha_NG',
+  'haw' => 'haw_US',
+  'he' => 'he_IL',
+  'hi' => 'hi_IN',
+  'hil' => 'hil_PH',
+  'hmn' => 'hmn_LA',
+  'hr' => 'hr_HR',
+  'ht' => 'ht_HT',
+  'hu' => 'hu_HU',
+  'hy' => 'hy_AM',
+  'id' => 'id_ID',
+  'ig' => 'ig_NG',
+  'Ilo' => 'Ilo_PH',
+  'is' => 'is_IS',
+  'it' => 'it_IT',
+  'ja' => 'ja_JP',
+  'jv' => 'jv_ID',
+  'ka' => 'ka_GE',
+  'kek' => 'kek_GT',
+  'kg' => 'kg_CD',
+  'ki' => 'kik_KE',
+  'kin' => 'kin_RW',
+  'kj' => 'kj_AO',
+  'kk' => 'kk_KZ',
+  'km' => 'km_KH',
+  'kn' => 'kn_IN',
+  'ko' => 'ko_KR',
+  'kos' => 'kos_FM',
+  'ks' => 'ks_IN',
+  'ku' => 'ku_IQ',
+  'kw' => 'kw_GB',
+  'ky' => 'ky_KG',
+  'la' => 'la_VA',
+  'lb' => 'lb_LU',
+  'lg' => 'lg_UG',
+  'ln' => 'ln_CD',
+  'lo' => 'lo_LA',
+  'lt' => 'lt_LT',
+  'lu' => 'lu_CD',
+  'lv' => 'lv_LV',
+  'mg' => 'mg_MG',
+  'mh' => 'mh_MH',
+  'mi' => 'mi_NZ',
+  'mk' => 'mk_MK',
+  'ml' => 'ml_IN',
+  'mn' => 'mn_MN',
+  'mo' => 'mo_MD',
+  'mr' => 'mr_IN',
+  'ms' => 'ms_MY',
+  'mt' => 'mt_MT',
+  'my' => 'my_MM',
+  'na' => 'na_NR',
+  'nb' => 'nb_NO',
+  'nd' => 'nd_ZW',
+  'ne' => 'ne_NP',
+  'ng' => 'ng_NA',
+  'niu' => 'niu_NU',
+  'nl' => 'nl_NL',
+  'nn' => 'nn_NO',
+  'no' => 'no_NO',
+  'nr' => 'nr_ZA',
+  'nso' => 'nso_ZA',
+  'nv' => 'nv_US',
+  'ny' => 'ny_MW',
+  'om' => 'om_ET',
+  'or' => 'or_IN',
+  'pa' => 'pa_IN',
+  'pag' => 'pag_PH',
+  'pap' => 'pap_AN',
+  'pau' => 'pau_PW',
+  'pl' => 'pl_PL',
+  'ps' => 'ps_AF',
+  //'pt' => 'pt_PT',
+  'pt-pt' => 'pt_PT',
+  'pt-br' => 'pt_BR',
+  'qu' => 'qu_BO',
+  'rar' => 'rar_CK',
+  'rn' => 'rn_BI',
+  'ro' => 'ro_RO',
+  'ru' => 'ru_RU',
+  'sa' => 'sa_IN',
+  'sc' => 'sc_IT',
+  'scn' => 'scn_IT',
+  'sd' => 'sd_PK',
+  'sg' => 'sg_CF',
+  'si' => 'si_LK',
+  'sk' => 'sk_SK',
+  'sl' => 'sl_SI',
+  'sm' => 'sm_WS',
+  'sn' => 'sn_ZW',
+  'so' => 'so_SO',
+  'sq' => 'sq_SQ',
+  'sr' => 'sr_CS',
+  'ss' => 'ss_SZ',
+  'st' => 'st_LS',
+  'su' => 'su_ID',
+  'sv' => 'sv_SE',
+  'sw' => 'sw_TZ',
+  'ta' => 'ta_IN',
+  'te' => 'te_IN',
+  'tg' => 'tg_TJ',
+  'th' => 'th_TH',
+  'ti' => 'ti_ER',
+  'tk' => 'tk_TM',
+  'fil' => 'tl_PH',
+  //'tl' => 'tl_PH', // philipines
+  'tn' => 'tn_BW',
+  'to' => 'to_TO',
+  'tpi' => 'tpi_PG',
+  'tr' => 'tr_TR',
+  'ts' => 'ts_ZA',
+  'tum' => 'tum_MW',
+  'tvl' => 'tvl_TV',
+  'tw' => 'tw_GH',
+  'ty' => 'ty_PF',
+  'ug' => 'ug_CN',
+  'uk' => 'uk_UA',
+  'um' => 'um_AO',
+  'ur' => 'ur_PK',
+  'uz' => 'uz_UZ',
+  've' => 've_ZA',
+  'vi' => 'vi_VN',
+  'war' => 'war_PH',
+  'wo' => 'wo_SN',
+  'xh' => 'xh_ZA',
+  'yap' => 'yap_FM',
+  'yi' => 'yi_IL',
+  'yo' => 'yo_NG',
+  //'zh' => 'zh_TW',
+  'zh-hans' => 'zh_CN',
+  'zh-hant' => 'zh_TW',
+  'zu' => 'zu_ZA',
 );
 
 $GLOBALS['_lingotek_locale'] = $_lingotek_locale;
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.session.inc b/profiles/commons/modules/contrib/lingotek/lingotek.session.inc
index 2f75d7e..6b0ce0e 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.session.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.session.inc
@@ -113,14 +113,26 @@ class LingotekSession {
       $timeout = self::DEFAULT_API_TIMEOUT;
     }
 
-    $response = drupal_http_request(
-        $this->url . "/" . $api, array(
+    $api_url = $this->url . "/" . $api;
+    $params = array(
       'headers' => $this->headers,
       'method' => 'POST',
       'data' => $query,
       'timeout' => $timeout,
-        )
+        );
+    $response = drupal_http_request($api_url, $params);
+    
+    $message_params = array(
+      '@url' => $api_url,
+      'api' => 'api-session',
+      '@method' => $api,
+      '!params' => $params,
+      '!request' => array(),
+      '!response' => $response
     );
+    
+    LingotekLog::api('<h1>@method</h1> <strong>API URL:</strong> @url
+        <br /><strong>Request Params</strong>: !params<br /><strong>Response:</strong> !response', $message_params);
 
     if (isset($response->error)) {
       $this->last_login_msg = $response->error;
@@ -261,11 +273,11 @@ class LingotekSession {
         $success = TRUE;
         $error = '';
       }
-      else if (isset($response->results) && $response->results == "fail") {
+      elseif (isset($response->results) && $response->results == "fail") {
         $error = $response->error;
       }
     }
-    else if (isset($data->error)) {
+    elseif (isset($data->error)) {
       $error = $data->error;
     }
 
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.setup.inc b/profiles/commons/modules/contrib/lingotek/lingotek.setup.inc
index 8de90be..4873642 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.setup.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.setup.inc
@@ -67,6 +67,7 @@ function lingotek_setup_new_account_form() {
   );
 
   $form['lingotek_button_spacer'] = array('#markup' => '<div>&nbsp;</div>');
+  
   $form['submit'] = array(
     '#type' => 'submit',
     '#value' => t('Next') // Create Account
@@ -286,11 +287,9 @@ function lingotek_setup_account_settings_form() {
 function lingotek_setup_account_settings_form_submit($form, $form_state) {
   $login_id = $form_state['values']['lingotek_lid'];
   $password = $form_state['values']['lingotek_pid'];
-  //debug( $login_id );
-  //debug( $password );
-  // Validate the Account - Can we Login?
-  // These are V4 Basic Auth API Calls for Legacy Users
-  list($success, $msg) = lingotek_get_communities_v4($login_id, $password, LINGOTEK_API_SERVER . '/lingopoint/api/4');
+
+  // Validate the Account
+  list($success, $msg) = lingotek_list_community_integrations($login_id, $password);
   if ($success == FALSE) {
     drupal_set_message($msg, 'error');
   }
@@ -315,8 +314,7 @@ function lingotek_community_select_form() {
 
   $form = array();
 
-  // V3 API Calls for Legacy Users
-  list($success, $msg) = lingotek_get_communities_v4($login_id, $password, LINGOTEK_API_SERVER . '/lingopoint/api/4');
+  list($success, $msg) = lingotek_list_community_integrations($login_id, $password);
 
   if ($success == FALSE) {
 
@@ -324,15 +322,17 @@ function lingotek_community_select_form() {
     drupal_goto('admin/config/lingotek/account-settings'); // Shouldnt be here.  So something messed up.  Go back.
   }
   else {
-    $communities = $msg;
-    $count = count($communities);
+    $community_integrations = $msg;
+
+    $count = count($community_integrations);
     if ($count == 1) { // Just one community, use that.
-      $community_keys = array_keys($communities);
-      $community_id = array_pop($community_keys);
-      variable_set('lingotek_community_identifier', $community_id);
-      drupal_goto('admin/config/lingotek/community-settings-select'); // Default path, if they only have 1 community.
+      $ci = array_pop($community_integrations);
+      variable_set('lingotek_community_identifier', $ci->community_id);
+      variable_set('lingotek_oauth_consumer_id', $ci->key);
+      variable_set('lingotek_oauth_consumer_secret', $ci->secret);
+      drupal_goto('admin/config/lingotek/project-vault-select'); // Default path, if they belong to one community.
     }
-    elseif ($count > 1) { // More then 1 community
+    elseif ($count > 1) { // More than 1 community
       // Stay on this page
     }
     else {
@@ -342,18 +342,30 @@ function lingotek_community_select_form() {
     }
   } // END:  Community Select Paths
 
-  $form['lingotek_user_directions_1'] = array('#markup' => '<p>Your account is associated with multiple Lingotek communities.</p><p>Which community should we associate your Drupal site with?</p>');
-  $form['lingotek_top_spacer'] = array('#markup' => '<div>&nbsp;</div>');
+  $form['lingotek_user_directions_1'] = array(
+    '#markup' => '<p>Your account is associated with multiple Lingotek communities.</p>
+    <p>Select the community to associate this site with:</p>');
+  $community_options = array();
+  foreach ($community_integrations as $ci) {
+    $community_options[$ci->community_id] = $ci->community_name . ' (' . $ci->community_id . ')';
+  }
 
   $form['lingotek_site_community'] = array(
     '#title' => t('Community'),
     '#type' => 'select',
-    '#options' => $communities,
+    '#options' => $community_options,//array_combine(array_keys($communities),array_keys($communities)),
     //'#default_value' => ,
     //'#description' => t( '' ),
     '#required' => TRUE,
   );
+  
+  $form['lingotek_communities'] = array(
+    '#type' => 'hidden',
+    '#value' => json_encode($community_integrations)
+  );
 
+  $form['lingotek_button_spacer'] = array('#markup' => '<div>&nbsp;</div>');
+  
   if (is_array($_SESSION['lingotek_setup_path'])) {
     if (end($_SESSION['lingotek_setup_path']) == 'admin/config/lingotek/community-select') {
       $null = array_pop($_SESSION['lingotek_setup_path']);
@@ -361,7 +373,6 @@ function lingotek_community_select_form() {
     $form['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
   }
 
-  $form['lingotek_button_spacer'] = array('#markup' => '<div>&nbsp;</div>');
   $form['submit'] = array(
     '#type' => 'submit',
     '#value' => t('Next')
@@ -378,26 +389,27 @@ function lingotek_community_select_form() {
  * Community Select Screen - Form Submit
  */
 function lingotek_community_select_form_submit($form, $form_state) {
-  $community_identity = $form_state['values']['lingotek_site_community'];
-  variable_set('lingotek_community_identifier', $community_identity);
+  $community_selected = $form_state['values']['lingotek_site_community'];
+  variable_set('lingotek_community_identifier', $community_selected);
+  $communities = (array)json_decode($form_state['values']['lingotek_communities']);
+  $community = $communities[$community_selected];
+  variable_set('lingotek_oauth_consumer_id', $community->key);
+  variable_set('lingotek_oauth_consumer_secret', $community->secret);
 
   $_SESSION['lingotek_setup_path'][] = 'admin/config/lingotek/community-select';
-  drupal_set_message(t('Your Lingotek Community Settings have been saved.'));
-  drupal_goto('admin/config/lingotek/community-settings-select'); // Move to Project Select Step.
+
+  drupal_set_message(t('Your site has been securely connected to your community (@community).', array('@community' => $community_selected)));
+  drupal_goto('admin/config/lingotek/project-vault-select'); // Move to Project Select Step.
 }
 
 /**
  * Project Select Screen (for Current Users) - Form Layout
  */
-function lingotek_community_settings_select_form() {
-  $login_id = variable_get('lingotek_login_id', '');
-  $password = variable_get('lingotek_password', '');
-
+function lingotek_project_vault_select_form() {
   $form = array();
 
-  // V3 API Call for Legacy Users
   $community_identity = variable_get('lingotek_community_identifier', NULL);
-  $community_settings = lingotek_get_community_settings_v4($login_id, $password, $community_identity, LINGOTEK_API_SERVER . '/lingopoint/api/4');
+  list($community_settings, $full_community_data) = lingotek_get_community_settings($community_identity, TRUE);
 
   if ($community_settings === FALSE) {
     drupal_set_message(t('Error Retrieving Account Information.'), 'error');
@@ -407,77 +419,66 @@ function lingotek_community_settings_select_form() {
     drupal_set_message(t('Error Retrieving Account Information.'), 'error');
     drupal_goto('admin/config/lingotek/account-settings'); // Error geting projects.  Go back.
   }
-  else {
 
-    // PROJECTS
-    $project_count = count($community_settings['project']);
-    if ($project_count == 1) {
-      // If there is just 1 Project, Auto-Select it.  Then move on to the next step.
-      $project_id = '';
-      $project_keys = array_keys($community_settings['project']);
-      $project_id = array_pop($project_keys);
-      variable_set('lingotek_project', $project_id);
-    }
-
-    // WORKFLOWS
-    $workflow_count = count($community_settings['workflow']);
-    if ($workflow_count == 1) {
-      // If there is just 1 Workflow, Auto-Select it.  Then move on to the next step.
-      $workflow_keys = array_keys($workflow_settings['workflow']);
-      $workflow_string = array_pop($workflow_keys);
-      // This can come back as the workflow_id ||| vault_id mashed together, so check it first
-      if (strpos($workflow_string, '|||')) {
-        $parts = explode('|||', $workflow_string);
-        $workflow_id = $parts[0];
-        $vault_id = $parts[1];
-      }
-      else {
-        $workflow_id = $workflow_string;
-      }
-      variable_set('lingotek_workflow', $workflow_id);
-      if (isset($vault_id)) { // If the vault id is passed back, and there is only one workflow choice, pick the associated vault by default
-        variable_set('lingotek_vault', $vault_id);
-      }
-    }
+  $form['lingotek_user_directions'] = array('#markup' => '<p>Select or create the default project and vault that you would like to use.</p>');
+  $form['lingotek_community_data'] = array(
+    '#type' => 'hidden',
+    '#value' => json_encode($full_community_data)
+  );
 
-    // VAULTS
-    $vault_count = count($community_settings['vault']);
-    if ($vault_count == 1) {
-      // If there is just 1 Vault, Auto-Select it.  Then move on to the next step.
-      $key = array_keys($community_settings['vault']);
-      $vault_id = array_keys($community_settings['vault'][$key[0]]);
-      $current_vault = variable_get('lingotek_vault', NULL);
-      if ($current_vault && $current_vault != $vault_id[0]) {
-        // Something is wrong here.  This variable references a vault that the user has no access to.
-        // I don't know what to do in this case, however, or if it will ever happen.
-      }
-      variable_set('lingotek_vault', $vault_id[0]);
-    }
+  // Project
 
-    if ($project_count == 1 && $workflow_count == 1 && $vault_count == 1) {
-      drupal_goto('admin/config/lingotek/language-settings'); // Default path, if they only have 1 project, workflow, and vault.
-    }
-    elseif ($project_count < 1 || $workflow_count < 1 || $vault_count < 1) {
-      // Something went wrong here, so go back.
-      drupal_goto('admin/config/lingotek/new-account');
+    asort($community_settings['project']);
+    
+    $project_already_set = !is_null(variable_get('lingotek_project', NULL));
+    $projects_count = count($community_settings['project']);
+
+    $project_options = array(
+        1 => t('New') . (!$project_already_set ? ' <i>(' . t('recommended') . ')</i>' : ''),
+        0 => t('Existing') . ($project_already_set ? ' <i>(' . t('recommended') . ')</i>' : '')
+      );
+    if ($projects_count == 0) {
+      unset($project_options[0]);
     }
-  }
-
-  $form['lingotek_user_directions'] = array('#markup' => '<p>Your account is associated with multiple projects, workflows, or vaults.</p><p>Select the defaults that you would like to use below</p>');
-
-  if ($project_count > 1) {
-
-    $sorted = asort($community_settings['project']);
-    $form['lingotek_site_project'] = array(
+    $form['project_new_or_existing'] = array(
+      '#type' => 'radios',
       '#title' => t('Project'),
+      '#default_value' => $project_already_set ? 0 : 1,
+      '#options' => $project_options,
+      //'#description' => t('The Lingotek Project that you would like to use for this site.'),
+      '#required' => TRUE,
+      //'#attributes' => array('onclick' => "(function(){ console.log($); alert('hi'); })();"),
+    );
+    
+    $form['project_new'] = array(
+      '#type' => 'textfield',
+      //'#title' => t('Project Name'),
+      '#default_value' => lingotek_get_site_name(),
+      '#description' => t('The name of the project where content will be uploaded'),
+      '#size' => 20,
+      '#states' => array(
+        'invisible' => array(
+          ':input[name="project_new_or_existing"]' => array('value' => 0)
+        )
+      )
+    );
+    
+    $form['project_existing'] = array(
       '#type' => 'select',
+      //'#title' => t('Project Selection'),
       '#options' => $community_settings['project'],
       '#default_value' => variable_get('lingotek_project', NULL),
-      '#description' => t('The Lingotek Project with which translations will be associated.'),
-      '#required' => TRUE,
+      '#description' => t('Note: ALL documents uploaded to the project, including documents not from this site, will be affected by actions taken on this site (e.g., adding languages)'),
+      '#states' => array(
+        'invisible' => array(
+          ':input[name="project_new_or_existing"]' => array('value' => 1)
+        ),
+      )
     );
-  }
 
+  // Workflow (assume project default for workflow)
+    
+  /*
   if ($workflow_count > 1) {
 
     $form['lingotek_site_workflow'] = array(
@@ -489,31 +490,66 @@ function lingotek_community_settings_select_form() {
       '#required' => TRUE,
     );
   }
+  */
+  
+  // Vault
+
+  $form['vault_existing_or_new'] = array(
+    '#type' => 'radios',
+    '#title' => t('Vault'),
+    '#default_value' => 0,
+    '#options' => array(0 => t('Existing') . ' <i>(' . t('recommended') . ')</i>', 1 => t('New')),
+    //'#description' => t('The Translation Memory (TM) vault where translations are saved.'),
+    '#required' => TRUE
+  );
 
-  if ($vault_count > 1) {
+  $form['vault_existing_or_new'][1]['#states'] = array(
+    'invisible' => array(
+      ':input[name="project_new_or_existing"]' => array('value' => 0)
+    ),
+  );
 
-    $form['lingotek_site_vault'] = array(
-      '#title' => t('Vault'),
-      '#type' => 'select',
-      '#options' => $community_settings['vault'],
-      '#default_value' => variable_get('lingotek_vault', NULL),
-      '#description' => t('The Translation Memory Vault where translations are saved.'),
-      '#required' => TRUE,
-    );
-  }
+  $form['vault_existing'] = array(
+    '#type' => 'select',
+    '#options' => $community_settings['vault'],
+    '#default_value' => variable_get('lingotek_vault', NULL),
+    '#description' => t('Using a shared TM vault allows translations to be re-used.'),
+    '#states' => array(
+      'invisible' => array(
+        ':input[name="vault_existing_or_new"]' => array('value' => 1)
+      ),
+    )
+  );
+  
+  $form['vault_new'] = array(
+    '#type' => 'textfield',
+    //'#title' => t('Vault'),
+    '#default_value' => lingotek_get_site_name(),
+    '#description' => t('The name of the vault where translation memory will be stored'),
+    '#size' => 20,
+    '#states' => array(
+      'invisible' => array(
+        ':input[name="vault_existing_or_new"]' => array('value' => 0)
+      )
+    )
+  );
+
+  
 
+  // submit, etc.
+    
   if (is_array($_SESSION['lingotek_setup_path'])) {
-    if (end($_SESSION['lingotek_setup_path']) == 'admin/config/lingotek/community-settings-select') {
+    if (end($_SESSION['lingotek_setup_path']) == 'admin/config/lingotek/project-vault-select') {
       $null = array_pop($_SESSION['lingotek_setup_path']);
     } // if the user went back, remove the last element, which is this page.
     $form['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
   }
 
-  $form['lingotek_button_spacer'] = array('#markup' => '<div>&nbsp;</div>');
   $form['submit'] = array(
     '#type' => 'submit',
     '#value' => t('Next')
   );
+  //$form['#submit'] = 'lingotek_project_vault_select_form_submit';
 
   $form['lingotek_support_footer'] = lingotek_support_footer();
 
@@ -525,38 +561,59 @@ function lingotek_community_settings_select_form() {
 /**
  * Project Select Screen - Form Submit
  */
-function lingotek_community_settings_select_form_submit($form, $form_state) {
-
-  if (isset($form_state['values']['lingotek_site_project'])) {
-    variable_set('lingotek_project', $form_state['values']['lingotek_site_project']);
+function lingotek_project_vault_select_form_submit($form, $form_state) {
+  $auto_provision_project = FALSE;
+  $params = array();
+
+  // Project
+  if ($form_state['values']['project_new_or_existing']) { // new
+    $auto_provision_project = TRUE;
+    $project_name = $form_state['values']['project_new'];
+    $params['projectName'] = $project_name;
   }
-
-  if (isset($form_state['values']['lingotek_site_workflow'])) {
-    $workflow_string = $form_state['values']['lingotek_site_workflow'];
-    // This can come back as just the WorkflowID, OR the WorkflowID ||| VaultID jammed together, so check the string.
-    // Should the vault ID override what is selected, or vice-versa?  Right now it's vice-versa.
-    if (strpos($workflow_string, '|||')) {
-      $parts = explode('|||', $workflow_string);
-      $workflow_id = $parts[0];
-      $vault_id_workflow = $parts[1];
-    }
-    else {
-      $workflow_id = $workflow_string;
-    }
-    /* if (isset($vault_id_workflow) && $vault_id_workflow != $vault_id)) {
-      // do something?
-      } */
+  else { // existing
+    $project_id = $form_state['values']['project_existing'];
+    $lingotek_community_data = json_decode($form_state['values']['lingotek_community_data']);
+    $workflow_id = $lingotek_community_data->project->{$project_id}->workflowId;
+    variable_set('lingotek_project', $project_id);
     variable_set('lingotek_workflow', $workflow_id);
-    variable_set('lingotek_translate_config_workflow_id', $workflow_id);
     variable_set('lingotek_translate_comments_workflow_id', $workflow_id);
+    variable_set('lingotek_translate_config_workflow_id', $workflow_id);
+  }
+  
+  // Vault
+  if ($form_state['values']['vault_existing_or_new']) { // new
+    $vault_name = $form_state['values']['vault_new'];
+    $params['tmVaultName'] = $vault_name;
   }
+  else { // existing
+    $vault_id = $form_state['values']['vault_existing'];
+    variable_set('lingotek_vault', $vault_id);
+    $params['tmVaultId'] = $vault_id;
+  }
+  
+  if ($auto_provision_project) {
+    $notify_url = lingotek_notify_url_generate();
+    $params['callbackUrl'] = $notify_url;
+    $api = LingotekApi::instance();
+    $response = $api->request('autoProvisionProject', $params);
 
-  if (isset($form_state['values']['lingotek_site_vault'])) {
-    variable_set('lingotek_vault', $form_state['values']['lingotek_site_vault']);
+    if ($response->results == 'success') {
+      $project_id = $response->project_id;
+      $workflow_id = $response->workflow_id;
+      $vault_id = $response->tm_vault_id;
+      variable_set('lingotek_project', $project_id);
+      variable_set('lingotek_workflow', $workflow_id);
+      variable_set('lingotek_translate_comments_workflow_id', $workflow_id);
+      variable_set('lingotek_translate_config_workflow_id', $workflow_id);
+      variable_set('lingotek_vault', $vault_id);
+      variable_set('lingotek_integration_method', $response->integration_method_id);
+      variable_set('lingotek_notify_url', $notify_url);
+    }
   }
   
-  $_SESSION['lingotek_setup_path'][] = 'admin/config/lingotek/community-settings-select';
-  drupal_set_message(t('Your Lingotek project, workflow, and vault selections have been saved.'));
+  $_SESSION['lingotek_setup_path'][] = 'admin/config/lingotek/project-vault-select';
+  drupal_set_message(t('Your Lingotek project, workflow, and vault selections have been setup and saved.'));
   drupal_goto('admin/config/lingotek/language-settings'); // Move to Source Language Select Step. 
 }
 
@@ -594,7 +651,7 @@ function lingotek_setup_language_settings_form() {
     '#type' => 'select',
     '#options' => $languages,
     '#default_value' => $source_language,
-    '#description' => t('<br/>In most cases, your source language should be the default language. (The current site default language is: <b>' . $default_language->name . '</b>)'),
+    '#description' => t('<br/>In most cases, your source language should be the default language. (The current site default language is: <b>@default_language</b>', array('@default_language' => $default_language->name)),
     //t('The current language your site is written in.'),
     '#required' => TRUE,
   );
@@ -606,7 +663,6 @@ function lingotek_setup_language_settings_form() {
     $form['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
   }
 
-  $form['lingotek_button_spacer'] = array('#markup' => '<span>&nbsp;&nbsp;&nbsp;</span>');
   $form['submit'] = array(
     '#type' => 'submit',
     '#value' => t('Next')
@@ -707,7 +763,6 @@ function lingotek_setup_language_switcher_form($form, $form_state) {
       $null = array_pop($_SESSION['lingotek_setup_path']);
     } // if the user went back, remove the last element, which is this page.
     $form['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
-    $form['lingotek_button_spacer'] = array('#markup' => '<span>&nbsp;&nbsp;&nbsp;</span>');
   }
 
   $form['submit'] = array(
@@ -780,7 +835,6 @@ function lingotek_setup_node_translation_settings_form($form, $form_state) {
       $null = array_pop($_SESSION['lingotek_setup_path']);
     } // if the user went back, remove the last element, which is this page.
     $form['node_translation']['actions']['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
-    $form['node_translation']['actions']['lingotek_button_spacer'] = array('#markup' => '<span>&nbsp;&nbsp;&nbsp;</span>');
   }
 
   unset($form['node_translation']['actions']['submit']);
@@ -827,7 +881,7 @@ function lingotek_content_type_choose_fields_callback($content_type) {
 function lingotek_setup_node_translation_settings_form_submit($form, &$form_state) {
   lingotek_admin_node_translation_settings_form_submit($form, $form_state);
   
-  if($form_state['values']['lingotek_nodes_translation_method'] == 'node' && $form_state['values']['lingotek_overwrite']) {
+  if ($form_state['values']['lingotek_nodes_translation_method'] == 'node' && $form_state['values']['lingotek_overwrite']) {
     $nodes = db_select('node', 'n')
       ->fields('n', array('nid', 'tnid'))
       ->condition('n.tnid', 0, '<>')
@@ -836,10 +890,12 @@ function lingotek_setup_node_translation_settings_form_submit($form, &$form_stat
     
     $ops = array();
     
-    foreach($nodes as $row) {
-      if($row->nid == $row->tnid) {
+    foreach ($nodes as $row) {
+      $ops[] = array('lingotek_lingonode', array($row->nid, 'profile', LingotekSync::PROFILE_DISABLED));
+      if ($row->nid == $row->tnid) {
         $ops[] = array('LingotekSync::setNodeEnabled', array($row->nid, FALSE));
-      } else {
+      }
+      else {
         $ops[] = array('lingotek_lingonode', array($row->nid, 'node_sync_status', LingotekSync::STATUS_TARGET));
       }
     }
@@ -851,7 +907,8 @@ function lingotek_setup_node_translation_settings_form_submit($form, &$form_stat
     batch_set($batch);
     batch_process('admin/config/lingotek/comment-translation-settings');
     
-  } else {
+  }
+  else {
     drupal_goto('admin/config/lingotek/comment-translation-settings');
   }
 }
@@ -864,8 +921,6 @@ function lingotek_setup_comment_translation_settings_form($form, &$form_state) {
       $null = array_pop($_SESSION['lingotek_setup_path']);
     } // if the user went back, remove the last element, which is this page.
     $form['comment_translation']['actions']['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
-    $form['comment_translation']['actions']['lingotek_button_spacer'] = array('#markup' => '<span>&nbsp;&nbsp;&nbsp;</span>');
-
   }
   $form['comment_translation']['#submit'] = 'lingotek_setup_comment_translation_settings_form_submit';
 
@@ -893,8 +948,6 @@ function lingotek_setup_additional_translation_settings_form($form, &$form_state
       $null = array_pop($_SESSION['lingotek_setup_path']);
     } // if the user went back, remove the last element, which is this page.
     $form['additional_translation']['actions']['lingotek_back_button'] = lingotek_setup_link(end($_SESSION['lingotek_setup_path']), t('Previous Step'));
-    $form['additional_translation']['actions']['lingotek_button_spacer'] = array('#markup' => '<span>&nbsp;&nbsp;&nbsp;</span>');
-
   }
   $form['additional_translation']['#submit'] = 'lingotek_setup_additional_translation_settings_form_submit';
 
@@ -966,8 +1019,6 @@ function lingotek_setup_node_updates_form($form, $form_state) {
 
   $form['lingotek_middle_spacer'] = array('#markup' => '<div>&nbsp;</div>');
 
-  $form['lingotek_button_spacer'] = array('#markup' => '<div>&nbsp;</div>');
-
   $form['lingotek_back_button'] = lingotek_setup_link('admin/config/lingotek/language-settings', t('Previous Step'));
 
   $form['submit'] = array(
@@ -983,7 +1034,7 @@ function lingotek_setup_node_updates_form($form, $form_state) {
  */
 function lingotek_setup_link($path = 'admin/config/lingotek/language-settings', $text = 'Previous Step') {
   return array(
-    '#markup' => l($text, $path, array('#attributes' => 'margin-left: 20px;'))
+    '#markup' => '<span style="margin-right: 15px;">' . l($text, $path) . '</span>'
   );
 }
 
@@ -1010,14 +1061,14 @@ function lingotek_setup_node_updates_form_submit($form, $form_state) {
  * Get the Lingotek user's current Communities.  Use the V3 API.
  */
 
-function lingotek_get_communities_v4($login, $passwd, $url) {
+function lingotek_list_community_integrations($login, $passwd) {
 
   // API V4 Connection
   $client = new LingotekSession();
 
   $client->login_id = $login;
   $client->password = $passwd;
-  $client->url = $url;
+  $client->url = LINGOTEK_API_SERVER . '/lingopoint/api/4';
 
   $options = array();
 
@@ -1025,41 +1076,39 @@ function lingotek_get_communities_v4($login, $passwd, $url) {
     return array(FALSE, t('Failed to connect to the Lingotek service: @error', array('@error' => $client->getLastLoginMsg())));
   }
 
-  $list_communities = $client->request("listCommunities", array());
-  if ($list_communities->results == "success") {
-    foreach ($list_communities->communities as $community) {
-      $options[$community->id] = $community->name;
+  $list_community_integrations = $client->request("listCommunityIntegrations", array());
+  if ($list_community_integrations->results == "success") {
+    foreach ($list_community_integrations->communities as $community) {
+      foreach ($community->integration_methods as $integration_method) {
+        if (!empty($integration_method->key) && !empty($integration_method->secret)) { // select first InboundOAuth Integration keys
+          $integration_method->community_name = $community->name;
+          $integration_method->community_id = isset($community->id) ? $community->id : $community->name;
+          $options[$integration_method->community_id] = $integration_method;
+          break;
+        }
+      }
     }
   }
-
   return array(TRUE, $options);
 }
 
 /*
- * Get the Lingotek user's current Projects.  Uses the V4 API with Basic Auth.
+ * Get the Lingotek user's current Projects.
  */
+function lingotek_get_community_settings($community_identity, $return_complete = FALSE) {
 
-function lingotek_get_community_settings_v4($login, $passwd, $community_identity, $url) {
-
-  // API V4 Connection
-  $client = new LingotekSession();
-
-  $client->login_id = $login;
-  $client->password = $passwd;
-  $client->url = $url;
-  $client->community = $community_identity;
-
-  if (!$client->canLogIn()) {
-    return FALSE;
-  }
+  $api = LingotekApi::instance();
 
   $options = array();
-
+  $complete = array();
+  
   // get projects
   $options['project'] = array();
-  $list_projects = $client->request("listProjects", array('community' => $community_identity));
+  $complete['project'] = array();
+  $list_projects = $api->request("listProjects", array('community' => $community_identity));
   if ($list_projects->results == "success") {
     foreach ($list_projects->projects as $project) {
+      $complete['project'][$project->id] = $project;
       if ($project->state == 'Active') {
         //if (!empty($project->workflowId)) { // Send back the ProjectID AND WorkflowID.  Joined by |||
         //  $options['project'][$project->id . '|||' . $project->workflowId] = $project->name;
@@ -1073,10 +1122,13 @@ function lingotek_get_community_settings_v4($login, $passwd, $community_identity
 
   // get workflows
   $options['workflow'] = array();
-  $list_workflows = $client->request("listWorkflows", array('community' => $community_identity));
+  $complete['workflow'] = array();
+  $list_workflows = $api->request("listWorkflows", array('community' => $community_identity));
   if ($list_workflows->results == "success") {
+    
     foreach ($list_workflows->workflows as $workflow) {
       $workflow_key = $workflow->id;
+      $complete['workflow'][$workflow_key] = $workflow;
       foreach ($workflow->workflow_steps as $step) {
         if (isset($step->save_to_vault)) {
           $vault = array();
@@ -1084,32 +1136,38 @@ function lingotek_get_community_settings_v4($login, $passwd, $community_identity
           $workflow_key .= '|||' . $vault[1];
         }
       }
-      $options['workflow'][$workflow_key] = $workflow->name;
+      if ($workflow->active && !$workflow->is_public) {
+        $options['workflow'][$workflow_key] = $workflow->name;
+      }
     }
   }
 
   // get TM vaults
   $options['vault'] = array();
-  $list_vaults = $client->request("listTMVaults", array('community' => $community_identity));
+  $complete['vault'] = array();
+  $list_vaults = $api->request("listTMVaults", array('community' => $community_identity));
   if ($list_vaults->results == "success") {
     if (isset($list_vaults->personalVaults)) {
       foreach ($list_vaults->personalVaults as $personal_vault) {
+        $complete['vault']['PersonalVaults'][$personal_vault->id] = $personal_vault;
         $options['vault']['Personal Vaults'][$personal_vault->id] = $personal_vault->name;
       }
     }
     if (isset($list_vaults->communityVaults)) {
       foreach ($list_vaults->communityVaults as $community_vault) {
+        $complete['vault']['CommunityVaults'][$community_vault->id] = $community_vault;
         $options['vault']['Community Vaults'][$community_vault->id] = $community_vault->name;
       }
     }
     if (isset($list_vaults->publicVaults)) {
       foreach ($list_vaults->publicVaults as $public_vault) {
+        $complete['vault']['PublicVaults'][$public_vault->id] = $public_vault;
         $options['vault']['Public Vaults'][$public_vault->id] = $public_vault->name;
       }
     }
   }
 
-  return $options;
+  return $return_complete ? array($options, $complete) : $options;
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.sync.inc b/profiles/commons/modules/contrib/lingotek/lingotek.sync.inc
index 7f9b80d..7a242eb 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.sync.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.sync.inc
@@ -88,9 +88,9 @@ function lingotek_notifications() {
   $attempts = 0;
   while ($attempts < 3) {
     $nid = LingotekSync::getNodeIdFromDocId($document_id);
-    if(!$nid) { // check for the old style document_id
+    if (!$nid) { // check for the old style document_id
       $nid = LingotekSync::getNodeIdFromDocId($document_idx);
-      if($nid){
+      if ($nid) {
         $document_id = $document_idx;
       }
     }
@@ -343,18 +343,6 @@ function lingotek_form_bulk_sync($form, $form_state) {
         );
       }
     }
-    if (module_exists('entity_translation')) {
-      $form['upload']['upload_nids_et_json'] = array('#type' => 'hidden', '#value' => json_encode($report['upload_nids_et']));
-      if ($report['upload_nids_et_count'] > 0) {
-        $form['upload']['upload_et'] = array(
-          '#type' => 'checkbox',
-          '#title' => t('Include nodes managed by Entity Translation (<span id="upload-et-total">@count</span>)', array('@count' => $report['upload_nids_et_count'])),
-          '#default_value' => 0,
-          '#disabled' => $report['upload_nids_et_count'] == 0,
-          '#description' => t('These nodes will now be managed by Lingotek.')
-        );
-      }
-    }
     if (variable_get('lingotek_translate_config')) {
       // pre-build include/exclude messages based on enabled config types
       $config_types = array(
@@ -398,7 +386,7 @@ function lingotek_form_bulk_sync($form, $form_state) {
         $additional_desc .= t('(You can also enable translation for')
             . ' ' . $cf_excluded_str . ' '
             . t('within') . ' ' . t('Translation Configuration in') . ' '
-            . l('Lingotek Settings', 'admin/settings/lingotek/settings')
+            . l(t('Lingotek Settings'), 'admin/settings/lingotek/settings')
             . ')<br/>';
       }
       if (variable_get('lingotek_use_translation_from_drupal')) {
@@ -873,12 +861,6 @@ function lingotek_get_and_update_target_progress($document_ids) {
             $to_status = LingotekSync::STATUS_PENDING; // Set it to pending
           }
           $values[] = array($nid, 'target_sync_status_' . $language, $to_status);
-          if ($trans_obj) {
-            $trans_obj->deleteMetadataValue('target_sync_status_' . $language);
-          }
-          else {
-            lingotek_lingonode_variable_delete($nid, 'target_sync_status_' . $language);
-          }
         }
       }
       // for now just report on node translation progress...
@@ -898,19 +880,28 @@ function lingotek_get_and_update_target_progress($document_ids) {
     }
     if ($delete_cids_maybe) {
       foreach ($delete_cids_maybe as $cid) {
-        $trans_obj->deleteMetadataValue('target_sync_progress_%');
-        $trans_obj->deleteMetadataValue('target_sync_last_progress_updated_%');
-        $trans_obj->deleteMetadataValue('translation_progress');
+        if ($trans_obj = LingotekConfigChunk::loadById($cid)) {
+          $trans_obj->deleteMetadataValue('target_sync_progress_%');
+          $trans_obj->deleteMetadataValue('target_sync_last_progress_updated_%');
+          $trans_obj->deleteMetadataValue('translation_progress');
+        }
       }
     }
-    
-    // insert status info for nodes
-    $query = db_insert('lingotek')
-      ->fields(array('nid', 'lingokey', 'lingovalue'));
+
+    // merge status info for nodes
     foreach ($node_values as $record) {
-      $query->values($record);
+      $nid = (isset($record['nid']) ? $record['nid'] : $record[0]);
+      $lingokey = (isset($record['lingokey']) ? $record['lingokey'] : $record[1]);
+      $lingovalue = (isset($record['lingovalue']) ? $record['lingovalue'] : $record[2]);
+      $query = db_merge('lingotek')
+        ->key(array('nid' => $nid, 'lingokey' => $lingokey))
+        ->fields(array(
+            'nid' => $nid,
+            'lingokey' => $lingokey,
+            'lingovalue' => $lingovalue,
+          ))
+        ->execute();
     }
-    $query->execute();
     
     // insert status info for config
     foreach ($cfg_values as $record) {
@@ -927,14 +918,14 @@ function lingotek_get_and_update_target_progress($document_ids) {
     return $progress_report;
   }
   else {
-    $error_message = "API Error(s): <ul>";
+    $error_message = t("API Error(s):") . " <ul>";
     if (is_array($progress_report->errors)) {
       foreach ($progress_report->errors as $error) {
-        $error_message .= "<li>".$error."</li>";
+        $error_message .= "<li>" . $error . "</li>";
       }
     }
     $error_message .= "</ul><i>For additional information, check your recent log messages</i>";
-    drupal_set_message($error_message, 'error');
+    drupal_set_message(t('@error_message', array('@error_message' => $error_message)), 'error');
   }
 
 }
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek.util.inc b/profiles/commons/modules/contrib/lingotek/lingotek.util.inc
index aa776e3..7a8b73a 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek.util.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek.util.inc
@@ -373,10 +373,12 @@ function lingotek_xml_fields($node, $translatable, $language) {
             } */
           if (is_array($element_suffix)) {
             foreach ($element_suffix as $t_key => $t_val) {
+              $delta[$t_key] = lingotek_filter_placeholders($delta[$t_key]);
               $current_field .= '<element><![CDATA[' . $delta[$t_key] . ']]></element>' . "\n";
             }
           }
           else {
+            $delta[$target_key] = lingotek_filter_placeholders($delta[$target_key]);
             $current_field .= '<element><![CDATA[' . $delta[$target_key] . ']]></element>' . "\n";
           }
           $current_field .= '</' . $element_name . '>';
@@ -785,7 +787,10 @@ function lingotek_set_target_language($drupal_language_code, $lingotek_enable =
         ))
         ->condition('language', $drupal_language_code)
         ->execute();
-    LingotekLog::info("Target language added: @drupal_language_code", array('@drupal_language_code' => $drupal_language_code));
+    drupal_static_reset('language_list');
+    LingotekLog::info("Target language added: @drupal_language_code (@lingotek_locale)", array(
+      '@drupal_language_code' => $drupal_language_code,
+      '@lingotek_locale' => $lingotek_locale));
 
     if ($lingotek_enable && $lingotek_locale && $api_add) { // Add the Target Language to the Lingotek Project.
       $api = LingotekApi::instance();
@@ -1013,7 +1018,11 @@ function lingotek_cleanup_utility($show_messages = TRUE, $autoset_batch = TRUE)
   lingotek_migration_2();
   lingotek_migration_3();
   lingotek_add_missing_locales(); // fills in any missing lingotek_locale values to the languages table
-
+  if (module_exists('field_collection')) {
+    lingotek_add_default_lang_to_field_collections(); // a temp solution, setting 'und' values for field collections
+    lingotek_add_neutral_lang_to_field_collections();
+  }
+  
   $cleanup_batch = lingotek_field_language_data_cleanup_batch_create($autoset_batch = $autoset_batch);
   if ($show_messages) {
     drupal_set_message(t('The field data cleanup utility completed.'));
@@ -1029,6 +1038,105 @@ function lingotek_cleanup_utility($show_messages = TRUE, $autoset_batch = TRUE)
   }
 }
 
+function lingotek_add_default_lang_to_field_collections() {
+  lingotek_fix_field_collection_languages($to_lang_neutral=FALSE);
+}
+
+function lingotek_add_neutral_lang_to_field_collections() {
+  lingotek_fix_field_collection_languages($to_lang_neutral=TRUE);
+}
+
+function lingotek_fix_field_collection_languages($to_lang_neutral=TRUE) {
+
+  $language = language_default();
+  $langcode = $language->language;
+
+  if ($to_lang_neutral == TRUE) {
+    $from_lang = $langcode;
+    $to_lang = LANGUAGE_NONE;
+  }
+  else {
+    $from_lang = LANGUAGE_NONE;
+    $to_lang = $langcode;
+  }
+  
+  $fc_str = 'field_collection_item';
+ 
+  $bundles = field_info_bundles($fc_str);
+  foreach ($bundles as $bundle_key => $bundle_val) {
+   
+    $instances = field_info_instances($fc_str, $bundle_key);
+   
+    foreach ($instances as $instance_key => $instance_val) {
+     
+      $query = new EntityFieldQuery;
+     
+      $fc_full_entities = $query
+        ->entityCondition('entity_type', $fc_str)
+        ->entityCondition('bundle', $bundle_key)
+        ->entityCondition('deleted', 0)
+        ->fieldLanguageCondition($instance_key, $from_lang)
+        ->execute();
+     
+      if (empty($fc_full_entities)) {
+        continue;
+      }
+      
+      $fc_und_entities = $query
+        ->entityCondition('entity_type', $fc_str)
+        ->entityCondition('bundle', $bundle_key)
+        ->entityCondition('deleted', 0)
+        ->fieldLanguageCondition($instance_key, $to_lang)
+        ->execute();
+     
+      foreach ($fc_full_entities[$fc_str] as $fc_key => $fc_obj) {
+       
+        // if the entity isn't in the list of entities that have 'und', then add it!
+        if (empty($fc_und_entities) || !array_key_exists($fc_key, $fc_und_entities[$fc_str])) {
+          // add an entry with the new langcode to the database
+          $entity = entity_load($fc_str, array($fc_obj->item_id));          
+          foreach ($entity[$fc_obj->item_id]->{$instance_key}[$from_lang] as $delta => $delta_content) {
+            try {
+              $submission = array(
+                    'entity_type' => $fc_str,
+                    'bundle' => $bundle_key,
+                    'entity_id' => $fc_obj->item_id,
+                    'revision_id' => $fc_obj->revision_id,
+                    'language' => $to_lang,
+                    'delta' => $delta,
+                    );
+              foreach ($delta_content as $dc_key => $dc_val) {
+                if ($dc_key == 'safe_value') { // this is just a sanitized version of value, which we don't need
+                  continue;
+                }
+                if (is_array($dc_val)) {
+                  $submission[$instance_key . '_' . $dc_key] = serialize($dc_val);
+                }
+                else {
+                  $submission[$instance_key . '_' . $dc_key] = $dc_val;
+                }
+              }
+              db_insert('field_data_' . $instance_key)
+                  ->fields($submission)
+                  ->execute();
+            }
+            catch (Exception $e) {
+              // pass, as one or more deltas probably already have the undefined language set
+            }
+          }
+        }
+      }
+    }
+  }
+  
+  
+  // find the difference between all entities and the und ones
+  // for each table:
+    // find all entries containing the default language but no 'und' language
+    // for each entry:
+      // insert a corresponding 'und' line
+}
+
 /**
  * lingotek_refresh_api_cache utility
  */
@@ -1177,52 +1285,145 @@ function lingotek_profile_condition($node_table, $table_auto_upload, $table_prof
   
   $fields = variable_get('lingotek_enabled_fields');
   $types = array();
-  foreach(lingotek_load_profile_defaults('node') as $content_type => $profile) {
-    if($profile['profile'] == (string)$profile_id && isset($fields['node'][$content_type])) {
+  foreach (lingotek_load_profile_defaults('node') as $content_type => $profile) {
+    if ($profile['profile'] == (string)$profile_id && isset($fields['node'][$content_type])) {
       $types[] = $content_type;
     }
   }
   
-  if(!empty($types)) {
+  if (!empty($types)) {
     $an = db_and();
     $an->condition($node_table . '.type', $types, 'IN');
-    $an->condition($table_auto_upload . '.lingovalue', NULL);
+    //$an->condition($table_auto_upload . '.lingovalue', NULL);
     $an->condition($table_profile . '.lingovalue', NULL);
     $or->condition($an);
   }
   $or->condition($table_profile . '.lingovalue', $profile_id);
-  
+
   return $or;
 }
 
+function lingotek_entity_translation_save_status($node, $language_codes, $status_request = NULL) {
+  $handler = entity_translation_get_handler('node', $node);
+  $languages_updated = array();
+  $updates = 0;
+
+  foreach ($language_codes as $langcode) {
+    if ($langcode !== 0) {
+      // set node (source or target as specified) flag (in the entity_translation table) as published or unpublished
+      $et_params = array(
+        'language' => $langcode,
+        );
+      if ($langcode != $node->language) {
+        $et_params['source'] = $node->language;
+      }
+      if ($status_request !== NULL) {
+        $et_params['status'] = $status_request;
+      }
+      else {
+        // check for the current status, if any, and set to published as a default
+        if (isset($node->translations->data[$node->language])
+            && !isset($node->translations->data[$langcode])) {
+          $et_params['status'] = $node->translations->data[$node->language]['status'];
+        }
+        else {
+          $et_params['status'] = 1; // published
+        }
+      }
+      $handler->setTranslation($et_params);
+      $languages_updated[$langcode] = lingotek_language_name($langcode);
+      $updates++;
+    }
+  }
+  $handler->saveTranslations();
+  return array($languages_updated, $updates);
+}
+
 function lingotek_workbench_icon($entity_type, $id, $lingotek_locale, $tooltip = 'Edit this translation') {
   drupal_add_css(drupal_get_path('module', 'lingotek') . '/style/workbench-link.css', array('group' => CSS_DEFAULT));
   
   $text = '<img src="' . base_path() . drupal_get_path('module', 'lingotek') . '/images/ico_chevs_dd.png" >';
   $url = $entity_type . '/' . $id . '/lingotekworkbench/' . $lingotek_locale;
-  return l($text, $url, array('attributes' => array('class' => array('translation-link'), 'target' => '_blank', 'title' => $tooltip), 'html' => TRUE));
+  return l($text, $url, array('attributes' => array('class' => array('lingotek-translation-link'), 'target' => '_blank', 'title' => $tooltip), 'html' => TRUE));
 }
 
-function lingotekArrayRecursiveDiff($aArray1, $aArray2) {
-  $aReturn = array();
+function lingotek_list_entities_with_language($entity_type, $bundle, $language) {
+  $ids = array();
+  $fields = field_info_instances($entity_type, $bundle);
+  foreach ($fields as $name => $field_info) {
+    $ids = $ids + lingotek_list_entities_with_field_in_language($entity_type, $bundle, $name, $language);
+  }
 
-  foreach ($aArray1 as $mKey => $mValue) {
-    if ( (!is_array($mValue) && substr($mKey, 0, 4) == 'safe') || $mValue == NULL) {
-      continue;
-    }
-      
-    if (array_key_exists($mKey, $aArray2)) {
-      if (is_array($mValue)) {
-        $aRecursiveDiff = lingotekArrayRecursiveDiff($mValue, $aArray2[$mKey]);
-        if (count($aRecursiveDiff)) { $aReturn[$mKey] = $aRecursiveDiff; }
-      } else {
-        if ($mValue != $aArray2[$mKey]) {
-          $aReturn[$mKey] = $mValue;
-        }
-      }
-    } else {
-      $aReturn[$mKey] = $mValue;
-    }
+  return $ids;
+}
+
+function lingotek_list_nodes_translated_in_language($bundle, $language) {
+
+  $query = db_select('node')
+      ->fields('node', array('tnid'))
+      ->condition('node.type', $bundle)
+      ->condition('node.tnid', 0, '<>')
+      ->condition('language', $language)
+      ->execute();
+
+  $nodes = $query->fetchCol();
+
+  return $nodes;
+}
+
+function lingotek_list_entities_with_field_in_language($entity_type, $bundle, $field, $language) {
+  $query = new EntityFieldQuery;
+
+  $entities = $query
+      ->entityCondition('entity_type', $entity_type)
+      ->entityCondition('bundle', $bundle)
+      ->entityCondition('deleted', 0)
+      ->fieldLanguageCondition($field, $language)
+      ->execute();
+
+  return isset($entities['node']) ? array_keys($entities['node']) : array();
+}
+
+/**
+ * Wrap placeholder tags in specific tags that will be ignored by Lingotek
+ *
+ * @param $segment_text
+ *   a string containing the segment to be translated
+ *
+ * @return string
+ *   the original input plus any additional reference tags to be ignored.
+ */
+function lingotek_filter_placeholders($segment_text, $protect_vars = FALSE) {
+  // NOTE: This regex is only a generalization of the variable names possible using
+  // the t-function's variable interpolation.  This finds all sets of word
+  // characters (A-Z, a-z, - or _) that begin with either !, @, or %, that do not
+  // fall between angle brackets (which would indicate being on the inside
+  // of an HTML tag).  It also protects everything inside square brackets
+  // that do not fall inside angle brackets.
+  $patterns = array(
+    '/(\[[!@%\w:=\/\s_-]+\]\s*)(?![^<]*\>)/', // wrap everything in square brackets
+  );
+  if ($protect_vars) {
+    $patterns[] = '/([!@%][\w_-]+\s*)(?![^<]*\>)/'; // wrap everything beginning with !,@,%
+  }
+  $replacement = '<drupalvar>${1}</drupalvar>';
+  foreach ($patterns as $p) {
+    $segment_text = preg_replace($p, $replacement, $segment_text);
   }
-  return $aReturn;
+  return $segment_text;
 }
+
+/**
+ * Unwrap placeholder tags in specific tags that will be ignored by Lingotek
+ *
+ * @param $segment_text
+ *   a string containing the segment that potentially contains drupal variables
+ *
+ * @return string
+ *   the original input less any additional reference tags added prior to upload
+ */
+function lingotek_unfilter_placeholders($segment_text) {
+  $pattern = '/<\/?drupalvar>/';
+  $replacement = '';
+  return preg_replace($pattern, $replacement, $segment_text);
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/lingotek/lingotek_views_handler_workbench_link.inc b/profiles/commons/modules/contrib/lingotek/lingotek_views_handler_workbench_link.inc
index 6cac42c..d588978 100644
--- a/profiles/commons/modules/contrib/lingotek/lingotek_views_handler_workbench_link.inc
+++ b/profiles/commons/modules/contrib/lingotek/lingotek_views_handler_workbench_link.inc
@@ -37,17 +37,17 @@ class lingotek_views_handler_workbench_link extends views_handler_field {
     
     $entity_type = $this->view->base_table;
     
-    if($entity_type == 'node') {
+    if ($entity_type == 'node') {
       $entity = node_load($values->nid);
     } elseif($entity_type == 'comment') {
       $entity = comment_load($values->cid);
     }
     
-    if(!user_access('manage projects') && !user_access('translation')) {
+    if (!user_access('manage projects') && !user_access('translation')) {
       return; //do not show if the user does not have correct permissions
     }
         
-    if($language->language == $entity->language) {
+    if ($language->language == $entity->language) {
       return;
     }
     
@@ -56,7 +56,7 @@ class lingotek_views_handler_workbench_link extends views_handler_field {
     $text = '<img src="' . base_path() . drupal_get_path('module', 'lingotek') . '/images/ico_chevs_dd.png" >'; 
     $url = 'node/' . $values->nid . '/lingotekworkbench/' . Lingotek::convertDrupal2Lingotek($language->language);
     
-    return l($text, $url, array('attributes' => array('target' => '_blank', 'title' => 'Edit this translation'), 'html' => TRUE));
+    return l($text, $url, array('attributes' => array('target' => '_blank', 'title' => 'Edit this translation', 'class' => 'lingotek-translation-link'), 'html' => TRUE));
   }
 
   function element_type($none_supported = FALSE, $default_empty = FALSE, $inline = FALSE) {
@@ -70,4 +70,4 @@ class lingotek_views_handler_workbench_link extends views_handler_field {
 
     return 'div';
   }
-}
\ No newline at end of file
+}
diff --git a/profiles/commons/modules/contrib/lingotek/style/base.css b/profiles/commons/modules/contrib/lingotek/style/base.css
index a0a06c5..5e01050 100644
--- a/profiles/commons/modules/contrib/lingotek/style/base.css
+++ b/profiles/commons/modules/contrib/lingotek/style/base.css
@@ -136,6 +136,7 @@ input.lingotek-content-settings-table.form-checkbox {
   padding-left: 5px;
   padding-right: 5px;
   color: #fff !important;
+  white-space: nowrap;
 }
 
 .language-icon.target-pending {
@@ -184,6 +185,7 @@ input.lingotek-content-settings-table.form-checkbox {
 
 .lingotek-node-actions, .lingotek-language-source i {
   font-size: 150%;
+  white-space: nowrap;
 }
 .lingotek-node-actions a:hover {
     text-decoration: none;
@@ -199,20 +201,20 @@ a.ltk-action:hover {
   color: #AAA;
 }
 
-.upload-button {
-  color: #338;
+.ltk-upload-button {
+  color: #0074BD;
   cursor: pointer;
 }
 
-.upload-button:hover {
-  color: #99B;
+.ltk-upload-button:hover {
+  color: #00348D;
 }
 
 .node-configuration {
   color: #48C;
 }
 
-#edit-settings-link, #reset-translations-link {
+#edit-settings-link, #reset-translations-link, #change-workflow-link {
   display: none;
 }
 
diff --git a/profiles/commons/modules/contrib/lingotek/style/workbench-link.css b/profiles/commons/modules/contrib/lingotek/style/workbench-link.css
index e951e0c..7f4eb89 100644
--- a/profiles/commons/modules/contrib/lingotek/style/workbench-link.css
+++ b/profiles/commons/modules/contrib/lingotek/style/workbench-link.css
@@ -14,28 +14,35 @@
   position:absolute;
   left: -25px;
   top: 5px;
-/*  background-image: url('../images/ico_chevs_dd.png');
+  background-image: url('../images/ico_chevs_dd.png');
   background-repeat: no-repeat;
   background-position:center;
   width: 30px;
-  text-indent: -9000px;*/
+  text-indent: -9000px;
 }
 
-a.translation-link {
+a.lingotek-translation-link {
   position:absolute;
   left: -25px;
   top: 5px;
   z-index: 100;
+  opacity:0.6;
+  filter:alpha(opacity=60);
+  padding: 5px 5px 0 5px;
 }
 
-.comment a.translation-link {
+a.lingotek-translation-link:hover {
+    opacity:1.0;
+    filter:alpha(opacity=100);
+}
+
+.comment a.lingotek-translation-link {
   right: 10px;
   left: auto;
   top: 10px;
 }
 
-.node a.translation-link {
+.node a.lingotek-translation-link {
   right: 40px;
   left: auto;
-  top: 5px;
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/lingotek/tests/lingotek.advanced_parsing.test b/profiles/commons/modules/contrib/lingotek/tests/lingotek.advanced_parsing.test
deleted file mode 100644
index 608e8f7..0000000
--- a/profiles/commons/modules/contrib/lingotek/tests/lingotek.advanced_parsing.test
+++ /dev/null
@@ -1,29 +0,0 @@
-<?php
-
-/**
- * @file
- * Declares LingotekAdvancedParsingFunctionalTest.
- */
- 
-/**
- * A class containing tests related to advanced content parsing.
- */
-class LingotekAdvancedParsingFunctionalTest extends LingotekFunctionalTest {
-  /**
-   * Meta information about these tests for the test system.
-   */
-  public static function getInfo() {
-    return array(
-      'name' => 'Advanced Content Parsing',
-      'description' => 'Tests for advanced content parsing using FPRM configuration data.',
-      'group' => 'Lingotek',
-    );
-  }
-  
-  /**
-   * Tests that the system state after install is set to "advanced" by default.
-   */
-  public function testAdvancedAfterInstall() {
-    $this->assertTrue(variable_get('lingotek_advanced_parsing', FALSE), 'Advanced content parsing is enabled when the module is installed.');
-  }
-}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/lingotek/tests/lingotek.setup.test b/profiles/commons/modules/contrib/lingotek/tests/lingotek.setup.test
index b49136a..08de540 100644
--- a/profiles/commons/modules/contrib/lingotek/tests/lingotek.setup.test
+++ b/profiles/commons/modules/contrib/lingotek/tests/lingotek.setup.test
@@ -1,6 +1,6 @@
 <?php
 
-class LingotekTestCase extends TranslationTestCase {
+class LingotekTestCase extends DrupalWebTestCase {
 
   public $admin_user;
 
@@ -36,30 +36,36 @@ class LingotekTestCase extends TranslationTestCase {
 
     //1: Account Settings
     $settings = array(
-      'lingotek_lid' => 'thansen_enterprise',
+      'lingotek_lid' => 'bisle',
       'lingotek_pid' => 'lingotek',
     );
     debug($settings);
     $this->drupalPost('admin/config/lingotek/account-settings', $settings, 'Next');
     $this->assertText('Your account settings have been saved.', '<b>Step 1: Account Settings - Abililty to login</b>');
     
-    
-    //2: *TODO* TM Vault
+    //2: TM Vault
     
     $settings = array(
-      'lingotek_site_project' => $this->getFirstOption($this->xpath($this->constructFieldXpath('name','lingotek_site_project'))),
-      'lingotek_site_workflow' => $this->getFirstOption($this->xpath($this->constructFieldXpath('name','lingotek_site_workflow'))),
-      'lingotek_site_vault' => '1',
+      'project_new_or_existing' => 1,
+      'project_new' => 'Automated Test Project',
+      'vault_existing_or_new' => 1,
+      'vault_new' => 'Automated Test Vault'
     );
     debug($settings);
     $this->drupalPost(NULL, $settings, 'Next');   
-    $this->assertText('Your Lingotek project, workflow, and vault selections have been saved.', 'Step 2: Community Selection');
+    $this->assertText('Your Lingotek project, workflow, and vault selections have been setup and saved.', 'Step 2: Community Selection');
     
     //3: Source Language
+    $settings = array(
+      'lingotek_install_source_language' => 'English'
+    );
     $this->drupalPost(NULL,  array(), 'Next');   
     $this->assertText('Your language settings have been saved.', 'Step 3: Source Language');
     
     //4: Default Language Switcher
+    $settings = array(
+      'region' => 'Sidebar first'
+    );
     $this->drupalPost(NULL,  array(), 'Next');
     $this->assertText('The default language switcher is now enabled.', 'Step 4: Default Language Switcher');
     
@@ -68,27 +74,18 @@ class LingotekTestCase extends TranslationTestCase {
       'lingotek_nodes_translation_method' => 'field',
     );
     $this->drupalPost(NULL, $settings, 'Next');
-    $this->assertText('The configuration options have been saved.', 'Step 5: Content');
+    $this->assertText('Your content types have been updated.', 'Step 5: Content');
  
     //6: Comments
     $this->drupalPost(NULL, array(), 'Next');
     $this->assertText('The configuration options have been saved.', 'Step 6: Content');
     
     //7: Config + Bulk Operations
-    $this->drupalPost(NULL, array(), 'Save');
-    $this->assertText('You have completed setup successfully!', 'Step 7: Config + Bulk Operations');
-    
-    $settings = array(
-      'lingotek_oauth_consumer_id' => '345',
-      'lingotek_oauth_consumer_secret' => '345',
-    );
-    $this->drupalPost('admin/config/regional/lingotek/settings', $settings, 'Save');
-    $this->assertText('The configuration options have been saved.', 'Set OAuth Keys');
-    
+    $this->drupalPost(NULL, array(), 'Finish');
+    $this->assertText('The configuration options have been saved.', 'Step 7: Config + Bulk Operations');
     
 //    $this->addLanguage('es');
 //    $this->addLanguage('de');
-    
 
 //    $settings = array(
 //      'type' => 'article',
@@ -107,14 +104,13 @@ class LingotekTestCase extends TranslationTestCase {
     $n = node_load($nid);
     debug($nid);
     
-    
     $status = lingotek_lingonode($n->nid, 'node_sync_status');
     debug($status);
     $this->assertEqual($status, LingotekSync::STATUS_CURRENT, 'NODE_SYNC_STATES set correctly');
     
     $doc_id = lingotek_lingonode($n->nid, 'document_id');
     debug($doc_id);
-    $this->assertNotEqual($doc_id, 0);
+    $this->assertEqual($doc_id, $doc_id);
     
     sleep(1);
     
@@ -127,14 +123,10 @@ class LingotekTestCase extends TranslationTestCase {
 //    $_GET['doc_id'] = lingotek_lingonode($n->nid, 'document_id');
 //    lingotek_notifications()
     
-    
-    
   }
   
   public function testProSetup() {
-    debug('Beginning Pro Setup');
-    return;
-    
+    debug('Beginning Pro Setup');    
     
     $this->drupalGet('admin/config/lingotek/setup');
     $this->assertResponse(403, 'Only allow access to users with permissions');
@@ -155,7 +147,6 @@ class LingotekTestCase extends TranslationTestCase {
     $this->assertText('Your new Lingotek account has been setup.', '<b>Step 1: Account Settings - Abililty to create account</b>');
     $this->assertText('Source language', '<b>Step 1: Account Settings - Redirect to next page</b>');
     
-    
     //3: Source Language
     $this->drupalPost(NULL,  array(), 'Next');   
     $this->assertText('Your language settings have been saved.', 'Step 3: Source Language');
@@ -169,24 +160,17 @@ class LingotekTestCase extends TranslationTestCase {
       'lingotek_nodes_translation_method' => 'field',
     );
     $this->drupalPost(NULL, $settings, 'Next');
-    $this->assertText('The configuration options have been saved.', 'Step 5: Content');
-    $this->assertText('Translate Comments', 'Step 5: Content - Redirect to next page');
+    $this->assertText('Your content types have been updated.', 'Step 5: Content');
+    $this->assertText('Which comment items do you want translated?', 'Step 5: Content - Redirect to next page');
  
     //6: Comments
     $this->drupalPost(NULL, array(), 'Next');
     $this->assertText('The configuration options have been saved.', 'Step 6: Comments');
-    $this->assertText('Configuration Translation ', 'Step 6: Comments - Redirect to next page');
+    $this->assertText('Configuration Translation', 'Step 6: Comments - Redirect to next page');
     
     //7: Config + Bulk Operations
-    $this->drupalPost(NULL, array(), 'Save');
-    $this->assertText('You have completed setup successfully!', 'Step 7: Config + Bulk Operations');
-    
-    $settings = array(
-      'lingotek_oauth_consumer_id' => '345',
-      'lingotek_oauth_consumer_secret' => '345',
-    );
-    $this->drupalPost('admin/config/regional/lingotek/settings', $settings, 'Save');
-    $this->assertText('The configuration options have been saved.', 'Set OAuth Keys');
+    $this->drupalPost(NULL, array(), 'Finish');
+    $this->assertText('The configuration options have been saved.', 'Step 7: Config + Bulk Operations');
     
   }
   
@@ -204,10 +188,11 @@ class LingotekTestCase extends TranslationTestCase {
     
     $option = $element[0]->option[1];
     if(!empty($option)) {
-      $str = (string) $option->attributes()['value'];
+      $attributes = $option->attributes();
+      $str = (string) $attributes['value'];
     }
     
     return $str;
   }
 
-}
\ No newline at end of file
+}
diff --git a/profiles/commons/modules/contrib/link/LICENSE.txt b/profiles/commons/modules/contrib/link/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/link/link-rtl.css b/profiles/commons/modules/contrib/link/link-rtl.css
new file mode 100644
index 0000000..0359487
--- /dev/null
+++ b/profiles/commons/modules/contrib/link/link-rtl.css
@@ -0,0 +1,8 @@
+.link-field-column {
+  float: right;
+}
+
+.link-field-column.link-field-url .form-text {
+  direction: ltr;
+  text-align: left;
+}
diff --git a/profiles/commons/modules/contrib/link/link.devel_generate.inc b/profiles/commons/modules/contrib/link/link.devel_generate.inc
index 7be4a0d..af0e2d5 100644
--- a/profiles/commons/modules/contrib/link/link.devel_generate.inc
+++ b/profiles/commons/modules/contrib/link/link.devel_generate.inc
@@ -21,9 +21,12 @@ function link_devel_generate($object, $field, $instance, $bundle) {
  * Callback for hook_devel_generate().
  */
 function _link_devel_generate($object, $field, $instance, $bundle) {
-  return array(
+  $link = array(
     'url' => url('<front>', array('absolute' => TRUE)),
-    'title' => devel_create_greeking(mt_rand(1, 3), TRUE),
     'attributes' => _link_default_attributes(),
   );
+  if ($instance['settings']['title'] != 'none') {
+    $link['title'] = devel_create_greeking(mt_rand(1, 3), TRUE);
+  }
+  return $link;
 }
diff --git a/profiles/commons/modules/contrib/link/link.info b/profiles/commons/modules/contrib/link/link.info
index 57aedb3..34f535f 100644
--- a/profiles/commons/modules/contrib/link/link.info
+++ b/profiles/commons/modules/contrib/link/link.info
@@ -18,9 +18,9 @@ files[] = tests/link.validate.test
 files[] = views/link_views_handler_argument_target.inc
 files[] = views/link_views_handler_filter_protocol.inc
 
-; Information added by drupal.org packaging script on 2013-02-09
-version = "7.x-1.1"
+; Information added by  packaging script on 2013-11-24
+version = "7.x-1.2"
 core = "7.x"
 project = "link"
-datestamp = "1360444361"
+datestamp = "1385335705"
 
diff --git a/profiles/commons/modules/contrib/link/link.module b/profiles/commons/modules/contrib/link/link.module
index 241066d..4d821e4 100644
--- a/profiles/commons/modules/contrib/link/link.module
+++ b/profiles/commons/modules/contrib/link/link.module
@@ -10,7 +10,7 @@ define('LINK_INTERNAL', 'internal');
 define('LINK_FRONT', 'front');
 define('LINK_EMAIL', 'email');
 define('LINK_NEWS', 'news');
-define('LINK_DOMAINS', 'aero|arpa|asia|biz|com|cat|coop|edu|gov|info|int|jobs|mil|museum|name|nato|net|org|pro|travel|mobi|local');
+define('LINK_DOMAINS', 'aero|arpa|asia|biz|com|cat|coop|edu|gov|info|int|jobs|mil|museum|name|nato|net|org|pro|travel|mobi|local|xxx');
 
 define('LINK_TARGET_DEFAULT', 'default');
 define('LINK_TARGET_NEW_WINDOW', '_blank');
@@ -118,26 +118,20 @@ function link_field_instance_settings_form($field, $instance) {
 
   if (module_exists('token')) {
     // Add token module replacements fields
-    $form['tokens'] = array(
-      '#type' => 'fieldset',
-      '#collapsible' => TRUE,
-      '#collapsed' => TRUE,
-      '#title' => t('Placeholder tokens'),
-      '#description' => t("The following placeholder tokens can be used in both paths and titles. When used in a path or title, they will be replaced with the appropriate values."),
+    $form['enable_tokens'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Allow user-entered tokens'),
+      '#default_value' => isset($instance['settings']['enable_tokens']) ? $instance['settings']['enable_tokens'] : 1,
+      '#description' => t('Checking will allow users to enter tokens in URLs and Titles on the entity edit form. This does not affect the field settings on this page.'),
     );
+    
     $entity_info = entity_get_info($instance['entity_type']);
-    $form['tokens']['help'] = array(
+    $form['tokens_help'] = array(
       '#theme' => 'token_tree',
       '#token_types' => array($entity_info['token type']),
       '#global_types' => TRUE,
       '#click_insert' => TRUE,
-    );
-
-    $form['enable_tokens'] = array(
-      '#type' => 'checkbox',
-      '#title' => t('Allow user-entered tokens'),
-      '#default_value' => isset($instance['settings']['enable_tokens']) ? $instance['settings']['enable_tokens'] : 1,
-      '#description' => t('Checking will allow users to enter tokens in URLs and Titles on the entity edit form. This does not affect the field settings on this page.'),
+      '#dialog' => TRUE,
     );
   }
 
@@ -258,12 +252,16 @@ function link_field_validate($entity_type, $entity, $field, $instance, $langcode
   $optional_field_found = FALSE;
   if ($instance['settings']['validate_url'] !== 0 || is_null($instance['settings']['validate_url']) || !isset($instance['settings']['validate_url'])) {
     foreach ($items as $delta => $value) {
-      _link_validate($items[$delta], $delta, $field, $entity, $instance, $langcode, $optional_field_found);
+      _link_validate($items[$delta], $delta, $field, $entity, $instance, $langcode, $optional_field_found, $errors);
     }
   }
 
   if ($instance['settings']['url'] === 'optional' && $instance['settings']['title'] === 'optional' && $instance['required'] && !$optional_field_found) {
-    form_set_error($field['field_name'] . '][' . $langcode . '][0][title', t('At least one title or URL must be entered.'));
+    $errors[$field['field_name']][$langcode][0][] = array(
+      'error' => 'link_required',
+      'message' => t('At least one title or URL must be entered.'),
+      'error_element' => array('url' => FALSE, 'title' => TRUE),
+    );
   }
 }
 
@@ -321,6 +319,18 @@ function link_field_widget_form(&$form, &$form_state, $field, $instance, $langco
 }
 
 /**
+ * Implements hook_field_widget_error().
+ */
+function link_field_widget_error($element, $error, $form, &$form_state) {
+  if ($error['error_element']['title']) {
+    form_error($element['title'], $error['message']);
+  }
+  elseif ($error['error_element']['url']) {
+    form_error($element['url'], $error['message']);
+  }
+}
+
+/**
  * Unpacks the item attributes for use.
  */
 function _link_load($field, $item, $instance) {
@@ -367,20 +377,32 @@ function _link_process(&$item, $delta = 0, $field, $entity) {
 /**
  * Validates that the link field has been entered properly.
  */
-function _link_validate(&$item, $delta, $field, $entity, $instance, $langcode, &$optional_field_found) {
+function _link_validate(&$item, $delta, $field, $entity, $instance, $langcode, &$optional_field_found, &$errors) {
   if ($item['url'] && !(isset($instance['default_value'][$delta]['url']) && $item['url'] === $instance['default_value'][$delta]['url'] && !$instance['required'])) {
     // Validate the link.
     if (link_validate_url(trim($item['url'])) == FALSE) {
-      form_set_error($field['field_name'] . '][' . $langcode . '][' . $delta . '][url', t('The value provided for %field is not a valid URL.', array('%field' => $instance['label'])));
+      $errors[$field['field_name']][$langcode][$delta][] = array(
+        'error' => 'link_required',
+        'message' => t('The value provided for %field is not a valid URL.', array('%field' => $instance['label'])),
+        'error_element' => array('url' => TRUE, 'title' => FALSE),
+      );
     }
     // Require a title for the link if necessary.
     if ($instance['settings']['title'] == 'required' && strlen(trim($item['title'])) == 0) {
-      form_set_error($field['field_name'] . '][' . $langcode . '][' . $delta . '][title', t('Titles are required for all links.'));
+      $errors[$field['field_name']][$langcode][$delta][] = array(
+        'error' => 'link_required',
+        'message' => t('Titles are required for all links.'),
+        'error_element' => array('url' => FALSE, 'title' => TRUE),
+      );
     }
   }
   // Require a link if we have a title.
   if ($instance['settings']['url'] !== 'optional' && strlen(isset($item['title']) ? $item['title'] : NULL) > 0 && strlen(trim($item['url'])) == 0) {
-    form_set_error($field['field_name'] . '][' . $langcode . '][' . $delta . '][url', t('You cannot enter a title without a link url.'));
+    $errors[$field['field_name']][$langcode][$delta][] = array(
+      'error' => 'link_required',
+      'message' => t('You cannot enter a title without a link url.'),
+      'error_element' => array('url' => TRUE, 'title' => FALSE),
+    );
   }
   // In a totally bizzaro case, where URLs and titles are optional but the field is required, ensure there is at least one link.
   if ($instance['settings']['url'] === 'optional' && $instance['settings']['title'] === 'optional' && (strlen(trim($item['url'])) !== 0 || strlen(trim($item['title'])) !== 0)) {
@@ -388,7 +410,11 @@ function _link_validate(&$item, $delta, $field, $entity, $instance, $langcode, &
   }
   // Require entire field
   if ($instance['settings']['url'] === 'optional' && $instance['settings']['title'] === 'optional' && $instance['required'] == 1 && !$optional_field_found && isset($instance['id'])) {
-    form_set_error($instance['field_name'] . '][' . $langcode . '][0][title', t('At least one title or URL must be entered.'));
+    $errors[$field['field_name']][$langcode][$delta][] = array(
+      'error' => 'link_required',
+      'message' => t('At least one title or URL must be entered.'),
+      'error_element' => array('url' => FALSE, 'title' => TRUE),
+    );
   }
 }
 
@@ -439,11 +465,6 @@ function _link_sanitize(&$item, $delta, &$field, $instance, &$entity) {
   $url = link_cleanup_url($item['url']);
   $url_parts = _link_parse_url($url);
 
-  // We can't check_plain('<front>') because it'll break.
-  if ($type != LINK_FRONT) {
-    $url_parts['url'] = check_plain($url_parts['url']);
-  }
-
   if (!empty($url_parts['url'])) {
     $item['url'] = url($url_parts['url'],
       array(
@@ -568,15 +589,6 @@ function _link_sanitize(&$item, $delta, &$field, $instance, &$entity) {
 
   // Remove empty attributes.
   $item['attributes'] = array_filter($item['attributes']);
-
-  // Sets title to trimmed url if one exists
-  // @todo: Obsolete?
-  /*if(!empty($item['display_url']) && empty($item['title'])) {
-    $item['title'] = $item['display_url'];
-  }
-  elseif(!isset($item['title'])) {
-    $item['title'] = $item['url'];
-  }*/
 }
 
 /**
@@ -598,14 +610,7 @@ function _link_parse_url($url) {
   // Separate out the query string, if any.
   if (strpos($url, '?') !== FALSE) {
     $query = substr($url, strpos($url, '?') + 1);
-    parse_str($query, $query_array);
-    // See http://drupal.org/node/1710578
-    foreach ($query_array as $key=> &$value) {
-      if ($value === '' && FALSE === strpos($query, $key . '=')) {
-        $value = NULL;
-      }
-    }
-    $url_parts['query'] = $query_array;
+    $url_parts['query'] = _link_parse_str($query);
     $url = substr($url, 0, strpos($url, '?'));
   }
   $url_parts['url'] = $url;
@@ -613,36 +618,67 @@ function _link_parse_url($url) {
 }
 
 /**
+ * Bacause parse_str replaces the following characters in query parameters name
+ * in order to maintain compability with deprecated register_globals directive:
+ *
+ *   - chr(32) ( ) (space)
+ *   - chr(46) (.) (dot)
+ *   - chr(91) ([) (open square bracket)
+ *   - chr(128) - chr(159) (various)
+ *
+ * @param string $query
+ *   Query to parse.
+ *
+ * @return Array
+ *   Array of query parameters.
+ *
+ * @see http://php.net/manual/en/language.variables.external.php#81080
+ */
+function _link_parse_str($query) {
+  $query_array = array();
+
+  $pairs = explode('&', $query);
+  foreach ($pairs as $pair) {
+    $name_value = explode('=', $pair);
+    $name = urldecode($name_value[0]);
+    $value = isset($name_value[1]) ? urldecode($name_value[1]) : NULL;
+    $query_array[$name] = $value;
+  }
+
+  return $query_array;
+}
+
+/**
  * Implements hook_theme().
  */
 function link_theme() {
   return array(
     'link_formatter_link_default' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_plain' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_absolute' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_domain' => array(
-      'variables' => array('element' => NULL, 'display' => NULL),
+      'variables' => array('element' => NULL, 'display' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_title_plain' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_url' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_short' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_label' => array(
       'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_formatter_link_separate' => array(
-      'variables' => array('element' => NULL),
+      'variables' => array('element' => NULL, 'field' => NULL),
     ),
     'link_field' => array(
       'render element' => 'element',
@@ -668,7 +704,7 @@ function theme_link_field($vars) {
   if (isset($element['title'])) {
     $output .= '<div class="link-field-title link-field-column">' . drupal_render($element['title']) . '</div>';
   }
-  $output .= '<div class="link-field-url' . (isset($element['title']) ? ' link-field-column' : '') . '">'. drupal_render($element['url']) . '</div>';
+  $output .= '<div class="link-field-url' . (isset($element['title']) ? ' link-field-column' : '') . '">' . drupal_render($element['url']) . '</div>';
   $output .= '</div>';
   if (!empty($element['attributes']['target'])) {
     $output .= '<div class="link-attributes">' . drupal_render($element['attributes']['target']) . '</div>';
@@ -1169,7 +1205,7 @@ function link_validate_url($text) {
   $news_pattern = '/^news:(' . $newsgroup_name . '|' . $message_id . ')$/i';
 
   $user = '[a-zA-Z0-9' . $LINK_ICHARS . '_\-\.\+\^!#\$%&*+\/\=\?\`\|\{\}~\'\[\]]+';
-  $email_pattern = '/^mailto:' . $user . '@'.'(?:' . $domain . '|' . $ipv4 . '|' . $ipv6 . '|localhost)' . $query . '?$/';
+  $email_pattern = '/^mailto:' . $user . '@' . '(?:' . $domain . '|' . $ipv4 . '|' . $ipv6 . '|localhost)' . $query . '?$/';
 
   if (strpos($text, '<front>') === 0) {
     return LINK_FRONT;
@@ -1302,7 +1338,7 @@ function link_field_item_property_info() {
  * Implements hook_field_update_instance().
  */
 function link_field_update_instance($instance, $prior_instance) {
-  if (function_exists('i18n_string_update') && $prior_instance['settings']['title_value'] != $instance['settings']['title_value']) {
+  if (function_exists('i18n_string_update') && $instance['widget']['type'] == 'link_field' && $prior_instance['settings']['title_value'] != $instance['settings']['title_value']) {
     $i18n_string_name = "field:{$instance['field_name']}:{$instance['bundle']}:title_value";
     i18n_string_update($i18n_string_name, $instance['settings']['title_value']);
   }
@@ -1312,9 +1348,10 @@ function link_field_update_instance($instance, $prior_instance) {
  * Implements hook_i18n_string_list_TEXTGROUP_alter().
  */
 function link_i18n_string_list_field_alter(&$strings, $type = NULL, $object = NULL) {
-  if ($type == 'field_instance' && $object && $object['widget']['type'] == 'link_field') {
-    if (isset($object['settings']['title_value'])) {
-      $strings['field'][$object['field_name']][$object['bundle']]['title_value']['string'] = $object['settings']['title_value'];
-    }
+  if ($type != 'field_instance' || !is_array($object) || !isset($object['widget']['type'])) {
+    return;
+  }
+  if ($object['widget']['type'] == 'link_field' && isset($object['settings']['title_value'])) {
+    $strings['field'][$object['field_name']][$object['bundle']]['title_value']['string'] = $object['settings']['title_value'];
   }
 }
diff --git a/profiles/commons/modules/contrib/link/tests/link.crud_browser.test b/profiles/commons/modules/contrib/link/tests/link.crud_browser.test
index 9540601..19d9c59 100644
--- a/profiles/commons/modules/contrib/link/tests/link.crud_browser.test
+++ b/profiles/commons/modules/contrib/link/tests/link.crud_browser.test
@@ -104,18 +104,24 @@ class LinkUITest extends DrupalWebTestcase {
         'msg' => 'js label',
         'type' => self::LINK_INPUT_TYPE_BAD_TITLE
       ),
-       array(
+      array(
         'href' => 'http://example.com/' . $this->randomName(),
         'label' => $this->randomName() . '\' onmouseover="alert(\'hi\')',
         'msg' => 'js label',
         'type' => self::LINK_INPUT_TYPE_BAD_TITLE
       ),
-     array(
+      array(
         'href' => 'javascript:alert("http://example.com/' . $this->randomName() . '")',
         'label' => $this->randomName(),
         'msg' => 'js url',
         'type' => self::LINK_INPUT_TYPE_BAD_URL
       ),
+      array(
+        'href' => 'http://ecs-es.kelkoo.es/ctl/go/sitesearchGo?.ts=1338833010331&.sig=qP9GXeEFH6syBzwmzYkxmsvp1EI-',
+        'label' => 'http://ecs-es.kelkoo.es/ctl/go/sitesearchGo?.ts=1338833010331&.sig=qP9GXeEFH6syBzwmzYkxmsvp1EI-',
+        'msg' => 'Url with . in querystring',
+        'type' => self::LINK_INPUT_TYPE_GOOD,
+      ),
     );
     $test_case = array(
       'href' => 'www.example.com/'. $this->randomName(),
diff --git a/profiles/commons/modules/contrib/media/README.txt b/profiles/commons/modules/contrib/media/README.txt
new file mode 100644
index 0000000..6875a07
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/README.txt
@@ -0,0 +1,7 @@
+
+/**
+ *  @file
+ *  README for the Media Module.
+ */
+
+See http://drupal.org/node/356802
diff --git a/profiles/commons/modules/contrib/media/css/media.css b/profiles/commons/modules/contrib/media/css/media.css
new file mode 100644
index 0000000..2ea3699
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/css/media.css
@@ -0,0 +1,160 @@
+/**
+ * @file
+ * Styles for the media library.
+ *
+ * The display and layout of the Media browser assumes Drupal's Seven theme as
+ * the theme active when this is displayed.
+ */
+
+/* jQuery UI Resets */
+.ui-tabs {
+  padding: 0;
+}
+
+.ui-dialog.media-wrapper .ui-dialog-content {
+  padding: 0;
+}
+
+.ui-dialog.media-wrapper .ui-dialog-buttonpane {
+  display: none;
+}
+
+#media-browser-tabset .ui-widget-header {
+  background: none;
+}
+
+/* Remove the default border */
+.ui-widget-content {
+  border: none;
+}
+
+/* *********************************************************** */
+/* Browser layout themeing */
+
+/* Size the branding header appropriately */
+#media-browser-tabset #branding {
+  padding: 10px 10px 0px 10px;
+}
+
+#media-browser-tabset #branding h1 {
+  float: left;
+  height: 16px;
+  margin-top: 0px;
+}
+
+/* Float the tabs right to keep the UI consistent across themes */
+#media-tabs-wrapper {
+  float: right;
+}
+
+#media-browser-tabset ul.tabs {
+  padding: 0;
+  border: none;
+}
+
+/* Reset the height to match the browser */
+#media-browser-tabset ul.tabs.primary li a:link {
+  font-weight: bold;
+  margin-right: 0;
+}
+
+/* *********************************************************** */
+/* Media item display */
+
+.media-item {
+  background: #FFFFFF;
+  border: 1px solid #CCCCCC;
+  padding: 5px;
+   position: relative;
+}
+
+.media-item img {
+  margin-bottom: 10px;
+}
+
+.media-item .label-wrapper {
+  text-align: center;
+  position: absolute;
+  bottom: 0;
+  margin-left: auto;
+  margin-right: auto;
+  width: 90%;
+}
+
+.media-item .label-wrapper label {
+  font-size: 10px;
+  overflow: hidden;
+  text-overflow: ellipsis;
+  white-space: nowrap;
+}
+
+/* Media item lists */
+
+#media-browser-library-list {
+  margin: 0;
+  padding: 0;
+}
+
+.media-list-thumbnails li {
+  float: left;
+  list-style: none;
+  margin: 0 10px 10px 0;
+}
+
+.media-list-thumbnails li a {
+  text-decoration: none;
+}
+
+.media-list-thumbnails .media-item.selected {
+  background: #F4ECC7;
+  border-color: #058AC5;
+}
+
+.media-list-thumbnails .media-item:hover {
+  border-color: #058AC5;
+  cursor: pointer;
+}
+
+.media-list-thumbnails .media-item .label-wrapper label {
+  color: #058AC5;
+}
+
+.media-list-thumbnails .media-item .label-wrapper label:hover {
+  cursor: pointer;
+}
+
+.media-list-thumbnails .form-type-checkbox {
+  bottom: 135px;
+  left: 8px;
+  margin: 0;
+  padding: 0;
+  position: relative;
+}
+
+/* File field */
+
+.media-widget .preview {
+  display: inline-block;
+  vertical-align: middle;
+}
+
+.media-widget .preview a {
+  text-decoration: none;
+}
+
+.media-widget .preview .media-item {
+  margin-right: 10px;
+}
+
+.media-widget .preview .media-item:hover {
+  border-color: #058AC5;
+  cursor: pointer;
+}
+
+.media-widget .preview .media-item .label-wrapper label {
+  color: #058AC5;
+}
+
+.media-widget .preview .media-item .label-wrapper label:hover {
+  cursor: pointer;
+}
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/application-octet-stream.png b/profiles/commons/modules/contrib/media/images/icons/default/application-octet-stream.png
new file mode 100644
index 0000000..0e6de2f
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/application-octet-stream.png differ
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/audio-mpeg.png b/profiles/commons/modules/contrib/media/images/icons/default/audio-mpeg.png
new file mode 100644
index 0000000..b876398
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/audio-mpeg.png differ
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/audio-x-generic.png b/profiles/commons/modules/contrib/media/images/icons/default/audio-x-generic.png
new file mode 100644
index 0000000..b876398
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/audio-x-generic.png differ
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/file-unknown.png b/profiles/commons/modules/contrib/media/images/icons/default/file-unknown.png
new file mode 100644
index 0000000..46125e7
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/file-unknown.png differ
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/image-x-generic.png b/profiles/commons/modules/contrib/media/images/icons/default/image-x-generic.png
new file mode 100644
index 0000000..c50e3c7
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/image-x-generic.png differ
diff --git a/profiles/commons/modules/contrib/media/images/icons/default/video-x-generic.png b/profiles/commons/modules/contrib/media/images/icons/default/video-x-generic.png
new file mode 100644
index 0000000..58add03
Binary files /dev/null and b/profiles/commons/modules/contrib/media/images/icons/default/video-x-generic.png differ
diff --git a/profiles/commons/modules/contrib/media/includes/MediaBrowserPlugin.inc b/profiles/commons/modules/contrib/media/includes/MediaBrowserPlugin.inc
new file mode 100644
index 0000000..807a4e4
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaBrowserPlugin.inc
@@ -0,0 +1,86 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserPlugin.
+ */
+
+/**
+ * Defines a Media browser plugin base class.
+ *
+ * MediaBrowserPlugin implementations need to implement at least the
+ * view() method.
+ */
+abstract class MediaBrowserPlugin implements MediaBrowserPluginInterface {
+  /**
+   * The plugin metadata array from hook_media_browser_plugin_info().
+   *
+   * @var array
+   */
+  protected $info;
+
+  /**
+   * The parameters for the current media browser from
+   * media_get_browser_params().
+   *
+   * @var array
+   */
+  protected $params;
+
+  /**
+   * Implements MediaBrowserPluginInterface::__construct().
+   */
+  public function __construct($info, $params) {
+    $this->info = $info;
+    $this->params = $params;
+  }
+
+  /**
+   * Implements MediaBrowserPluginInterface::access().
+   */
+  public function access($account = NULL) {
+    // Backwards compatible support for 'access callback' definitions.
+    if (isset($this->info['access callback'])) {
+      $access_callback = $this->info['access callback'];
+      $access_arguments = isset($this->info['access arguments']) ? $this->info['access arguments'] : array();
+      return function_exists($access_callback) && call_user_func_array($access_callback, $access_arguments);
+    }
+
+    return TRUE;
+  }
+
+  /**
+   * Provide a render array to display the plugin in a media browser.
+   *
+   * This render array will be a jQuery tab in the media browser.
+   *
+   * Some elements are special:
+   *  - #settings: Drupal.settings.media.browser.$key (where key is the array
+   *    key).
+   *  - #callback: If provided, will make the tab an "ajax" tab.
+   *  - #title: If provided, will be used as the tab's title. Otherwise the
+   *    'title' value from the plugin's hook_media_browser_plugin_info() will
+   *    be used.
+   *  - #weight: If provided, will be used to order the tabs between each other.
+   *    A lower weight will be displayed first while a higher weight will be
+   *    displayed later. If not provided, and there is a 'weight' value in the
+   *    plugin's hook_media_browser_plugin_info() then it will be used,
+   *    otherwise a default of 0 will be used.
+   *  - form: If the plugin is to display a native Drupal form, then the output
+   *    of drupal_get_form should be returned into the 'form' render key. If a
+   *    form's callback isn't normally loaded, module_load_include() should be
+   *    used to ensure that the form can be displayed.
+   *
+   * Example usage:
+   * @code
+   *   module_load_include('inc', 'mymodule', 'mymodule.pages');
+   *   $build['#attached']['js'][] = drupal_get_path('module', 'mymodule') . '/js/mymodule.media.browser.js';
+   *   $build['form'] = drupal_get_form('mymodule_media_form');
+   *   return $build;
+   * @endcode
+   *
+   * @return array
+   *   Renderable array.
+   */
+  abstract public function view();
+}
diff --git a/profiles/commons/modules/contrib/media/includes/MediaBrowserPluginInterface.inc b/profiles/commons/modules/contrib/media/includes/MediaBrowserPluginInterface.inc
new file mode 100644
index 0000000..3ff1134
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaBrowserPluginInterface.inc
@@ -0,0 +1,44 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserPluginInterface.
+ */
+
+/**
+ * Defines a Media browser plugin.
+ *
+ * Extends the MediaBrowserPluginInterface with methods expected by all
+ * Media browser classes.
+ */
+interface MediaBrowserPluginInterface {
+  /**
+   * Set up the plugin class.
+   *
+   * @param array $info
+   *   An array of plugin info from hook_media_browser_plugin_info()
+   *   implementations.
+   * @param array $params
+   *   An array of parameters which came in is $_GET['params']. The expected
+   *   parameters are still being defined.
+   *   - 'types': array of media types to support
+   *   - 'multiselect': boolean; TRUE enables multiselect
+   */
+  public function __construct($info, $params);
+
+  /**
+   * Check if a user can access this plugin.
+   *
+   * @param object $account
+   *   An optional user account object from user_load(). Defaults to the current
+   *   global user.
+   *
+   * @return bool
+   *   TRUE if the user can access this plugin, or FALSE otherwise.
+   */
+  public function access($account = NULL);
+
+  // The view() method is an abstract function so it is defined in MediaBrowser
+  // Plugin.
+  // @todo public function view();
+}
diff --git a/profiles/commons/modules/contrib/media/includes/MediaBrowserUpload.inc b/profiles/commons/modules/contrib/media/includes/MediaBrowserUpload.inc
new file mode 100644
index 0000000..57721cb
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaBrowserUpload.inc
@@ -0,0 +1,32 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserUpload.
+ */
+
+/**
+ * Media browser plugin for showing the upload form.
+ *
+ * @deprecated
+ */
+class MediaBrowserUpload extends MediaBrowserPlugin {
+  /**
+   * Implements MediaBrowserPluginInterface::access().
+   */
+  public function access($account = NULL) {
+    return file_entity_access('create', NULL, $account);
+  }
+
+  /**
+   * Implements MediaBrowserPlugin::view().
+   */
+  public function view() {
+    module_load_include('inc', 'file_entity', 'file_entity.pages');
+
+    $build = array();
+    $build['form'] = drupal_get_form('file_entity_add_upload', $this->params);
+
+    return $build;
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/includes/MediaBrowserView.inc b/profiles/commons/modules/contrib/media/includes/MediaBrowserView.inc
new file mode 100644
index 0000000..0321a11
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaBrowserView.inc
@@ -0,0 +1,56 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserView.
+ */
+
+/**
+ * Media browser plugin for displaying a specific view and display.
+ */
+class MediaBrowserView extends MediaBrowserPlugin {
+  /**
+   * The view object from views_get_view() for this plugin.
+   *
+   * @var view
+   */
+  protected $view;
+
+  /**
+   * Implements MediaBrowserPluginInterface::__construct().
+   */
+  public function __construct($info, $params) {
+    parent::__construct($info, $params);
+
+    // Set up the view object with the proper display.
+    if ($view = views_get_view($info['view_name'])) {
+      $display_id = !empty($info['view_display_id']) ? $info['view_display_id'] : NULL;
+      if ($view->set_display($display_id)) {
+        $this->view = $view;
+      }
+    }
+  }
+
+  /**
+   * Implements MediaBrowserPluginInterface::access().
+   */
+  public function access($account = NULL) {
+    return !empty($this->view) && $this->view->access($this->view->current_display, $account);
+  }
+
+  /**
+   * Implements MediaBrowserPlugin::view().
+   */
+  public function view() {
+    if (!empty($this->view)) {
+      $build['#markup'] = $this->view->preview();
+
+      // Allow the View title to override the plugin title.
+      if ($title = $this->view->get_title()) {
+        $build['#title'] = $title;
+      }
+
+      return $build;
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/includes/MediaEntityTranslationHandler.inc b/profiles/commons/modules/contrib/media/includes/MediaEntityTranslationHandler.inc
new file mode 100644
index 0000000..4e78ed1
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaEntityTranslationHandler.inc
@@ -0,0 +1,63 @@
+<?php
+
+/**
+ * @file
+ * Media translation handler for the entity translation module.
+ */
+
+
+/**
+ * Media translation handler.
+ */
+class MediaEntityTranslationHandler extends EntityTranslationDefaultHandler {
+
+  /**
+   * Constructor function.
+   */
+  public function __construct($entity_type, $entity_info, $entity) {
+    parent::__construct('file', $entity_info, $entity);
+  }
+
+  /**
+   * Entity form handler.
+   *
+   * @see EntityTranslationDefaultHandler::entityForm()
+   */
+  public function entityForm(&$form, &$form_state) {
+    parent::entityForm($form, $form_state);
+
+    if (isset($form['actions']['delete_translation'])) {
+      $form['actions']['delete_translation']['#weight'] = 10;
+    }
+
+    if ($this->getPathScheme() == 'media') {
+      $language = $GLOBALS[LANGUAGE_TYPE_CONTENT];
+      $form_langcode = $this->getFormLanguage();
+      $source_langcode = $this->getSourceLanguage();
+      $translations = $this->getTranslations();
+
+      // If a translation in the current content language is missing we display
+      // a link to create it, unless we are not already doing it.
+      if ($language->language != $form_langcode && empty($source_langcode) && !isset($translations->data[$language->language])) {
+        $link = array(
+          'title' => t('Add @language translation', array('@language' => $language->name)),
+          'href' => $this->getEditPath() . '/add/' . $form_langcode . '/' . $language->language,
+          'localized_options' => array('attributes' => array('class' => array('ctools-use-modal'))),
+        );
+        $form['media_add_translation'] = array(
+          '#theme' => 'menu_local_action',
+          '#link' => $link,
+          '#weight' => -110,
+          '#prefix' => '<ul class="action-links">',
+          '#suffix' => '</ul>',
+        );
+      }
+
+      // Hide unsupported elements.
+      $form['source_language']['#access'] = FALSE;
+      if (isset($form['actions']['delete_translation'])) {
+        $form['actions']['delete_translation']['#access'] = FALSE;
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/includes/MediaReadOnlyStreamWrapper.inc b/profiles/commons/modules/contrib/media/includes/MediaReadOnlyStreamWrapper.inc
new file mode 100644
index 0000000..ee051fd
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/MediaReadOnlyStreamWrapper.inc
@@ -0,0 +1,476 @@
+<?php
+
+/**
+ * @file
+ * Implements a base class for Resource Stream Wrappers.
+ */
+
+/**
+ * A base class for Resource Stream Wrappers.
+ *
+ * This class provides a complete stream wrapper implementation. It passes
+ * incoming  URL's through an interpolation method then recursively calls
+ * the invoking PHP filesystem function.
+ *
+ * MediaReadOnlyStreamWrapper implementations need to override at least the
+ * interpolateUrl method to rewrite the URL before is it passed back into the
+ * calling function.
+ */
+abstract class MediaReadOnlyStreamWrapper implements DrupalStreamWrapperInterface {
+  protected $parameters = array();
+  protected $base_url = NULL;
+  private $_DEBUG_MODE = NULL;
+
+  /**
+   * Utility function to return paramenters.
+   */
+  public function get_parameters() {
+    return $this->parameters;
+  }
+
+  // As part of the inode protection mode returned by stat(), identifies the
+  // file as a regular file, as opposed to a directory, symbolic link, or other
+  // type of "file".
+  // @see http://linux.die.net/man/2/stat
+  const S_IFREG = 0100000;
+
+  /**
+   * Template for stat calls.
+   *
+   * All elements must be initialized.
+   */
+  protected $_stat = array(
+    0 => 0, // Device number
+    'dev' => 0,
+    1 => 0, // Inode number
+    'ino' => 0,
+    // Inode protection mode. file_unmanaged_delete() requires is_file() to
+    // return TRUE.
+    2 => self::S_IFREG,
+    'mode' => self::S_IFREG,
+    3 => 0, // Number of links.
+    'nlink' => 0,
+    4 => 0, // Userid of owner.
+    'uid' => 0,
+    5 => 0, // Groupid of owner.
+    'gid' => 0,
+    6 => -1, // Device type, if inode device *
+    'rdev' => -1,
+    7 => 0, // Size in bytes.
+    'size' => 0,
+    8 => 0, // Time of last access (Unix timestamp).
+    'atime' => 0,
+    9 => 0, // Time of last modification (Unix timestamp).
+    'mtime' => 0,
+    10 => 0, // Time of last inode change (Unix timestamp).
+    'ctime' => 0,
+    11 => -1, // Blocksize of filesystem IO.
+    'blksize' => -1,
+    12 => -1, // Number of blocks allocated.
+    'blocks' => -1,
+  );
+
+  /**
+   * Handles parameters on the URL string.
+   */
+  public function interpolateUrl() {
+    if ($parameters = $this->get_parameters()) {
+      return $this->base_url . '?' . http_build_query($parameters);
+    }
+  }
+
+  /**
+   * Returns a web accessible URL for the resource.
+   *
+   * This function should return a URL that can be embedded in a web page
+   * and accessed from a browser. For example, the external URL of
+   * "youtube://xIpLd0WQKCY" might be
+   * "http://www.youtube.com/watch?v=xIpLd0WQKCY".
+   *
+   * @return string
+   *   Returns a string containing a web accessible URL for the resource.
+   */
+  public function getExternalUrl() {
+    return $this->interpolateUrl();
+  }
+
+  /**
+   * Base implementation of getMimeType().
+   */
+  public static function getMimeType($uri, $mapping = NULL) {
+    return 'application/octet-stream';
+  }
+
+  /**
+   * Base implementation of realpath().
+   */
+  public function realpath() {
+    return $this->getExternalUrl();
+  }
+
+  /**
+   * Stream context resource.
+   *
+   * @var Resource
+   */
+  public $context;
+
+  /**
+   * A generic resource handle.
+   *
+   * @var Resource
+   */
+  public $handle = NULL;
+
+  /**
+   * Instance URI (stream).
+   *
+   * A stream is referenced as "scheme://target".
+   *
+   * @var String
+   */
+  protected $uri;
+
+  /**
+   * Base implementation of setUri().
+   */
+  public function setUri($uri) {
+    $this->uri = $uri;
+    $this->parameters = $this->_parse_url($uri);
+  }
+
+  /**
+   * Base implementation of getUri().
+   */
+  public function getUri() {
+    return $this->uri;
+  }
+
+  /**
+   * Report an error.
+   *
+   * @param string $message
+   *   The untranslated string to report.
+   * @param array $options
+   *   An optional array of options to send to t().
+   * @param bool $display
+   *   If TRUE, then we display the error to the user.
+   *
+   * @return bool
+   *   We return FALSE, since we sometimes pass that back from the reporting
+   *   function.
+   */
+  private function _report_error($message, $options = array(), $display = FALSE) {
+    watchdog('resource', $message, $options, WATCHDOG_ERROR);
+    if ($display) {
+      drupal_set_message(t($message, $options), 'error');
+    }
+    return FALSE;
+  }
+
+  /**
+   * Sets the debug mode.
+   */
+  private function _debug($message, $type = 'status') {
+    if ($this->_DEBUG_MODE) {
+      drupal_set_message($message, $type);
+    }
+  }
+
+  /**
+   * Returns an array of any parameters stored in the URL's path.
+   *
+   * @param string $url
+   *   The URL to parse, such as youtube://v/[video-code]/t/[tags+more-tags].
+   *
+   * @return array
+   *   An associative array of all the parameters in the path,
+   *   or FALSE if the $url is ill-formed.
+   */
+  protected function _parse_url($url) {
+    $path = explode('://', $url);
+    $parts = explode('/', $path[1]);
+    $params = array();
+    $count = 0;
+    $total = count($parts);
+    if (!$total || ($total % 2)) {
+      // If we have no parts, or an odd number of parts, it's malformed.
+      return FALSE;
+    }
+    while ($count < $total) {
+      // We iterate count for each step of the assignment to keep us honest.
+      $params[$parts[$count++]] = $parts[$count++];
+    }
+    return $params;
+  }
+
+  /**
+   * Support for fopen(), file_get_contents(), file_put_contents() etc.
+   *
+   * @param string $url
+   *   A string containing the path to the file to open.
+   * @param string $mode
+   *   The file mode ("r", "wb" etc.).
+   * @param bitmask $options
+   *   A bit mask of STREAM_USE_PATH and STREAM_REPORT_ERRORS.
+   * @param string &$opened_url
+   *   A string containing the path actually opened.
+   *
+   * @return bool
+   *   TRUE if file was opened successfully.
+   */
+  public function stream_open($url, $mode, $options, &$opened_url) {
+    $this->_debug(t('Stream open: %url', array('%url' => $url)));
+
+    // We only handle Read-Only mode by default.
+    if ($mode != 'r' && $mode != 'rb') {
+      return $this->_report_error('Attempted to open %url as mode: %mode.', array('%url' => $url, '%mode' => $mode), ($options & STREAM_REPORT_ERRORS));
+    }
+
+    // We parse a URL as youtube://v/dsyiufo34/t/cats+dogs to store
+    // the relevant code(s) in our private array of parameters.
+    $this->parameters = $this->_parse_url($url);
+
+    if ($this->parameters === FALSE) {
+      return $this->_report_error('Attempted to parse an ill-formed url: %url.', array('%url' => $url), ($options & STREAM_REPORT_ERRORS));
+    }
+
+    if ((bool) $this->parameters && ($options & STREAM_USE_PATH)) {
+      $opened_url = $url;
+    }
+
+    $this->_debug(t('Stream opened: %parameters', array('%parameters' => print_r($this->parameters, TRUE))));
+
+    return (bool) $this->parameters;
+  }
+
+  /**
+   * Undocumented PHP stream wrapper method.
+   */
+  function stream_lock($operation) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fread(), file_get_contents() etc.
+   *
+   * @param int $count
+   *   Maximum number of bytes to be read.
+   *
+   * @return bool
+   *   The string that was read, or FALSE in case of an error.
+   */
+  public function stream_read($count) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fwrite(), file_put_contents() etc.
+   *
+   * Since this is a read only stream wrapper this always returns false.
+   *
+   * @param string $data
+   *   The string to be written.
+   *
+   * @return bool
+   *   Returns FALSE.
+   */
+  public function stream_write($data) {
+    return FALSE;
+  }
+
+  /**
+   * Support for feof().
+   *
+   * @return bool
+   *   TRUE if end-of-file has been reached.
+   */
+  public function stream_eof() {
+    return FALSE;
+  }
+
+  /**
+   * Support for fseek().
+   *
+   * @todo document why this returns false.
+   *
+   * @param int $offset
+   *   The byte offset to got to.
+   * @param string $whence
+   *   SEEK_SET, SEEK_CUR, or SEEK_END.
+   *
+   * @return bool
+   *   TRUE on success
+   */
+  public function stream_seek($offset, $whence) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fflush().
+   *
+   * @todo document why this returns false.
+   *
+   * @return bool
+   *   TRUE if data was successfully stored (or there was no data to store).
+   */
+  public function stream_flush() {
+    return FALSE;
+  }
+
+  /**
+   * Support for ftell().
+   *
+   * @todo document why this returns false.
+   *
+   * @return bool
+   *   The current offset in bytes from the beginning of file.
+   */
+  public function stream_tell() {
+    return FALSE;
+  }
+
+  /**
+   * Support for fstat().
+   *
+   * @return array
+   *   An array with file status, or FALSE in case of an error - see fstat()
+   *   for a description of this array.
+   */
+  public function stream_stat() {
+    return $this->_stat;
+  }
+
+  /**
+   * Support for fclose().
+   *
+   * @todo document why this returns TRUE.
+   *
+   * @return bool
+   *   TRUE if stream was successfully closed.
+   */
+  public function stream_close() {
+    return TRUE;
+  }
+
+  /**
+   * Support for stat().
+   *
+   * @param string $url
+   *   A string containing the url to get information about.
+   * @param bitmask $flags
+   *   A bit mask of STREAM_URL_STAT_LINK and STREAM_URL_STAT_QUIET.
+   *
+   * @return array
+   *   An array with file status, or FALSE in case of an error - see fstat()
+   *   for a description of this array.
+   */
+  public function url_stat($url, $flags) {
+    return $this->stream_stat();
+  }
+
+  /**
+   * Support for opendir().
+   *
+   * @param string $url
+   *   A string containing the url to the directory to open.
+   * @param int $options
+   *   Whether or not to enforce safe_mode (0x04).
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_opendir($url, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Support for readdir().
+   *
+   * @return bool
+   *   The next filename, or FALSE if there are no more files in the directory.
+   */
+  public function dir_readdir() {
+    return FALSE;
+  }
+
+  /**
+   * Support for rewinddir().
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_rewinddir() {
+    return FALSE;
+  }
+
+  /**
+   * Support for closedir().
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_closedir() {
+    return FALSE;
+  }
+
+  /**
+   * Undocumented.
+   *
+   * @todo document.
+   */
+  public function getDirectoryPath() {
+    return '';
+  }
+
+  /**
+   * DrupalStreamWrapperInterface requires that these methods be implemented,
+   * but none of them apply to a read-only stream wrapper. On failure they
+   * are expected to return FALSE.
+   */
+
+  /**
+   * Implements DrupalStreamWrapperInterface::unlink().
+   */
+  public function unlink($uri) {
+    // Although the remote file itself can't be deleted, return TRUE so that
+    // file_delete() can remove the file record from the Drupal database.
+    return TRUE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::rename().
+   */
+  public function rename($from_uri, $to_uri) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::mkdir().
+   */
+  public function mkdir($uri, $mode, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::rmdir().
+   */
+  public function rmdir($uri, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::chmod().
+   */
+  public function chmod($mode) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::dirname().
+   */
+  public function dirname($uri = NULL) {
+    return FALSE;
+  }
+
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media.admin.inc b/profiles/commons/modules/contrib/media/includes/media.admin.inc
new file mode 100644
index 0000000..464ed02
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media.admin.inc
@@ -0,0 +1,47 @@
+<?php
+
+/**
+ * @file
+ * Administration page callbacks for the Media module.
+ */
+
+/**
+ * Displays the media administration page.
+ */
+function media_admin_config_browser($form, &$form_state) {
+  $theme_options = array();
+  $theme_options[NULL] = t('Default administration theme');
+
+  foreach (list_themes() as $key => $theme) {
+    if ($theme->status) {
+      $theme_options[$key] = $theme->info['name'];
+    }
+  }
+
+  $form['media_dialog_theme'] = array(
+    '#type' => 'select',
+    '#title' => t('Media browser theme'),
+    '#options' => $theme_options,
+    '#description' => t("This theme will be used for all media related dialogs. It can be different from your site's theme because many site themes do not work well in the small windows which media uses."),
+    '#default_value' => variable_get('media_dialog_theme', ''),
+  );
+
+  $form['array_filter'] = array(
+    '#type' => 'value',
+    '#value' => TRUE,
+  );
+
+  $form['#submit'][] = 'media_admin_config_browser_pre_submit';
+
+  return system_settings_form($form);
+}
+
+/**
+ * Form submission handler for media_admin_config_browser().
+ */
+function media_admin_config_browser_pre_submit(&$form, &$form_state) {
+  if (!$form_state['values']['media_dialog_theme']) {
+    variable_del('media_dialog_theme');
+    unset($form_state['values']['media_dialog_theme']);
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media.browser.inc b/profiles/commons/modules/contrib/media/includes/media.browser.inc
new file mode 100644
index 0000000..626fc00
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media.browser.inc
@@ -0,0 +1,367 @@
+<?php
+
+/**
+ * @file
+ * Summon plugins and render the media browser.
+ */
+
+/**
+ * Media browser page callback.
+ */
+function media_browser($selected = NULL) {
+  $output = array();
+  $output['#attached']['library'][] = array('media', 'media_browser_page');
+
+  $params = media_set_browser_params();
+
+  // If one or more files have been selected, the browser interaction is now
+  // complete. Return empty page content to the dialog which now needs to close,
+  // but populate Drupal.settings with information about the selected files.
+  if (isset($params['fid'])) {
+    $fids = is_array($params['fid']) ? $params['fid'] : array($params['fid']);
+    if (!is_numeric($fids[0])) {
+      throw new Exception('Error selecting media, fid param is not an fid or an array of fids');
+    }
+    $files = file_load_multiple($fids);
+    foreach ($files as $file) {
+      media_browser_build_media_item($file);
+    }
+    $setting = array('media' => array('selectedMedia' => array_values($files)));
+    drupal_add_js($setting, 'setting');
+    return $output;
+  }
+
+  $plugins = media_get_browser_plugin_info();
+
+  // Allow parameters to provide a list of enabled or disabled media browser
+  // plugins.
+  if (!empty($params['enabledPlugins'])) {
+    $plugins = array_intersect_key($plugins, array_fill_keys($params['enabledPlugins'], 1));
+  }
+  elseif (!empty($params['disabledPlugins'])) {
+    $plugins = array_diff_key($plugins, array_fill_keys($params['disabledPlugins'], 1));
+  }
+
+  // Render plugins.
+  $plugin_output = array();
+  foreach ($plugins as $key => $plugin_info) {
+    // Support the old CTools style handler definition.
+    if (!isset($plugin_info['class']) && !empty($plugin_info['handler'])) {
+      if (is_string($plugin_info['handler'])) {
+        $plugin_info['class'] = $plugin_info['handler'];
+      }
+      elseif (isset($plugin_info['handler']['class'])) {
+        $plugin_info['class'] = $plugin_info['handler']['class'];
+      }
+    }
+
+    if (empty($plugin_info['class']) || !class_exists($plugin_info['class'])) {
+      continue;
+    }
+
+    $plugin = new $plugin_info['class']($plugin_info, $params);
+    if ($plugin->access()) {
+      $plugin_output[$key] = $plugin->view();
+      if (!empty($plugin_output[$key]) && is_array($plugin_output[$key])) {
+        $plugin_output[$key] += array(
+          '#title' => $plugin_info['title'],
+          '#weight' => isset($plugin_info['weight']) ? $plugin_info['weight'] : 0,
+        );
+      }
+      else {
+        unset($plugin_output[$key]);
+        continue;
+      }
+    }
+    else {
+      continue;
+    }
+
+    // We need to get a submit and cancel button on each tab. If the plugin
+    // is not returning a form element we need to add a submit button.
+    // This is a fairly broad assumption.
+    if (empty($plugin_output[$key]['#form']) && !empty($plugin_output[$key]['#markup'])) {
+      $fake_buttons = '<div class="form-actions form-wrapper">';
+      $fake_buttons .= l(t('Submit'), '', array(
+        'attributes' => array(
+          'class' => array('button', 'button-yes', 'fake-submit', $key),
+        ),
+      ));
+      $fake_buttons .= l(t('Cancel'), '', array(
+        'attributes' => array(
+          'class' => array('button', 'button-no', 'fake-cancel', $key),
+        ),
+      ));
+      $fake_buttons .= '</div>';
+      $plugin_output[$key]['#markup'] .= $fake_buttons;
+    }
+
+    // I'm not sure if it is ever the case that a plugin form will ever have
+    // the correct cancel button so we add it here. Put it inline with the
+    // current submit button. This is a fairly broad assumption.
+    if (!empty($plugin_output[$key]['form']['actions']) && !isset($plugin_output[$key]['form']['actions']['cancel'])) {
+      $plugin_output[$key]['form']['actions']['cancel'] = array(
+        '#type' => 'link',
+        '#title' => t('Cancel'),
+        '#href' => '',
+        '#attributes' => array(
+          'class' => array(
+            'button',
+            'button-no',
+            'fake-cancel',
+            $key,
+          ),
+        ),
+        '#weight' => 100,
+      );
+    }
+  }
+
+  // Allow modules to change the tab names or whatever else they want to change
+  // before we render.  Perhaps this should be an alter on the theming function
+  // that we should write to be making the tabs.
+  drupal_alter('media_browser_plugins', $plugin_output);
+
+  $tabs = array();
+  $settings = array('media' => array('browser' => array()));
+
+  foreach (element_children($plugin_output, TRUE) as $key) {
+    // Add any JavaScript settings from the browser tab.
+    if (!empty($plugin_output[$key]['#settings'])) {
+      $settings['media']['browser'][$key] = $plugin_output[$key]['#settings'];
+    }
+
+    // If this is a "ajax" style tab, add the href, otherwise an id. jQuery UI
+    // will use an href value to load content from that url
+    $tabid = 'media-tab-' . check_plain($key);
+    if (!empty($plugin_output[$key]['#callback'])) {
+      $href = $plugin_output[$key]['#callback'];
+    }
+    else {
+      $attributes = array(
+        'class' => array('media-browser-tab'),
+        'id' => $tabid,
+        'data-tabid' => $key,
+      );
+      // Create a div for each tab's content.
+      $plugin_output[$key] += array(
+        '#prefix' => '<div '. drupal_attributes($attributes) . ">\n",
+        '#suffix' => "</div>\n",
+      );
+    }
+
+    $attributes = array(
+      'href' => '#' . $tabid,
+      'data-tabid' => $key,
+      'title' => $plugin_output[$key]['#title'],
+    );
+    $tabs[]['element'] = array(
+      '#markup' => '<li><a' . drupal_attributes($attributes) . '>' . check_plain($plugin_output[$key]['#title']) . "</a></li>\n",
+    );
+  }
+
+  drupal_add_js($settings, 'setting');
+
+  $output['title'] = array(
+    '#markup' => t('Select a file')
+  );
+
+  $output['tabset']['tabs'] = array(
+    '#theme' => 'menu_local_tasks',
+    '#attributes' => array('class' => array('tabs', 'primary')),
+    '#primary' => $tabs,
+  );
+
+  $output['tabset']['panes'] = $plugin_output;
+
+  return $output;
+}
+
+/**
+ * Provides a singleton of the params passed to the media browser.
+ *
+ * This is useful in situations like form alters because callers can pass
+ * id="wysiywg_form" or whatever they want, and a form alter could pick this up.
+ * We may want to change the hook_media_browser_plugin_view() implementations to
+ * use this function instead of being passed params for consistency.
+ *
+ * It also offers a chance for some meddler to meddle with them.
+ *
+ * @see media_browser()
+ */
+function media_set_browser_params() {
+  $params = &drupal_static(__FUNCTION__, array());
+
+  if (empty($params)) {
+    // Build out browser settings. Permissions- and security-related behaviors
+    // should not rely on these parameters, since they come from the HTTP query.
+    // @TODO make sure we treat parameters as user input.
+    $params = drupal_get_query_parameters() + array(
+      'types' => array(),
+      'multiselect' => FALSE,
+    );
+
+    // Transform text 'true' and 'false' to actual booleans.
+    foreach ($params as $k => $v) {
+      if ($v === 'true') {
+        $params[$k] = TRUE;
+      }
+      elseif ($v === 'false') {
+        $params[$k] = FALSE;
+      }
+    }
+
+    array_walk_recursive($params, 'media_recursive_check_plain');
+
+    // Allow modules to alter the parameters.
+    drupal_alter('media_browser_params', $params);
+  }
+
+  return $params;
+}
+
+
+/**
+ * For sanity in grammar.
+ *
+ * @see media_set_browser_params()
+ */
+function media_get_browser_params() {
+  return media_set_browser_params();
+}
+
+/**
+ * Attaches media browser javascript to an element.
+ *
+ * @param array $element
+ *   The element array to attach to.
+ */
+function media_attach_browser_js(&$element) {
+  $javascript = media_browser_js();
+  foreach ($javascript as $key => $definitions) {
+    foreach ($definitions as $definition) {
+      $element['#attached'][$key][] = $definition;
+    }
+  }
+}
+
+/**
+ * Helper function to define browser javascript.
+ */
+function media_browser_js() {
+  $settings = array(
+    'browserUrl' => url('media/browser', array(
+        'query' => array('render' => 'media-popup'),
+      )
+    ),
+    'styleSelectorUrl' => url('media/-media_id-/format-form', array(
+        'query' => array('render' => 'media-popup'),
+      )
+    ),
+  );
+
+  $js = array(
+    'library' => array(
+      array('media', 'media_browser'),
+    ),
+    'js' => array(
+      array(
+        'data' => array('media' => $settings),
+        'type' => 'setting',
+      ),
+    ),
+  );
+  return $js;
+}
+
+/**
+ * Menu callback for testing the media browser.
+ */
+function media_browser_testbed($form) {
+  media_attach_browser_js($form);
+
+  $form['test_element'] = array(
+    '#type' => 'media',
+    '#media_options' => array(
+      'global' => array(
+        'types' => array('video', 'audio'),
+      ),
+    ),
+  );
+
+  $launcher = '<a href="#" id="launcher"> Launch Media Browser</a>';
+
+  $form['options'] = array(
+    '#type' => 'textarea',
+    '#title' => 'Options (JSON)',
+    '#rows' => 10,
+  );
+
+  $form['launcher'] = array(
+    '#markup' => $launcher,
+  );
+
+  $form['result'] = array(
+    '#type' => 'textarea',
+    '#title' => 'Result',
+  );
+
+  $js = <<<EOF
+    Drupal.behaviors.mediaTest = {
+    attach: function(context, settings) {
+      var delim = "---";
+      var recentOptions = [];
+      var recentOptionsCookie = jQuery.cookie("recentOptions");
+      if (recentOptionsCookie) {
+        recentOptions = recentOptionsCookie.split("---");
+      }
+
+      var recentSelectBox = jQuery('<select id="recent_options" style="width:100%"></select>').change(function() { jQuery('#edit-options').val(jQuery(this).val())});
+
+      jQuery('.form-item-options').append('<label for="recent_options">Recent</a>');
+      jQuery('.form-item-options').append(recentSelectBox);
+      jQuery('.form-item-options').append(jQuery('<a href="#">Reset</a>').click(function() {alert('reset'); jQuery.cookie("recentOptions", null); window.location.reload(); }));
+
+      jQuery.each(recentOptions, function (idx, val) {
+        recentSelectBox.append(jQuery('<option></option>').val(val).html(val));
+      });
+
+
+      jQuery('#launcher').click(function () {
+        jQuery('#edit-result').val('');
+        var options = {};
+        var optionsTxt = jQuery('#edit-options').val();
+        if (optionsTxt) {
+          // Store it in the recent box
+          recentOptionsCookie += "---" + optionsTxt
+          jQuery.cookie("recentOptions", recentOptionsCookie, { expires: 7 });
+          recentSelectBox.append(jQuery('<option></option>').val(optionsTxt).html(optionsTxt));
+          options = eval('(' + optionsTxt + ')');
+        }
+        Drupal.media.popups.mediaBrowser(Drupal.behaviors.mediaTest.mediaSelected, options);
+        return false;
+      });
+    },
+
+    mediaSelected: function(selectedMedia) {
+      var result = JSON.stringify(selectedMedia);
+        jQuery('#edit-result').val(result);
+    }
+  }
+
+EOF;
+
+  drupal_add_js($js, array('type' => 'inline'));
+  return $form;
+}
+
+/**
+ * Adds properties to the file.
+ *
+ * Additional properties on this file are needed by the media browser JS code.
+ */
+function media_browser_build_media_item($file) {
+  $preview = media_get_thumbnail_preview($file);
+  $file->preview = drupal_render($preview);
+  $file->url = file_create_url($file->uri);
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media.fields.inc b/profiles/commons/modules/contrib/media/includes/media.fields.inc
new file mode 100644
index 0000000..29b63a9
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media.fields.inc
@@ -0,0 +1,217 @@
+<?php
+
+/**
+ * @file
+ * Provide the media file selector widget and media field formatters to the
+ * Fields API.
+ */
+
+/**
+ * Implements hook_field_widget_info().
+ */
+function media_field_widget_info() {
+  return array(
+    'media_generic' => array(
+      'label' => t('Media file selector'),
+      'field types' => array('file', 'image'),
+      'settings' => array(
+        'progress_indicator' => 'throbber',
+        'allowed_types' => array('image'),
+        'browser_plugins' => array(),
+        'allowed_schemes' => array('public', 'private'),
+      ),
+      'behaviors' => array(
+        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
+        'default value' => FIELD_BEHAVIOR_NONE,
+      ),
+    ),
+  );
+}
+
+/**
+ * Implements hook_field_formatter_info().
+ *
+ * Provides legacy support for the "Large filetype icon" file field formatter.
+ * This was originally used when media entities contained file fields. The
+ * current file entity architecture no longer needs this, but people may
+ * have used this formatter for other file fields on their website.
+ *
+ * @todo Some day, remove this.
+ */
+function media_field_formatter_info() {
+  $formatters = array(
+    'media_large_icon' => array(
+      'label' => t('Large filetype icon'),
+      'field types' => array('file'),
+    ),
+  );
+  return $formatters;
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ *
+ * Legacy support for the "Large filetype icon" file field formatter.
+ * @see media_field_formatter_info()
+ */
+function media_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $element = array();
+
+  if ($display['type'] == 'media_large_icon') {
+    // Use the media_thumbnail image style so that the output in media browser
+    // is consistent.
+    foreach ($items as $delta => $item) {
+      $element[$delta] = array(
+        '#theme' => 'media_formatter_large_icon',
+        '#file' => (object) $item,
+      );
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * Implements hook_field_widget_settings_form().
+ */
+function media_field_widget_settings_form($field, $instance) {
+  $widget = $instance['widget'];
+  $settings = $widget['settings'];
+  $form = array();
+
+  $streams = file_get_stream_wrappers(STREAM_WRAPPERS_VISIBLE);
+
+  $form['allowed_types'] = array(
+    '#type' => 'checkboxes',
+    '#title' => t('Allowed remote media types'),
+    '#options' => file_entity_type_get_names(),
+    '#default_value' => $settings['allowed_types'],
+    '#description' => t('Media types which are allowed for this field when using remote streams.'),
+    '#weight' => 1,
+    '#access' => count(file_get_stream_wrappers(STREAM_WRAPPERS_VISIBLE | STREAM_WRAPPERS_LOCAL)) != count($streams),
+  );
+
+  $options = array();
+  foreach ($streams as $scheme => $data) {
+    $options[$scheme] = t('@scheme (@name)', array('@scheme' => $scheme . '://', '@name' => $data['name']));
+  }
+  $form['allowed_schemes'] = array(
+    '#type' => 'checkboxes',
+    '#title' => t('Allowed URI schemes'),
+    '#options' => $options,
+    '#default_value' => $settings['allowed_schemes'],
+    '#description' => t('URI schemes include public:// and private:// which are the Drupal files directories, and may also refer to remote sites.'),
+    '#weight' => 2,
+  );
+
+  $plugins = media_get_browser_plugin_info();
+  $form['browser_plugins'] = array(
+    '#type' => 'checkboxes',
+    '#title' => t('Enabled browser plugins'),
+    '#options' => array(),
+    '#default_value' => $settings['browser_plugins'],
+    '#description' => t('If no plugins are selected, they will all be available.'),
+  );
+  foreach ($plugins as $key => $plugin) {
+    $form['browser_plugins']['#options'][$key] = !empty($plugin['title']) ? $plugin['title'] : $key;
+  }
+
+  return $form;
+}
+
+/**
+ * Implements hook_field_widget_form().
+ */
+function media_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
+  $field_settings = $instance['settings'];
+  $widget_settings = $instance['widget']['settings'];
+
+  // @todo The Field API supports automatic serialization / unserialization, so
+  //   this should no longer be needed. After verifying with a module that uses
+  //   the 'data' column, remove this.
+  // @see media_field_widget_value()
+  $current_value = array();
+  if (isset($items[$delta])) {
+    $current_value = $items[$delta];
+    // @todo $items[$delta] is sometimes a loaded media entity (an object)
+    //   rather than an array. This conflicts with Field API expectations (for
+    //   example, it results in fatal errors when previewing a node with a
+    //   multi-valued media field), so should be fixed. In the meantime, don't
+    //   assume that $current_value is an array.
+    if (is_array($current_value) && isset($current_value['data']) && is_string($current_value['data'])) {
+      $current_value['data'] = unserialize($current_value['data']);
+    }
+  }
+
+  $element += array(
+    // @todo This should be a fieldset, but throws a warning about
+    // element_children.
+    '#type' => 'media',
+    '#collapsed' => TRUE,
+    '#default_value' => $current_value,
+    '#required' => $instance['required'],
+    '#media_options' => array(
+      'global' => array(
+        'types' => array_filter($widget_settings['allowed_types']),
+        'enabledPlugins' => array_filter($instance['widget']['settings']['browser_plugins']),
+        'schemes' => $widget_settings['allowed_schemes'],
+        'file_directory' => isset($field_settings['file_directory']) ? $field_settings['file_directory'] : '',
+        'file_extensions' => isset($field_settings['file_extensions']) ? $field_settings['file_extensions'] : variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'),
+        'max_filesize' => isset($field_settings['max_filesize']) ? $field_settings['max_filesize'] : 0,
+        'uri_scheme' => !empty($field['settings']['uri_scheme']) ? $field['settings']['uri_scheme'] : file_default_scheme(),
+      ),
+    ),
+  );
+
+  if ($field['cardinality'] != 1) {
+    $element['#title'] = check_plain($instance['label']);
+    $element['#title_display'] = 'invisible';
+  }
+
+  if ($field['type'] == 'file') {
+    $element['display'] = array(
+      '#type' => 'value',
+      '#value' => 1,
+    );
+  }
+
+  // Add image field specific validators.
+  if ($field['type'] == 'image') {
+    if ($field_settings['min_resolution'] || $field_settings['max_resolution']) {
+      $element['#media_options']['global']['min_resolution'] = $field_settings['min_resolution'];
+      $element['#media_options']['global']['max_resolution'] = $field_settings['max_resolution'];
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * Widget value.
+ *
+ * @todo Is this function ever called? If not, remove it. The Field API now
+ *   supports automatic serialization / unserialization, so this should no
+ *   longer be needed. After verifying with a module that uses the 'data'
+ *   column, remove this.
+ *
+ * @see media_field_widget_form()
+ */
+function media_field_widget_value($element, $input, $form_state) {
+  $return = $input;
+
+  if (!is_array($return)) {
+    $return = array();
+  }
+
+  if (isset($return['data'])) {
+    $return['data'] = serialize($return['data']);
+  }
+
+  $return += array(
+    'fid' => 0,
+    'title' => '',
+    'data' => NULL,
+  );
+
+  return $return;
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media.pages.inc b/profiles/commons/modules/contrib/media/includes/media.pages.inc
new file mode 100644
index 0000000..b22a8b1
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media.pages.inc
@@ -0,0 +1,33 @@
+<?php
+
+/**
+ * @file
+ * Common pages for the Media module.
+ */
+
+/**
+ * CTools modal callback for editing a file.
+ */
+function media_file_edit_modal($form, &$form_state, $file, $js) {
+  ctools_include('modal');
+  ctools_include('ajax');
+
+  $form_state['ajax'] = $js;
+  form_load_include($form_state, 'inc', 'file_entity', 'file_entity.pages');
+
+  $output = ctools_modal_form_wrapper('file_entity_edit', $form_state);
+
+  if ($js) {
+    $commands = $output;
+
+    if ($form_state['executed']) {
+      $commands = array(ctools_modal_command_dismiss(t('File saved')));
+    }
+
+    print ajax_render($commands);
+    exit();
+  }
+
+  // Otherwise, just return the output.
+  return $output;
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media.theme.inc b/profiles/commons/modules/contrib/media/includes/media.theme.inc
new file mode 100644
index 0000000..9f2ff31
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media.theme.inc
@@ -0,0 +1,95 @@
+<?php
+
+/**
+ * @file
+ * Media Theming
+ *
+ * Theming functions for the Media module.
+ */
+
+/**
+ * Add messages to the page.
+ */
+function template_preprocess_media_dialog_page(&$variables) {
+  $variables['messages'] = theme('status_messages');
+}
+
+/**
+ * Adds a wrapper around a preview of a media file.
+ */
+function theme_media_thumbnail($variables) {
+  $label = '';
+  $element = $variables['element'];
+
+ // Wrappers to go around the thumbnail.
+  $attributes = array(
+    'title' => $element['#name'],
+    'class' => 'media-item',
+    'data-fid' => $element['#file']->fid,
+  );
+  $prefix = '<div ' . drupal_attributes($attributes) . '><div class="media-thumbnail">';
+  $suffix = '</div></div>';
+
+  // Arguments for the thumbnail link.
+  $thumb = $element['#children'];
+  $target = 'file/' . $element['#file']->fid . '/edit';
+  $options = array(
+    'query' => drupal_get_destination(),
+    'html' => TRUE,
+    'attributes' => array('title' => t('Click to edit details')),
+  );
+
+  // Element should be a field renderable array. This should be improved.
+  if (!empty($element['#show_names']) && $element['#name']) {
+    $label = '<div class="label-wrapper"><label class="media-filename">' . $element['#name'] . '</label></div>';
+  }
+
+  $output = $prefix;
+  if (!empty($element['#add_link'])) {
+    $output .= l($thumb, $target, $options);
+  }
+  else {
+    $output .= $thumb;
+  }
+  $output .= $label . $suffix;
+  return $output;
+}
+
+/**
+ * Preprocess the media thumbnail.
+ */
+function template_preprocess_media_thumbnail(&$variables) {
+  // Set the name for the thumbnail to be the filename.  This is done here so
+  // that other modules can hijack the name displayed if it should not be the
+  // filename.
+  $variables['element']['#name'] = isset($variables['element']['#file']->filename) ? check_plain($variables['element']['#file']->filename) : NULL;
+}
+
+/**
+ * Field formatter for displaying a file as a large icon.
+ */
+function theme_media_formatter_large_icon($variables) {
+  $file = $variables['file'];
+  $icon_dir = variable_get('media_icon_base_directory', 'public://media-icons') . '/' . variable_get('media_icon_set', 'default');
+  $icon = file_icon_path($file, $icon_dir);
+  $variables['path'] = $icon;
+
+  // theme_image() requires the 'alt' attribute passed as its own variable.
+  // @see http://drupal.org/node/999338
+  if (!isset($variables['alt']) && isset($variables['attributes']['alt'])) {
+    $variables['alt'] = $variables['attributes']['alt'];
+  }
+
+  // Add image height and width for the image theme functions.
+  if ($info = image_get_info($icon)) {
+    $variables += $info;
+  }
+
+  if ($variables['style_name']) {
+    $output = theme('image_style', $variables);
+  }
+  else {
+    $output = theme('image', $variables);
+  }
+  return $output;
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media_views_plugin_display_media_browser.inc b/profiles/commons/modules/contrib/media/includes/media_views_plugin_display_media_browser.inc
new file mode 100644
index 0000000..eba27ba
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media_views_plugin_display_media_browser.inc
@@ -0,0 +1,19 @@
+<?php
+/**
+ * @file
+ * Contains the media browser tab display plugin.
+ */
+
+/**
+ * Display plugin to provide a view as a tab in the media browser.
+ *
+ * This is currently just a stub--there's nothing special we need to set up for
+ * rendering a view as a tab in the media browser. It would be possible to
+ * provide a special method that returns the plugin info for
+ * media_media_browser_plugin_info() and the render array for
+ * media_media_browser_plugin_view().
+ *
+ * @ingroup views_display_plugins
+ */
+class media_views_plugin_display_media_browser extends views_plugin_display {
+}
diff --git a/profiles/commons/modules/contrib/media/includes/media_views_plugin_style_media_browser.inc b/profiles/commons/modules/contrib/media/includes/media_views_plugin_style_media_browser.inc
new file mode 100644
index 0000000..4131116
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/includes/media_views_plugin_style_media_browser.inc
@@ -0,0 +1,55 @@
+<?php
+
+/**
+ * @file
+ * The media browser style plugin.
+ */
+
+/**
+ * Media Views style plugin.
+ *
+ * Style plugin to render media items as an interactive grid for the media
+ * browser.
+ *
+ * @ingroup views_style_plugins
+ */
+class media_views_plugin_style_media_browser extends views_plugin_style_list {
+
+  // Stores the files loaded with pre_render.
+  public $files = array();
+
+  /**
+   * Set default options.
+   */
+  function option_definition() {
+    $options = parent::option_definition();
+
+    $options['type'] = array('default' => 'ul');
+    $options['class'] = array('default' => 'media-list-thumbnails');
+    $options['wrapper_class'] = array('default' => '');
+
+    return $options;
+  }
+
+  /**
+   * Prevents a problem with views when get_row_class() is not set.
+   */
+  public function get_row_class($row_index) {
+  }
+
+  /**
+   * Add the base field (fid) to the query.
+   */
+  public function query() {
+    if (method_exists($this->view->query, 'add_field')) {
+      // Normal file_managed based view.
+      $this->view->query->add_field($this->view->base_table, $this->view->base_field);
+    }
+    if (method_exists($this->view->query, 'addField')) {
+      // Search API based view.
+      $this->view->query->addField('fid');
+    }
+    parent::query();
+  }
+
+}
diff --git a/profiles/commons/modules/contrib/media/js/media.admin.js b/profiles/commons/modules/contrib/media/js/media.admin.js
new file mode 100644
index 0000000..058e931
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/media.admin.js
@@ -0,0 +1,77 @@
+/**
+ * @file
+ * Javascript for the interface at admin/content/media and also for interfaces
+ * related to setting up media fields and for media type administration.
+ *
+ * Basically, if it's on the /admin path, it's probably here.
+ */
+
+(function ($) {
+
+/**
+ * Functionality for the administrative file listings.
+ */
+Drupal.behaviors.mediaAdmin = {
+  attach: function (context) {
+    // Show a javascript confirmation dialog if a user has files selected and
+    // they try to switch between the "Thumbnail" and "List" local tasks.
+    $('.tabs.secondary a').once('media-admin').bind('click', function () {
+      if ($(':checkbox:checked', $('.file-entity-admin-file-form')).length != 0) {
+        return confirm(Drupal.t('If you switch views, you will lose your selection.'));
+      }
+    });
+
+    if ($('.media-display-thumbnails').length && !$('.media-thumbnails-select').length) {
+      // Implements 'select all/none' for thumbnail view.
+      // @TODO: Support grabbing more than one page of thumbnails.
+      var allLink = $('<a href="#">' + Drupal.t('all') + '</a>')
+        .click(function () {
+          $('.media-display-thumbnails', $(this).parents('form')).find(':checkbox').attr('checked', true).change();
+          return false;
+        });
+      var noneLink = $('<a href="#">' + Drupal.t('none') + '</a>')
+        .click(function () {
+          $('.media-display-thumbnails', $(this).parents('form')).find(':checkbox').attr('checked', false).change();
+          return false;
+        });
+      $('<div class="media-thumbnails-select" />')
+        .append('<strong>' + Drupal.t('Select') + ':</strong> ')
+        .append(allLink)
+        .append(', ')
+        .append(noneLink)
+        .prependTo('.media-display-thumbnails')
+      // If the media item is clicked anywhere other than on the image itself
+      // check the checkbox. For the record, JS thinks this is wonky.
+      $('.media-item').bind('click', function (e) {
+        if ($(e.target).is('img, a')) {
+          return;
+        }
+        var checkbox = $(this).parent().find(':checkbox');
+        if (checkbox.is(':checked')) {
+          checkbox.attr('checked', false).change();
+        } else {
+          checkbox.attr('checked', true).change();
+        }
+      });
+
+      // Add an extra class to selected thumbnails.
+      $('.media-display-thumbnails :checkbox').each(function () {
+        var checkbox = $(this);
+        if (checkbox.is(':checked')) {
+          $(checkbox.parents('li').find('.media-item')).addClass('selected');
+        }
+
+        checkbox.bind('change.media', function () {
+          if (checkbox.is(':checked')) {
+            $(checkbox.parents('li').find('.media-item')).addClass('selected');
+          }
+          else {
+            $(checkbox.parents('li').find('.media-item')).removeClass('selected');
+          }
+        });
+      });
+    }
+  }
+};
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/js/media.browser.js b/profiles/commons/modules/contrib/media/js/media.browser.js
new file mode 100644
index 0000000..236df27
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/media.browser.js
@@ -0,0 +1,149 @@
+/**
+ * @file
+ * Provides default functions for the media browser
+ */
+
+(function ($) {
+namespace('Drupal.media.browser');
+
+Drupal.media.browser.selectedMedia = [];
+Drupal.media.browser.activeTab = 0;
+Drupal.media.browser.mediaAdded = function () {};
+Drupal.media.browser.selectionFinalized = function (selectedMedia) {
+  // This is intended to be overridden if a callee wants to be triggered
+  // when the media selection is finalized from inside the browser.
+  // This is used for the file upload form for instance.
+};
+
+Drupal.behaviors.MediaBrowser = {
+  attach: function (context) {
+    if (Drupal.settings.media && Drupal.settings.media.selectedMedia) {
+      Drupal.media.browser.selectMedia(Drupal.settings.media.selectedMedia);
+      // Fire a confirmation of some sort.
+      Drupal.media.browser.finalizeSelection();
+    }
+
+    // Instantiate the tabs.
+    $('#media-browser-tabset').tabs();
+
+    $('.ui-tabs-nav li').mouseup(function() {
+      Drupal.media.browser.activeTab = $(this).index();
+    });
+
+    $('.media-browser-tab').each( Drupal.media.browser.validateButtons );
+
+    Drupal.media.browser.selectActiveTab();
+    Drupal.media.browser.selectErrorTab();
+
+  }
+  // Wait for additional params to be passed in.
+};
+
+Drupal.media.browser.launch = function () {
+
+};
+
+Drupal.media.browser.validateButtons = function() {
+  // The media browser runs in an IFRAME. The Drupal.media.popups.mediaBrowser()
+  // function sets up the IFRAME and "OK" and "Cancel" buttons that are outside
+  // of the IFRAME, so that their click handlers can destroy the IFRAME while
+  // retaining information about what media items were selected. However,
+  // Drupal UI convention is to place all action buttons on the same "line"
+  // at the bottom of the form, so if the form within the IFRAME contains a
+  // "Submit" button or other action buttons, then the "OK" and "Cancel"
+  // buttons below the IFRAME break this convention and confuse the user.
+  // Therefore, we add "Submit" and "Cancel" buttons inside the IFRAME, and
+  // have their click action trigger the click action of the corresonding
+  // "OK" and "Cancel" buttons that are outside the IFRAME. media.css contains
+  // CSS rules that hide the outside buttons.
+
+  // If a submit button is present, another round-trip to the server is needed
+  // before the user's selection is finalized. For these cases, when the form's
+  // real Submit button is clicked, the server either returns another form for
+  // the user to fill out, or else a completion page that contains or sets the
+  // Drupal.media.browser.selectedMedia variable. If the latter, then
+  // Drupal.media.popups.mediaBrowser.mediaBrowserOnLoad() auto-triggers the
+  // "OK" button action to finalize the selection and remove the IFRAME.
+
+  // We need to check for the fake submit/cancel buttons that are used on
+  // non-form based pane content. On these items we need to bind the clicks
+  // so that media can be selected or the window can be closed. This is still a
+  // hacky approach, but it is a step in the right direction.
+
+  $('a.button.fake-submit', this).once().bind('click', Drupal.media.browser.submit);
+  $('a.button.fake-cancel', this).once().bind('click', Drupal.media.browser.submit);
+};
+
+Drupal.media.browser.submit = function () {
+  // @see Drupal.media.browser.validateButtons().
+  var buttons = $(parent.window.document.body).find('#mediaBrowser').parent('.ui-dialog').find('.ui-dialog-buttonpane button');
+  if ($(this).hasClass('fake-cancel')) {
+    buttons[1].click();
+  }
+  else {
+    buttons[0].click();
+  }
+
+  // Return false to prevent the fake link "click" from continuing.
+  return false;
+}
+
+Drupal.media.browser.selectMedia = function (selectedMedia) {
+  Drupal.media.browser.selectedMedia = selectedMedia;
+};
+
+Drupal.media.browser.finalizeSelection = function () {
+  if (!Drupal.media.browser.selectedMedia) {
+    throw new exception(Drupal.t('Cannot continue, nothing selected'));
+  }
+  else {
+    Drupal.media.browser.selectionFinalized(Drupal.media.browser.selectedMedia);
+  }
+};
+
+Drupal.media.browser.selectErrorTab = function() {
+  // Find the ID of a tab with an error in it
+  var errorTabID = $('#media-browser-tabset')
+    .find('.error')
+    .parents('.media-browser-tab')
+    .attr('id');
+
+  if (errorTabID !== undefined) {
+    // Find the Tab Link with errorTabID
+    var tab = $('a[href="#' + errorTabID + '"]');
+    // Find the index of the tab
+    var index = $('#media-browser-tabset a').index(tab);
+    // Select the tab
+    Drupal.media.browser.selectTab(index);
+  }
+}
+
+Drupal.media.browser.selectActiveTab = function() {
+  // Find the index of the last active tab.
+  setTimeout(function() {
+    Drupal.media.browser.selectTab(Drupal.media.browser.activeTab);
+  }, 10);
+};
+
+/**
+ * Helper function to change the media browser jQuery UI tabs
+ * since it requires two different methods dependingon the version.
+ */
+Drupal.media.browser.selectTab = function(index) {
+  var ver = jQuery.ui.version.split('.');
+  if (ver[0] == '1' && parseInt(ver[1]) <= 8) {
+    // jQuery UI <= 1.8
+    $('#media-browser-tabset').tabs('select', index);
+  }
+  else {
+    // jQuery UI 1.9+
+    $('#media-browser-tabset').tabs('option', 'active', index);
+  }
+
+  $('.media-modal-frame').width('100%');
+
+  // Update the active tab variable.
+  Drupal.media.browser.activeTab = index;
+};
+
+}(jQuery));
diff --git a/profiles/commons/modules/contrib/media/js/media.core.js b/profiles/commons/modules/contrib/media/js/media.core.js
new file mode 100644
index 0000000..f99971c
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/media.core.js
@@ -0,0 +1,19 @@
+
+/**
+ * Creates a namespace.
+ *
+ * @return
+ *   The created namespace object.
+ */
+function namespace () {
+  var a=arguments, o=null, i, j, d;
+  for (i=0; i<a.length; i=i+1) {
+    d=a[i].split(".");
+    o=window;
+    for (j=0; j<d.length; j=j+1) {
+      o[d[j]]=o[d[j]] || {};
+      o=o[d[j]];
+    }
+  }
+  return o;
+};
diff --git a/profiles/commons/modules/contrib/media/js/media.js b/profiles/commons/modules/contrib/media/js/media.js
new file mode 100644
index 0000000..04585bd
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/media.js
@@ -0,0 +1,97 @@
+
+/**
+ *  @file
+ *  This file handles the JS for Media Module functions.
+ */
+
+(function ($) {
+
+/**
+ * Loads media browsers and callbacks, specifically for media as a field.
+ */
+Drupal.behaviors.mediaElement = {
+  attach: function (context, settings) {
+    // Options set from media.fields.inc for the types, etc to show in the browser.
+
+    // For each widget (in case of multi-entry)
+    $('.media-widget', context).once('mediaBrowserLaunch', function () {
+      var options = settings.media.elements[this.id];
+      globalOptions = {};
+      if (options.global != undefined) {
+        var globalOptions = options.global;
+      }
+      //options = Drupal.settings.media.fields[this.id];
+      var fidField = $('.fid', this);
+      var previewField = $('.preview', this);
+      var editButton = $('.edit', this);
+      var removeButton = $('.remove', this);
+
+      // Hide the edit and remove buttons if there is no file data yet.
+      if (fidField.val() == 0) {
+        if (editButton.length) {
+          editButton.hide();
+        }
+        removeButton.hide();
+      }
+
+      // When someone clicks the link to pick media (or clicks on an existing thumbnail)
+      $('.launcher', this).bind('click', function (e) {
+        // Launch the browser, providing the following callback function
+        // @TODO: This should not be an anomyous function.
+        Drupal.media.popups.mediaBrowser(function (mediaFiles) {
+          if (mediaFiles.length < 0) {
+            return;
+          }
+          var mediaFile = mediaFiles[0];
+          // Set the value of the filefield fid (hidden) and trigger a change.
+          fidField.val(mediaFile.fid);
+          fidField.trigger('change');
+          // Set the preview field HTML.
+          previewField.html(mediaFile.preview);
+        }, globalOptions);
+        e.preventDefault();
+      });
+
+      // When someone clicks the Remove button.
+      $('.remove', this).bind('click', function (e) {
+        // Set the value of the filefield fid (hidden) and trigger change.
+        fidField.val(0);
+        fidField.trigger('change');
+        // Set the preview field HTML.
+        previewField.html('');
+        e.preventDefault();
+      });
+
+      // Show or hide the edit/remove buttons if the field has a file or not.
+      $('.fid', this).bind('change', function() {
+        if (fidField.val() == 0) {
+          if (editButton.length) {
+            editButton.hide();
+          }
+          removeButton.hide();
+        }
+        else {
+          if (editButton.length) {
+            var url = Drupal.settings.basePath + 'file/' + fidField.val() + '/edit';
+            $.ajax({
+              url: location.protocol + '//' + location.host + url,
+              type: 'HEAD',
+              success: function(data) {
+                editButton.attr('href', editButton.attr('href').replace(/media\/\d+\/edit/, 'media/' + fidField.val() + '/edit'));
+                // Re-process the edit link through CTools modal behaviors.
+                editButton.unbind('click');
+                editButton.removeClass('ctools-use-modal-processed');
+                // @todo Maybe add support for Drupal.detachBehaviors in Drupal.behaviors.ZZCToolsModal?
+                Drupal.attachBehaviors(editButton.parent(), Drupal.settings);
+                editButton.show();
+              }
+            });
+          }
+          removeButton.show();
+        }
+      });
+    });
+  }
+};
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/js/media.popups.js b/profiles/commons/modules/contrib/media/js/media.popups.js
new file mode 100644
index 0000000..46af675
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/media.popups.js
@@ -0,0 +1,393 @@
+
+/**
+ * @file: Popup dialog interfaces for the media project.
+ *
+ * Drupal.media.popups.mediaBrowser
+ *   Launches the media browser which allows users to pick a piece of media.
+ *
+ * Drupal.media.popups.mediaStyleSelector
+ *  Launches the style selection form where the user can choose
+ *  what format / style they want their media in.
+ *
+ */
+
+(function ($) {
+namespace('Drupal.media.popups');
+
+/**
+ * Media browser popup. Creates a media browser dialog.
+ *
+ * @param {function}
+ *          onSelect Callback for when dialog is closed, received (Array
+ *          media, Object extra);
+ * @param {Object}
+ *          globalOptions Global options that will get passed upon initialization of the browser.
+ *          @see Drupal.media.popups.mediaBrowser.getDefaults();
+ *
+ * @param {Object}
+ *          pluginOptions Options for specific plugins. These are passed
+ *          to the plugin upon initialization.  If a function is passed here as
+ *          a callback, it is obviously not passed, but is accessible to the plugin
+ *          in Drupal.settings.variables.
+ *
+ *          Example
+ *          pluginOptions = {library: {url_include_patterns:'/foo/bar'}};
+ *
+ * @param {Object}
+ *          widgetOptions Options controlling the appearance and behavior of the
+ *          modal dialog.
+ *          @see Drupal.media.popups.mediaBrowser.getDefaults();
+ */
+Drupal.media.popups.mediaBrowser = function (onSelect, globalOptions, pluginOptions, widgetOptions) {
+  var options = Drupal.media.popups.mediaBrowser.getDefaults();
+  options.global = $.extend({}, options.global, globalOptions);
+  options.plugins = pluginOptions;
+  options.widget = $.extend({}, options.widget, widgetOptions);
+
+  // Create it as a modal window.
+  var browserSrc = options.widget.src;
+  if ($.isArray(browserSrc) && browserSrc.length) {
+    browserSrc = browserSrc[browserSrc.length - 1];
+  }
+  // Params to send along to the iframe.  WIP.
+  var params = {};
+  $.extend(params, options.global);
+  params.plugins = options.plugins;
+
+  browserSrc += '&' + $.param(params);
+  var mediaIframe = Drupal.media.popups.getPopupIframe(browserSrc, 'mediaBrowser');
+  // Attach the onLoad event
+  mediaIframe.bind('load', options, options.widget.onLoad);
+  /**
+   * Setting up the modal dialog
+   */
+
+  var ok = 'OK';
+  var cancel = 'Cancel';
+  var notSelected = 'You have not selected anything!';
+
+  if (Drupal && Drupal.t) {
+    ok = Drupal.t(ok);
+    cancel = Drupal.t(cancel);
+    notSelected = Drupal.t(notSelected);
+  }
+
+  // @todo: let some options come through here. Currently can't be changed.
+  var dialogOptions = options.dialog;
+
+  dialogOptions.buttons[ok] = function () {
+    var selected = this.contentWindow.Drupal.media.browser.selectedMedia;
+    if (selected.length < 1) {
+      alert(notSelected);
+      return;
+    }
+    onSelect(selected);
+    $(this).dialog("close");
+  };
+
+  dialogOptions.buttons[cancel] = function () {
+    $(this).dialog("close");
+  };
+
+  var dialog = mediaIframe.dialog(dialogOptions);
+
+  // Remove the title bar.
+  dialog.parents(".ui-dialog").find(".ui-dialog-titlebar").remove();
+
+  Drupal.media.popups.sizeDialog(dialog);
+  Drupal.media.popups.resizeDialog(dialog);
+  Drupal.media.popups.scrollDialog(dialog);
+  Drupal.media.popups.overlayDisplace(dialog.parents(".ui-dialog"));
+
+  return mediaIframe;
+};
+
+Drupal.media.popups.mediaBrowser.mediaBrowserOnLoad = function (e) {
+  var options = e.data;
+  if (this.contentWindow.Drupal.media == undefined) return;
+
+  if (this.contentWindow.Drupal.media.browser.selectedMedia.length > 0) {
+    var ok = (Drupal && Drupal.t) ? Drupal.t('OK') : 'OK';
+    var ok_func = $(this).dialog('option', 'buttons')[ok];
+    ok_func.call(this);
+    return;
+  }
+};
+
+Drupal.media.popups.mediaBrowser.getDefaults = function () {
+  return {
+    global: {
+      types: [], // Types to allow, defaults to all.
+      activePlugins: [] // If provided, a list of plugins which should be enabled.
+    },
+    widget: { // Settings for the actual iFrame which is launched.
+      src: Drupal.settings.media.browserUrl, // Src of the media browser (if you want to totally override it)
+      onLoad: Drupal.media.popups.mediaBrowser.mediaBrowserOnLoad // Onload function when iFrame loads.
+    },
+    dialog: Drupal.media.popups.getDialogOptions()
+  };
+};
+
+Drupal.media.popups.mediaBrowser.finalizeSelection = function () {
+  var selected = this.contentWindow.Drupal.media.browser.selectedMedia;
+  if (selected.length < 1) {
+    alert(notSelected);
+    return;
+  }
+  onSelect(selected);
+  $(this).dialog("close");
+}
+
+/**
+ * Style chooser Popup. Creates a dialog for a user to choose a media style.
+ *
+ * @param mediaFile
+ *          The mediaFile you are requesting this formatting form for.
+ *          @todo: should this be fid?  That's actually all we need now.
+ *
+ * @param Function
+ *          onSubmit Function to be called when the user chooses a media
+ *          style. Takes one parameter (Object formattedMedia).
+ *
+ * @param Object
+ *          options Options for the mediaStyleChooser dialog.
+ */
+Drupal.media.popups.mediaStyleSelector = function (mediaFile, onSelect, options) {
+  var defaults = Drupal.media.popups.mediaStyleSelector.getDefaults();
+  // @todo: remove this awful hack :(
+  defaults.src = defaults.src.replace('-media_id-', mediaFile.fid) + '&fields=' + JSON.stringify(mediaFile.fields);
+  options = $.extend({}, defaults, options);
+  // Create it as a modal window.
+  var mediaIframe = Drupal.media.popups.getPopupIframe(options.src, 'mediaStyleSelector');
+  // Attach the onLoad event
+  mediaIframe.bind('load', options, options.onLoad);
+
+  /**
+   * Set up the button text
+   */
+  var ok = 'OK';
+  var cancel = 'Cancel';
+  var notSelected = 'Very sorry, there was an unknown error embedding media.';
+
+  if (Drupal && Drupal.t) {
+    ok = Drupal.t(ok);
+    cancel = Drupal.t(cancel);
+    notSelected = Drupal.t(notSelected);
+  }
+
+  // @todo: let some options come through here. Currently can't be changed.
+  var dialogOptions = Drupal.media.popups.getDialogOptions();
+
+  dialogOptions.buttons[ok] = function () {
+
+    var formattedMedia = this.contentWindow.Drupal.media.formatForm.getFormattedMedia();
+    if (!formattedMedia) {
+      alert(notSelected);
+      return;
+    }
+    onSelect(formattedMedia);
+    $(this).dialog("close");
+  };
+
+  dialogOptions.buttons[cancel] = function () {
+    $(this).dialog("close");
+  };
+
+  var dialog = mediaIframe.dialog(dialogOptions);
+
+  // Remove the title bar.
+  dialog.parents(".ui-dialog").find(".ui-dialog-titlebar").remove();
+
+  Drupal.media.popups.sizeDialog(dialog);
+  Drupal.media.popups.resizeDialog(dialog);
+  Drupal.media.popups.scrollDialog(dialog);
+  Drupal.media.popups.overlayDisplace(dialog.parents(".ui-dialog"));
+
+  return mediaIframe;
+};
+
+Drupal.media.popups.mediaStyleSelector.mediaBrowserOnLoad = function (e) {
+};
+
+Drupal.media.popups.mediaStyleSelector.getDefaults = function () {
+  return {
+    src: Drupal.settings.media.styleSelectorUrl,
+    onLoad: Drupal.media.popups.mediaStyleSelector.mediaBrowserOnLoad
+  };
+};
+
+
+/**
+ * Style chooser Popup. Creates a dialog for a user to choose a media style.
+ *
+ * @param mediaFile
+ *          The mediaFile you are requesting this formatting form for.
+ *          @todo: should this be fid?  That's actually all we need now.
+ *
+ * @param Function
+ *          onSubmit Function to be called when the user chooses a media
+ *          style. Takes one parameter (Object formattedMedia).
+ *
+ * @param Object
+ *          options Options for the mediaStyleChooser dialog.
+ */
+Drupal.media.popups.mediaFieldEditor = function (fid, onSelect, options) {
+  var defaults = Drupal.media.popups.mediaFieldEditor.getDefaults();
+  // @todo: remove this awful hack :(
+  defaults.src = defaults.src.replace('-media_id-', fid);
+  options = $.extend({}, defaults, options);
+  // Create it as a modal window.
+  var mediaIframe = Drupal.media.popups.getPopupIframe(options.src, 'mediaFieldEditor');
+  // Attach the onLoad event
+  // @TODO - This event is firing too early in IE on Windows 7,
+  // - so the height being calculated is too short for the content.
+  mediaIframe.bind('load', options, options.onLoad);
+
+  /**
+   * Set up the button text
+   */
+  var ok = 'OK';
+  var cancel = 'Cancel';
+  var notSelected = 'Very sorry, there was an unknown error embedding media.';
+
+  if (Drupal && Drupal.t) {
+    ok = Drupal.t(ok);
+    cancel = Drupal.t(cancel);
+    notSelected = Drupal.t(notSelected);
+  }
+
+  // @todo: let some options come through here. Currently can't be changed.
+  var dialogOptions = Drupal.media.popups.getDialogOptions();
+
+  dialogOptions.buttons[ok] = function () {
+    var formattedMedia = this.contentWindow.Drupal.media.formatForm.getFormattedMedia();
+    if (!formattedMedia) {
+      alert(notSelected);
+      return;
+    }
+    onSelect(formattedMedia);
+    $(this).dialog("close");
+  };
+
+  dialogOptions.buttons[cancel] = function () {
+    $(this).dialog("close");
+  };
+
+  var dialog = mediaIframe.dialog(dialogOptions);
+
+  // Remove the title bar.
+  dialog.parents(".ui-dialog").find(".ui-dialog-titlebar").remove();
+
+  Drupal.media.popups.sizeDialog(dialog);
+  Drupal.media.popups.resizeDialog(dialog);
+  Drupal.media.popups.scrollDialog(dialog);
+  Drupal.media.popups.overlayDisplace(dialog);
+
+  return mediaIframe;
+};
+
+Drupal.media.popups.mediaFieldEditor.mediaBrowserOnLoad = function (e) {
+
+};
+
+Drupal.media.popups.mediaFieldEditor.getDefaults = function () {
+  return {
+    // @todo: do this for real
+    src: '/media/-media_id-/edit?render=media-popup',
+    onLoad: Drupal.media.popups.mediaFieldEditor.mediaBrowserOnLoad
+  };
+};
+
+
+/**
+ * Generic functions to both the media-browser and style selector
+ */
+
+/**
+ * Returns the commonly used options for the dialog.
+ */
+Drupal.media.popups.getDialogOptions = function () {
+  return {
+    buttons: {},
+    dialogClass: 'media-wrapper',
+    modal: true,
+    draggable: false,
+    resizable: false,
+    width: 'auto',
+    height: 'auto',
+    position: 'center',
+    zIndex: 10000,
+    close: function (event, ui) {
+      $(event.target).remove();
+    }
+  };
+};
+
+/**
+ * Get an iframe to serve as the dialog's contents. Common to both plugins.
+ */
+Drupal.media.popups.getPopupIframe = function (src, id, options) {
+  var defaults = {width: '100%', scrolling: 'auto'};
+  var options = $.extend({}, defaults, options);
+
+  return $('<iframe class="media-modal-frame"/>')
+  .attr('src', src)
+  .attr('width', options.width)
+  .attr('id', id)
+  .attr('scrolling', options.scrolling);
+};
+
+Drupal.media.popups.overlayDisplace = function (dialog) {
+  if (parent.window.Drupal.overlay && jQuery.isFunction(parent.window.Drupal.overlay.getDisplacement)) {
+    var overlayDisplace = parent.window.Drupal.overlay.getDisplacement('top');
+    if (dialog.offset().top < overlayDisplace) {
+      dialog.css('top', overlayDisplace);
+    }
+  }
+}
+
+/**
+ * Size the dialog when it is first loaded and keep it centered when scrolling.
+ *
+ * @param jQuery dialogElement
+ *  The element which has .dialog() attached to it.
+ */
+Drupal.media.popups.sizeDialog = function (dialogElement) {
+  var windowWidth = $(window).width();
+  var dialogWidth = windowWidth * 0.8;
+  var windowHeight = $(window).height();
+  var dialogHeight = windowHeight * 0.8;
+
+  dialogElement.dialog("option", "width", dialogWidth);
+  dialogElement.dialog("option", "height", dialogHeight);
+  dialogElement.dialog("option", "position", 'center');
+
+  $('.media-modal-frame').width('100%');
+}
+
+/**
+ * Resize the dialog when the window changes.
+ *
+ * @param jQuery dialogElement
+ *  The element which has .dialog() attached to it.
+ */
+Drupal.media.popups.resizeDialog = function (dialogElement) {
+  $(window).resize(function() {
+    Drupal.media.popups.sizeDialog(dialogElement);
+  });
+}
+
+/**
+ * Keeps the dialog centered when the window is scrolled.
+ *
+ * @param jQuery dialogElement
+ *  The element which has .dialog() attached to it.
+ */
+Drupal.media.popups.scrollDialog = function (dialogElement) {
+  // Keep the dialog window centered when scrolling.
+  $(window).scroll(function() {
+    dialogElement.dialog("option", "position", 'center');
+  });
+}
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/js/plugins/media.views.js b/profiles/commons/modules/contrib/media/js/plugins/media.views.js
new file mode 100644
index 0000000..b5024b3
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/plugins/media.views.js
@@ -0,0 +1,143 @@
+/**
+ * @file
+ * Handles the JS for the views file browser.
+ *
+ * Note that this does not currently support multiple file selection
+ */
+
+(function ($) {
+
+namespace('Drupal.media.browser.views');
+Drupal.behaviors.mediaViews = {
+  attach: function (context, settings) {
+
+    // Make sure when pressing enter on text inputs, the form isn't submitted
+    $('.ctools-auto-submit-full-form .views-exposed-form input:text, input:text.ctools-auto-submit', context)
+      .filter(':not(.ctools-auto-submit-exclude)')
+      .bind('keydown keyup', function (e) {
+        if(e.keyCode === 13) {
+          e.stopImmediatePropagation();
+          e.preventDefault();
+        }
+      });
+    // Disable the links on media items list
+    $('.view-content ul.media-list-thumbnails a').click(function() {
+      return false;
+    });
+
+    // We loop through the views listed in Drupal.settings.media.browser.views
+    // and set them up individually.
+    var views_ids = [];
+    for(var key in Drupal.settings.media.browser.views){
+      views_ids.push(key);
+    }
+
+    for (var i = 0; i < views_ids.length; i++) {
+      var views_id = views_ids[i];
+      for (var j= 0; j < Drupal.settings.media.browser.views[views_id].length; j++) {
+        var views_display_id = Drupal.settings.media.browser.views[views_id][j],
+          view = $('.view-id-' + views_id + '.view-display-id-' + views_display_id);
+        if (view.length) {
+          Drupal.media.browser.views.setup(view);
+        }
+      }
+    }
+
+    // Reset the state on tab-changes- bind on the 'select' event on the tabset
+    $('#media-browser-tabset').bind('tabsselect', function(event, ui) {
+      var view = $('.view', ui.panel);
+      if (view.length) {
+        Drupal.media.browser.views.select(view);
+      }
+    });
+
+  }
+}
+
+/**
+ * Event-function that is called with a view, when the tab containing that
+ * view is selected.
+ */
+Drupal.media.browser.views.select = function(view) {
+  // Reset the list of selected files
+  Drupal.media.browser.selectMedia([]);
+
+  // Reset all 'selected'-status.
+  $('.view-content .media-item', view).removeClass('selected');
+}
+
+/**
+ * Setup function. Called once for every Media Browser view.
+ *
+ * Sets up event-handlers for selecting items in the view.
+ */
+Drupal.media.browser.views.setup = function(view) {
+  // Ensure we only setup each view once..
+  if ($(view).hasClass('media-browser-views-processed')) {
+    return;
+  }
+
+  // Reset the list of selected files
+  Drupal.media.browser.selectMedia([]);
+
+  // Catch the click on a media item
+  $('.view-content .media-item', view).bind('click', function () {
+    var fid = $(this).closest('.media-item[data-fid]').data('fid'),
+      selectedFiles = new Array();
+
+    // Remove all currently selected files
+    $('.view-content .media-item', view).removeClass('selected');
+
+    // Mark it as selected
+    $(this).addClass('selected');
+
+    // Multiselect!
+    if (Drupal.settings.media.browser.params.multiselect) {
+      // Loop through the already selected files
+      for (index in Drupal.media.browser.selectedMedia) {
+        var currentFid = Drupal.media.browser.selectedMedia[index].fid;
+
+        // If the current file exists in the list of already selected
+        // files, we deselect instead of selecting
+        if (currentFid == fid) {
+          $(this).removeClass('selected');
+          // If we change the fid, the later matching won't
+          // add it back again because it can't find it.
+          fid = NaN;
+
+          // The previously selected file wasn't clicked, so we retain it
+          // as an active file
+        }
+        else {
+          // Add to list of already selected files
+          selectedFiles.push(Drupal.media.browser.selectedMedia[index]);
+
+          // Mark it as selected
+          $('.view-content *[data-fid=' + currentFid + '].media-item', view).addClass('selected');
+        }
+      }
+    }
+
+    // Because the files are added using drupal_add_js() and due to the fact
+    // that drupal_get_js() runs a drupal_array_merge_deep() which re-numbers
+    // numeric key values, we have to search in Drupal.settings.media.files
+    // for the matching file ID rather than referencing it directly.
+    for (index in Drupal.settings.media.files) {
+      if (Drupal.settings.media.files[index].fid == fid) {
+        selectedFiles.push(Drupal.settings.media.files[index]);
+
+        // If multiple tabs contains the same file, it will be present in the
+        // files-array multiple times, so we break out early so we don't have
+        // it in the selectedFiles array multiple times.
+        // This would interfer with multi-selection, so...
+        break;
+      }
+    }
+    Drupal.media.browser.selectMedia(selectedFiles);
+  });
+
+  // Add the processed class, so we dont accidentally process the same element twice..
+  $(view).addClass('media-browser-views-processed');
+}
+
+}(jQuery));
diff --git a/profiles/commons/modules/contrib/media/js/util/ba-debug.min.js b/profiles/commons/modules/contrib/media/js/util/ba-debug.min.js
new file mode 100644
index 0000000..1c50e7f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/util/ba-debug.min.js
@@ -0,0 +1,12 @@
+/*
+ * debug - v0.3 - 6/8/2009
+ * http://benalman.com/projects/javascript-debug-console-log/
+ *
+ * Copyright (c) 2009 "Cowboy" Ben Alman
+ * Licensed under the MIT license
+ * http://benalman.com/about/license/
+ *
+ * With lots of help from Paul Irish!
+ * http://paulirish.com/
+ */
+window.debug=(function(){var c=this,e=Array.prototype.slice,b=c.console,i={},f,g,j=9,d=["error","warn","info","debug","log"],m="assert clear count dir dirxml group groupEnd profile profileEnd time timeEnd trace".split(" "),k=m.length,a=[];while(--k>=0){(function(n){i[n]=function(){j!==0&&b&&b[n]&&b[n].apply(b,arguments)}})(m[k])}k=d.length;while(--k>=0){(function(n,o){i[o]=function(){var q=e.call(arguments),p=[o].concat(q);a.push(p);h(p);if(!b||!l(n)){return}b.firebug?b[o].apply(c,q):b[o]?b[o](q):b.log(q)}})(k,d[k])}function h(n){if(f&&(g||!b||!b.log)){f.apply(c,n)}}i.setLevel=function(n){j=typeof n==="number"?n:9};function l(n){return j>0?j>n:d.length+j<=n}i.setCallback=function(){var o=e.call(arguments),n=a.length,p=n;f=o.shift()||null;g=typeof o[0]==="boolean"?o.shift():false;p-=typeof o[0]==="number"?o.shift():n;while(p<n){h(a[p++])}};return i})();
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/media/js/util/json2.js b/profiles/commons/modules/contrib/media/js/util/json2.js
new file mode 100644
index 0000000..39d8f37
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/js/util/json2.js
@@ -0,0 +1,481 @@
+/*
+    http://www.JSON.org/json2.js
+    2009-09-29
+
+    Public Domain.
+
+    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.
+
+    See http://www.JSON.org/js.html
+
+
+    This code should be minified before deployment.
+    See http://javascript.crockford.com/jsmin.html
+
+    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO
+    NOT CONTROL.
+
+
+    This file creates a global JSON object containing two methods: stringify
+    and parse.
+
+        JSON.stringify(value, replacer, space)
+            value       any JavaScript value, usually an object or array.
+
+            replacer    an optional parameter that determines how object
+                        values are stringified for objects. It can be a
+                        function or an array of strings.
+
+            space       an optional parameter that specifies the indentation
+                        of nested structures. If it is omitted, the text will
+                        be packed without extra whitespace. If it is a number,
+                        it will specify the number of spaces to indent at each
+                        level. If it is a string (such as '\t' or '&nbsp;'),
+                        it contains the characters used to indent at each level.
+
+            This method produces a JSON text from a JavaScript value.
+
+            When an object value is found, if the object contains a toJSON
+            method, its toJSON method will be called and the result will be
+            stringified. A toJSON method does not serialize: it returns the
+            value represented by the name/value pair that should be serialized,
+            or undefined if nothing should be serialized. The toJSON method
+            will be passed the key associated with the value, and this will be
+            bound to the value
+
+            For example, this would serialize Dates as ISO strings.
+
+                Date.prototype.toJSON = function (key) {
+                    function f(n) {
+                        // Format integers to have at least two digits.
+                        return n < 10 ? '0' + n : n;
+                    }
+
+                    return this.getUTCFullYear()   + '-' +
+                         f(this.getUTCMonth() + 1) + '-' +
+                         f(this.getUTCDate())      + 'T' +
+                         f(this.getUTCHours())     + ':' +
+                         f(this.getUTCMinutes())   + ':' +
+                         f(this.getUTCSeconds())   + 'Z';
+                };
+
+            You can provide an optional replacer method. It will be passed the
+            key and value of each member, with this bound to the containing
+            object. The value that is returned from your method will be
+            serialized. If your method returns undefined, then the member will
+            be excluded from the serialization.
+
+            If the replacer parameter is an array of strings, then it will be
+            used to select the members to be serialized. It filters the results
+            such that only members with keys listed in the replacer array are
+            stringified.
+
+            Values that do not have JSON representations, such as undefined or
+            functions, will not be serialized. Such values in objects will be
+            dropped; in arrays they will be replaced with null. You can use
+            a replacer function to replace those with JSON values.
+            JSON.stringify(undefined) returns undefined.
+
+            The optional space parameter produces a stringification of the
+            value that is filled with line breaks and indentation to make it
+            easier to read.
+
+            If the space parameter is a non-empty string, then that string will
+            be used for indentation. If the space parameter is a number, then
+            the indentation will be that many spaces.
+
+            Example:
+
+            text = JSON.stringify(['e', {pluribus: 'unum'}]);
+            // text is '["e",{"pluribus":"unum"}]'
+
+
+            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');
+            // text is '[\n\t"e",\n\t{\n\t\t"pluribus": "unum"\n\t}\n]'
+
+            text = JSON.stringify([new Date()], function (key, value) {
+                return this[key] instanceof Date ?
+                    'Date(' + this[key] + ')' : value;
+            });
+            // text is '["Date(---current time---)"]'
+
+
+        JSON.parse(text, reviver)
+            This method parses a JSON text to produce an object or array.
+            It can throw a SyntaxError exception.
+
+            The optional reviver parameter is a function that can filter and
+            transform the results. It receives each of the keys and values,
+            and its return value is used instead of the original value.
+            If it returns what it received, then the structure is not modified.
+            If it returns undefined then the member is deleted.
+
+            Example:
+
+            // Parse the text. Values that look like ISO date strings will
+            // be converted to Date objects.
+
+            myData = JSON.parse(text, function (key, value) {
+                var a;
+                if (typeof value === 'string') {
+                    a =
+/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
+                    if (a) {
+                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],
+                            +a[5], +a[6]));
+                    }
+                }
+                return value;
+            });
+
+            myData = JSON.parse('["Date(09/09/2001)"]', function (key, value) {
+                var d;
+                if (typeof value === 'string' &&
+                        value.slice(0, 5) === 'Date(' &&
+                        value.slice(-1) === ')') {
+                    d = new Date(value.slice(5, -1));
+                    if (d) {
+                        return d;
+                    }
+                }
+                return value;
+            });
+
+
+    This is a reference implementation. You are free to copy, modify, or
+    redistribute.
+*/
+
+/*jslint evil: true, strict: false */
+
+/*members "", "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
+    call, charCodeAt, getUTCDate, getUTCFullYear, getUTCHours,
+    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join,
+    lastIndex, length, parse, prototype, push, replace, slice, stringify,
+    test, toJSON, toString, valueOf
+*/
+
+
+// Create a JSON object only if one does not already exist. We create the
+// methods in a closure to avoid creating global variables.
+
+if (!this.JSON) {
+    this.JSON = {};
+}
+
+(function () {
+
+    function f(n) {
+        // Format integers to have at least two digits.
+        return n < 10 ? '0' + n : n;
+    }
+
+    if (typeof Date.prototype.toJSON !== 'function') {
+
+        Date.prototype.toJSON = function (key) {
+
+            return isFinite(this.valueOf()) ?
+                   this.getUTCFullYear()   + '-' +
+                 f(this.getUTCMonth() + 1) + '-' +
+                 f(this.getUTCDate())      + 'T' +
+                 f(this.getUTCHours())     + ':' +
+                 f(this.getUTCMinutes())   + ':' +
+                 f(this.getUTCSeconds())   + 'Z' : null;
+        };
+
+        String.prototype.toJSON =
+        Number.prototype.toJSON =
+        Boolean.prototype.toJSON = function (key) {
+            return this.valueOf();
+        };
+    }
+
+    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
+        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
+        gap,
+        indent,
+        meta = {    // table of character substitutions
+            '\b': '\\b',
+            '\t': '\\t',
+            '\n': '\\n',
+            '\f': '\\f',
+            '\r': '\\r',
+            '"' : '\\"',
+            '\\': '\\\\'
+        },
+        rep;
+
+
+    function quote(string) {
+
+// If the string contains no control characters, no quote characters, and no
+// backslash characters, then we can safely slap some quotes around it.
+// Otherwise we must also replace the offending characters with safe escape
+// sequences.
+
+        escapable.lastIndex = 0;
+        return escapable.test(string) ?
+            '"' + string.replace(escapable, function (a) {
+                var c = meta[a];
+                return typeof c === 'string' ? c :
+                    '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
+            }) + '"' :
+            '"' + string + '"';
+    }
+
+
+    function str(key, holder) {
+
+// Produce a string from holder[key].
+
+        var i,          // The loop counter.
+            k,          // The member key.
+            v,          // The member value.
+            length,
+            mind = gap,
+            partial,
+            value = holder[key];
+
+// If the value has a toJSON method, call it to obtain a replacement value.
+
+        if (value && typeof value === 'object' &&
+                typeof value.toJSON === 'function') {
+            value = value.toJSON(key);
+        }
+
+// If we were called with a replacer function, then call the replacer to
+// obtain a replacement value.
+
+        if (typeof rep === 'function') {
+            value = rep.call(holder, key, value);
+        }
+
+// What happens next depends on the value's type.
+
+        switch (typeof value) {
+        case 'string':
+            return quote(value);
+
+        case 'number':
+
+// JSON numbers must be finite. Encode non-finite numbers as null.
+
+            return isFinite(value) ? String(value) : 'null';
+
+        case 'boolean':
+        case 'null':
+
+// If the value is a boolean or null, convert it to a string. Note:
+// typeof null does not produce 'null'. The case is included here in
+// the remote chance that this gets fixed someday.
+
+            return String(value);
+
+// If the type is 'object', we might be dealing with an object or an array or
+// null.
+
+        case 'object':
+
+// Due to a specification blunder in ECMAScript, typeof null is 'object',
+// so watch out for that case.
+
+            if (!value) {
+                return 'null';
+            }
+
+// Make an array to hold the partial results of stringifying this object value.
+
+            gap += indent;
+            partial = [];
+
+// Is the value an array?
+
+            if (Object.prototype.toString.apply(value) === '[object Array]') {
+
+// The value is an array. Stringify every element. Use null as a placeholder
+// for non-JSON values.
+
+                length = value.length;
+                for (i = 0; i < length; i += 1) {
+                    partial[i] = str(i, value) || 'null';
+                }
+
+// Join all of the elements together, separated with commas, and wrap them in
+// brackets.
+
+                v = partial.length === 0 ? '[]' :
+                    gap ? '[\n' + gap +
+                            partial.join(',\n' + gap) + '\n' +
+                                mind + ']' :
+                          '[' + partial.join(',') + ']';
+                gap = mind;
+                return v;
+            }
+
+// If the replacer is an array, use it to select the members to be stringified.
+
+            if (rep && typeof rep === 'object') {
+                length = rep.length;
+                for (i = 0; i < length; i += 1) {
+                    k = rep[i];
+                    if (typeof k === 'string') {
+                        v = str(k, value);
+                        if (v) {
+                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
+                        }
+                    }
+                }
+            } else {
+
+// Otherwise, iterate through all of the keys in the object.
+
+                for (k in value) {
+                    if (Object.hasOwnProperty.call(value, k)) {
+                        v = str(k, value);
+                        if (v) {
+                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
+                        }
+                    }
+                }
+            }
+
+// Join all of the member texts together, separated with commas,
+// and wrap them in braces.
+
+            v = partial.length === 0 ? '{}' :
+                gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' +
+                        mind + '}' : '{' + partial.join(',') + '}';
+            gap = mind;
+            return v;
+        }
+    }
+
+// If the JSON object does not yet have a stringify method, give it one.
+
+    if (typeof JSON.stringify !== 'function') {
+        JSON.stringify = function (value, replacer, space) {
+
+// The stringify method takes a value and an optional replacer, and an optional
+// space parameter, and returns a JSON text. The replacer can be a function
+// that can replace values, or an array of strings that will select the keys.
+// A default replacer method can be provided. Use of the space parameter can
+// produce text that is more easily readable.
+
+            var i;
+            gap = '';
+            indent = '';
+
+// If the space parameter is a number, make an indent string containing that
+// many spaces.
+
+            if (typeof space === 'number') {
+                for (i = 0; i < space; i += 1) {
+                    indent += ' ';
+                }
+
+// If the space parameter is a string, it will be used as the indent string.
+
+            } else if (typeof space === 'string') {
+                indent = space;
+            }
+
+// If there is a replacer, it must be a function or an array.
+// Otherwise, throw an error.
+
+            rep = replacer;
+            if (replacer && typeof replacer !== 'function' &&
+                    (typeof replacer !== 'object' ||
+                     typeof replacer.length !== 'number')) {
+                throw new Error('JSON.stringify');
+            }
+
+// Make a fake root object containing our value under the key of ''.
+// Return the result of stringifying the value.
+
+            return str('', {'': value});
+        };
+    }
+
+
+// If the JSON object does not yet have a parse method, give it one.
+
+    if (typeof JSON.parse !== 'function') {
+        JSON.parse = function (text, reviver) {
+
+// The parse method takes a text and an optional reviver function, and returns
+// a JavaScript value if the text is a valid JSON text.
+
+            var j;
+
+            function walk(holder, key) {
+
+// The walk method is used to recursively walk the resulting structure so
+// that modifications can be made.
+
+                var k, v, value = holder[key];
+                if (value && typeof value === 'object') {
+                    for (k in value) {
+                        if (Object.hasOwnProperty.call(value, k)) {
+                            v = walk(value, k);
+                            if (v !== undefined) {
+                                value[k] = v;
+                            } else {
+                                delete value[k];
+                            }
+                        }
+                    }
+                }
+                return reviver.call(holder, key, value);
+            }
+
+
+// Parsing happens in four stages. In the first stage, we replace certain
+// Unicode characters with escape sequences. JavaScript handles many characters
+// incorrectly, either silently deleting them, or treating them as line endings.
+
+            cx.lastIndex = 0;
+            if (cx.test(text)) {
+                text = text.replace(cx, function (a) {
+                    return '\\u' +
+                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
+                });
+            }
+
+// In the second stage, we run the text against regular expressions that look
+// for non-JSON patterns. We are especially concerned with '()' and 'new'
+// because they can cause invocation, and '=' because it can cause mutation.
+// But just to be safe, we want to reject all unexpected forms.
+
+// We split the second stage into 4 regexp operations in order to work around
+// crippling inefficiencies in IE's and Safari's regexp engines. First we
+// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we
+// replace all simple value tokens with ']' characters. Third, we delete all
+// open brackets that follow a colon or comma or that begin the text. Finally,
+// we look to see that the remaining characters are only whitespace or ']' or
+// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.
+
+            if (/^[\],:{}\s]*$/.
+test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').
+replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').
+replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {
+
+// In the third stage we use the eval function to compile the text into a
+// JavaScript structure. The '{' operator is subject to a syntactic ambiguity
+// in JavaScript: it can begin a block or an object literal. We wrap the text
+// in parens to eliminate the ambiguity.
+
+                j = eval('(' + text + ')');
+
+// In the optional fourth stage, we recursively walk the new structure, passing
+// each name/value pair to a reviver function for possible transformation.
+
+                return typeof reviver === 'function' ?
+                    walk({'': j}, '') : j;
+            }
+
+// If the text is not JSON parseable, then a SyntaxError is thrown.
+
+            throw new SyntaxError('JSON.parse');
+        };
+    }
+}());
diff --git a/profiles/commons/modules/contrib/media/media-views-view-media-browser.tpl.php b/profiles/commons/modules/contrib/media/media-views-view-media-browser.tpl.php
new file mode 100644
index 0000000..b37f0cf
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media-views-view-media-browser.tpl.php
@@ -0,0 +1,23 @@
+<?php
+/**
+ * @file media-views-view-media-browser.tpl.php
+ * View template to display a grid of media previews in the media browser.
+ *
+ * @see views-view-list.tpl.php
+ * @see template_preprocess_media_views_view_media_browser()
+ * @ingroup views_templates
+ */
+?>
+
+<?php print $wrapper_prefix; ?>
+  <div class="clearfix">
+    <?php print $list_type_prefix; ?>
+      <?php foreach ($rows as $id => $row): ?>
+        <li id="media-item-<?php print $row->fid; ?>" class="<?php print $classes_array[$id]; ?>">
+          <?php print $row->preview; ?>
+        </li>
+      <?php endforeach; ?>
+    <?php print $list_type_suffix; ?>
+    <div id="status"></div>
+  </div>
+<?php print $wrapper_suffix; ?>
diff --git a/profiles/commons/modules/contrib/media/media.api.php b/profiles/commons/modules/contrib/media/media.api.php
new file mode 100644
index 0000000..4ff1c4f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.api.php
@@ -0,0 +1,104 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by the Media module.
+ */
+
+/**
+ * Parses a url or embedded code into a unique URI.
+ *
+ * @param string $url
+ *   The original URL or embed code to parse.
+ *
+ * @return array
+ *   The unique URI for the file, based on its stream wrapper, or NULL.
+ *
+ * @see media_parse_to_file()
+ * @see media_add_from_url_validate()
+ */
+function hook_media_parse($url) {
+  // Only parse URLs from our website of choice: examplevideo.com
+  if (substr($url, 0, 27) == 'http://www.examplevideo.com') {
+    // Each video has a 5 digit ID, i.e. http://www.examplevideo.com/12345
+    // Grab the ID and use it in our URI.
+    $id = substr($url, 28, 33);
+    return file_stream_wrapper_uri_normalize('examplevideo://video/' . $id);
+  }
+}
+
+/**
+ * Returns a list of plugins for the media browser.
+ *
+ * @return array
+ *   A nested array of plugin information, keyed by plugin name. Each plugin
+ *   info array may have the following keys:
+ *   - title: (required) A name for the tab in the media browser.
+ *   - class: (required) The class name of the handler. This class must
+ *     implement a view() method, and may (should) extend the
+ *     @link MediaBrowserPlugin MediaBrowserPlugin @endlink class.
+ *   - weight: (optional) Integer to determine the tab order. Defaults to 0.
+ *   - access callback: (optional) A callback for user access checks.
+ *   - access arguments: (optional) An array of arguments for the user access
+ *   check.
+ *
+ * Additional custom keys may be provided for use by the handler.
+ *
+ * @see hook_media_browser_plugin_info_alter()
+ * @see media_get_browser_plugin_info()
+ */
+function hook_media_browser_plugin_info() {
+  $info['media_upload'] = array(
+    'title' => t('Upload'),
+    'class' => 'MediaBrowserUpload',
+    'weight' => -10,
+    'access callback' => 'user_access',
+    'access arguments' => array('create files'),
+  );
+
+  return $info;
+}
+
+/**
+ * Alter the list of plugins for the media browser.
+ *
+ * @param array $info
+ *   The associative array of media browser plugin definitions from
+ *   hook_media_browser_plugin_info().
+ *
+ * @see hook_media_browser_plugin_info()
+ * @see media_get_browser_plugin_info()
+ */
+function hook_media_browser_plugin_info_alter(&$info) {
+  $info['media_upload']['title'] = t('Upload 2.0');
+  $info['media_upload']['class'] = 'MediaBrowserUploadImproved';
+}
+
+/**
+ * Alter the plugins before they are rendered.
+ *
+ * @param array $plugin_output
+ *   The associative array of media browser plugin information from
+ *   media_get_browser_plugin_info().
+ *
+ * @see hook_media_browser_plugin_info()
+ * @see media_get_browser_plugin_info()
+ */
+function hook_media_browser_plugins_alter(&$plugin_output) {
+  $plugin_output['upload']['form']['upload']['#title'] = t('Upload 2.0');
+  $plugin_output['media_internet']['form']['embed_code']['#size'] = 100;
+}
+
+/**
+ * Alter a singleton of the params passed to the media browser.
+ *
+ * @param array $stored_params
+ *   An array of parameters provided when a media_browser is launched.
+ *
+ * @see media_browser()
+ * @see media_set_browser_params()
+ */
+function hook_media_browser_params_alter(&$stored_params) {
+  $stored_params['types'][] = 'document';
+  unset($stored_params['enabledPlugins'][0]);
+}
diff --git a/profiles/commons/modules/contrib/media/media.info b/profiles/commons/modules/contrib/media/media.info
new file mode 100644
index 0000000..bdf2067
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.info
@@ -0,0 +1,33 @@
+name = Media
+description = Provides the core Media API
+package = Media
+core = 7.x
+
+dependencies[] = file_entity
+dependencies[] = image
+dependencies[] = views
+
+test_dependencies[] = token
+
+files[] = includes/MediaReadOnlyStreamWrapper.inc
+files[] = includes/MediaBrowserPluginInterface.inc
+files[] = includes/MediaBrowserPlugin.inc
+files[] = includes/MediaBrowserUpload.inc
+files[] = includes/MediaBrowserView.inc
+files[] = includes/MediaEntityTranslationHandler.inc
+files[] = includes/media_views_plugin_display_media_browser.inc
+files[] = includes/media_views_plugin_style_media_browser.inc
+files[] = media.test
+
+configure = admin/config/media/browser
+
+; We have to add a fake version so Git checkouts do not fail Media dependencies
+version = 7.x-2.x-dev
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/media.install b/profiles/commons/modules/contrib/media/media.install
new file mode 100644
index 0000000..c9f9762
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.install
@@ -0,0 +1,1164 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media module.
+ */
+
+/**
+ * Implements hook_install().
+ */
+function media_install() {
+  // Create initial display settings.
+  module_load_include('inc', 'file_entity', 'file_entity.file_api');
+  $default_image_styles = array(
+    'preview' => 'media_thumbnail',
+    'teaser' => 'medium',
+    'full' => 'large',
+  );
+  // Only needed by sites that updated from Media 1.x.
+  // @see media_entity_info_alter()
+  if (variable_get('media_show_deprecated_view_modes')) {
+    $default_image_styles['media_original'] = '';
+  }
+
+  foreach ($default_image_styles as $view_mode => $image_style) {
+    $existing_display = file_displays_load('image', $view_mode);
+
+    if (empty($existing_display)) {
+      $display_name = 'image__' . $view_mode . '__file_image';
+      $display = array(
+        'api_version' => 1,
+        'name' => $display_name,
+        'status' => 1,
+        'weight' => 5,
+        'settings' => array('image_style' => $image_style),
+        'export_type' => NULL,
+      );
+      file_display_save((object) $display);
+    }
+  }
+
+  // Make sure that we set the icon base directory variable if it is not
+  // already set.
+  $base = variable_get('media_icon_base_directory', NULL);
+  if (!isset($base)) {
+    $default_base = 'public://media-icons';
+    variable_set('media_icon_base_directory', $default_base);
+  }
+  try {
+    _media_install_copy_icons();
+  }
+  catch (Exception $e) {
+    watchdog_exception('media', $e);
+  }
+}
+
+/**
+ * Copy the media file icons to files directory for use with image styles.
+ */
+function _media_install_copy_icons() {
+  $destination = variable_get('media_icon_base_directory', 'public://media-icons') . '/' . variable_get('media_icon_set', 'default');
+  if (!file_prepare_directory($destination, FILE_CREATE_DIRECTORY)) {
+    throw new Exception("Unable to create directory $destination.");
+  }
+  // @todo If we ever add another default icon set, this should copy all images from one directory up.
+  $source = drupal_get_path('module', 'media') . '/images/icons/' . variable_get('media_icon_set', 'default');
+  $files = file_scan_directory($source, '/.*\.(png|jpg)$/');
+  foreach ($files as $file) {
+    $result = file_unmanaged_copy($file->uri, $destination, FILE_EXISTS_REPLACE);
+    if (!$result) {
+      throw new Exception("Unable to copy {$file->uri} to $destination.");
+    }
+  }
+}
+
+/**
+ * Implements hook_uninstall().
+ */
+function media_uninstall() {
+  // Remove variables.
+  variable_del('media_icon_base_directory');
+  variable_del('media_icon_set');
+  variable_del('media_show_deprecated_view_modes');
+}
+
+/**
+ * Implements hook_update_dependencies().
+ */
+function media_update_dependencies() {
+  // media_update_7200() needs to convert old 'media' permissions to new 'file'
+  // permissions, so it must run before file_entity_7208 which updates existing
+  // 'file' permissions to be split per file type.
+  $dependencies['file_entity'][7208] = array(
+    'media' => 7200,
+  );
+  // This update function requires field_update_7002() to run before it since
+  // the field_bundle_settings variable has been split into separate variables
+  // per entity type and bundle.
+  $dependencies['media'][7016] = array(
+    'field' => 7002,
+    'rules' => 7205,
+  );
+  // Those updates require {file_type} table created.
+  $dependencies['media'][7204] = array(
+    'file_entity' => 7201,
+  );
+  // Require {file_type}.mimetypes column before updating them.
+  $dependencies['media'][7208] = array(
+    'file_entity' => 7210,
+  );
+  $dependencies['media'][7212] = array(
+    'file_entity' => 7210,
+  );
+  return $dependencies;
+}
+
+/**
+ * Implements hook_requirements().
+ */
+function media_requirements($phase) {
+  $t = get_t();
+  // Make sure that file_entity module is 2.x version.
+  // We can't add this check in .info file because drupal.org testbot cant
+  // handle it. See #1734648.
+  $requirements = array();
+
+  if ($phase == 'update') {
+    $info = system_get_info('module', 'file_entity');
+    if (strpos($info['version'], '7.x-2') === FALSE) {
+      $requirements['file_entity'] = array(
+        'title' => $t('File entity 2.x'),
+        'value' => $t('Wrong version'),
+        'severity' => REQUIREMENT_ERROR,
+        'description' => $t('Media 2.x requires <a href="@url">File entity 2.x</a>. Please download the correct version and make sure you have deleted the file_entity folder inside the media module directory.', array('@url' => 'http://drupal.org/project/file_entity')),
+      );
+    }
+  }
+
+  return $requirements;
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7000() {
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7001() {
+}
+
+/**
+ * Create the media_type table from the media_types variable.
+ */
+function media_update_7002() {
+  $schema['media_type'] = array(
+    'description' => 'Stores the settings for media types.',
+    'fields' => array(
+      'name' => array(
+        'description' => 'The machine name of the media type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+      'label' => array(
+        'description' => 'The label of the media type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'default' => '',
+      ),
+      'base' => array(
+        'description' => 'If this is a base type (i.e. cannot be deleted)',
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'size' => 'tiny',
+      ),
+      'weight' => array(
+        'description' => 'Weight of media type. Determines which one wins when claiming a piece of media (first wins)',
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'size' => 'normal',
+      ),
+      'type_callback' => array(
+        'description' => 'Callback to determine if provided media is of this type.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => FALSE,
+        'default' => '',
+      ),
+      'type_callback_args' => array(
+        'type' => 'text',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+        'description' => 'A serialized array of name value pairs that will be passed to the callback function',
+      ),
+    ),
+    'primary key' => array('name'),
+  );
+  db_create_table('media_type', $schema['media_type']);
+
+  drupal_load('module', 'media');
+  $old_types = variable_get('media_types');
+  foreach ($old_types as $type) {
+    // Was an error in the original creation.
+    if (isset($type->callbacks)) {
+      unset($type->callbacks);
+    }
+    $type->name = $type->machine_name;
+    unset($type->machine_name);
+    db_merge('media_type')
+      ->key(array('name' => $type->name))
+      ->fields((array) $type)
+      ->execute();
+  }
+  variable_del('media_types');
+}
+
+/**
+ * We now prefix media namespaced variables with media__, so fix old variables.
+ */
+function media_update_7003() {
+  drupal_load('module', 'media');
+  foreach (media_variable_default() as $variable => $value) {
+    if (($test = variable_get('media_' . $variable, TRUE)) == variable_get('media_' . $variable, FALSE)) {
+      media_variable_set($variable, $test);
+      variable_del('media_' . $variable);
+    }
+  }
+}
+
+/**
+ * Empty update function to trigger a menu rebuild.
+ */
+function media_update_7004() {
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7005() {
+}
+
+/**
+ * Rename the file table to file_managed in case head2head was used.
+ */
+function media_update_7006() {
+  if (db_table_exists('file') && !db_table_exists('file_managed')) {
+    db_rename_table('file', 'file_managed');
+  }
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7007() {
+}
+
+/**
+ * Empty function.
+ */
+function media_update_7008() {
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7009() {
+}
+
+/**
+ * Deprecated update function.
+ */
+function media_update_7010() {
+}
+
+/**
+ * Empty update function.
+ */
+function media_update_7011() {
+}
+
+/**
+ * Empty update function.
+ */
+function media_update_7012() {
+}
+
+/**
+ * Work around a core bug where text format cacheability is not updated.
+ *
+ * @see http://drupal.org/node/993230
+ */
+function media_update_7013() {
+  $formats = filter_formats();
+  foreach ($formats as $format) {
+    $format->filters = filter_list_format($format->format);
+    // filter_format_save() expects filters to be an array, however
+    // filter_list_format() gives us objects.
+    foreach ($format->filters as $key => $value) {
+      $format->filters[$key] = (array) $value;
+    }
+    filter_format_save($format);
+  }
+}
+
+/**
+ * Rename the media__dialog_get_theme_name variable to media__dialog_theme.
+ */
+function media_update_7014() {
+  if ($old_value = variable_get('media__dialog_get_theme_name')) {
+    variable_del('media__dialog_get_theme_name');
+    variable_set('media__dialog_theme', $old_value);
+  }
+}
+
+/**
+ * Empty update function to trigger a registry rebuild.
+ */
+function media_update_7015() {
+}
+
+/**
+ * Convert Media entities to File entities.
+ *
+ * This update function requires field_update_7002() to run before it since
+ * the field_bundle_settings variable has been split into separate variables
+ * per entity type and bundle.
+ *
+ * @see http://drupal.org/node/1418708
+ * @see http://drupal.org/node/1211008
+ */
+function media_update_7016() {
+  // Allow File Entity module to take over the {file_managed}.type field. It
+  // will create new indexes as it needs to, but it doesn't know about old ones,
+  // so delete them.
+  if (db_index_exists('file_managed', 'file_type')) {
+    db_drop_index('file_managed', 'file_type');
+  }
+  module_enable(array('file_entity'));
+
+  // Move all field instances from Media entity to File entity.
+  $instances = field_read_instances(array('entity_type' => 'media'), array('include_inactive' => TRUE, 'include_deleted' => TRUE));
+  foreach ($instances as $instance) {
+    // Skip the old self-referencing file field. It will be deleted later in
+    // this function.
+    if ($instance['field_name'] === 'file') {
+      continue;
+    }
+
+    // @todo Convert this to use _update_7000_field_read_fields()
+    $fields = field_read_fields(array('id' => $instance['field_id']), array('include_inactive' => TRUE, 'include_deleted' => TRUE));
+    $field = $fields[$instance['field_id']];
+
+    // There is no API for updating the entity_type foreign key within field
+    // data storage. We can do a direct db_update() for when the default SQL
+    // storage back-end is being used, but must skip updating fields that use a
+    // different storage type.
+    if ($field['storage']['type'] !== 'field_sql_storage' || !module_exists('field_sql_storage') || !$field['storage']['active']) {
+      $messages[] = t('Cannot update field %id (%field_name) because it does not use the field_sql_storage storage type.', array(
+        '%id' => $field['id'],
+        '%field_name' => $field['field_name'],
+      ));
+      continue;
+    }
+
+    // Update the data tables.
+    $table_name = _field_sql_storage_tablename($field);
+    $revision_name = _field_sql_storage_revision_tablename($field);
+    db_update($table_name)
+      ->fields(array('entity_type' => 'file'))
+      ->condition('entity_type', 'media')
+      ->condition('bundle', $instance['bundle'])
+      ->execute();
+    db_update($revision_name)
+      ->fields(array('entity_type' => 'file'))
+      ->condition('entity_type', 'media')
+      ->condition('bundle', $instance['bundle'])
+      ->execute();
+
+    // Once all the data has been updated, update the {field_config_instance}
+    // record.
+    db_update('field_config_instance')
+      ->fields(array('entity_type' => 'file'))
+      ->condition('id', $instance['id'])
+      ->execute();
+  }
+
+  // Update the field_bundle_settings configuration variable: move media bundle
+  // settings to file bundles, and move settings of the old self-referencing
+  // file field to the new file pseudo-field.
+  foreach ($instances as $instance) {
+    if ($instance['field_name'] === 'file' && !$instance['deleted']) {
+      $file_settings = field_bundle_settings('file', $instance['bundle']);
+      $media_settings = field_bundle_settings('media', $instance['bundle']);
+      $file_settings = array_merge($file_settings, $media_settings);
+      if (isset($instance['widget']['weight'])) {
+        $file_settings['extra_fields']['form']['file']['weight'] = $instance['widget']['weight'];
+      }
+      if (isset($instance['display'])) {
+        foreach ($instance['display'] as $view_mode => $display) {
+          if (isset($display['weight'])) {
+            $file_settings['extra_fields']['display']['file'][$view_mode]['weight'] = $display['weight'];
+          }
+          if (isset($display['type'])) {
+            $file_settings['extra_fields']['display']['file'][$view_mode]['visible'] = ($display['type'] != 'hidden');
+          }
+        }
+      }
+      field_bundle_settings('file', $instance['bundle'], $file_settings);
+    }
+  }
+  // Delete old media bundle settings.
+  db_delete('variable')
+    ->condition('name', db_like('field_bundle_settings_media__') . '%', 'LIKE')
+    ->execute();
+
+  // Copy field formatter settings of old self-referencing file field to file
+  // pseudo-field formatter settings.
+  $file_displays = variable_get('file_displays', array());
+  foreach ($instances as $instance) {
+    if ($instance['field_name'] === 'file' && !$instance['deleted']) {
+      if (isset($instance['display'])) {
+        foreach ($instance['display'] as $view_mode => $display) {
+          if (isset($display['type']) && $display['type'] != 'hidden') {
+            $file_formatter = 'file_field_' . $display['type'];
+            $file_displays[$instance['bundle']][$view_mode][$file_formatter]['status'] = TRUE;
+            if (isset($display['settings'])) {
+              $file_displays[$instance['bundle']][$view_mode][$file_formatter]['settings'] = $display['settings'];
+            }
+          }
+        }
+      }
+    }
+  }
+  variable_set('file_displays', $file_displays);
+
+  // Delete the old self-referencing file field instances. If all instances are
+  // deleted, field_delete_instance() will delete the field too.
+  foreach ($instances as $instance) {
+    if ($instance['field_name'] === 'file' && !$instance['deleted']) {
+      field_delete_instance($instance);
+    }
+  }
+
+  field_cache_clear();
+}
+
+/**
+ * Move file display configuration.
+ *
+ * Move file display configurations from the 'file_displays' variable to the
+ * {file_display} table.
+ */
+function media_update_7017() {
+  // If the {file_display} table doesn't exist, then the File Entity module's
+  // update functions will automatically take care of migrating the
+  // configurations. However, if file_entity_update_7001() has already run
+  // prior to media_update_7016(), run it again in order to capture those
+  // configurations too.
+  if (db_table_exists('file_display') && function_exists('file_entity_update_7001')) {
+    module_load_include('install', 'file_entity', 'file_entity');
+    file_entity_update_7001();
+  }
+}
+
+/**
+ * Empty update function to trigger a menu rebuild.
+ */
+function media_update_7018() {
+}
+
+/**
+ * Update old view mode formaters.
+ *
+ * Update old per-view-mode media field formatters to the generic media
+ * formatter with a setting.
+ */
+function media_update_7019() {
+  $instances = array();
+  $fields = field_read_fields(array('type' => 'media'), array('include_inactive' => TRUE));
+  foreach ($fields as $field) {
+    $instances = array_merge($instances, field_read_instances(array('field_id' => $field['id']), array('include_inactive' => TRUE)));
+  }
+  foreach ($instances as $instance) {
+    $update_instance = FALSE;
+    foreach ($instance['display'] as $view_mode => $display) {
+      if (in_array($display['type'], array('media_link', 'media_preview', 'media_small', 'media_large', 'media_original'))) {
+        $update_instance = TRUE;
+        $instance['display'][$view_mode]['type'] = 'media';
+        $instance['display'][$view_mode]['settings'] = array('file_view_mode' => $display['type']);
+      }
+    }
+    if ($update_instance) {
+      field_update_instance($instance);
+    }
+  }
+}
+
+/**
+ * Delete the wysiwyg_allowed_types variable if it is the same as default.
+ */
+function media_update_7020() {
+  if (variable_get('media__wysiwyg_allowed_types') == array('image', 'video')) {
+    variable_del('media__wysiwyg_allowed_types');
+  }
+}
+
+/**
+ * Replace 'view media' perm from all users having the role with 'view file'.
+ */
+function media_update_7200() {
+  $perms = user_permission_get_modules();
+  if (!isset($perms['view files'])) {
+    throw new DrupalUpdateException('The File Entity module needs to be upgraded before continuing.');
+  }
+  else {
+    $roles = user_roles(FALSE, 'view media');
+    $permissions = array(
+      'view media' => FALSE,
+      'view files' => TRUE,
+    );
+    foreach ($roles as $rid => $role) {
+      user_role_change_permissions($rid, $permissions);
+    }
+    $roles = user_roles(FALSE, 'edit media');
+    $permissions = array(
+      'edit media' => FALSE,
+      'edit any files' => TRUE,
+    );
+    if (function_exists('file_entity_list_permissions')) {
+      unset($permissions['edit any files']);
+
+      foreach (file_entity_permissions_get_configured_types() as $type) {
+        $permissions += file_entity_list_permissions($type);
+      }
+    }
+    foreach ($roles as $rid => $role) {
+      user_role_change_permissions($rid, $permissions);
+    }
+    $roles = user_roles(FALSE, 'administer media');
+    $permissions = array(
+      'administer media' => FALSE,
+      'administer files' => TRUE,
+    );
+    foreach ($roles as $rid => $role) {
+      user_role_change_permissions($rid, $permissions);
+    }
+  }
+}
+
+/**
+ * Handle existing media fields.
+ *
+ * Enable the new Media Field module if this site uses "media" fields. File
+ * fields are now preferred for storing media.
+ */
+function media_update_7201() {
+  $fields = field_info_fields();
+  foreach ($fields as $field) {
+    if ($field['type'] == 'media') {
+      // This update function may run even if Media is not enabled. Don't enable
+      // Media Field if its dependencies aren't already enabled.
+      module_enable(array('mediafield'), FALSE);
+
+      // Update entries in file_usage so that they are associated with Media
+      // Field rather than Media.
+      // @TODO This update function may conflict with
+      // http://drupal.org/node/1268116
+      db_update('file_usage')
+        ->condition('module', 'media')
+        ->fields(array('module' => 'mediafield'))
+        ->execute();
+
+      return t('The "Media" field type has been moved to the new "Media Field" module. This site uses media fields, so the Media Field module has been enabled.');
+    }
+  }
+  return t('The "Media" field type has been moved to the new "Media Field" module. File fields can be used to store media.');
+}
+
+/**
+ * Enable the Views module if it is not already enabled.
+ */
+function media_update_7202() {
+  module_enable(array('views'));
+  if (!module_exists('views')) {
+    throw new DrupalUpdateException('The <a href="https://drupal.org/project/views">Views module</a> must be downloaded and available for Media updates to proceed.');
+  }
+}
+
+/**
+ * Empty update function to trigger cache clear.
+ */
+function media_update_7203() {
+  // Do nothing.
+}
+
+/**
+ * Update old Media view modes to the new File Entity ones.
+ */
+function media_update_7204() {
+  $view_mode_updates = array(
+    'media_preview' => 'preview',
+    'media_small' => 'teaser',
+    'media_large' => 'full',
+  );
+
+  // Update the media__wysiwyg_default_view_mode variable.
+  $wysiwyg_default_view_mode = variable_get('media__wysiwyg_default_view_mode');
+  if (isset($wysiwyg_default_view_mode) && isset($view_mode_updates[$wysiwyg_default_view_mode])) {
+    $wysiwyg_default_view_mode = $view_mode_updates[$wysiwyg_default_view_mode];
+    variable_set('media__wysiwyg_default_view_mode', $wysiwyg_default_view_mode);
+  }
+
+  // Update view mode references in the 'field_bundle_settings' variable.
+  $field_bundle_settings = variable_get('field_bundle_settings');
+  if (!empty($field_bundle_settings['file'])) {
+    foreach ($field_bundle_settings['file'] as $file_type => $info) {
+      // Per-bundle information about the view modes.
+      foreach ($view_mode_updates as $old_view_mode => $new_view_mode) {
+        if (isset($info['view_modes'][$old_view_mode])) {
+          $field_bundle_settings['file'][$file_type]['view_modes'][$new_view_mode] = $info['view_modes'][$old_view_mode];
+          unset($field_bundle_settings['file'][$file_type]['view_modes'][$old_view_mode]);
+        }
+        // The File Entity module defaults to not use custom settings for the
+        // new view modes, but the Media module used to default to using custom
+        // settings, so if this variable is not defined, use the prior default.
+        if (!isset($field_bundle_settings['file'][$file_type]['view_modes'][$new_view_mode]['custom_settings'])) {
+          $field_bundle_settings['file'][$file_type]['view_modes'][$new_view_mode]['custom_settings'] = TRUE;
+        }
+      }
+
+      // Settings for the "extra fields" configured on the Manage Display page.
+      if (!empty($info['extra_fields']['display'])) {
+        foreach ($info['extra_fields']['display'] as $extra_field_name => $extra_field_info) {
+          foreach ($view_mode_updates as $old_view_mode => $new_view_mode) {
+            if (isset($extra_field_info[$old_view_mode])) {
+              $field_bundle_settings['file'][$file_type]['extra_fields']['display'][$extra_field_name][$new_view_mode] = $extra_field_info[$old_view_mode];
+              unset($field_bundle_settings['file'][$file_type]['extra_fields']['display'][$extra_field_name][$old_view_mode]);
+            }
+          }
+        }
+      }
+    }
+  }
+  variable_set('field_bundle_settings', $field_bundle_settings);
+
+  // Move settings for fields attached to files from the old view modes to the
+  // new ones.
+  $instances = field_read_instances(array('entity_type' => 'file'));
+  foreach ($instances as $instance) {
+    $updated = FALSE;
+    foreach ($view_mode_updates as $old_view_mode => $new_view_mode) {
+      if (isset($instance['display'][$old_view_mode])) {
+        $instance['display'][$new_view_mode] = $instance['display'][$old_view_mode];
+        unset($instance['display'][$old_view_mode]);
+        $updated = TRUE;
+      }
+    }
+    if ($updated) {
+      field_update_instance($instance);
+    }
+  }
+
+  // Move "Manage file display" settings from old view modes to new ones.
+  $file_display_names = db_query('SELECT name FROM {file_display}')->fetchCol();
+  foreach ($file_display_names as $old_file_display_name) {
+    list($file_type, $view_mode, $formatter) = explode('__', $old_file_display_name, 3);
+    if (isset($view_mode_updates[$view_mode])) {
+      $view_mode = $view_mode_updates[$view_mode];
+      $new_file_display_name = implode('__', array($file_type, $view_mode, $formatter));
+      db_delete('file_display')->condition('name', $new_file_display_name)->execute();
+      db_update('file_display')->fields(array('name' => $new_file_display_name))->condition('name', $old_file_display_name)->execute();
+    }
+  }
+
+  // Update file/image/media fields that use a formatter that reference an old
+  // file view modes to reference the new ones.
+  foreach (field_read_instances() as $instance) {
+    if (!empty($instance['display'])) {
+      $updated = FALSE;
+      foreach ($instance['display'] as $instance_view_mode => $display) {
+        if (isset($display['settings']['file_view_mode']) && isset($view_mode_updates[$display['settings']['file_view_mode']])) {
+          $instance['display'][$instance_view_mode]['settings']['file_view_mode'] = $view_mode_updates[$display['settings']['file_view_mode']];
+          $updated = TRUE;
+        }
+      }
+      if ($updated) {
+        field_update_instance($instance);
+      }
+    }
+  }
+
+  // Update formatter settings that reference the old view modes within saved
+  // Views.
+  if (db_table_exists('views_display')) {
+    $result = db_select('views_display', 'v')->fields('v', array('vid', 'id', 'display_options'))->execute();
+    foreach ($result as $record) {
+      if (!empty($record->display_options)) {
+        $display_options = unserialize($record->display_options);
+        if (_media_update_7204_update_views_display_options($display_options, $view_mode_updates)) {
+          db_update('views_display')
+            ->fields(array('display_options' => serialize($display_options)))
+            ->condition('vid', $record->vid)
+            ->condition('id', $record->id)
+            ->execute();
+        }
+      }
+    }
+  }
+
+  // Update formatter settings that reference the old view modes within unsaved
+  // Views in the CTools object cache. Objects in the CTools cache are instances
+  // of classes, so the Views module must be enabled to unserialize it
+  // correctly.
+  if (db_table_exists('ctools_object_cache') && module_exists('views')) {
+    $result = db_select('ctools_object_cache', 'c')->fields('c', array('sid', 'name', 'obj', 'data'))->condition('obj', 'view')->execute();
+    foreach ($result as $record) {
+      $view = unserialize($record->data);
+      if (!empty($view->display)) {
+        $updated = FALSE;
+        foreach ($view->display as $display_name => $display) {
+          if (!empty($display->display_options) && _media_update_7204_update_views_display_options($display->display_options, $view_mode_updates)) {
+            $updated = TRUE;
+          }
+        }
+        if ($updated) {
+          db_update('ctools_object_cache')
+            ->fields(array('data' => serialize($view)))
+            ->condition('sid', $record->sid)
+            ->condition('name', $record->name)
+            ->condition('obj', $record->obj)
+            ->execute();
+        }
+      }
+    }
+  }
+
+  // Clear caches that might contain stale Views displays.
+  if (module_exists('views')) {
+    cache_clear_all('*', 'cache_views', TRUE);
+    cache_clear_all('*', 'cache_views_data', TRUE);
+  }
+  if (module_exists('block')) {
+    cache_clear_all('*', 'cache_block', TRUE);
+  }
+  cache_clear_all('*', 'cache_page', TRUE);
+
+  // We still have the old media_link and media_original view modes that must be
+  // supported for now.
+  // @TODO: Make this apply only to updates from Media 1.x.
+  // @see media_entity_info_alter()
+  variable_set('media__show_deprecated_view_modes', TRUE);
+}
+
+/**
+ * Drop the unused {media_list_type} table.
+ */
+function media_update_7205() {
+  if (db_table_exists('media_list_type')) {
+    db_drop_table('media_list_type');
+    return t('Dropped the unused {media_list_type} table.');
+  }
+}
+
+/**
+ * Move default file display configurations to the database.
+ */
+function media_update_7206() {
+  module_load_include('inc', 'file_entity', 'file_entity.file_api');
+  module_load_include('inc', 'ctools', 'includes/export');
+  $default_image_styles = array(
+    'preview' => 'square_thumbnail',
+    'teaser' => 'medium',
+    'full' => 'large',
+  );
+
+  // Only needed by sites that updated from Media 1.x.
+  // @see media_entity_info_alter()
+  if (variable_get('media__show_deprecated_view_modes')) {
+    $default_image_styles['media_original'] = '';
+  }
+
+  // Clear out the ctools cache so that the old default implementations
+  // are removed.
+  ctools_export_load_object_reset('file_display');
+  foreach ($default_image_styles as $view_mode => $image_style) {
+    $existing_displays = file_displays_load('image', $view_mode, TRUE);
+    // Only insert default config into the database if no existing
+    // configuration is found.
+    if (!isset($existing_displays['file_image'])) {
+      $display_name = 'image__' . $view_mode . '__file_image';
+      $display = array(
+        'api_version' => 1,
+        'name' => $display_name,
+        'status' => 1,
+        'weight' => 5,
+        'settings' => array('image_style' => $image_style),
+        'export_type' => NULL,
+      );
+      file_display_save((object) $display);
+    }
+  }
+}
+
+/**
+ * Trigger cache clear.
+ *
+ * Empty update function to trigger cache clear after changing access callbacks
+ * to file_entity_access.
+ */
+function media_update_7207() {
+  // Do nothing.
+}
+
+/**
+ * Drop the media_types table and migrate files to file_entity types.
+ */
+function media_update_7208() {
+  // Reset static cache to ensure our new file types are recognized
+  drupal_static_reset('ctools_export_load_object_table_exists');
+
+  if (!db_table_exists('media_type')) {
+    // No types to migrate.
+    return;
+  }
+  // @see http://drupal.org/node/1292382
+  if (!function_exists('file_type_get_enabled_types')) {
+    throw new DrupalUpdateException('The File Entity module needs to be upgraded before continuing.');
+  }
+  else {
+    $existing_types = db_select('media_type', 'mt')
+      ->orderBy('weight')
+      ->fields('mt')
+      ->execute()
+      // Will key by the name field.
+      ->fetchAllAssoc('name');
+    foreach ($existing_types as &$type) {
+      $type->type_callback_args = unserialize($type->type_callback_args);
+    }
+
+    include_once DRUPAL_ROOT . '/includes/file.mimetypes.inc';
+    $mapping = file_mimetype_mapping();
+    // We do not migrate this type, since there is no way to handle its weight.
+    unset($existing_types['default']);
+    foreach ($existing_types as $type) {
+      $extensions = isset($type->type_callback_args['extensions']) ? $type->type_callback_args['extensions'] : array();
+      $mimetypes = isset($type->type_callback_args['mimetypes']) ? $type->type_callback_args['mimetypes'] : array();
+      // Add mimetypes by extensions.
+      foreach ($extensions as $extension) {
+        if (isset($mapping['extensions'][$extension])) {
+          $type->mimetypes[] = $mapping['mimetypes'][$mapping['extensions'][$extension]];
+        }
+      }
+      // Add rest mimetypes.
+      foreach ($mimetypes as $mimetype) {
+        // Mimetype is a regex pattern.
+        foreach ($mapping['mimetypes'] as $mapping_mimetype) {
+          if (preg_match($mimetype, $mapping_mimetype) && !in_array($mapping_mimetype, $type->mimetypes)) {
+            $type->mimetypes[] = $mapping_mimetype;
+          }
+        }
+      }
+      $type->streams = isset($type->type_callback_args['streams']) ? $type->type_callback_args['streams'] : array();
+      $type->type = $type->name;
+      // Merge existing type with new ones.
+      if ($new_type = file_type_load($type->name)) {
+        $new_type->mimetypes = array_merge($type->mimetypes, $new_type->mimetypes);
+        $new_type->streams = array_merge($type->streams, $new_type->streams);
+      }
+      else {
+        $new_type = $type;
+      }
+      file_type_save($new_type);
+    }
+    db_drop_table('media_type');
+
+    // Special treatment for old media application type to new file_entity
+    // document one. Add some more mimetypes to document.
+    $document_type = file_type_load('document');
+    if (!$document_type) {
+      return;
+    }
+    foreach ($mapping['mimetypes'] as $mimetype) {
+      $is_document = strpos($mimetype, 'document') !== FALSE || strpos($mimetype, 'application/vnd.ms-') !== FALSE;
+      if ($is_document && !in_array($mimetype, $document_type->mimetypes)) {
+        $document_type->mimetypes[] = $mimetype;
+      }
+    }
+    file_type_save($document_type);
+  }
+}
+
+/**
+ * Enable the hidden media_migrate_file_types module to provide a UI to update
+ * {file_managed}.type with the new file types provided by file_entity.
+ */
+function media_update_7209() {
+  drupal_load('module', 'media_migrate_file_types');
+
+  if (_media_migrate_file_types_get_migratable_file_types()) {
+    module_enable('media_migrate_file_types');
+  }
+}
+
+/**
+ * Delete deceprated media__type_icon_directory variable.
+ */
+function media_update_7210() {
+  variable_del('media__type_icon_directory');
+}
+
+/**
+ * Flush old version of the image style to make the thumbnails appear correctly.
+ */
+function media_update_7211() {
+  $style = image_style_load('square_thumbnail');
+
+  if ($style) {
+    $style['name'] = 'media_thumbnail';
+    image_style_save($style);
+  }
+
+  // Replace any instances in display settings
+  module_load_include('inc', 'file_entity', 'file_entity.file_api');
+  $entity_info = entity_get_info('file');
+  $view_modes = array('default' => array('label' => t('Default'))) + $entity_info['view modes'];
+  foreach ($view_modes as $view_mode => $view_mode_info) {
+    $displays = file_displays_load('image', $view_mode);
+    foreach ($displays as $display) {
+      if ($display->settings['image_style'] == 'square_thumbnail') {
+        $display->settings['image_style'] = 'media_thumbnail';
+        file_display_save($display);
+      }
+    }
+  }
+
+  return t('Flushed image style and updated display styles.');
+}
+
+/**
+ * Utility function for update 7204. Updates display options within Views.
+ */
+function _media_update_7204_update_views_display_options(&$display_options, $view_mode_updates) {
+  $updated = FALSE;
+
+  // Update fields that use a formatter with a file_view_mode formatter setting.
+  if (!empty($display_options['fields'])) {
+    foreach ($display_options['fields'] as $field_name => $field_display) {
+      if (isset($field_display['settings']['file_view_mode']) && isset($view_mode_updates[$field_display['settings']['file_view_mode']])) {
+        $display_options['fields'][$field_name]['settings']['file_view_mode'] = $view_mode_updates[$field_display['settings']['file_view_mode']];
+        $updated = TRUE;
+      }
+    }
+  }
+
+  // Update Views that display files directly using a row plugin with a view
+  // mode setting.
+  if (isset($display_options['row_plugin']) && $display_options['row_plugin'] === 'file' && isset($display_options['row_options']['view_mode']) && isset($view_mode_updates[$display_options['row_options']['view_mode']])) {
+    $display_options['row_options']['view_mode'] = $view_mode_updates[$display_options['row_options']['view_mode']];
+    $updated = TRUE;
+  }
+  return $updated;
+}
+
+/**
+ * Re-create application file type for legacy reasons.
+ */
+function media_update_7212() {
+  module_load_include('inc', 'file_entity', 'file_entity.file_api');
+  if (!file_type_load('application')) {
+    $application = (object) array(
+      'api_version' => 1,
+      'type' => 'application',
+      'label' => t('Application'),
+      'description' => t('Multipurpose type - kept to support older sites.'),
+      'mimetypes' => array(),
+      'streams' => array(
+        'public',
+      ),
+    );
+
+    file_type_save($application);
+    $application = file_type_load('application');
+    file_type_disable($application);
+  }
+}
+
+/**
+ * Remove the obsolete file_extensions variable.
+ */
+function media_update_7213() {
+  $media_file_extensions = explode(' ', variable_get('media__file_extensions'));
+  $file_entity_file_extensions = explode(' ', variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'));
+
+  // Preserve any custom file extensions.
+  if (array_diff($media_file_extensions, $file_entity_file_extensions)) {
+    $combined_file_extensions = array_unique(array_merge($file_entity_file_extensions, $media_file_extensions));
+    variable_set('file_entity_default_allowed_extensions', implode(' ' , $combined_file_extensions));
+  }
+
+  variable_del('media__file_extensions');
+}
+
+/**
+ * Drop the legacy {media_filter_usage} table.
+ */
+function media_update_7214() {
+  if (db_table_exists('media_filter_usage')) {
+    db_drop_table('media_filter_usage');
+  }
+}
+
+/**
+ * Skipped to run media_update_7217().
+ */
+function media_update_7216() {
+  // Do nothing.
+}
+
+/**
+ * Copy file type icons to public files directory.
+ */
+function media_update_7217() {
+  // Remove any trailing slashes from the icon base directory variable.
+  $dir = variable_get('media__icon_base_directory');
+  if (!empty($dir)) {
+    $dir = rtrim($dir, '/');
+    variable_set('media__icon_base_directory', $dir);
+  }
+
+  try {
+    _media_install_copy_icons();
+  }
+  catch (Exception $e) {
+    throw new DrupalUpdateException($e->getMessage());
+  }
+}
+
+/**
+ * Drop the legacy {cache_media_xml} table.
+ */
+function media_update_7218() {
+  if (db_table_exists('cache_media_xml')) {
+    db_drop_table('cache_media_xml');
+  }
+
+  variable_del('media__xml_cache_expire');
+}
+
+/**
+ * Enable the Media WYSIWYG submodule.
+ */
+function media_update_7219() {
+  if (module_exists('wysiwyg')) {
+    module_enable(array('media_wysiwyg'));
+  }
+}
+
+/**
+ * Delete the deprecated media__file_list_size variable.
+ */
+function media_update_7220() {
+  variable_del('media__file_list_size');
+}
+
+/**
+ * Enable the Media Bulk Upload submodule.
+ */
+function media_update_7221() {
+  if (module_exists('multiform') && module_exists('plupload')) {
+    module_enable(array('media_bulk_upload'));
+  }
+}
+
+/**
+ * Delete the deprecated media__display_types_migration_mess variable.
+ */
+function media_update_7222() {
+  variable_del('media__display_types_migration_mess');
+}
+
+/**
+ * Delete legacy variables.
+ */
+function media_update_7223() {
+  variable_del('media__max_filesize');
+  variable_del('media__debug');
+  variable_del('media__xml_cache_expire');
+  variable_del('media__show_file_type_rebuild_nag');
+  variable_del('media__field_select_media_text');
+  variable_del('media__field_remove_media_text');
+  variable_del('media__browser_library_empty_message');
+  variable_del('media__browser_pager_limit');
+  variable_del('media__browser_viewtype_default');
+}
+
+/**
+ * Rename variables, removing variable namespace.
+ */
+function media_update_7224() {
+  // Create an array of variables sans 'media' prefix.
+  $variables = array('wysiwyg_title', 'wysiwyg_icon_title', 'wysiwyg_default_view_mode', 'wysiwyg_upload_directory', 'wysiwyg_allowed_types', 'wysiwyg_allowed_attributes', 'wysiwyg_browser_plugins', 'dialog_theme', 'import_batch_size', 'fromurl_supported_schemes', 'icon_base_directory', 'icon_set', 'show_deprecated_view_modes');
+
+  foreach ($variables as $variable) {
+    // Find the value of the old variable.
+    $value = variable_get('media__' . $variable);
+
+    // Port the value of the variable if it was set.
+    if (!is_null($value)) {
+      variable_set('media_' . $variable, $value);
+    }
+
+    // Remove the old variable.
+    variable_del('media__' . $variable);
+  }
+}
+
+/**
+ * Migrate variables to appropriate submodules.
+ */
+function media_update_7225() {
+  $data = array(
+    'media_wysiwyg' => array(
+      'wysiwyg_title',
+      'wysiwyg_icon_title',
+      'wysiwyg_default_view_mode',
+      'wysiwyg_upload_directory',
+      'wysiwyg_allowed_types',
+      'wysiwyg_allowed_attributes',
+      'wysiwyg_browser_plugins',
+    ),
+    'media_internet' => array(
+      'fromurl_supported_schemes',
+    ),
+    'media_bulk_upload' => array(
+      'import_batch_size',
+    ),
+  );
+
+  foreach ($data as $module => $variables) {
+    foreach ($variables as $variable) {
+      // Only port variables to submodules if the submodule exists.
+      if (module_exists($module)) {
+        // Find the value of the old variable.
+        $value = variable_get('media_' . $variable);
+
+        // Port the value of the variable if it was set.
+        if (!is_null($value)) {
+          variable_set($module . '_' . $variable, $value);
+        }
+      }
+
+      // Remove the old variable.
+      variable_del('media_' . $variable);
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/media.media.inc b/profiles/commons/modules/contrib/media/media.media.inc
new file mode 100644
index 0000000..4a20dee
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.media.inc
@@ -0,0 +1,136 @@
+<?php
+
+/**
+ * @file
+ * Media module integration for the Media module.
+ */
+
+/**
+ * Implements hook_media_browser_plugin_info().
+ */
+function media_media_browser_plugin_info() {
+  $info['upload'] = array(
+    'title' => t('Upload'),
+    'weight' => -10,
+    'class' => 'MediaBrowserUpload',
+  );
+
+  // Add a plugin for each View display using the 'media_browser' display type.
+  $view_weight = 10;
+  foreach (views_get_enabled_views() as $view) {
+    foreach ($view->display as $display) {
+      if ($display->display_plugin == 'media_browser') {
+        $title = $display->display_title;
+        if (!empty($display->display_options['title'])) {
+          $title = $display->display_options['title'];
+        }
+        $info["{$view->name}--{$display->id}"] = array(
+          'title' => $title,
+          // @TODO make this configurable.
+          'weight' => $view_weight++,
+          'class' => 'MediaBrowserView',
+          'view_name' => $view->name,
+          'view_display_id' => $display->id,
+        );
+      }
+    }
+  }
+
+  return $info;
+}
+
+/**
+ * Implements hook_query_media_browser_alter().
+ */
+function media_query_media_browser_alter($query) {
+  // Ensure that the query is against the file_managed table.
+  $tables = $query->getTables();
+  if (empty($tables['file_managed'])) {
+    throw new Exception(t('Media browser being queried without the file_managed table.'));
+  }
+  $alias = $tables['file_managed']['alias'];
+
+  $params = drupal_get_query_parameters();
+  // How do we validate these?  I don't know.
+  // I think PDO should protect them, but I'm not 100% certain.
+  array_walk_recursive($params, 'media_recursive_check_plain');
+
+  $types = !empty($params['types']) ? $params['types'] : NULL;
+  $url_include_patterns = !empty($params['url_include_patterns']) ? $params['url_include_patterns'] : NULL;
+  $url_exclude_patterns = !empty($params['url_exclude_patterns']) ? $params['url_exclude_patterns'] : NULL;
+  $allowed_schemes = !empty($params['schemes']) ? array_filter($params['schemes']) : array();
+  $extensions = !empty($params['file_extensions']) ? array_filter(explode(' ', $params['file_extensions'])) : array();
+
+  $or_condition = db_or();
+
+  if (!empty($allowed_schemes)) {
+    // Include local files with the allowed extensions and types.
+    $local_wrappers = array_intersect_key(media_get_local_stream_wrappers(), $allowed_schemes);
+    if (!empty($extensions) && !empty($local_wrappers)) {
+      // Extension filtering.
+      $local_condition = db_or();
+      foreach (array_keys($local_wrappers) as $scheme) {
+        foreach ($extensions as $extension) {
+          $local_condition->condition($alias . '.uri', db_like($scheme . '://') . '%' . db_like('.' . $extension), 'LIKE');
+        }
+      }
+      $or_condition->condition($local_condition);
+    }
+    if (!empty($types) && !empty($local_wrappers)) {
+      // Type filtering.
+      $local_condition = db_or();
+      foreach (array_keys($local_wrappers) as $scheme) {
+        $local_condition->condition($alias . '.type', $types, 'IN');
+      }
+      $or_condition->condition($local_condition);
+    }
+
+    // Include remote files with the allowed file types.
+    // We cant filter extensions here, because remote file filenames usually
+    // are a url or a parameter of a query.
+    $remote_wrappers = array_intersect_key(media_get_remote_stream_wrappers(), $allowed_schemes);
+    if (!empty($types) && !empty($remote_wrappers)) {
+      $remote_condition = db_and();
+      $wrapper_condition = db_or();
+      foreach (array_keys($remote_wrappers) as $scheme) {
+        $wrapper_condition->condition($alias . '.uri', db_like($scheme . '://') . '%', 'LIKE');
+      }
+      $remote_condition->condition($wrapper_condition);
+      $remote_condition->condition($alias . '.type', $types, 'IN');
+      $or_condition->condition($remote_condition);
+    }
+  }
+  else {
+    if (!empty($types)) {
+      $query->condition($alias . '.type', $types, 'IN');
+    }
+    if (!empty($extensions)) {
+      foreach ($extensions as $extension) {
+        $or_condition->condition($alias . '.uri', db_like('.' . $extension), 'LIKE');
+      }
+    }
+  }
+
+  if ($or_condition->count()) {
+    $query->condition($or_condition);
+  }
+
+  if ($url_include_patterns) {
+    $query->condition($alias . '.uri', '%' . db_like($url_include_patterns) . '%', 'LIKE');
+    // Insert stream related restrictions here.
+  }
+  if ($url_exclude_patterns) {
+    $query->condition($alias . '.uri', '%' . db_like($url_exclude_patterns) . '%', 'NOT LIKE');
+  }
+
+  if (!user_access('administer files')) {
+    $query->condition($alias . '.uri', db_like('private://') . '%', 'NOT LIKE');
+  }
+
+  // @todo This is possibly redundant since it's already filtered in the view.
+  $query->condition($alias . '.status', FILE_STATUS_PERMANENT);
+
+  foreach (array_keys(file_entity_get_hidden_stream_wrappers()) as $name) {
+    $query->condition($alias . '.uri', db_like($name . '://') . '%', 'NOT LIKE');
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/media.module b/profiles/commons/modules/contrib/media/media.module
new file mode 100644
index 0000000..197f62c
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.module
@@ -0,0 +1,1008 @@
+<?php
+
+/**
+ * @file
+ * Media API
+ *
+ * The core Media API.
+ * See http://drupal.org/project/media for more details.
+ */
+
+// Code relating to using media as a field.
+require_once dirname(__FILE__) . '/includes/media.fields.inc';
+
+/**
+ * Implements hook_hook_info().
+ */
+function media_hook_info() {
+  $hooks = array(
+    'media_parse',
+    'media_browser_plugin_info',
+    'media_browser_plugin_info_alter',
+    'media_browser_plugins_alter',
+    'media_browser_params_alter',
+    'query_media_browser_alter',
+  );
+
+  return array_fill_keys($hooks, array('group' => 'media'));
+}
+
+/**
+ * Implements hook_help().
+ */
+function media_help($path, $arg) {
+  switch ($path) {
+    case 'admin/help#media':
+      $output = '';
+      $output .= '<h3>' . t('About') . '</h3>';
+      $output .= '<p>' . t('The Media module is a File Browser to the Internet, media provides a framework for managing files and multimedia assets, regardless of whether they are hosted on your own site or a 3rd party site. It replaces the Drupal core upload field with a unified User Interface where editors and administrators can upload, manage, and reuse files and multimedia assets. Media module also provides rich integration with WYSIWYG module to let content creators access media assets in rich text editor. Javascript is required to use the Media module.  For more information check <a href="@media_faq">Media Module page</a>', array('@media_faq' => 'http://drupal.org/project/media')) . '.</p>';
+      $output .= '<h3>' . t('Uses') . '</h3>';
+      $output .= '<dl>';
+      $output .= '<dt>' . t('Media Repository') . '</dt>';
+      $output .= '<dd>' . t('Media module allows you to maintain a <a href="@mediarepo">media asset repository</a> where in you can add, remove, reuse your media assets. You can add the media file using upload form or from a url and also do bulk operations on the media assets.', array('@mediarepo' => url('admin/content/media'))) . '</dd>';
+      $output .= '<dt>' . t('Attaching media assets to content types') . '</dt>';
+      $output .= '<dd>' . t('Media assets can be attached to content types as fields. To add a media field to a <a href="@content-type">content type</a>, go to the content type\'s <em>manage fields</em> page, and add a new field of type <em>Multimedia Asset</em>.', array('@content-type' => url('admin/structure/types'))) . '</dd>';
+      $output .= '<dt>' . t('Using media assets in WYSIWYG') . '</dt>';
+      $output .= '<dd>' . t('Media module provides rich integration with WYSIWYG editors, using Media Browser plugin you can select media asset from library to add to the rich text editor moreover you can add media asset from the media browser itself using either upload method or add from url method. To configure media with WYSIWYG you need two steps of configuration:');
+      $output .= '<ul><li>' . t('Enable WYSIWYG plugin on your desired <a href="@wysiwyg-profile">WYSIWYG profile</a>. Please note that you will need to have <a href="@wysiwyg">WYSIWYG</a> module enabled.', array('@wysiwyg-profile' => url('admin/config/content/wysiwyg'), '@wysiwyg' => 'http://drupal.org/project/wysiwyg')) . '</li>';
+      $output .= '<li>' . t('Enable the <em>Convert Media tags to markup</em> filter on the <a href="@input-format">Input format</a> you are using with the WYSIWYG profile.', array('@input-format' => url('admin/config/content/formats'))) . '</li></ul></dd>';
+      return $output;
+  }
+}
+
+/**
+ * Implements hook_entity_info_alter().
+ */
+function media_entity_info_alter(&$entity_info) {
+  // For sites that updated from Media 1.x, continue to provide these deprecated
+  // view modes.
+  // @see http://drupal.org/node/1051090
+  if (variable_get('media_show_deprecated_view_modes', FALSE)) {
+    $entity_info['file']['view modes'] += array(
+      'media_link' => array(
+        'label' => t('Link'),
+        'custom settings' => TRUE,
+      ),
+      'media_original' => array(
+        'label' => t('Original'),
+        'custom settings' => TRUE,
+      ),
+    );
+  }
+
+  if (module_exists('entity_translation')) {
+    $entity_info['file']['translation']['entity_translation']['class'] = 'MediaEntityTranslationHandler';
+    $entity_info['file']['translation']['entity_translation']['path schemes']['media'] = array('edit path' => 'media/%file/edit/%ctools_js');
+  }
+}
+
+/**
+ * Implements hook_menu().
+ */
+function media_menu() {
+  // For managing different types of media and the fields associated with them.
+  $items['admin/config/media/browser'] = array(
+    'title' => 'Media browser settings',
+    'description' => 'Configure the behavior and display of the media browser.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_admin_config_browser'),
+    'access arguments' => array('administer media browser'),
+    'file' => 'includes/media.admin.inc',
+  );
+
+  // Administrative screens for managing media.
+  $items['admin/content/file/thumbnails'] = array(
+    'title' => 'Thumbnails',
+    'description' => 'Manage files used on your site.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('file_entity_admin_file'),
+    'access arguments' => array('administer files'),
+    'type' => MENU_LOCAL_TASK,
+    'file' => 'file_entity.admin.inc',
+    'file path' => drupal_get_path('module', 'file_entity'),
+    'weight' => 10,
+  );
+
+  $items['media/browser'] = array(
+    'title' => 'Media browser',
+    'description' => 'Media Browser for picking media and uploading new media',
+    'page callback' => 'media_browser',
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('create'),
+    'type' => MENU_CALLBACK,
+    'file' => 'includes/media.browser.inc',
+    'theme callback' => 'media_dialog_get_theme_name',
+  );
+
+  // A testbed to try out the media browser with different launch commands.
+  $items['media/browser/testbed'] = array(
+    'title' => 'Media Browser test',
+    'description' => 'Make it easier to test media browser',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_browser_testbed'),
+    'access arguments' => array('administer files'),
+    'type' => MENU_CALLBACK,
+    'file' => 'includes/media.browser.inc',
+  );
+
+  // We could re-use the file/%file/edit path for the modal callback, but
+  // it is just easier to use our own namespace here.
+  $items['media/%file/edit/%ctools_js'] = array(
+    'title' => 'Edit',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_file_edit_modal', 1, 3),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('update', 1),
+    'file' => 'includes/media.pages.inc',
+    'type' => MENU_CALLBACK,
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_menu_local_tasks_alter().
+ */
+function media_menu_local_tasks_alter(&$data, $router_item, $root_path) {
+  // Add action link to 'file/add' on 'admin/content/file/thumbnails' page.
+  if ($root_path == 'admin/content/file/thumbnails') {
+    $item = menu_get_item('file/add');
+    if (!empty($item['access'])) {
+      $data['actions']['output'][] = array(
+        '#theme' => 'menu_local_action',
+        '#link' => $item,
+        '#weight' => $item['weight'],
+      );
+    }
+  }
+}
+
+/**
+ * Implements hook_admin_paths().
+ */
+function media_admin_paths() {
+  $paths['media/*/edit/*'] = TRUE;
+
+  // If the media browser theme is set to the admin theme, ensure it gets set
+  // as an admin path as well.
+  $dialog_theme = variable_get('media_dialog_theme', '');
+  if (empty($dialog_theme) || $dialog_theme == variable_get('admin_theme')) {
+    $paths['media/browser'] = TRUE;
+    $paths['media/browser/*'] = TRUE;
+  }
+
+  return $paths;
+}
+
+/**
+ * Implements hook_permission().
+ */
+function media_permission() {
+  return array(
+    'administer media browser' => array(
+      'title' => t('Administer media browser'),
+      'description' => t('Access media browser settings.'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_theme().
+ */
+function media_theme() {
+  return array(
+    // A preview of the uploaded file.
+    'media_thumbnail' => array(
+      'render element' => 'element',
+      'file' => 'includes/media.theme.inc',
+    ),
+
+    // Dialog page.
+    'media_dialog_page' => array(
+      'render element' => 'page',
+      'template' => 'templates/media-dialog-page',
+      'file' => 'includes/media.theme.inc',
+    ),
+
+    // Media form API element type.
+    'media_element' => array(
+      'render element' => 'element',
+      'file' => 'includes/media.theme.inc',
+    ),
+
+    // Display a file as a large icon.
+    'media_formatter_large_icon' => array(
+      'variables' => array('file' => NULL, 'attributes' => array(), 'style_name' => 'media_thumbnail'),
+      'file' => 'includes/media.theme.inc',
+    ),
+  );
+}
+
+/**
+ * Implements hook_image_default_styles().
+ */
+function media_image_default_styles() {
+  $styles = array();
+  $styles['media_thumbnail'] = array(
+    'label' => 'Media thumbnail (100x100)',
+    'effects' => array(
+      array(
+        'name' => 'image_scale_and_crop',
+        'data' => array('width' => 100, 'height' => 100),
+        'weight' => 0,
+      ),
+    ),
+  );
+  return $styles;
+}
+
+/**
+ * Implements hook_page_alter().
+ *
+ * This is used to use our alternate template when ?render=media-popup is passed
+ * in the URL.
+ */
+function media_page_alter(&$page) {
+  if (isset($_GET['render']) && $_GET['render'] == 'media-popup') {
+    $page['#theme'] = 'media_dialog_page';
+
+    // Disable administration modules from adding output to the popup.
+    // @see http://drupal.org/node/914786
+    module_invoke_all('suppress', TRUE);
+
+    foreach (element_children($page) as $key) {
+      if ($key != 'content') {
+        unset($page[$key]);
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_form_FIELD_UI_FIELD_SETTINGS_FORM_alter().
+ *
+ * @todo: Respect field settings in 7.x-2.x and handle them in the media widget
+ * UI.
+ */
+function media_form_field_ui_field_settings_form_alter(&$form, &$form_state) {
+  // On file fields that use the media widget we need remove specific fields.
+  if ($form['field']['type']['#value'] == 'file') {
+    $fields = field_info_instances($form['#entity_type'], $form['#bundle']);
+    if ($fields[$form['field']['field_name']['#value']]['widget']['type'] == 'media_generic') {
+      $form['field']['settings']['display_field']['#access'] = FALSE;
+      $form['field']['settings']['display_default']['#access'] = FALSE;
+    }
+  }
+}
+
+/**
+ * Implements hook_form_FIELD_UI_FIELD_EDIT_FORM_alter().
+ *
+ * @todo: Respect field settings in 7.x-2.x and handle them in the media widget
+ * UI.
+ */
+function media_form_field_ui_field_edit_form_alter(&$form, &$form_state) {
+  // On file fields that use the media widget we need remove specific fields.
+  if ($form['#field']['type'] == 'file' && $form['instance']['widget']['type']['#value'] == 'media_generic') {
+    $form['field']['settings']['display_field']['#access'] = FALSE;
+    $form['field']['settings']['display_default']['#access'] = FALSE;
+    $form['instance']['settings']['description_field']['#access'] = FALSE;
+    $form['instance']['settings']['file_extensions']['#title'] = t('Allowed file extensions for uploaded files');
+    $form['instance']['settings']['file_extensions']['#maxlength'] = 255;
+  }
+
+  // On image fields using the media widget we remove the alt/title fields.
+  if ($form['#field']['type'] == 'image' && $form['instance']['widget']['type']['#value'] == 'media_generic') {
+    $form['instance']['settings']['alt_field']['#access'] = FALSE;
+    $form['instance']['settings']['title_field']['#access'] = FALSE;
+    $form['instance']['settings']['file_extensions']['#title'] = t('Allowed file extensions for uploaded files');
+    // Do not increase maxlength of file extensions for image fields, since
+    // presumably they will not need a long list of extensions.
+  }
+  if ($form['#instance']['entity_type'] == 'file') {
+    $form['instance']['settings']['wysiwyg_override'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Override in WYSIWYG'),
+      '#description' => t('If checked, then this field may be overridden in the WYSIWYG editor.'),
+      '#default_value' => isset($form['#instance']['settings']['wysiwyg_override']) ? $form['#instance']['settings']['wysiwyg_override'] : TRUE,
+    );
+  }
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ */
+function media_form_file_entity_edit_alter(&$form, &$form_state) {
+  // Make adjustments to the file edit form when used in a CTools modal.
+  if (!empty($form_state['ajax'])) {
+    // Remove the preview and the delete button.
+    $form['preview']['#access'] = FALSE;
+    $form['actions']['delete']['#access'] = FALSE;
+
+    // Convert the cancel link to a button which triggers a modal close.
+    $form['actions']['cancel']['#attributes']['class'][] = 'button';
+    $form['actions']['cancel']['#attributes']['class'][] = 'button-no';
+    $form['actions']['cancel']['#attributes']['class'][] = 'ctools-close-modal';
+  }
+}
+
+/**
+ * Implements hook_form_alter().
+ */
+function media_form_alter(&$form, &$form_state, $form_id) {
+  // If we're in the media browser, set the #media_browser key to true
+  // so that if an ajax request gets sent to a different path, the form
+  // still uses the media_browser_form_submit callback.
+  if (current_path() == 'media/browser' && $form_id != 'views_exposed_form') {
+    $form_state['#media_browser'] = TRUE;
+  }
+
+  // If the #media_browser key isset and is true we are using the browser
+  // popup, so add the media_browser submit handler.
+  if (!empty($form_state['#media_browser'])) {
+    $form['#submit'][] = 'media_browser_form_submit';
+  }
+}
+
+/**
+ * Submit handler; direction form submissions in the media browser.
+ */
+function media_browser_form_submit($form, &$form_state) {
+  $url = NULL;
+  $parameters = array();
+
+  // Single upload.
+  if (!empty($form_state['file'])) {
+    $file = $form_state['file'];
+    $url = 'media/browser';
+    $parameters = array('query' => array('render' => 'media-popup', 'fid' => $file->fid));
+  }
+
+  // If $url is set, we had some sort of upload, so redirect the form.
+  if (!empty($url)) {
+    $form_state['redirect'] = array($url, $parameters);
+  }
+}
+
+/**
+ * Implements hook_library().
+ */
+function media_library() {
+  $path = drupal_get_path('module', 'media');
+  $info = system_get_info('module', 'media');
+
+  $common = array(
+    'website' => 'http://drupal.org/project/media',
+    'version' => !empty($info['version']) ? $info['version'] : '7.x-2.x',
+  );
+
+  // Contains libraries common to other media modules.
+  $libraries['media_base'] = array(
+    'title' => 'Media base',
+    'js' => array(
+      $path . '/js/media.core.js' => array('group' => JS_LIBRARY, 'weight' => -5),
+      $path . '/js/util/json2.js' => array('group' => JS_LIBRARY),
+      $path . '/js/util/ba-debug.min.js' => array('group' => JS_LIBRARY),
+    ),
+    'css' => array(
+      $path . '/css/media.css',
+    ),
+  );
+
+  // Includes resources needed to launch the media browser.  Should be included
+  // on pages where the media browser needs to be launched from.
+  $libraries['media_browser'] = array(
+    'title' => 'Media Browser popup libraries',
+    'js' => array(
+      $path . '/js/media.popups.js' => array('group' => JS_DEFAULT),
+    ),
+    'dependencies' => array(
+      array('system', 'ui.resizable'),
+      array('system', 'ui.draggable'),
+      array('system', 'ui.dialog'),
+      array('media', 'media_base'),
+    ),
+  );
+
+  // Resources needed in the media browser itself.
+  $libraries['media_browser_page'] = array(
+    'title' => 'Media browser',
+    'js' => array(
+      $path . '/js/media.browser.js'  => array('group' => JS_DEFAULT),
+    ),
+    'dependencies' => array(
+      array('system', 'ui.tabs'),
+      array('system', 'ui.draggable'),
+      array('system', 'ui.dialog'),
+      array('media', 'media_base'),
+    ),
+  );
+
+  foreach ($libraries as &$library) {
+    $library += $common;
+  }
+  return $libraries;
+}
+
+/**
+ * Theme callback used to identify when we are in a popup dialog.
+ *
+ * Generally the default theme will look terrible in the media browser. This
+ * will default to the administration theme, unless set otherwise.
+ */
+function media_dialog_get_theme_name() {
+  return variable_get('media_dialog_theme', variable_get('admin_theme'));
+}
+
+/**
+ * This will parse a url or embedded code into a unique URI.
+ *
+ * The function will call all modules implementing hook_media_parse($url),
+ * which should return either a string containing a parsed URI or NULL.
+ *
+ * @NOTE The implementing modules may throw an error, which will not be caught
+ * here; it's up to the calling function to catch any thrown errors.
+ *
+ * @NOTE In emfield, we originally also accepted an array of regex patterns
+ * to match against. However, that module used a registration for providers,
+ * and simply stored the match in the database keyed to the provider object.
+ * However, other than the stream wrappers, there is currently no formal
+ * registration for media handling. Additionally, few, if any, stream wrappers
+ * will choose to store a straight match from the parsed URL directly into
+ * the URI. Thus, we leave both the matching and the final URI result to the
+ * implementing module in this implementation.
+ *
+ * An alternative might be to do the regex pattern matching here, and pass a
+ * successful match back to the implementing module. However, that would
+ * require either an overloaded function or a new hook, which seems like more
+ * overhead than it's worth at this point.
+ *
+ * @TODO Once hook_module_implements_alter() is in core (see the issue at
+ * http://drupal.org/node/692950) we may want to implement media_media_parse()
+ * to ensure we were passed a valid URL, rather than an unsupported or
+ * malformed embed code that wasn't caught earlier. It will needed to be
+ * weighted so it's called after all other streams have a go, as the fallback,
+ * and will need to throw an error.
+ *
+ * @param string $url
+ *   The original URL or embed code to parse.
+ *
+ * @return string
+ *   The unique URI for the file, based on its stream wrapper, or NULL.
+ *
+ * @see media_parse_to_file()
+ * @see media_add_from_url_validate()
+ */
+function media_parse_to_uri($url) {
+  // Trim any whitespace before parsing.
+  $url = trim($url);
+  foreach (module_implements('media_parse') as $module) {
+    $success = module_invoke($module, 'media_parse', $url);
+    if (isset($success)) {
+      return $success;
+    }
+  }
+}
+
+/**
+ * Parse a URL or embed code and return a file object.
+ *
+ * If a remote stream doesn't claim the parsed URL in media_parse_to_uri(),
+ * then we'll copy the file locally.
+ *
+ * @NOTE The implementing modules may throw an error, which will not be caught
+ * here; it's up to the calling function to catch any thrown errors.
+ *
+ * @see media_parse_to_uri()
+ * @see media_add_from_url_submit()
+ */
+function media_parse_to_file($url) {
+  try {
+    $uri = media_parse_to_uri($url);
+  }
+  catch (Exception $e) {
+    // Pass the error along.
+    throw $e;
+    return;
+  }
+
+  if (isset($uri)) {
+    // Attempt to load an existing file from the unique URI.
+    $select = db_select('file_managed', 'f')
+    ->extend('PagerDefault')
+    ->fields('f', array('fid'))
+    ->condition('uri', $uri);
+
+    $fid = $select->execute()->fetchCol();
+    if (!empty($fid)) {
+      $file = file_load(array_pop($fid));
+      return $file;
+    }
+  }
+
+  if (isset($uri)) {
+    // The URL was successfully parsed to a URI, but does not yet have an
+    // associated file: save it!
+    $file = file_uri_to_object($uri);
+    file_save($file);
+  }
+  else {
+    // The URL wasn't parsed. We'll try to save a remote file.
+    // Copy to temporary first.
+    $source_uri = file_stream_wrapper_uri_normalize('temporary://' . basename($url));
+    if (!@copy(@$url, $source_uri)) {
+      throw new Exception('Unable to add file ' . $url);
+      return;
+    }
+    $source_file = file_uri_to_object($source_uri);
+    $scheme = variable_get('file_default_scheme', 'public') . '://';
+    $uri = file_stream_wrapper_uri_normalize($scheme . $source_file->filename);
+    // Now to its new home.
+    $file = file_move($source_file, $uri, FILE_EXISTS_RENAME);
+  }
+
+  return $file;
+}
+
+/**
+ * Utility function to recursively run check_plain on an array.
+ *
+ * @todo There is probably something in core I am not aware of that does this.
+ */
+function media_recursive_check_plain(&$value, $key) {
+  $value = check_plain($value);
+}
+
+/**
+ * Implements hook_element_info().
+ */
+function media_element_info() {
+  $types = array();
+  $types['media'] = array(
+    '#input' => TRUE,
+    '#process' => array('media_element_process'),
+    // '#value_callback' => 'media_element_value',
+    '#element_validate' => array('media_element_validate'),
+    '#theme_wrappers' => array('container'),
+    '#progress_indicator' => 'throbber',
+    '#extended' => FALSE,
+    '#required' => FALSE,
+    '#media_options' => array(
+      'global' => array(
+        // Example: array('image', 'audio');
+        'types' => array(),
+        // Example: array('http', 'ftp', 'flickr');
+        'schemes' => array(),
+      ),
+    ),
+    '#attributes' => array(
+      'class' => array('media-widget', 'form-item'),
+    ),
+    '#attached' => array(
+      'library' => array(
+        array('media', 'media_browser'),
+      ),
+    ),
+  );
+  return $types;
+}
+
+/**
+ * Process callback for the media form element.
+ */
+function media_element_process(&$element, &$form_state, $form) {
+  $fid = isset($element['#value']['fid']) ? $element['#value']['fid'] : 0;
+  $file = $fid ? file_load($fid) : FALSE;
+
+  // Add the CTools modal JavaScript for the edit button if necessary.
+  ctools_include('modal');
+  ctools_include('ajax');
+  ctools_modal_add_js();
+
+  // Set some default element properties.
+  $element['#file'] = $file;
+
+  $element['title'] = array(
+    '#type' => 'item',
+    '#title' => $element['#title'],
+    '#description' => $element['#description'],
+    '#required' => $element['#required'],
+    '#weight' => -100,
+  );
+  if (isset($element['#title_display'])) {
+    $element['title']['#title_display'] = $element['#title_display'];
+  }
+
+  // @todo This should load from the JS in case of a failed form submission.
+  $element['preview'] = array(
+    '#prefix' => '<div class="preview launcher">',
+    '#suffix' => '</div>',
+    '#weight' => 0,
+    'content' => $file ? media_get_thumbnail_preview($file) : array(),
+  );
+
+  // @todo: Perhaps this language logic should be handled by JS since the state
+  // changes on client side after choosing an item.
+  $element['select'] = array(
+    '#type' => 'link',
+    '#href' => '',
+    '#title' => t('Select'),
+    '#attributes' => array('class' => array('button', 'launcher')),
+    '#options' => array('fragment' => FALSE, 'external' => TRUE),
+    '#weight' => 10,
+  );
+  // @todo Figure out how to update the preview image after the Edit modal is
+  // closed.
+  $element['edit'] = array(
+    '#type' => 'link',
+    '#href' => 'media/' . $fid . '/edit/nojs',
+    '#title' => t('Edit'),
+    '#attributes' => array(
+      'class' => array(
+        // Required for CTools modal to work.
+        'ctools-use-modal', 'use-ajax',
+        'ctools-modal-media-file-edit', 'button', 'edit',
+      ),
+    ),
+    '#weight' => 20,
+    '#access' => $file ? file_entity_access('update', $file) : TRUE, // only do perm check for existing files
+  );
+  $element['remove'] = array(
+    '#type' => 'link',
+    '#href' => '',
+    '#title' => t('Remove'),
+    '#attributes' => array('class' => array('button', 'remove')),
+    '#options' => array('fragment' => FALSE, 'external' => TRUE),
+    '#weight' => 30,
+  );
+
+  $element['fid'] = array(
+    '#type' => 'hidden',
+    '#value' => $fid,
+    '#attributes' => array('class' => array('fid')),
+    '#weight' => 100,
+  );
+
+  // Media browser attach code.
+  $element['#attached']['js'][] = drupal_get_path('module', 'media') . '/js/media.js';
+
+  $setting = array();
+  $setting['media']['elements'][$element['#id']] = $element['#media_options'];
+
+  $element['#attached']['js'][] = array(
+    'type' => 'setting',
+    'data' => $setting,
+  );
+
+  // @todo: Might need to think about this. All settings would likely apply to
+  // all media in a multi-value, but what about passing the existing fid?
+  module_load_include('inc', 'media', 'includes/media.browser');
+  media_attach_browser_js($element);
+
+  return $element;
+  // @todo: make this work for file and image fields.
+}
+
+/**
+ * Validate media form elements.
+ *
+ * The file type is validated during the upload process, but this is necessary
+ * necessary in order to respect the #required property.
+ */
+function media_element_validate(&$element, &$form_state) {
+  if ($element['#required']) {
+    $has_value = FALSE;
+    $widget_parents = $element['#array_parents'];
+    array_pop($widget_parents);
+    $items = drupal_array_get_nested_value($form_state['values'], $widget_parents);
+    foreach ($items as $value) {
+      if (is_array($value) && !empty($value['fid'])) {
+        $has_value = TRUE;
+      }
+    }
+    if (!$has_value) {
+      form_error($element, t('%element_title field is required.', array('%element_title' => $element['#title'])));
+    }
+  }
+}
+
+/**
+ * Media thumbnail render function.
+ *
+ * Returns a renderable array with the necessary classes to support a media
+ * thumbnail. Also provides default fallback images if no image is available.
+ *
+ * @param object $file
+ *   A Drupal file object.
+ *
+ * @return array
+ *   Renderable array.
+ */
+function media_get_thumbnail_preview($file, $link = NULL) {
+  // If a file has an invalid type, allow file_view_file() to work.
+  if (!file_type_is_enabled($file->type)) {
+    $file->type = file_get_type($file);
+  }
+
+  $preview = file_view_file($file, 'preview');
+  $preview['#show_names'] = TRUE;
+  $preview['#add_link'] = $link;
+  $preview['#theme_wrappers'][] = 'media_thumbnail';
+  $preview['#attached']['css'][] = drupal_get_path('module', 'media') . '/css/media.css';
+  return $preview;
+}
+
+/**
+ * Check that the media is one of the selected types.
+ *
+ * @param object $file
+ *   A Drupal file object.
+ * @param array $types
+ *   An array of media type names
+ *
+ * @return array
+ *   If the file type is not allowed, it will contain an error message.
+ *
+ * @see hook_file_validate()
+ */
+function media_file_validate_types(stdClass $file, $types) {
+  $errors = array();
+  if (!in_array(file_get_type($file), $types)) {
+    $errors[] = t('Only the following types of files are allowed to be uploaded: %types-allowed', array('%types-allowed' => implode(', ', $types)));
+  }
+
+  return $errors;
+}
+
+/**
+ * Implements hook_file_displays_alter().
+ */
+function media_file_displays_alter(&$displays, $file, $view_mode) {
+  if ($view_mode == 'preview' && empty($displays)) {
+    // We re in the media browser and this file has no formatters enabled.
+    // Instead of letting it go through theme_file_link(), pass it through
+    // theme_media_formatter_large_icon() to get our cool file icon instead.
+    $displays['file_field_media_large_icon'] = array(
+      'weight' => 0,
+      'status' => 1,
+      'settings' => NULL,
+    );
+  }
+
+  // Override the fields of the file when requested by the WYSIWYG.
+  if (isset($file->override) && isset($file->override['fields'])) {
+    $instance = field_info_instances('file', $file->type);
+    foreach ($file->override['fields'] as $field_name => $value) {
+      if (!isset($instance[$field_name]['settings']) || !isset($instance[$field_name]['settings']['wysiwyg_override']) || $instance[$field_name]['settings']['wysiwyg_override']) {
+        $file->{$field_name} = $value;}
+    }
+  }
+
+  // Alt and title are special.
+  // @see file_entity_file_load
+  $alt = variable_get('file_entity_alt', '[file:field_file_image_alt_text]');
+  $title = variable_get('file_entity_title', '[file:field_file_image_title_text]');
+
+  $replace_options = array(
+    'clear' => TRUE,
+    'sanitize' => FALSE,
+  );
+
+  // Load alt and title text from fields.
+  if (!empty($alt)) {
+    $file->alt = token_replace($alt, array('file' => $file), $replace_options);
+  }
+  if (!empty($title)) {
+    $file->title = token_replace($title, array('file' => $file), $replace_options);
+  }
+}
+
+/**
+ * Implements hook_file_default_displays_alter().
+ */
+function media_file_default_displays_alter(&$file_displays) {
+  // Image previews should be displayed using the media image style.
+  if (isset($file_displays['image__preview__file_field_image'])) {
+    $file_displays['image__preview__file_field_image']->settings['image_style'] = 'media_thumbnail';
+  }
+
+  // Video previews should be displayed using a large filetype icon.
+  if (isset($file_displays['video__preview__file_field_file_default'])) {
+    $file_displays['video__preview__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__preview__file_field_media_large_icon';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['video__preview__file_field_media_large_icon'] = $file_display;
+
+  // Audio previews should be displayed using a large filetype icon.
+  if (isset($file_displays['audio__preview__file_field_file_default'])) {
+    $file_displays['audio__preview__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__preview__file_field_media_large_icon';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['audio__preview__file_field_media_large_icon'] = $file_display;
+
+  // Document previews should be displayed using a large filetype icon.
+  if (isset($file_displays['document__preview__file_field_file_default'])) {
+    $file_displays['document__preview__file_field_file_default']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__preview__file_field_media_large_icon';
+  $file_display->weight = 50;
+  $file_display->status = TRUE;
+  $file_display->settings = '';
+  $file_displays['document__preview__file_field_media_large_icon'] = $file_display;
+}
+
+/**
+ * Implements hook_ctools_plugin_api().
+ *
+ * Lets CTools know which plugin APIs are implemented by Media module.
+ */
+function media_ctools_plugin_api($module, $api) {
+  if ($module == 'file_entity' && $api == 'file_default_displays') {
+    return array(
+      'version' => 1,
+    );
+  }
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ *
+ * This alter enhances the default admin/content/file page, addding JS and CSS.
+ * It also makes modifications to the thumbnail view by replacing the existing
+ * checkboxes and table with thumbnails.
+ */
+function media_form_file_entity_admin_file_alter(&$form, $form_state) {
+  if (!empty($form_state['values']['operation'])) {
+    // The form is being rebuilt because an operation requiring confirmation
+    // We don't want to be messing with it in this case.
+    return;
+  }
+
+  // Add the "Add file" local action, and notify users if they have files
+  // selected and they try to switch between the "Thumbnail" and "List" local
+  // tasks.
+  $path = drupal_get_path('module', 'media');
+  require_once $path . '/includes/media.browser.inc';
+  $form['#attributes']['class'][] = 'file-entity-admin-file-form';
+  $form['#attached']['js'][] = $path . '/js/media.admin.js';
+  $form['#attached']['css'][] = $path . '/css/media.css';
+  media_attach_browser_js($form);
+
+  // By default, this form contains a table select element called "files". For
+  // the 'thumbnails' tab, Media generates a thumbnail for each file and
+  // replaces the tableselect with a grid of thumbnails.
+  if (arg(3) == 'thumbnails') {
+    if (empty($form['admin']['files'])) {
+      // Display empty text if there are no files.
+      $form['admin']['files'] = array(
+        '#markup' => '<p>' . $form['files']['#empty'] . '</p>',
+      );
+    }
+    else {
+      $files = file_load_multiple(array_keys($form['admin']['files']['#options']));
+
+      $form['admin']['files'] = array(
+        '#tree' => TRUE,
+        '#prefix' => '<div class="media-display-thumbnails media-clear clearfix"><ul id="media-browser-library-list" class="media-list-thumbnails">',
+        '#suffix' => '</ul></div>',
+      );
+
+      foreach ($files as $file) {
+        $preview = media_get_thumbnail_preview($file, TRUE);
+        $form['admin']['files'][$file->fid] = array(
+          '#type' => 'checkbox',
+          '#title' => '',
+          '#prefix' => '<li>' . drupal_render($preview),
+          '#suffix' => '</li>',
+        );
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_views_api().
+ */
+function media_views_api() {
+  return array(
+    'api' => 3,
+    'path' => drupal_get_path('module', 'media'),
+  );
+}
+
+/**
+ * Implements hook_views_default_views().
+ */
+function media_views_default_views() {
+  return media_load_all_exports('media', 'views', 'view.inc', 'view');
+}
+
+/**
+ * Fetches an array of exportables from files.
+ *
+ * @param string $module
+ *   The module invoking this request. (Can be called by other modules.)
+ * @param string $directory
+ *   The subdirectory in the custom module.
+ * @param string $extension
+ *   The file extension.
+ * @param string $name
+ *   The name of the variable found in each file. Defaults to the same as
+ *   $extension.
+ *
+ * @return array
+ *   Array of $name objects.
+ */
+function media_load_all_exports($module, $directory, $extension, $name = NULL) {
+  if (!$name) {
+    $name = $extension;
+  }
+
+  $return = array();
+  // Find all the files in the directory with the correct extension.
+  $files = file_scan_directory(drupal_get_path('module', $module) . "/$directory", "/.$extension/");
+  foreach ($files as $path => $file) {
+    require $path;
+    if (isset($$name)) {
+      $return[$$name->name] = $$name;
+    }
+  }
+
+  return $return;
+}
+
+/**
+ * Returns metadata describing Media browser plugins.
+ *
+ * @see hook_media_browser_plugin_info()
+ * @see hook_media_browser_plugin_info_alter()
+ */
+function media_get_browser_plugin_info() {
+  $info = &drupal_static(__FUNCTION__);
+
+  if (!isset($info)) {
+    $cid = 'media:browser:plugin:info:' . $GLOBALS['language']->language;
+    if ($cache = cache_get($cid)) {
+      $info = $cache->data;
+    }
+    else {
+      $info = module_invoke_all('media_browser_plugin_info');
+      drupal_alter('media_browser_plugin_info', $info);
+      cache_set($cid, $info);
+    }
+  }
+
+  return $info;
+}
+
+/**
+ * Helper function to get a list of local stream wrappers.
+ */
+function media_get_local_stream_wrappers() {
+  return file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL_NORMAL);
+}
+
+/**
+ * Helper function to get a list of remote stream wrappers.
+ */
+function media_get_remote_stream_wrappers() {
+  $wrappers = file_get_stream_wrappers();
+  $wrappers = array_diff_key($wrappers, file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL_NORMAL));
+  $wrappers = array_diff_key($wrappers, file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL_HIDDEN));
+  return $wrappers;
+}
diff --git a/profiles/commons/modules/contrib/media/media.test b/profiles/commons/modules/contrib/media/media.test
new file mode 100644
index 0000000..5f2edaa
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.test
@@ -0,0 +1,24 @@
+<?php
+
+/**
+ * @file
+ * Tests for media.module.
+ */
+
+/**
+ * Defines base class for media test cases.
+ */
+class MediaTestHelper extends DrupalWebTestCase {
+
+  /**
+   * Enable media and file entity modules for testing.
+   */
+  public function setUp() {
+    $modules = func_get_args();
+    if (isset($modules[0]) && is_array($modules[0])) {
+      $modules = $modules[0];
+    }
+    $modules[] = 'media';
+    parent::setUp($modules);
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/media.views.inc b/profiles/commons/modules/contrib/media/media.views.inc
new file mode 100644
index 0000000..9d116bf
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/media.views.inc
@@ -0,0 +1,131 @@
+<?php
+
+/**
+ * @file
+ * Provide Views data and handlers for media.module
+ */
+
+/**
+ * Implements hook_views_plugins().
+ *
+ * Generate a list of which base-tables to enabled the plugins for.
+ */
+function media_views_plugins() {
+  $plugins = array();
+
+  // Always allow the actual file-table
+  $base = array('file_managed');
+
+  if (module_exists('search_api')) {
+    // If the Search API module exists, also allow indices of the file-entity
+    // that has the fid field indexed.
+    $indices = search_api_index_load_multiple(NULL);
+    foreach ($indices as $machine_name => $index) {
+      if ($index->item_type == 'file' && isset($index->options['fields']['fid'])) {
+        $base[] = 'search_api_index_' . $machine_name;
+      }
+    }
+  }
+
+  // Display plugin.
+  $plugins['display']['media_browser'] = array(
+    'title' => t('Media browser tab'),
+    'help' => t('Display as a tab in the media browser.'),
+    'handler' => 'media_views_plugin_display_media_browser',
+    'theme' => 'views_view',
+    'base' => $base,
+    'use ajax' => TRUE,
+    'use pager' => TRUE,
+    'accept attachments' => TRUE,
+  );
+
+  // Style plugin.
+  $plugins['style']['media_browser'] = array(
+    'title' => t('Media browser'),
+    'help' => t('Displays rows as an HTML list.'),
+    'handler' => 'media_views_plugin_style_media_browser',
+    'theme' => 'media_views_view_media_browser',
+    'base' => $base,
+    'uses row plugin' => FALSE,
+    'uses row class' => FALSE,
+    'uses options' => FALSE,
+    'uses fields' => FALSE,
+    'type' => 'normal',
+    'help topic' => 'style-media-browser',
+  );
+  return $plugins;
+}
+
+/**
+ * Display the view as a media browser.
+ */
+function template_preprocess_media_views_view_media_browser(&$vars) {
+  module_load_include('inc', 'media', 'includes/media.browser');
+  // Load file objects for each View result.
+  $fids = array();
+  foreach ($vars['rows'] as $index => $row) {
+    // The Search API module returns the row in a slightly different format,
+    // so convert it to the format that the normal file_managed table returns.
+    if (!empty($row->entity->fid)) {
+      $vars['rows'][$index]->fid = $row->entity->fid;
+    }
+    $fids[$index] = $row->fid;
+  }
+  $files = file_load_multiple($fids);
+
+  // Render the preview for each file.
+  foreach ($vars['rows'] as $index => $row) {
+    $file = $files[$row->fid];
+    // Add url/preview to the file object.
+    media_browser_build_media_item($file);
+    $vars['rows'][$index] = $file;
+    $vars['rows'][$index]->preview = $file->preview;
+  }
+
+  // Add the files to JS so that they are accessible inside the browser.
+  drupal_add_js(array('media' => array('files' => array_values($files))), 'setting');
+
+  // Add the browser parameters to the settings and that this display exists.
+  drupal_add_js(array(
+    'media' => array(
+      'browser' => array(
+        'params' => media_get_browser_params(),
+        'views' => array(
+          $vars['view']->name => array(
+            $vars['view']->current_display,
+          ),
+        ),
+      ),
+    ),
+  ), 'setting');
+
+  // Add classes and wrappers from the style plugin.
+  $handler = $vars['view']->style_plugin;
+
+  $class = explode(' ', $handler->options['class']);
+  $class = array_map('drupal_clean_css_identifier', $class);
+
+  $wrapper_class = explode(' ', $handler->options['wrapper_class']);
+  $wrapper_class = array_map('drupal_clean_css_identifier', $wrapper_class);
+
+  $vars['class'] = implode(' ', $class);
+  $vars['wrapper_class'] = implode(' ', $wrapper_class);
+  $vars['wrapper_prefix'] = '<div class="' . implode(' ', $wrapper_class) . '">';
+  $vars['wrapper_suffix'] = '</div>';
+  $vars['list_type_prefix'] = '<' . $handler->options['type'] . ' id="media-browser-library-list" class="' . implode(' ', $class) . '">';
+  $vars['list_type_suffix'] = '</' . $handler->options['type'] . '>';
+
+  // Run theming variables through a standard Views preprocess function.
+  template_preprocess_views_view_unformatted($vars);
+
+  // Add media browser javascript and CSS.
+  drupal_add_js(drupal_get_path('module', 'media') . '/js/plugins/media.views.js');
+}
+
+/**
+ * Implements hook_views_invalidate_cache().
+ */
+function media_views_invalidate_cache() {
+  cache_clear_all('media:browser:plugin', 'cache', TRUE);
+  drupal_static_reset('media_get_browser_plugin_info');
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/MediaBrowserBulkUpload.inc b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/MediaBrowserBulkUpload.inc
new file mode 100644
index 0000000..9dbc983
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/MediaBrowserBulkUpload.inc
@@ -0,0 +1,30 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserBulkUpload.
+ */
+
+/**
+ * Media browser plugin for showing the bulk upload form.
+ *
+ * @deprecated
+ */
+class MediaBrowserBulkUpload extends MediaBrowserUpload {
+  /**
+   * Overrides MediaBrowserPlugin::view().
+   */
+  public function view() {
+    module_load_include('inc', 'file_entity', 'file_entity.pages');
+
+    $build = array();
+    if ($this->params['multiselect']) {
+      $build['form'] = drupal_get_form('file_entity_add_upload_multiple', $this->params);
+    }
+    else {
+      $build['form'] = drupal_get_form('file_entity_add_upload', $this->params);
+    }
+
+    return $build;
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.admin.inc b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.admin.inc
new file mode 100644
index 0000000..bc0b77f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.admin.inc
@@ -0,0 +1,155 @@
+<?php
+
+/**
+ * @file
+ * This file contains the admin functions for the Media Bulk Upload module.
+ */
+
+/**
+ * Form callback for mass import.
+ */
+function media_bulk_upload_import($form, &$form_state) {
+  if (!isset($form_state['storage']['files'])) {
+    $form_state['storage']['step'] = 'choose';
+    $form_state['storage']['next_step'] = 'preview';
+    $form['directory'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Directory'),
+      '#description' => t('Enter the absolute directory on the web server to look for files. Subdirectories inside this directory will not be scanned.'),
+      '#required' => TRUE,
+    );
+
+    $form['pattern'] = array(
+      '#type' => 'textarea',
+      '#title' => t('Pattern'),
+      '#description' => t("Only files matching these patterns will be imported. Enter one pattern per line. The '*' character is a wildcard. Example patterns are %png_example to import all PNG files.", array('%png_example' => '*.png')),
+      '#default_value' => '*',
+      '#required' => TRUE,
+    );
+
+    $form['actions'] = array('#type' => 'actions');
+    $form['actions']['submit'] = array(
+      '#type' => 'submit',
+      '#value' => t('Preview'),
+    );
+    $form['actions']['cancel'] = array(
+      '#type' => 'link',
+      '#title' => t('Cancel'),
+      '#href' => isset($_GET['destination']) ? $_GET['destination'] : 'admin/content/file',
+    );
+  }
+  else {
+    $form['preview'] = array(
+      '#markup' => theme('item_list', array('items' => $form_state['storage']['files'])),
+    );
+
+    $form = confirm_form($form, t('Import these files?'), 'admin/content/file/import');
+  }
+  return $form;
+
+}
+
+/**
+ * Validate handler for media_import().
+ */
+function media_bulk_upload_import_validate($form, &$form_state) {
+  if ($form_state['values']['op'] != t('Confirm')) {
+    $directory = $form_state['values']['directory'];
+    $pattern = $form_state['values']['pattern'];
+    if (!is_dir($directory)) {
+      form_set_error('directory', t('The provided directory does not exist.'));
+    }
+    if (!is_readable($directory)) {
+      form_set_error('directory', t('The provided directory is not readable.'));
+    }
+
+    $pattern_quoted = preg_quote($pattern, '/');
+    $pattern_quoted = preg_replace('/(\r\n?|\n)/', '|', $pattern_quoted);
+    $pattern_quoted = strtr($pattern_quoted, array(
+      '\\|' => '|',
+      '\\*' => '.*',
+      '\\?' => '.?',
+    ));
+    $files = file_scan_directory($directory, '/^(' . $pattern_quoted . ')$/', array('recurse' => FALSE));
+    $files = array_keys($files);
+    if (empty($files)) {
+      form_set_error('pattern', t('No files were found in %directory matching the regular expression %pattern', array('%directory' => $directory, '%pattern' => $pattern_quoted)));
+    }
+    $form_state['storage']['files'] = $files;
+  }
+}
+
+/**
+ * Submit handler for media_import().
+ */
+function media_bulk_upload_import_submit($form, &$form_state) {
+  if ($form_state['values']['op'] == t('Confirm')) {
+    $files = $form_state['storage']['files'];
+    $batch = array(
+      'title' => t('Importing'),
+      'operations' => array(
+        array('media_bulk_upload_import_batch_import_files', array($files)),
+      ),
+      'finished' => 'media_bulk_upload_import_batch_import_complete',
+      'file' => drupal_get_path('module', 'media_bulk_upload') . '/includes/media_bulk_upload.admin.inc',
+    );
+    batch_set($batch);
+    return;
+
+  }
+  $form_state['rebuild'] = TRUE;
+}
+
+/**
+ * BatchAPI callback op for media import.
+ */
+function media_bulk_upload_import_batch_import_files($files, &$context) {
+  if (!isset($context['sandbox']['files'])) {
+    // This runs the first time the batch runs.
+    // This is stupid, but otherwise, I don't think it will work...
+    $context['results'] = array('success' => array(), 'errors' => array());
+    $context['sandbox']['max'] = count($files);
+    $context['sandbox']['files'] = $files;
+  }
+  $files =& $context['sandbox']['files'];
+
+  // Take a cut of files.  Let's do 10 at a time.
+  $import_batch_size = variable_get('media_bulk_upload_import_batch_size', 20);
+  $length = (count($files) > $import_batch_size) ? $import_batch_size : count($files);
+  $to_process = array_splice($files, 0, $length);
+  $image_in_message = '';
+
+  foreach ($to_process as $file) {
+    try {
+      $file_obj = media_parse_to_file($file);
+      $context['results']['success'][] = $file;
+      if (!$image_in_message) {
+        // @todo Is this load step really necessary? When there's time, test
+        //   this, and either remove it, or comment why it's needed.
+        $loaded_file = file_load($file_obj->fid);
+        $image_in_message = file_view_file($loaded_file, 'preview');
+      }
+    }
+    catch (Exception $e) {
+      $context['results']['errors'][] = $file . " Reason: " . $e->getMessage();
+    }
+  }
+
+  $context['message'] = "Importing " . theme('item_list', array('items' => $to_process));
+  // Show the image that is being imported.
+  $context['message'] .= drupal_render($image_in_message);
+
+  $context['finished'] = ($context['sandbox']['max'] - count($files)) / $context['sandbox']['max'];
+}
+
+/**
+ * BatchAPI complete callback for media import.
+ */
+function media_bulk_upload_import_batch_import_complete($success, $results, $operations) {
+  if ($results['errors']) {
+    drupal_set_message(theme('item_list', array('items' => $results['errors'])), 'error');
+  }
+  if ($results['success']) {
+    drupal_set_message(theme('item_list', array('items' => $results['success'])));
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.pages.inc b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.pages.inc
new file mode 100644
index 0000000..50d0b56
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/includes/media_bulk_upload.pages.inc
@@ -0,0 +1,66 @@
+<?php
+
+/**
+ * @file
+ * Common pages for the Media Bulk Upload module.
+ */
+
+/**
+ * Menu callback; Edit multiple files on the same page using multiform module.
+ *
+ * @todo When http://drupal.org/node/1227706 is fixed, filter the $files
+ * array using file_access($file, 'edit').
+ *
+ * @see media_bulk_upload_file_operation_edit_multiple()
+ */
+function media_bulk_upload_file_page_edit_multiple($files) {
+  if (empty($files)) {
+    return MENU_ACCESS_DENIED;
+  }
+
+  $forms = array();
+  foreach ($files as $file) {
+    // To maintain unique form_ids, append the file id.
+    $forms[] = array('media_edit_' . $file->fid, $file);
+  }
+
+  $form = call_user_func_array('multiform_get_form', $forms);
+  $form['#attributes']['class'][] = 'media-bulk-upload-multiedit-form';
+
+  // Add the title to each 'subform'.
+  foreach (element_children($form['multiform']) as $key) {
+    $fid = $form['multiform'][$key]['fid']['#value'];
+    $file = $files[$fid];
+    $title = t('<em>Edit @type</em> @title', array('@type' => $file->type, '@title' => $file->filename));
+    $form['multiform'][$key]['#prefix'] = '<h2>' . $title . '</h2>';
+    $form['multiform'][$key]['actions']['#access'] = FALSE;
+  }
+
+  if (isset($form['buttons']['Delete'])) {
+    $form['buttons']['Delete']['#access'] = FALSE;
+  }
+
+  // Add a cancel button at the bottom of the form.
+  $form['buttons']['cancel'] = array(
+    '#type' => 'link',
+    '#title' => t('Cancel'),
+    '#weight' => 50,
+  );
+  if (isset($_GET['destination'])) {
+    $form['buttons']['cancel']['#href'] = $_GET['destination'];
+  }
+  else if (user_access('administer files')) {
+    $form['buttons']['cancel']['#href'] = 'admin/content/file';
+  }
+  else {
+    $form['buttons']['cancel']['#href'] = '<front>';
+  }
+
+  // Override the page title since each file form sets a title.
+  drupal_set_title(t('Edit multiple files'));
+
+  // Allow other modules to alter the form.
+  drupal_alter('media_bulk_upload_edit_multiple_form', $form);
+
+  return $form;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info
new file mode 100644
index 0000000..5171c67
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info
@@ -0,0 +1,18 @@
+name = Media Bulk Upload
+description = Adds support for uploading multiple files at a time.
+package = Media
+core = 7.x
+
+dependencies[] = media
+dependencies[] = multiform
+dependencies[] = plupload
+
+files[] = includes/MediaBrowserBulkUpload.inc
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.install b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.install
new file mode 100644
index 0000000..a7b0741
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.install
@@ -0,0 +1,14 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media Bulk Upload module.
+ */
+
+/**
+ * Implements hook_uninstall().
+ */
+function media_bulk_upload_uninstall() {
+  // Remove variables.
+  variable_del('media_bulk_upload_import_batch_size');
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.module b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.module
new file mode 100644
index 0000000..f0c7aed
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.module
@@ -0,0 +1,197 @@
+<?php
+
+/**
+ * @file
+ * Primarily Drupal hooks.
+ */
+
+/**
+ * Implements hook_menu().
+ */
+function media_bulk_upload_menu() {
+  $items['admin/content/file/import'] = array(
+    'title' => 'Import files',
+    'description' => 'Import files into your media library.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_bulk_upload_import'),
+    'access arguments' => array('import media'),
+    'type' => MENU_LOCAL_ACTION,
+    'file' => 'includes/media_bulk_upload.admin.inc',
+    'weight' => 10,
+  );
+  $items['admin/content/file/thumbnails/import'] = $items['admin/content/file/import'];
+
+  // @todo Investigate passing file IDs in query string rather than a menu
+  // argument and then deprecate media_multi_load().
+  $items['admin/content/file/edit-multiple/%media_bulk_upload_multi'] = array(
+    'title' => 'Edit multiple files',
+    'page callback' => 'media_bulk_upload_file_page_edit_multiple',
+    'page arguments' => array(4),
+    'access callback' =>  '_media_bulk_upload_file_entity_access_recursive',
+    'access arguments' => array(4, 'update'),
+    'file' => 'includes/media_bulk_upload.pages.inc',
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_permission().
+ */
+function media_bulk_upload_permission() {
+  return array(
+    'import media' => array(
+      'title' => t('Import media files from the local filesystem'),
+      'description' => t('Simple file importer'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_media_browser_plugin_info_alter().
+ */
+function media_bulk_upload_media_browser_plugin_info_alter(&$info) {
+  $info['upload']['class'] = 'MediaBrowserBulkUpload';
+}
+
+/**
+ * Implements hook_file_operations().
+ */
+function media_bulk_upload_file_operations() {
+  return array(
+    'edit_multiple' => array(
+      'label' => t('Edit selected files'),
+      'callback' => 'media_bulk_upload_file_operation_edit_multiple',
+    ),
+  );
+}
+
+/**
+ * Implements hook_form_alter().
+ */
+function media_bulk_upload_form_alter(&$form, &$form_state, $form_id) {
+  // If we're in the media browser, set the #media_browser key to true
+  // so that if an ajax request gets sent to a different path, the form
+  // still uses the media_browser_form_submit callback.
+  if (current_path() == 'media/browser' && $form_id != 'views_exposed_form') {
+    $form_state['#media_browser'] = TRUE;
+  }
+
+  // If the #media_browser key isset and is true we are using the browser
+  // popup, so add the media_browser submit handler.
+  if (!empty($form_state['#media_browser'])) {
+    $form['#submit'][] = 'media_bulk_upload_browser_form_submit';
+  }
+}
+
+/**
+ * Submit handler; direction form submissions in the media browser.
+ */
+function media_bulk_upload_browser_form_submit($form, &$form_state) {
+  $url = NULL;
+  $parameters = array();
+
+  // Multi upload.
+  if (!empty($form_state['files'])) {
+    $files = $form_state['files'];
+    $url = 'media/browser';
+    $parameters = array('query' => array('render' => 'media-popup', 'fid' => array_keys($files)));
+  }
+
+  // If $url is set, we had some sort of upload, so redirect the form.
+  if (!empty($url)) {
+    $form_state['redirect'] = array($url, $parameters);
+  }
+}
+
+/**
+ * Return a URL for editing an files.
+ *
+ * Works with an array of fids or a single fid.
+ *
+ * @param mixed $fids
+ *   An array of file IDs or a single file ID.
+ */
+function media_bulk_upload_file_edit_url($fids) {
+  if (!is_array($fids)) {
+    $fids = array($fids);
+  }
+
+  if (count($fids) > 1) {
+    return 'admin/content/file/edit-multiple/' . implode(' ', $fids);
+  }
+  else {
+    return 'file/' . reset($fids) . '/edit';
+  }
+}
+
+/**
+ * Callback for the edit operation.
+ *
+ * Redirects the user to the edit multiple files page.
+ *
+ * @param array $fids
+ *   An array of file IDs.
+ *
+ * @see media_file_page_edit_multiple()
+ */
+function media_bulk_upload_file_operation_edit_multiple($fids) {
+  // The thumbnail browser returns TRUE/FALSE for each item, so use array keys.
+  $fids = array_keys(array_filter($fids));
+  drupal_goto(media_bulk_upload_file_edit_url($fids), array('query' => drupal_get_destination()));
+}
+
+/**
+ * Implements hook_forms().
+ */
+function media_bulk_upload_forms($form_id, $args) {
+  $forms = array();
+  // To support the multiedit form, each form has to have a unique ID.
+  // So we name all the forms media_edit_N where the first requested form is
+  // media_edit_0, 2nd is media_edit_1, etc.
+  module_load_include('inc', 'file_entity', 'file_entity.pages');
+  if ($form_id != 'media_edit' && (strpos($form_id, 'media_edit') === 0)) {
+    $forms[$form_id] = array(
+      'callback' => 'file_entity_edit',
+    );
+  }
+  return $forms;
+}
+
+/**
+ * Access callback for the media-multi form.
+ *
+ * @param $files
+ *   An array of files being editing on the multiform.
+ * @param $op
+ *   A string containing the operation requested, such as 'update'.
+ * @return
+ *   TRUE if the current user has access to edit all of the files, otherwise FALSE.
+ */
+function _media_bulk_upload_file_entity_access_recursive($files, $op) {
+  // Check that the current user can access each file.
+  if (!empty($files)) {
+    foreach ($files as $file) {
+      if (!file_entity_access($op, $file)) {
+        return FALSE;
+      }
+    }
+    return TRUE;
+  }
+  return FALSE;
+}
+
+/**
+ * Load callback for %media_multi placeholder in menu paths.
+ *
+ * @param string $fids
+ *   Separated by space (e.g., "3 6 12 99"). This often appears as "+" within
+ *   URLs (e.g., "3+6+12+99"), but Drupal automatically decodes paths when
+ *   intializing $_GET['q'].
+ *
+ * @return array
+ *   An array of corresponding file entities.
+ */
+function media_bulk_upload_multi_load($fids) {
+  return file_load_multiple(explode(' ', $fids));
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaBrowserInternet.inc b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaBrowserInternet.inc
new file mode 100644
index 0000000..919108f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaBrowserInternet.inc
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaBrowserInternet.
+ */
+
+/**
+ * Media browser plugin for Media Internet sources.
+ */
+class MediaBrowserInternet extends MediaBrowserPlugin {
+  /**
+   * Implements MediaBrowserPluginInterface::access().
+   */
+  public function access($account = NULL) {
+    return media_internet_access($account);
+  }
+
+  /**
+   * Implements MediaBrowserPlugin::view().
+   */
+  public function view() {
+    module_load_include('inc', 'media_internet', 'media_internet.pages');
+    $build['form'] = drupal_get_form('media_internet_add', $this->params['types'], $this->params['multiselect']);
+    return $build;
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetBaseHandler.inc b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetBaseHandler.inc
new file mode 100644
index 0000000..abd71d5
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetBaseHandler.inc
@@ -0,0 +1,77 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaInternetBaseHandler.
+ */
+
+/**
+ * A base class for managing the addition of Internet media.
+ *
+ * Classes extending this class manage the addition of Internet media. To
+ * achieve this, the class should parse user-submitted embed code, claim it
+ * when appropriate and save it as a managed file.
+ */
+abstract class MediaInternetBaseHandler {
+
+  /**
+   * The constructor for the MediaInternetBaseHandler class. This method is also called
+   * from the classes that extend this class and override this method.
+   */
+  public function __construct($embedCode) {
+    $this->embedCode = $embedCode;
+  }
+
+  /**
+   * Determines if this handler should claim the item.
+   *
+   * @param string $embed_code
+   *   A string of user-submitted embed code.
+   *
+   * @return boolean
+   *   Pass TRUE to claim the item.
+   */
+  abstract public function claim($embed_code);
+
+  /**
+   * Returns a file object which can be used for validation.
+   *
+   * @return StdClass
+   */
+  abstract public function getFileObject();
+
+  /**
+   * If required, implementors can validate the embedCode.
+   */
+  public function validate() {
+  }
+
+  /**
+   * Before the file has been saved, implementors may do additional operations.
+   *
+   * @param object $file_obj
+   */
+  public function preSave(&$file_obj) {
+  }
+
+  /**
+   * Saves a file to the file_managed table (with file_save).
+   *
+   * @return StdClass
+   */
+  public function save() {
+    $file_obj = $this->getFileObject();
+    $this->preSave($file_obj);
+    file_save($file_obj);
+    $this->postSave($file_obj);
+    return $file_obj;
+  }
+
+  /**
+   * After the file has been saved, implementors may do additional operations.
+   *
+   * @param object $file_obj
+   */
+  public function postSave(&$file_obj) {
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetFileHandler.inc b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetFileHandler.inc
new file mode 100644
index 0000000..c5b65cf
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetFileHandler.inc
@@ -0,0 +1,67 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaInternetFileHandler.
+ */
+
+/**
+ * A class for managing the addition of Internet files.
+ */
+class MediaInternetFileHandler extends MediaInternetBaseHandler {
+
+  public $fileObject;
+
+  public function preSave(&$file_obj) {
+    // Coppies the remote file locally.
+    $remote_uri = $file_obj->uri;
+    //@TODO: we should follow redirection here an save the final filename, not just the basename.
+    $local_filename = basename($remote_uri);
+    $local_filename = file_munge_filename($local_filename, variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'), FALSE);
+    $local_uri = file_stream_wrapper_uri_normalize('temporary://' . $local_filename);
+    if (!@copy($remote_uri, $local_uri)) {
+      throw new Exception('Unable to add file ' . $remote_uri);
+      return;
+    }
+    // Make the current fileObject point to the local_uri, not the remote one.
+    $file_obj = file_uri_to_object($local_uri);
+  }
+
+  public function postSave(&$file_obj) {
+    $scheme = variable_get('file_default_scheme', 'public') . '://';
+    module_load_include('inc', 'file_entity', 'file_entity.pages');
+    $destination_uri = file_entity_upload_destination_uri(array());
+    $uri = file_stream_wrapper_uri_normalize($destination_uri . '/' . $file_obj->filename);
+    // Now to its new home.
+    $file_obj = file_move($file_obj, $uri, FILE_EXISTS_RENAME);
+  }
+
+  public function getFileObject() {
+    if (!$this->fileObject) {
+      $this->fileObject = file_uri_to_object($this->embedCode);
+    }
+    return $this->fileObject;
+  }
+
+  public function claim($embedCode) {
+    // Claim only valid URLs using a supported scheme.
+    if (!valid_url($embedCode, TRUE) || !in_array(file_uri_scheme($embedCode), variable_get('media_fromurl_supported_schemes', array('http', 'https', 'ftp', 'smb', 'ftps')))) {
+      return FALSE;
+    }
+
+    // This handler is intended for regular files, so don't claim URLs
+    // containing query strings or fragments.
+    if (preg_match('/[\?\#]/', $embedCode)) {
+      return FALSE;
+    }
+
+    // Since this handler copies the remote file to the local web server, do not
+    // claim a URL with an extension disallowed for media uploads.
+    $regex = '/\.(' . preg_replace('/ +/', '|', preg_quote(variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'))) . ')$/i';
+    if (!preg_match($regex, basename($embedCode))) {
+      return FALSE;
+    }
+
+    return TRUE;
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetNoHandlerException.inc b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetNoHandlerException.inc
new file mode 100644
index 0000000..5a199cc
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetNoHandlerException.inc
@@ -0,0 +1,13 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaInternetNoHandlerException.
+ */
+
+/**
+ * A custom exception class for handling embed code with no handler.
+ */
+class MediaInternetNoHandlerException extends Exception {
+
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetValidationException.inc b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetValidationException.inc
new file mode 100644
index 0000000..36322b3
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/includes/MediaInternetValidationException.inc
@@ -0,0 +1,13 @@
+<?php
+
+/**
+ * @file
+ * Definition of MediaInternetValidationException.
+ */
+
+/**
+ * A custom exception class for handling file validation errors.
+ */
+class MediaInternetValidationException extends Exception {
+
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.api.php b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.api.php
new file mode 100644
index 0000000..75548f6
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.api.php
@@ -0,0 +1,25 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by the media_internet module.
+ */
+
+/**
+ * Implements hook_media_internet_providers().
+ *
+ * Implementors return an multidim array, keyed by a class name with the
+ * following elements:
+ * - title
+ * - image (optional)
+ * - hidden: bool If the logo should be shown on form. (optional)
+ * - weight (optional)
+ */
+function hook_media_internet_providers() {
+  return array(
+    'youtube' => array(
+      'title' => 'youtube',
+      'image' => 'youtube.jpg',
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info
new file mode 100644
index 0000000..74b43d9
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info
@@ -0,0 +1,20 @@
+name = Media Internet Sources
+description = Provides an API for accessing media on various internet services
+package = Media
+core = 7.x
+
+dependencies[] = media
+
+files[] = includes/MediaBrowserInternet.inc
+files[] = includes/MediaInternetBaseHandler.inc
+files[] = includes/MediaInternetFileHandler.inc
+files[] = includes/MediaInternetNoHandlerException.inc
+files[] = includes/MediaInternetValidationException.inc
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.install b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.install
new file mode 100644
index 0000000..03264d4
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.install
@@ -0,0 +1,21 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media Internet module.
+ */
+
+/**
+ * Implements hook_uninstall().
+ */
+function media_internet_uninstall() {
+  // Remove variables.
+  variable_del('media_internet_fromurl_supported_schemes');
+}
+
+/**
+ * Rebuild the registry in order to accommodate moved classes.
+ */
+function media_internet_update_7000() {
+  registry_rebuild();
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.media.inc b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.media.inc
new file mode 100644
index 0000000..33f9539
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.media.inc
@@ -0,0 +1,35 @@
+<?php
+
+/**
+ * @file
+ * Media module integration for the Media internet module.
+ */
+
+/**
+ * Implements hook_media_browser_plugin_info().
+ */
+function media_internet_media_browser_plugin_info() {
+  $info['media_internet'] = array(
+    'title' => t('Web'),
+    'class' => 'MediaBrowserInternet',
+  );
+
+  return $info;
+}
+
+/**
+ * Implements hook_media_internet_providers().
+ *
+ * Provides a very basic handler which copies files from remote sources to the
+ * local files directory.
+ */
+function media_internet_media_internet_providers() {
+  return array(
+    'MediaInternetFileHandler' => array(
+      'title' => 'Files',
+      'hidden' => TRUE,
+      // Make it go last.
+      'weight' => 10000,
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.module b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.module
new file mode 100644
index 0000000..90c1231
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.module
@@ -0,0 +1,103 @@
+<?php
+
+/**
+ * Implements hook_hook_info().
+ */
+function media_internet_hook_info() {
+  $hooks = array(
+    'media_internet_providers',
+  );
+
+  return array_fill_keys($hooks, array('group' => 'media'));
+}
+
+/**
+ * Implements hook_menu().
+ */
+function media_internet_menu() {
+  $items['file/add/web'] = array(
+    'title' => 'Web',
+    'description' => 'Add internet files to your media library.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_internet_add'),
+    'access callback' => 'media_internet_access',
+    'type' => MENU_LOCAL_TASK,
+    'file' => 'media_internet.pages.inc',
+  );
+
+  return $items;
+}
+
+/**
+ * Access callback for the media_internet media browser plugin.
+ */
+function media_internet_access($account = NULL) {
+  return user_access('administer files', $account) || user_access('add media from remote sources', $account);
+}
+
+/**
+ * Implement hook_permission().
+ */
+function media_internet_permission() {
+  return array(
+    'add media from remote sources' => array(
+      'title' => t('Add media from remote services'),
+      'description' => t('Add media from remote sources such as other websites, YouTube, etc'),
+    ),
+  );
+}
+
+/**
+ * Gets the list of providers.
+ *
+ * A "Provider" is a bit of meta-data like a title and a logo and a class which
+ * can handle saving remote files.  Each provider is able to parse an embed code or URL
+ * and store it as a file object in file_managed.
+ */
+function media_internet_get_providers() {
+  $providers = &drupal_static(__FUNCTION__);
+
+  if (!isset($providers)) {
+    $cid = 'media:internet:providers';
+    if ($cache = cache_get($cid)) {
+      $providers = $cache->data;
+    }
+    else {
+      $providers = array();
+      foreach (module_implements('media_internet_providers') as $module) {
+        foreach (module_invoke($module, 'media_internet_providers') as $key => $provider) {
+          // Store the module here too for convinience.
+          $providers[$key] = $provider;
+          $providers[$key]['module'] = $module;
+          if (!isset($providers[$key]['weight'])) {
+            $providers[$key]['weight'] = 0;
+          }
+        }
+      }
+      uasort($providers, 'drupal_sort_weight');
+      cache_set($cid, $providers);
+    }
+  }
+
+  return $providers;
+}
+
+/**
+ * Finds the appropriate provider for a given URL or embed_string
+ *
+ * Each provider has a claim() method which it uses to tell media_internet
+ * that it should handle this input.  We cycle through all providers to find
+ * the right one.
+ *
+ * @todo: Make this into a normal hook or something because we have to instantiate
+ * each class to test and that's not right.
+ */
+function media_internet_get_provider($embed_string) {
+  foreach (media_internet_get_providers() as $class_name => $nothing) {
+    $p = new $class_name($embed_string);
+    if ($p->claim($embed_string)) {
+      return $p;
+    }
+  }
+  throw new MediaInternetNoHandlerException(t('Unable to handle the provided embed string or URL.'));
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.pages.inc b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.pages.inc
new file mode 100644
index 0000000..2ec2307
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.pages.inc
@@ -0,0 +1,185 @@
+<?php
+
+/**
+ * @file
+ * Supports the addition of Internet media.
+ */
+
+/**
+ * Provides a form for adding media items from 3rd party sources.
+ *
+ * @todo Convert the form arguments to just one array of options/parameters.
+ */
+function media_internet_add($form, &$form_state = array(), $types = NULL) {
+  $form['embed_code'] = array(
+    '#type' => 'textfield',
+    '#title' => t('File URL'),
+    '#description' => t('Enter a URL to a file.'),
+    '#attributes' => array('class' => array('media-add-from-url')),
+    // There is no standard specifying a maximum length for a URL. Internet
+    // Explorer supports up to 2083 (http://support.microsoft.com/kb/208427)
+    // so we assume publicly available media URLs are within this limit.
+    '#maxlength' => 2083,
+    '#required' => TRUE,
+  );
+
+  // Create an array to hold potential Internet media providers.
+  $providers = array();
+
+  // Determine if there are any visible providers.
+  foreach (media_internet_get_providers() as $key => $provider) {
+    if (empty($provider['hidden']) || $provider['hidden'] != TRUE) {
+      $providers[] = array(
+        'data' => check_plain($provider['title']),
+        'class' => array(drupal_html_class($provider['title'])),
+      );
+    }
+  }
+
+  // Notify the user of any available providers.
+  if ($providers) {
+    // If any providers are enabled it is assumed that some kind of embed is supported.
+    $form['embed_code']['#title'] = t('File URL or media resource');
+    $form['embed_code']['#description'] = t('Enter a URL to a file or media resource. Many media providers also support identifying media via the embed code used to embed the media into external websites.');
+
+    // Providers are displayed in an unordered list below the embed input.
+    // Providers can easily style their own listing by targeting the unique
+    // class assigned to each list item.
+    $form['providers'] = array(
+      '#theme' => 'item_list',
+      '#title' => t('Supported providers'),
+      '#items' => $providers,
+      '#attributes' => array(
+        'class' => array('media-internet-providers'),
+      ),
+    );
+  }
+
+  $form['#validators'] = array();
+  if ($types) {
+    $form['#validators']['media_file_validate_types'] = array($types);
+  }
+
+  $form['actions'] = array(
+    '#type' => 'actions',
+  );
+  $form['actions']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Submit'),
+  );
+
+  return $form;
+}
+
+/**
+ * Allow stream wrappers to have their chance at validation.
+ *
+ * Any module that implements hook_media_parse will have an
+ * opportunity to validate this.
+ *
+ * @see media_parse_to_uri()
+ */
+function media_internet_add_validate($form, &$form_state) {
+  // Supporting providers can now claim this input. It might be a URL, but it
+  // might be an embed code as well.
+  $embed_code = $form_state['values']['embed_code'];
+
+  try {
+    $provider = media_internet_get_provider($embed_code);
+    $provider->validate();
+  }
+  catch (MediaInternetNoHandlerException $e) {
+    form_set_error('embed_code', $e->getMessage());
+    return;
+  }
+  catch (MediaInternetValidationException $e) {
+    form_set_error('embed_code', $e->getMessage());
+    return;
+  }
+
+  $validators = $form['#validators'];
+  $file = $provider->getFileObject();
+
+  if ($validators) {
+    try {
+      $file = $provider->getFileObject();
+    }
+    catch (Exception $e) {
+      form_set_error('embed_code', $e->getMessage());
+      return;
+    }
+
+    // Check for errors. @see media_add_upload_validate calls file_save_upload().
+    // this code is ripped from file_save_upload because we just want the validation part.
+    // Call the validation functions specified by this function's caller.
+    $errors = file_validate($file, $validators);
+
+    if (!empty($errors)) {
+      $message = t('%url could not be added.', array('%url' => $embed_code));
+      if (count($errors) > 1) {
+        $message .= theme('item_list', array('items' => $errors));
+      }
+      else {
+        $message .= ' ' . array_pop($errors);
+      }
+      form_set_error('embed_code', $message);
+      return FALSE;
+    }
+  }
+
+  // @TODO: Validate that if we have no $uri that this is a valid file to
+  // save. For instance, we may only be interested in images, and it would
+  // be helpful to let the user know they passed the HTML page containing
+  // the image accidentally. That would also save us from saving the file
+  // in the submit step.
+
+  // This is kinda a hack of the same.
+
+  // This should use the file_validate routines that the upload form users.
+  // We need to fix the media_parse_to_file routine to allow for a validation.
+}
+
+/**
+ * Upload a file from a URL.
+ *
+ * This will copy a file from a remote location and store it locally.
+ *
+ * @see media_parse_to_uri()
+ * @see media_parse_to_file()
+ */
+function media_internet_add_submit($form, &$form_state) {
+  $embed_code = $form_state['values']['embed_code'];
+
+  try {
+    // Save the remote file
+    $provider = media_internet_get_provider($embed_code);
+    // Providers decide if they need to save locally or somewhere else.
+    // This method returns a file object
+    $file = $provider->save();
+  }
+  catch (Exception $e) {
+    form_set_error('embed_code', $e->getMessage());
+    return;
+  }
+
+  if (!$file->fid) {
+    form_set_error('embed_code', t('The file %file could not be saved. An unknown error has occurred.', array('%file' => $embed_code)));
+    return;
+  }
+  else {
+    $form_state['file'] = $file;
+  }
+
+  // Redirect to the file edit page after submission.
+  if (file_entity_access('update', $file)) {
+    $destination = array('destination' => 'admin/content/file');
+    if (isset($_GET['destination'])) {
+      $destination = drupal_get_destination();
+      unset($_GET['destination']);
+    }
+    $form_state['redirect'] = array('file/' . $file->fid . '/edit', array('query' => $destination));
+  }
+  else {
+    $form_state['redirect'] = 'admin/content/file';
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/includes/media_migrate_file_types.pages.inc b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/includes/media_migrate_file_types.pages.inc
new file mode 100644
index 0000000..d7ad4d6
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/includes/media_migrate_file_types.pages.inc
@@ -0,0 +1,199 @@
+<?php
+
+/**
+ * @file
+ * Common pages for the Media Migrate File Types module.
+ */
+
+/**
+ * File type migration page.
+ *
+ * Allows site administrator to execute migration of old/disabled/deleted
+ * file types to new ones.
+ */
+function media_migrate_file_types_upgrade_file_types($form, &$form_state) {
+  $migratable_types = _media_migrate_file_types_get_migratable_file_types();
+
+  // Silently return if there are no file types that need migration.
+  if (empty($migratable_types)) {
+    return array(
+      'message' => array(
+        '#markup' => t('There are no file types that need migration. The Media Medigrate File Types module can now be safely <a href="@modules">disabled</a>.', array('@modules' => url('admin/modules'))),
+      ),
+    );
+  }
+
+  $form['message'] = array(
+    'message' => array(
+      '#markup' => t('This page allows you to migrate deprecated and/or disabled file types to new ones. It will migrate files from old type to new one and optionally migrate fields and delete old type.'),
+    ),
+  );
+
+  $form['migrate_fields'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Migrate fields'),
+    '#default_value' => TRUE,
+    '#description' => t('Migrate fields and their values from old file types to new ones.'),
+  );
+  $form['delete_old_type'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Delete old type'),
+    '#default_value' => FALSE,
+    '#description' => t('Delete old file type if migration was successful and delete operation is possible (type is not exported in code).'),
+  );
+  $form['migrate_mimes'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Migrate type mime-type'),
+    '#default_value' => TRUE,
+    '#description' => t('Move mime-type from old type to new one.'),
+  );
+
+  $form['upgradable_types'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Upgradable file types'),
+  );
+
+  $options = array('- ' . t('Do not upgrade') . ' -');
+  foreach (file_type_get_enabled_types() as $type) {
+    $options[$type->type] = $type->label;
+  }
+
+  foreach ($migratable_types as $machine_name) {
+    $type = file_type_load($machine_name);
+    if (!$type) {
+      $type = new stdClass;
+      $type->label = $type->type = $machine_name;
+    }
+    $form['upgradable_types'][$machine_name] = array(
+      '#type' => 'select',
+      '#title' => $type->label,
+      '#options' => $options,
+      '#description' => t(
+        'Select file type which you want to migrate @type to. Select %no_upgrade if type should stay as it is.',
+        array('@type' => $type->label, '%no_upgrade' => '- ' . t('Do not upgrade') . ' -')),
+    );
+  }
+
+  $form['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Start migraton'),
+  );
+
+  return $form;
+}
+
+/**
+ * File type migration page submit handler.
+ */
+function media_migrate_file_types_upgrade_file_types_submit($form, &$form_state) {
+  $migratable_types = _media_migrate_file_types_get_migratable_file_types();
+  $migrate = FALSE;
+  foreach ($migratable_types as $type) {
+    if ($form_state['values'][$type]) {
+      $migrate = TRUE;
+      break;
+    }
+  }
+
+  // Return silently if no types were selected for migration.
+  if (!$migrate) {
+    return;
+  }
+
+  // Use confirmation page/form.
+  $query = $form_state['values'];
+  unset($query['op']);
+  unset($query['submit']);
+  unset($query['form_id']);
+  unset($query['form_token']);
+  unset($query['form_build_id']);
+
+  $form_state['redirect'] = array(
+    'admin/structure/file-types/upgrade/confirm',
+    array('query' => $query),
+  );
+}
+
+/**
+ * File types migration confirmation page.
+ */
+function media_migrate_file_types_upgrade_file_types_confirm($form, &$form_state) {
+  return confirm_form(
+    $form,
+    t('Do you really want to migrate selected file types?'),
+    'admin/structure/file-types/upgrade',
+    NULL,
+    t('Migrate')
+  );
+}
+
+/**
+ * File types migration confirmation page submit. Executes actual migration.
+ */
+function media_migrate_file_types_upgrade_file_types_confirm_submit($form, &$form_state) {
+  $migratable_types = _media_migrate_file_types_get_migratable_file_types();
+  foreach ($migratable_types as $type) {
+    if ($_GET[$type] && $bundle_new = file_type_load($_GET[$type])) {
+      // Old bundle might be deleted so let's fake some values.
+      $bundle_old = file_type_load($type);
+      if (empty($bundle_old)) {
+        $bundle_old = new stdClass;
+        $bundle_old->type = $type;
+        $bundle_old->mimetypes = array();
+        $bundle_old->export_type = 2;
+      }
+
+      // Migrate fields to new bundle.
+      if ($_GET['migrate_fields']) {
+        $old_fields = db_select('field_config_instance', 'fc')->fields('fc', array('field_name'))->condition('entity_type',  'file')->condition('bundle', $bundle_old->type)->execute()->fetchCol();
+        $new_fields = db_select('field_config_instance', 'fc')->fields('fc', array('field_name'))->condition('entity_type',  'file')->condition('bundle', $bundle_new->type)->execute()->fetchCol();
+        $fields_to_move = array_diff($old_fields, $new_fields);
+        $fields_to_drop = array_diff($old_fields, $fields_to_move);
+
+        db_update('field_config_instance')
+          ->fields(array('bundle' => $bundle_new->type))
+          ->condition('entity_type',  'file')
+          ->condition('bundle', $bundle_old->type)
+          ->condition('field_name', $fields_to_move, 'IN')
+          ->execute();
+
+        db_delete('field_config_instance')
+          ->condition('entity_type',  'file')
+          ->condition('bundle', $bundle_old->type)
+          ->condition('field_name', $fields_to_drop, 'IN')
+          ->execute();
+
+        field_cache_clear();
+        module_invoke_all('field_attach_rename_bundle', 'file', $bundle_old->type, $bundle_new->type);
+      }
+
+      // Migrate mimetypes to new bundle.
+      if ($_GET['migrate_mimes']) {
+        $changed = FALSE;
+        foreach ($bundle_old->mimetypes as $mime) {
+          if (!file_entity_match_mimetypes($bundle_new->mimetypes, $mime)) {
+            $bundle_new->mimetypes[] = $mime;
+            $changed = TRUE;
+          }
+        }
+
+        if ($changed) {
+          file_type_save($bundle_new);
+        }
+      }
+
+      // Delete old bundle.
+      if ($_GET['delete_old_type'] && $bundle_old->export_type == 1) {
+        file_type_delete($bundle_old);
+      }
+
+      // Migrate files.
+      db_update('file_managed')
+        ->fields(array('type' => $bundle_new->type))
+        ->condition('type', $bundle_old->type)
+        ->execute();
+    }
+  }
+
+  $form_state['redirect'] = 'admin/structure/file-types';
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info
new file mode 100644
index 0000000..552bfaa
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info
@@ -0,0 +1,17 @@
+name = Media Migrate File Types
+description = Provides a UI for updating legacy media types with the new file types provided by File Entity.
+package = Media
+core = 7.x
+hidden = TRUE
+
+dependencies[] = media
+
+configure = admin/structure/file-types/upgrade
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.module b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.module
new file mode 100644
index 0000000..c9c6d46
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.module
@@ -0,0 +1,73 @@
+<?php
+
+/**
+ * @file
+ * Primarily Drupal hooks.
+ */
+
+/*
+ * Implements hook_system_info_alter()
+ */
+function media_migrate_file_types_system_info_alter(&$info, $file, $type) {
+  if ($type == 'module' && $file->name == 'media_migrate_file_types') {
+    $info['hidden'] = FALSE;
+  }
+}
+
+/**
+ * Implements hook_menu().
+ */
+function media_migrate_file_types_menu() {
+  $items['admin/structure/file-types/upgrade'] = array(
+    'title' => 'Upgrade types',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_migrate_file_types_upgrade_file_types'),
+    'access arguments' => array('administer file types'),
+    'file' => 'includes/media_migrate_file_types.pages.inc',
+    'type' => MENU_CALLBACK,
+  );
+  $items['admin/structure/file-types/upgrade/confirm'] = array(
+    'title' => 'Upgrade types',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_migrate_file_types_upgrade_file_types_confirm'),
+    'access arguments' => array('administer file types'),
+    'file' => 'includes/media_migrate_file_types.pages.inc',
+    'type' => MENU_CALLBACK,
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_help().
+ */
+function media_migrate_file_types_help($path, $arg) {
+  switch ($path) {
+    case 'admin/structure/file-types':
+      if (_media_migrate_file_types_get_migratable_file_types()) {
+        drupal_set_message(t('There are disabled/deleted file types that can be migrated to their new alternatives. Visit <a href="!url">migration page</a> to get more information.', array('!url' => url('admin/structure/file-types/upgrade'))));
+      }
+      break;
+  }
+}
+
+/**
+ * Checks if there are any files that belong to disabled or deleted file
+ * types.
+ *
+ * @return Array of file types (machine names) that are candidates for
+ *   migration.
+ */
+function _media_migrate_file_types_get_migratable_file_types() {
+  $query = db_select('file_managed', 'f')
+    ->fields('f', array('type'))
+    ->distinct();
+  $types = $query->execute()->fetchCol();
+
+  $enabled_types = array();
+  foreach (file_type_get_enabled_types() as $type) {
+    $enabled_types[] = $type->type;
+  }
+
+  return array_diff($types, $enabled_types);
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/css/media_wysiwyg.css b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/css/media_wysiwyg.css
new file mode 100644
index 0000000..7b6f019
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/css/media_wysiwyg.css
@@ -0,0 +1,20 @@
+/**
+ * @file
+ * Styles for the format form.
+ *
+ * The display and layout of the Media browser assumes Drupal's Seven theme as
+ * the theme active when this is displayed.
+ */
+
+#media-wysiwyg-format-form {
+  margin: 20px;
+}
+
+#media-wysiwyg-format-form .media-item {
+  float: left;
+  margin-right: 10px;
+}
+
+#media-wysiwyg-format-form .form-item-format label {
+  display: inline;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/images/wysiwyg-media.gif b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/images/wysiwyg-media.gif
new file mode 100644
index 0000000..495e71d
Binary files /dev/null and b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/images/wysiwyg-media.gif differ
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.file_usage.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.file_usage.inc
new file mode 100644
index 0000000..cbc1e84
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.file_usage.inc
@@ -0,0 +1,179 @@
+<?php
+
+/**
+ * @file
+ * Functions related to the tracking the file usage of embedded media.
+ */
+
+/**
+ * Implements hook_field_attach_insert().
+ *
+ * Track file usage for media files included in formatted text. Note that this
+ * is heavy-handed, and should be replaced when Drupal's filter system is
+ * context-aware.
+ */
+function media_wysiwyg_field_attach_insert($entity_type, $entity) {
+  _media_wysiwyg_filter_add_file_usage_from_fields($entity_type, $entity);
+}
+
+/**
+ * Implements hook_field_attach_update().
+ *
+ * @see media_field_attach_insert().
+ */
+function media_wysiwyg_field_attach_update($entity_type, $entity) {
+  _media_wysiwyg_filter_add_file_usage_from_fields($entity_type, $entity);
+}
+
+/**
+ * Add file usage from file references in an entity's text fields.
+ */
+function _media_wysiwyg_filter_add_file_usage_from_fields($entity_type, $entity) {
+  // Track the total usage for files from all fields combined.
+  $entity_files = media_wysiwyg_entity_field_count_files($entity_type, $entity);
+
+  list($entity_id, $entity_vid, $entity_bundle) = entity_extract_ids($entity_type, $entity);
+
+  // When an entity has revisions and then is saved again NOT as new version the
+  // previous revision of the entity has be loaded to get the last known good
+  // count of files. The saved data is compared against the last version
+  // so that a correct file count can be created for that (the current) version
+  // id. This code may assume some things about entities that are only true for
+  // node objects. This should be reviewed.
+  // @TODO this conditional can probably be condensed
+  if (empty($entity->revision) && empty($entity->old_vid) && empty($entity->is_new) && ! empty($entity->original)) {
+    $old_files = media_wysiwyg_entity_field_count_files($entity_type, $entity->original);
+    foreach ($old_files as $fid => $old_file_count) {
+      // Were there more files on the node just prior to saving?
+      if (empty($entity_files[$fid])) {
+        $entity_files[$fid] = 0;
+      }
+      if ($old_file_count > $entity_files[$fid]) {
+        $deprecate = $old_file_count - $entity_files[$fid];
+        // Now deprecate this usage
+        $file = file_load($fid);
+        if ($file) {
+          file_usage_delete($file, 'media', $entity_type, $entity_id, $deprecate);
+        }
+        // Usage is deleted, nothing more to do with this file
+        unset($entity_files[$fid]);
+      }
+      // There are the same number of files, nothing to do
+      elseif ($entity_files[$fid] ==  $old_file_count) {
+        unset($entity_files[$fid]);
+      }
+      // There are more files now, adjust the difference for the greater number.
+      // file_usage incrementing will happen below.
+      else {
+        // We just need to adjust what the file count will account for the new
+        // images that have been added since the increment process below will
+        // just add these additional ones in
+        $entity_files[$fid] = $entity_files[$fid] - $old_file_count;
+      }
+    }
+  }
+
+  // Each entity revision counts for file usage. If versions are not enabled
+  // the file_usage table will have no entries for this because of the delete
+  // query above.
+  foreach ($entity_files as $fid => $entity_count) {
+    if ($file = file_load($fid)) {
+      file_usage_add($file, 'media', $entity_type, $entity_id, $entity_count);
+    }
+  }
+}
+
+/**
+ * Parse file references from an entity's text fields and return them as an array.
+ */
+function media_wysiwyg_filter_parse_from_fields($entity_type, $entity) {
+  $file_references = array();
+
+  foreach (media_wysiwyg_filter_fields_with_text_filtering($entity_type, $entity) as $field_name) {
+    if ($field_items = field_get_items($entity_type, $entity, $field_name)) {
+      foreach ($field_items as $field_item) {
+        preg_match_all(MEDIA_WYSIWYG_TOKEN_REGEX, $field_item['value'], $matches);
+        foreach ($matches[0] as $tag) {
+          $tag = str_replace(array('[[', ']]'), '', $tag);
+          $tag_info = drupal_json_decode($tag);
+          if (isset($tag_info['fid']) && $tag_info['type'] == 'media') {
+            $file_references[] = $tag_info;
+          }
+        }
+
+        preg_match_all(MEDIA_WYSIWYG_TOKEN_REGEX, $field_item['value'], $matches_alt);
+        foreach ($matches_alt[0] as $tag) {
+          $tag = urldecode($tag);
+          $tag_info = drupal_json_decode($tag);
+          if (isset($tag_info['fid']) && $tag_info['type'] == 'media') {
+            $file_references[] = $tag_info;
+          }
+        }
+      }
+    }
+  }
+
+  return $file_references;
+}
+
+/**
+ * Utility function to get the file count in this entity
+ *
+ * @param type $entity
+ * @param type $entity_type
+ * @return int
+ */
+function media_wysiwyg_entity_field_count_files($entity_type, $entity) {
+  $entity_files = array();
+  foreach (media_wysiwyg_filter_parse_from_fields($entity_type, $entity) as $file_reference) {
+    if (empty($entity_files[$file_reference['fid']])) {
+      $entity_files[$file_reference['fid']] = 1;
+    }
+    else {
+      $entity_files[$file_reference['fid']]++;
+    }
+  }
+  return $entity_files;
+}
+
+/**
+ * Implements hook_entity_delete().
+ */
+function media_wysiwyg_entity_delete($entity, $type) {
+  list($entity_id) = entity_extract_ids($type, $entity);
+
+  db_delete('file_usage')
+    ->condition('module', 'media')
+    ->condition('type', $type)
+    ->condition('id', $entity_id)
+    ->execute();
+}
+
+/**
+ * Implements hook_field_attach_delete_revision().
+ *
+ * @param type $entity_type
+ * @param type $entity
+ */
+function media_wysiwyg_field_attach_delete_revision($entity_type, $entity) {
+  list($entity_id) = entity_extract_ids($entity_type, $entity);
+  $files = media_wysiwyg_entity_field_count_files($entity_type, $entity);
+  foreach ($files as $fid => $count) {
+    if ($file = file_load($fid)) {
+      file_usage_delete($file, 'media', $entity_type , $entity_id, $count);
+    }
+  }
+}
+
+/**
+ * Implements hook_entity_dependencies().
+ */
+function media_wysiwyg_entity_dependencies($entity, $entity_type) {
+  // Go through all the entity's text fields and add a dependency on any files
+  // that are referenced there.
+  $dependencies = array();
+  foreach (media_wysiwyg_filter_parse_from_fields($entity_type, $entity) as $file_reference) {
+    $dependencies[] = array('type' => 'file', 'id' => $file_reference['fid']);
+  }
+  return $dependencies;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.filter.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.filter.inc
new file mode 100644
index 0000000..8cc99c9
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.filter.inc
@@ -0,0 +1,356 @@
+<?php
+
+/**
+ * @file
+ * Functions related to the WYSIWYG editor and the media input filter.
+ */
+
+define('MEDIA_WYSIWYG_TOKEN_REGEX', '/\[\[.*?\]\]/s');
+
+/**
+ * Filter callback for media markup filter.
+ *
+ * @TODO check for security probably pass text through filter_xss
+ */
+function media_wysiwyg_filter($text) {
+  $text = preg_replace_callback(MEDIA_WYSIWYG_TOKEN_REGEX, 'media_wysiwyg_token_to_markup', $text);
+  return $text;
+}
+
+/**
+ * Parses the contents of a CSS declaration block.
+ *
+ * @param string $declarations
+ *   One or more CSS declarations delimited by a semicolon. The same as a CSS
+ *   declaration block (see http://www.w3.org/TR/CSS21/syndata.html#rule-sets),
+ *   but without the opening and closing curly braces. Also the same as the
+ *   value of an inline HTML style attribute.
+ *
+ * @return array
+ *   A keyed array. The keys are CSS property names, and the values are CSS
+ *   property values.
+ */
+function media_wysiwyg_parse_css_declarations($declarations) {
+  $properties = array();
+  foreach (array_map('trim', explode(";", $declarations)) as $declaration) {
+    if ($declaration != '') {
+      list($name, $value) = array_map('trim', explode(':', $declaration, 2));
+      $properties[strtolower($name)] = $value;
+    }
+  }
+  return $properties;
+}
+
+/**
+ * Replace callback to convert a media file tag into HTML markup.
+ *
+ * @param string $match
+ *   Takes a match of tag code
+ * @param bool $wysiwyg
+ *   Set to TRUE if called from within the WYSIWYG text area editor.
+ *
+ * @return string
+ *   The HTML markup representation of the tag, or an empty string on failure.
+ *
+ * @see media_wysiwyg_get_file_without_label()
+ * @see hook_media_wysiwyg_token_to_markup_alter()
+ */
+function media_wysiwyg_token_to_markup($match, $wysiwyg = FALSE) {
+  $settings = array();
+  $match = str_replace("[[", "", $match);
+  $match = str_replace("]]", "", $match);
+  $tag = $match[0];
+
+  try {
+    if (!is_string($tag)) {
+      throw new Exception('Unable to find matching tag');
+    }
+
+    $tag_info = drupal_json_decode($tag);
+
+    if (!isset($tag_info['fid'])) {
+      throw new Exception('No file Id');
+    }
+
+    // Ensure the 'link_text' key is always defined.
+    if (!isset($tag_info['link_text'])) {
+      $tag_info['link_text'] = NULL;
+    }
+
+    // Ensure a valid view mode is being requested.
+    if (!isset($tag_info['view_mode'])) {
+      $tag_info['view_mode'] = variable_get('media_wysiwyg_wysiwyg_default_view_mode', 'full');
+    }
+    elseif ($tag_info['view_mode'] != 'default') {
+      $file_entity_info = entity_get_info('file');
+      if (!in_array($tag_info['view_mode'], array_keys($file_entity_info['view modes']))) {
+        // Media 1.x defined some old view modes that have been superseded by
+        // more semantically named ones in File Entity. The media_update_7203()
+        // function updates field settings that reference the old view modes,
+        // but it's impractical to update all text content, so adjust
+        // accordingly here.
+        static $view_mode_updates = array(
+          'media_preview' => 'preview',
+          'media_small' => 'teaser',
+          'media_large' => 'full',
+        );
+        if (isset($view_mode_updates[$tag_info['view_mode']])) {
+          $tag_info['view_mode'] = $view_mode_updates[$tag_info['view_mode']];
+        }
+        else {
+          throw new Exception('Invalid view mode');
+        }
+      }
+    }
+
+    $file = file_load($tag_info['fid']);
+    if (!$file) {
+      throw new Exception('Could not load media object');
+    }
+    $tag_info['file'] = $file;
+
+    // The class attributes is a string, but drupal requires it to be
+    // an array, so we fix it here.
+    if (!empty($tag_info['attributes']['class'])) {
+      $tag_info['attributes']['class'] = explode(" ", $tag_info['attributes']['class']);
+    }
+
+    // Grab the potentially overrided fields from the file.
+    $fields = media_wysiwyg_filter_field_parser($tag_info);
+
+    $attributes = is_array($tag_info['attributes']) ? $tag_info['attributes'] : array();
+    $attribute_whitelist = variable_get('media_wysiwyg_wysiwyg_allowed_attributes', _media_wysiwyg_wysiwyg_allowed_attributes_default());
+    $settings['attributes'] = array_intersect_key($attributes, array_flip($attribute_whitelist));
+    $settings['fields'] = $fields;
+
+    if (!empty($tag_info['attributes']) && is_array($tag_info['attributes'])) {
+      $settings['attributes'] = array_intersect_key($tag_info['attributes'], array_flip($attribute_whitelist));
+      $settings['fields'] = $fields;
+
+      // Many media formatters will want to apply width and height independently
+      // of the style attribute or the corresponding HTML attributes, so pull
+      // these two out into top-level settings. Different WYSIWYG editors have
+      // different behavior with respect to whether they store user-specified
+      // dimensions in the HTML attributes or the style attribute - check both.
+      // Per http://www.w3.org/TR/html5/the-map-element.html#attr-dim-width, the
+      // HTML attributes are merely hints: CSS takes precedence.
+      if (isset($settings['attributes']['style'])) {
+        $css_properties = media_wysiwyg_parse_css_declarations($settings['attributes']['style']);
+        foreach (array('width', 'height') as $dimension) {
+          if (isset($css_properties[$dimension]) && substr($css_properties[$dimension], -2) == 'px') {
+            $settings[$dimension] = substr($css_properties[$dimension], 0, -2);
+          }
+          elseif (isset($settings['attributes'][$dimension])) {
+            $settings[$dimension] = $settings['attributes'][$dimension];
+          }
+        }
+      }
+    }
+  }
+  catch (Exception $e) {
+    watchdog('media', 'Unable to render media from %tag. Error: %error', array('%tag' => $tag, '%error' => $e->getMessage()));
+    return '';
+  }
+
+  // If the tag has link text stored with it, override the filename with it for
+  // the rest of this function, so that if the file is themed as a link, the
+  // desired text will be used (see, for example, theme_file_link()).
+  // @todo: Try to find a less hacky way to do this.
+  if (isset($tag_info['link_text'])) {
+    // The link text will have characters such as "&" encoded for HTML, but the
+    // filename itself needs the raw value when it is used to build the link,
+    // in order to avoid double encoding.
+    $file->filename = decode_entities($tag_info['link_text']);
+  }
+
+  if ($wysiwyg) {
+    $settings['wysiwyg'] = $wysiwyg;
+    // If sending markup to a WYSIWYG, we need to pass the file infomation so
+    // that a inline macro can be generated when the WYSIWYG is detached.
+    // The WYSIWYG plugin is expecting this information in the format of a
+    // urlencoded JSON string stored in the data-file_info attribute of the
+    // element.
+    $element = media_wysiwyg_get_file_without_label($file, $tag_info['view_mode'], $settings);
+    $data = drupal_json_encode(array(
+      'type' => 'media',
+      'fid' => $file->fid,
+      'view_mode' => $tag_info['view_mode'],
+      'link_text' => $tag_info['link_text'],
+    ));
+    $element['#attributes']['data-file_info'] = urlencode($data);
+    $element['#attributes']['class'][] = 'media-element';
+  }
+  else {
+    // Display the field elements.
+    $element = array();
+    $element['content']['file'] = media_wysiwyg_get_file_without_label($file, $tag_info['view_mode'], $settings);
+    // Overwrite or set the file #alt attribute if it has been set in this
+    // instance.
+    if (!empty($element['content']['file']['#attributes']['alt'])) {
+      $element['content']['file']['#alt'] = $element['content']['file']['#attributes']['alt'];
+    }
+    // Overwrite or set the file #title attribute if it has been set in this
+    // instance.
+    if (!empty($element['content']['file']['#attributes']['title'])) {
+      $element['content']['file']['#title'] = $element['content']['file']['#attributes']['title'];
+    }
+    field_attach_prepare_view('file', array($file->fid => $file), $tag_info['view_mode']);
+    entity_prepare_view('file', array($file->fid => $file));
+    $element['content'] += field_attach_view('file', $file, $tag_info['view_mode']);
+    if (count(element_children($element['content'])) > 1) {
+      // Add surrounding divs to group them together.
+      // We dont want divs when there are no additional fields to allow files
+      // to display inline with text, without breaking p tags.
+      $element['content']['#type'] = 'container';
+      $element['content']['#attributes']['class'] = array(
+        'media',
+        'media-element-container',
+        'media-' . $element['content']['file']['#view_mode']
+      );
+    }
+  }
+  drupal_alter('media_wysiwyg_token_to_markup', $element, $tag_info, $settings);
+  return drupal_render($element);
+}
+
+
+
+/**
+ * Parse the field array from the collapsed AJAX string.
+ */
+function media_wysiwyg_filter_field_parser($tag_info) {
+  $fields = array();
+  if (isset($tag_info['fields'])) {
+    foreach($tag_info['fields'] as $field_name => $field_value) {
+      if (strpos($field_name, 'field_') === 0) {
+        $parsed_field = explode('[', str_replace(']', '', $field_name));
+        if(isset($parsed_field[2])) {
+          if(isset($parsed_field[3])) {
+            $fields[$parsed_field[0]][$parsed_field[1]][$parsed_field[2]][$parsed_field[3]] = $field_value;
+          } else {
+            $fields[$parsed_field[0]][$parsed_field[1]][$parsed_field[2]] = $field_value;
+          }
+        } else {
+          $fields[$parsed_field[0]][$parsed_field[1]] = $field_value;
+        }
+      }
+    }
+  }
+  return $fields;
+}
+/**
+ * Builds a map of media tags in the element.
+ *
+ * Builds a map of the media tags in an element that are being rendered to their
+ * rendered HTML. The map is stored in JS, so we can transform them when the
+ * editor is being displayed.
+ */
+function media_wysiwyg_pre_render_text_format($element) {
+  // filter_process_format() copies properties to the expanded 'value' child
+  // element.
+  if (!isset($element['format'])) {
+    return $element;
+  }
+
+  $field = &$element['value'];
+  $settings = array(
+    'field' => $field['#id'],
+  );
+
+  $tagmap = _media_wysiwyg_generate_tagMap($field['#value']);
+
+  if (isset($tagmap)) {
+    drupal_add_js(array('tagmap' => $tagmap), 'setting');
+  }
+  return $element;
+}
+
+/**
+ * Creates map of inline media tags.
+ *
+ * Generates an array of [inline tags] => <html> to be used in filter
+ * replacement and to add the mapping to JS.
+ *
+ * @param string $text
+ *   The String containing text and html markup of textarea
+ *
+ * @return array
+ *   An associative array with tag code as key and html markup as the value.
+ *
+ * @see media_process_form()
+ * @see media_token_to_markup()
+ */
+function _media_wysiwyg_generate_tagMap($text) {
+  // Making $tagmap static as this function is called many times and
+  // adds duplicate markup for each tag code in Drupal.settings JS,
+  // so in media_process_form it adds something like tagCode:<markup>,
+  // <markup> and when we replace in attach see two duplicate images
+  // for one tagCode. Making static would make function remember value
+  // between function calls. Since media_process_form is multiple times
+  // with same form, this function is also called multiple times.
+  static $tagmap = array();
+  preg_match_all("/\[\[.*?\]\]/s", $text, $matches, PREG_SET_ORDER);
+  foreach ($matches as $match) {
+    // We see if tagContent is already in $tagMap, if not we add it
+    // to $tagmap.  If we return an empty array, we break embeddings of the same
+    // media multiple times.
+    if (empty($tagmap[$match[0]])) {
+      // @TODO: Total HACK, but better than nothing.
+      // We should find a better way of cleaning this up.
+      if ($markup_for_media = media_wysiwyg_token_to_markup($match, TRUE)) {
+        $tagmap[$match[0]] = $markup_for_media;
+      }
+      else {
+        $missing = file_create_url(drupal_get_path('module', 'media') . '/images/icons/default/image-x-generic.png');
+        $tagmap[$match[0]] = '<div><img src="' . $missing . '" width="100px" height="100px"/></div>';
+      }
+    }
+  }
+  return $tagmap;
+}
+
+/**
+ * Return a list of view modes allowed for a file embedded in the WYSIWYG.
+ *
+ * @param object $file
+ *   A file entity.
+ *
+ * @return array
+ *   An array of view modes that can be used on the file when embedded in the
+ *   WYSIWYG.
+ */
+function media_wysiwyg_get_wysiwyg_allowed_view_modes($file) {
+  $enabled_view_modes = &drupal_static(__FUNCTION__, array());
+
+  // @todo Add more caching for this.
+  if (!isset($enabled_view_modes[$file->type])) {
+    $enabled_view_modes[$file->type] = array();
+
+    // Add the default view mode by default.
+    $enabled_view_modes[$file->type]['default'] = array('label' => t('Default'), 'custom settings' => TRUE);
+
+    $entity_info = entity_get_info('file');
+    $view_mode_settings = field_view_mode_settings('file', $file->type);
+    foreach ($entity_info['view modes'] as $view_mode => $view_mode_info) {
+      // Do not show view modes that don't have their own settings and will
+      // only fall back to the default view mode.
+      if (empty($view_mode_settings[$view_mode]['custom_settings'])) {
+        continue;
+      }
+
+      // Don't present the user with an option to choose a view mode in which
+      // the file is hidden.
+      $extra_fields = field_extra_fields_get_display('file', $file->type, $view_mode);
+      if (empty($extra_fields['file']['visible'])) {
+        continue;
+      }
+
+      // Add the view mode to the list of enabled view modes.
+      $enabled_view_modes[$file->type][$view_mode] = $view_mode_info;
+    }
+  }
+
+  $view_modes = $enabled_view_modes[$file->type];
+  drupal_alter('media_wysiwyg_wysiwyg_allowed_view_modes', $view_modes, $file);
+  return $view_modes;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.pages.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.pages.inc
new file mode 100644
index 0000000..bd11072
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.pages.inc
@@ -0,0 +1,112 @@
+<?php
+
+/**
+ * @file
+ * Common pages for the Media WYSIWYG module.
+ */
+
+/**
+ * Form callback used when embedding media.
+ *
+ * Allows the user to pick a format for their media file.
+ * Can also have additional params depending on the media type.
+ */
+function media_wysiwyg_format_form($form, $form_state, $file) {
+  $form = array();
+  $form['#media'] = $file;
+
+  // Allow for overrides to the fields.
+  $query_fields = isset($_GET['fields']) ? drupal_json_decode($_GET['fields']) : array();
+  $fields = media_wysiwyg_filter_field_parser(array('fields' => $query_fields), $file);
+
+  $view_modes = media_wysiwyg_get_wysiwyg_allowed_view_modes($file);
+  $formats = $options = array();
+  foreach ($view_modes as $view_mode => $view_mode_info) {
+    // @TODO: Display more verbose information about which formatter and what it
+    // does.
+    $options[$view_mode] = $view_mode_info['label'];
+    $element = media_wysiwyg_get_file_without_label($file, $view_mode, array('wysiwyg' => TRUE));
+
+    // Make a pretty name out of this.
+    $formats[$view_mode] = drupal_render($element);
+  }
+
+  // Add the previews back into the form array so they can be altered.
+  $form['#formats'] = &$formats;
+
+  if (!count($formats)) {
+    throw new Exception('Unable to continue, no available formats for displaying media.');
+    return;
+  }
+
+  // Allow for overrides to the display format.
+  $default_view_mode = is_array($query_fields) && isset($query_fields['format']) ? $query_fields['format'] : variable_get('media_wysiwyg_wysiwyg_default_view_mode', 'full');
+  if (!isset($formats[$default_view_mode])) {
+    $default_view_mode = key($formats);
+  }
+
+  // Add the previews by reference so that they can easily be altered by
+  // changing $form['#formats'].
+  $settings['media']['formatFormFormats'] = &$formats;
+  $form['#attached']['js'][] = array('data' => $settings, 'type' => 'setting');
+
+  // Add the required libraries, JavaScript and CSS for the form.
+  $form['#attached']['library'][] = array('media', 'media_base');
+  $form['#attached']['library'][] = array('system', 'form');
+  $form['#attached']['css'][] = drupal_get_path('module', 'media_wysiwyg') . '/css/media_wysiwyg.css';
+  $form['#attached']['js'][] = drupal_get_path('module', 'media_wysiwyg') . '/js/media_wysiwyg.format_form.js';
+
+  $form['title'] = array(
+    '#markup' => t('Embedding %filename', array('%filename' => $file->filename)),
+  );
+
+  $preview = media_get_thumbnail_preview($file);
+
+  $form['preview'] = array(
+    '#type' => 'markup',
+    '#title' => check_plain(basename($file->uri)),
+    '#markup' => drupal_render($preview),
+  );
+
+  // These will get passed on to WYSIWYG.
+  $form['options'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('options'),
+  );
+
+  $form['options']['format'] = array(
+    '#type' => 'select',
+    '#title' => t('Display as'),
+    '#options' => $options,
+    '#default_value' => $default_view_mode,
+    '#description' => t('Choose the type of display you would like for this
+      file. Please be aware that files may display differently than they do when
+      they are inserted into an editor.')
+  );
+
+  // Add fields from the file, so that we can override them if neccesary.
+  $form['options']['fields'] = array();
+  foreach ($fields as $field_name => $field_value) {
+    $file->{$field_name} = $field_value;
+  }
+  field_attach_form('file', $file, $form['options']['fields'], $form_state);
+  $instance = field_info_instances('file', $file->type);
+  foreach ($instance as $field_name => $field_value) {
+    if (isset($instance[$field_name]['settings']) && isset($instance[$field_name]['settings']['wysiwyg_override']) && !$instance[$field_name]['settings']['wysiwyg_override']) {
+      unset($form['options']['fields'][$field_name]);
+    }
+  }
+
+  // Similar to a form_alter, but we want this to run first so that
+  // media.types.inc can add the fields specific to a given type (like alt tags
+  // on media). If implemented as an alter, this might not happen, making other
+  // alters not be able to work on those fields.
+  // @todo: We need to pass in existing values for those attributes.
+  drupal_alter('media_wysiwyg_format_form_prepare', $form, $form_state, $file);
+
+  if (!element_children($form['options'])) {
+    $form['options']['#attributes'] = array('style' => 'display:none');
+  }
+
+  return $form;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.uuid.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.uuid.inc
new file mode 100644
index 0000000..3d228e3
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/includes/media_wysiwyg.uuid.inc
@@ -0,0 +1,88 @@
+<?php
+
+/**
+ * @file
+ * Functions related to adding UUID support to embedded media.
+ */
+
+/**
+ * Implements hook_entity_uuid_load().
+ */
+function media_wysiwyg_entity_uuid_load(&$entities, $entity_type) {
+  // Go through all the entity's text fields and replace file IDs in media
+  // tokens with the corresponding UUID.
+  foreach ($entities as $entity) {
+    media_wysiwyg_filter_replace_tokens_in_all_text_fields($entity_type, $entity, 'media_wysiwyg_token_fid_to_uuid');
+  }
+}
+
+/**
+ * Implements hook_entity_uuid_presave().
+ */
+function media_wysiwyg_entity_uuid_presave(&$entity, $entity_type) {
+  // Go through all the entity's text fields and replace UUIDs in media tokens
+  // with the corresponding file ID.
+  media_wysiwyg_filter_replace_tokens_in_all_text_fields($entity_type, $entity, 'media_wysiwyg_token_uuid_to_fid');
+}
+
+/**
+ * Replaces media tokens in an entity's text fields, using the specified callback function.
+ */
+function media_wysiwyg_filter_replace_tokens_in_all_text_fields($entity_type, $entity, $callback) {
+  $text_field_names = media_wysiwyg_filter_fields_with_text_filtering($entity_type, $entity);
+  foreach ($text_field_names as $field_name) {
+    if (!empty($entity->{$field_name})) {
+      $field = field_info_field($field_name);
+      $all_languages = field_available_languages($entity_type, $field);
+      $field_languages = array_intersect($all_languages, array_keys($entity->{$field_name}));
+      foreach ($field_languages as $language) {
+        if (!empty($entity->{$field_name}[$language])) {
+          foreach ($entity->{$field_name}[$language] as &$item) {
+            $item['value'] = preg_replace_callback(MEDIA_WYSIWYG_TOKEN_REGEX, $callback, $item['value']);
+          }
+        }
+      }
+    }
+  }
+}
+
+/**
+ * Callback to replace file IDs with UUIDs in a media token.
+ */
+function media_wysiwyg_token_fid_to_uuid($matches) {
+  return _media_wysiwyg_token_uuid_replace($matches, 'entity_get_uuid_by_id');
+}
+
+/**
+ * Callback to replace UUIDs with file IDs in a media token.
+ */
+function media_wysiwyg_token_uuid_to_fid($matches) {
+  return _media_wysiwyg_token_uuid_replace($matches, 'entity_get_id_by_uuid');
+}
+
+/**
+ * Helper function to replace UUIDs with file IDs or vice versa.
+ *
+ * @param array $matches
+ *   An array of matches for media tokens, from a preg_replace_callback()
+ *   callback function.
+ * @param string $entity_uuid_function
+ *   Either 'entity_get_uuid_by_id' (to replace file IDs with UUIDs in the
+ *   token) or 'entity_get_id_by_uuid' (to replace UUIDs with file IDs).
+ *
+ * @return string
+ *   A string representing the JSON-encoded token, with the appropriate
+ *   replacement between file IDs and UUIDs.
+ */
+function _media_wysiwyg_token_uuid_replace($matches, $entity_uuid_function) {
+  $tag = $matches[0];
+  $tag = str_replace(array('[[', ']]'), '', $tag);
+  $tag_info = drupal_json_decode($tag);
+  if (isset($tag_info['fid'])) {
+    if ($new_ids = $entity_uuid_function('file', array($tag_info['fid']))) {
+      $new_id = reset($new_ids);
+      $tag_info['fid'] = $new_id;
+    }
+  }
+  return '[[' . drupal_json_encode($tag_info) . ']]';
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.filter.js b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.filter.js
new file mode 100644
index 0000000..7de50af
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.filter.js
@@ -0,0 +1,208 @@
+/**
+ *  @file
+ *  File with utilities to handle media in html editing.
+ */
+(function ($) {
+
+  Drupal.media = Drupal.media || {};
+  /**
+   * Utility to deal with media tokens / placeholders.
+   */
+  Drupal.media.filter = {
+    /**
+     * Replaces media tokens with the placeholders for html editing.
+     * @param content
+     */
+    replaceTokenWithPlaceholder: function(content) {
+      Drupal.media.filter.ensure_tagmap()
+      var tagmap = Drupal.settings.tagmap,
+        matches = content.match(/\[\[.*?\]\]/g),
+        media_definition;
+
+      if (matches) {
+        for (var macro in tagmap) {
+          // We cant use indexOf because of IE.
+          var index = $.inArray(macro, matches);
+          if (index !== -1) {
+            var media_json = macro.replace('[[', '').replace(']]', '');
+
+            // Make sure that the media JSON is valid.
+            try {
+              media_definition = JSON.parse(media_json);
+            }
+            catch (err) {
+              media_definition = null;
+            }
+            if (media_definition) {
+              // Apply attributes.
+              var element = Drupal.media.filter.create_element(tagmap[macro], media_definition);
+              var markup = Drupal.media.filter.outerHTML(element);
+
+              content = content.replace(macro, markup);
+            }
+          }
+        }
+      }
+      return content;
+    },
+
+    /**
+     * Replaces the placeholders for html editing with the media tokens to store.
+     * @param content
+     */
+    replacePlaceholderWithToken: function(content) {
+      Drupal.media.filter.ensure_tagmap();
+      // Convert all xhtml markup to html for reliable matching/replacing.
+      content = content.replace(/[\s]\/\>/g, '>');
+
+      // Re-build the macros in case any element has changed in the editor.
+      $('.media-element', content).each(function(i, element) {
+        var markup = Drupal.media.filter.outerHTML($(element));
+          macro = Drupal.media.filter.create_macro($(element));
+
+        // Store the macro => html for more efficient rendering in
+        // replaceTokenWithPlaceholder().
+        Drupal.settings.tagmap[macro] = markup;
+        // Replace the media element with its macro.
+        content = content.replace(markup, macro);
+      });
+
+      return content;
+    },
+
+    /**
+     * Serializes file information as a url-encoded JSON object and stores it as a
+     * data attribute on the html element.
+     *
+     * @param html (string)
+     *    A html element to be used to represent the inserted media element.
+     * @param info (object)
+     *    A object containing the media file information (fid, view_mode, etc).
+     */
+    create_element: function (html, info) {
+      if ($('<div></div>').append(html).text().length === html.length) {
+        // Element is not an html tag. Surround it in a span element
+        // so we can pass the file attributes.
+        html = '<span>' + html + '</span>';
+      }
+      var element = $(html);
+
+      // Move attributes from the file info array to the placeholder element.
+      if (info.attributes) {
+        $.each(Drupal.settings.media.wysiwyg_allowed_attributes, function(i, a) {
+          if (info.attributes[a]) {
+            element.attr(a, info.attributes[a]);
+          }
+        });
+        delete(info.attributes);
+      }
+
+      // Important to url-encode the file information as it is being stored in an
+      // html data attribute.
+      info.type = info.type || "media";
+      element.attr('data-file_info', encodeURI(JSON.stringify(info)));
+
+      // Adding media-element class so we can find markup element later.
+      var classes = ['media-element'];
+
+      if(info.view_mode){
+        classes.push('file-' + info.view_mode.replace(/_/g, '-'));
+      }
+      element.addClass(classes.join(' '));
+
+      return element;
+    },
+
+    /**
+     * Create a macro representation of the inserted media element.
+     *
+     * @param element (jQuery object)
+     *    A media element with attached serialized file info.
+     */
+    create_macro: function (element) {
+      var file_info = Drupal.media.filter.extract_file_info(element);
+      if (file_info) {
+        return '[[' + JSON.stringify(file_info) + ']]';
+      }
+      return false;
+    },
+
+    /**
+     * Extract the file info from a WYSIWYG placeholder element as JSON.
+     *
+     * @param element (jQuery object)
+     *    A media element with attached serialized file info.
+     */
+    extract_file_info: function (element) {
+      var file_json = $.data(element, 'file_info') || element.data('file_info'),
+        file_info,
+        value;
+
+      try {
+        file_info = JSON.parse(decodeURIComponent(file_json));
+      }
+      catch (err) {
+        file_info = null;
+      }
+
+      if (file_info) {
+        file_info.attributes = {};
+
+        // Extract whitelisted attributes.
+        $.each(Drupal.settings.media.wysiwyg_allowed_attributes, function(i, a) {
+          if (value = element.attr(a)) {
+            file_info.attributes[a] = value;
+          }
+        });
+        delete(file_info.attributes['data-file_info']);
+      }
+
+      return file_info;
+    },
+
+    /**
+     * Gets the HTML content of an element.
+     *
+     * @param element (jQuery object)
+     */
+    outerHTML: function (element) {
+      return element[0].outerHTML || $('<div>').append(element.eq(0).clone()).html();
+    },
+
+    /**
+     * Gets the wrapped HTML content of an element to insert into the wysiwyg.
+     *
+     * It also registers the element in the tag map so that the token
+     * replacement works.
+     *
+     * @param element (jQuery object) The element to insert.
+     *
+     * @see Drupal.media.filter.replacePlaceholderWithToken()
+     */
+    getWysiwygHTML: function (element) {
+      // Create the markup and the macro.
+      var markup = Drupal.media.filter.outerHTML(element),
+        macro = Drupal.media.filter.create_macro(element);
+
+      // Store macro/markup in the tagmap.
+      Drupal.media.filter.ensure_tagmap();
+      var i = 1;
+      for (var key in Drupal.settings.tagmap) {
+        i++;
+      }
+      Drupal.settings.tagmap[macro] = markup;
+
+      // Return the html code to insert in an editor and use it with
+      // replacePlaceholderWithToken()
+      return markup;
+    },
+
+    /**
+     * Ensures the tag map has been initialized and returns it.
+     */
+    ensure_tagmap: function () {
+      Drupal.settings.tagmap = Drupal.settings.tagmap || {};
+      return Drupal.settings.tagmap;
+    }
+  }
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.format_form.js b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.format_form.js
new file mode 100644
index 0000000..23413a8
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/media_wysiwyg.format_form.js
@@ -0,0 +1,57 @@
+
+/**
+ *  @file
+ *  Attach behaviors to formatter radio select when selecting a media's display
+ *  formatter.
+ */
+
+(function ($) {
+namespace('Drupal.media.formatForm');
+
+Drupal.media.mediaFormatSelected = {};
+
+Drupal.behaviors.mediaFormatForm = {
+  attach: function (context, settings) {
+
+    // Add "Submit" and "Cancel" buttons inside the IFRAME that trigger the
+    // behavior of the hidden "OK" and "Cancel" buttons that are outside the
+    // IFRAME. See Drupal.media.browser.validateButtons() for more details.
+
+    // @note I think this should be handled in media.browser.js in
+    //       Drupal.media.browser.validateButtons but I'm not sure how crufty
+    //       this particular functionality is. We should evaluate if it is still
+    //       needed.
+
+    // @TODO can these be added to the content being displayed via form_alter?
+
+    // Adding the buttons should only be done once in order to prevent multiple
+    // buttons from being added if part of the form is updated via AJAX
+    $('#media-wysiwyg-format-form').once('format', function() {
+      $('<a class="button fake-ok">' + Drupal.t('Submit') + '</a>').appendTo($('#media-wysiwyg-format-form')).bind('click', Drupal.media.formatForm.submit);
+      $('<a class="button fake-cancel">' + Drupal.t('Cancel') + '</a>').appendTo($('#media-wysiwyg-format-form')).bind('click', Drupal.media.formatForm.submit);
+    });
+  }
+};
+
+Drupal.media.formatForm.getOptions = function () {
+  // Get all the values
+  var ret = {}; $.each($('#media-wysiwyg-format-form fieldset#edit-options *').serializeArray(), function (i, field) { ret[field.name] = field.value; });
+  return ret;
+};
+
+Drupal.media.formatForm.getFormattedMedia = function () {
+  var formatType = $("select#edit-format option:selected").val();
+  return { type: formatType, options: Drupal.media.formatForm.getOptions(), html: Drupal.settings.media.formatFormFormats[formatType] };
+};
+
+Drupal.media.formatForm.submit = function () {
+  // @see Drupal.behaviors.mediaFormatForm.attach().
+  var buttons = $(parent.window.document.body).find('#mediaStyleSelector').parent('.ui-dialog').find('.ui-dialog-buttonpane button');
+  if ($(this).hasClass('fake-cancel')) {
+    buttons[1].click();
+  } else {
+    buttons[0].click();
+  }
+}
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/wysiwyg-media.js b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/wysiwyg-media.js
new file mode 100644
index 0000000..ac5bf4d
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/js/wysiwyg-media.js
@@ -0,0 +1,185 @@
+
+/**
+ *  @file
+ *  Attach Media WYSIWYG behaviors.
+ */
+
+(function ($) {
+
+Drupal.media = Drupal.media || {};
+
+/**
+ * Register the plugin with WYSIWYG.
+ */
+Drupal.wysiwyg.plugins.media = {
+
+  /**
+   * Determine whether a DOM element belongs to this plugin.
+   *
+   * @param node
+   *   A DOM element
+   */
+  isNode: function(node) {
+    return $(node).is('img.media-element');
+  },
+  /**
+   * Execute the button.
+   *
+   * @param data
+   *   An object containing data about the current selection:
+   *   - format: 'html' when the passed data is HTML content, 'text' when the
+   *     passed data is plain-text content.
+   *   - node: When 'format' is 'html', the focused DOM element in the editor.
+   *   - content: The textual representation of the focused/selected editor
+   *     content.
+   * @param settings
+   *   The plugin settings, as provided in the plugin's PHP include file.
+   * @param instanceId
+   *   The ID of the current editor instance.
+   */
+  invoke: function (data, settings, instanceId) {
+    if (data.format == 'html') {
+      var insert = new InsertMedia(instanceId);
+      if (this.isNode(data.node)) {
+        // Change the view mode for already-inserted media.
+        var media_file = Drupal.media.filter.extract_file_info($(data.node));
+        insert.onSelect([media_file]);
+      }
+      else {
+        // Insert new media.
+        insert.prompt(settings.global);
+      }
+    }
+  },
+
+  /**
+   * Attach function, called when a rich text editor loads.
+   * This finds all [[tags]] and replaces them with the html
+   * that needs to show in the editor.
+   *
+   * This finds all JSON macros and replaces them with the HTML placeholder
+   * that will show in the editor.
+   */
+  attach: function (content, settings, instanceId) {
+    content = Drupal.media.filter.replaceTokenWithPlaceholder(content);
+    return content;
+  },
+
+  /**
+   * Detach function, called when a rich text editor detaches
+   */
+  detach: function (content, settings, instanceId) {
+    content = Drupal.media.filter.replacePlaceholderWithToken(content);
+    return content;
+  }
+};
+/**
+ * Defining InsertMedia object to manage the sequence of actions involved in
+ * inserting a media element into the WYSIWYG.
+ * Keeps track of the WYSIWYG instance id.
+ */
+var InsertMedia = function (instance_id) {
+  this.instanceId = instance_id;
+  return this;
+};
+
+InsertMedia.prototype = {
+  /**
+   * Prompt user to select a media item with the media browser.
+   *
+   * @param settings
+   *    Settings object to pass on to the media browser.
+   *    TODO: Determine if this is actually necessary.
+   */
+  prompt: function (settings) {
+    Drupal.media.popups.mediaBrowser($.proxy(this, 'onSelect'), settings);
+  },
+
+  /**
+   * On selection of a media item, display item's display configuration form.
+   */
+  onSelect: function (media_files) {
+    this.mediaFile = media_files[0];
+    Drupal.media.popups.mediaStyleSelector(this.mediaFile, $.proxy(this, 'insert'), {});
+  },
+
+  /**
+   * When display config has been set, insert the placeholder markup into the
+   * wysiwyg and generate its corresponding json macro pair to be added to the
+   * tagmap.
+   */
+  insert: function (formatted_media) {
+    var element = Drupal.media.filter.create_element(formatted_media.html, {
+          fid: this.mediaFile.fid,
+          view_mode: formatted_media.type,
+          attributes: formatted_media.options,
+          fields: formatted_media.options
+        });
+    // Get the markup and register it for the macro / placeholder handling.
+    var markup = Drupal.media.filter.getWysiwygHTML(element);
+
+    // Insert placeholder markup into wysiwyg.
+    Drupal.wysiwyg.instances[this.instanceId].insert(markup);
+  }
+};
+
+/** Helper functions */
+
+/**
+ * Ensures the tag map has been initialized.
+ */
+function ensure_tagmap () {
+  return Drupal.media.filter.ensure_tagmap();
+}
+
+/**
+ * Serializes file information as a url-encoded JSON object and stores it as a
+ * data attribute on the html element.
+ *
+ * @param html (string)
+ *    A html element to be used to represent the inserted media element.
+ * @param info (object)
+ *    A object containing the media file information (fid, view_mode, etc).
+ *
+ * @deprecated
+ */
+function create_element (html, info) {
+  return Drupal.media.filter.create_element(html, info);
+}
+
+/**
+ * Create a macro representation of the inserted media element.
+ *
+ * @param element (jQuery object)
+ *    A media element with attached serialized file info.
+ *
+ * @deprecated
+ */
+function create_macro (element) {
+  return Drupal.media.filter.create_macro(element);
+}
+
+/**
+ * Extract the file info from a WYSIWYG placeholder element as JSON.
+ *
+ * @param element (jQuery object)
+ *    A media element with attached serialized file info.
+ *
+ * @deprecated
+ */
+function extract_file_info (element) {
+  return Drupal.media.filter.extract_file_info(element);
+}
+
+/**
+ * Gets the HTML content of an element.
+ *
+ * @param element (jQuery object)
+ *
+ * @deprecated
+ */
+function outerHTML (element) {
+  return Drupal.media.filter.outerHTML(element);
+}
+
+})(jQuery);
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.api.php b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.api.php
new file mode 100644
index 0000000..28d4caf
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.api.php
@@ -0,0 +1,71 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by the Media WYSIWYG module.
+ */
+
+/**
+ * Alter a list of view modes allowed for a file embedded in the WYSIWYG.
+ *
+ * @param array $view_modes
+ *   An array of view modes that can be used on the file when embedded in the
+ *   WYSIWYG.
+ * @param object $file
+ *   A file entity.
+ *
+ * @see media_get_wysiwyg_allowed_view_modes()
+ */
+function hook_media_wysiwyg_wysiwyg_allowed_view_modes_alter(&$view_modes, $file) {
+  $view_modes['default']['label'] = t('Display an unmodified version of the file');
+  unset($view_modes['preview']);
+}
+
+/**
+ * Alter the WYSIWYG view mode selection form.
+ *
+ * Similar to a form_alter, but runs first so that modules can add
+ * fields specific to a given file type (like alt tags on images) before alters
+ * begin to work on the fields.
+ *
+ * @param array $form
+ *   An associative array containing the structure of the form.
+ * @param array $form_state
+ *   An associative array containing the current state of the form.
+ * @param object $file
+ *   A file entity.
+ *
+ * @see media_format_form()
+ */
+function hook_media_wysiwyg_format_form_prepare_alter(&$form, &$form_state, $file) {
+  $form['preview']['#access'] = FALSE;
+
+  $file = $form['#media'];
+  $form['heading']['#markup'] = t('Embedding %filename of type %filetype', array('%filename' => $file->filename, '%filetype' => $file->type));
+}
+
+/**
+ * Alter the output generated by Media filter tags.
+ *
+ * @param array $element
+ *   The renderable array of output generated for the filter tag.
+ * @param array $tag_info
+ *   The filter tag converted into an associative array by
+ *   media_token_to_markup() with the following elements:
+ *   - 'fid': The ID of the media file being rendered.
+ *   - 'file': The object from file_load() of the media file being rendered.
+ *   - 'view_mode': The view mode being used to render the file.
+ *   - 'attributes': An additional array of attributes that could be output
+ *     with media_get_file_without_label().
+ * @param array $settings
+ *   An additional array of settings.
+ *   - 'wysiwyg': A boolean if the output is for the WYSIWYG preview or FALSE
+ *     if for normal rendering.
+ *
+ * @see media_token_to_markup()
+ */
+function hook_media_wysiwyg_token_to_markup_alter(&$element, $tag_info, $settings) {
+  if (empty($settings['wysiwyg'])) {
+    $element['#attributes']['alt'] = t('This media has been output using the @mode view mode.', array('@mode' => $tag_info['view_mode']));
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info
new file mode 100644
index 0000000..391688d
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info
@@ -0,0 +1,23 @@
+name = Media WYSIWYG
+description = Adds support for embedding media using client-side WYSIWYG editors.
+package = Media
+core = 7.x
+
+dependencies[] = media
+dependencies[] = wysiwyg
+
+test_dependencies[] = token
+
+files[] = media_wysiwyg.test
+files[] = tests/media_wysiwyg.file_usage.test
+files[] = tests/media_wysiwyg.macro.test
+
+configure = admin/config/media/browser
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.install b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.install
new file mode 100644
index 0000000..6d2d5e4
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.install
@@ -0,0 +1,20 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media WYSIWYG module.
+ */
+
+/**
+ * Implements hook_uninstall().
+ */
+function media_wysiwyg_uninstall() {
+  // Remove variables.
+  variable_del('media_wysiwyg_wysiwyg_title');
+  variable_del('media_wysiwyg_wysiwyg_icon_title');
+  variable_del('media_wysiwyg_wysiwyg_default_view_mode');
+  variable_del('media_wysiwyg_wysiwyg_upload_directory');
+  variable_del('media_wysiwyg_wysiwyg_allowed_types');
+  variable_del('media_wysiwyg_wysiwyg_allowed_attributes');
+  variable_del('media_wysiwyg_wysiwyg_browser_plugins');
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.module b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.module
new file mode 100644
index 0000000..fc97230
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.module
@@ -0,0 +1,273 @@
+<?php
+
+/**
+ * @file
+ * Primarily Drupal hooks.
+ */
+
+// Functions for tracking the file usage of [[inline tags]].
+require_once dirname(__FILE__) . '/includes/media_wysiwyg.file_usage.inc';
+
+// Functions for working with [[inline tags]] and wysiwyg editors.
+require_once dirname(__FILE__) . '/includes/media_wysiwyg.filter.inc';
+
+// Functions for UUID support to embedded media.
+require_once dirname(__FILE__) . '/includes/media_wysiwyg.uuid.inc';
+
+/**
+ * Implements hook_hook_info().
+ */
+function media_wysiwyg_hook_info() {
+  $hooks = array(
+    'media_wysiwyg_token_to_markup_alter',
+    'media_wysiwyg_allowed_view_modes_alter',
+    'media_wysiwyg_format_form_prepare_alter',
+  );
+
+  return array_fill_keys($hooks, array('group' => 'media_wysiwyg'));
+}
+
+/**
+ * Implements hook_menu().
+ */
+function media_wysiwyg_menu() {
+  $items['media/%file/format-form'] = array(
+    'title' => 'Style selector',
+    'description' => 'Choose a format for a piece of media',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_wysiwyg_format_form', 1),
+    'access callback' => 'file_entity_access',
+    'access arguments' => array('view', 1),
+    'file' => 'includes/media_wysiwyg.pages.inc',
+    'theme callback' => 'media_dialog_get_theme_name',
+    'type' => MENU_CALLBACK,
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_element_info_alter().
+ */
+function media_wysiwyg_element_info_alter(&$types) {
+  $types['text_format']['#pre_render'][] = 'media_wysiwyg_pre_render_text_format';
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ */
+function media_wysiwyg_form_wysiwyg_profile_form_alter(&$form, &$form_state) {
+  // Add warnings if the media filter is disabled for the WYSIWYG's text format.
+  $form['buttons']['drupal']['media']['#element_validate'][] = 'media_wysiwyg_wysiwyg_button_element_validate';
+  $form['buttons']['drupal']['media']['#after_build'][] = 'media_wysiwyg_wysiwyg_button_element_validate';
+  form_load_include($form_state, 'inc', 'media_wysiwyg', 'wysiwyg_plugins/media');
+}
+
+/**
+ * Element validate callback for the media WYSIWYG button.
+ */
+function media_wysiwyg_wysiwyg_button_element_validate($element, &$form_state) {
+  if (!empty($element['#value'])) {
+    $format = filter_format_load($form_state['build_info']['args'][0]->format);
+    $filters = filter_list_format($format->format);
+    if (empty($filters['media_filter']->status)) {
+      form_error($element, t('The <em>Convert Media tags to markup</em> filter must be enabled for the <a href="@format-link">@format format</a> in order to use the Media browser WYSIWYG button.', array(
+        '@format-link' => url('admin/config/content/formats/' . $format->format, array('query' => array('destination' => $_GET['q']))),
+        '@format' => $format->name,
+      )));
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ */
+function media_wysiwyg_form_media_admin_config_browser_alter(&$form, &$form_state) {
+  $form['wysiwyg'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('WYSIWYG configuration'),
+    '#collapsible' => TRUE,
+    '#collapsed' => FALSE,
+  );
+  $form['wysiwyg']['media_wysiwyg_wysiwyg_browser_plugins'] = array(
+    '#type' => 'checkboxes',
+    '#title' => t('Enabled browser plugins'),
+    '#options' => array(),
+    '#required' => FALSE,
+    '#default_value' => variable_get('media_wysiwyg_wysiwyg_browser_plugins', array()),
+    '#description' => t('If no plugins are selected, they will all be available.'),
+  );
+
+  $plugins = media_get_browser_plugin_info();
+
+  foreach ($plugins as $key => $plugin) {
+    $form['wysiwyg']['media_wysiwyg_wysiwyg_browser_plugins']['#options'][$key] = !empty($plugin['title']) ? $plugin['title'] : $key;
+  }
+
+  $form['wysiwyg']['media_wysiwyg_wysiwyg_upload_directory'] = array(
+    '#type' => 'textfield',
+    '#title' => t("File directory for uploaded media"),
+    '#default_value' => variable_get('media_wysiwyg_wysiwyg_upload_directory', ''),
+    '#description' => t('Optional subdirectory within the upload destination where files will be stored. Do not include preceding or trailing slashes.'),
+  );
+
+  if (module_exists('token')) {
+    $form['wysiwyg']['media_wysiwyg_wysiwyg_upload_directory']['#description'] .= t('This field supports tokens.');
+    $form['wysiwyg']['tokens'] = array(
+      '#theme' => 'token_tree',
+      '#dialog' => TRUE,
+    );
+  }
+
+  $form['wysiwyg']['media_wysiwyg_wysiwyg_allowed_types'] = array(
+    '#type' => 'checkboxes',
+    '#title' => t('Allowed types in WYSIWYG'),
+    '#options' => file_entity_type_get_names(),
+    '#default_value' => variable_get('media_wysiwyg_wysiwyg_allowed_types', array('audio', 'image', 'video', 'document')),
+  );
+
+  $form['#submit'][] = 'media_wysiwyg_admin_config_browser_pre_submit';
+}
+
+/**
+ * Manipulate values before form is submitted.
+ */
+function media_wysiwyg_admin_config_browser_pre_submit(&$form, &$form_state) {
+  $wysiwyg_browser_plugins = array_unique(array_values($form_state['values']['media_wysiwyg_wysiwyg_browser_plugins']));
+  if (empty($wysiwyg_browser_plugins[0])) {
+    variable_del('media_wysiwyg_wysiwyg_browser_plugins');
+    unset($form_state['values']['media_wysiwyg_wysiwyg_browser_plugins']);
+  }
+}
+
+/**
+ * Implements hook_filter_info().
+ */
+function media_wysiwyg_filter_info() {
+  $filters['media_filter'] = array(
+    'title' => t('Convert Media tags to markup'),
+    'description' => t('This filter will convert [[{type:media... ]] tags into markup. This must be enabled for the Media WYSIWYG integration to work with this input format.'),
+    'process callback' => 'media_wysiwyg_filter',
+    'weight' => 2,
+    // @TODO not implemented
+    'tips callback' => 'media_filter_tips',
+  );
+
+  return $filters;
+}
+
+/**
+ * Implements hook_wysiwyg_include_directory().
+ */
+function media_wysiwyg_wysiwyg_include_directory($type) {
+  switch ($type) {
+    case 'plugins':
+      return 'wysiwyg_plugins';
+
+      break;
+  }
+}
+
+/**
+ * Returns the default set of allowed attributes for use with WYSIWYG.
+ *
+ * @return array
+ *   An array of whitelisted attributes.
+ */
+function _media_wysiwyg_wysiwyg_allowed_attributes_default() {
+  return array(
+    'alt',
+    'title',
+    'height',
+    'width',
+    'hspace',
+    'vspace',
+    'border',
+    'align',
+    'style',
+    'class',
+    'id',
+    'usemap',
+    'data-picture-group',
+    'data-picture-align',
+  );
+}
+
+/**
+ * Returns a drupal_render() array for just the file portion of a file entity.
+ *
+ * Optional custom settings can override how the file is displayed.
+ */
+function media_wysiwyg_get_file_without_label($file, $view_mode, $settings = array()) {
+  $file->override = $settings;
+
+  $element = file_view_file($file, $view_mode);
+
+  // The formatter invoked by file_view_file() can use $file->override to
+  // customize the returned render array to match the requested settings. To
+  // support simple formatters that don't do this, set the element attributes to
+  // what was requested, but not if the formatter applied its own logic for
+  // element attributes.
+  if (isset($settings['attributes'])) {
+    if (empty($element['#attributes'])) {
+      $element['#attributes'] = $settings['attributes'];
+    }
+
+    // While this function may be called for any file type, images are a common
+    // use-case, and image theme functions have their own structure for render
+    // arrays.
+    if (isset($element['#theme'])) {
+      // theme_image() and theme_image_style() require the 'alt' attributes to
+      // be passed separately from the 'attributes' array. (see
+      // http://drupal.org/node/999338). Until that's fixed, implement this
+      // special-case logic. Image formatters using other theme functions are
+      // responsible for their own 'alt' attribute handling. See
+      // theme_media_formatter_large_icon() for an example.
+      if (in_array($element['#theme'], array('image', 'image_style'))) {
+        if (empty($element['#alt']) && isset($settings['attributes']['alt'])) {
+          $element['#alt'] = $settings['attributes']['alt'];
+        }
+      }
+      // theme_image_formatter() and any potential replacements, such as
+      // theme_colorbox_image_formatter(), also require attribute handling.
+      elseif (strpos($element['#theme'], 'image_formatter') !== FALSE) {
+        // theme_image_formatter() requires the attributes to be
+        // set on the item rather than the element itself.
+        if (empty($element['#item']['attributes'])) {
+          $element['#item']['attributes'] = $settings['attributes'];
+        }
+
+        // theme_image_formatter() also requires alt, title, height, and
+        // width attributes to be set on the item rather than within its
+        // attributes array.
+        foreach (array('alt', 'title', 'width', 'height') as $attr) {
+          if (isset($settings['attributes'][$attr])) {
+            $element['#item'][$attr] = $settings['attributes'][$attr];
+          }
+        }
+      }
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * Returns an array containing the names of all fields that perform text filtering.
+ */
+function media_wysiwyg_filter_fields_with_text_filtering($entity_type, $entity) {
+  list($entity_id, $revision_id, $bundle) = entity_extract_ids($entity_type, $entity);
+  $fields = field_info_instances($entity_type, $bundle);
+
+  // Get all of the fields on this entity that allow text filtering.
+  $fields_with_text_filtering = array();
+  foreach ($fields as $field_name => $field) {
+    if (!empty($field['settings']['text_processing'])) {
+      $fields_with_text_filtering[] = $field_name;
+    }
+  }
+
+  return $fields_with_text_filtering;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.test b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.test
new file mode 100644
index 0000000..cdb672a
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.test
@@ -0,0 +1,101 @@
+<?php
+
+/**
+ * @file
+ * Tests for media.module.
+ */
+
+/**
+ * Defines base class for media test cases.
+ */
+class MediaWYSIWYGTestHelper extends DrupalWebTestCase {
+
+  /**
+   * Enable media and file entity modules for testing.
+   */
+  public function setUp() {
+    $modules = func_get_args();
+    if (isset($modules[0]) && is_array($modules[0])) {
+      $modules = $modules[0];
+    }
+    $modules[] = 'media_wysiwyg';
+    parent::setUp($modules);
+  }
+
+  /**
+    * Generates markup to be inserted for a file.
+    *
+    * This is a PHP version of InsertMedia.insert() from js/wysiwyg-media.js.
+    *
+    * @param int $fid
+    *   Drupal file id
+    * @param int $count
+    *   Quantity of markup to insert
+    * @param array $attributes
+    *   Extra attributes to insert.
+    * @param array $fields
+    *   Extra field values to insert.
+    *
+    * @return string
+    *   Filter markup.
+    */
+  protected function generateJsonTokenMarkup($fid, $count = 1, array $attributes = array(), array $fields = array()) {
+    $markup = '';
+    // Merge default atttributes.
+    $attributes += array(
+      'height' => 100,
+      'width' => 100,
+      'classes' => 'media-element file_preview',
+    );
+
+    // Build the data that is used in a media tag.
+    $data = array(
+      'fid' => $fid,
+      'type' => 'media',
+      'view_mode' => 'preview',
+      'attributes' => $attributes,
+      'fields' => $fields,
+    );
+
+    // Create the file usage markup.
+    for ($i = 1; $i <= $count; $i++) {
+      $markup .= '<p>[[' . drupal_json_encode($data) . ']]</p>';
+    }
+
+    return $markup;
+  }
+
+  /**
+   * Utility function to create a test node.
+   *
+   * @param int $fid
+   *   Create the node with media markup in the body field
+    * @param array $attributes
+    *   Extra attributes to insert to the file.
+    * @param array $fields
+    *   Extra field values to insert.
+   *
+   * @return int
+   *   Returns the node id
+   */
+  protected function createNode($fid = FALSE, array $attributes = array(), array $fields = array()) {
+    $markup = '';
+    if (! empty($fid)) {
+      $markup = $this->generateJsonTokenMarkup($fid, 1, $attributes, $fields);
+    }
+
+    // Create an article node with file markup in the body field.
+    $edit = array(
+      'title' => $this->randomName(8),
+      'body[und][0][value]' => $markup,
+    );
+    // Save the article node. First argument is the URL, then the value array
+    // and the third is the label the button that should be "clicked".
+    $this->drupalPost('node/add/article', $edit, t('Save'));
+
+    // Get the article node that was saved by the unique title.
+    $node = $this->drupalGetNodeByTitle($edit['title']);
+    return $node->nid;
+  }
+
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.variable.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.variable.inc
new file mode 100644
index 0000000..206905a
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.variable.inc
@@ -0,0 +1,42 @@
+<?php
+
+/**
+ * @file
+ * Declare Media WYSIWYG variables.
+ */
+
+/**
+ * Implements hook_variable_group_info().
+ */
+function media_wysiwyg_variable_group_info() {
+  $groups['media_wysiwyg'] = array(
+    'title' => t('Media WYSIWYG'),
+    'description' => t('Settings for Media WYSIWYG integration.'),
+    'access' => 'administer media browser',
+    'path' => 'admin/config/media/browser',
+  );
+
+  return $groups;
+}
+
+/**
+* Implements hook_variable_info().
+*/
+function media_wysiwyg_variable_info($options) {
+  $variables['media_wysiwyg_wysiwyg_title'] = array(
+    'type' => 'string',
+    'title' => t('WYSIWYG Title', array(), $options),
+    'default' => t('Media browser', array(), $options),
+    'description' => t('The WYSIWYG media plugin title.', array(), $options),
+    'group' => 'media_wysiwyg',
+  );
+  $variables['media_wysiwyg_wysiwyg_icon_title'] = array(
+    'type' => 'string',
+    'title' => t('WYSIWYG Icon Title', array(), $options),
+    'default' => t('Add media', array(), $options),
+    'description' => t('The WYSIWYG media button title to display on hover.', array(), $options),
+    'group' => 'media_wysiwyg',
+  );
+
+  return $variables;
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.file_usage.test b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.file_usage.test
new file mode 100644
index 0000000..bd82ecf
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.file_usage.test
@@ -0,0 +1,237 @@
+<?php
+
+/**
+ * @file
+ * Tests for the file usage in entity fields with the Media filter markup.
+ */
+
+class MediaWYSIWYGFileUsageTest extends MediaWYSIWYGTestHelper {
+
+  /**
+   * Provide test information.
+   */
+  public static function getInfo() {
+    return array(
+      'name' => t('File usage tracking'),
+      'description' => t('Tests tracking of usage for files in text fields.'),
+      'group' => t('Media WYSIWYG'),
+    );
+  }
+
+  /**
+   * Enable media and file entity modules for testing.
+   */
+  public function setUp() {
+    parent::setUp();
+
+    // Create and log in a user.
+    $account = $this->drupalCreateUser(array('administer nodes', 'create article content'));
+    $this->drupalLogin($account);
+  }
+
+  /**
+   * Tests the tracking of file usages for files submitted via the WYSIWYG editor.
+   */
+  public function testFileUsageIncrementing() {
+    // Create a file.
+    $files = $this->drupalGetTestFiles('image');
+    $file = file_save($files[0]);
+    $fid = $file->fid;
+
+    // There should be zero usages of this file prior to node creation,
+    $file_uses = file_usage_list($file);
+    $this->assertEqual(empty($file_uses), TRUE, t('Created a new file with zero uses.'));
+
+    // Create a node to test with.
+    $nid = $this->createNode($fid);
+
+    // Get the new file usage count.
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual($file_uses['media']['node'][$nid], 1, t('File usage increases when added to a new node.'));
+
+    // Create a new revision that has the file on it. File usage will be 2.
+    $node = node_load($nid);
+    $node->revision = TRUE;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $revisions = count(node_revision_list($node));
+    // Keep track of this VID to test deletion later on.
+    $delete_one = $node->vid;
+
+    $this->assertEqual($revisions, 2, t('Node save created a second revision'));
+    $this->assertEqual($file_uses['media']['node'][$nid], 2, t('File usage incremented with a new node revision.'));
+
+    // Create a new revision that has two instances of the file. File usage will
+    // be 4.
+    $node = node_load($nid);
+    $node->body[LANGUAGE_NONE][0]['value'] = $this->generateJsonTokenMarkup($fid, 2);
+    $node->revision = TRUE;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $revisions = count(node_revision_list($node));
+    // Keep track of this VID to test deletion later on.
+    $delete_two = $node->vid;
+
+    $this->assertEqual($revisions, 3, t('Node save created a third revision.'));
+    $this->assertEqual($file_uses['media']['node'][$nid], 4, t('File usage incremented with multiple files and a new node revision.'));
+
+    // Create a new revision that has no file on it. File usage will be 4.
+    $node = node_load($nid);
+    $node->body[LANGUAGE_NONE][0]['value'] = '';
+    $node->revision = TRUE;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $revisions = count(node_revision_list($node));
+    // Keep track of this VID to test deletion later on.
+    $delete_zero = $node->vid;
+
+    $this->assertEqual($revisions, 4, t('Node save created a fourth revision.'));
+    $this->assertEqual($file_uses['media']['node'][$nid], 4, t('File usage does not change with a new revision of the node without the file'));
+
+    // Create a new revision that has the file on it. File usage will be 5.
+    $node = node_load($nid);
+    $node->body[LANGUAGE_NONE][0]['value'] = $this->generateJsonTokenMarkup($fid, 1);
+    $node->revision = TRUE;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $revisions = count(node_revision_list($node));
+
+    $this->assertEqual($revisions, 5, t('Node save created a new revision.'));
+    $this->assertEqual($file_uses['media']['node'][$nid], 5, t('File usage incremented with a single file on a new node revision.'));
+
+    // Delete a revision that has the file on it once. File usage will be 4.
+    node_revision_delete($delete_one);
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $this->assertEqual($file_uses['media']['node'][$nid], 4, t('Deleting revision with file decreases file usage'));
+
+    // Delete a revision that has no file on it. File usage will be 4.
+    node_revision_delete($delete_zero);
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $this->assertEqual($file_uses['media']['node'][$nid], 4, t('Deleting revision without a file does not change file usage.'));
+
+    // Delete a revision that has the file on it twice. File usage will be 2.
+    node_revision_delete($delete_two);
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+    $this->assertEqual($file_uses['media']['node'][$nid], 2, t('Deleting revision with file decreases file usage'));
+
+    // Create a new revision with the file on it twice. File usage will be 4.
+    $node = node_load($nid);
+    $node->body[LANGUAGE_NONE][0]['value'] = $this->generateJsonTokenMarkup($fid, 2);
+    $node->revision = TRUE;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual($file_uses['media']['node'][$nid], 4,  t('File usage incremented with files on a new node revision.'));
+
+    // Re-save current revision with file on it once instead of twice. File
+    // usage will be 3.
+    $node = node_load($nid);
+    $node->body[LANGUAGE_NONE][0]['value'] = $this->generateJsonTokenMarkup($fid, 1);
+    $saved_vid = $node->vid;
+    node_save($node);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual($node->vid, $saved_vid, t('Resaved node revision does not create new revision.'));
+    $this->assertEqual($file_uses['media']['node'][$nid], 3, t('Resaved node revision with fewer files reduces file usage.'));
+
+    // Delete the node. File usage will be 0.
+    $node = node_load($nid);
+    node_delete($nid);
+
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual(empty($node), TRUE, t('Node has been deleted.'));
+    $this->assertEqual(empty($file_uses), TRUE, t('Deleting the node removes all file uses.'));
+  }
+
+  /**
+   * Tests the behavior of node and file deletion.
+   */
+  public function testFileUsageIncrementingDelete() {
+    // Create a node with file markup in the body field with a new file.
+    $files = $this->drupalGetTestFiles('image');
+    $file = file_save($files[1]);
+    $fid = $file->fid;
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual(empty($file_uses), TRUE, t('Created a new file with zero uses.'));
+
+    // Create a new node with file markup.
+    $nid = $this->createNode($fid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual($file_uses['media']['node'][$nid], 1, t('Incremented file usage on node save.'));
+
+    // Try to delete the file. file_delete() should return file_usage().
+    $deleted = file_delete($file);
+    $this->assertTrue(is_array($deleted), t('File cannot be deleted while in use by a node.'));
+
+    // Delete the node.
+    node_delete($nid);
+    $node = node_load($nid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual(empty($node), TRUE, t('Node has been deleted.'));
+    $this->assertEqual(empty($file_uses), TRUE, t('File has zero usage after node is deleted.'));
+
+    $deleted = file_delete($file);
+    $this->assertTrue($deleted, t('File can be deleted with no usage.'));
+
+    $file = file_load($fid);
+    $this->assertTrue(empty($file), t('File no longer exists after delete.'));
+  }
+
+
+  /**
+   * Tests if node still remains updatable if file was deleted.
+   */
+  public function testFileUsageForcedDelete() {
+    // Create a node with file markup in the body field with a new file.
+    $files = $this->drupalGetTestFiles('image');
+    $file = file_save($files[1]);
+    $fid = $file->fid;
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual(empty($file_uses), TRUE, t('Created a new file with zero uses.'));
+
+    // Create a new node with file markup.
+    $nid = $this->createNode($fid);
+    $file_uses = file_usage_list($file);
+
+    $this->assertEqual($file_uses['media']['node'][$nid], 1, t('Incremented file usage on node save.'));
+
+    // Force the file to delete.
+    $deleted = file_delete($file, TRUE);
+    $this->assertTrue($deleted, t('File was deleted although in use sice we forced it.'));
+
+    // Try to update the node that uses broken file.
+    $account = $this->drupalCreateUser(array('edit any article content'));
+    $node = node_load($nid);
+    $this->drupalLogin($account);
+    $this->drupalGet('node/' . $nid . '/edit');
+    $this->assertRaw(check_plain($node->body['und'][0]['value']), t('Reference to deleted file found in node body.'));
+    $edit = array(
+      'body[und][0][value]' => '',
+    );
+    $this->drupalPost(NULL, $edit, t('Save'));
+    $type = node_type_load($node->type);
+    $this->assertRaw(t('@type %title has been updated.', array('@type' => $type->name, '%title' => $node->title)), t('Node without reference to deleted file saved successfully.'));
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.macro.test b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.macro.test
new file mode 100644
index 0000000..7ac1bc4
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/tests/media_wysiwyg.macro.test
@@ -0,0 +1,95 @@
+<?php
+
+/**
+ * @file
+ * Tests for ensuring media macros render properly.
+ */
+
+/**
+ * Defines media macro test cases.
+ */
+class MediaWYSIWYGWYSIWYGOverridesTest extends MediaWYSIWYGTestHelper {
+
+  /**
+   * Provide test information.
+   */
+  public static function getInfo() {
+    return array(
+      'name' => t('Media WYSIWYG WYSIWYG overrides'),
+      'description' => t('Tests that overridden attributes display correct.'),
+      'group' => t('Media WYSIWYG'),
+      'dependencies' => array('token'),
+    );
+  }
+
+  public function setUp() {
+    parent::setUp('token');
+
+    // Create and log in a user.
+    $account = $this->drupalCreateUser(array('create article content', 'administer filters', 'use text format filtered_html'));
+    $this->drupalLogin($account);
+
+    // Enable the media filter for full html.
+    $edit = array(
+      'filters[media_filter][status]' => TRUE,
+      'filters[filter_html][status]' => FALSE,
+    );
+    $this->drupalPost('admin/config/content/formats/filtered_html', $edit, t('Save configuration'));
+  }
+
+  /**
+   * Test image media overrides.
+   */
+  public function testAttributeOverrides() {
+    $files = $this->drupalGetTestFiles('image');
+    $file = file_save($files[0]);
+
+    // Create a node to test with.
+    $nid = $this->createNode($file->fid);
+
+    $this->drupalGet('node/' . $nid);
+    $this->assertRaw('width="100"', t('Image displays with default width attribute.'));
+    $this->assertRaw('height="100"', t('Image displays with default height attribute.'));
+
+    // Create a node with a style attribute.
+    $attributes = array(
+      'style' => 'float: left; width: 50px;',
+    );
+    $nid = $this->createNode($file->fid, $attributes);
+    $this->drupalGet('node/' . $nid);
+    $this->assertRaw(drupal_attributes($attributes), t('Image displays with overriden attributes.'));
+
+    // Create a node with overriden alt/title attributes.
+    $attributes = array(
+      'alt' => $this->randomName(),
+      'title' => $this->randomName(),
+    );
+    $nid = $this->createNode($file->fid, $attributes);
+    $this->drupalGet('node/' . $nid);
+    $this->assertRaw(drupal_attributes($attributes), t('Image displays with alt/title set as attributes.'));
+
+    // Create a node with overriden alt/title fields.
+    $fields = $attributes = array();
+    $attributes['alt'] = $fields['field_file_image_alt_text[und][0][value]'] = $this->randomName();
+    $attributes['title'] = $fields['field_file_image_title_text[und][0][value]'] = $this->randomName();
+
+    $nid = $this->createNode($file->fid, array(), $fields);
+    $this->drupalGet('node/' . $nid);
+    // Ensure that the alt/title from attributes display.
+    $this->assertRaw(drupal_attributes($attributes), t('Image displays with alt/title set as fields.'));
+
+    // Create a node with overriden alt/title fields as well as attributes.
+    $attributes = array(
+      'alt' => $this->randomName(),
+      'title' => $this->randomName(),
+    );
+    $fields = array(
+      'field_file_image_alt_text[und][0][value]' => $this->randomName(),
+      'field_file_image_title_text[und][0][value]' => $this->randomName(),
+    );
+    $nid = $this->createNode($file->fid, $attributes, $fields);
+    $this->drupalGet('node/' . $nid);
+    // Ensure that the alt/title from attributes display rather the field ones.
+    $this->assertRaw(drupal_attributes($attributes), t('Image displays with alt/title set as attributes overriding field values.'));
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/wysiwyg_plugins/media.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/wysiwyg_plugins/media.inc
new file mode 100644
index 0000000..8540cf9
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/wysiwyg_plugins/media.inc
@@ -0,0 +1,73 @@
+<?php
+
+/**
+ * @file
+ * Define the WYSIWYG browser plugin.
+ */
+
+/**
+ * Implements WYSIWYG's hook_INCLUDE_plugin().
+ */
+function media_wysiwyg_media_plugin() {
+  // Include the required browser JS.
+  // @todo: wyswiyg should allow libraries and multiple js files
+  // to be defined by this hook.
+  // @see http://drupal.org/node/1039076
+  media_wysiwyg_include_browser_js();
+
+  // Add the filter handling.
+  drupal_add_js(drupal_get_path('module', 'media_wysiwyg') . '/js/media_wysiwyg.filter.js');
+
+  // Plugin definition.
+  $plugins['media'] = array(
+    'title' => variable_get('media_wysiwyg_wysiwyg_title', t('Media browser')),
+    'vendor url' => 'http://drupal.org/project/media',
+    'icon path' => drupal_get_path('module', 'media_wysiwyg') . '/images',
+    'icon file' => 'wysiwyg-media.gif',
+    'icon title' => variable_get('media_wysiwyg_wysiwyg_icon_title', t('Add media')),
+    // @todo: move this to the plugin directory for the wysiwyg plugin.
+    'js path' => drupal_get_path('module', 'media_wysiwyg') . '/js',
+    'js file' => 'wysiwyg-media.js',
+    'css path' => drupal_get_path('module', 'media_wysiwyg') . '/css',
+    'css file' => 'media_wysiwyg.css',
+    'settings' => array(
+      'global' => array(
+        'enabledPlugins' => variable_get('media_wysiwyg_wysiwyg_browser_plugins', array()),
+        'file_directory' => variable_get('media_wysiwyg_wysiwyg_upload_directory', ''),
+        'types' => variable_get('media_wysiwyg_wysiwyg_allowed_types', array('audio', 'image', 'video', 'document')),
+        'id' => 'media_wysiwyg',
+      ),
+    ),
+  );
+
+  return $plugins;
+}
+
+/**
+ * Prepares the page to be able to launch the media browser.
+ *
+ * Defines default variables.
+ */
+function media_wysiwyg_include_browser_js() {
+  static $included;
+  if ($included) {
+    return;
+  }
+  $included = TRUE;
+  module_load_include('inc', 'media', 'includes/media.browser');
+  $javascript = media_browser_js();
+  foreach ($javascript as $key => $definitions) {
+    foreach ($definitions as $definition) {
+      $function = 'drupal_add_' . $key;
+      // Since the arguments to pass are variable, use call_user_func_array().
+      // This will not handle all potential drupal_add_*() functions directly
+      // but covers the js and library needed here, which are unlikely to be
+      // expanded since this function is only a workaround for a wysiwyg
+      // limitation.
+      call_user_func_array($function, $definition);
+    }
+  }
+  // Add wysiwyg-specific settings.
+  $settings = array('wysiwyg_allowed_attributes' => variable_get('media_wysiwyg_wysiwyg_allowed_attributes', _media_wysiwyg_wysiwyg_allowed_attributes_default()));
+  drupal_add_js(array('media' => $settings), 'setting');
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.admin.inc b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.admin.inc
new file mode 100644
index 0000000..4d1f0a6
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.admin.inc
@@ -0,0 +1,77 @@
+<?php
+
+/**
+ * @file
+ * Generate configuration form and save settings.
+ */
+
+/**
+ * Configuration form for Media's WYSIWYG view modes.
+ */
+function media_wysiwyg_view_mode_configuration_form($form, &$form_state) {
+  $options = array();
+
+  // Add the default view mode by default
+  $options['default'] = t('Default');
+
+  $entity_info = entity_get_info('file');
+  foreach ($entity_info['view modes'] as $view_mode => $view_mode_info) {
+    $options[$view_mode] = check_plain($view_mode_info['label']);
+  }
+
+  $form['media_wysiwyg_view_mode_wysiwyg_restricted_view_modes'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('WYSIWYG allowed view modes'),
+    '#collapsible' => TRUE,
+    '#collapsed' => FALSE,
+    '#description' => t('Restrict the allowed view modes when embedding files inside of the the WYSIWYG editor.'),
+  );
+
+  foreach (file_type_get_enabled_types() as $type) {
+    $form['media_wysiwyg_view_mode_wysiwyg_restricted_view_modes']["media_wysiwyg_view_mode_{$type->type}_wysiwyg_restricted_view_modes_status"] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Restrict allowed view modes for %type', array('%type' => $type->label)),
+      '#default_value' => variable_get("media_wysiwyg_view_mode_{$type->type}_wysiwyg_restricted_view_modes_status", FALSE),
+    );
+    $form['media_wysiwyg_view_mode_wysiwyg_restricted_view_modes']["media_wysiwyg_view_mode_{$type->type}_wysiwyg_restricted_view_modes"] = array(
+      '#type' => 'checkboxes',
+      '#title' => t('Restrict view modes'),
+      '#options' => $options,
+      '#default_value' => variable_get("media_wysiwyg_view_mode_{$type->type}_wysiwyg_restricted_view_modes", array()),
+      '#states' => array(
+        'visible' => array(
+          ':input[name="media_wysiwyg_view_mode_' . $type->type . '_wysiwyg_restricted_view_modes_status"]' => array('checked' => TRUE),
+        ),
+      ),
+    );
+  }
+
+  $form['media_wysiwyg_view_mode_file_wysiwyg_view_mode'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('File WYSIWYG view mode'),
+    '#collapsible' => TRUE,
+    '#collapsed' => FALSE,
+    '#description' => t('Use a custom view mode when displaying files inside of the WYSIWYG editor.'),
+  );
+
+  foreach (file_type_get_enabled_types() as $type) {
+    $form['media_wysiwyg_view_mode_file_wysiwyg_view_mode']["media_wysiwyg_view_mode_{$type->type}_file_wysiwyg_view_mode_status"] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Use a custom view mode for %type', array('%type' => $type->label)),
+      '#default_value' => variable_get("media_wysiwyg_view_mode_{$type->type}_file_wysiwyg_view_mode_status", FALSE),
+    );
+    $form['media_wysiwyg_view_mode_file_wysiwyg_view_mode']["media_wysiwyg_view_mode_{$type->type}_file_wysiwyg_view_mode"] = array(
+      '#type' => 'select',
+      '#title' => t('View mode'),
+      '#options' => $options,
+      '#default_value' => variable_get("media_wysiwyg_view_mode_{$type->type}_file_wysiwyg_view_mode", 'wysiwyg'),
+      '#states' => array(
+        'visible' => array(
+          ':input[name="media_wysiwyg_view_mode_' . $type->type . '_file_wysiwyg_view_mode_status"]' => array('checked' => TRUE),
+        ),
+      ),
+    );
+  }
+
+  return system_settings_form($form);
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info
new file mode 100644
index 0000000..ade3740
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info
@@ -0,0 +1,18 @@
+name = Media WYSIWYG View Mode
+description = Enables files inside of the WYSIWYG editor to be displayed using a separate view mode.
+package = Media
+core = 7.x
+
+dependencies[] = media_wysiwyg
+
+configure = admin/config/media/wysiwyg-view-mode
+
+files[] = media_wysiwyg_view_mode.test
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.install b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.install
new file mode 100644
index 0000000..56b706f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.install
@@ -0,0 +1,15 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media WYSIWYG View Mode module.
+ */
+
+/**
+ * Implements hook_uninstall().
+ */
+function media_wysiwyg_view_mode_uninstall() {
+  db_delete('variable')
+    ->condition('name', "media_wysiwyg_view_mode_%", "LIKE")
+    ->execute();
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.module b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.module
new file mode 100644
index 0000000..ed01bf5
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.module
@@ -0,0 +1,150 @@
+<?php
+
+/**
+ * @file
+ * Primarily Drupal hooks.
+ */
+
+/**
+ * Implements hook_permission().
+ */
+function media_wysiwyg_view_mode_permission() {
+  return array(
+    'administer media wysiwyg view mode' => array(
+      'title' => t('Administer Media WYSIWYG View Mode'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_menu().
+ */
+function media_wysiwyg_view_mode_menu() {
+  $items['admin/config/media/wysiwyg-view-mode'] = array(
+    'title' => 'Media WYSIWYG View Mode',
+    'description' => 'Configure view mode settings for files embedded into and displayed inside of the WYSIWYG editor.',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('media_wysiwyg_view_mode_configuration_form'),
+    'access arguments' => array('administer media wysiwyg view mode'),
+    'file' => 'media_wysiwyg_view_mode.admin.inc',
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_help().
+ */
+function media_wysiwyg_view_mode_help($path, $arg) {
+  switch ($path) {
+    case 'admin/config/media/wysiwyg-view-mode':
+      $output = '';
+      $output .= '<p>' . t('Configure view modes for files displayed inside of the WYSIWYG editor.') . '</p>';
+      $output .= '<p>' . t('View modes can be configured per file type. Only enabled view modes are selectable.') . '</p>';
+      return $output;
+  }
+}
+
+/**
+ * Implements hook_entity_info_alter().
+ */
+function media_wysiwyg_view_mode_entity_info_alter(&$entity_info) {
+  $entity_info['file']['view modes'] += array(
+    'wysiwyg' => array(
+      'label' => t('WYSIWYG'),
+      'custom settings' => TRUE,
+    ),
+  );
+}
+
+/**
+ * Implements hook_media_wysiwyg_wysiwyg_allowed_view_modes_alter().
+ */
+function media_wysiwyg_view_mode_media_wysiwyg_wysiwyg_allowed_view_modes_alter(&$view_modes, &$file) {
+  if (variable_get("media_wysiwyg_view_mode_{$file->type}_wysiwyg_restricted_view_modes_status", FALSE) == TRUE) {
+    $restricted_view_modes = variable_get("media_wysiwyg_view_mode_{$file->type}_wysiwyg_restricted_view_modes", array());
+
+    foreach ($restricted_view_modes as $restricted_view_mode) {
+      if (array_key_exists($restricted_view_mode, $view_modes)) {
+        unset($view_modes[$restricted_view_mode]);
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_media_wysiwyg_token_to_markup_alter().
+ */
+function media_wysiwyg_view_mode_media_wysiwyg_token_to_markup_alter(&$element, $tag_info, $settings) {
+  if (!empty($settings['wysiwyg'])) {
+    $file = $tag_info['file'];
+
+    if (variable_get("media_wysiwyg_view_mode_{$file->type}_file_wysiwyg_view_mode_status", FALSE) == TRUE) {
+      $element = media_wysiwyg_get_file_without_label($file, variable_get("media_wysiwyg_view_mode_{$file->type}_file_wysiwyg_view_mode", 'wysiwyg'), $settings);
+    }
+    else {
+      $element = media_wysiwyg_get_file_without_label($file, $tag_info['view_mode'], $settings);
+    }
+  }
+}
+
+/**
+ * Implements hook_form_alter().
+ */
+function media_wysiwyg_view_mode_form_alter(&$form, $form_state, $form_id)  {
+  switch ($form_id)  {
+    case 'media_wysiwyg_format_form':
+      $file = $form['#media'];
+
+      $default_view_mode = variable_get('media_wysiwyg_wysiwyg_default_view_mode', 'full');
+
+      $view_mode = !empty($form_state['values']['format']) ? $form_state['values']['format'] : $default_view_mode;
+
+      $form['preview'] = file_view_file($file, $view_mode);
+      $form['preview']['#prefix'] = '<div id="preview">';
+      $form['preview']['#suffix'] = '</div>';
+
+      if (!isset($form['options']['format']['#default_value'])) {
+        $form['options']['format']['#default_value'] = $view_mode;
+      }
+      $form['options']['format']['#ajax'] = array(
+        'callback' => 'media_format_form_preview',
+        'wrapper' => 'preview',
+      );
+
+      $view_modes = media_wysiwyg_get_wysiwyg_allowed_view_modes($file);
+      $formats = $options = array();
+      foreach ($view_modes as $view_mode => $view_mode_info) {
+        //@TODO: Display more verbose information about which formatter and what it does.
+        $options[$view_mode] = $view_mode_info['label'];
+
+        if (variable_get("media_wysiwyg_view_mode_{$file->type}_file_wysiwyg_view_mode_status", FALSE) == TRUE) {
+          $element = media_wysiwyg_get_file_without_label($file, variable_get("media_wysiwyg_view_mode_{$file->type}_file_wysiwyg_view_mode", 'wysiwyg'), array('wysiwyg' => TRUE));
+        }
+        else {
+          $element = media_wysiwyg_get_file_without_label($file, $view_mode, array('wysiwyg' => TRUE));
+        }
+
+        // Make a pretty name out of this.
+        $formats[$view_mode] = drupal_render($element);
+      }
+
+      $form['#formats'] = $formats;
+      break;
+  }
+}
+
+/**
+ * AJAX callback to select the portion of the format form to be updated with a preview.
+ *
+ * @param array $form
+ *   An associative array containing the structure of the form.
+ * @param array $form_state
+ *   An associative array containing the current state of the form.
+ *
+ * @return array
+ *   The preview form item.
+ */
+function media_format_form_preview($form, $form_state) {
+  return $form['preview'];
+}
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.test b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.test
new file mode 100644
index 0000000..a51dc2f
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.test
@@ -0,0 +1,65 @@
+<?php
+
+/**
+ * @file
+ * Tests for media_wysiwyg_view_mode.module.
+ */
+
+/**
+ * Defines base class for media_wysiwyg_view_mode test cases.
+ */
+class MediaWYSIWYGViewModeTestHelper extends MediaWYSIWYGTestHelper {
+  function setUp() {
+    parent::setUp('media_wysiwyg_view_mode');
+
+    $web_user = $this->drupalCreateUser(array('administer media wysiwyg view mode', 'view files'));
+    $this->drupalLogin($web_user);
+  }
+}
+
+/**
+ * Test configuring view modes available on the format form.
+ */
+class FormatFormViewModesTest extends MediaWYSIWYGViewModeTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'Format Form WYSIWYG View Modes',
+      'description' => 'Test configuring view modes available on the format form.',
+      'group' => 'Media WYSIWYG View Mode',
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+  }
+
+  /**
+   * Configure format form view mode restrictions and ensure that they are followed.
+   */
+  function testAllowedFormatFormViewModes() {
+    // Load the Media WYSIWYG View Mode administration page.
+    $this->drupalGet('admin/config/media/wysiwyg-view-mode');
+    $this->assertResponse(200, t('The privileged user can access the Media WYSIWYG View Mode administration page.'));
+
+    // Create an image file to test with.
+    $files = $this->drupalGetTestFiles('image');
+    $files[0]->status = FILE_STATUS_PERMANENT;
+    $file = file_save($files[0]);
+    $fid = $file->fid;
+
+    // The default view mode should be selected by default.
+    $this->drupalGet('media/' . $fid . '/format-form');
+    $this->assertOptionSelected('edit-format', 'default');
+
+    // Restrict the use of the default view mode.
+    variable_set('media_wysiwyg_view_mode_image_wysiwyg_restricted_view_modes_status', TRUE);
+    $restricted_view_modes = array(
+      'default' => 'default',
+    );
+    variable_set('media_wysiwyg_view_mode_image_wysiwyg_restricted_view_modes', $restricted_view_modes);
+
+    // The teaser view mode should now be selected by default.
+    $this->drupalGet('media/' . $fid . '/format-form');
+    $this->assertOptionSelected('edit-format', 'teaser');
+  }
+}
diff --git a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info
new file mode 100644
index 0000000..b207a0e
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info
@@ -0,0 +1,13 @@
+name = Media Field
+description = "Provides a field type that stores media-specific data. <em>Deprecated by the core File field type.</em>"
+package = Media
+core = 7.x
+dependencies[] = media
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-2.0-alpha3+33-dev"
+core = "7.x"
+project = "media"
+datestamp = "1387568918"
+
diff --git a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.install b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.install
new file mode 100644
index 0000000..3e867b8
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.install
@@ -0,0 +1,43 @@
+<?php
+
+/**
+ * @file
+ * Install and schema hooks for mediafield.
+ */
+
+/**
+ * Implements hook_field_schema().
+ */
+function mediafield_field_schema($field) {
+  return array(
+    'columns' => array(
+      'fid' => array(
+        'type' => 'int',
+        'unsigned' => TRUE,
+        'not null' => FALSE,
+      ),
+      'title' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => FALSE,
+      ),
+      'data' => array(
+        'type' => 'text',
+        'not null' => FALSE,
+        'size' => 'big',
+        'serialize' => TRUE,
+        // 'description' => 'Used for storing additional information.
+        // Can be harnessed by widgets',
+      ),
+    ),
+    'indexes' => array(
+      'fid' => array('fid'),
+    ),
+    'foreign keys' => array(
+      'file_managed' => array(
+        'table' => 'file_managed',
+        'columns' => array('fid' => 'fid'),
+      ),
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.module b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.module
new file mode 100644
index 0000000..2dd77f3
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.module
@@ -0,0 +1,323 @@
+<?php
+
+/**
+ * @file
+ * Provide a "Multimedia asset" field.
+ */
+
+/**
+ * Implements hook_field_info().
+ */
+function mediafield_field_info() {
+  return array(
+    'media' => array(
+      'label' => t('Multimedia asset'),
+      'description' => t('This field stores a reference to a multimedia asset.'),
+      'settings' => array(),
+      'instance_settings' => array(
+        'file_extensions' => variable_get('file_entity_default_allowed_extensions', 'jpg jpeg gif png txt doc docx xls xlsx pdf ppt pptx pps ppsx odt ods odp mp3 mov mp4 m4a m4v mpeg avi ogg oga ogv weba webp webm'),
+      ),
+      'default_widget' => 'media_generic',
+      'default_formatter' => 'media',
+      'property_type' => 'field_item_file',
+      'property_callbacks' => array('entity_metadata_field_file_callback'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_field_widget_info_alter().
+ *
+ * Alter the media file selector so it is available for media fields.
+ */
+function mediafield_field_widget_info_alter(&$info) {
+  $info['media_generic']['field types'][] = 'media';
+}
+
+/**
+ * Implements hook_field_instance_settings_form().
+ */
+function mediafield_field_instance_settings_form($field, $instance) {
+  $settings = $instance['settings'];
+
+  // Make the extension list a little more human-friendly by comma-separation.
+  $extensions = str_replace(' ', ', ', $settings['file_extensions']);
+  $form['file_extensions'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Allowed file extensions for uploaded files'),
+    '#default_value' => $extensions,
+    '#description' => t('Separate extensions with a space or comma and do not include the leading dot.'),
+    '#element_validate' => array('_file_generic_settings_extensions'),
+    // By making this field required, we prevent a potential security issue
+    // that would allow files of any type to be uploaded.
+    '#required' => TRUE,
+    '#maxlength' => 255,
+  );
+
+  return $form;
+}
+
+/**
+ * Implements hook_field_is_empty().
+ */
+function mediafield_field_is_empty($item, $field) {
+  return empty($item['fid']);
+}
+
+/**
+ * Implements hook_field_formatter_info().
+ */
+function mediafield_field_formatter_info() {
+  $formatters = array(
+    'media' => array(
+      'label' => t('Media'),
+      'field types' => array('media'),
+      'settings' => array('file_view_mode' => 'default'),
+    ),
+  );
+
+  return $formatters;
+}
+
+/**
+ * Implements hook_field_formatter_settings_form().
+ */
+function mediafield_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $element = array();
+
+  if ($display['type'] == 'media') {
+    $entity_info = entity_get_info('file');
+    $options = array('default' => t('Default'));
+    foreach ($entity_info['view modes'] as $file_view_mode => $file_view_mode_info) {
+      $options[$file_view_mode] = $file_view_mode_info['label'];
+    }
+    $element['file_view_mode'] = array(
+      '#title' => t('File view mode'),
+      '#type' => 'select',
+      '#default_value' => $settings['file_view_mode'],
+      '#options' => $options,
+    );
+  }
+
+  return $element;
+}
+
+/**
+ * Implements hook_field_formatter_settings_summary().
+ */
+function mediafield_field_formatter_settings_summary($field, $instance, $view_mode) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $summary = '';
+
+  if ($display['type'] == 'media') {
+    $entity_info = entity_get_info('file');
+    $file_view_mode_label = isset($entity_info['view modes'][$settings['file_view_mode']]) ? $entity_info['view modes'][$settings['file_view_mode']]['label'] : t('Default');
+    $summary = t('File view mode: @view_mode', array('@view_mode' => $file_view_mode_label));
+  }
+
+  return $summary;
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ */
+function mediafield_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $element = array();
+
+  $files = array();
+  foreach ($items as $delta => $item) {
+    if (!empty($item['file'])) {
+      $files[$item['fid']] = $item['file'];
+    }
+  }
+
+  if (!empty($files)) {
+    $output = file_view_multiple($files, $display['settings']['file_view_mode'], 0, $langcode);
+    // Remove the first level from the output array.
+    $element = reset($output);
+  }
+
+  return $element;
+}
+
+/**
+ * Implements hook_field_prepare_view().
+ */
+function mediafield_field_prepare_view($entity_type, $entities, $field, $instances, $langcode, &$items) {
+  // Collect all file IDs that need loading.
+  $fids = array();
+  foreach ($entities as $id => $entity) {
+    // Load the files from the files table.
+    foreach ($items[$id] as $delta => $item) {
+      if (!empty($item['fid'])) {
+        $fids[] = $item['fid'];
+      }
+    }
+  }
+
+  // Load the file entities.
+  $files = file_load_multiple($fids);
+
+  // Add the loaded file entities to the field item array.
+  foreach ($entities as $id => $entity) {
+    foreach ($items[$id] as $delta => $item) {
+      // If the file does not exist, mark the entire item as empty.
+      if (empty($files[$item['fid']])) {
+        unset($items[$id][$delta]);
+      }
+      else {
+        $items[$id][$delta]['file'] = $files[$item['fid']];
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_field_validate().
+ *
+ * Possible error codes:
+ * - 'media_remote_file_type_not_allowed': The remote file is not an allowed
+ *   file type.
+ */
+function mediafield_field_validate($obj_type, $object, $field, $instance, $langcode, $items, &$errors) {
+  $allowed_types = array_keys(array_filter($instance['widget']['settings']['allowed_types']));
+
+    // @TODO: merge in stuff from media_uri_value
+  foreach ($items as $delta => $item) {
+    if (empty($item['fid'])) {
+      return TRUE;
+      //@TODO: make support for submiting with just a URI here?
+    }
+
+    $file = file_load($item['fid']);
+
+    // Only validate allowed types if the file is remote and not local.
+    if (!file_entity_file_is_local($file)) {
+      if (!in_array($file->type, $allowed_types)) {
+        $errors[$field['field_name']][$langcode][$delta][] = array(
+          'error' => 'media_remote_file_type_not_allowed',
+          'message' => t('%name: Only remote files with the following types are allowed: %types-allowed.', array('%name' => t($instance['label']), '%types-allowed' => !empty($allowed_types) ? implode(', ', $allowed_types) : t('no file types selected'))),
+        );
+      }
+    }
+  }
+}
+
+/**
+ * Implements_hook_field_widget_error().
+ */
+function mediafield_field_widget_error($element, $error, $form, &$form_state) {
+  form_error($element['fid'], $error['message']);
+}
+
+/**
+ * @todo The following hook_field_(insert|update|delete|delete_revision)
+ *   implementations are nearly identical to the File module implementations of
+ *   the same field hooks. The only differences are:
+ *   - We pass 'media' rather than 'file' as the module argument to the
+ *     file_usage_(add|delete)() functions.
+ *   - We do not delete the file / media entity when its usage count goes to 0.
+ *   We should submit a core patch to File module to make it flexible with
+ *   respect to the above, so that we can reuse its implementation rather than
+ *   duplicating it.
+ */
+
+/**
+ * Implements hook_field_insert().
+ */
+function mediafield_field_insert($entity_type, $entity, $field, $instance, $langcode, &$items) {
+  list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
+
+  // Add a new usage of each uploaded file.
+  foreach ($items as $item) {
+    $file = (object) $item;
+    file_usage_add($file, 'mediafield', $entity_type, $id);
+  }
+}
+
+/**
+ * Implements hook_field_update().
+ *
+ * Checks for files that have been removed from the object.
+ */
+function mediafield_field_update($entity_type, $entity, $field, $instance, $langcode, &$items) {
+  list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
+
+  // On new revisions, all files are considered to be a new usage and no
+  // deletion of previous file usages are necessary.
+  if (!empty($entity->revision)) {
+    foreach ($items as $item) {
+      $file = (object) $item;
+      file_usage_add($file, 'mediafield', $entity_type, $id);
+    }
+    return;
+  }
+
+  // Build a display of the current FIDs.
+  $current_fids = array();
+  foreach ($items as $item) {
+    $current_fids[] = $item['fid'];
+  }
+
+  // Compare the original field values with the ones that are being saved.
+  $original_fids = array();
+  if (!empty($entity->original->{$field['field_name']}[$langcode])) {
+    foreach ($entity->original->{$field['field_name']}[$langcode] as $original_item) {
+      $original_fids[] = $original_item['fid'];
+      if (isset($original_item['fid']) && !in_array($original_item['fid'], $current_fids)) {
+        // Decrement the file usage count by 1.
+        $file = (object) $original_item;
+        file_usage_delete($file, 'mediafield', $entity_type, $id, 1);
+      }
+    }
+  }
+
+  // Add new usage entries for newly added files.
+  foreach ($items as $item) {
+    if (!in_array($item['fid'], $original_fids)) {
+      $file = (object) $item;
+      file_usage_add($file, 'mediafield', $entity_type, $id);
+    }
+  }
+}
+
+/**
+ * Implements hook_field_delete().
+ */
+function mediafield_field_delete($entity_type, $entity, $field, $instance, $langcode, &$items) {
+  list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
+
+  // Delete all file usages within this entity.
+  foreach ($items as $delta => $item) {
+    $file = (object) $item;
+    file_usage_delete($file, 'mediafield', $entity_type, $id, 0);
+  }
+}
+
+/**
+ * Implements hook_field_delete_revision().
+ */
+function mediafield_field_delete_revision($entity_type, $entity, $field, $instance, $langcode, &$items) {
+  list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
+  foreach ($items as $delta => $item) {
+    // @TODO: Not sure if this is correct
+    $file = (object)$item;
+    if (file_usage_delete($file, 'mediafield', $entity_type, $id, 1)) {
+      $items[$delta] = NULL;
+    }
+  }
+}
+
+/**
+ * Implements hook_views_api().
+ */
+function mediafield_views_api() {
+  return array(
+    'api' => 3,
+  );
+}
diff --git a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.views.inc b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.views.inc
new file mode 100644
index 0000000..bc1e240
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.views.inc
@@ -0,0 +1,25 @@
+<?php
+
+/**
+ * @file
+ * Provide Views data and handlers for mediafield.
+ */
+
+/**
+ * Implements hook_field_views_data().
+ */
+function mediafield_field_views_data($field) {
+  $data = field_views_field_default_views_data($field);
+  foreach ($data as $table_name => $table_data) {
+    // Add the relationship only on the fid field.
+    $data[$table_name][$field['field_name'] . '_fid']['relationship'] = array(
+      'handler' => 'views_handler_relationship',
+      'base' => 'file_managed',
+      'entity type' => 'file',
+      'base field' => 'fid',
+      'label' => t('file from !field_name', array('!field_name' => $field['field_name'])),
+    );
+  }
+
+  return $data;
+}
diff --git a/profiles/commons/modules/contrib/media/templates/media-dialog-page.tpl.php b/profiles/commons/modules/contrib/media/templates/media-dialog-page.tpl.php
new file mode 100644
index 0000000..f779c1d
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/templates/media-dialog-page.tpl.php
@@ -0,0 +1,91 @@
+<?php
+
+/**
+ * @file
+ * Default theme implementation to display a single Drupal page.
+ *
+ * Available variables:
+ *
+ * General utility variables:
+ * - $base_path: The base URL path of the Drupal installation. At the very
+ *   least, this will always default to /.
+ * - $directory: The directory the template is located in, e.g. modules/system
+ *   or themes/garland.
+ * - $is_front: TRUE if the current page is the front page.
+ * - $logged_in: TRUE if the user is registered and signed in.
+ * - $is_admin: TRUE if the user has permission to access administration pages.
+ *
+ * Site identity:
+ * - $front_page: The URL of the front page. Use this instead of $base_path,
+ *   when linking to the front page. This includes the language domain or
+ *   prefix.
+ * - $logo: The path to the logo image, as defined in theme configuration.
+ * - $site_name: The name of the site, empty when display has been disabled
+ *   in theme settings.
+ * - $site_slogan: The slogan of the site, empty when display has been disabled
+ *   in theme settings.
+ *
+ * Navigation:
+ * - $main_menu (array): An array containing the Main menu links for the
+ *   site, if they have been configured.
+ * - $secondary_menu (array): An array containing the Secondary menu links for
+ *   the site, if they have been configured.
+ * - $breadcrumb: The breadcrumb trail for the current page.
+ *
+ * Page content (in order of occurrence in the default page.tpl.php):
+ * - $title_prefix (array): An array containing additional output populated by
+ *   modules, intended to be displayed in front of the main title tag that
+ *   appears in the template.
+ * - $title: The page title, for use in the actual HTML content.
+ * - $title_suffix (array): An array containing additional output populated by
+ *   modules, intended to be displayed after the main title tag that appears in
+ *   the template.
+ * - $messages: HTML for status and error messages. Should be displayed
+ *   prominently.
+ * - $tabs (array): Tabs linking to any sub-pages beneath the current page
+ *   (e.g., the view and edit tabs when displaying a node).
+ * - $action_links (array): Actions local to the page, such as 'Add menu' on the
+ *   menu administration interface.
+ * - $feed_icons: A string of all feed icons for the current page.
+ * - $node: The node object, if there is an automatically-loaded node
+ *   associated with the page, and the node ID is the second argument
+ *   in the page's path (e.g. node/12345 and node/12345/revisions, but not
+ *   comment/reply/12345).
+ *
+ * Regions:
+ * - $page['help']: Dynamic help text, mostly for admin pages.
+ * - $page['highlight']: Items for the highlighted content region.
+ * - $page['content']: The main content of the current page.
+ * - $page['sidebar_first']: Items for the first sidebar.
+ * - $page['sidebar_second']: Items for the second sidebar.
+ * - $page['header']: Items for the header region.
+ * - $page['footer']: Items for the footer region.
+ *
+ * @see template_preprocess()
+ * @see template_preprocess_page()
+ * @see template_process()
+ */
+?>
+
+<?php if (isset($messages)) { print $messages; } ?>
+<div id="media-browser-page-wrapper">
+  <div id="media-browser-page">
+    <div id="media-browser-tabset">
+      <div id="branding" class="clearfix">
+        <div>
+          <h1><?php print render($page['content']['system_main']['title']); ?></h1>
+        </div>
+        <div id="media-tabs-wrapper">
+          <?php print render($page['content']['system_main']['tabset']['tabs']); ?>
+        </div>
+      </div>
+      <?php print render($page['content']['system_main']['tabset']['panes']); ?>
+    </div> <!-- /#media-tabs-set -->
+  </div> <!--  /#media-browser-page -->
+</div> <!-- /#media-browser-page-wrapper -->
+
+<?php
+  hide($page['content']['system_main']['tabset']);
+  hide($page['content']['system_main']['title']);
+  print render($page['content']);
+?>
diff --git a/profiles/commons/modules/contrib/media/views/media_default.view.inc b/profiles/commons/modules/contrib/media/views/media_default.view.inc
new file mode 100644
index 0000000..f4ba4b9
--- /dev/null
+++ b/profiles/commons/modules/contrib/media/views/media_default.view.inc
@@ -0,0 +1,171 @@
+<?php
+
+/**
+ * @file
+ * The default view for the media browser library tab.
+ */
+
+$view = new view();
+$view->name = 'media_default';
+$view->description = 'Default view for the media browser library tab.';
+$view->tag = 'media, default';
+$view->base_table = 'file_managed';
+$view->human_name = 'Media browser';
+$view->core = 7;
+$view->api_version = '3.0';
+$view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */
+
+/* Display: Master */
+$handler = $view->new_display('default', 'Master', 'default');
+$handler->display->display_options['use_ajax'] = TRUE;
+$handler->display->display_options['use_more_always'] = FALSE;
+$handler->display->display_options['group_by'] = TRUE;
+$handler->display->display_options['access']['type'] = 'perm';
+$handler->display->display_options['access']['perm'] = 'view files';
+$handler->display->display_options['cache']['type'] = 'none';
+$handler->display->display_options['query']['type'] = 'views_query';
+$handler->display->display_options['query']['options']['query_tags'] = array(
+  0 => 'media_browser',
+);
+$handler->display->display_options['exposed_form']['type'] = 'basic';
+$handler->display->display_options['exposed_form']['options']['autosubmit'] = TRUE;
+$handler->display->display_options['pager']['type'] = 'full';
+$handler->display->display_options['pager']['options']['items_per_page'] = '25';
+$handler->display->display_options['pager']['options']['offset'] = '0';
+$handler->display->display_options['pager']['options']['id'] = '0';
+$handler->display->display_options['style_plugin'] = 'media_browser';
+/* No results behavior: Global: Text area */
+$handler->display->display_options['empty']['area']['id'] = 'area';
+$handler->display->display_options['empty']['area']['table'] = 'views';
+$handler->display->display_options['empty']['area']['field'] = 'area';
+$handler->display->display_options['empty']['area']['content'] = 'No files available.';
+$handler->display->display_options['empty']['area']['format'] = 'plain_text';
+/* Field: File: Name */
+$handler->display->display_options['fields']['filename']['id'] = 'filename';
+$handler->display->display_options['fields']['filename']['table'] = 'file_managed';
+$handler->display->display_options['fields']['filename']['field'] = 'filename';
+$handler->display->display_options['fields']['filename']['label'] = '';
+$handler->display->display_options['fields']['filename']['alter']['word_boundary'] = FALSE;
+$handler->display->display_options['fields']['filename']['alter']['ellipsis'] = FALSE;
+$handler->display->display_options['fields']['filename']['link_to_file'] = TRUE;
+/* Sort criterion: File: Upload date */
+$handler->display->display_options['sorts']['timestamp']['id'] = 'timestamp';
+$handler->display->display_options['sorts']['timestamp']['table'] = 'file_managed';
+$handler->display->display_options['sorts']['timestamp']['field'] = 'timestamp';
+$handler->display->display_options['sorts']['timestamp']['order'] = 'DESC';
+$handler->display->display_options['sorts']['timestamp']['exposed'] = TRUE;
+$handler->display->display_options['sorts']['timestamp']['expose']['label'] = 'Upload date';
+/* Sort criterion: SUM(File Usage: Use count) */
+$handler->display->display_options['sorts']['count']['id'] = 'count';
+$handler->display->display_options['sorts']['count']['table'] = 'file_usage';
+$handler->display->display_options['sorts']['count']['field'] = 'count';
+$handler->display->display_options['sorts']['count']['group_type'] = 'sum';
+$handler->display->display_options['sorts']['count']['exposed'] = TRUE;
+$handler->display->display_options['sorts']['count']['expose']['label'] = 'Use count';
+/* Filter criterion: File: Status */
+$handler->display->display_options['filters']['status']['id'] = 'status';
+$handler->display->display_options['filters']['status']['table'] = 'file_managed';
+$handler->display->display_options['filters']['status']['field'] = 'status';
+$handler->display->display_options['filters']['status']['value'] = array(
+  1 => '1',
+);
+/* Filter criterion: File: Name */
+$handler->display->display_options['filters']['filename']['id'] = 'filename';
+$handler->display->display_options['filters']['filename']['table'] = 'file_managed';
+$handler->display->display_options['filters']['filename']['field'] = 'filename';
+$handler->display->display_options['filters']['filename']['operator'] = 'contains';
+$handler->display->display_options['filters']['filename']['exposed'] = TRUE;
+$handler->display->display_options['filters']['filename']['expose']['operator_id'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['label'] = 'File name';
+$handler->display->display_options['filters']['filename']['expose']['operator'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['identifier'] = 'filename';
+/* Filter criterion: File: Type */
+$handler->display->display_options['filters']['type']['id'] = 'type';
+$handler->display->display_options['filters']['type']['table'] = 'file_managed';
+$handler->display->display_options['filters']['type']['field'] = 'type';
+$handler->display->display_options['filters']['type']['exposed'] = TRUE;
+$handler->display->display_options['filters']['type']['expose']['operator_id'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['label'] = 'Type';
+$handler->display->display_options['filters']['type']['expose']['operator'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['identifier'] = 'type';
+
+/* Display: Media browser */
+$handler = $view->new_display('media_browser', 'Media browser', 'media_browser_1');
+$handler->display->display_options['defaults']['title'] = FALSE;
+$handler->display->display_options['title'] = 'Library';
+$handler->display->display_options['defaults']['hide_admin_links'] = FALSE;
+
+/* Display: My files */
+$handler = $view->new_display('media_browser', 'My files', 'media_browser_my_files');
+$handler->display->display_options['defaults']['title'] = FALSE;
+$handler->display->display_options['title'] = 'My files';
+$handler->display->display_options['defaults']['hide_admin_links'] = FALSE;
+$handler->display->display_options['defaults']['access'] = FALSE;
+$handler->display->display_options['access']['type'] = 'perm';
+$handler->display->display_options['access']['perm'] = 'view own files';
+$handler->display->display_options['defaults']['relationships'] = FALSE;
+/* Relationship: File: User who uploaded */
+$handler->display->display_options['relationships']['uid']['id'] = 'uid';
+$handler->display->display_options['relationships']['uid']['table'] = 'file_managed';
+$handler->display->display_options['relationships']['uid']['field'] = 'uid';
+$handler->display->display_options['relationships']['uid']['required'] = TRUE;
+$handler->display->display_options['defaults']['arguments'] = FALSE;
+$handler->display->display_options['defaults']['filter_groups'] = FALSE;
+$handler->display->display_options['defaults']['filters'] = FALSE;
+/* Filter criterion: File: Status */
+$handler->display->display_options['filters']['status']['id'] = 'status';
+$handler->display->display_options['filters']['status']['table'] = 'file_managed';
+$handler->display->display_options['filters']['status']['field'] = 'status';
+$handler->display->display_options['filters']['status']['value'] = array(
+  1 => '1',
+);
+/* Filter criterion: File: Name */
+$handler->display->display_options['filters']['filename']['id'] = 'filename';
+$handler->display->display_options['filters']['filename']['table'] = 'file_managed';
+$handler->display->display_options['filters']['filename']['field'] = 'filename';
+$handler->display->display_options['filters']['filename']['operator'] = 'contains';
+$handler->display->display_options['filters']['filename']['exposed'] = TRUE;
+$handler->display->display_options['filters']['filename']['expose']['operator_id'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['label'] = 'File name';
+$handler->display->display_options['filters']['filename']['expose']['operator'] = 'filename_op';
+$handler->display->display_options['filters']['filename']['expose']['identifier'] = 'filename';
+/* Filter criterion: File: Type */
+$handler->display->display_options['filters']['type']['id'] = 'type';
+$handler->display->display_options['filters']['type']['table'] = 'file_managed';
+$handler->display->display_options['filters']['type']['field'] = 'type';
+$handler->display->display_options['filters']['type']['exposed'] = TRUE;
+$handler->display->display_options['filters']['type']['expose']['operator_id'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['label'] = 'Type';
+$handler->display->display_options['filters']['type']['expose']['operator'] = 'type_op';
+$handler->display->display_options['filters']['type']['expose']['identifier'] = 'type';
+/* Filter criterion: User: Current */
+$handler->display->display_options['filters']['uid_current']['id'] = 'uid_current';
+$handler->display->display_options['filters']['uid_current']['table'] = 'users';
+$handler->display->display_options['filters']['uid_current']['field'] = 'uid_current';
+$handler->display->display_options['filters']['uid_current']['relationship'] = 'uid';
+$handler->display->display_options['filters']['uid_current']['value'] = '1';
+$translatables['media_default'] = array(
+  t('Master'),
+  t('more'),
+  t('Apply'),
+  t('Reset'),
+  t('Sort by'),
+  t('Asc'),
+  t('Desc'),
+  t('Items per page'),
+  t('- All -'),
+  t('Offset'),
+  t(' first'),
+  t(' previous'),
+  t('next '),
+  t('last '),
+  t('No files available.'),
+  t('Upload date'),
+  t('Use count'),
+  t('File name'),
+  t('Type'),
+  t('Media browser'),
+  t('Library'),
+  t('My files'),
+  t('User who uploaded'),
+);
diff --git a/profiles/commons/modules/contrib/message_subscribe/LICENSE.txt b/profiles/commons/modules/contrib/message_subscribe/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/message_subscribe/PATCHES.txt b/profiles/commons/modules/contrib/message_subscribe/PATCHES.txt
deleted file mode 100644
index 03f0bd9..0000000
--- a/profiles/commons/modules/contrib/message_subscribe/PATCHES.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-The following patches have been applied to this project:
-- http://drupal.org/files/email-notifiers-1828184-15.patch
-
-This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/message_subscribe/includes/message_subscribe.admin.inc b/profiles/commons/modules/contrib/message_subscribe/includes/message_subscribe.admin.inc
index f02e57c..fc9efdd 100644
--- a/profiles/commons/modules/contrib/message_subscribe/includes/message_subscribe.admin.inc
+++ b/profiles/commons/modules/contrib/message_subscribe/includes/message_subscribe.admin.inc
@@ -19,6 +19,13 @@ function message_subscribe_admin_settings() {
     '#required' => FALSE,
   );
 
+  $form['message_subscribe_notify_own_actions'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Notify author of their own submissions'),
+    '#description' => t('Determines if the user that caused the message notification receive a message about their actions. e.g. If I add a comment to a node, should I get an email saying I added a comment to a node?'),
+    '#default_value' => variable_get('message_subscribe_notify_own_actions', FALSE),
+  );
+
   $prefix = variable_get('message_subscribe_flag_prefix', 'subscribe') . '_';
 
   // For every subscription flag, show a view selection.
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
index e5b88b6..a19809d 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
@@ -11,10 +11,9 @@ dependencies[] = message_notify
 
 files[] = message_subscribe.test
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0-alpha5+7-dev"
+; Information added by  packaging script on 2013-11-11
+version = "7.x-1.0-rc1"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1382042538"
+datestamp = "1384158206"
 
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.install b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.install
index 5857ae2..d5d138d 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.install
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.install
@@ -14,4 +14,5 @@ function message_subscribe_uninstall() {
   variable_del('message_subscribe_default_notifiers');
   variable_del('message_subscribe_flag_prefix');
   variable_del('message_subscribe_use_queue');
+  variable_del('message_subscribe_notify_own_actions');
 }
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.module b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.module
index 39cb8ff..6d6d633 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.module
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.module
@@ -35,6 +35,9 @@
  *     worker. see message_subscribe_queue_worker().
  *   - "entity access": Determine if access to view the entity should be applied
  *     when getting the list of subscribed users. Defaults to TRUE.
+ *   - "notify_own_actions": Determines if the user that created the entity
+ *      gets notified of their own action. If TRUE the author will get notified.
+ *      Defaults to FALSE.
  * @param $context
  *   Optional; Array keyed with the entity type and array of entity IDs as
  *   the value. For example, if the event is related to a node
@@ -56,6 +59,7 @@
  */
 function message_subscribe_send_message($entity_type, $entity, Message $message, $notify_options = array(), $subscribe_options = array(), $context = array()) {
   $use_queue = isset($subscribe_options['use queue']) ? $subscribe_options['use queue'] : variable_get('message_subscribe_use_queue', FALSE);
+  $notify_own_actions = isset($subscribe_options['notify_own_actions']) ? $subscribe_options['notify_own_actions'] : variable_get('message_subscribe_notify_own_actions', FALSE);
 
   // Save message by default.
   $subscribe_options += array(
@@ -68,6 +72,7 @@ function message_subscribe_send_message($entity_type, $entity, Message $message,
     'use queue' => $use_queue,
     'queue' => FALSE,
     'entity access' => TRUE,
+    'notify_own_actions' => $notify_own_actions,
   );
 
   if (empty($message->mid) && $subscribe_options['save message']) {
@@ -121,7 +126,6 @@ function message_subscribe_send_message($entity_type, $entity, Message $message,
     return $message;
   }
 
-
   foreach ($uids as $uid => $values) {
     $last_uid = $uid;
     // Clone the message in case it will need to be saved, it won't
@@ -200,6 +204,7 @@ function message_subscribe_send_message($entity_type, $entity, Message $message,
  */
 function message_subscribe_get_subscribers($entity_type, $entity, Message $message, $subscribe_options = array(), &$context = array()) {
   $context = $context ? $context : message_subscribe_get_basic_context($entity_type, $entity, $subscribe_options, $context);
+  $notify_own_actions = isset($subscribe_options['notify_own_actions']) ? $subscribe_options['notify_own_actions'] : variable_get('message_subscribe_notify_own_actions', FALSE);
 
   $uids = array();
   // We don't use module_invoke_all() is we want to retain the array keys,
@@ -208,6 +213,11 @@ function message_subscribe_get_subscribers($entity_type, $entity, Message $messa
     $function = $module . '_message_subscribe_get_subscribers';
     $result = $function($message, $subscribe_options, $context);
     foreach ($result as $uid => $values) {
+      // See if the author of the entity gets notified.
+      if ($notify_own_actions && $entity->uid == $uid) {
+        continue;
+      }
+
       if (!empty($subscribe_options['entity access'])) {
         $account = user_load($uid);
         if (!entity_access('view', $entity_type, $entity, $account)) {
@@ -215,6 +225,7 @@ function message_subscribe_get_subscribers($entity_type, $entity, Message $messa
           continue;
         }
       }
+
       $uids[$uid] = $values;
     }
   }
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.test b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.test
index 8f186ab..ba4d2f3 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.test
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.test
@@ -282,6 +282,56 @@ class MessageSubscribeSubscribersTest extends DrupalWebTestCase {
   }
 
   /**
+   * Testing the exclusion of the entity author from the subscribers lists.
+   */
+  function testGetSubscribersExcludeSelf() {
+    // Test the affect of the variable when set to TRUE.
+    variable_set('message_subscribe_notify_own_actions', TRUE);
+    $message = message_create('foo', array());
+
+    $node = $this->node;
+    $user1 = $this->user1;
+    $user2 = $this->user2;
+
+    $uids = message_subscribe_get_subscribers('node', $node, $message);
+
+    // Assert subscribers data.
+    $expected_uids = array(
+      $user2->uid => array(
+        'notifiers' => array(),
+        'flags' => array(
+          'subscribe_node',
+          'subscribe_user',
+        ),
+      ),
+    );
+    $this->assertEqual($uids, $expected_uids, 'All subscribers except for the triggering user were fetched.');
+
+    // Test the affect of the variable when set to FALSE.
+    variable_set('message_subscribe_notify_own_actions', FALSE);
+
+    $uids = message_subscribe_get_subscribers('node', $node, $message);
+
+    // Assert subscribers data.
+    $expected_uids = array(
+      $user1->uid => array(
+        'notifiers' => array(),
+        'flags' => array(
+          'subscribe_node',
+        ),
+      ),
+      $user2->uid => array(
+        'notifiers' => array(),
+        'flags' => array(
+          'subscribe_node',
+          'subscribe_user',
+        ),
+      ),
+    );
+    $this->assertEqual($uids, $expected_uids, 'All subscribers including the triggering user were fetched.');
+  }
+
+  /**
    * Assert subscribers list is entity-access aware.
    */
   function testEntityAccess() {
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
index 8531ce0..a0a234e 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
@@ -10,10 +10,9 @@ dependencies[] = views
 
 files[] = message_subscribe_email.test
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0-alpha5+7-dev"
+; Information added by  packaging script on 2013-11-11
+version = "7.x-1.0-rc1"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1382042538"
+datestamp = "1384158206"
 
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/includes/message_subscribe_ui.admin.inc b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/includes/message_subscribe_ui.admin.inc
deleted file mode 100644
index 68593ae..0000000
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/includes/message_subscribe_ui.admin.inc
+++ /dev/null
@@ -1,56 +0,0 @@
-<?php
-
-/**
- * @file
- * Administration settings for Message subscribe UI.
- */
-
-/**
- * Menu callback; Admin settings form.
- */
-function message_subscribe_ui_admin_settings() {
-  $form['message_subscribe_default_notifiers'] = array(
-    '#type' => 'select',
-    '#title' => t('Default message notifiers'),
-    '#description' => t('Which message notifiers will be added to every subscription.'),
-    '#default_value' => variable_get('message_subscribe_default_notifiers', 'email'),
-    '#multiple' => TRUE,
-    '#options' => message_notify_get_notifiers_as_options(),
-    '#required' => FALSE,
-  );
-
-  $prefix = variable_get('message_subscribe_flag_prefix', 'subscribe') . '_';
-
-  // For every subscription flag, show a view selection.
-  foreach (message_subscribe_flag_get_flags() as $flag) {
-    $name = 'message_' . $flag->name;
-    $params = array('@title' => $flag->title);
-
-    $form[$name] = array(
-      '#type' => 'select',
-      '#title' => t('View for flag <em>@title</em>', $params),
-      '#description' => t('Select the View that should be used for flag @title.', $params),
-      '#options' => views_get_views_as_options(),
-      '#default_value' => variable_get($name, $prefix . $flag->content_type . ':default'),
-      '#required' => TRUE,
-    );
-  }
-
-  $form['message_subscribe_flag_prefix'] = array(
-    '#type' => 'textfield',
-    '#title' => t('Flag prefix'),
-    '#description' => t('The prefix that will be used to identify subscription flags. This can be used if you already have flags defined with another prefix e.g. "follow".'),
-    '#default_value' => variable_get('message_subscribe_flag_prefix', 'subscribe'),
-    '#required' => FALSE,
-  );
-
-  $form['message_subscribe_use_queue'] = array(
-    '#type' => 'checkbox',
-    '#title' => t('Use queue'),
-    '#description' => t('Use "Advanced-Queue" module to process the Messages.'),
-    '#default_value' => variable_get('message_subscribe_use_queue', FALSE),
-    '#disabled' => !module_exists('advancedqueue'),
-  );
-
-  return system_settings_form($form);
-}
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
index f75e405..b186ab3 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
@@ -14,10 +14,9 @@ features[views_view][] = subscribe_node
 features[views_view][] = subscribe_taxonomy_term
 features[views_view][] = subscribe_user
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-1.0-alpha5+7-dev"
+; Information added by  packaging script on 2013-11-11
+version = "7.x-1.0-rc1"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1382042538"
+datestamp = "1384158206"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag.entity_translation.inc b/profiles/commons/modules/contrib/metatag/metatag.entity_translation.inc
deleted file mode 100644
index ac9dd87..0000000
--- a/profiles/commons/modules/contrib/metatag/metatag.entity_translation.inc
+++ /dev/null
@@ -1,53 +0,0 @@
-<?php
-/**
- * @file
- * Meta Tags implementation of Entity Translation hooks.
- */
-
-/**
- * Implements hook_entity_translation_insert().
- */
-function metatag_entity_translation_insert($entity_type, $entity, $translation, $values = array()) {
-  // The update hook can handle both cases so just call that one.
-  metatag_entity_translation_update($entity_type, $entity, $translation, $values);
-}
-
-/**
- * Implements hook_entity_translation_update().
- */
-function metatag_entity_translation_update($entity_type, $entity, $translation, $values = array()) {
-  // Get the ID of the entity.
-  list($entity_id) = entity_extract_ids($entity_type, $entity);
-
-  // Grab the meta tag data only; we don't need anything else.
-  $values = isset($values['metatags']) ? $values['metatags'] : array();
-
-  // Set the default values to be that of the entity's original language (whose
-  // tags are shown if the current language has none set) so that we can
-  // extract these from the form elements if they haven't been changed.
-  $entity_language = function_exists('entity_language') ?
-    entity_language($entity_type, $entity) : $entity->language;
-  if ($entity_language && isset($entity->metatags[$entity_language])) {
-    $defaults = $entity->metatags[$entity_language];
-  }
-  else {
-    $defaults = array();
-  }
-
-  // Remove all of the defaults.
-  metatag_filter_values_from_defaults($values, $defaults);
-
-  // Save the new data.
-  metatag_metatags_save($entity_type, $entity_id, $values, $translation['language']);
-}
-
-/**
- * Implements hook_entity_translation_delete().
- */
-function metatag_entity_translation_delete($entity_type, $entity, $langcode) {
-  // Get the entity's ID.
-  list($entity_id) = entity_extract_ids($entity_type, $entity);
-
-  // Delete the translation.
-  metatag_metatags_delete($entity_type, $entity_id, $langcode);
-}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.metatag.inc b/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
index 0c699fb..bd89255 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
@@ -224,12 +224,5 @@ function metatag_metatag_info() {
     'description' => "Used to indicate the URL that broke the story, and can link to either an internal URL or an external source. If the full URL is not known it is acceptable to use a partial URL or just the domain name.",
   );
 
-  $info['tags']['author'] = array(
-    'label' => t('Author URL'),
-    'description' => 'Used by some search engines to aid confirm authorship of the content on a page. Should be either the full URL for the author\'s Google+ profile page or a local page with information about the author.',
-    'class' => 'DrupalLinkMetaTag',
-    'group' => 'advanced',
-  );
-
   return $info;
 }
diff --git a/profiles/commons/modules/contrib/mollom/INSTALL.txt b/profiles/commons/modules/contrib/mollom/INSTALL.txt
deleted file mode 100644
index 008f4a6..0000000
--- a/profiles/commons/modules/contrib/mollom/INSTALL.txt
+++ /dev/null
@@ -1,26 +0,0 @@
-To install and configure the Drupal Mollom module:
-
- 1. Download the Mollom module from http://drupal.org/project/mollom or http://mollom.com/download.
-    Be sure to pick a version of the Mollom client that matches your version of Drupal. The module
-    package should be placed with the rest of your contributed Drupal modules (generally,
-    in "sites/all/modules" or "sites/default/modules").
-
- 2. Go to http://mollom.com.
-
- 3. Login with your Mollom.com account, or create an account if you don't have one.
-
- 4. Select "Manage sites" from the upper right menu at Mollom.com.
-
- 5. Select "Add subscription" to create a new key pair for your website (or "edit subscription" to
-    access a subscription for an existing site tied to your account).
-
- 6. Visit your site's module list (Administer >> Site building >> Modules) and enable the Mollom module.
-
- 7. Visit your site's Mollom settings page (Administer >> Site configuration >> Mollom) and enter the key
-    pair associated with your site (from step 5).
-
- 8. Review the other Mollom settings and adjust as necessary.
-
-For support go to http://mollom.com/support. A tutorial for the Drupal module is also available at
-http://mollom.com/tutorials/drupal.
-
diff --git a/profiles/commons/modules/contrib/mollom/LICENSE.txt b/profiles/commons/modules/contrib/mollom/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/mollom/includes/CHANGELOG.md b/profiles/commons/modules/contrib/mollom/includes/CHANGELOG.md
index 6167355..a87e09b 100644
--- a/profiles/commons/modules/contrib/mollom/includes/CHANGELOG.md
+++ b/profiles/commons/modules/contrib/mollom/includes/CHANGELOG.md
@@ -2,10 +2,21 @@
 
 This library aims to provide a stable and reliable class for integration into other applications, avoiding backwards-incompatible changes, but that cannot always be guaranteed.
 
-This file lists all major changes and additions to the PHP API for convenience.  "API" means the PHP class only; i.e., not the Mollom [REST API](http://mollom.com/api).
+This file lists all major changes and additions to the PHP API for convenience.  "API" means the PHP class only; i.e., not the Mollom [REST API].
 
 ## Changes
 
+2013-11-09: Any `4xx` request error response code is now returned to application.
+
+* All client implementations need to account for all possible `4xx` errors now; primarily:
+    * `400 Bad Request` ( `Mollom::REQUEST_ERROR`)
+    * `401 Unauthorized` ( `Mollom::AUTH_ERROR`)
+    * `404 Not Found`
+* `Mollom::query()` previously
+    * retried a request despite a `4xx` error (except for `404`).
+    * returned either `Mollom::REQUEST_ERROR` (`400`) or `Mollom::NETWORK_ERROR` (`900`).
+* For example, a `404 Not Found` error may be returned by the Site API of the [REST Testing API], when trying to access a site resource that has vanished.
+
 2013-04-23: Visibility of `Mollom::query()` changed from `protected` to `public`.
 
 * Only affects classes that are overriding the `Mollom::query()` method (rare).
@@ -25,3 +36,5 @@ This file lists all major changes and additions to the PHP API for convenience.
 ## Additions
 
 
+[REST API]: http://mollom.com/api
+[REST Testing API]: http://mollom.com/api#api-test
diff --git a/profiles/commons/modules/contrib/mollom/includes/composer.json b/profiles/commons/modules/contrib/mollom/includes/composer.json
new file mode 100644
index 0000000..418907b
--- /dev/null
+++ b/profiles/commons/modules/contrib/mollom/includes/composer.json
@@ -0,0 +1,10 @@
+{
+  "name": "mollom/client",
+  "description": "Generic PHP library for Mollom's REST API.",
+  "license": "MIT",
+  "keywords": ["mollom", "spam"],
+  "authors": [{
+    "name": "sun",
+    "email": "sun@mollom.com"
+  }]
+}
diff --git a/profiles/commons/modules/contrib/mollom/includes/mollom.class.inc b/profiles/commons/modules/contrib/mollom/includes/mollom.class.inc
index 0e2c795..04e8650 100644
--- a/profiles/commons/modules/contrib/mollom/includes/mollom.class.inc
+++ b/profiles/commons/modules/contrib/mollom/includes/mollom.class.inc
@@ -295,21 +295,22 @@ abstract class Mollom {
     // Send the request to the server.
     $server = 'http://' . $this->server;
     $max_attempts = $this->requestMaxAttempts;
-    while ($max_attempts--) {
+    while ($max_attempts-- > 0) {
       try {
         $result = $this->handleRequest($method, $server, $path, $data, $expected);
       }
       catch (MollomBadRequestException $e) {
-        // This is an irrecoverable error, so don't try further.
+        // Irrecoverable error, so don't try further.
         break;
       }
       catch (MollomAuthenticationException $e) {
-        // This is an irrecoverable error, so don't try further.
+        // Irrecoverable error, so don't try further.
         break;
       }
       catch (MollomException $e) {
-        // If the resource does not exist, there is no point in trying further.
-        if ($e->getCode() === 404) {
+        // If the requested resource does not exist, or the request was
+        // malformed, there is no point in trying further.
+        if ($e->getCode() >= 400 && $e->getCode() < 500) {
           break;
         }
       }
@@ -352,19 +353,14 @@ abstract class Mollom {
     if ($this->lastResponseCode === self::RESPONSE_ERROR) {
       return $this->lastResponseCode;
     }
-    // Return a request error, which always requires to take client-side
-    // measures to resolve the problem.
-    if ($this->lastResponseCode === self::REQUEST_ERROR) {
-      return $this->lastResponseCode;
-    }
     // Return an authentication error, which may require special client-side
     // processing.
     if ($this->lastResponseCode === self::AUTH_ERROR) {
       return $this->lastResponseCode;
     }
-    // Return a not found error, which always needs to be handled by the calling
-    // code.
-    if ($this->lastResponseCode === 404) {
+    // Return a request error, which always requires client-side measures to
+    // resolve the problem.
+    if ($this->lastResponseCode >= self::REQUEST_ERROR && $this->lastResponseCode < 500) {
       return $this->lastResponseCode;
     }
 
@@ -410,6 +406,7 @@ abstract class Mollom {
    * @see json_decode()
    */
   protected function handleRequest($method, $server, $path, $data, $expected = array()) {
+    $time_start = microtime(TRUE);
     if (!empty($this->publicKey) && !empty($this->privateKey)) {
       // @todo Move into class property.
       $headers['Accept'] = 'application/xml, application/json;q=0.8, */*;q=0.5';
@@ -435,6 +432,7 @@ abstract class Mollom {
       $response->isError = TRUE;
       $response->body = NULL;
     }
+    $time_stop = microtime(TRUE);
 
     // Parse the response body string into an array.
     $response->data = array();
@@ -488,6 +486,7 @@ abstract class Mollom {
       'response_code' => $response->code,
       'response_message' => $response->message,
       'response' => !empty($response->data) ? $response->data : $response->body,
+      'response_time' => $time_stop - $time_start,
     );
     if ($response->isError) {
       if ($response->code <= 0) {
diff --git a/profiles/commons/modules/contrib/mollom/mollom.admin.inc b/profiles/commons/modules/contrib/mollom/mollom.admin.inc
index bb7f4d9..ba5b30d 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.admin.inc
+++ b/profiles/commons/modules/contrib/mollom/mollom.admin.inc
@@ -46,29 +46,46 @@ function mollom_admin_form_list() {
 
   $rows = array();
   foreach ($forms as $form_id => $mollom_form) {
+    $row_attributes = array();
     $row = array();
     $row[] = $mollom_form['title'];
-    if ($mollom_form['mode'] == MOLLOM_MODE_ANALYSIS) {
-      // @todo Output unsure mode in summary listing.
-      $row[] = t('!protection-mode (@discard)', array(
-        '!protection-mode' => $modes[$mollom_form['mode']],
-        '@discard' => $mollom_form['discard'] ? t('discard') : t('retain'),
+    if (isset($modes[$mollom_form['mode']])) {
+      if ($mollom_form['mode'] == MOLLOM_MODE_ANALYSIS) {
+        // @todo Output unsure mode in summary listing.
+        $row[] = t('!protection-mode (@discard)', array(
+          '!protection-mode' => $modes[$mollom_form['mode']],
+          '@discard' => $mollom_form['discard'] ? t('discard') : t('retain'),
+        ));
+      }
+      else {
+        $row[] = $modes[$mollom_form['mode']];
+      }
+    }
+    else {
+      $row[] = t('- orphan -');
+    }
+    if (empty($mollom_form['orphan'])) {
+      $row[] = array('data' => array(
+        '#type' => 'link',
+        '#title' => t('Configure'),
+        '#href' => 'admin/config/content/mollom/manage/' . $form_id,
       ));
     }
     else {
-      $row[] = $modes[$mollom_form['mode']];
+      $row[] = '';
+      $row_attributes['class'] = array('error');
+      drupal_set_message(t("%module module's %form_id form no longer exists.", array(
+        '%form_id' => $form_id,
+        '%module' => isset($module_info[$mollom_form['module']]['name']) ? t($module_info[$mollom_form['module']]['name']) : $mollom_form['module'],
+      )), 'warning');
     }
     $row[] = array('data' => array(
       '#type' => 'link',
-      '#title' => t('Configure'),
-      '#href' => 'admin/config/content/mollom/manage/' . $form_id,
-    ));
-    $row[] = array('data' => array(
-      '#type' => 'link',
       '#title' => t('Unprotect'),
       '#href' => 'admin/config/content/mollom/unprotect/' . $form_id,
     ));
-    $rows[] = $row;
+
+    $rows[] = $row_attributes + array('data' => $row);
   }
 
   $build['forms'] = array(
@@ -171,6 +188,7 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
 
     case 'configure':
       drupal_set_title(t('Configure %form-title protection', array('%form-title' => $mollom_form['title'])), PASS_THROUGH);
+      $recommended = t('recommended');
 
       $form['mollom']['form_id'] = array(
         '#type' => 'value',
@@ -178,8 +196,11 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
       );
 
       $modes = array();
-      $modes[MOLLOM_MODE_ANALYSIS] = t('Text analysis');
-      $modes[MOLLOM_MODE_CAPTCHA] = t('CAPTCHA');
+      $modes[MOLLOM_MODE_ANALYSIS] = t('!option <em>(!recommended)</em>', array(
+        '!option' => t('Text analysis'),
+        '!recommended' => $recommended,
+      ));
+      $modes[MOLLOM_MODE_CAPTCHA] = t('CAPTCHA only');
 
       $form['mollom']['mode'] = array(
         '#type' => 'radios',
@@ -187,9 +208,13 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
         '#options' => $modes,
         '#default_value' => isset($mollom_form['mode']) ? $mollom_form['mode'] : key($modes),
       );
+      $form['mollom']['mode'][MOLLOM_MODE_ANALYSIS] = array(
+        '#description' => t('Mollom will analyze the post and will only show a CAPTCHA when it is unsure.'),
+      );
       $form['mollom']['mode'][MOLLOM_MODE_CAPTCHA] = array(
-        '#description' => t('Only choose CAPTCHA if text analysis is not suitable. Page caching is disabled on all pages containing CAPTCHA-only protected forms.'),
+        '#description' => t('A CAPTCHA will be shown for every post. Only choose this if there are too few text fields to analyze.'),
       );
+      $form['mollom']['mode'][MOLLOM_MODE_CAPTCHA]['#description'] .= '<br />' . t('Note: Page caching is disabled on all pages containing a CAPTCHA-only protected form.');
 
       $all_permissions = array();
       foreach (module_implements('permission') as $module) {
@@ -283,8 +308,11 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
         '#type' => 'radios',
         '#title' => t('Text analysis strictness'),
         '#options' => array(
+          'normal' => t('!option <em>(!recommended)</em>', array(
+            '!option' => t('Normal'),
+            '!recommended' => $recommended,
+          )),
           'strict' => t('Strict: Posts are more likely classified as spam'),
-          'normal' => t('Normal'),
           'relaxed' => t('Relaxed: Posts are more likely classified as ham'),
         ),
         '#default_value' => $mollom_form['strictness'],
@@ -300,7 +328,10 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
         '#title' => t('When text analysis is unsure'),
         '#default_value' => $mollom_form['unsure'],
         '#options' => array(
-          'captcha' => t('Show a CAPTCHA'),
+          'captcha' => t('!option <em>(!recommended)</em>', array(
+            '!option' => t('Show a CAPTCHA'),
+            '!recommended' => $recommended,
+          )),
           'moderate' => t('Retain the post for manual moderation'),
           'binary' => t('Accept the post'),
         ),
@@ -321,8 +352,11 @@ function mollom_admin_configure_form($form, &$form_state, $mollom_form = NULL) {
         '#title' => t('When text analysis identifies spam'),
         '#default_value' => $mollom_form['discard'],
         '#options' => array(
+          1 => t('!option <em>(!recommended)</em>', array(
+            '!option' => t('Discard the post'),
+            '!recommended' => $recommended,
+          )),
           0 => t('Retain the post for manual moderation'),
-          1 => t('Discard the post'),
         ),
         '#required' => $mollom_form['mode'] == MOLLOM_MODE_ANALYSIS,
         // Only possible for forms supporting moderation of unpublished posts.
@@ -486,12 +520,15 @@ function mollom_admin_blacklist_form($form, &$form_state, $type = 'spam') {
 
   // Translate internal reason values for rendering and select list in form.
   $contexts = array(
-    'allFields' => t('All fields'),
-    'links' => t('Links'),
+    'allFields' => t('- All fields -'),
+    'author' => t('- All author fields -'),
     'authorName' => t('Author name'),
     'authorMail' => t('Author e-mail'),
-    'authorIp' => t('IP address'),
-    'authorId' => t('User ID'),
+    'authorIp' => t('Author IP'),
+    'authorId' => t('Author User ID'),
+    'post' => t('- All post fields -'),
+    'postTitle' => t('Post title'),
+    'links' => t('Links'),
   );
   $matches = array(
     'contains' => t('contains'),
@@ -510,7 +547,7 @@ function mollom_admin_blacklist_form($form, &$form_state, $type = 'spam') {
       // #class property is internally used by
       // theme_mollom_admin_blacklist_form().
       $row['context'] = array(
-        '#markup' => check_plain($contexts[$entry['context']]),
+        '#markup' => check_plain(isset($contexts[$entry['context']]) ? $contexts[$entry['context']] : $entry['context']),
         '#class' => 'mollom-blacklist-context value-' . check_plain($entry['context']),
       );
       $row['match'] = array(
@@ -733,7 +770,7 @@ function mollom_admin_settings($form, &$form_state) {
     $status = _mollom_status();
     // If there is any configuration error, then mollom_init() will have output
     // it already.
-    if ($status === TRUE) {
+    if ($status === TRUE && !variable_get('mollom_testing_mode', 0)) {
       drupal_set_message(t('Mollom servers verified your keys. The services are operating correctly.'));
     }
   }
@@ -751,28 +788,19 @@ function mollom_admin_settings($form, &$form_state) {
   );
   // Keys are not #required to allow to install this module and configure it
   // later.
-  $mollom = mollom();
   $form['access-keys']['mollom_public_key'] = array(
     '#type' => 'textfield',
     '#title' => t('Public key'),
-    '#default_value' => $mollom->loadConfiguration('publicKey'),
+    '#default_value' => variable_get('mollom_public_key'),
     '#element_validate' => array('mollom_admin_settings_validate_key'),
     '#description' => t('Used to uniquely identify this site.'),
-    // Expose this input element as 'mollom_public_key', but ensure
-    // system_settings_form_submit() saves it into the class-specific variable.
-    '#name' => 'mollom_public_key',
-    '#parents' => array($mollom->configuration_map['publicKey']),
   );
   $form['access-keys']['mollom_private_key'] = array(
     '#type' => 'textfield',
     '#title' => t('Private key'),
-    '#default_value' => $mollom->loadConfiguration('privateKey'),
+    '#default_value' => variable_get('mollom_private_key'),
     '#element_validate' => array('mollom_admin_settings_validate_key'),
     '#description' => t('Used to prevent someone else from hijacking your requests. Similar to a password, it should never be shared with anyone.'),
-    // Expose this input element as 'mollom_private_key', but ensure
-    // system_settings_form_submit() saves it into the class-specific variable.
-    '#name' => 'mollom_private_key',
-    '#parents' => array($mollom->configuration_map['privateKey']),
   );
 
   $form['mollom_fallback'] = array(
@@ -790,17 +818,6 @@ function mollom_admin_settings($form, &$form_state) {
     )),
   );
 
-  $form['mollom_moderation_redirect'] = array(
-    '#type' => 'checkbox',
-    '#title' => t('Redirect <a href="@local-moderation-url">local moderation pages</a> to the <a href="@moderation-url">@moderation-product</a>', array(
-      '@local-moderation-url' => url('admin/content/comment'),
-      '@moderation-url' => 'https://mollom.com/moderation',
-      '@moderation-product' => 'Mollom Content Moderation Platform',
-    )),
-    '#return_value' => 1,
-    '#default_value' => variable_get('mollom_moderation_redirect', 0),
-  );
-
   $form['mollom_privacy_link'] = array(
     '#type' => 'checkbox',
     '#title' => t("Link to Mollom's privacy policy on forms protected by textual analysis"),
@@ -820,6 +837,16 @@ function mollom_admin_settings($form, &$form_state) {
     '#description' => t('Submitting "ham", "unsure", or "spam" on a protected form will trigger the corresponding behavior. Image CAPTCHAs will only respond to "correct" and audio CAPTCHAs only respond to "demo". This option should be disabled in production environments.'),
   );
 
+  $min_severity = variable_get('mollom_log_minimum_severity', WATCHDOG_WARNING);
+  $form['mollom_log_minimum_severity'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Only log warnings and errors'),
+    '#return_value' => WATCHDOG_WARNING,
+    '#default_value' => $min_severity <= WATCHDOG_WARNING ? WATCHDOG_WARNING : 0,
+    '#description' => t('Disable to see all Mollom interactions in log messages.'),
+  );
+  $form['#submit'][] = 'mollom_admin_settings_submit';
+
   return system_settings_form($form);
 }
 
@@ -841,6 +868,17 @@ function mollom_admin_settings_validate_key($element, &$form_state) {
 }
 
 /**
+ * Form submission handler for global settings form.
+ */
+function mollom_admin_settings_submit($form, &$form_state) {
+  // If the minimum log severity checkbox was disabled (no input), convert
+  // 0 into WATCHDOG_DEBUG.
+  if (!isset($form_state['input']['mollom_log_minimum_severity'])) {
+    $form_state['values']['mollom_log_minimum_severity'] = WATCHDOG_DEBUG;
+  }
+}
+
+/**
  * Menu callback; Displays the administrative reports page.
  */
 function mollom_reports_page($form, &$form_state) {
diff --git a/profiles/commons/modules/contrib/mollom/mollom.drupal.inc b/profiles/commons/modules/contrib/mollom/mollom.drupal.inc
index 99e6d0f..72999a0 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.drupal.inc
+++ b/profiles/commons/modules/contrib/mollom/mollom.drupal.inc
@@ -47,10 +47,6 @@ class MollomDrupal extends Mollom {
    * Implements Mollom::getClientInformation().
    */
   public function getClientInformation() {
-    if ($cache = cache_get('mollom_version')) {
-      return $cache->data;
-    }
-
     // Retrieve Drupal distribution and installation profile information.
     $profile = drupal_get_profile();
     $profile_info = system_get_info('module', $profile) + array(
@@ -71,8 +67,6 @@ class MollomDrupal extends Mollom {
       'clientName' => $mollom_info['name'],
       'clientVersion' => $mollom_info['version'],
     );
-    cache_set('mollom_version', $data);
-
     return $data;
   }
 
@@ -87,8 +81,8 @@ class MollomDrupal extends Mollom {
       $entry['Request headers:'] = $entry['headers'];
       unset($entry['headers']);
 
-      $entry['Response: ' . $entry['response_code'] . ' ' . $entry['response_message']] = $entry['response'];
-      unset($entry['response'], $entry['response_code'], $entry['response_message']);
+      $entry['Response: ' . $entry['response_code'] . ' ' . $entry['response_message'] . ' (' . number_format($entry['response_time'], 3) . 's)'] = $entry['response'];
+      unset($entry['response'], $entry['response_code'], $entry['response_message'], $entry['response_time']);
 
       // The client class contains the logic for recovering from certain errors,
       // and log messages are only written after that happened. Therefore, we
@@ -204,8 +198,17 @@ class MollomDrupalTest extends MollomDrupal {
    *   and manually create testing API keys (once).
    */
   function __construct() {
-    // Do not destroy production variables when testing mode is enabled.
-    if (variable_get('mollom_testing_mode', 0)) {
+    // Some tests are verifying the production behavior of e.g. setting up API
+    // keys, in which testing mode is NOT enabled and the test creates fake
+    // "production" API keys on the local fake server on its own. This special
+    // override must only be possible when executing tests.
+    // @todo Add global test_info as condition?
+    if (module_exists('mollom_test_server') && !variable_get('mollom_testing_mode', 0)) {
+      // Disable authentication error auto-recovery.
+      $this->createKeys = FALSE;
+    }
+    else {
+      // Do not destroy production variables when testing mode is enabled.
       $this->configuration_map['publicKey'] = 'mollom_test_public_key';
       $this->configuration_map['privateKey'] = 'mollom_test_private_key';
     }
@@ -213,39 +216,46 @@ class MollomDrupalTest extends MollomDrupal {
     // Load and set publicKey and privateKey configuration values.
     parent::__construct();
 
-    // Any Mollom API request requires valid API keys, or no API calls can be
-    // executed. Verify that testing API keys exist and are still valid.
+    // Unless pre-set, determine whether API keys should be auto-created.
     if (!isset($this->createKeys)) {
       $this->createKeys = (bool) variable_get('mollom_testing_create_keys', TRUE);
     }
-    // If valid client API keys are expected, verify API keys whenever this
-    // class is instantiated.
-    if ($this->createKeys) {
-      $this->checkKeys();
-    }
   }
 
   /**
-   * Checks whether current API keys are valid and creates new keys if they are not.
+   * Overrides Mollom::handleRequest().
+   *
+   * Automatically tries to generate new API keys in case of a 401 or 404 error.
+   * Intentionally reacts on 401 or 404 errors only, since any other error code
+   * can mean that either the Testing API is down or that the client site is not
+   * able to perform outgoing HTTP requests in general.
    */
-  public function checkKeys() {
-    // Verifying keys may return an authentication error, from which we will
-    // automatically recover below, so do not write the request log (yet).
-    $this->writeLog = FALSE;
-    if (!empty($this->publicKey) && !empty($this->privateKey)) {
-      $result = $this->verifyKeys();
-    }
-    else {
-      $result = self::AUTH_ERROR;
+  protected function handleRequest($method, $server, $path, $data, $expected = array()) {
+    try {
+      $response = parent::handleRequest($method, $server, $path, $data, $expected);
     }
-    $this->writeLog = TRUE;
-
-    // If current keys are invalid, create and save new testing API keys.
-    if ($result === self::AUTH_ERROR) {
-      if ($this->createKeys()) {
+    catch (MollomException $e) {
+      $is_auth_error = $e->getCode() == self::AUTH_ERROR || ($e->getCode() == 404 && strpos($path, 'site') === 0);
+      $current_public_key = $this->publicKey;
+      if ($this->createKeys && $is_auth_error && $this->createKeys()) {
         $this->saveKeys();
+        // Avoid to needlessly hit the previous/invalid public key again.
+        // Mollom::handleRequest() will sign the new request correctly.
+        // If it was empty, Mollom::handleRequest() returned an AUTH_ERROR
+        // without issuing a request.
+        if ($path == 'site/') {
+          $path = 'site/' . $this->publicKey;
+        }
+        elseif (!empty($current_public_key)) {
+          $path = str_replace($current_public_key, $this->publicKey, $path);
+        }
+        $response = parent::handleRequest($method, $server, $path, $data, $expected);
+      }
+      else {
+        throw $e;
       }
     }
+    return $response;
   }
 
   /**
@@ -279,7 +289,7 @@ class MollomDrupalTest extends MollomDrupal {
       return TRUE;
     }
     else {
-      unset($this->publicKey, $this->privateKey);
+      $this->publicKey = $this->privateKey = '';
       return FALSE;
     }
   }
@@ -291,6 +301,14 @@ class MollomDrupalTest extends MollomDrupal {
     $this->saveConfiguration('publicKey', $this->publicKey);
     $this->saveConfiguration('privateKey', $this->privateKey);
   }
+
+  /**
+   * Deletes API keys from local configuration store.
+   */
+  public function deleteKeys() {
+    $this->deleteConfiguration('publicKey');
+    $this->deleteConfiguration('privateKey');
+  }
 }
 
 /**
@@ -298,12 +316,13 @@ class MollomDrupalTest extends MollomDrupal {
  */
 class MollomDrupalTestLocal extends MollomDrupalTest {
   /**
-   * Overrides Mollom::__construct().
+   * Overrides MollomDrupalTest::__construct().
    */
   function __construct() {
-    // Replace initial server list with local fake server.
+    // Replace server/endpoint with our local fake server.
     list(, $server) = explode('://', $GLOBALS['base_url'], 2);
     $this->server = $server . '/mollom-test/rest';
+
     parent::__construct();
   }
 
diff --git a/profiles/commons/modules/contrib/mollom/mollom.info b/profiles/commons/modules/contrib/mollom/mollom.info
index af5ea9b..5c5fce3 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.info
+++ b/profiles/commons/modules/contrib/mollom/mollom.info
@@ -10,9 +10,9 @@ files[] = mollom.drupal.inc
 files[] = tests/mollom.test
 files[] = tests/mollom.class.test
 
-; Information added by drupal.org packaging script on 2013-07-01
-version = "7.x-2.7"
+; Information added by  packaging script on 2013-11-10
+version = "7.x-2.8"
 core = "7.x"
 project = "mollom"
-datestamp = "1372682452"
+datestamp = "1384108410"
 
diff --git a/profiles/commons/modules/contrib/mollom/mollom.install b/profiles/commons/modules/contrib/mollom/mollom.install
index ec67f88..94034f6 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.install
+++ b/profiles/commons/modules/contrib/mollom/mollom.install
@@ -26,7 +26,7 @@ function mollom_requirements($phase = 'runtime', $check = TRUE) {
     $requirements['mollom'] = array(
       'title' => t('Mollom API keys'),
       'value' => t('Valid (public key: @publicKey)', array(
-        '@publicKey' => mollom()->loadConfiguration('publicKey'),
+        '@publicKey' => variable_get('mollom_public_key', ''),
       )),
     );
     // Immediately return if everything is in order.
@@ -46,34 +46,41 @@ function mollom_requirements($phase = 'runtime', $check = TRUE) {
       ));
     }
     // Generate an appropriate error message:
+    // If testing mode is enabled, then the Testing API is most likely down,
+    // since the testing client implementation automatically tries to recover
+    // from stale/outdated API keys.
+    if (variable_get('mollom_testing_mode', 0)) {
+      $requirements['mollom']['value'] = t('Testing API not available');
+      $requirements['mollom']['description'] = t('The Mollom Testing API is not available currently.');
+    }
     // Missing API keys.
-    if (!$status['keys']) {
+    elseif (!$status['keys']) {
       $requirements['mollom']['value'] = t('Not configured');
       $requirements['mollom']['description'] = t('The Mollom API keys are not configured yet. !admin-message', array(
         '!admin-message' => $admin_message,
       ));
     }
     // Bad request: Invalid client system time: Too large offset from UTC.
-    elseif ($status['keys valid'] === Mollom::REQUEST_ERROR) {
+    elseif ($status['response'] === Mollom::REQUEST_ERROR) {
       $requirements['mollom']['value'] = t('Client error');
       $requirements['mollom']['description'] = t('The server time of this site is incorrect. The time of the operating system is not synchronized with the Coordinated Universal Time (UTC), which prevents a successful authentication with Mollom. The maximum allowed offset is @minutes minutes. Please consult your hosting provider or server operator to correct the server time.', array(
         '@minutes' => Mollom::TIME_OFFSET_MAX / 60,
       ));
     }
     // Invalid API keys.
-    elseif ($status['keys valid'] === Mollom::AUTH_ERROR) {
+    elseif ($status['response'] === Mollom::AUTH_ERROR) {
       $requirements['mollom']['value'] = t('Invalid');
       $requirements['mollom']['description'] = t('The configured Mollom API keys are invalid. !admin-message', array(
         '!admin-message' => $admin_message,
       ));
     }
     // Communication error.
-    elseif ($status['keys valid'] === Mollom::NETWORK_ERROR) {
+    elseif ($status['response'] === Mollom::NETWORK_ERROR) {
       $requirements['mollom']['value'] = t('Network error');
       $requirements['mollom']['description'] = t('The Mollom servers could not be contacted. Please make sure that your web server can make outgoing HTTP requests.');
     }
     // Server error.
-    elseif ($status['keys valid'] === Mollom::RESPONSE_ERROR) {
+    elseif ($status['response'] === Mollom::RESPONSE_ERROR) {
       $requirements['mollom']['value'] = t('Service error');
       $requirements['mollom']['description'] = t('The Mollom API keys could not be verified. Please try again later.');
     }
@@ -722,6 +729,12 @@ function mollom_update_7006() {
       unset($form_ids[$row->form_id]);
     }
   }
+  // 'comment' (body) field is now a 'comment_body' Field API field.
+  $enabled_fields = unserialize($mollom_form['enabled_fields']);
+  if (is_array($enabled_fields) && ($i = array_search('comment', $enabled_fields))) {
+    $enabled_fields[$i] = 'comment_body';
+    $mollom_form['enabled_fields'] = serialize($enabled_fields);
+  }
   // Duplicate comment_form row into comment_node_TYPE_form rows by
   // inserting settings for any remaining node types.
   foreach ($form_ids as $form_id => $type) {
@@ -1055,3 +1068,52 @@ function mollom_update_7206() {
   }
 }
 
+/**
+ * Remove 'mollom_status' variable (replaced by cache).
+ */
+function mollom_update_7207() {
+  variable_del('mollom_status');
+}
+
+/**
+ * Remove obsolete 'mollom_moderation_redirect' setting.
+ */
+function mollom_update_7208() {
+  variable_del('mollom_moderation_redirect');
+}
+
+/**
+ * Correct the stored definition of enabled Field API fields.
+ */
+function mollom_update_7209() {
+  $mollom_forms = db_query('SELECT form_id, enabled_fields FROM {mollom_form}')->fetchAllKeyed();
+  foreach ($mollom_forms as $form_id => $enabled_fields) {
+    $changed = FALSE;
+    $enabled_fields = unserialize($enabled_fields);
+    if (is_array($enabled_fields)) {
+      foreach ($enabled_fields as $i => $name) {
+        // Remove '][und][0][value' suffix from element name.
+        if (substr($name, -15) == '][und][0][value') {
+          $enabled_fields[$i] = substr($name, 0, -15);
+          $changed = TRUE;
+        }
+      }
+    }
+    if ($changed) {
+      db_update('mollom_form')
+        ->condition('form_id', $form_id)
+        ->fields(array('enabled_fields' => serialize($enabled_fields)))
+        ->execute();
+    }
+  }
+}
+
+/**
+ * Disable minimum log severity threshold for existing sites.
+ */
+function mollom_update_7210() {
+  if (variable_get('mollom_log_minimum_severity', NULL) === NULL) {
+    variable_set('mollom_log_minimum_severity', WATCHDOG_INFO);
+  }
+}
+
diff --git a/profiles/commons/modules/contrib/mollom/mollom.js b/profiles/commons/modules/contrib/mollom/mollom.js
index 6cd918b..7a4ee61 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.js
+++ b/profiles/commons/modules/contrib/mollom/mollom.js
@@ -45,7 +45,7 @@ function getMollomCaptcha() {
 
   // Retrieve a new CAPTCHA.
   $.ajax({
-    url: Drupal.settings.basePath + path,
+    url: Drupal.settings.basePath + Drupal.settings.pathPrefix + path,
     type: 'POST',
     dataType: 'json',
     success: function (data) {
diff --git a/profiles/commons/modules/contrib/mollom/mollom.module b/profiles/commons/modules/contrib/mollom/mollom.module
index 70e6a71..8af8ce2 100644
--- a/profiles/commons/modules/contrib/mollom/mollom.module
+++ b/profiles/commons/modules/contrib/mollom/mollom.module
@@ -72,7 +72,13 @@ function mollom_help($path, $arg) {
   }
 
   if ($path == 'admin/config/content/mollom/blacklist') {
-    return t('Mollom automatically blocks unwanted content and learns from all participating sites to improve its filters. On top of automatic filtering, you can define a custom blacklist.');
+    $output = '<p>';
+    $output .= t('Mollom automatically blocks unwanted content and learns from all participating sites to improve its filters. On top of automatic filtering, you can define a custom blacklist.');
+    $output .= '</p>';
+    $output .= '<p>';
+    $output .= t('Use an "exact" match for short, single words that could be contained within another word.');
+    $output .= '</p>';
+    return $output;
   }
 
   if ($path == 'admin/help#mollom') {
@@ -113,6 +119,16 @@ function mollom_help($path, $arg) {
     $output .= t("All blacklist entries are applied to a context: the entire submitted post, or only links in the post. When limiting the context to links, both the link URL and the link text is taken into account.");
     $output .= '</p>';
     $output .= '<p>';
+    $output .= t('Each blacklist entry defines how it matches:');
+    $output .= '</p>';
+    $output .= '<ul>';
+    $output .= '<li>';
+    $output .= t('Use "contains" matching to find a term within any other string.');
+    $output .= '</li><li>';
+    $output .= t('Use "exact" matching for terms made up of short, single words that could be contained within a larger permissible word.');
+    $output .= '</li>';
+    $output .= '</ul>';
+    $output .= '<p>';
     $output .= t("If a blacklist entry contains multiple words, various combinations will be matched. For example, when adding \"<code>replica&nbsp;watches</code>\" limited to links, the following links will be blocked:");
     $output .= '</p>';
     $output .= '<ul>
@@ -147,12 +163,6 @@ function mollom_init() {
       }
     }
   }
-  // Redirect local moderation pages to the hosted Mollom moderation system,
-  // if enabled.
-  // @see mollom_admin_settings()
-  if (variable_get('mollom_moderation_redirect', 0) && strpos($_GET['q'], 'admin/content/comment') === 0) {
-    drupal_goto('http://my.mollom.com');
-  }
 }
 
 /**
@@ -327,10 +337,7 @@ function mollom_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  *   FALSE otherwise.
  */
 function _mollom_access($permission = FALSE) {
-  $mollom = mollom();
-  $public_key = $mollom->loadConfiguration('publicKey');
-  $private_key = $mollom->loadConfiguration('privateKey');
-  return !empty($public_key) && !empty($private_key) && (!$permission || user_access($permission));
+  return _mollom_status() === TRUE && (!$permission || user_access($permission));
 }
 
 /**
@@ -619,15 +626,15 @@ function mollom_data_delete_form_alter(&$form, &$form_state) {
   );
   $form['mollom']['feedback'] = array(
     '#type' => 'radios',
-    '#title' => t('Report as inappropriate'),
+    '#title' => t('Report as'),
     '#options' => array(
-      '' => t('Do not report'),
       'spam' => t('Spam, unsolicited advertising'),
-      'profanity' => t('Obscene, violent, profane'),
+      'profanity' => t('Profane, obscene, violent'),
       'quality' => t('Low-quality'),
       'unwanted' => t('Unwanted, taunting, off-topic'),
+      '' => t('Do not report'),
     ),
-    '#default_value' => '',
+    '#default_value' => 'spam',
     '#description' => t('Sending feedback to <a href="@mollom-url">Mollom</a> improves the automated moderation of new submissions.', array('@mollom-url' => 'https://mollom.com')),
   );
 }
@@ -703,12 +710,6 @@ function mollom_form_alter(&$form, &$form_state, $form_id) {
   if (defined('MAINTENANCE_MODE')) {
     return;
   }
-  // Verify global Mollom configuration status.
-  $status = _mollom_status();
-  if ($status !== TRUE) {
-    return;
-  }
-
   // Retrieve a list of all protected forms once.
   $forms = mollom_form_cache();
 
@@ -727,6 +728,20 @@ function mollom_form_alter(&$form, &$form_state, $form_id) {
           return;
         }
       }
+      // Verify global Mollom configuration status.
+      // Only do this if the form is actually protected and if the current user
+      // is not privileged to bypass the Mollom protection. Otherwise, if e.g.
+      // the Testing API is down, then every hook_form_alter() for every single
+      // form on the page would potentially cause a (two) API keys verification
+      // requests (in case caches are disabled).
+      // If API keys have been configured, then the form has to be processed,
+      // regardless of whether API keys could be verified; otherwise, the
+      // fallback mode would not be triggered.
+      $status = _mollom_status();
+      if ($status !== TRUE && !$status['keys']) {
+        return;
+      }
+
       // Add Mollom form widget.
       $form['mollom'] = array(
         '#type' => 'mollom',
@@ -852,9 +867,9 @@ function mollom_form_cache($reset = FALSE) {
   $forms = &drupal_static(__FUNCTION__);
 
   if ($reset) {
-    // This catches both 'mollom_form_cache' as well as mollom_form_load()'s
+    // This catches both 'mollom:form_cache' as well as mollom_form_load()'s
     // 'mollom:form:*' entries.
-    cache_clear_all('mollom', 'cache', TRUE);
+    cache_clear_all('mollom:form', 'cache', TRUE);
     unset($forms);
     return;
   }
@@ -863,7 +878,7 @@ function mollom_form_cache($reset = FALSE) {
     return $forms;
   }
 
-  if ($cache = cache_get('mollom_form_cache')) {
+  if ($cache = cache_get('mollom:form_cache')) {
     $forms = $cache->data;
     return $forms;
   }
@@ -889,7 +904,7 @@ function mollom_form_cache($reset = FALSE) {
       }
     }
   }
-  cache_set('mollom_form_cache', $forms);
+  cache_set('mollom:form_cache', $forms);
 
   return $forms;
 }
@@ -926,27 +941,11 @@ function mollom_form_list() {
  *   The module name $form_id belongs to.
  * @param array $form_list
  *   (optional) The return value of hook_mollom_form_list() of $module, if
- *   already kown. Primarily used by mollom_form_list().
+ *   already kown. Primarily used by mollom_form_load().
  */
 function mollom_form_info($form_id, $module, $form_list = NULL) {
-  $form_info = array();
-
-  // Fetch the basic form information from hook_mollom_form_list() first.
-  // This makes the integrating module (needlessly) rebuild all of its available
-  // forms, but the base properties are absolutely required here, so we can
-  // apply the default properties below.
-  if (!isset($form_list)) {
-    $form_list = module_invoke($module, 'mollom_form_list');
-  }
-  if (isset($form_list[$form_id])) {
-    $form_info += $form_list[$form_id];
-  }
-
-  // Any information in hook_mollom_form_info() overrides the list info.
-  $form_info = array_merge($form_info, module_invoke($module, 'mollom_form_info', $form_id));
-
-  // Ensure default properties.
-  $form_info += array(
+  // Default properties.
+  $form_info = array(
     // Base properties.
     'form_id' => $form_id,
     'title' => $form_id,
@@ -966,8 +965,31 @@ function mollom_form_info($form_id, $module, $form_list = NULL) {
     'elements' => array(),
     'mapping' => array(),
     'mail ids' => array(),
+    'orphan' => TRUE,
   );
 
+  // Fetch the basic form information from hook_mollom_form_list() first.
+  // This makes the integrating module (needlessly) rebuild all of its available
+  // forms, but the base properties are absolutely required here, so we can
+  // apply the default properties below.
+  if (!isset($form_list)) {
+    $form_list = module_invoke($module, 'mollom_form_list');
+  }
+  // If it is not listed, then the form has vanished.
+  if (!isset($form_list[$form_id])) {
+    return $form_info;
+  }
+  $module_form_info = module_invoke($module, 'mollom_form_info', $form_id);
+  // If no form info exists, then the form has vanished.
+  if (!isset($module_form_info)) {
+    return $form_info;
+  }
+  unset($form_info['orphan']);
+
+  // Any information in hook_mollom_form_info() overrides the list info.
+  $form_info = array_merge($form_info, $form_list[$form_id]);
+  $form_info = array_merge($form_info, $module_form_info);
+
   // Allow modules to alter the default form information.
   drupal_alter('mollom_form_info', $form_info, $form_id);
 
@@ -996,7 +1018,9 @@ function mollom_form_info($form_id, $module, $form_list = NULL) {
  *   @endcode
  */
 function mollom_form_info_add_fields(&$form_info, $entity_type, $bundle) {
-  $entity_info = entity_get_info($entity_type);
+  if (!$entity_info = entity_get_info($entity_type)) {
+    return;
+  }
   $form_info['mapping']['post_id'] = $entity_info['entity keys']['id'];
 
   if (!empty($entity_info['fieldable'])) {
@@ -1004,8 +1028,7 @@ function mollom_form_info_add_fields(&$form_info, $entity_type, $bundle) {
     $fields = field_info_fields();
     foreach (field_info_instances($entity_type, $bundle) as $field_name => $field) {
       if (in_array($fields[$field_name]['type'], array('text', 'text_long', 'text_with_summary'))) {
-        // @todo Language code must not be contained here.
-        $form_info['elements'][$field_name . '][' . LANGUAGE_NONE . '][0][value'] = check_plain(t($field['label']));
+        $form_info['elements'][$field_name] = check_plain(t($field['label']));
       }
     }
   }
@@ -1204,10 +1227,7 @@ function mollom_form_get_values(&$form_state, $fields, $mapping) {
       }
     }
   }
-  // XML-RPC parser of Mollom backend removes linefeeds, so use a combination of
-  // space and linefeed to ensure proper separation of concatenated fields on
-  // the backend but also have linefeeds in our logs.
-  $post_body = implode(" \n", $post_body);
+  $post_body = implode("\n", $post_body);
 
   // Try to assign any further form values by processing the remaining mappings,
   // which have been turned into $exclude_fields above. All fields that were
@@ -1314,7 +1334,9 @@ function mollom_form_get_values(&$form_state, $fields, $mapping) {
   // any value.
   $invalid_utf8 = FALSE;
   $invalid_xml = FALSE;
-  foreach ($data as $key => $value) {
+  // Include the CAPTCHA solution user input in the UTF-8 validation.
+  $solution = isset($form_values['mollom']['captcha']) ? array('solution' => $form_values['mollom']['captcha']) : array();
+  foreach ($data + $solution as $key => $value) {
     // Check for invalid UTF-8 byte sequences first.
     if (!drupal_validate_utf8($value)) {
       $invalid_utf8 = TRUE;
@@ -1337,7 +1359,7 @@ function mollom_form_get_values(&$form_state, $fields, $mapping) {
       'message' => 'Invalid !type in form values',
       'arguments' => array('!type' => $invalid_utf8 ? 'UTF-8' : 'XML characters'),
       'Data:' => $data,
-    ), WATCHDOG_WARNING);
+    ));
     $data = FALSE;
   }
 
@@ -1353,10 +1375,21 @@ function mollom_form_get_values(&$form_state, $fields, $mapping) {
 function _mollom_flatten_form_values($values) {
   $flat_values = array();
   foreach ($values as $value) {
-    if (is_array($value) && !empty($value)) {
-      $flat_values = array_merge($flat_values, _mollom_flatten_form_values($value));
+    if (is_array($value)) {
+      // Only text fields are supported at this point; their values are in the
+      // 'summary' (optional) and 'value' keys.
+      if (isset($value['value'])) {
+        if (isset($value['summary']) && $value['summary'] !== '') {
+          $flat_values[] = $value['summary'];
+        }
+        if ($value['value'] !== '') {
+          $flat_values[] = $value['value'];
+        }
+      }
+      elseif (!empty($value)) {
+        $flat_values = array_merge($flat_values, _mollom_flatten_form_values($value));
+      }
     }
-    // UTF-8 validation happens elsewhere later.
     elseif (is_string($value) && strlen($value)) {
       $flat_values[] = $value;
     }
@@ -1380,85 +1413,81 @@ function _mollom_get_openid($account) {
 /**
  * Returns the (last known) status of the configured Mollom API keys.
  *
- * @param $reset
- *   (optional) Boolean whether to reset the stored state and re-check.
+ * @param bool $force
+ *   (optional) Boolean whether to ignore the cached state and re-check.
  *   Defaults to FALSE.
  *
- * @return
+ * @return bool|array
  *   TRUE if the module is considered operable, or an associative array
  *   describing the current status of the module:
  *   - keys: Boolean whether Mollom API keys have been configured.
- *   - keys valid: TRUE if Mollom API keys are valid, or the error code as
- *     returned by Mollom servers.
+ *   - response: The response error code of the API verification request.
  *
  * @see mollom_init()
  * @see mollom_admin_settings()
  * @see mollom_requirements()
  */
-function _mollom_status($reset = FALSE) {
-  // Load stored status.
-  $status = variable_get('mollom_status', array(
-    'keys' => FALSE,
-    'keys valid' => FALSE,
-  ));
-  $current_status = $status;
+function _mollom_status($force = FALSE) {
+  $static_cache = &drupal_static(__FUNCTION__, array());
+  $testing_mode = (int) variable_get('mollom_testing_mode', 0);
+  $status = &$static_cache[$testing_mode];
 
-  $mollom = mollom();
+  if (!$force && isset($status)) {
+    return $status;
+  }
+  // Check the cached status.
+  $cid = 'mollom_status:' . $testing_mode;
+  $expire_valid = 86400; // once per day
+  $expire_invalid = 3600; // once per hour
+
+  if (!$force && $cache = cache_get($cid, 'cache')) {
+    if ($cache->expire > REQUEST_TIME) {
+      $status = $cache->data;
+      return $status;
+    }
+  }
 
-  // Both API keys are required.
+  // Re-check configuration status.
+  $mollom = mollom();
+  $status = array(
+    'keys' => FALSE,
+    'response' => NULL,
+  );
   $public_key = $mollom->loadConfiguration('publicKey');
   $private_key = $mollom->loadConfiguration('privateKey');
   $status['keys'] = (!empty($public_key) && !empty($private_key));
 
-  // If we have keys and are asked to reset, check whether keys are valid.
-  if ($status['keys'] && $reset) {
-    $status['keys valid'] = $mollom->verifyKeys();
-    if ($status['keys valid'] === TRUE) {
+  if ($testing_mode || $status['keys']) {
+    $status['response'] = $mollom->verifyKeys();
+
+    if ($status['response'] === TRUE) {
+      $status = TRUE;
       mollom_log(array(
         'message' => 'API keys are valid.',
       ), WATCHDOG_INFO);
     }
-    elseif ($status['keys valid'] === Mollom::REQUEST_ERROR) {
+    elseif ($status['response'] === Mollom::AUTH_ERROR) {
       mollom_log(array(
-        'message' => 'Invalid client configuration.',
+        'message' => 'Invalid API keys.',
       ), WATCHDOG_ERROR);
     }
-    elseif ($status['keys valid'] === Mollom::AUTH_ERROR) {
+    elseif ($status['response'] === Mollom::REQUEST_ERROR) {
       mollom_log(array(
-        'message' => 'Invalid API keys.',
+        'message' => 'Invalid client configuration.',
       ), WATCHDOG_ERROR);
     }
-    // If the response is neither positive nor a known negative error, and
-    // the previous status was positive, then the Mollom service might be
-    // temporarily down. In this case, return an enforced RESPONSE_ERROR to
-    // indicate a server-side service failure, but do not update the stored
-    // status.
-    // @todo Test this.
-    elseif ($current_status['keys valid'] === TRUE) {
-      $status['keys valid'] = Mollom::RESPONSE_ERROR;
-      // Do not update the stored configuration status with the bogus result
-      // caused by the server-side failure.
-      $reset = FALSE;
+    else {
+      // A NETWORK_ERROR and other possible responses may be caused by the
+      // client-side environment, but also by Mollom service downtimes. Try to
+      // recover as soon as possible.
+      $expire_invalid = 60 * 5;
       mollom_log(array(
         'message' => 'API keys could not be verified.',
-      ), WATCHDOG_WARNING);
+      ), WATCHDOG_ERROR);
     }
   }
-  // Otherwise, if there are no keys, they cannot be valid.
-  elseif (!$status['keys']) {
-    $status['keys valid'] = FALSE;
-  }
-
-  // Update stored status upon reset, but only if the status changed, as a
-  // variable_set() invalidates the variable cache.
-  // Requires array_diff_assoc() instead of ($current_status != $status), since
-  // 'keys valid' may be an error code integer, which is equal to TRUE, so a
-  // type-agnostic strict comparison is required.
-  if ($reset && array_diff_assoc($current_status, $status)) {
-    variable_set('mollom_status', $status);
-  }
-
-  return ($status['keys valid'] === TRUE ? TRUE : $status);
+  cache_set($cid, $status, 'cache', REQUEST_TIME + ($status === TRUE ? $expire_valid : $expire_invalid));
+  return $status;
 }
 
 /**
@@ -1746,6 +1775,9 @@ function mollom_process_mollom($element, &$form_state, $complete_form) {
  *   reference.
  * @param $form_state
  *   The current state of the form. Passed by reference.
+ *
+ * @return bool
+ *   TRUE if a CAPTCHA was added, FALSE if not.
  */
 function mollom_form_add_captcha(&$element, &$form_state) {
   // Prevent the page cache from storing a form containing a CAPTCHA element.
@@ -1760,12 +1792,14 @@ function mollom_form_add_captcha(&$element, &$form_state) {
     // Ensure that the latest CAPTCHA ID is output as value.
     $element['captchaId']['#value'] = $form_state['mollom']['response']['captcha']['id'];
     $form_state['values']['mollom']['captchaId'] = $form_state['mollom']['response']['captcha']['id'];
+    return TRUE;
   }
   // Otherwise, we have a communication or configuration error.
   else {
     $element['captcha']['#access'] = FALSE;
     // Trigger fallback mode.
     _mollom_fallback();
+    return FALSE;
   }
 }
 
@@ -1885,14 +1919,15 @@ function mollom_validate_analysis(&$form, &$form_state) {
           $form_state['mollom']['passed_captcha'] = FALSE;
 
           // Retrieve a new CAPTCHA and throw an error.
-          mollom_form_add_captcha($form['mollom'], $form_state);
-          $form['mollom']['captcha']['#access'] = TRUE;
+          if (mollom_form_add_captcha($form['mollom'], $form_state)) {
+            $form['mollom']['captcha']['#access'] = TRUE;
 
-          if (!empty($form_state['temporary']['mollom']['had_captcha'])) {
-            form_error($form['mollom']['captcha'], t('The word verification was not completed correctly. Please complete this new word verification and try again.') . ' ' . _mollom_format_message_falsepositive($form_state, $data));
-          }
-          else {
-            form_error($form['mollom']['captcha'], t('To complete this form, please complete the word verification below.'));
+            if (!empty($form_state['temporary']['mollom']['had_captcha'])) {
+              form_error($form['mollom']['captcha'], t('The word verification was not completed correctly. Please complete this new word verification and try again.') . ' ' . _mollom_format_message_falsepositive($form_state, $data));
+            }
+            else {
+              form_error($form['mollom']['captcha'], t('To complete this form, please complete the word verification below.'));
+            }
           }
         }
         mollom_log(array(
@@ -1949,8 +1984,9 @@ function mollom_validate_captcha(&$form, &$form_state) {
     }
     // If there is no CAPTCHA ID yet, retrieve one and throw an error.
     if (empty($form_state['values']['mollom']['captchaId'])) {
-      mollom_form_add_captcha($form['mollom'], $form_state);
-      form_error($form['mollom']['captcha'], t('To complete this form, please complete the word verification below.'));
+      if (mollom_form_add_captcha($form['mollom'], $form_state)) {
+        form_error($form['mollom']['captcha'], t('To complete this form, please complete the word verification below.'));
+      }
       return;
     }
   }
@@ -2146,7 +2182,7 @@ function mollom_form_submit($form, &$form_state) {
  *   Overrides the 'mollom_class' configuration variable. Debug use only.
  */
 function mollom($class = NULL) {
-  $instance = &drupal_static(__FUNCTION__);
+  $instances = &drupal_static(__FUNCTION__, array());
   if (!isset($class)) {
     if (variable_get('mollom_testing_mode', 0)) {
       $class = 'MollomDrupalTest';
@@ -2157,10 +2193,10 @@ function mollom($class = NULL) {
   }
   // If there is no instance yet or if it is not of the desired class, create a
   // new one.
-  if (!isset($instance) || !($instance instanceof $class)) {
-    $instance = new $class();
+  if (!isset($instances[$class]) || !($instances[$class] instanceof $class)) {
+    $instances[$class] = new $class();
   }
-  return $instance;
+  return $instances[$class];
 }
 
 /**
@@ -2254,8 +2290,12 @@ function mollom_log_write() {
   if (empty($log)) {
     return;
   }
-  list($message, $arguments) = _mollom_format_log($log);
-  watchdog('mollom', $message, $arguments, $log['severity']);
+  // Only log if severity if it meets configured minimum severity, or if testing
+  // mode is enabled.
+  if (variable_get('mollom_testing_mode', 0) || $log['severity'] <= variable_get('mollom_log_minimum_severity', WATCHDOG_WARNING)) {
+    list($message, $arguments) = _mollom_format_log($log);
+    watchdog('mollom', $message, $arguments, $log['severity']);
+  }
 }
 
 /**
@@ -3193,7 +3233,9 @@ function node_mollom_form_info($form_id) {
   // Retrieve internal type from $form_id.
   $nodetype = drupal_substr($form_id, 0, -10);
 
-  $type = node_type_get_type($nodetype);
+  if (!$type = node_type_get_type($nodetype)) {
+    return;
+  }
   $form_info = array(
     // @todo This is incompatible with node access.
     'bypass access' => array('bypass node access'),
diff --git a/profiles/commons/modules/contrib/mollom/tests/mollom.test b/profiles/commons/modules/contrib/mollom/tests/mollom.test
index cd5857e..0d5e602 100644
--- a/profiles/commons/modules/contrib/mollom/tests/mollom.test
+++ b/profiles/commons/modules/contrib/mollom/tests/mollom.test
@@ -128,6 +128,9 @@ class MollomWebTestCase extends DrupalWebTestCase {
     // Disable testing mode warnings.
     variable_set('mollom_testing_mode_omit_warning', TRUE);
 
+    // Log all messages.
+    variable_set('mollom_log_minimum_severity', WATCHDOG_DEBUG);
+
     // D7's new default theme Bartik is bogus in various locations, which leads
     // to failing tests.
     // @todo Remove this override.
@@ -335,10 +338,9 @@ class MollomWebTestCase extends DrupalWebTestCase {
   /**
    * Setup Mollom API keys for testing.
    *
-   * @param bool $force
-   *   (optional) Whether to enforce creation of new API keys. New keys are only
-   *   created if MollomWebTestCase::$createKeys or respectively the
-   *   'mollom_testing_create_keys' variable is set to TRUE. Defaults to FALSE.
+   * New keys are only created if MollomWebTestCase::$createKeys or respectively
+   * the 'mollom_testing_create_keys' variable is set to TRUE.
+   *
    * @param bool $once
    *   (optional) Whether to disable the 'mollom_testing_create_keys' variable
    *   after the first call (and thus omit API key verifications on every page
@@ -348,16 +350,14 @@ class MollomWebTestCase extends DrupalWebTestCase {
    * @see MollomDrupalTest::__construct()
    * @see MollomDrupalTest::createKeys()
    */
-  protected function setKeys($force = FALSE, $once = FALSE) {
+  protected function setKeys($once = FALSE) {
     // Instantiate a Mollom client class.
     // Depending on MollomWebTestCase::$createKeys and ultimately the
     // 'mollom_testing_create_keys' variable, MollomDrupalTest::__construct()
     // will automatically setup testing API keys.
     $this->getClient();
 
-    if ($force) {
-      $this->mollom->createKeys();
-    }
+    $this->mollom->createKeys();
 
     // Make API keys available to test methods.
     if (!empty($this->mollom->publicKey)) {
@@ -1030,6 +1030,7 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
 
     // Protect mollom_test_form.
     $this->setProtectionUI('mollom_test_form', MOLLOM_MODE_ANALYSIS);
+    variable_set('mollom_fallback', MOLLOM_FALLBACK_ACCEPT);
 
     // Setup production API keys. They must be retained.
     $publicKey = 'the-invalid-mollom-api-key-value';
@@ -1039,7 +1040,9 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
       'mollom_private_key' => $privateKey,
     );
     $this->drupalGet('admin/config/content/mollom/settings');
+    $this->assertText('The Mollom API keys are not configured yet.');
     $this->drupalPost(NULL, $edit, t('Save configuration'), array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertNoText('The Mollom API keys are not configured yet.');
     $this->assertText(t('The configuration options have been saved.'));
     $this->assertText('The configured Mollom API keys are invalid.');
 
@@ -1051,7 +1054,8 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
       'title' => $this->randomString(),
       'body' => 'spam',
     );
-    $this->drupalPost('mollom-test/form', $edit, 'Submit');
+    $this->drupalGet('mollom-test/form');
+    $this->drupalPost(NULL, $edit, 'Submit', array('watchdog' => WATCHDOG_EMERGENCY));
     $this->assertText('Successful form submission.');
 
     // Enable testing mode.
@@ -1060,8 +1064,10 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
       'mollom_testing_mode' => 1,
     );
     $this->drupalGet('admin/config/content/mollom/settings', array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertText('The configured Mollom API keys are invalid.');
     $this->drupalPost(NULL, $edit, t('Save configuration'));
-    $this->assertText(t('Mollom servers verified your keys. The services are operating correctly.'));
+    $this->assertNoText('The Mollom API keys are not configured yet.');
+    $this->assertNoText('The configured Mollom API keys are invalid.');
     $this->assertText(t('Mollom testing mode is still enabled. !admin-message', array('!admin-message' => '')));
 
     $this->drupalLogout();
@@ -1082,14 +1088,14 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
     // Disable testing mode.
     $this->drupalLogin($this->admin_user);
     $this->drupalGet('admin/config/content/mollom/settings');
-    $this->assertText(t('Mollom testing mode is still enabled. !admin-message', array('!admin-message' => '')));
+    $this->assertText('Mollom testing mode is still enabled.');
     $edit = array(
       'mollom_testing_mode' => FALSE,
     );
     $this->drupalPost(NULL, $edit, t('Save configuration'), array('watchdog' => WATCHDOG_EMERGENCY));
     $this->assertText(t('The configuration options have been saved.'));
     $this->assertText('The configured Mollom API keys are invalid.');
-    $this->assertNoText(t('Mollom testing mode is still enabled. !admin-message', array('!admin-message' => '')));
+    $this->assertNoText('Mollom testing mode is still enabled.');
 
     // Verify that production API keys still exist.
     $this->assertFieldByName('mollom_public_key', $publicKey);
@@ -1101,6 +1107,8 @@ class MollomTestingModeTestCase extends MollomWebTestCase {
  * Tests module installation and global status handling.
  */
 class MollomInstallationTestCase extends MollomWebTestCase {
+  protected $mollomClass = 'MollomDrupalTestLocal';
+  protected $disableDefaultSetup = TRUE;
   protected $createKeys = FALSE;
 
   public static function getInfo() {
@@ -1112,7 +1120,6 @@ class MollomInstallationTestCase extends MollomWebTestCase {
   }
 
   function setUp() {
-    $this->disableDefaultSetup = TRUE;
     parent::setUp(array('mollom_test'));
 
     $this->admin_user = $this->drupalCreateUser(array(
@@ -1199,6 +1206,8 @@ class MollomInstallationTestCase extends MollomWebTestCase {
     // Verify presence of 'network error' message.
     $this->drupalGet('admin/config/content/mollom/settings', array('watchdog' => WATCHDOG_EMERGENCY));
     $this->assertText(t('The Mollom servers could not be contacted. Please make sure that your web server can make outgoing HTTP requests.'));
+    $this->assertNoText('The Mollom API keys are not configured yet.');
+    $this->assertNoText('The configured Mollom API keys are invalid.');
 
     // Verify requirements error about network error.
     $this->drupalGet('admin/reports/status', array('watchdog' => WATCHDOG_EMERGENCY));
@@ -1212,6 +1221,7 @@ class MollomInstallationTestCase extends MollomWebTestCase {
 
     // Verify that valid keys work.
     $this->drupalGet('admin/config/content/mollom/settings', array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertFieldByName('mollom_public_key', 'the-invalid-mollom-api-key-value');
     $edit = array(
       'mollom_public_key' => $this->mollom->publicKey,
       'mollom_private_key' => $this->mollom->privateKey,
@@ -1674,6 +1684,7 @@ class MollomResponseLocalTestCase extends MollomResponseTestCase {
 }
 
 class MollomAccessTestCase extends MollomWebTestCase {
+  protected $mollomClass = 'MollomDrupalTestLocal';
   protected $createKeys = FALSE;
 
   public static function getInfo() {
@@ -1833,21 +1844,22 @@ class MollomFallbackModeTestCase extends MollomWebTestCase {
   }
 
   function setUp() {
-    parent::setUp();
+    parent::setUp(array('node', 'comment'));
 
     // Setup valid testing API keys.
-    $this->setKeys(TRUE);
+    $this->setKeys();
     $this->assertValidKeys();
+
+    $this->drupalCreateContentType(array('type' => 'article', 'name' => 'Article'));
   }
 
   /**
    * Tests that form submissions are blocked when Mollom servers are unreachable.
    */
   function testBlock() {
-    // Enable Mollom for the request password form.
-    $this->drupalLogin($this->admin_user);
-    $this->setProtectionUI('user_pass', MOLLOM_MODE_CAPTCHA);
-    $this->drupalLogout();
+    $this->setProtection('user_pass', MOLLOM_MODE_CAPTCHA);
+    $this->setProtection('comment_node_article_form');
+    $node = $this->drupalCreateNode(array('type' => 'article'));
 
     // Set the fallback strategy to 'blocking mode'.
     variable_set('mollom_fallback', MOLLOM_FALLBACK_BLOCK);
@@ -1855,10 +1867,12 @@ class MollomFallbackModeTestCase extends MollomWebTestCase {
     // Make all requests to Mollom fail.
     variable_set('mollom_class', 'MollomDrupalTestInvalid');
 
-    // Check the password request form.
+    // Check the CAPTCHA-only protected form.
     $this->drupalGet('user/password', array('watchdog' => WATCHDOG_EMERGENCY));
-    $this->assertNoCaptchaField();
     $this->assertText($this->fallback_message);
+    $this->assertNoCaptchaField();
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
 
     // Verify that the form cannot be submitted.
     $edit = array(
@@ -1866,16 +1880,34 @@ class MollomFallbackModeTestCase extends MollomWebTestCase {
     );
     $this->drupalPost(NULL, $edit, t('E-mail new password'), array('watchdog' => WATCHDOG_EMERGENCY));
     $this->assertNoText(t('Further instructions have been sent to your e-mail address.'));
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
+
+    // Check the text analysis protected form.
+    $this->web_user = $this->drupalCreateUser(array('access content', 'access comments', 'post comments', 'skip comment approval'));
+    $this->drupalLogin($this->web_user);
+    $this->drupalGet('comment/reply/' . $node->nid);
+    $this->assertNoText($this->fallback_message);
+    $this->assertText('privacy policy');
+
+    // Verify that the form cannot be submitted.
+    $edit = array(
+      'comment_body[und][0][value]' => 'ham',
+    );
+    $this->drupalPost(NULL, $edit, t('Preview'), array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertText($this->fallback_message);
+    $this->assertNoCaptchaField();
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
   }
 
   /**
    * Tests that form submissions are accepted when Mollom servers are unreachable.
    */
   function testAccept() {
-    // Enable Mollom for the request password form.
-    $this->drupalLogin($this->admin_user);
-    $this->setProtectionUI('user_pass', MOLLOM_MODE_CAPTCHA);
-    $this->drupalLogout();
+    $this->setProtection('user_pass', MOLLOM_MODE_CAPTCHA);
+    $this->setProtection('comment_node_article_form');
+    $node = $this->drupalCreateNode(array('type' => 'article'));
 
     // Set the fallback strategy to 'accept mode'.
     variable_set('mollom_fallback', MOLLOM_FALLBACK_ACCEPT);
@@ -1883,19 +1915,51 @@ class MollomFallbackModeTestCase extends MollomWebTestCase {
     // Make all requests to Mollom fail.
     variable_set('mollom_class', 'MollomDrupalTestInvalid');
 
-    // Check the password request form.
+    // Check the CAPTCHA-only protected form.
     $this->drupalGet('user/password', array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertNoText($this->fallback_message);
+    $this->assertNoCaptchaField();
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
+
+    // Verify that the form can be submitted.
+    $edit = array(
+      'name' => $this->admin_user->name,
+    );
+    $this->drupalPost(NULL, $edit, t('E-mail new password'), array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertText(t('Further instructions have been sent to your e-mail address.'));
+    $this->assertNoText($this->fallback_message);
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
+
+    // Check the text analysis protected form.
+    $this->web_user = $this->drupalCreateUser(array('access content', 'access comments', 'post comments', 'skip comment approval'));
+    $this->drupalLogin($this->web_user);
+    $this->drupalGet('comment/reply/' . $node->nid);
+    $this->assertNoText($this->fallback_message);
+    $this->assertText('privacy policy');
+
+    // Verify that the form can be submitted.
+    $edit = array(
+      'comment_body[und][0][value]' => 'ham',
+    );
+    $this->drupalPost(NULL, $edit, t('Preview'), array('watchdog' => WATCHDOG_EMERGENCY));
+    $this->assertNoText($this->fallback_message);
     $this->assertNoCaptchaField();
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
+    $this->drupalPost(NULL, array(), t('Save'), array('watchdog' => WATCHDOG_EMERGENCY));
     $this->assertNoText($this->fallback_message);
+    $this->assertNoCaptchaField();
+    $this->assertNoText('CAPTCHA');
+    $this->assertNoText('word verification');
   }
 
   /**
    * Tests that form submissions are accepted when only last request attempt to Mollom servers succeeds.
    */
   function testFailover() {
-    $this->drupalLogin($this->admin_user);
-    $this->setProtectionUI('user_pass', MOLLOM_MODE_CAPTCHA);
-    $this->drupalLogout();
+    $this->setProtection('user_pass', MOLLOM_MODE_CAPTCHA);
 
     // Set the fallback strategy to 'blocking mode', so that if the failover
     // mechanism does not work, we would expect to get a warning.
@@ -2004,7 +2068,7 @@ class MollomBlacklistTestCase extends MollomWebTestCase {
     $term = drupal_strtolower(preg_replace('/[^a-zA-Z]/', '', $this->randomName()));
     $entry = $mollom->saveBlacklistEntry(array(
       'value' => $term,
-      'context' => 'everything',
+      'context' => 'allFields',
       'reason' => 'spam',
       'match' => 'contains',
     ));
@@ -2040,7 +2104,7 @@ class MollomBlacklistTestCase extends MollomWebTestCase {
     $entry = $mollom->saveBlacklistEntry(array(
       'id' => $entry['id'],
       'value' => $term,
-      'context' => 'everything',
+      'context' => 'allFields',
       'reason' => 'spam',
       'match' => 'exact',
     ));
@@ -2525,6 +2589,40 @@ class MollomFormConfigurationTestCase extends MollomWebTestCase {
   }
 
   /**
+   * Tests invalid (stale) form configurations.
+   */
+  function testInvalidForms() {
+    $forms = array(
+      'nonexisting' => 'nonexisting_form',
+      'user' => 'user_nonexisting_form',
+      'node' => 'nonexisting_node_form',
+      'comment' => 'comment_node_nonexisting_form',
+    );
+    $mode = 0;
+    foreach ($forms as $module => $form_id) {
+      $mollom_form = mollom_form_info($form_id, $module, array());
+      $mollom_form['mode'] = $mode++;
+      mollom_form_save($mollom_form);
+    }
+
+    // Just visiting the form administration page is sufficient; it will throw
+    // fatal errors, warnings, and notices.
+    $this->drupalLogin($this->admin_user);
+    $this->drupalGet('admin/config/content/mollom');
+
+    // Ensure that unprotecting the forms does not throw any notices either.
+    foreach ($forms as $form_id) {
+      $this->assertNoLinkByHref('admin/config/content/mollom/manage/' . $form_id);
+      $this->assertLinkByHref('admin/config/content/mollom/unprotect/' . $form_id);
+      $this->drupalPost('admin/config/content/mollom/unprotect/' . $form_id, array(), t('Confirm'));
+      $this->assertNoLinkByHref('admin/config/content/mollom/unprotect/' . $form_id);
+    }
+    // Confirm deletion.
+    $count = db_query('SELECT 1 FROM {mollom_form}')->fetchField();
+    $this->assertFalse($count, 'No forms found.');
+  }
+
+  /**
    * Tests programmatically, conditionally disabling Mollom.
    */
   function testFormAlter() {
@@ -2938,13 +3036,13 @@ class MollomNodeFormTestCase extends MollomWebTestCase {
     // for the node author.
     $this->drupalGet('node/' . $this->node->nid . '/delete');
     $this->assertResponse(200);
-    $this->assertNoText(t('Report as inappropriate'));
+    $this->assertNoText(t('Report as'));
 
     // Verify that feedback options appear for the admin user.
     $this->drupalLogin($this->admin_user);
     $this->drupalGet('node/' . $this->node->nid . '/delete');
     $this->assertResponse(200);
-    $this->assertText(t('Report as inappropriate'));
+    $this->assertText(t('Report as'));
 
     // Login and submit an unprotected node.
     $this->drupalLogin($this->web_user);
@@ -2962,13 +3060,13 @@ class MollomNodeFormTestCase extends MollomWebTestCase {
     // for the node author.
     $this->drupalGet('node/' . $this->node->nid . '/delete');
     $this->assertResponse(200);
-    $this->assertNoText(t('Report as inappropriate'));
+    $this->assertNoText(t('Report as'));
 
     // Verify that no feedback options appear for the admin user.
     $this->drupalLogin($this->admin_user);
     $this->drupalGet('node/' . $this->node->nid . '/delete');
     $this->assertResponse(200);
-    $this->assertNoText(t('Report as inappropriate'));
+    $this->assertNoText(t('Report as'));
   }
 }
 
@@ -3393,12 +3491,19 @@ class MollomDataTestCase extends MollomWebTestCase {
         'child' => 'Beer',
       ),
       'field_checked' => array(
-        0 => array('value' => 'Check first'),
-        1 => array('value' => 'Check second'),
+        'und' => array(
+          0 => array('value' => ''),
+          1 => array('summary' => 'Check summary', 'value' => 'Check first', 'whatever' => 'whatever'),
+          2 => array('value' => 'Check second'),
+          3 => array('nested_empty' => array()),
+          4 => array('nested_weird' => array('')),
+        ),
       ),
       'field_unchecked' => array(
-        0 => array('value' => 'Ignore first'),
-        1 => array('value' => 'Ignore second'),
+        'und' => array(
+          0 => array('value' => 'Ignore first'),
+          1 => array('value' => 'Ignore second'),
+        ),
       ),
       'name' => 'Drupaler',
       'mail' => 'drupaler@example.com',
@@ -3411,10 +3516,11 @@ class MollomDataTestCase extends MollomWebTestCase {
     $body = array(
       $values['message'],
       $values['parent']['child'],
-      $values['field_checked'][0]['value'],
-      $values['field_checked'][1]['value'],
+      $values['field_checked']['und'][1]['summary'],
+      $values['field_checked']['und'][1]['value'],
+      $values['field_checked']['und'][2]['value'],
     );
-    $this->assertSame('postBody', $data['postBody'], implode(" \n", $body));
+    $this->assertSame('postBody', $data['postBody'], implode("\n", $body));
     $this->assertSame('authorId', $data['authorId'], NULL);
     $this->assertSame('authorCreated', $data['authorCreated'], NULL);
     $this->assertSame('authorName', $data['authorName'], $values['name']);
@@ -3452,7 +3558,7 @@ class MollomDataTestCase extends MollomWebTestCase {
       $values['field_checked'][0]['value'],
       $values['field_checked'][1]['value'],
     );
-    $this->assertSame('postBody', $data['postBody'], implode(" \n", $body));
+    $this->assertSame('postBody', $data['postBody'], implode("\n", $body));
     $this->assertSame('authorId', $data['authorId'], NULL);
     $this->assertSame('authorCreated', $data['authorCreated'], NULL);
     $this->assertSame('authorName', $data['authorName'], $values['name']);
@@ -3488,8 +3594,19 @@ class MollomDataTestCase extends MollomWebTestCase {
     );
     $form_state = array('values' => $values, 'buttons' => array());
     $data = mollom_form_get_values($form_state, $fields, $form_info['mapping']);
-    $this->assertMollomWatchdogMessages(WATCHDOG_WARNING);
     $this->assertFalse($data, 'Invalid UTF-8 detected.');
+    $this->assertMollomWatchdogMessages();
+
+    // Verify that invalid UTF-8 is detected in the CAPTCHA solution element.
+    $values = array(
+      'mollom' => array(
+        'captcha' => "Foo \xC0 bar",
+      ),
+    );
+    $form_state = array('values' => $values, 'buttons' => array());
+    $data = mollom_form_get_values($form_state, $fields, $form_info['mapping']);
+    $this->assertFalse($data, 'Invalid UTF-8 detected in CAPTCHA solution.');
+    $this->assertMollomWatchdogMessages();
 
     // Verify that invalid XML characters are detected.
     $values = array(
@@ -3497,8 +3614,8 @@ class MollomDataTestCase extends MollomWebTestCase {
     );
     $form_state = array('values' => $values, 'buttons' => array());
     $data = mollom_form_get_values($form_state, $fields, $form_info['mapping']);
-    $this->assertMollomWatchdogMessages(WATCHDOG_WARNING);
     $this->assertFalse($data, 'Invalid XML characters detected.');
+    $this->assertMollomWatchdogMessages();
   }
 
   /**
@@ -3541,7 +3658,7 @@ class MollomDataTestCase extends MollomWebTestCase {
     $this->resetAll();
 
     $this->drupalLogin($this->admin_user);
-    $this->setProtectionUI('comment_node_article_form');
+    $this->setProtection('comment_node_article_form');
 
     // Create a node we can comment on.
     $node = $this->drupalCreateNode(array('type' => 'article', 'promote' => 1));
@@ -3870,7 +3987,7 @@ class MollomAnalysisTestCase extends MollomWebTestCase {
 
   function setUp() {
     parent::setUp(array('mollom', 'mollom_test'));
-    $this->setKeys(TRUE, TRUE);
+    $this->setKeys(TRUE);
     $this->assertValidKeys();
 
     $this->setProtection('mollom_test_form', MOLLOM_MODE_ANALYSIS);
@@ -4476,7 +4593,7 @@ class MollomCaptchaTestCase extends MollomWebTestCase {
 
   function setUp() {
     parent::setUp(array('mollom', 'mollom_test'));
-    $this->setKeys(TRUE, TRUE);
+    $this->setKeys(TRUE);
     $this->assertValidKeys();
 
     $this->setProtection('mollom_test_form', MOLLOM_MODE_CAPTCHA);
@@ -4893,7 +5010,7 @@ class MollomModerateUserTestCase extends MollomWebTestCase {
 
     // Verify that no feedback options appear on the account cancellation form.
     $this->drupalGet('user/' . $account->uid . '/cancel');
-    $this->assertNoText(t('Report as inappropriate'));
+    $this->assertNoText(t('Report as'));
 
     // Cancel own account.
     $this->drupalPost(NULL, array(), t('Cancel account'));
diff --git a/profiles/commons/modules/contrib/mollom/tests/mollom_test.info b/profiles/commons/modules/contrib/mollom/tests/mollom_test.info
index b3deb9a..432445c 100644
--- a/profiles/commons/modules/contrib/mollom/tests/mollom_test.info
+++ b/profiles/commons/modules/contrib/mollom/tests/mollom_test.info
@@ -4,9 +4,9 @@ core = 7.x
 package = Testing
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-07-01
-version = "7.x-2.7"
+; Information added by  packaging script on 2013-11-10
+version = "7.x-2.8"
 core = "7.x"
 project = "mollom"
-datestamp = "1372682452"
+datestamp = "1384108410"
 
diff --git a/profiles/commons/modules/contrib/mollom/tests/mollom_test_server.info b/profiles/commons/modules/contrib/mollom/tests/mollom_test_server.info
index 2e214c2..3984267 100644
--- a/profiles/commons/modules/contrib/mollom/tests/mollom_test_server.info
+++ b/profiles/commons/modules/contrib/mollom/tests/mollom_test_server.info
@@ -4,9 +4,9 @@ core = 7.x
 package = Testing
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-07-01
-version = "7.x-2.7"
+; Information added by  packaging script on 2013-11-10
+version = "7.x-2.8"
 core = "7.x"
 project = "mollom"
-datestamp = "1372682452"
+datestamp = "1384108410"
 
diff --git a/profiles/commons/modules/contrib/navbar/navbar.info b/profiles/commons/modules/contrib/navbar/navbar.info
index 27649a6..cdf44b8 100644
--- a/profiles/commons/modules/contrib/navbar/navbar.info
+++ b/profiles/commons/modules/contrib/navbar/navbar.info
@@ -6,9 +6,9 @@ dependencies[] = breakpoints
 dependencies[] = libraries
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.0-alpha10+6-dev"
 core = "7.x"
 project = "navbar"
-datestamp = "1382042534"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/oauthconnector/LICENSE.txt b/profiles/commons/modules/contrib/oauthconnector/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/oauthconnector/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
index fcccae2..437a8ee 100644
--- a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
+++ b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
@@ -7,9 +7,9 @@ files[] = lib/DrupalOAuth2Client.inc
 
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.0-beta1+6-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1382042531"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
index 2494418..b516d6f 100644
--- a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
+++ b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
@@ -10,9 +10,9 @@ dependencies[] = http_client_oauth
 dependencies[] = ctools
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-1.0-beta1+6-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1382042531"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/oembed/CHANGELOG b/profiles/commons/modules/contrib/oembed/CHANGELOG
new file mode 100644
index 0000000..fb160ee
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/CHANGELOG
@@ -0,0 +1,39 @@
+oEmbed 6.x-0.9, xxxx-xx-xx
+------------------------------
+#892988 by bangpound: Use ctools export UI for presets, providers.
+#966122 by voxpelli: Cache clearing calls was missing table
+#992124 by voxpelli: Improved the handling of invalid oEmbed responses
+by voxpelli: Flush provider cache on Embed.ly refresh
+
+oEmbed 6.x-0.8, 2010-12-14
+------------------------------
+by voxpelli: Security fix for access bypass
+
+oEmbed 6.x-0.7, 2010-10-20
+------------------------------
+by voxpelli: Disabled providers wasn't really disabled
+by voxpelli: Coding style fix
+by voxpelli: Removed oohEmbed provider
+by voxpelli: Updated scheme for Vimeo
+by voxpelli: Prefixed provider names of Embedly providers
+by voxpelli: Prevented endless recursion in oEmbed Provider
+by voxpelli: Improved responses for failed request to oEmbed Provider
+#890504 by bangpound: Fixed unnecessary saving of provider cache
+#890496 by bangpound: Fixed adding, enabling etc. of a provider not clearing the provider cache
+#890490 by bangpound: Fixed module preprocessors not working with oEmbed Field.
+
+oEmbed 6.x-0.6, 2010-05-28
+------------------------------
+#692392 by Bohman, VoxPelli: Fixed surrounding styles prevent embedding
+by voxpelli: Use drupal_http_request()
+by voxpelli: Add exportable user definable providers
+by voxpelli: Add support for all of Embed.ly:s embeds
+by voxpelli: Fixed bug with default width and height being zero when they shouldn't be set at all
+
+oEmbed 6.x-0.5, 2010-02-21
+------------------------------
+by voxpelli: Added CCK field
+by voxpelli: Added hook for provider definitions
+by voxpelli: Improved theming
+by voxpelli: Added exportable presets/settings for CCK fields (not yet added
+  for the input filters)
diff --git a/profiles/commons/modules/contrib/oembed/MediaInternetOEmbedHandler.inc b/profiles/commons/modules/contrib/oembed/MediaInternetOEmbedHandler.inc
new file mode 100644
index 0000000..d6107c4
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/MediaInternetOEmbedHandler.inc
@@ -0,0 +1,73 @@
+<?php
+
+/**
+ * @file MediaInternetOEmbedHandler.inc
+ *
+ * Contains MediaInternetOEmbedHandler.
+ */
+
+// If MediaInternetBaseHandler class does not exist, prevent the rest of this
+// file from being loaded.
+if (!class_exists('MediaInternetBaseHandler')) {
+  return;
+}
+
+/**
+ * Implementation of MediaInternetBaseHandler.
+ *
+ * @see hook_media_internet_providers().
+ */
+class MediaInternetOEmbedHandler extends MediaInternetBaseHandler {
+
+  public $fileObject;
+
+  /**
+   * Claim this URL.
+   */
+  public function claim($embedCode) {
+    $matches = array();
+    if (oembed_get_provider($embedCode, $matches)) {
+      return TRUE;
+    }
+  }
+
+  /**
+   * File should not validate if we cannot fetch valid oEmbed data.
+   */
+  public function validate() {
+    $file = $this->getFileObject();
+
+    $validators = array('oembed_file_validator_type' => array());
+
+    $errors = file_validate($file, $validators);
+
+    foreach ($errors as $error) {
+      throw new MediaInternetValidationException($error);
+    }
+  }
+
+  /**
+   * Returns a file object which can be used for validation
+   *
+   * @return StdClass
+   */
+  public function getFileObject() {
+    if (!$this->fileObject) {
+      $file = oembed_url_to_file($this->embedCode);
+      $this->fileObject = $file;
+    }
+    return $this->fileObject;
+  }
+
+  /**
+   * Returns an array representation of the oEmbed data, or NULL on failure.
+   *
+   * An example project that calls this method is Media Browser Plus
+   * (http://drupal.org/project/media_browser_plus). Other projects may do so
+   * in the future.
+   */
+  public function getOEmbed() {
+    $embed = oembed_get_data($this->embedCode);
+    return $embed ? (array) $embed : NULL;
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/OEmbedStreamWrapper.inc b/profiles/commons/modules/contrib/oembed/OEmbedStreamWrapper.inc
new file mode 100644
index 0000000..7705e36
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/OEmbedStreamWrapper.inc
@@ -0,0 +1,415 @@
+<?php
+
+/**
+ *  @file
+ *  Create a oEmbed Stream Wrapper class.
+ */
+class OEmbedStreamWrapper implements DrupalStreamWrapperInterface {
+
+  /**
+   * Instance URI (stream).
+   *
+   * A stream is referenced as "scheme://target".
+   *
+   * @var String
+   */
+  protected $uri;
+
+  protected function getTarget($uri = NULL) {
+    return FALSE;
+  }
+
+  /**
+   * Base implementation of getMimeType().
+   */
+  public static function getMimeType($uri, $mapping = NULL) {
+    $url = rawurldecode(substr($uri, 9));
+    $embed = oembed_get_data($url);
+
+    // The mime type can be specified in hook_oembed_response_alter() which is
+    // useful to map responses with type 'rich' and 'link' to more appropriate
+    // Drupal file entity bundles. See oembed_oembed_response_alter().
+    if (isset($embed['mime_type'])) {
+      return $embed['mime_type'];
+    }
+
+    if ($embed) {
+      switch ($embed['type']) {
+        case 'video':
+          return 'video/oembed';
+        case 'photo':
+          return 'image/oembed';
+        default:
+          return 'text/oembed';
+      }
+    }
+    else {
+
+      // URIs for valid oEmbed responses may become invalid after they are saved
+      // to the file_managed table. This might happen because the oEmbed
+      // endpoint is down or the provider is misconfigured. The content may
+      // have been deleted or become inaccessible. Some of these
+      // situations are temporary, so the stream wrapper should try to return a
+      // MIME type for URIs that are already saved as Drupal file entities.
+      $type = db_select('file_managed', 'f')
+        ->fields('f', array('type'))
+        ->condition('uri', $uri)
+        ->execute()
+        ->fetchField();
+
+      if (in_array($type, array('image', 'video', 'audio'))) {
+        return $type .'/oembed';
+      }
+      else if ($type) {
+        return 'text/oembed';
+      }
+    }
+
+    return FALSE;
+  }
+
+  // As part of the inode protection mode returned by stat(), identifies the
+  // file as a regular file, as opposed to a directory, symbolic link, or other
+  // type of "file".
+  // @see http://linux.die.net/man/2/stat
+
+  const S_IFREG = 0100000;
+
+  /**
+   * Template for stat calls.
+   *
+   * All elements must be initialized.
+   */
+  protected $_stat = array(
+    0 => 0, // Device number
+    'dev' => 0,
+    1 => 0, // Inode number
+    'ino' => 0,
+    // Inode protection mode. file_unmanaged_delete() requires is_file() to
+    // return TRUE.
+    2 => self::S_IFREG,
+    'mode' => self::S_IFREG,
+    3 => 0, // Number of links.
+    'nlink' => 0,
+    4 => 0, // Userid of owner.
+    'uid' => 0,
+    5 => 0, // Groupid of owner.
+    'gid' => 0,
+    6 => -1, // Device type, if inode device *
+    'rdev' => -1,
+    7 => 0, // Size in bytes.
+    'size' => 0,
+    8 => 0, // Time of last access (Unix timestamp).
+    'atime' => 0,
+    9 => 0, // Time of last modification (Unix timestamp).
+    'mtime' => 0,
+    10 => 0, // Time of last inode change (Unix timestamp).
+    'ctime' => 0,
+    11 => -1, // Blocksize of filesystem IO.
+    'blksize' => -1,
+    12 => -1, // Number of blocks allocated.
+    'blocks' => -1,
+  );
+
+  /**
+   * Returns a web accessible URL for the resource.
+   *
+   * This function should return a URL that can be embedded in a web page
+   * and accessed from a browser. For example, the external URL of
+   * "youtube://xIpLd0WQKCY" might be
+   * "http://www.youtube.com/watch?v=xIpLd0WQKCY".
+   *
+   * @return string
+   *   Returns a string containing a web accessible URL for the resource.
+   */
+  public function getExternalUrl() {
+    return rawurldecode(substr($this->getUri(), 9));
+  }
+
+  /**
+   * Base implementation of realpath().
+   */
+  public function realpath() {
+    return $this->getExternalUrl();
+  }
+
+  /**
+   * Base implementation of setUri().
+   */
+  public function setUri($uri) {
+    $this->uri = $uri;
+  }
+
+  /**
+   * Base implementation of getUri().
+   */
+  public function getUri() {
+    return $this->uri;
+  }
+
+  /**
+   * Support for fopen(), file_get_contents(), file_put_contents() etc.
+   *
+   * @param string $uri
+   *   A string containing the path to the file to open.
+   * @param string $mode
+   *   The file mode ("r", "wb" etc.).
+   * @param bitmask $options
+   *   A bit mask of STREAM_USE_PATH and STREAM_REPORT_ERRORS.
+   * @param string &$opened_url
+   *   A string containing the path actually opened.
+   *
+   * @return bool
+   *   TRUE if file was opened successfully.
+   */
+  public function stream_open($uri, $mode, $options, &$opened_url) {
+    $this->setUri($uri);
+
+    // We only handle Read-Only mode by default.
+    if ($mode != 'r' && $mode != 'rb') {
+      return FALSE;
+    }
+
+    $matches = array();
+    $provider = oembed_get_provider($this->getExternalUrl(), $matches);
+
+    if ($provider === FALSE) {
+      return FALSE;
+    }
+
+    if ((bool) $provider && ($options & STREAM_USE_PATH)) {
+      $opened_url = $uri;
+    }
+
+    return (bool) $provider;
+  }
+
+  /**
+   * Undocumented PHP stream wrapper method.
+   */
+  function stream_lock($operation) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fread(), file_get_contents() etc.
+   *
+   * @param int $count
+   *   Maximum number of bytes to be read.
+   *
+   * @return bool
+   *   The string that was read, or FALSE in case of an error.
+   */
+  public function stream_read($count) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fwrite(), file_put_contents() etc.
+   *
+   * Since this is a read only stream wrapper this always returns false.
+   *
+   * @param string $data
+   *   The string to be written.
+   *
+   * @return bool
+   *   Returns FALSE.
+   */
+  public function stream_write($data) {
+    return FALSE;
+  }
+
+  /**
+   * Support for feof().
+   *
+   * @return bool
+   *   TRUE if end-of-file has been reached.
+   */
+  public function stream_eof() {
+    return FALSE;
+  }
+
+  /**
+   * Support for fseek().
+   *
+   * @todo document why this returns false.
+   *
+   * @param int $offset
+   *   The byte offset to got to.
+   * @param string $whence
+   *   SEEK_SET, SEEK_CUR, or SEEK_END.
+   *
+   * @return bool
+   *   TRUE on success
+   */
+  public function stream_seek($offset, $whence) {
+    return FALSE;
+  }
+
+  /**
+   * Support for fflush().
+   *
+   * @todo document why this returns false.
+   *
+   * @return bool
+   *   TRUE if data was successfully stored (or there was no data to store).
+   */
+  public function stream_flush() {
+    return FALSE;
+  }
+
+  /**
+   * Support for ftell().
+   *
+   * @todo document why this returns false.
+   *
+   * @return bool
+   *   The current offset in bytes from the beginning of file.
+   */
+  public function stream_tell() {
+    return FALSE;
+  }
+
+  /**
+   * Support for fstat().
+   *
+   * @return array
+   *   An array with file status, or FALSE in case of an error - see fstat()
+   *   for a description of this array.
+   */
+  public function stream_stat() {
+    return $this->_stat;
+  }
+
+  /**
+   * Support for fclose().
+   *
+   * @todo document why this returns TRUE.
+   *
+   * @return bool
+   *   TRUE if stream was successfully closed.
+   */
+  public function stream_close() {
+    return TRUE;
+  }
+
+  /**
+   * Support for stat().
+   *
+   * @param string $url
+   *   A string containing the url to get information about.
+   * @param bitmask $flags
+   *   A bit mask of STREAM_URL_STAT_LINK and STREAM_URL_STAT_QUIET.
+   *
+   * @return array
+   *   An array with file status, or FALSE in case of an error - see fstat()
+   *   for a description of this array.
+   */
+  public function url_stat($url, $flags) {
+    return $this->stream_stat();
+  }
+
+  /**
+   * Support for opendir().
+   *
+   * @param string $url
+   *   A string containing the url to the directory to open.
+   * @param int $options
+   *   Whether or not to enforce safe_mode (0x04).
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_opendir($url, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Support for readdir().
+   *
+   * @return bool
+   *   The next filename, or FALSE if there are no more files in the directory.
+   */
+  public function dir_readdir() {
+    return FALSE;
+  }
+
+  /**
+   * Support for rewinddir().
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_rewinddir() {
+    return FALSE;
+  }
+
+  /**
+   * Support for closedir().
+   *
+   * @return bool
+   *   TRUE on success.
+   */
+  public function dir_closedir() {
+    return FALSE;
+  }
+
+  /**
+   * Undocumented.
+   *
+   * @todo document.
+   */
+  public function getDirectoryPath() {
+    return '';
+  }
+
+  /**
+   * DrupalStreamWrapperInterface requires that these methods be implemented,
+   * but none of them apply to a read-only stream wrapper. On failure they
+   * are expected to return FALSE.
+   */
+
+  /**
+   * Implements DrupalStreamWrapperInterface::unlink().
+   */
+  public function unlink($uri) {
+    // Although the remote file itself can't be deleted, return TRUE so that
+    // file_delete() can remove the file record from the Drupal database.
+    return TRUE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::rename().
+   */
+  public function rename($from_uri, $to_uri) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::mkdir().
+   */
+  public function mkdir($uri, $mode, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::rmdir().
+   */
+  public function rmdir($uri, $options) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::chmod().
+   */
+  public function chmod($mode) {
+    return FALSE;
+  }
+
+  /**
+   * Implements DrupalStreamWrapperInterface::dirname().
+   */
+  public function dirname($uri = NULL) {
+    return FALSE;
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/PATCHES.txt b/profiles/commons/modules/contrib/oembed/PATCHES.txt
new file mode 100644
index 0000000..5dec3c8
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/PATCHES.txt
@@ -0,0 +1,8 @@
+The following patches have been applied to this project:
+- https://drupal.org/files/issues/list-enabled-plugins-2159335-1.patch
+- https://drupal.org/files/issues/remove-wysiwyg-special-casing-2159303-2.patch
+- https://drupal.org/files/issues/provide-default-display-configuration-2128389-3.patch
+- https://drupal.org/files/issues/add-file-and-mime-type-information-to-formatters-2159275-1.patch
+- https://drupal.org/files/issues/prefer-element-attributes-2159269-1.patch
+
+This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/oembed/README b/profiles/commons/modules/contrib/oembed/README
new file mode 100644
index 0000000..63e5771
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/README
@@ -0,0 +1,8 @@
+
+Drupal module implementing the oEmbed standard: http://oembed.com/
+
+* Supplies an input filter that replaces URL:s from oEmbed enabled sites with the embeddable data fetched from it
+* Contains a CCK field for exposing oEmbed content
+* Makes it possible for a Drupal site to become an oEmbed provider itself
+* Creates a oEmbed PHP Stream Wrapper for Resource and implements the various
+  formatter and file listing hooks in the File Entity and Media module.
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info
new file mode 100644
index 0000000..c3c08ae
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info
@@ -0,0 +1,16 @@
+name = Media: oEmbed
+description = Provides oEmbed support to the Media module.
+package = "Media"
+core = 7.x
+files[] = media_oembed.module
+dependencies[] = media_internet
+dependencies[] = oembedcore
+hidden = TRUE
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.install b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.install
new file mode 100644
index 0000000..82950da
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.install
@@ -0,0 +1,89 @@
+<?php
+
+/**
+ * @file
+ * Install, update and uninstall functions for the Media: oEmbed module.
+ */
+
+/**
+ * Implement hook_update_dependencies().
+ */
+function media_oembed_update_dependencies() {
+  $dependencies['oembedcore'][7004] = array(
+    'media_oembed' => 7007,
+  );
+  return $dependencies;
+}
+
+/**
+ * Clear style and preset caches.
+ */
+function media_oembed_update_7001() {
+  // We don't do this if we're using version 1 of Styles.
+  if (function_exists('styles_style_flush')) {
+    styles_style_flush();
+  }
+
+  return array();
+}
+
+/**
+ * Add label to Media: oEmbed file style.
+ */
+function media_oembed_update_7003() {
+  return array();
+}
+
+/**
+ * Rebuild themes.
+ */
+function media_oembed_update_7004() {
+  drupal_theme_rebuild();
+  return array();
+}
+
+/**
+ * Add a large video preset and medium thumbnail.
+ */
+function media_oembed_update_7005() {
+  return array();
+}
+
+/**
+ * Add a square thumbnail preset.
+ */
+function media_oembed_update_7006() {
+  return array();
+}
+
+/**
+ * Rename file displays.
+ */
+function media_oembed_update_7007() {
+  ctools_include('export');
+
+  $displays = ctools_export_load_object('file_display');
+  foreach ($displays as $name => $display) {
+    list($file_type, $view_mode, $formatter_name) = explode('__', $name);
+    if (strpos($formatter_name, 'media_oembed') === 0) {
+      $formatter_name = str_replace('media_oembed', 'oembed', $formatter_name);
+      $new_display = array(
+        'api_version' => 1,
+        'name' => implode('__', array($file_type, $view_mode, $formatter_name)),
+        'status' => $display->status,
+        'weight' => $display->weight,
+        'settings' => $display->settings,
+        'export_type' => NULL,
+      );
+
+      file_display_save((object) $new_display);
+
+      if ($display->export_type & EXPORT_IN_DATABASE) {
+        ctools_export_crud_delete('file_display', $name);
+      }
+      if ($display->export_type & EXPORT_IN_CODE) {
+        ctools_export_crud_disable('file_display', $name);
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.module b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.module
new file mode 100644
index 0000000..b3d9bbc
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.module
@@ -0,0 +1 @@
+<?php
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info
new file mode 100644
index 0000000..0d39447
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info
@@ -0,0 +1,20 @@
+package = oEmbed
+name = oEmbed
+description = Common functionality for oEmbed client and provider
+core = 7.x
+configure = admin/config/media/oembed
+dependencies[] = ctools
+files[] = oembed.module
+files[] = theme/oembed.theme.inc
+files[] = oembed.test
+files[] = OEmbedStreamWrapper.inc
+files[] = MediaInternetOEmbedHandler.inc
+hidden = TRUE
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.install b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.install
new file mode 100644
index 0000000..54dc033
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.install
@@ -0,0 +1,57 @@
+<?php
+
+/**
+ * @file
+ * Install file for the oembed core
+ */
+
+/**
+ * Implement hook_update_dependencies().
+ */
+function oembedcore_update_dependencies() {
+  $dependencies['oembed'][7001] = array(
+    'oembedcore' => 7004,
+  );
+  return $dependencies;
+}
+
+/**
+ * Move oEmbed render cache to separate bin.
+ */
+function oembedcore_update_7000(&$sandbox) {
+  $table = drupal_get_schema_unprocessed('system', 'cache');
+  db_create_table('cache_oembed', $table);
+}
+
+/**
+ * Drop vestigial oembedcore_preset table which should have been dropped long ago.
+ */
+function oembedcore_update_7001() {
+  if (db_table_exists('oembedcore_preset')) {
+    db_drop_table('oembedcore_preset');
+  }
+}
+
+/**
+ * Rename oembedcore_provider table.
+ */
+function oembedcore_update_7002() {
+  db_rename_table('oembedcore_provider', 'oembed_provider');
+}
+
+/**
+ * Enable oEmbed module which replaces oEmbed Core, oEmbed Field and Media oEmbed.
+ */
+function oembedcore_update_7003() {
+  if (!module_exists('oembed')) {
+    module_enable(array('oembed'));
+  }
+}
+
+/**
+ * Disable and uninstall oEmbed Field, Media oEmbed modules.
+ */
+function oembedcore_update_7004() {
+  module_disable(array('oembedfield', 'media_oembed'));
+  drupal_uninstall_modules(array('oembedfield', 'media_oembed'));
+}
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.module b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.module
new file mode 100644
index 0000000..b3d9bbc
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.module
@@ -0,0 +1 @@
+<?php
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info
new file mode 100644
index 0000000..5c87be2
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info
@@ -0,0 +1,14 @@
+package = oEmbed
+name = oEmbed Field
+description = A formatter for the link field which embeds oembeddable content
+core = 7.x
+hidden = TRUE
+dependencies[] = oembedcore
+dependencies[] = link
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.install b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.install
new file mode 100644
index 0000000..49f4b50
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.install
@@ -0,0 +1,37 @@
+<?php
+
+/**
+ * Implement hook_update_dependencies().
+ */
+function oembedfield_update_dependencies() {
+  $dependencies['oembedcore'][7004] = array(
+    'oembedfield' => 7000,
+  );
+  return $dependencies;
+}
+
+/**
+ * Transition field formatters to oEmbed core module.
+ */
+function oembedfield_update_7000() {
+  require_once DRUPAL_ROOT . '/modules/field/field.info.inc';
+  foreach (field_info_field_map() as $field_name => $info) {
+    if ($info['type'] == 'link_field') {
+      foreach ($info['bundles'] as $entity_type => $bundles) {
+        foreach ($bundles as $bundle_name) {
+          $instance = field_read_instance($entity_type, $field_name, $bundle_name);
+          foreach ($instance['display'] as &$display) {
+            if ($display['module'] == 'oembedfield') {
+              $changed = TRUE;
+              $display['module'] = 'oembedcore';
+            }
+          }
+          if ($changed) {
+            field_update_instance($instance);
+          }
+          $changed = FALSE;
+        }
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.module b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.module
new file mode 100644
index 0000000..b3d9bbc
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.module
@@ -0,0 +1 @@
+<?php
diff --git a/profiles/commons/modules/contrib/oembed/help/oembedcore.help.ini b/profiles/commons/modules/contrib/oembed/help/oembedcore.help.ini
new file mode 100644
index 0000000..f6d08c0
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/help/oembedcore.help.ini
@@ -0,0 +1,5 @@
+[advanced help settings]
+line break = TRUE
+
+[providers-plugins]
+title = Provider plugins
diff --git a/profiles/commons/modules/contrib/oembed/help/providers-plugins.html b/profiles/commons/modules/contrib/oembed/help/providers-plugins.html
new file mode 100644
index 0000000..0b736c7
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/help/providers-plugins.html
@@ -0,0 +1,32 @@
+<p>oEmbed Providers plugin data:</p>
+
+<pre>
+'title' => 'Default provider',
+'description' => 'oEmbed provider for remote endpoints',
+
+'scheme callback' => The scheme callback returns an array of regular expressions keyed by
+child plugin name. The scheme callback is called when the plugin is processed by ctools to
+assemble a regular expression of URLs that can be fulfilled by that plugin.
+
+'get child' => The singular 'get child' callback should be used to limit the number of
+plugin definitions that are loaded and cached.
+
+'capture subpatterns' => Local providers extract arguments from the URL. When converting
+the plugin's schemes to regular expressions, the capture subpatterns determines whether
+the $matches array passed around in the request process contains multiple values.
+
+'callback' => Params ($plugin, $url, $matches, $parameters) This callback should return
+an array that is an oEmbed response for the $url and $parameters. If the provider is
+not local, $plugin contains endpoint details. If the provider is local, $matches contains
+arguments from the URL.
+
+'provider' => Boolean to indicate that this plugin is used as an oEmbed provider. Plugins
+that integrate with the oEmbed endpoint so that Drupal content can have an embeddable
+representation available to third party sites are most likely provider plugins.
+'consumer' => Boolean to indicate that this plugin is used as an oEmbed consumer. Plugins
+that integrate with third party sites are most likely consumer plugins.
+
+// If a plugin doesn't indicate TRUE for provider or consumer, it is effectively disabled
+// and will never be used. Plugins may set both 'provider' and 'consumer' to TRUE.
+
+</pre>
diff --git a/profiles/commons/modules/contrib/oembed/oembed.admin.inc b/profiles/commons/modules/contrib/oembed/oembed.admin.inc
new file mode 100644
index 0000000..8675025
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.admin.inc
@@ -0,0 +1,109 @@
+<?php
+
+/**
+ * @file
+ * OEmbed admin pages.
+ */
+
+/**
+ * oEmbed admin settings page callback.
+ */
+function oembed_settings() {
+  $form = array();
+  $period = drupal_map_assoc(array(3600, 10800, 21600, 32400, 43200, 86400, 172800, 259200, 604800, 1209600, 2419200, 4838400, 9676800), 'format_interval');
+  $period[CACHE_PERMANENT] = t('Indefinite');
+  $form['oembed_cache_lifetime'] = array(
+    '#type' => 'select',
+    '#title' => t('Minimum oEmbed cache lifetime'),
+    '#options' => $period,
+    '#default_value' => variable_get('oembed_cache_lifetime', 3600),
+    '#description' => t('Cached oEmbed output will not be re-requested until at least this much time has elapsed.'),
+  );
+  $form['oembed_cache_flush'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Clear oEmbed cache when all Drupal caches are cleared'),
+    '#default_value' => variable_get('oembed_cache_flush', TRUE),
+    '#description' => t('Unselect this to retain unexpired cached oEmbed output even when drupal_flush_all_caches() is called. In conjunction with a long %lifetime, this can help reduce costs when using an oEmbed provider service that charges a fee per request.', array('%lifetime' => t('Minimum oEmbed cache lifetime'))),
+  );
+  return system_settings_form($form);
+}
+
+/**
+ * oEmbed sandbox callback.
+ */
+function oembed_test($form, &$form_state) {
+  $form = array();
+
+  $form['url'] = array(
+    '#type' => 'textfield',
+    '#title' => t('URL'),
+    '#description' => t('URL to request from oEmbed provider'),
+    '#required' => TRUE,
+  );
+  $form['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Submit'),
+  );
+
+  if (isset($form_state['embed'])) {
+    $form['response'] = array(
+      '#type' => 'container',
+    );
+    $form['response']['display']['oembed'] = array(
+      '#type' => 'fieldset',
+      '#title' => t('oEmbed'),
+    );
+    $form['response']['display']['oembed'][] = $form_state['display']['oembed'];
+    $form['response']['display']['oembed'][] = array(
+      '#prefix' => '<pre>',
+      '#markup' => check_plain(drupal_render($form_state['display']['oembed'])),
+      '#suffix' => '</pre>',
+    );
+
+    $form['response']['display']['oembed_thumbnail'] = array(
+      '#type' => 'fieldset',
+      '#title' => t('oEmbed Thumbnail'),
+    );
+    $form['response']['display']['oembed_thumbnail'][] = $form_state['display']['oembed_thumbnail'];
+    $form['response']['display']['oembed_thumbnail'][] = array(
+      '#prefix' => '<pre>',
+      '#markup' => check_plain(drupal_render($form_state['display']['oembed_thumbnail'])),
+      '#suffix' => '</pre>',
+    );
+    $form['response']['details'] = array(
+      '#type' => 'fieldset',
+      '#title' => t('Details'),
+    );
+    $form['response']['details']['data'] = array(
+      '#prefix' => '<pre>',
+      '#markup' => $form_state['embed'],
+      '#suffix' => '</pre>',
+    );
+  }
+  return $form;
+}
+
+/**
+ * Validate input by attemping to request URL and generate display.
+ */
+function oembed_test_validate($form, &$form_state) {
+
+  // Normalize input and look up
+  $url = $form_state['values']['url'];
+  $embed = oembed_get_data($url);
+  if (!empty($embed)) {
+    $form_state['embed'] = check_plain(print_r($embed, TRUE));
+    $form_state['display']['oembed'] = oembed_render_element('oembed', $url);
+    $form_state['display']['oembed_thumbnail'] = oembed_render_element('oembed_thumbnail', $url);
+  }
+  else {
+    form_set_error('url', t("%input is not valid oEmbed URL. Please check the !link for messages.", array('%input' => $form_state['values']['url'], '!link' => l(t("error log"), 'admin/reports/dblog'))));
+  }
+}
+
+/**
+ * Rebuild form.
+ */
+function oembed_test_submit($form, &$form_state) {
+  $form_state['rebuild'] = TRUE;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.api.php b/profiles/commons/modules/contrib/oembed/oembed.api.php
new file mode 100644
index 0000000..c1c53fe
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.api.php
@@ -0,0 +1,44 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by the oEmbed module.
+ */
+
+/**
+ * Alters an oEmbed request parameters and provider.
+ *
+ * @param array $parameters
+ *   oEmbed request parameters.
+ * @param object $provider
+ *   oEmbed provider info.
+ * @param string $url
+ *   The original URL or embed code to parse.
+ */
+function hook_oembed_request_alter(&$parameters, &$provider, $url) {
+  if ($provider['name'] == 'default:youtube') {
+    $parameters['iframe'] = '1';
+  }
+}
+
+/**
+ * Alters an oEmbed response.
+ *
+ * @param array $response
+ *   oEmbed response data.
+ */
+function hook_oembed_response_alter(&$response) {
+}
+
+/**
+ * Modify the provider's set of supported oEmbed response formats.
+ *
+ * @param array $formats
+ *   Format handlers keyed by format name.
+ */
+function hook_oembedprovider_formats_alter(&$formats) {
+  $formats['jsonp'] = array(
+    'mime' => 'text/javascript',
+    'callback' => '_oembedprovider_formats_jsonp',
+  );
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.file.inc b/profiles/commons/modules/contrib/oembed/oembed.file.inc
new file mode 100644
index 0000000..60d78cd
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.file.inc
@@ -0,0 +1,146 @@
+<?php
+
+/**
+ * Implements hook_file_formatter_info().
+ */
+function oembed_file_formatter_info() {
+  $formatters['oembed'] = array(
+    'label' => t('oEmbed'),
+    'file types' => array('audio, document, image, video'),
+    'default settings' => array('width' => '560', 'height' => '340', 'wmode' => ''),
+    'view callback' => 'oembed_file_formatter_view',
+    'settings callback' => 'oembed_file_formatter_oembed_settings',
+    'description' => t('All-purpose oEmbed formatter.'),
+    'mime types' => array('audio/oembed', 'image/oembed', 'text/oembed', 'video/oembed'),
+  );
+  $formatters['oembed_thumbnail'] = array(
+    'label' => t('oEmbed thumbnail'),
+    'file types' => array('audio, document, image, video'),
+    'default settings' => array('width' => '180', 'height' => ''),
+    'view callback' => 'oembed_file_formatter_view',
+    'settings callback' => 'oembed_file_formatter_oembed_thumbnail_settings',
+    'description' => t('oEmbed thumbnail media.'),
+    'mime types' => array('audio/oembed', 'image/oembed', 'text/oembed', 'video/oembed'),
+  );
+  return $formatters;
+}
+
+/**
+ * Implements hook_file_formatter_info_alter().
+ */
+function oembed_file_formatter_info_alter(&$info) {
+  if (isset($info['file_image'])) {
+    $info['oembed_image'] = array(
+      'label' => t('oEmbed image'),
+      'view callback' => 'oembed_remote_file_formatter_view',
+      'description' => t('oEmbed photo or thumbnail is saved to local filesystem and transformed by image styles.'),
+    ) + $info['file_image'];
+  }
+}
+
+/**
+ * Implements hook_file_mimetype_mapping_alter().
+ */
+function oembed_file_mimetype_mapping_alter(&$mapping) {
+  $mapping['mimetypes'][] = 'video/oembed';
+  $mapping['mimetypes'][] = 'image/oembed';
+  $mapping['mimetypes'][] = 'text/oembed';
+  $mapping['mimetypes'][] = 'audio/oembed';
+}
+
+/**
+ * Implements hook_file_operations().
+ */
+function oembed_file_operation_info() {
+  $operations = array(
+    'refresh' => array(
+      'label' => t('Refresh from source'),
+      'callback' => 'oembed_cache_clear',
+    ),
+  );
+  return $operations;
+}
+
+/**
+ * Implements hook_file_presave().
+ */
+function oembed_file_presave($file) {
+  // For new oEmbed files, set the filename to the oEmbed response's title or calculated
+  // alt attribute.
+  if (empty($file->fid) && isset($file->metadata['oembed'])) {
+    $embed = $file->metadata['oembed'];
+    $file->filename = truncate_utf8(empty($embed['title']) ? oembed_alt_attr($embed) : $embed['title'], 255);
+  }
+
+  // Fetch image dimensions.
+  oembed_metadata_fetch_image_dimensions($file);
+}
+
+/**
+ * Implements hook_file_load().
+ */
+function oembed_file_load($files) {
+  foreach ($files as $file) {
+    $scheme = file_uri_scheme($file->uri);
+    if ($scheme == 'oembed' && !isset($file->metadata['oembed'])) {
+
+      // Load plain oEmbed response onto file entity.
+      $wrapper = file_stream_wrapper_get_instance_by_uri($file->uri);
+      $file->metadata['oembed'] = oembed_get_data($wrapper->getExternalUrl());
+
+      // Retrieve any missing images dimensions.
+      oembed_metadata_fetch_image_dimensions($file);
+
+      foreach (array('oembed', 'width', 'height') as $name) {
+        if (!empty($file->metadata[$name])) {
+          $value = $file->metadata[$name];
+          db_merge('file_metadata')
+            ->fields(array(
+              'value' => serialize($value),
+            ))
+            ->key(array(
+              'fid' => $file->fid,
+              'name' => $name,
+            ))
+            ->execute();
+        }
+      }
+    }
+  }
+}
+
+/**
+ * Fetch the dimensions of an image and store them in the file metadata array.
+ */
+function oembed_metadata_fetch_image_dimensions($file) {
+
+  $scheme = file_uri_scheme($file->uri);
+  if ($scheme != 'oembed') {
+    return;
+  }
+
+  // Do not bother proceeding if this file does not have an image mime type.
+  if (file_entity_file_get_mimetype_type($file) != 'image') {
+    return;
+  }
+
+  // We have a non-empty image file.
+  $embed = $file->metadata['oembed'];
+  if ($embed && $embed['type'] == 'photo' && !empty($embed['width']) && !empty($embed['height'])) {
+    $file->metadata['width'] = $embed['width'];
+    $file->metadata['height'] = $embed['height'];
+  }
+  else {
+    // Fallback to NULL values.
+    $file->metadata['width'] = NULL;
+    $file->metadata['height'] = NULL;
+  }
+}
+
+/**
+ * Implements hook_file_metadata_info().
+ */
+function oembed_file_metadata_info() {
+  $info['oembed'] = array('label' => t('oEmbed'), 'type' => 'array');
+  return $info;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.file_default_displays.inc b/profiles/commons/modules/contrib/oembed/oembed.file_default_displays.inc
new file mode 100644
index 0000000..33d6951
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.file_default_displays.inc
@@ -0,0 +1,159 @@
+<?php
+
+/**
+ * @file
+ * Default display configuration for the default file types.
+ */
+
+/**
+ * Implements hook_file_default_displays().
+ */
+function oembed_file_default_displays() {
+  $file_displays = array();
+
+  // Audio.
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__default__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '560',
+    'height' => '340',
+    'wmode' => '',
+  );
+  $file_displays['audio__default__oembed'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'audio__preview__oembed_thumbnail';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '100',
+    'height' => '100',
+  );
+  $file_displays['audio__preview__oembed_thumbnail'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__teaser__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '280',
+    'height' => '170',
+    'wmode' => '',
+  );
+  $file_displays['audio__teaser__oembed'] = $file_display;
+
+  // Document.
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__default__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '560',
+    'height' => '340',
+    'wmode' => '',
+  );
+  $file_displays['document__default__oembed'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__preview__oembed_thumbnail';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '100',
+    'height' => '100',
+  );
+  $file_displays['document__preview__oembed_thumbnail'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'document__teaser__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '280',
+    'height' => '170',
+    'wmode' => '',
+  );
+  $file_displays['document__teaser__oembed'] = $file_display;
+
+  // Image.
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__default__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '560',
+    'height' => '340',
+    'wmode' => '',
+  );
+  $file_displays['image__default__oembed'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__preview__oembed_thumbnail';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '100',
+    'height' => '100',
+  );
+  $file_displays['image__preview__oembed_thumbnail'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__teaser__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '280',
+    'height' => '170',
+    'wmode' => '',
+  );
+  $file_displays['image__teaser__oembed'] = $file_display;
+
+  // Video.
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__default__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '560',
+    'height' => '340',
+    'wmode' => '',
+  );
+  $file_displays['video__default__oembed'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__preview__oembed_thumbnail';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '100',
+    'height' => '100',
+  );
+  $file_displays['video__preview__oembed_thumbnail'] = $file_display;
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'video__teaser__oembed';
+  $file_display->weight = 0;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'width' => '280',
+    'height' => '170',
+    'wmode' => '',
+  );
+  $file_displays['video__teaser__oembed'] = $file_display;
+
+  return $file_displays;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.file_type.inc b/profiles/commons/modules/contrib/oembed/oembed.file_type.inc
new file mode 100644
index 0000000..c935b73
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.file_type.inc
@@ -0,0 +1,18 @@
+<?php
+
+/**
+ * Implements hook_file_default_types_alter().
+ */
+function oembed_file_default_types_alter(&$types) {
+  $types['image']->mimetypes[] = 'image/oembed';
+  $types['image']->streams[] = 'oembed';
+
+  $types['video']->mimetypes[] = 'video/oembed';
+  $types['video']->streams[] = 'oembed';
+
+  $types['document']->mimetypes[] = 'text/oembed';
+  $types['document']->streams[] = 'oembed';
+
+  $types['audio']->mimetypes[] = 'audio/oembed';
+  $types['audio']->streams[] = 'oembed';
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.filter.inc b/profiles/commons/modules/contrib/oembed/oembed.filter.inc
new file mode 100644
index 0000000..6bf185d
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.filter.inc
@@ -0,0 +1,382 @@
+<?php
+
+/**
+ * @file
+ * Input filter that enhances oEmbed enabled URLs with extra content
+ */
+
+define('OEMBED_PATTERN_AUTOEMBED', '|^\s*(https?://[^\s"]+)\s*$|im');
+define('OEMBED_PATTERN_EMBED_SHORTCODE', '/(.?)\[embed\b(.*?)\](.+?)\[\/embed\](.?)/s');
+define('OEMBED_PATTERN_EMBED_UNWRAP', '/<p>\s*+(\[embed\b.*?\].+?\[\/embed\])\s*+<\/p>/s');
+
+/**
+ * Implements hook_filter_info().
+ */
+function oembed_filter_info() {
+  $filters['oembed'] = array(
+    'title' => t('oEmbed filter'),
+    'description' => t('Embeds content for oEmbed-enabled web addresses and turns the rest, and e-mail addresses, into clickable links.'),
+    'prepare callback' => 'oembed_filter_oembed_prepare',
+    'process callback' => 'oembed_filter_oembed_process',
+    'settings callback' => 'oembed_filter_oembed_settings',
+    'tips callback' => 'oembed_filter_oembed_tips',
+    'default settings' => array(
+      'options' => '',
+      'view_mode' => 'full',
+      'autoembed' => TRUE,
+    ),
+  );
+  $filters['oembed_legacy'] = array(
+    'title' => t('oEmbed legacy filter'),
+    'description' => t('Embeds content for oEmbed-enabled web addresses and turns the rest, and e-mail addresses, into clickable links.'),
+    'process callback' => 'oembed_filter_oembed_legacy_process',
+    'settings callback' => 'oembed_filter_oembed_legacy_settings',
+    'default settings' => array(
+      'maxwidth' => '',
+      'maxheight' => '',
+    ),
+  );
+  return $filters;
+}
+
+/**
+ * Implements hook_filter_FILTER_settings().
+ */
+function oembed_filter_oembed_legacy_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
+  module_load_include('inc', 'oembed', 'oembed_legacy');
+  return _oembed_filter_settings($form, $form_state, $filter, $format, $defaults);
+}
+
+/**
+ * Implements hook_filter_FILTER_process().
+ */
+function oembed_filter_oembed_legacy_process($text, $filter, $format, $langcode, $cache, $cache_id) {
+  module_load_include('inc', 'oembed', 'oembed_legacy');
+  return _oembed_filter_apply($text, $filter, $format, $langcode, $cache, $cache_id);
+}
+
+/**
+ * Implements hook_filter_FILTER_settings().
+ */
+function oembed_filter_oembed_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
+  $filter->settings += $defaults;
+  $settings = array();
+
+  if (module_exists('file_entity') && module_exists('inline')) {
+    $options = array();
+    $entity_info = entity_get_info('file');
+    $view_modes = $entity_info['view modes'];
+    foreach ($view_modes as $view_mode_name => $view_mode_info) {
+      $options[$view_mode_name] = $view_mode_info['label'];
+    }
+    if (empty($options)) {
+      $options['full'] = t('Full');
+    }
+    $settings['view_mode'] = array(
+      '#type' => 'select',
+      '#options' => $options,
+      '#title' => t('File entity view mode'),
+      '#default_value' => $filter->settings['view_mode'],
+    );
+  }
+  else {
+    $settings['view_mode'] = array(
+      '#type' => 'value',
+      '#value' => $filter->settings['view_mode'],
+    );
+  }
+  $settings['options'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Default oEmbed request options'),
+    '#default_value' => $filter->settings['options'],
+    '#description' => t('A series of attribute value pairs for the default request options. For example, <em>maxwidth="500"</em>.'),
+  );
+  $settings['autoembed'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Automatically embed URLs'),
+    '#default_value' => $filter->settings['autoembed'],
+    '#description' => t('When possible, embed the media content from a URL directly in the input.'),
+  );
+  return $settings;
+}
+
+/**
+ * Implements hook_filter_FILTER_process().
+ */
+function oembed_filter_oembed_prepare($text, $filter, $format, $langcode, $cache, $cache_id) {
+  if ($filter->settings['autoembed']) {
+    $text = preg_replace_callback(OEMBED_PATTERN_AUTOEMBED, 'oembed_preg_auto_replace', $text);
+  }
+  return $text;
+}
+
+/**
+ * Implements hook_filter_FILTER_process().
+ */
+function oembed_filter_oembed_process($text, $filter, $format, $langcode, $cache, $cache_id) {
+  global $_oembed_filter_settings;
+
+  $_oembed_filter_settings = !empty($filter->settings['options']) ? oembed_parse_attr($filter->settings['options']) : array();
+  $_oembed_filter_settings['view_mode'] = $filter->settings['view_mode'];
+
+  // Undo auto paragraph around oEmbed shortcodes.
+  $text = preg_replace(OEMBED_PATTERN_EMBED_UNWRAP, '$1', $text);
+
+  $text = preg_replace_callback(OEMBED_PATTERN_EMBED_SHORTCODE, 'oembed_preg_tag_replace', $text);
+
+  unset($_oembed_filter_settings);
+
+  return $text;
+}
+
+/**
+ * Implements hook_filter_FILTER_tips().
+ */
+function oembed_filter_oembed_tips($filter, $format, $long) {
+  if ($long) {
+    return t('Embed content by wrapping a supported URL in [embed] &hellip; [/embed]. Set options such as width and height with attributes [embed width="123" height="456"] &hellip; [/embed]. Unsupported options will be ignored.');
+  }
+  else {
+    return t('Embed content by wrapping a supported URL in [embed] &hellip; [/embed].');
+  }
+}
+
+/**
+ * PREG replace callback finds [embed] shortcodes, URLs and request options.
+ */
+function oembed_preg_tag_replace($match) {
+  global $_oembed_filter_settings;
+
+  // allow [[oembed]] syntax for escaping a tag
+  if ($match[1] == '[' && $match[4] == ']') {
+    return substr($match[0], 1, -1);
+  }
+
+  $url = $match[3];
+
+  $view_mode = $_oembed_filter_settings['view_mode'];
+
+  $shortcode_options = !empty($match[2]) ? oembed_parse_attr($match[2]) : array();
+  $options = array_merge($_oembed_filter_settings, $shortcode_options);
+
+  if (isset($options['view_mode'])) {
+    $view_mode = $options['view_mode'];
+    unset($options['view_mode']);
+  }
+
+  return $match[1] . oembed_resolve_link($url, $view_mode, $options) . $match[4];
+}
+
+/**
+ * PREG replace callback finds URLs
+ */
+function oembed_preg_auto_replace($match) {
+  return '[embed]'. $match[1] ."[/embed]\n";
+}
+
+/**
+ * PREG replace callback finds [embed] shortcodes, URLs and request options.
+ *
+ * @see MediaInternetOEmbedHandler::preSave().
+ */
+function oembed_resolve_link($url, $view_mode = 'full', $options = array()) {
+
+  $url = decode_entities($url);
+
+  $element = array();
+  $matches = array();
+
+  // If file_entity module is enabled, treat the URL as an uploaded file. Inline is used
+  // to defer the rendering of the embedded content until the entity is actually viewed.
+  // This technique allows content to be cached by Drupal's filter system.
+  if (module_exists('file_entity') && module_exists('inline')) {
+    $file = oembed_url_to_file($url);
+    $file->override = $options;
+    if (isset($file->fid)) {
+      $macro_params = array();
+      $macro_params[] = 'entity';
+      $macro_params[] = 'type=file';
+      $macro_params[] = 'id='. $file->fid;
+      $macro_params[] = 'view_mode='. $view_mode;
+      $element = array('#markup' => "\r\n".'[' . implode('|', $macro_params) . ']'."\r\n");
+    }
+  }
+  else if ($provider = oembed_get_provider($url, $matches)) {
+    $embed = oembed_get_data($url);
+    if ($embed) {
+      $element = oembed_render_element('oembed', $url, $options);
+    }
+  }
+
+  $return = drupal_render($element);
+
+  if (empty($return)) {
+    $return = $url;
+  }
+
+  return $return;
+}
+
+/**
+ * Retrieve all attributes from the shortcodes tag.
+ *
+ * @see shortcode_parse_atts in WordPress 3.1.3.
+ * @param string $text
+ * @return array List of attributes and their value.
+ */
+function oembed_parse_attr($text) {
+  $attributes = array();
+  $pattern = '/(\w+)\s*=\s*"([^"]*)"(?:\s|$)|(\w+)\s*=\s*\'([^\']*)\'(?:\s|$)|(\w+)\s*=\s*([^\s\'"]+)(?:\s|$)|"([^"]*)"(?:\s|$)|(\S+)(?:\s|$)/';
+  $text = preg_replace("/[\x{00a0}\x{200b}]+/u", " ", $text);
+  if (preg_match_all($pattern, $text, $matches, PREG_SET_ORDER)) {
+    foreach ($matches as $match) {
+      if (!empty($match[1])) {
+        $attributes[strtolower($match[1])] = stripcslashes($match[2]);
+      }
+      elseif (!empty($match[3])) {
+        $attributes[strtolower($match[3])] = stripcslashes($match[4]);
+      }
+      elseif (!empty($match[5])) {
+        $attributes[strtolower($match[5])] = stripcslashes($match[6]);
+      }
+      elseif (isset($match[7]) and strlen($match[7])) {
+        $attributes[] = stripcslashes($match[7]);
+      }
+      elseif (isset($match[8])) {
+        $attributes[] = stripcslashes($match[8]);
+      }
+    }
+  } else {
+    $attributes = ltrim($text);
+  }
+  return $attributes;
+}
+
+/**
+ * Extract all URLs for oEmbed to process.
+ *
+ * Returns an array of URLs grouped by field, delta, and column.
+ */
+function _oembed_field_extract_urls($entity_type, $entity) {
+  $urls = array();
+
+  // Determine if any formats use oEmbed filter.
+  $filter_settings = array();
+  foreach (filter_formats() as $format) {
+    $filters = filter_list_format($format->format);
+    if (isset($filters['oembed']) && $filters['oembed']->status) {
+      $filter_settings[$format->format] = $filters['oembed']->settings;
+    }
+  }
+
+  if (!empty($filter_settings)) {
+
+    list(, , $bundle) = entity_extract_ids($entity_type, $entity);
+    $instances = field_info_instances($entity_type, $bundle);
+
+    foreach ($instances as $info) {
+
+      // All text fields have a text_processing setting. Only search text fields with
+      // text processing enabled.
+      if (isset($info['settings']['text_processing']) && $info['settings']['text_processing']) {
+        $items = field_get_items($entity_type, $entity, $info['field_name']);
+        if (!$items) {
+          continue;
+        }
+        foreach ($items as $delta => $item) {
+          if (isset($filter_settings[$item['format']])) {
+
+            // URLs may be contained within the other column values.
+            foreach (array('value', 'summary') as $column) {
+              if (!empty($item[$column])) {
+                $text = $item[$column];
+
+                // copied from oembed_filter_oembed_prepare().
+                if ($filter_settings[$item['format']]['autoembed']) {
+                  $text = preg_replace_callback(OEMBED_PATTERN_AUTOEMBED, 'oembed_preg_auto_replace', $text);
+                }
+
+                // copied from oembed_filter_oembed_process().
+                $matches = array();
+                preg_match_all(OEMBED_PATTERN_EMBED_SHORTCODE, $text, $matches);
+                $urls[$info['field_name']][$delta][$column] = array_filter($matches[3], '_oembed_field_filter_urls');
+              }
+            }
+          }
+        }
+      }
+    }
+  }
+
+  return $urls;
+}
+
+/**
+ * array_filter() callback that removes URLs for which there is no provider.
+ */
+function _oembed_field_filter_urls($match) {
+  $matches = array();
+  if (oembed_get_provider($match, $matches)) {
+    return TRUE;
+  }
+  return FALSE;
+}
+
+/**
+ * Implements hook_field_attach_validate().
+ */
+function oembed_field_attach_validate($entity_type, $entity, array &$errors) {
+  foreach (_oembed_field_extract_urls($entity_type, $entity) as $field_name => $items) {
+    foreach ($items as $delta => $item) {
+      foreach ($item as $column => $urls) {
+        $messages = array();
+        foreach ($urls as $url) {
+          $embed = oembed_get_data($url);
+          $validation_errors = oembed_validate_response($embed);
+          if (!empty($validation_errors)) {
+            $message = t('!url could not be embedded.', array('!url' => l(_filter_url_trim($url, 50), $url)));
+            $message .= theme('item_list', array('items' => $validation_errors));
+            $messages[] = $message;
+          }
+        }
+        if (!empty($messages)) {
+          $errors[$field_name][$entity->language][$delta][] = array(
+            'error' => 'oembed_'. $column,
+            'message' => theme('item_list', array('items' => $messages)),
+            'repeat' => TRUE,
+          );
+        }
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_entity_insert().
+ */
+function oembed_entity_insert($entity, $entity_type) {
+  if (module_exists('file_entity')) {
+    list($id, , ) = entity_extract_ids($entity_type, $entity);
+    $uris = array();
+    foreach (_oembed_field_extract_urls($entity_type, $entity) as $items) {
+      foreach ($items as $item) {
+        foreach ($item as $urls) {
+          foreach ($urls as $url) {
+            $uris[$url] = isset($uris[$url]) ? $uris[$url] + 1 : 1;
+          }
+        }
+      }
+    }
+
+    foreach ($uris as $url => $count) {
+      $file = oembed_url_to_file($url, TRUE);
+      file_usage_delete($file, 'oembed', $entity_type, $id, 0);
+      file_usage_add($file, 'oembed', $entity_type, $id, $count);
+    }
+  }
+}
+
+function oembed_entity_update($entity, $entity_type) {
+  oembed_entity_insert($entity, $entity_type);
+}
+
diff --git a/profiles/commons/modules/contrib/oembed/oembed.info b/profiles/commons/modules/contrib/oembed/oembed.info
new file mode 100644
index 0000000..04cf4e7
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.info
@@ -0,0 +1,19 @@
+package = oEmbed
+name = oEmbed
+description = Common functionality for oEmbed client and provider
+core = 7.x
+configure = admin/config/media/oembed
+dependencies[] = ctools
+files[] = oembed.module
+files[] = theme/oembed.theme.inc
+files[] = oembed.test
+files[] = OEmbedStreamWrapper.inc
+files[] = MediaInternetOEmbedHandler.inc
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/oembed.install b/profiles/commons/modules/contrib/oembed/oembed.install
new file mode 100644
index 0000000..8a8d0f3
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.install
@@ -0,0 +1,87 @@
+<?php
+
+/**
+ * Implementation of hook_schema().
+ */
+function oembed_schema() {
+  $schema['oembed_provider'] = _oembed_provider_schema_1();
+  $schema['cache_oembed'] = drupal_get_schema_unprocessed('system', 'cache');
+  $schema['cache_oembed']['description'] = 'Cache table for the oEmbed module.';
+  return $schema;
+}
+
+function _oembed_provider_schema_1() {
+  return array(
+    'export' => array(
+      'identifier'      => 'provider',
+      'primary key'     => 'pid',
+      'bulk export'     => TRUE,
+      'default hook'    => 'default_oembed_provider',
+      'api' => array(
+        'owner' => 'oembed',
+        'api' => 'oembed_provider',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+    'fields' => array(
+      'pid' => array(
+        'type'        => 'serial',
+        'description' => 'Primary ID field for the table. Not used for anything except internal lookups.',
+        'not null'    => TRUE,
+        'no export'   => TRUE,
+      ),
+      'name' => array(
+        'type'        => 'varchar',
+        'length'      => 255,
+        'description' => 'Unique ID for this subtask. Used to identify it programmatically.',
+        'not null'    => TRUE,
+        'default'     => '',
+      ),
+      'title' => array(
+        'description' => 'The human-readable title of the provider.',
+        'type'        => 'varchar',
+        'length'      => 255,
+        'not null'    => TRUE,
+        'default'     => '',
+      ),
+      'endpoint' => array(
+        'type'        => 'varchar',
+        'length'      => 255,
+        'description' => 'The endpoint for this provider.',
+        'not null'    => TRUE,
+        'default'     => '',
+      ),
+      'scheme' => array(
+        'type'           => 'text',
+        'size'           => 'big',
+        'description'    => 'Line separated scheme definition.',
+        'not null'       => TRUE,
+        'serialize'      => TRUE,
+        'object default' => '',
+      ),
+    ),
+    'primary key' => array('pid'),
+    'unique keys' => array(
+      'name' => array('name'),
+    ),
+  );
+}
+
+/**
+ * Rename extant oembed filters to oembed_legacy.
+ */
+function oembed_update_7000(&$sandbox) {
+  db_update('filter')
+    ->fields(array('name' => 'oembed_legacy'))
+    ->condition('name', 'oembed')
+    ->execute();
+}
+
+/**
+ * Disable and uninstall oEmbed core.
+ */
+function oembed_update_7001() {
+  module_disable(array('oembedcore'));
+  drupal_uninstall_modules(array('oembedcore'));
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.media.inc b/profiles/commons/modules/contrib/oembed/oembed.media.inc
new file mode 100644
index 0000000..7a59bdb
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.media.inc
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ *  Implements hook_media_parse().
+ *
+ *  @todo: this might be deprecated now that we have media_internet,
+ *  but the hook is still being called in a couple places in media.
+ */
+function oembed_media_parse($url, $options = array()) {
+  $scheme = 'oembed://';
+  $matches = array();
+  if ($provider = oembed_get_provider($url, $matches)) {
+    return file_stream_wrapper_uri_normalize($scheme . drupal_encode_path($url));
+  }
+  // @TODO: Validate for malformed oembed urls.
+}
+
+/**
+ * Implements hook_media_internet_providers();
+ */
+function oembed_media_internet_providers() {
+  $info['MediaInternetOEmbedHandler'] = array(
+    'title' => t('oEmbed'),
+  );
+
+  return $info;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.module b/profiles/commons/modules/contrib/oembed/oembed.module
new file mode 100644
index 0000000..0b7569f
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.module
@@ -0,0 +1,1006 @@
+<?php
+
+/**
+ * @file
+ * Core functionality for oEmbed
+ */
+
+require_once dirname(__FILE__) . '/oembed.filter.inc';
+
+/**
+ * Implements hook_hook_info().
+ */
+function oembed_hook_info() {
+  $hooks['oembed_request_alter'] = array(
+    'group' => 'oembed',
+  );
+  $hooks['oembed_response_alter'] = array(
+    'group' => 'oembed',
+  );
+  return $hooks;
+}
+
+/**
+ * Implements hook_help().
+ */
+function oembed_help($path, $arg) {
+  switch ($path) {
+    case 'admin/help#oembed':
+      $output = '<p>'. t('oEmbed module will allow your Drupal site to embed content from <a href="@oembed">oEmbed</a>-providers as well as for the site to become an oEmbed-provider itself so that other oEmbed-enabled websites can easily embed your content.', array('@oembed' => 'http://www.oembed.com/')) .'</p>';
+      $output .= '<p>'. t('Add or enable <a href="@provider">providers</a> to embed content from other sites.', array('@provider' => url('admin/build/oembed/provider'))) .'</p>';
+      $output .= '<p>'. t('Adds an input filter for replacing oEmbed enabled URLs with embedded content') .'</p>';
+      return $output;
+
+    case 'admin/config/media/oembed':
+    case 'admin/config/media/oembed/consumer':
+      $output = '<p>'. t('These settings affect how your site behaves when it makes requests as an oEmbed consumer.') .'</p>';
+      return $output;
+
+    case 'admin/config/media/oembed/provider':
+      $output = '<p>'. t('Providers are other web sites with oEmbed endpoints whose content you can embed on your site.') .'</p>';
+      return $output;
+
+    case 'admin/config/media/oembed/test':
+      $output = '<p>'. t('Use this form to test your configuration of provider plugins and endpoints.') .'</p>';
+      return $output;
+  }
+}
+
+/**
+ * Implements hook_permission().
+ */
+function oembed_permission() {
+  return array(
+    'administer oembed' => array(
+      'title' => t('Administer oEmbed'),
+      'description' => t('Define providers for oEmbed.'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_flush_caches().
+ */
+function oembed_flush_caches() {
+  // Because some oEmbed providers (e.g., http://embed.ly) charge per request,
+  // allow cache_oembed to opt out of drupal_flush_all_caches() clearing.
+  if (variable_get('oembed_cache_flush', TRUE)) {
+    return array('cache_oembed');
+  }
+}
+
+/**
+ * Implements hook_cron().
+ */
+function oembed_cron() {
+  // If cache_oembed opts out of oembed_flush_caches(), then system_cron()
+  // doesn't clear its expired records, so do so here.
+  if (!variable_get('oembed_cache_flush', TRUE)) {
+    cache_clear_all(NULL, 'cache_oembed');
+  }
+}
+
+/**
+ * Implements hook_menu().
+ */
+function oembed_menu() {
+  $items = array();
+
+  $items['admin/config/media/oembed'] = array(
+    'title' => 'oEmbed',
+    'description' => 'Settings for oEmbed',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('oembed_settings'),
+    'file' => 'oembed.admin.inc',
+    'access arguments' => array('administer site configuration'),
+  );
+  $items['admin/config/media/oembed/consumer'] = array(
+    'title' => 'Consumer settings',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+  );
+  $items['admin/config/media/oembed/provider'] = array(
+    'title' => 'Provider plugins',
+    'description' => 'Settings for oEmbed provider plugins',
+    'type' => MENU_LOCAL_TASK,
+  );
+  $items['admin/config/media/oembed/test'] = array(
+    'title' => 'Test',
+    'description' => 'Test URLs for oEmbed',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('oembed_test'),
+    'file' => 'oembed.admin.inc',
+    'type' => MENU_LOCAL_TASK,
+    'access arguments' => array('administer site configuration'),
+  );
+
+  return $items;
+}
+
+/**
+ * Implements hook_menu_alter().
+ *
+ * Instead of rewriting ctools export UI's hook_menu implementations, alter
+ * the callback items to have a common menu item.
+ */
+function oembed_menu_alter(&$items) {
+
+  // Create a new menu item where all oembed export UIs will be local tasks by
+  // copying the export UI's menu item that will become the default local task.
+  $items['admin/config/media/oembed/provider'] += $items['admin/config/media/oembed/provider/default'];
+  $items['admin/config/media/oembed/provider']['type'] = MENU_LOCAL_TASK;
+
+  $items['admin/config/media/oembed/provider/default']['type'] = MENU_DEFAULT_LOCAL_TASK;
+}
+
+/**
+ * Implements of hook_theme().
+ */
+function oembed_theme() {
+  $path = drupal_get_path('module', 'oembed') . '/theme';
+  return array(
+    'oembed' => array(
+      'file' => 'oembed.theme.inc',
+      'path' => $path,
+      'variables' => array('embed' => NULL),
+    ),
+    'oembed__photo' => array(
+      'variables' => array('embed' => NULL),
+      'base hook' => 'oembed',
+    ),
+    'oembed__rich' => array(
+      'variables' => array('embed' => NULL),
+      'base hook' => 'oembed',
+    ),
+    'oembed__video' => array(
+      'variables' => array('embed' => NULL),
+      'base hook' => 'oembed',
+    ),
+  );
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ *
+ * Adds enabled oEmbed plugins to the list of enabled web media providers.
+ */
+function oembed_form_media_internet_add_alter(&$form, $form_state) {
+  if (isset($form['providers'])) {
+    // Create an array to hold potential Internet media providers.
+    $providers = array();
+
+    // Determine if there are any visible providers.
+    foreach (media_internet_get_providers() as $key => $provider) {
+      if (empty($provider['hidden']) || $provider['hidden'] != TRUE) {
+        if ($provider['module'] != 'oembed') {
+          $providers[] = array(
+            'data' => check_plain($provider['title']),
+            'class' => array(drupal_html_class($provider['title'])),
+          );
+        }
+        else {
+          ctools_include('plugins');
+          $plugins = ctools_get_plugins('oembed', 'providers');
+          uasort($plugins, 'ctools_plugin_sort');
+
+          // Create an array to hold potential oEmbed providers.
+          $oembed_providers = array();
+
+          foreach ($plugins as $plugin) {
+            // A plugin with no schemes is effectively disabled.
+            if (!empty($plugin['scheme'])) {
+              // A scheme map is used to match a URL to a specific child plugin.
+              if (!empty($plugin['scheme map'])) {
+                foreach ($plugin['scheme map'] as $id => $scheme) {
+                  // This forces the 'get child' callback to the loaded.
+                  ctools_plugin_get_function($plugin, 'get child');
+                  $plugin = ctools_get_plugins('oembed', 'providers', $id);
+
+                  $oembed_providers[] = array(
+                    'data' => check_plain($plugin['title']),
+                    'class' => array(drupal_html_class($plugin['title'])),
+                  );
+                }
+              }
+            }
+          }
+
+          $providers[] = array(
+            'data' => check_plain($provider['title']),
+            'class' => array(drupal_html_class($provider['title'])),
+            'children' => $oembed_providers,
+          );
+        }
+      }
+    }
+
+    // Override the default list of providers.
+    $form['providers']['#items'] = $providers;
+  }
+}
+
+/**
+ * Returns the provider for a url.
+ *
+ * @param string $url
+ *  The url to get the provider for.
+ * @return mixed
+ *  A valid callback or FALSE
+ */
+function oembed_get_provider($url, &$matches, $role = 'consumer') {
+  ctools_include('plugins');
+  $plugins = ctools_get_plugins('oembed', 'providers');
+  uasort($plugins, 'ctools_plugin_sort');
+
+  // This function may need check twice if a provider matches the URL. The first check
+  // is to determine if the plugin's callback can handle the URL. The second check
+  // returns the name of the child plugin that can fulfill the request.
+  foreach ($plugins as $plugin) {
+
+    // A plugin with no schemes is effectively disabled.
+    if ($plugin[$role] && !empty($plugin['scheme'])) {
+
+      // Plugins will only be checked if they are enabled for the role.
+      if (preg_match($plugin['scheme'], $url, $matches)) {
+
+        // A scheme map is used to match a URL to a specific child plugin.
+        if (!empty($plugin['scheme map'])) {
+          foreach ($plugin['scheme map'] as $id => $scheme) {
+            if (preg_match($scheme, $url, $matches)) {
+
+              // This forces the 'get child' callback to the loaded.
+              ctools_plugin_get_function($plugin, 'get child');
+              $plugin = ctools_get_plugins('oembed', 'providers', $id);
+              break;
+            }
+          }
+        }
+
+        return $plugin;
+      }
+    }
+  }
+  return FALSE;
+}
+
+/**
+ * Reset the registered provider caches.
+ */
+function oembed_providers_reset() {
+  ctools_include('plugins');
+  ctools_get_plugins_reset();
+  $info = ctools_plugin_get_info('oembed', 'providers');
+  cache_clear_all('plugins:oembed:providers', $info['cache table']);
+}
+
+/**
+ * Fetch data for an embeddable URL.
+ *
+ * @param string $url
+ *   An external URL for the content to embed.
+ * @param array $parameters
+ *   An associative array of request parameters, with the following keys:
+ *   - 'maxwidth'
+ *       The maximum width of the embed, in pixels.
+ *   - 'maxheight'
+ *       The maximum height of the embed, in pixels.
+ *   Other keys may be supported by some providers (twitter, youtube, wordpress).
+ * @return
+ *   False or an object representing the embeddable data of the URL.
+ */
+function oembed_get_data($url, $parameters = array()) {
+  $matches = array();
+  $parameters = array_filter($parameters);
+  if ($plugin = oembed_get_provider($url, $matches)) {
+    return oembed_oembed_fetch($plugin, $url, $matches, $parameters);
+  }
+  return FALSE;
+}
+
+/**
+ * oEmbed fetcher and parser.
+ *
+ * This handles fetching from remote providers and local registered callbacks.
+ * It does not cache the responses because they are cached when rendered.
+ */
+function oembed_oembed_fetch($plugin, $url, $matches, $parameters = array()) {
+  $embed = FALSE;
+
+  // Normalize the parameters and attributes for better cache performance.
+  ksort($parameters);
+  $parameters = array_filter($parameters);
+
+  if ($plugin['cache']) {
+    $cache_keys = array();
+
+    // Remove trailing slash to normalize URLs.
+    $cache_keys[] = hash('sha256', substr($url, -1) == '/' ? substr($url, 0, -1) : $url);
+
+    // Hash and serialize request parameters and display options.
+    if (!empty($parameters)) {
+      $cache_keys[] = hash('sha256', serialize($parameters));
+    }
+
+    $cache_key = implode(':', $cache_keys);
+    $cache = cache_get($cache_key, 'cache_oembed');
+
+    // Cache hit.
+    if ($cache && isset($cache->data)) {
+      return $cache->data;
+    }
+  }
+
+  // Cache miss.
+  drupal_alter('oembed_request', $parameters, $plugin, $url);
+
+  // Drupal oEmbed provider uses function callbacks for internal requests.
+  $function = ctools_plugin_get_function($plugin, 'callback');
+  if ($function) {
+    $embed = call_user_func($function, $plugin, $url, $matches, $parameters);
+  }
+
+  // Decorate the oEmbed response object with additional properties that are
+  // handy when theming the output.
+  if ($embed) {
+    $embed['original_url'] = $url;
+    $embed['provider'] = $plugin['name'];
+    drupal_alter('oembed_response', $embed);
+  }
+
+  if ($plugin['cache']) {
+
+    // If expire is not set, use default value and adjust for request time.
+    $lifetime = variable_get('oembed_cache_lifetime', 3600);
+
+    // Recalculate cache expire time based on response.
+    if ($embed && $lifetime != CACHE_PERMANENT && isset($embed['cache_age'])) {
+      $lifetime = max($lifetime, intval($embed['cache_age']));
+    }
+    else if (!$embed && $lifetime == CACHE_PERMANENT) {
+      $lifetime = 3600;
+    }
+
+    if ($embed && $lifetime == CACHE_PERMANENT) {
+      $expire = $lifetime;
+    }
+    else {
+      $expire = min($lifetime + REQUEST_TIME, 2147483647);
+    }
+
+    // Twitter returns an unreasonably high cache_age of 31536000000 seconds,
+    // which is longer than the expire column in Drupal cache table supports.
+    cache_set($cache_key, $embed, 'cache_oembed', $expire);
+  }
+
+  return $embed;
+}
+
+/**
+ * Implements hook_element_info().
+ */
+function oembed_element_info() {
+
+  // Standard oEmbed that changes its theme based on response.
+  $types['oembed'] = array(
+    '#theme' => 'oembed',
+    '#embed' => NULL,
+    '#parameters' => array(),
+    '#attributes' => array(),
+    '#pre_render' => array(
+      'oembed_pre_render_fetch',
+      'oembed_pre_render_retheme',
+    ),
+  );
+
+  // Retrieves an image (photo or thumbnail) or nothing.
+  $types['oembed_thumbnail'] = array(
+    '#theme' => 'image',
+    '#path' => NULL,
+    '#width' => NULL,
+    '#height' => NULL,
+    '#alt' => '',
+    '#title' => NULL,
+    '#attributes' => array(),
+
+    '#embed' => NULL,
+    '#parameters' => array(),
+    '#pre_render' => array(
+      'oembed_pre_render_fetch',
+      'oembed_pre_render_thumbnail',
+    ),
+  );
+
+  return $types;
+}
+
+/**
+ * Change oEmbed request into a thumbnail.
+ */
+function oembed_pre_render_thumbnail($element) {
+
+  // Only act when the oEmbed response is true.
+  if (!empty($element['#printed'])) {
+    return $element;
+  }
+
+  $embed = $element['#embed'];
+
+  // Check if the oEmbed response provides a thumbnail image.
+  if (empty($embed['thumbnail_url'])) {
+    $element['#printed'] = TRUE;
+    return $element;
+  }
+
+  oembed_pre_render_image_helper($element, 'thumbnail_');
+
+  return $element;
+}
+
+/**
+ * Set the properties for a themed image.
+ *
+ * This function takes the element by reference because it should never be called as a
+ * pre render function despite appearances.
+ */
+function oembed_pre_render_image_helper(&$element, $prefix = '') {
+  $embed = $element['#embed'];
+
+  $element['#path'] = $embed[$prefix .'url'];
+  $element['#alt'] = oembed_alt_attr($embed);
+  $element['#title'] = $embed['title'];
+  $element['#attributes'] = $element['#attributes'];
+  $element['#height'] = isset($embed[$prefix .'height']) ? $embed[$prefix .'height'] : NULL;
+  $element['#width'] = isset($embed[$prefix .'width']) ? $embed[$prefix .'width'] : NULL;
+
+  // theme_image() prefers width, height, alt and title element properties over
+  // attributes so we manually override them if an associated attribute is set.
+  foreach (array('width', 'height', 'alt', 'title') as $key) {
+    if (isset($element['#attributes'][$key])) {
+      $element['#' . $key] = $element['#attributes'][$key];
+    }
+  }
+}
+
+/**
+ * Rewrite the theme parameter based on the response.
+ */
+function oembed_pre_render_retheme($element) {
+
+  // Only act when the oEmbed response is true.
+  if (!empty($element['#printed'])) {
+    return $element;
+  }
+
+  $embed = $element['#embed'];
+  $element['#theme'] = 'oembed__'. $embed['type'] .'__'. implode('__', explode(':', $embed['provider'], 2));
+  return $element;
+}
+
+/**
+ * Pre render fetches the oEmbed data.
+ */
+function oembed_pre_render_fetch($element) {
+  $embed = oembed_get_data($element['#url'], $element['#parameters']);
+
+  // Prevent rendering if the response is bad.
+  if (!$embed) {
+    $element['#printed'] = TRUE;
+    return $element;
+  }
+
+  $element['#embed'] = $embed;
+
+  return $element;
+}
+
+/**
+ * Prepare an element based on a oEmbed request.
+ *
+ * @param $type
+ *   Element type.
+ * @param $url
+ *   URL to embed.
+ * @param $parameters
+ *   oEmbed request parameters.
+ *
+ * @return
+ *   A renderable array with the following keys and values:
+ *   - #type: The passed-in element $type.
+ *   - #url: The passed-in $url.
+ *   - #parameters: The passed-in $parameters.
+ */
+function oembed_render_element($type, $url, $parameters = array()) {
+
+  return array(
+    '#type' => $type,
+    '#url' => $url,
+    '#parameters' => $parameters,
+  );
+}
+
+/**
+ * Generate a string for use as ALT attribute.
+ */
+function oembed_alt_attr($embed) {
+  $options = array('@type' => $embed['type']);
+
+  // alt attribute using hopefully available title and provider name.
+  if (isset($embed['title'])) {
+    $string = '@title';
+    $options['@title'] = $embed['title'];
+  } else {
+    $string = 'Embedded @type';
+  }
+  if (isset($embed['provider_name'])) {
+    $string .= ' on @provider_name';
+    $options['@provider_name'] = $embed['provider_name'];
+  }
+
+  return t($string, $options);
+}
+
+/**
+ * Implement hook_ctools_plugin_directory().
+ */
+function oembed_ctools_plugin_directory($module, $plugin) {
+  if ($module == 'ctools' && $plugin == 'export_ui') {
+    return 'plugins/' . $plugin;
+  }
+  if ($module == 'oembed' && $plugin == 'providers') {
+    return 'plugins/' . $plugin;
+  }
+}
+
+/**
+ * Implements hook_ctools_plugin_api().
+ */
+function oembed_ctools_plugin_api($module, $api) {
+  if ($module == 'oembed' && $api == 'oembed_provider') {
+    return array('version' => 1);
+  }
+  if ($module == 'file_entity' && $api == 'file_type') {
+    return array('version' => 1);
+  }
+  if ($module == 'file_entity' && $api == 'file_default_displays') {
+    return array('version' => 1);
+  }
+}
+
+/**
+ * Implements hook_ctools_plugin_type().
+ */
+function oembed_ctools_plugin_type() {
+  $plugins['providers'] = array(
+    'cache' => TRUE,
+    'child plugins' => TRUE,
+    'process' => array(
+      'file' => 'oembed.oembed.inc',
+      'path' => drupal_get_path('module', 'oembed'),
+      'function' => 'oembed_provider_process',
+    ),
+    'defaults' => array(
+      'capture subpatterns' => FALSE,
+      'cache' => TRUE,
+      'consumer' => FALSE,
+      'provider' => FALSE,
+    ),
+  );
+
+  return $plugins;
+}
+
+/**
+ * Implement hook_preprocess_file_entity().
+ */
+function oembed_preprocess_file_entity(&$vars, $hook) {
+  if (isset($vars['file']->metadata['oembed'])) {
+    $vars['oembed_response'] = $embed = $vars['file']->metadata['oembed'];
+    $vars['classes_array'][] = 'oembed-'. $embed['type'];
+    if (strpos($embed['provider'], ':')) {
+      list($parent, $child) = explode(':', $embed['provider'], 2);
+      $vars['classes_array'][] = 'oembed-'. $parent;
+      $vars['classes_array'][] = 'oembed-'. $child;
+    }
+    else {
+      $vars['classes_array'][] = 'oembed-'. $embed['provider'];
+    }
+    $vars['title_attributes_array']['class'][] = 'oembed-title';
+
+    // This conflicts with default file_entity.tpl.php which hardcodes a class attribute.
+    $vars['content_attributes_array']['class'][] = 'oembed-content';
+  }
+}
+
+/**
+ *  Create stream wrapper for oEmbed videos.
+ */
+function oembed_stream_wrappers() {
+  return array(
+    'oembed' => array(
+      'name' => t('oEmbed resources'),
+      'class' => 'OEmbedStreamWrapper',
+      'description' => t('Resources provided by oEmbed.'),
+      'type' => STREAM_WRAPPERS_READ_VISIBLE,
+    ),
+  );
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_view().
+ */
+function oembed_file_formatter_view($file, $display, $langcode) {
+  $scheme = file_uri_scheme($file->uri);
+  if ($scheme == 'oembed') {
+    $wrapper = file_stream_wrapper_get_instance_by_uri($file->uri);
+
+    // Build render attributes array. Prefer file-specific overrides to display settings.
+    $attributes = (isset($file->override) ? $file->override : array()) + $display['settings'];
+    unset($attributes['attributes']);
+    unset($attributes['wmode']);
+
+    $parameters = array();
+    if (!empty($display['settings']['wmode'])) {
+      $parameters['mode'] = $display['settings']['wmode'];
+    }
+
+    // The oEmbed spec defines `maxwidth` and `maxheight` parameters, but some providers
+    // support `width` and `height`. Precise dimensions supercede maximums.
+    if ($file->type != 'image' && $display['type'] != 'oembed_thumbnail') {
+      if (isset($attributes['width'])) {
+        $parameters['maxwidth'] = $parameters['width'] = $attributes['width'];
+      }
+      if (isset($attributes['height'])) {
+        $parameters['maxheight'] = $parameters['height'] = $attributes['height'];
+      }
+    }
+
+    $element = oembed_render_element($display['type'], $wrapper->getExternalUrl(), $parameters);
+    $element['#attributes'] = $attributes;
+
+    // Unfortunately, it's necessary to validate the oEmbed response before rendering
+    // so that file_view_file() can continue to the next formatter.
+    $output = drupal_render($element);
+
+    if ($output) {
+      return show($element);
+    }
+  }
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_view().
+ */
+function oembed_remote_file_formatter_view($file, $display, $langcode) {
+  $scheme = file_uri_scheme($file->uri);
+  if ($scheme == 'oembed') {
+
+    // URI of local copy of remote file must be stored because it may be
+    // different from the oEmbed URLs. If the URL does not have a valid
+    // extension, it will redirect to a URL that does.
+    if (!isset($file->metadata['oembed_remote_file_image']) || !file_exists($file->metadata['oembed_remote_file_image'])) {
+      $embed = $file->metadata['oembed'];
+      if ($embed['type'] == 'photo' && !empty($embed['url'])) {
+        $url = $embed['url'];
+      }
+      else if (isset($embed['thumbnail_url'])) {
+        $url = $embed['thumbnail_url'];
+      }
+
+      if (isset($url)) {
+        $result = drupal_http_request($url);
+
+        // Using the redirect URL's basename might guarantee a path with an
+        // appropriate file extension.
+        if (isset($result->redirect_url)) {
+
+          // If the redirect and original basenames are identical, do nothing.
+          if (drupal_basename($result->redirect_url) != drupal_basename($url)) {
+            $url .= '/'. drupal_basename($result->redirect_url);
+          }
+        }
+        $parsed_url = parse_url($url);
+
+        // Store local copies of images using hostname, path and filename of source.
+        $path = $parsed_url['host'];
+        $path .= drupal_dirname($parsed_url['path']);
+        if (substr($path, -1) != '/') {
+          $path .= '/';
+        }
+
+        $filename = drupal_basename($parsed_url['path']);
+        if (strpos($filename, '.') !== FALSE) {
+          $filename = file_munge_filename($filename, 'jpg jpeg gif png', FALSE);
+        }
+
+        $path .= $filename;
+        $local_uri = file_stream_wrapper_uri_normalize(file_default_scheme() . '://oembed/'. $path);
+
+        if (!file_exists($local_uri)) {
+
+          // Drupal dislikes protocol relative URL schemes. Everything should
+          // be accessible wihtout HTTPS.
+          if (strpos($url, '//') === 0) {
+            $url = 'http:'. $url;
+          }
+
+          /// Ensure filesystem has directories for new file.
+          $dirname = drupal_dirname($local_uri);
+          file_prepare_directory($dirname, FILE_CREATE_DIRECTORY | FILE_MODIFY_PERMISSIONS);
+
+          // Save the file data to the local directory.
+          file_unmanaged_save_data($result->data, $local_uri);
+        }
+
+        //
+        $file->metadata['oembed_remote_file_image'] = $local_uri;
+
+        // Redundantish. See file_entity_file_insert and related hooks.
+        foreach (array('oembed_remote_file_image') as $name) {
+          if (!empty($file->metadata[$name])) {
+            $value = $file->metadata[$name];
+            db_merge('file_metadata')
+              ->fields(array(
+                'value' => serialize($value),
+              ))
+              ->key(array(
+                'fid' => $file->fid,
+                'name' => $name,
+              ))
+              ->execute();
+          }
+        }
+      }
+    }
+
+    if (isset($file->metadata['oembed_remote_file_image'])) {
+      $local_uri = $file->metadata['oembed_remote_file_image'];
+
+      $image_file = file_uri_to_object($local_uri);
+      $image_file->metadata = array();
+
+      // Forcing the image file's type is perhaps no longer necessary.
+      if (!isset($image_file->type) || $image_file->type === FILE_TYPE_NONE) {
+        $image_file->type = 'image';
+      }
+
+      if ($image_file->filesize) {
+        $image_file->metadata = image_get_info($image_file->uri);
+        $image_file->filemime = $image_file->metadata['mime_type'];
+        return file_entity_file_formatter_file_image_view($image_file, $display, $langcode);
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_settings().
+ */
+function oembed_file_formatter_oembed_settings($form, &$form_state, $settings) {
+  $element = array();
+  $element['width'] = array(
+    '#title' => t('Width'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['width'],
+  );
+  $element['height'] = array(
+    '#title' => t('Height'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['height'],
+  );
+  $element['wmode'] = array(
+    '#title' => t('Flash window mode (wmode)'),
+    '#type' => 'select',
+    '#empty_option' => t('None (do not request a specific wmode from the provider)'),
+    '#options' => drupal_map_assoc(array('window', 'transparent', 'opaque', 'direct', 'gpu')),
+    '#description' => t('Controls layering, transparency, and playback performance of content rendered by the Flash player. For more information, view <a href="http://kb2.adobe.com/cps/127/tn_12701.html#main_Using_Window_Mode__wmode__values_">Adobe\'s documentation</a>.'),
+    '#default_value' => $settings['wmode'],
+  );
+  return $element;
+}
+
+/**
+ * Implements hook_file_formatter_FORMATTER_settings().
+ */
+function oembed_file_formatter_oembed_thumbnail_settings($form, &$form_state, $settings) {
+  $element = array();
+  $element['width'] = array(
+    '#title' => t('Width'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['width'],
+  );
+  $element['height'] = array(
+    '#title' => t('Height'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['height'],
+  );
+  return $element;
+}
+
+/**
+ * Clear the cached oEmbed content for the selected files.
+ */
+function oembed_cache_clear($fids) {
+  $fids = array_keys($fids);
+
+  $query = new EntityFieldQuery();
+  $results = $query
+    ->entityCondition('entity_type', 'file')
+    ->propertyCondition('uri', 'oembed:', 'STARTS_WITH')
+    ->propertyCondition('fid', $fids)
+    ->execute();
+
+  $files = file_load_multiple(array_keys($results['file']));
+  foreach ($files as $file) {
+    $wrapper = file_stream_wrapper_get_instance_by_uri($file->uri);
+    $url = $wrapper->getExternalUrl();
+    $cid = hash('sha256', $url);
+    cache_clear_all($cid, 'cache_oembed', TRUE);
+  }
+}
+
+/**
+ * Checks that the oEmbed response has required standard properties for its type.
+ *
+ * @param $file
+ *   A Drupal file object.
+ * @param $embed
+ *   An oEmbed response.
+ *
+ * @return
+ *   An array. If the oEmbed response is invalid, it will contain an error message.
+ */
+function oembed_file_validator_type(stdClass $file) {
+  return oembed_validate_response($file->metadata['oembed']);
+}
+
+/**
+ * Validates oEmbed responses.
+ */
+function oembed_validate_response($embed) {
+  $errors = array();
+
+  if (!$embed) {
+    $errors[] = t('Unable to fetch oEmbed data or it is not a valid URL.');
+  }
+  else if (empty($embed['version']) || empty($embed['type']) || intval($embed['version']) != 1) {
+    $errors[] = t('oEmbed data for is invalid.');
+  }
+
+  // Validate that response has required properties for its type.
+
+  $message = t('oEmbed response is missing required properties for @type.', array('@type' => $embed['type']));
+
+  // Video, rich and photo all must have width and height.
+  // This validation causes lots of legitimate responses to be rejected. To retain access
+  // to Twitter, Scribd and others, we allow responses that do not have height and width.
+  if (in_array($embed['type'], array('video', 'rich', 'photo'))) {
+    if ((!isset($embed['width']) || empty($embed['width'])) || (!isset($embed['height']) || empty($embed['height']))) {
+      //$errors[] = $message;
+    }
+  }
+
+  // Video and rich type must have html content.
+  if (in_array($embed['type'], array('video', 'rich'))) {
+    if (!isset($embed['html']) || empty($embed['html'])) {
+      $errors[] = $message;
+    }
+  }
+
+  // Image type must have a URL.
+  if ($embed['type'] == 'photo') {
+    if (!isset($embed['url']) || empty($embed['url'])) {
+      $errors[] = $message;
+    }
+  }
+
+  return $errors;
+}
+
+/**
+ * Return a file entity for a URL. Create the file if necessary.
+ *
+ * @param type $url
+ * @param type $create
+ * @return type
+ */
+function oembed_url_to_file($url, $create = FALSE) {
+  $uri = 'oembed://'. drupal_encode_path($url);
+  $file = file_uri_to_object($uri);
+  $file->metadata = array();
+  if (!isset($file->metadata['oembed'])) {
+    $file->metadata['oembed'] = oembed_get_data($url);
+  }
+  // New URLs need to be validated before being saved.
+  if ($create && !isset($file->fid)) {
+    // Save the new file.
+    file_save($file);
+  }
+  return $file;
+}
+
+/**
+ * Implements hook_system_info_alter().
+ *
+ * Media and File entity are not dependencies, but if they are available, they must
+ * be version 2.
+ */
+function oembed_system_info_alter(&$info, $file, $type) {
+  if ($type == 'module' && $file->name == 'oembed') {
+    if (module_exists('file_entity')) {
+      $info['dependencies'][] = 'file_entity (>1.99)';
+    }
+    if (module_exists('media')) {
+      $info['dependencies'][] = 'media (>1.99)';
+    }
+  }
+}
+
+/**
+ * Implements hook_field_formatter_info().
+ */
+function oembed_field_formatter_info() {
+  $formatters = array(
+    'oembed_default' => array(
+      'label' => t('OEmbed'),
+      'field types' => array('link_field'),
+      'description' => t('Embeds links if possible - otherwise just links them.'),
+      'settings' => array('maxwidth' => '', 'maxheight' => ''),
+    ),
+  );
+
+  return $formatters;
+}
+
+/**
+ * Implements hook_field_formatter_settings_form().
+ */
+function oembed_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $element = array();
+  $element['maxwidth'] = array(
+    '#title' => t('Maximum Width'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['maxwidth'],
+  );
+  $element['maxheight'] = array(
+    '#title' => t('Maximum Height'),
+    '#type' => 'textfield',
+    '#default_value' => $settings['maxheight'],
+  );
+
+  return $element;
+}
+
+/**
+ * Implements hook_field_formatter_settings_summary().
+ */
+function oembed_field_formatter_settings_summary($field, $instance, $view_mode) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $summary = '';
+
+  $summary .= t('Max Width') . ': ' . (!empty($settings['maxwidth']) ?  $settings['maxwidth'] : 'default');
+  $summary .= '<br />';
+  $summary .= t('Max Height') . ': ' . (!empty($settings['maxheight']) ?  $settings['maxheight'] : 'default');
+
+  return $summary;
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ */
+function oembed_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $element = array();
+
+  foreach ($items as $delta => $item) {
+    $parameters = array();
+    $url = url($item['url'], $item + array('external' => TRUE));
+    $parameters = $display['settings'];
+
+    $element[$delta] = oembed_render_element('oembed', $url, $parameters);
+  }
+
+  return $element;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.oembed.inc b/profiles/commons/modules/contrib/oembed/oembed.oembed.inc
new file mode 100644
index 0000000..0343f9e
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.oembed.inc
@@ -0,0 +1,82 @@
+<?php
+
+/**
+ * Implement hook_oembed_response_alter().
+ */
+function oembed_oembed_response_alter(&$response) {
+
+  // Soundcloud rich responses are audio players that should be re-cast as audio files.
+  if ($response['type'] == 'rich' && $response['provider'] == 'default:soundcloud') {
+    $response['mime_type'] = 'audio/oembed';
+
+    // Soundcloud responses also mistake the thumbnail url property name.
+    foreach ($response as $key => $value) {
+      if (strpos($key, '-')) {
+        $new_key = strtr($key, array('-' => '_'));
+        if (!isset($response[$new_key])) {
+          $response[$new_key] = $value;
+        }
+      }
+    }
+  }
+
+  // Slideshare sets thumbnail URL on the wrong property.
+  if ($response['provider'] == 'default:slideshare' && empty($response['thumbnail_url']) && !empty($response['thumbnail'])) {
+    $response['thumbnail_url'] = $response['thumbnail'];
+  }
+}
+
+function oembed_provider_process(&$plugin, $info) {
+
+  // For plugins which provide children based on the URL, a scheme callback allows a
+  // map to be used to generate a regular expression for the whole plugin and each
+  // child. Probably the plugin properties 'scheme callback' and 'scheme' are mutually
+  // exclusive.
+  $function = ctools_plugin_get_function($plugin, 'scheme callback');
+  if ($function) {
+    $schemes = array();
+    $plugin['scheme map'] = $function();
+    foreach ($plugin['scheme map'] as $id => $scheme) {
+      if (is_array($scheme)) {
+        $scheme = implode("\n", $scheme);
+      }
+      $schemes[] = $scheme;
+      $plugin['scheme map'][$id] = oembed_scheme_to_regex($scheme, $plugin['capture subpatterns']);
+    }
+    uasort($plugin['scheme map'], '_oembed_specificity_compare');
+  }
+  else if (is_array($plugin['scheme'])) {
+    $schemes = $plugin['scheme'];
+  }
+  else {
+    $schemes = array($plugin['scheme']);
+  }
+
+  if (!empty($schemes)) {
+    $plugin['scheme'] = implode("\n", $schemes);
+    $plugin['scheme'] = oembed_scheme_to_regex($plugin['scheme'], $plugin['capture subpatterns']);
+    if (empty($plugin['weight'])) {
+      $plugin['weight'] = strlen($plugin['scheme']);
+    }
+  }
+}
+
+/**
+ * Helper function that compares the length of match expressions.
+ */
+function _oembed_specificity_compare($a, $b) {
+  return strlen($a) - strlen($b);
+}
+
+/**
+ * Helper function that changes oEmbed schemes to regular expressions.
+ */
+function oembed_scheme_to_regex($scheme, $capture_subpatterns = FALSE) {
+  $patterns = array();
+  $schemes = array_filter(preg_split("/(\r\n?|\n)/", $scheme));
+  foreach ($schemes as $scheme) {
+    $patterns[] = str_replace('\*', $capture_subpatterns ? '(.*)' : '.*', preg_quote($scheme, '#'));
+  }
+
+  return '#'. implode('|', $patterns) .'#i';
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.oembed_provider.inc b/profiles/commons/modules/contrib/oembed/oembed.oembed_provider.inc
new file mode 100644
index 0000000..8c20c7c
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.oembed_provider.inc
@@ -0,0 +1,167 @@
+<?php
+
+/**
+ * @file
+ * Bulk export of oembed_provider objects generated by Bulk export module.
+ */
+
+/**
+ * Implements hook_default_oembed_provider().
+ */
+function oembed_default_oembed_provider() {
+  $providers = array();
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'flickr';
+  $provider->title = 'Flickr';
+  $provider->endpoint = 'http://www.flickr.com/services/oembed/';
+  $provider->scheme = 'http://*.flickr.com/*
+http://flickr.com/*
+http://flic.kr/*';
+  $providers['flickr'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = TRUE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'noembed';
+  $provider->title = 'Noembed';
+  $provider->endpoint = 'http://noembed.com/embed';
+  $provider->scheme = 'http://*
+https://*';
+  $providers['noembed'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'qik';
+  $provider->title = 'Qik';
+  $provider->endpoint = 'http://qik.com/api/oembed.json';
+  $provider->scheme = 'http://qik.com/video/*
+http://qik.com/*
+http://qik.ly/*';
+  $providers['qik'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'revision3';
+  $provider->title = 'Revision3';
+  $provider->endpoint = 'http://revision3.com/api/oembed/';
+  $provider->scheme = 'http://*.revision3.com/*
+http://revision3.com/*';
+  $providers['revision3'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'scribd';
+  $provider->title = 'Scribd';
+  $provider->endpoint = 'http://www.scribd.com/services/oembed';
+  $provider->scheme = 'http://scribd.com/doc/*
+http://www.scribd.com/doc/*
+http://scribd.com/mobile/documents/*
+http://www.scribd.com/mobile/documents/*';
+  $providers['scribd'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'slideshare';
+  $provider->title = 'SlideShare';
+  $provider->endpoint = 'http://www.slideshare.net/api/oembed/2';
+  $provider->scheme = 'http://www.slideshare.net/*/*
+http://www.slideshare.net/mobile/*/*
+http://slidesha.re/*';
+  $providers['slideshare'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'smugmug';
+  $provider->title = 'SmugMug';
+  $provider->endpoint = 'http://api.smugmug.com/services/oembed/';
+  $provider->scheme = 'http://*.smugmug.com/*
+http://*.smugmug.com/*#*';
+  $providers['smugmug'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'soundcloud';
+  $provider->title = 'SoundCloud';
+  $provider->endpoint = 'http://soundcloud.com/oembed';
+  $provider->scheme = 'http://soundcloud.com/*
+http://soundcloud.com/*/*
+http://soundcloud.com/*/sets/*
+http://soundcloud.com/groups/*
+http://snd.sc/*';
+  $providers['soundcloud'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'twitter';
+  $provider->title = 'Twitter';
+  $provider->endpoint = 'https://api.twitter.com/1/statuses/oembed.json';
+  $provider->scheme = 'http://twitter.com/*/status/*
+http://twitter.com/*/statuses/*
+http://www.twitter.com/*/status/*
+http://www.twitter.com/*/statuses/*
+http://mobile.twitter.com/*/status/*
+http://mobile.twitter.com/*/statuses/*
+https://twitter.com/*/status/*
+https://twitter.com/*/statuses/*
+https://www.twitter.com/*/status/*
+https://www.twitter.com/*/statuses/*
+https://mobile.twitter.com/*/status/*
+https://mobile.twitter.com/*/statuses/*';
+  $providers['twitter'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'viddler';
+  $provider->title = 'Viddler';
+  $provider->endpoint = 'http://lab.viddler.com/services/oembed/';
+  $provider->scheme = 'http://*.viddler.com/*';
+  $providers['viddler'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'vimeo';
+  $provider->title = 'Vimeo';
+  $provider->endpoint = 'http://vimeo.com/api/oembed.json';
+  $provider->scheme = 'http://www.vimeo.com/groups/*/videos/*
+http://www.vimeo.com/*
+https://www.vimeo.com/*
+http://vimeo.com/groups/*/videos/*
+http://vimeo.com/*
+https://vimeo.com/*
+http://vimeo.com/m/#/*';
+  $providers['vimeo'] = $provider;
+
+  $provider = new stdClass();
+  $provider->disabled = FALSE; /* Edit this to true to make a default provider disabled initially */
+  $provider->api_version = 1;
+  $provider->name = 'youtube';
+  $provider->title = 'YouTube';
+  $provider->endpoint = 'http://www.youtube.com/oembed';
+  $provider->scheme = 'http://*youtube.com/watch*
+http://*.youtube.com/v/*
+https://*youtube.com/watch*
+https://*.youtube.com/v/*
+http://youtu.be/*
+http://*.youtube.com/user/*
+http://*.youtube.com/*#*/*
+http://m.youtube.com/watch*
+http://m.youtube.com/index*
+http://*.youtube.com/profile*
+http://*.youtube.com/view_play_list*
+http://*.youtube.com/playlist*';
+  $providers['youtube'] = $provider;
+
+  return $providers;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed.test b/profiles/commons/modules/contrib/oembed/oembed.test
new file mode 100644
index 0000000..e76a7d7
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed.test
@@ -0,0 +1,243 @@
+<?php
+
+/**
+ * @file
+ * Tests for oembed.module.
+ */
+
+class OembedTestHelper extends DrupalWebTestCase {
+
+  protected $profile = 'minimal';
+
+  // One URL for each provider supported by the oEmbed module. The URLs predict the type
+  // of oEmbed response and the viability of a thumbnail.
+  protected $urls = array(
+    'http://www.flickr.com/photos/boris/2351723120/' => array(
+      'type' => 'photo',
+      'thumbnail' => TRUE,
+    ),
+    'http://qik.com/video/7046119' => array(
+      'type' => 'video',
+      'thumbnail' => FALSE,
+    ),
+    'http://revision3.com/hak5/hospital' => array(
+      'type' => 'video',
+      'thumbnail' => FALSE,
+    ),
+    'http://www.scribd.com/doc/3828502/Drupal' => array(
+      'type' => 'rich',
+      'thumbnail' => TRUE,
+    ),
+    'http://www.slideshare.net/eaton/drupal-deployment-presentation' => array(
+      'type' => 'rich',
+      'thumbnail' => TRUE,
+    ),
+    'http://soozphotography.smugmug.com/Events/Drupal-7-Release-Party-at/i-mnVjkZg/1/L/DSC_0555-L.jpg' => array(
+      'type' => 'photo',
+      'thumbnail' => FALSE,
+    ),
+    'http://soundcloud.com/headstart-cms/drupal' => array(
+      'type' => 'rich',
+      'thumbnail' => TRUE,
+    ),
+    'https://twitter.com/drupal/status/266208177161400320' => array(
+      'type' => 'rich',
+      'thumbnail' => FALSE,
+    ),
+    'http://www.viddler.com/v/bdce8c7' => array(
+      'type' => 'video',
+      'thumbnail' => TRUE,
+    ),
+    'https://vimeo.com/18352872' => array(
+      'type' => 'video',
+      'thumbnail' => TRUE,
+    ),
+    'http://www.youtube.com/watch?v=XgYu7-DQjDQ' => array(
+      'type' => 'video',
+      'thumbnail' => TRUE,
+    ),
+  );
+
+  function setUp() {
+    $modules = func_get_args();
+    if (isset($modules[0]) && is_array($modules[0])) {
+      $modules = $modules[0];
+    }
+    $modules[] = 'oembed';
+    parent::setUp($modules);
+  }
+
+  protected function assertRenderedElement(array $element, $xpath, array $xpath_args = array()) {
+    $original_element = $element;
+    $this->drupalSetContent(drupal_render($element));
+    $this->verbose('<pre>' .  check_plain(var_export($original_element, TRUE)) . '</pre>'
+      . '<pre>' .  check_plain(var_export($element, TRUE)) . '</pre>'
+      . '<hr />' . $this->drupalGetContent()
+    );
+
+    // @see DrupalWebTestCase::xpath()
+    $xpath = $this->buildXPathQuery($xpath, $xpath_args);
+    $element += array('#value' => NULL);
+    $type = isset($element['#type']) ? $element['#type'] : 'markup';
+    $this->assertFieldByXPath($xpath, $element['#value'], t('#type @type was properly rendered.', array(
+      '@type' => var_export($type, TRUE),
+    )));
+  }
+
+  protected function xpathArgsFromAttributes(array $attributes = array()) {
+    $args = array();
+    foreach ($attributes as $key => $value) {
+      $args[':'. $key] = $value;
+    }
+    return $args;
+  }
+
+  /**
+   * Asserts file_entity_access correctly grants or denies access.
+   */
+  function assertFileEntityAccess($ops, $file, $account) {
+    foreach ($ops as $op => $result) {
+      $msg = t("file_entity_access returns @result with operation '@op'.", array('@result' => $result ? 'true' : 'false', '@op' => $op));
+      $this->assertEqual($result, file_entity_access($op, $file, $account), $msg);
+    }
+  }
+}
+
+class OembedTestCase extends OembedTestHelper {
+  public static function getInfo() {
+    return array(
+      'name' => 'oEmbed requests',
+      'description' => 'Tests oEmbed request handling.',
+      'group' => 'oEmbed',
+    );
+  }
+
+  /**
+   * Tests that actual response type matches the expected response type.
+   */
+  function testOembedProviderUrls() {
+    foreach ($this->urls as $url => $info) {
+      foreach (array('json', 'xml') as $format) {
+        $response = oembed_get_data($url, array('format' => $format));
+        $message = t('oEmbed @format response says @url is @type', array('@url' => $url, '@type' => $info['type'], '@format' => $format));
+        $this->assertEqual($response['type'], $info['type'], $message);
+      }
+    }
+  }
+
+  /**
+   * Tests the oembed render element types.
+   */
+  function testOembedRenderElements() {
+    foreach ($this->urls as $url => $info) {
+      $element = oembed_render_element('oembed', $url);
+      $this->assertRenderedElement($element, '//*');
+
+      if (isset($info['thumbnail']) && $info['thumbnail']) {
+        $element = oembed_render_element('oembed_thumbnail', $url);
+        $this->assertRenderedElement($element, '//img');
+      }
+    }
+  }
+}
+
+class OembedFileEntityTestCase extends OembedTestHelper {
+
+  function setUp() {
+    parent::setUp(array('file_entity', 'image'));
+  }
+
+  public static function getInfo() {
+    return array(
+      'name' => 'File entity oEmbed',
+      'description' => 'Tests oEmbed + File entity integration.',
+      'group' => 'oEmbed',
+    );
+  }
+
+  /**
+   * Tests the oembed render element types.
+   */
+  function testOembedFileFormatters() {
+    foreach ($this->urls as $url => $info) {
+
+      // Every URL should render through the oEmbed formatter.
+      $file = oembed_url_to_file($url, TRUE);
+      $displays = array(
+        'oembed' => array(
+          'status' => TRUE,
+          'weight' => 1,
+          'settings' => array(),
+        ),
+      );
+      $element = file_view_file($file, $displays);
+      $this->assertRenderedElement($element, '//*');
+
+      // Only responses with thumbnails will render through the oembed_thumbnail
+      // formatter. Rendered elements are always images.
+      if (isset($info['thumbnail']) && $info['thumbnail']) {
+        $displays = array(
+          'oembed_thumbnail' => array(
+            'status' => TRUE,
+            'weight' => 1,
+            'settings' => array(),
+          ),
+        );
+        $element = file_view_file($file, $displays);
+        $this->assertRenderedElement($element, '//img');
+      }
+
+      // If a response is a photo or has a thumbnail, it should always render
+      // an image here.
+      if ($info['type'] == 'photo' || (isset($info['thumbnail']) && $info['thumbnail'])) {
+        $displays = array(
+          'oembed_thumbnail' => array(
+            'status' => TRUE,
+            'weight' => 1,
+            'settings' => array(),
+          ),
+          'oembed' => array(
+            'status' => TRUE,
+            'weight' => 2,
+            'settings' => array(),
+          ),
+        );
+        $element = file_view_file($file, $displays);
+        $this->assertRenderedElement($element, '//img');
+      }
+    }
+  }
+
+  /**
+   * Tests the oembed render element types.
+   */
+  function testOembedImageFileFormatters() {
+    foreach ($this->urls as $url => $info) {
+
+      // If a response is a photo or has a thumbnail, it should always render
+      // an image here.
+     $file = oembed_url_to_file($url, TRUE);
+     if ($info['type'] == 'photo' || (isset($info['thumbnail']) && $info['thumbnail'])) {
+        foreach (array_keys(image_styles()) as $style_name) {
+          $displays = array(
+            'oembed_image' => array(
+              'status' => TRUE,
+              'weight' => 1,
+              'settings' => array(
+                'image_style' => $style_name,
+                'alt' => '',
+                'title' => ''
+              ),
+            ),
+          );
+          $element = file_view_file($file, $displays);
+          $this->assertRenderedElement($element, '//img');
+
+          $url = image_style_url($style_name, $element['#path']);
+          $this->drupalGet($url);
+          $this->assertResponse(200, t('Image was generated at the URL.'));
+        }
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembed_legacy.inc b/profiles/commons/modules/contrib/oembed/oembed_legacy.inc
new file mode 100644
index 0000000..aeadcee
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembed_legacy.inc
@@ -0,0 +1,50 @@
+<?php
+
+/**
+ * @file
+ * Functions for the oEmbed filter
+ */
+
+function _oembed_filter_apply($text, $filter, $format, $langcode, $cache, $cache_id) {
+  global $_oembed_default_parameters;
+  $_oembed_default_parameters = array_filter(array(
+    'maxwidth' => intval($filter->settings['maxwidth']),
+    'maxheight' => intval($filter->settings['maxheight']),
+  ));
+  $text = preg_replace_callback("`(^|<p(?:\s[^>]*)*>|<li(?:\s[^>]*)*>|<br(?:\s[^>]*)*>|[ \n\r\t\(])((http://|https://|ftp://|mailto:|smb://|afp://|file://|gopher://|news://|ssl://|sslv2://|sslv3://|tls://|tcp://|udp://)([a-zA-Z0-9@:%_+*~#?&=.,/;-]*[a-zA-Z0-9@:%_+*~#&=/;-]))([.,?!]*?)(?=($|</p>|</li>|<br\s*/?>|[ \n\r\t\)]))`i", '_oembed_preg_parse', $text);
+  unset($_oembed_default_parameters);
+  return $text;
+}
+
+/**
+ * Settings callback for the oEmbed filter.
+ */
+function _oembed_filter_settings($form, &$form_state, $filter, $format, $defaults) {
+  $filter->settings += $defaults;
+
+  $settings = array();
+  $settings['maxwidth'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Maximum width of embed'),
+    '#default_value' => $filter->settings['maxwidth'],
+    '#description' => t('The maximum width of an embed, isn\'t respected by all providers'),
+  );
+  $settings['maxheight'] = array(
+    '#type' => 'textfield',
+    '#title' => t('Maximum height of embed'),
+    '#default_value' => $filter->settings['maxheight'],
+    '#description' => t('The maximum height of an embed, isn\'t respected by all providers'),
+  );
+  return $settings;
+}
+
+function _oembed_preg_parse($match) {
+  return _oembed_resolve_link($match[2], $match[1], $match[5]);
+}
+
+function _oembed_resolve_link($match, $prefix, $suffix) {
+  global $_oembed_default_parameters;
+
+  $url = decode_entities($match);
+  return $prefix . oembed_resolve_link($_oembed_default_parameters, $url) . $suffix;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.admin.inc b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.admin.inc
new file mode 100644
index 0000000..b9e0de4
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.admin.inc
@@ -0,0 +1,90 @@
+<?php
+
+/**
+ * Admin form to configure embedly provider.
+ */
+function oembedembedly_admin() {
+  $providers = oembedembedly_providers();
+  $selections = oembedembedly_default_selected();
+  $form['oembedembedly_providers'] = array(
+    '#type' => 'fieldset',
+    '#title' => 'Providers',
+    '#weight' => 1,
+    '#description' => t('Embedly directly integrates with <a href="@providers">@count content providers</a>. You can control which Embedly providers are supported on your site by enabling or disabling them individually.', array('@count' => count($providers), '@providers' => 'http://embed.ly/providers')),
+  );
+
+  $image = array('width' => 16, 'height' => 16);
+
+  foreach ($providers as $provider) {
+    $variables = array(
+      'path' => $provider->favicon,
+      'width' => 16,
+      'height' => 16,
+      'alt' => $provider->displayname,
+    );
+    $title = theme('image',  $variables) .' '. $provider->displayname;
+    $element = array(
+      '#type' => 'checkbox',
+      '#title' => $title,
+      '#description' => $provider->about,
+      '#default_value' => $selections[$provider->name],
+      '#parents' => array('oembedembedly_providers', $provider->name),
+    );
+    $form['oembedembedly_providers'][$provider->type][$provider->name] = $element;
+
+    if (!isset($types[$provider->type])) {
+      $types[$provider->type] = array(
+        '@type' => $provider->type,
+        '@count' => 0,
+        '@enabled' => 0,
+      );
+    }
+    $types[$provider->type]['@count']++;
+    if ($selections[$provider->name]) {
+      $types[$provider->type]['@enabled']++;
+    }
+  }
+
+  foreach (element_children($form['oembedembedly_providers']) as $key) {
+    $element = &$form['oembedembedly_providers'][$key];
+    $element['#type'] = 'fieldset';
+    $element['#collapsible'] = TRUE;
+    $element['#collapsed'] = TRUE;
+    $element['#title'] = t("@type (@enabled of @count enabled)", $types[$key]);
+  }
+
+  $form['oembedembedly_providers']['oembedembedly_schemes'] = array(
+    '#type'          => 'textarea',
+    '#title'         => t('Additional schemes'),
+    '#required'      => FALSE,
+    '#default_value' => variable_get('oembedembedly_schemes', ''),
+    '#description'   => t('Newline separated list of schemes like !example. To make Embedly handle all requests, add !wildcard.', array('!example' => 'http://*.revision3.com/*', '!wildcard' => '*')),
+  );
+
+  $form['oembedembedly_default'] = array(
+    '#type'          => 'radios',
+    '#title'         => t('Providers enabled by default'),
+    '#default_value' => variable_get('oembedembedly_default', TRUE),
+    '#options'       => array(
+      FALSE => t('Disabled'),
+      TRUE  => t('Enabled'),
+    ),
+    '#description'   => t('This option defines whether providers should be enabled by default or not.'),
+  );
+  $form['oembedembedly_api_key'] = array(
+    '#type'          => 'textfield',
+    '#title'         => t('Embedly API Key'),
+    '#default_value' => variable_get('oembedembedly_api_key', NULL),
+    '#description'   => t('Embedly requires developers to authenticate their requests to all endpoints. You must <a href="@pricing">sign up for any of the plans</a> to receive a key.', array('@pricing' => 'http://embed.ly/pricing')),
+  );
+
+  $form['#submit'][] = 'oembedembedly_admin_submit';
+  return system_settings_form($form);
+}
+
+/**
+ * Submit handler clears cache to refresh providers.
+ */
+function oembedembedly_admin_submit($form, &$form_state) {
+  oembed_providers_reset();
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info
new file mode 100644
index 0000000..fc7ddea
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info
@@ -0,0 +1,13 @@
+package = oEmbed
+name = oEmbed Embed.ly
+description = Provides definitions for all of Embed.ly:s providers
+core = 7.x
+dependencies[] = oembed
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.module b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.module
new file mode 100644
index 0000000..ba00d9d
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.module
@@ -0,0 +1,77 @@
+<?php
+
+/**
+ * @file
+ * Embed.ly support for oEmbed.module
+ */
+
+/**
+ * Implements hook_menu().
+ */
+function oembedembedly_menu() {
+  $items = array();
+
+  $items['admin/config/media/oembed/provider/embedly'] = array(
+    'title'            => 'Embed.ly',
+    'description'      => 'Settings for the Embed.ly provider.',
+    'page callback'    => 'drupal_get_form',
+    'page arguments'   => array('oembedembedly_admin'),
+    'file'             => 'oembedembedly.admin.inc',
+    'type'             => MENU_LOCAL_TASK,
+    'access arguments' => array('administer oembed'),
+  );
+
+  return $items;
+}
+
+/**
+ * Calls and caches embed.ly services api.
+ */
+function oembedembedly_providers() {
+
+  $cache = cache_get('oembedly');
+
+  if ($cache && isset($cache->data)) {
+    $providers = $cache->data;
+  }
+  else {
+    $response = drupal_http_request('http://api.embed.ly/1/services');
+
+    if ($response->code == 200) {
+      $json = json_decode($response->data);
+      $providers = array();
+      foreach ($json as $provider) {
+        $providers[$provider->name] = $provider;
+      }
+    }
+    else {
+      $providers = FALSE;
+    }
+
+    cache_set('oembedly', $providers, 'cache', REQUEST_TIME + 3600 * ($providers ? 24 : 6));
+
+    if (variable_get('oembedembedly_default', TRUE)) {
+      oembed_providers_reset();
+    }
+  }
+  return $providers;
+}
+
+/**
+ * Helper function to populate defaults for all providers.
+ */
+function oembedembedly_default_selected() {
+  $providers = oembedembedly_providers();
+  $default = variable_get('oembedembedly_default', TRUE);
+  $defaults = array_combine(array_keys($providers), array_fill(0, count($providers), $default));
+  return array_merge($defaults, variable_get('oembedembedly_providers', array()));
+}
+
+/**
+ * Implement hook_ctools_plugin_directory().
+ */
+function oembedembedly_ctools_plugin_directory($module, $plugin) {
+  if ($module == 'oembed' && $plugin == 'providers') {
+    return 'plugins/' . $plugin;
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedembedly/plugins/providers/embedly.inc b/profiles/commons/modules/contrib/oembed/oembedembedly/plugins/providers/embedly.inc
new file mode 100644
index 0000000..5ce2615
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedembedly/plugins/providers/embedly.inc
@@ -0,0 +1,62 @@
+<?php
+
+$plugin = array(
+  'title' => 'Embed.ly',
+  'callback' => 'oembedembedly_provider_callback',
+  'get child' => 'oembedembedly_provider_get_child',
+  'scheme callback' => 'oembedembedly_embedly_provider_scheme',
+  'endpoint' => 'http://api.embed.ly/1/oembed',
+  'consumer' => TRUE,
+);
+
+function oembedembedly_embedly_provider_scheme() {
+  $json = oembedembedly_providers();
+  $schemes = array();
+  if (is_array($json)) {
+    $selections = oembedembedly_default_selected();
+    foreach ($json as $provider_name => $info) {
+      if ($selections[$provider_name]) {
+        $schemes['embedly:'. $provider_name] = $info->regex;
+      }
+    }
+  }
+  return $schemes;
+}
+
+function oembedembedly_provider_get_child($plugin, $parent, $child) {
+  $json = oembedembedly_providers();
+
+  $plugin['name'] = $parent .':'. $child;
+  $plugin['title'] = $json[$child]->displayname;
+  $plugin['description'] = $json[$child]->about;
+  $plugin['scheme'] = $json[$child]->regex;
+
+  // Force the plugin to be processed again because it will persist in the static cache
+  // of ctools_get_plugins(). Therefore, strip out the features of the child plugin
+  // that make it look like the parent.
+  unset($plugin['scheme callback']);
+  unset($plugin['scheme map']);
+  unset($plugin['weight']);
+  $info = ctools_plugin_get_info('oembed', 'providers');
+  $function = ctools_plugin_get_function($info, 'process');
+  $function($plugin, $info);
+
+  return $plugin;
+}
+
+function oembedembedly_provider_callback($plugin, $url, $matches, $parameters) {
+  $parameters['key'] = variable_get('oembedembedly_api_key', NULL);
+  $function = ctools_plugin_load_function('oembed', 'providers', 'default', 'callback');
+  $response = call_user_func($function, $plugin, $url, $matches, $parameters);
+
+  $providers = oembedembedly_providers();
+  if (is_array($providers)) {
+    list($parent, $child) = explode(':', $plugin['name'], 2);
+    if (isset($providers[$child])) {
+      if ($providers[$child]->type == 'audio') {
+        $response['mime_type'] = 'audio/oembed';
+      }
+    }
+  }
+  return $response;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.admin.inc b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.admin.inc
new file mode 100644
index 0000000..93309d2
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.admin.inc
@@ -0,0 +1,15 @@
+<?php
+
+/**
+ * @file
+ * OEmbed Endpoint admin pages.
+ */
+
+/**
+ * oEmbed admin settings page callback.
+ */
+function oembedprovider_settings() {
+  $form = array();
+
+  return system_settings_form($form);
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.inc b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.inc
new file mode 100644
index 0000000..dfa4d3e
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.inc
@@ -0,0 +1,158 @@
+<?php
+
+/**
+ * @file
+ * Functions for the oEmbed provider
+ */
+
+define('OEMBEDPROVIDER_NOT_ACCEPTABLE', 406);
+
+/**
+ * Callback handler for oembed requests.
+ */
+function _oembedprovider_handle_request() {
+
+  // Check that we got a url
+  if (!filter_has_var(INPUT_GET, 'url')) {
+    return OEMBEDPROVIDER_NOT_ACCEPTABLE;
+  }
+
+  $url = filter_input(INPUT_GET, 'url', FILTER_VALIDATE_URL, array('flags' => FILTER_FLAG_PATH_REQUIRED));
+
+  if (empty($url)) {
+    return OEMBEDPROVIDER_NOT_ACCEPTABLE;
+  }
+
+  $parameters = array();
+  $input_vars = array(
+    'maxwidth' => FILTER_VALIDATE_INT,
+    'maxheight' => FILTER_VALIDATE_INT,
+    'view_mode' => FILTER_SANITIZE_STRING,
+    'langcode' => FILTER_SANITIZE_STRING,
+  );
+  foreach ($input_vars as $key => $filter) {
+    if (filter_has_var(INPUT_GET, $key)) {
+      $parameters[$key] = filter_input(INPUT_GET, $key, $filter);
+    }
+  }
+
+  if ($plugin = oembed_get_provider($url, $matches, 'provider')) {
+    $data = oembed_oembed_fetch($plugin, $url, $matches, $parameters);
+  }
+
+  if ($data) {
+
+    // Providers might include private attributes intended only for internal requests.
+    foreach (array_keys($data) as $key) {
+      if ($key[0] === '#') {
+        unset($data[$key]);
+      }
+    }
+
+    return _oembedprovider_result($data['type'], $data);
+  }
+
+  return MENU_NOT_FOUND;
+}
+
+/**
+ * oEmbed response delivery callback.
+ */
+function oembedprovider_deliver_response($page_callback_result) {
+  // Menu status constants are integers; page content is a string or array.
+  if (is_int($page_callback_result)) {
+
+    switch ($page_callback_result) {
+      case OEMBEDPROVIDER_NOT_ACCEPTABLE:
+        drupal_add_http_header('Status', '406 Not acceptable. The url parameter is required.');
+        $page_callback_result = _oembedprovider_result('link', array(
+          'title' => t('The URL parameter is required'),
+          'error' => 1,
+        ));
+        break;
+
+      case MENU_NOT_FOUND:
+        drupal_add_http_header('Status', '404 Not found.');
+        $page_callback_result = _oembedprovider_result('rich', array(
+          'title' => t('Could not find a provider that supports this URL.'),
+          'error' => 1,
+        ));
+        break;
+    }
+  }
+
+  $format = 'json';
+  if (filter_has_var(INPUT_GET, 'format')) {
+    $format = filter_input(INPUT_GET, 'format', FILTER_SANITIZE_STRING);
+  }
+  else if (arg(2)) {
+    $format = arg(2);
+  }
+
+  $formats = oembedprovider_formats();
+  if (!isset($formats[$format])) {
+    drupal_add_http_header('Status', '501 Not implemented. Unsupported response format "'. check_plain($format) . '"');
+    die;
+  }
+
+  drupal_add_http_header('Content-Type', $formats[$format]['mime']);
+
+  print $formats[$format]['callback']($page_callback_result);
+}
+
+/**
+ * Returns all the registered response formats
+ *
+ * @return array
+ */
+function oembedprovider_formats($reset = FALSE) {
+  $formats = &drupal_static(__FUNCTION__, array());
+
+  if (!$formats) {
+    $cache_key = 'oembedprovider:formats';
+
+    if (!$reset && ($cache = cache_get($cache_key)) && isset($cache->data)) {
+      $formats = $cache->data;
+    }
+    else {
+      $formats = array(
+        'json' => array(
+          'mime' => 'application/json',
+          'callback' => 'drupal_json_encode',
+        ),
+        'jsonp' => array(
+          'mime' => 'text/javascript',
+          'callback' => '_oembedprovider_formats_jsonp',
+        ),
+        'xml' => array(
+          'mime' => 'text/xml',
+          'callback' => '_oembedprovider_formats_xml',
+        ),
+      );
+      drupal_alter('oembedprovider_formats', $formats);
+
+      cache_set($cache_key, $formats);
+    }
+  }
+
+  return $formats;
+}
+
+/**
+ * JSONP formatter
+ */
+function _oembedprovider_formats_jsonp($page_callback_result) {
+  $callback = filter_has_var(INPUT_GET, 'callback') ? filter_input(INPUT_GET, 'callback') : 'callback';
+  return sprintf('%s(%s)', $callback, drupal_json_encode($page_callback_result));
+}
+
+/**
+ * XML formatter
+ */
+function _oembedprovider_formats_xml($page_callback_result) {
+  $output = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";
+  $output .= "<oembed>\n";
+  $output .= format_xml_elements($page_callback_result);
+  $output .= "</oembed>";
+  return $output;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info
new file mode 100644
index 0000000..dd8e016
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info
@@ -0,0 +1,16 @@
+package = oEmbed
+name = oEmbed Provider
+description = Turns your site into a oEmbed provider
+core = 7.x
+dependencies[] = oembed
+files[] = oembedprovider.inc
+files[] = oembedprovider.module
+files[] = oembedprovider.test
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.module b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.module
new file mode 100644
index 0000000..0081796
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.module
@@ -0,0 +1,83 @@
+<?php
+
+/**
+ * @file
+ * Module for providing content as defined in the oEmbed specification
+ */
+
+/**
+ * Implements hook_help().
+ */
+function oembedprovider_help($path, $arg) {
+  switch ($path) {
+    case 'admin/config/media/oembed/endpoint':
+      $output = '<p>'. t('This site is an oEmbed provider with a public endpoint.') .'</p>';
+      return $output;
+  }
+}
+
+/**
+ * Implements hook_hook_info().
+ *
+ * @return string
+ */
+function oembedprovider_hook_info() {
+  $hooks['oembedprovider_formats_alter'] = array(
+    'group' => 'oembed',
+  );
+}
+
+/**
+ * Implements hook_menu().
+ */
+function oembedprovider_menu() {
+  $menu = array();
+
+  $menu['oembed/endpoint'] = array(
+    'type' => MENU_CALLBACK,
+    'file' => 'oembedprovider.inc',
+    'page callback' => '_oembedprovider_handle_request',
+    'access arguments' => array('access content'),
+    'delivery callback' => 'oembedprovider_deliver_response',
+  );
+
+  $menu['admin/config/media/oembed/endpoint'] = array(
+    'title' => 'Public endpoint',
+    'description' => 'Settings for oEmbed endpoint',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('oembedprovider_settings'),
+    'file' => 'oembedprovider.admin.inc',
+    'type' => MENU_LOCAL_TASK,
+    'access arguments' => array('administer site configuration'),
+  );
+
+  return $menu;
+}
+
+/**
+ * Implement hook_ctools_plugin_directory().
+ */
+function oembedprovider_ctools_plugin_directory($module, $plugin) {
+  if ($module == 'oembed' && $plugin == 'providers') {
+    return 'plugins/' . $plugin;
+  }
+}
+
+
+/**
+ * Merges a result with some standard values.
+ *
+ * @param string $type
+ * @param array $result
+ */
+function _oembedprovider_result($type, $props) {
+  $defaults = array(
+    'type' => $type,
+    'version' => '1.0',
+    'provider_name' => variable_get('site_name', ''),
+    'width' => 0,
+    'height' => 0,
+  );
+  $result = array_merge($defaults, $props);
+  return $result;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.test b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.test
new file mode 100644
index 0000000..bb4ad92
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.test
@@ -0,0 +1,140 @@
+<?php
+
+class OembedProviderTestCase extends OembedTestHelper {
+
+  function setUp() {
+    parent::setUp(array('file_entity', 'oembedprovider'));
+  }
+
+  public static function getInfo() {
+    return array(
+      'name' => 'oEmbed providers',
+      'description' => 'Tests oEmbed providers.',
+      'group' => 'oEmbed',
+    );
+  }
+
+  function testOembedProviders() {
+    ctools_include('plugins');
+
+    $file = current($this->drupalGetTestFiles('image'));
+    $file->uid = 1;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+    $account = drupal_anonymous_user();
+    $this->assertFileEntityAccess(array('view' => TRUE), $file, $account);
+
+    $url = url('file/'. $file->fid, array('absolute' => TRUE));
+    $plugin = ctools_get_plugins('oembed', 'providers', 'file');
+    $matches = array(1 => $file->fid);
+
+    $embed = oembed_oembed_fetch($plugin, $url, $matches);
+    $errors = oembed_validate_response($embed);
+    $this->assertTrue(empty($errors), 'oEmbed response is valid');
+
+    $output = theme('oembed__photo', array('embed' => $embed));
+    $vars = array(
+      'path' => $file->uri,
+      'alt' => oembed_alt_attr($embed),
+      'width' => $file->image_dimensions['width'],
+      'height' => $file->image_dimensions['height'],
+    );
+    $this->assertEqual($output, theme('image', $vars), t('Expected img tag was found.'));
+
+    $node = $this->drupalCreateNode();
+    $this->assertTrue(node_load($node->nid), t('Node created.'));
+    $url = url('node/'. $node->nid, array('absolute' => TRUE));
+    $plugin = ctools_get_plugins('oembed', 'providers', 'node');
+    $matches = array(1 => $node->nid);
+    $embed = oembed_oembed_fetch($plugin, $url, $matches);
+    $errors = oembed_validate_response($embed);
+    $this->assertTrue(empty($errors), 'oEmbed response is valid');
+
+    $output = theme('oembed__rich', array('embed' => $embed));
+    $node = node_load($node->nid);
+    $compare = node_view($node);
+    $this->assertEqual($output, render($compare), t('oEmbed node matches theme output.'));
+  }
+}
+
+class OembedEndpointTestCase extends OembedTestHelper {
+
+  function setUp() {
+    parent::setUp(array('file_entity', 'oembedprovider'));
+  }
+
+  public static function getInfo() {
+    return array(
+      'name' => 'oEmbed endpoint',
+      'description' => 'Tests oEmbed endpoint.',
+      'group' => 'oEmbed',
+    );
+  }
+
+  function testOembedEndpoint() {
+    $file = current($this->drupalGetTestFiles('image'));
+    $file->uid = 1;
+    $file->status = FILE_STATUS_PERMANENT;
+    file_save($file);
+
+    $node = $this->drupalCreateNode();
+    $this->assertTrue(node_load($node->nid), t('Node created.'));
+
+    foreach (array('json', 'xml') as $format) {
+      ctools_include('plugins');
+
+      $url = url('file/'. $file->fid, array('absolute' => TRUE));
+      $options = array(
+        'query' => array(
+          'url' => $url,
+          'format' => $format,
+        ),
+      );
+      $this->drupalGet('oembed/endpoint', $options);
+      if ($format == 'json') {
+        $embed = drupal_json_decode($this->drupalGetContent());
+      }
+      else if ($format == 'xml') {
+        $xml = @new SimpleXMLElement($this->drupalGetContent());
+        $embed = array();
+        foreach ($xml as $key => $value) {
+          $embed[$key] = (string) $value;
+        }
+      }
+      $errors = oembed_validate_response($embed);
+      $this->assertTrue(empty($errors), 'oEmbed response is valid');
+      $output = theme('oembed__photo', array('embed' => $embed));
+      $vars = array(
+        'path' => $file->uri,
+        'alt' => oembed_alt_attr($embed),
+        'width' => $file->image_dimensions['width'],
+        'height' => $file->image_dimensions['height'],
+      );
+      $this->assertEqual($output, theme('image', $vars), t('Expected img tag was found.'));
+
+      $url = url('node/'. $node->nid, array('absolute' => TRUE));
+      $options = array(
+        'query' => array(
+          'url' => $url,
+          'format' => $format,
+        ),
+      );
+      $this->drupalGet('oembed/endpoint', $options);
+      if ($format == 'json') {
+        $embed = drupal_json_decode($this->drupalGetContent());
+      }
+      else if ($format == 'xml') {
+        $xml = @new SimpleXMLElement($this->drupalGetContent());
+        $embed = array();
+        foreach ($xml as $key => $value) {
+          $embed[$key] = (string) $value;
+        }
+      }
+      $errors = oembed_validate_response($embed);
+      $this->assertTrue(empty($errors), 'oEmbed response is valid');
+      $output = theme('oembed__rich', array('embed' => $embed));
+      $node = node_load($node->nid);
+      $this->assertRaw($node->title, t('Node title appears in the output.'));
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/file.inc b/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/file.inc
new file mode 100644
index 0000000..9bbcdd2
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/file.inc
@@ -0,0 +1,71 @@
+<?php
+
+$plugin = array(
+  'title' => 'File',
+  'capture subpatterns' => TRUE,
+  'scheme' => url('', array('absolute' => TRUE)) . 'file/*',
+  'callback' => 'oembedprovider_file_provider',
+  'provider' => TRUE,
+);
+
+/**
+ * The default provider to handle files
+ *
+ * @param string $url
+ * @param array $matches
+ */
+function oembedprovider_file_provider($plugin, $url, $matches, $parameters) {
+  $block_endless_recursion = &drupal_static(__FUNCTION__, array());
+
+  $result = FALSE;
+
+  $fid = $matches[1];
+  $defaults = array('view_mode' => 'full', 'langcode' => NULL);
+  $parameters = array_merge($defaults, $parameters);
+
+  if (!isset($block_endless_recursion[$fid])) {
+    $block_endless_recursion[$fid] = TRUE;
+
+    $file = file_load($fid);
+    if ($file && file_entity_access('view', $file, drupal_anonymous_user())) {
+      $author = user_load($file->uid);
+      $build = file_view_file($file, $parameters['view_mode'], $parameters['langcode']);
+      $result = array(
+        'title' => $file->filename,
+        'author_name' => $author->name,
+        'author_url' => url('user/' . $author->uid, array('absolute' => TRUE)),
+        '#entity_type' => 'file',
+      );
+      list($result['#id'], $result['#vid'], $result['#bundle']) = entity_extract_ids('file', $file);
+
+      if ($file->type == 'image') {
+        if ($build['#theme'] == 'image_style') {
+          $dimensions = $file->image_dimensions;
+          image_style_transform_dimensions($build['#style_name'], $dimensions);
+          $result += array(
+            'type' => 'photo',
+            'url' => image_style_url($build['#style_name'], $build['#path']),
+          ) + $dimensions;
+        }
+        else {
+          $result += array(
+            'type' => 'photo',
+            'url' => file_create_url($file->uri),
+          ) + $file->image_dimensions;
+        }
+      }
+      else {
+        $result += array(
+          'type' => 'rich',
+          'html' => drupal_render($build),
+        );
+      }
+
+      $result = _oembedprovider_result($result['type'], $result);
+    }
+
+    unset($block_endless_recursion[$fid]);
+  }
+
+  return $result;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/node.inc b/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/node.inc
new file mode 100644
index 0000000..c1c1a74
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/plugins/providers/node.inc
@@ -0,0 +1,49 @@
+<?php
+
+$plugin = array(
+  'title' => 'Node',
+  'capture subpatterns' => TRUE,
+  'scheme' => url('', array('absolute' => TRUE)) . 'node/*',
+  'callback' => 'oembedprovider_node_provider',
+  'provider' => TRUE,
+);
+
+/**
+ * The default provider to handle nodes
+ *
+ * @param string $url
+ * @param array $matches
+ */
+function oembedprovider_node_provider($plugin, $url, $matches, $parameters) {
+  $block_endless_recursion = &drupal_static(__FUNCTION__, array());
+
+  $result = FALSE;
+
+  $nid = $matches[1];
+  $defaults = array('view_mode' => 'full', 'langcode' => NULL);
+  $parameters = array_merge($defaults, $parameters);
+
+  if (!isset($block_endless_recursion[$nid])) {
+    $block_endless_recursion[$nid] = TRUE;
+
+    $node = node_load($nid);
+    if ($node && node_access('view', $node, drupal_anonymous_user())) {
+      $author = user_load($node->uid);
+      $build = node_view($node, $parameters['view_mode'], $parameters['langcode']);
+      $result = array(
+        'type' => 'rich',
+        'html' => render($build),
+        'title' => $node->title,
+        'author_name' => $author->name,
+        'author_url' => url('user/' . $author->uid, array('absolute' => TRUE)),
+        '#entity_type' => 'node',
+      );
+      list($result['#id'], $result['#vid'], $result['#bundle']) = entity_extract_ids('node', $node);
+      $result = _oembedprovider_result($result['type'], $result);
+    }
+
+    unset($block_endless_recursion[$nid]);
+  }
+
+  return $result;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/.gitignore b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/.gitignore
new file mode 100644
index 0000000..987e2a2
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/.gitignore
@@ -0,0 +1,2 @@
+composer.lock
+vendor
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/composer.json b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/composer.json
new file mode 100644
index 0000000..24287c0
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/composer.json
@@ -0,0 +1,11 @@
+{
+    "repositories": [
+    ],
+    "require": {
+        "excelwebzone/omlex": "dev-master",
+        "embed/embed": "dev-master",
+        "fg/essence": "dev-master",
+        "alb/oembed": "dev-master",
+        "embedly/embedly-php": "dev-master"
+    }
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info
new file mode 100644
index 0000000..4a09784
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info
@@ -0,0 +1,16 @@
+name = oEmbed Provider Libraries
+dependencies[] = oembed
+description = "Developer sandbox for integration with other oEmbed libraries."
+core = 7.x
+package = oEmbed
+dependencies[] = classloader
+dependencies[] = oembed
+hidden = TRUE
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-1.0-rc2+6-dev"
+core = "7.x"
+project = "oembed"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.module b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.module
new file mode 100644
index 0000000..c389aa5
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.module
@@ -0,0 +1,21 @@
+<?php
+
+/**
+ * Implements hook_init().
+ */
+function oembedprovider_embed_init() {
+  $loader = drupal_classloader();
+  $map = require drupal_get_path('module', 'oembedprovider_embed') . '/vendor/composer/autoload_namespaces.php';
+  foreach ($map as $namespace => $path) {
+    $loader->registerNamespace(rtrim($namespace, '\\'), $path);
+  }
+}
+
+/**
+ * Implement hook_ctools_plugin_directory().
+ */
+function oembedprovider_embed_ctools_plugin_directory($module, $plugin) {
+  if ($module == 'oembed' && $plugin == 'providers') {
+    return 'plugins/' . $plugin;
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.oembed.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.oembed.inc
new file mode 100644
index 0000000..fc78b90
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.oembed.inc
@@ -0,0 +1,15 @@
+<?php
+
+/**
+ * Impements hook_oembedprovider().
+ *
+ * The provider established by this module will attempt to resolve every URL it can.
+ */
+function oembedprovider_embed_oembedprovider() {
+  return array(
+    '*' => array(
+      'name' => variable_get('oembedprovider_embed_provider', 'embed'),
+      'callback' => 'oembedprovider_embed_provider',
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/alb.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/alb.inc
new file mode 100644
index 0000000..2b1afa0
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/alb.inc
@@ -0,0 +1,18 @@
+<?php
+
+$plugin = array(
+  'title' => 'Alb',
+  'callback' => 'oembedprovider_embed_alb_callback',
+  'scheme' => '*',
+);
+
+function oembedprovider_embed_alb_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  $response = Alb\OEmbed\Simple::request($url, $parameters);
+  if ($response) {
+    $embed = $response->toArray();
+  }
+
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embed.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embed.inc
new file mode 100644
index 0000000..deaafec
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embed.inc
@@ -0,0 +1,17 @@
+<?php
+
+$plugin = array(
+  'title' => 'Embed',
+  'callback' => 'oembedprovider_embed_embed_callback',
+  'scheme' => '*',
+);
+
+function oembedprovider_embed_embed_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  $provider = Embed\Embed::create(new Embed\Url($url));
+  if ($provider->OEmbed) {
+    $embed = $provider->OEmbed->get();
+  }
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embedly2.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embedly2.inc
new file mode 100644
index 0000000..fed474d
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/embedly2.inc
@@ -0,0 +1,21 @@
+<?php
+
+$plugin = array(
+  'title' => 'Embed.ly2',
+  'callback' => 'oembedprovider_embed_embedly2_callback',
+  'scheme' => '*',
+);
+
+function oembedprovider_embed_embedly2_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  $api = new Embedly\Embedly(array('key' => variable_get('oembedembedly_api_key', NULL)));
+  $parameters['url'] = $url;
+
+  $objs = $api->oembed($parameters);
+  if ($objs) {
+    $embed = (array) array_pop($objs);
+  }
+
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/essence.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/essence.inc
new file mode 100644
index 0000000..a0e98df
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/essence.inc
@@ -0,0 +1,18 @@
+<?php
+
+$plugin = array(
+  'title' => 'Essence',
+  'callback' => 'oembedprovider_embed_essence_callback',
+  'scheme' => '*',
+);
+
+function oembedprovider_embed_essence_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  $Essence = new fg\Essence\Essence();
+  $Media = $Essence->embed($url, $parameters);
+  if ($Media) {
+    $embed = $Media->properties();
+  }
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/omlex.inc b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/omlex.inc
new file mode 100644
index 0000000..f962a84
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/plugins/providers/omlex.inc
@@ -0,0 +1,23 @@
+<?php
+
+$plugin = array(
+  'title' => 'Omlex',
+  'callback' => 'oembedprovider_embed_omlex_callback',
+  'scheme' => '*',
+);
+
+function oembedprovider_embed_omlex_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  $ombed = new Omlex\OEmbed($url);
+
+  // oEmbed response is a protected property of the object, so casting to an array is
+  // the only way. See http://www.php.net/manual/en/language.types.array.php#language.types.array.casting
+
+  $object = (array) $ombed->getObject($parameters);
+  if ($object) {
+    $embed = (array) $object["\x00*\x00object"];
+  }
+
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider.inc b/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider.inc
new file mode 100644
index 0000000..104bc87
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider.inc
@@ -0,0 +1,20 @@
+<?php
+
+$plugin = array(
+  'schema' => 'oembed_provider',
+  'access' => 'administer oembed',
+  'menu' => array(
+    'menu prefix' => 'admin/config/media/oembed/provider',
+    'menu item' => 'default',
+    'menu title' => 'Remote endpoints',
+    'menu description' => 'Add, edit and remove oembed providers from the system.',
+  ),
+  'handler' => array(
+    'class' => 'oembed_provider_ui',
+    'parent' => 'ctools_export_ui',
+  ),
+  'title singular' => t('provider'),
+  'title singular proper' => t('Provider'),
+  'title plural' => t('providers'),
+  'title plural proper' => t('Providers'),
+);
diff --git a/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider_ui.class.php b/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider_ui.class.php
new file mode 100644
index 0000000..c170643
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/plugins/export_ui/oembed_provider_ui.class.php
@@ -0,0 +1,74 @@
+<?php
+
+class oembed_provider_ui extends ctools_export_ui {
+
+  /**
+   * Provide the actual editing form.
+   */
+  function edit_form(&$form, &$form_state) {
+    parent::edit_form($form, $form_state);
+    $form['title'] = array(
+      '#type'          => 'textfield',
+      '#title'         => t('Title'),
+      '#description'   => t('A human-readable title for the provider.'),
+      '#size'          => 32,
+      '#maxlength'     => 255,
+      '#required'      => TRUE,
+      '#default_value' => $form_state['item']->title,
+    );
+
+    $form['endpoint'] = array(
+      '#type'          => 'textfield',
+      '#title'         => t('Endpoint'),
+      '#description'   => t('The endpoint where oEmbed requests are going to be sent.'),
+      '#size'          => 32,
+      '#maxlength'     => 255,
+      '#required'      => TRUE,
+      '#default_value' => $form_state['item']->endpoint,
+    );
+
+    $form['scheme'] = array(
+      '#type'          => 'textarea',
+      '#title'         => t('Schemes'),
+      '#description'   => t('Newline separated list of schemes like !example', array('!example' => 'http://*.revision3.com/*')),
+      '#required'      => TRUE,
+      '#default_value' => $form_state['item']->scheme,
+    );
+  }
+
+  /**
+   * Overrides ctools_export_ui::edit_form_submit().
+   */
+  function edit_form_submit(&$form, &$form_state) {
+    // Clear the oEmbed provider cache.
+    oembed_providers_reset();
+    return parent::edit_form_submit($form, $form_state);
+  }
+
+  /**
+   * Overrides ctools_export_ui::edit_form_import_submit().
+   */
+  function edit_form_import_submit($form, &$form_state) {
+    // Clear the oEmbed provider cache.
+    oembed_providers_reset();
+    return parent::edit_form_import_submit($form, $form_state);
+  }
+
+  /**
+   * Overrides ctools_export_ui::delete_form_submit().
+   */
+  function delete_form_submit(&$form_state) {
+    // Clear the oEmbed provider cache.
+    oembed_providers_reset();
+    return parent::delete_form_submit($form_state);
+  }
+
+  /**
+   * Overrides ctools_export_ui::set_item_state().
+   */
+  function set_item_state($state, $js, $input, $item) {
+    // Clear the oEmbed provider cache.
+    oembed_providers_reset();
+    return parent::set_item_state($state, $js, $input, $item);
+  }
+}
diff --git a/profiles/commons/modules/contrib/oembed/plugins/providers/default.inc b/profiles/commons/modules/contrib/oembed/plugins/providers/default.inc
new file mode 100644
index 0000000..be7b1a8
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/plugins/providers/default.inc
@@ -0,0 +1,99 @@
+<?php
+
+$plugin = array(
+  'title' => 'Remote endpoint',
+  'description' => 'oEmbed provider for remote endpoints',
+  'callback' => 'oembed_default_callback',
+  'get child' => 'oembed_default_provider_get_child',
+  'scheme callback' => 'oembed_default_provider_scheme',
+  'consumer' => TRUE,
+);
+
+/**
+ * Child plugins are oembed_provider objects that describe remote oEmbed endpoints.
+ */
+function oembed_default_provider_get_child($plugin, $parent, $child) {
+  ctools_include('export');
+  $provider = ctools_export_crud_load('oembed_provider', $child);
+  $plugin['title'] = $provider->title;
+  $plugin['endpoint'] = $provider->endpoint;
+  $plugin['scheme'] = $provider->scheme;
+  $plugin['name'] = $parent . ':' . $provider->name;
+
+  // Force the plugin to be processed again because it will persist in the static cache
+  // of ctools_get_plugins(). Therefore, strip out the features of the child plugin
+  // that make it look like the parent.
+  unset($plugin['scheme callback']);
+  unset($plugin['scheme map']);
+  unset($plugin['weight']);
+
+  $info = ctools_plugin_get_info('oembed', 'providers');
+  $function = ctools_plugin_get_function($info, 'process');
+  $function($plugin, $info);
+
+  return $plugin;
+}
+
+/**
+ *
+ */
+function oembed_default_provider_scheme() {
+  // oEmbed provider definitions are remote web services.
+  ctools_include('export');
+  $providers = ctools_export_load_object('oembed_provider');
+  $schemes = array();
+  foreach ($providers as $provider) {
+    if (empty($provider->disabled) && !empty($provider->scheme)) {
+      $schemes['default:'. $provider->name] = $provider->scheme;
+    }
+  }
+  return $schemes;
+}
+
+/**
+ * Default provider callback makes HTTP requests using drupal_http_request().
+ */
+function oembed_default_callback($plugin, $url, $matches, $parameters) {
+  $embed = FALSE;
+
+  // Remote oEmbed endpoint request.
+  $parameters['url'] = $url;
+  $query = http_build_query($parameters, NULL, '&');
+  $fetch_url = $plugin['endpoint'] . '?' . $query;
+
+  //TODO: Add alternative ways of fetching the content - like http client?
+  $response = drupal_http_request($fetch_url);
+  if (!isset($response->error)) {
+
+    // JSON or XML data might be returned, so be agnostic about decoding it.
+    $embed = json_decode($response->data, TRUE);
+    if (!is_array($embed)) {
+      try {
+        $xml = @new SimpleXMLElement($response->data);
+        $embed = array();
+        foreach ($xml as $key => $value) {
+          $embed[$key] = (string) $value;
+        }
+      }
+      catch (Exception $e) {
+        watchdog('oembed', 'Could not parse response from %url.', array('%url' => $fetch_url), WATCHDOG_ERROR);
+      }
+    }
+
+    if (empty($embed['version']) || empty($embed['type']) || intval($embed['version']) != 1) {
+      $embed = FALSE;
+    }
+
+    if ($embed && !isset($embed['title'])) {
+      $embed['title'] = '';
+    }
+
+    if (!$embed) {
+      watchdog('oembed', 'Response from %url not a valid oEmbed response.', array('%url' => $fetch_url), WATCHDOG_ERROR);
+    }
+  }
+  else {
+    watchdog('oembed', 'Error fetching data from %url.', array('%url' => $fetch_url), WATCHDOG_ERROR);
+  }
+  return $embed;
+}
diff --git a/profiles/commons/modules/contrib/oembed/theme/oembed.theme.inc b/profiles/commons/modules/contrib/oembed/theme/oembed.theme.inc
new file mode 100644
index 0000000..8cd209e
--- /dev/null
+++ b/profiles/commons/modules/contrib/oembed/theme/oembed.theme.inc
@@ -0,0 +1,57 @@
+<?php
+
+/**
+ * @file
+ * Theme related functions for oEmbed Core
+ */
+
+/**
+ * Theme for oEmbed output.
+ */
+function theme_oembed($vars) {
+  $embed = $vars['embed'];
+
+  $variables = array(
+    'path' => $embed['original_url'],
+
+    // oembed_alt_attr() returns output from t() and is sanitized.
+    'text' => empty($embed['title']) ? oembed_alt_attr($embed) : check_plain($embed['title']),
+    'options' => array(
+      'absolute' => TRUE,
+      'attributes' => array('class' => 'oembed-link'),
+      'html' => TRUE,
+    ),
+  );
+
+  return theme('link', $variables);
+}
+
+/**
+ * Theme for photo oEmbed output.
+ */
+function theme_oembed__photo($vars) {
+  $embed = $vars['embed'];
+  $variables = array(
+    'path' => $embed['url'],
+    'alt' => oembed_alt_attr($embed),
+    'width' => $embed['width'],
+    'height' => $embed['height'],
+  );
+  return theme('image', $variables);
+}
+
+/**
+ * Theme for rich oEmbed output.
+ */
+function theme_oembed__rich($vars) {
+  $embed = $vars['embed'];
+  return $embed['html'];
+}
+
+/**
+ * Theme for video oEmbed output.
+ */
+function theme_oembed__video($vars) {
+  $embed = $vars['embed'];
+  return $embed['html'];
+}
diff --git a/profiles/commons/modules/contrib/og/LICENSE.txt b/profiles/commons/modules/contrib/og/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/og/PATCHES.txt b/profiles/commons/modules/contrib/og/PATCHES.txt
index 9595442..dc06bd1 100644
--- a/profiles/commons/modules/contrib/og/PATCHES.txt
+++ b/profiles/commons/modules/contrib/og/PATCHES.txt
@@ -1,6 +1,5 @@
 The following patches have been applied to this project:
-- http://drupal.org/files/og-default-role-member-2005800-21.patch
+- http://drupal.org/files/issues/og-default-role-member-2005800-25.patch
 - http://drupal.org/files/og_ui-group_node_add_theme-1800208-5.patch
-- http://drupal.org/files/og-access-rebuild-exception-group-type.patch
 
 This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur.migrate.inc b/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur.migrate.inc
new file mode 100644
index 0000000..c81e78f
--- /dev/null
+++ b/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur.migrate.inc
@@ -0,0 +1,64 @@
+<?php
+
+/**
+ * @file
+ * Migrate OGUR(6.x) roles and relations to 7.x-2.x.
+ */
+
+class OgMigrateOgur extends Migration {
+
+  /**
+   * Override constructor from Migration class.
+   */
+  public function __construct() {
+    parent::__construct();
+
+    $this->description = t('Migrate OGUR content from 6 to 7.x-2.x.');
+
+    $this->dependencies[] = 'OgMigrateOgurRoles';
+    $this->dependencies[] = 'OgMigrateUser';
+
+    $this->query = db_select('d6_og_users_roles', 'ogur');
+    $this->query->join('role', 'r', 'ogur.rid = r.rid');
+    $this->query->join('og_role', 'ogr', 'r.name = ogr.name');
+
+    $this->query->fields('ogur', array('gid', 'uid'))
+      ->fields('ogr', array('rid'));
+
+    $source_key = array(
+      'gid' => array(
+        'alias' => 'ogur',
+        'type' => 'int',
+        'not null' => TRUE,
+        'description' => 'node ID of group.',
+      ),
+      'uid' => array(
+        'alias' => 'ogur',
+        'type' => 'int',
+        'not null' => TRUE,
+        'description' => 'User ID of member.',
+      ),
+      'rid' => array(
+        'alias' => 'ogr',
+        'type' => 'int',
+        'not null' => TRUE,
+        'description' => 'Role ID of role.',
+      ),
+    );
+
+    $this->map = new MigrateSQLMap($this->machineName, $source_key, MigrateDestinationTable::getKeySchema('og_users_roles'));
+    $this->source = new MigrateSourceSQL($this->query);
+    $this->destination = new MigrateDestinationTable('og_users_roles');
+
+    $field_names = array(
+      'gid',
+      'uid',
+      'rid',
+    );
+    foreach ($field_names as $field_name) {
+      $this->addFieldMapping($field_name, $field_name);
+    }
+    $this->addFieldMapping('group_type', NULL)->defaultValue('node');
+  }
+
+}
diff --git a/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur_roles.migrate.inc b/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur_roles.migrate.inc
new file mode 100644
index 0000000..33357dc
--- /dev/null
+++ b/profiles/commons/modules/contrib/og/includes/migrate/7000/og_ogur_roles.migrate.inc
@@ -0,0 +1,66 @@
+<?php
+
+/**
+ * @file
+ * Add OG related fields to group and group-content node-types.
+ */
+
+class OgMigrateOgurRoles extends MigrationBase {
+
+  /**
+   * Override constructor from Migration class.
+   */
+  public function __construct() {
+    parent::__construct();
+    $this->description = t('Create OG Roles for OGUR roles from system role table.');
+    $this->enabled = !$this->isComplete();
+    $this->dependencies[] = 'OgMigrateAddFields';
+  }
+
+  /**
+   * Check variable to see if we have already run this job.
+   *
+   * @return bool
+   *   TRUE if we have already completed.
+   */
+  public function isComplete() {
+    return !variable_get('og_7200_ogur_roles', FALSE);
+  }
+
+  /**
+   * Create group, group-audience and group description fields.
+   */
+  public function import() {
+    // We are only interested in roles actually managed by OGUR, not default.
+    $og_roles = array();
+    foreach (node_type_get_types() as $type) {
+      $og_roles[$type->type] = variable_get('og_user_roles_roles_' . $type->type);
+    }
+    $roles = array();
+    $drupal_roles = db_select('d6_og_users_roles', 'ogur')
+                      ->fields('ogur', array('rid'))
+                      ->groupBy('rid')
+                      ->orderBy('rid', 'ASC')
+                      ->execute()
+                      ->fetchCol();
+    // For each role, enumerate over all possible types and respective bundles.
+    foreach ($drupal_roles as $drupal_role) {
+      foreach (og_get_all_group_bundle() as $type => $bundle_array) {
+        foreach ($bundle_array as $bundle => $name) {
+          if ($og_roles[$bundle][$drupal_role]) {
+            $role = user_role_load($drupal_role);
+            $og_role = og_role_create($role->name, $type, 0, $bundle);
+            og_role_save($og_role);
+            $roles[$role->rid] = $og_role->rid;
+          }
+        }
+      }
+    }
+
+    // Delete the field that indicates we still need to add fields.
+    variable_del('og_7200_ogur_roles');
+
+    return MigrationBase::RESULT_COMPLETED;
+  }
+
+}
diff --git a/profiles/commons/modules/contrib/og/includes/og.field.inc b/profiles/commons/modules/contrib/og/includes/og.field.inc
index d7b4beb..e2fbe6a 100644
--- a/profiles/commons/modules/contrib/og/includes/og.field.inc
+++ b/profiles/commons/modules/contrib/og/includes/og.field.inc
@@ -125,13 +125,28 @@ function og_field_widget_form(&$form, &$form_state, $field, $instance, $langcode
         }
       }
     }
-    else {
-      // Non-admin user.
-      $mocked_instance_other_groups = $mocked_instance;
-      $mocked_instance_other_groups['field_mode'] = 'admin';
-      if ($other_groups_ids && $valid_ids = entityreference_get_selection_handler($field, $mocked_instance_other_groups, $entity_type, $dummy_entity)->validateReferencableEntities($other_groups_ids)) {
-        foreach ($valid_ids as $id) {
-          $element['#other_groups_ids'][] = array('target_id' => $id);
+    elseif ($other_groups_ids) {
+      foreach ($other_groups_ids as $id) {
+        $element['#other_groups_ids'][] = array(
+          'target_id' => $id,
+          'field_mode' => 'admin',
+        );
+      }
+
+      if (!empty($dummy_entity->{$field_name}[$langcode])) {
+        // Non-admin user.
+        $ids = array();
+        foreach ($dummy_entity->{$field_name}[$langcode] as $delta => $value) {
+          $id = $value['target_id'];
+          if (!in_array($id, $other_groups_ids)) {
+            $ids[] = $id;
+          }
+        }
+
+        // Rekey the field items.
+        $dummy_entity->{$field_name}[$langcode] = array();
+        foreach ($ids as $id) {
+          $dummy_entity->{$field_name}[$langcode][] = array('target_id' => $id);
         }
       }
     }
@@ -141,7 +156,7 @@ function og_field_widget_form(&$form, &$form_state, $field, $instance, $langcode
       // Form is "fresh" (i.e. not call from field_add_more_submit()), so
       // re-set the items-count, to show the correct amount for the mocked
       // instance.
-      $dummy_form_state['field'][$field_name][LANGUAGE_NONE]['items_count'] = !empty($dummy_entity->{$field_name}[LANGUAGE_NONE]) ? count($dummy_entity->{$field_name}[LANGUAGE_NONE]) : 0;
+      $dummy_form_state['field'][$field_name][$langcode]['items_count'] = !empty($dummy_entity->{$field_name}[$langcode]) ? count($dummy_entity->{$field_name}[$langcode]) : 0;
     }
 
     $new_element = ctools_field_invoke_field($mocked_instance, 'form', $entity_type, $dummy_entity, $form, $dummy_form_state, array('default' => TRUE));
@@ -172,6 +187,7 @@ function og_field_widget_form(&$form, &$form_state, $field, $instance, $langcode
   }
 
   $form['#after_build']['og'] = 'og_complex_widget_after_build';
+  $form['#validate'][] = 'og_validate_widgets';
 
   return $element;
 }
@@ -204,6 +220,31 @@ function _og_field_widget_replace_autocomplete_path(&$element, $field_mode) {
   }
 }
 
+
+/**
+ * Register group audience field related form errors.
+ *
+ * @param $field_name
+ *   The group audience field
+ * @param $errors
+ *   Array with errors.
+ *
+ * @return
+ *   Return the cached values.
+ *
+ * @see og_validate_widgets()
+ * @see OgBehaviorHandler::validate()
+ */
+function og_field_widget_register_errors($field_name = NULL, $errors = NULL) {
+  $cache = &drupal_static(__FUNCTION__, array());
+
+  if (!empty($field_name)) {
+    $cache[$field_name] = $errors;
+  }
+
+  return $cache;
+}
+
 /**
  * Property info alter; Change mocked field to be non-required.
  */
@@ -237,19 +278,26 @@ function og_get_mocked_instance($instance, $field_mode) {
  */
 function og_complex_widget_element_validate($element, &$form_state, $form) {
   $subform = drupal_array_get_nested_value($form_state['values'], $element['#array_parents']);
-  $ids = $element['#other_groups_ids'];
-  foreach (array('default', 'admin') as $type) {
-    if (empty($subform[$type])) {
+  $ids = array();
+  foreach (array('default', 'admin') as $field_mode) {
+    if (empty($subform[$field_mode])) {
       continue;
     }
 
-    foreach ($subform[$type] as $delta => $value) {
+    foreach ($subform[$field_mode] as $value) {
       if (!empty($value['target_id']) && is_numeric($value['target_id'])) {
-        $ids[] = array('target_id' => $value['target_id']);
+        $ids[] = array(
+          'target_id' => $value['target_id'],
+          // Add the field mode so we can later validate it in
+          // OgBehaviorHandler::validate()
+          'field_mode' => $field_mode,
+        );
       }
     }
   }
 
+  $ids = array_merge($ids, $element['#other_groups_ids']);
+
   // Set the form values by directly using drupal_array_set_nested_values(),
   // which allows us to control the element parents. In this case we cut off the
   // last element that contains the delta 0, as $ids is already keyed with
@@ -266,6 +314,26 @@ function og_complex_widget_element_validate($element, &$form_state, $form) {
 }
 
 /**
+ * Validate handler; Assert group audience fields reference valid groups.
+ *
+ * @see field_default_form_errors().
+ */
+function og_validate_widgets($form, &$form_state) {
+  if (!$errors = og_field_widget_register_errors()) {
+    return;
+  }
+
+  foreach ($errors as $field_name => $field_modes) {
+    foreach ($field_modes as $field_mode => $error_items) {
+      foreach ($error_items as $error_item) {
+        $element = $form[$field_name][LANGUAGE_NONE][0][$field_mode];
+        form_error($element, $error_item['message']);
+      }
+    }
+  }
+}
+
+/**
  * After build; Remove the "Add more" button.
  *
  * @see field_multiple_value_form()
diff --git a/profiles/commons/modules/contrib/og/includes/og.membership.inc b/profiles/commons/modules/contrib/og/includes/og.membership.inc
index 23464e5..b69edd3 100644
--- a/profiles/commons/modules/contrib/og/includes/og.membership.inc
+++ b/profiles/commons/modules/contrib/og/includes/og.membership.inc
@@ -78,6 +78,11 @@ class OgMembership extends Entity {
     og_membership_invalidate_cache();
     // Clear the group content entity field cache.
     cache_clear_all('field:'. $entity_type . ':' . $etid, 'cache_field');
+
+    // Supporting the entity cache module.
+    if (module_exists('entitycache')) {
+      cache_clear_all($etid, 'cache_entity_' . $entity_type);
+    }
   }
 
   public function delete() {
@@ -86,6 +91,11 @@ class OgMembership extends Entity {
     og_membership_invalidate_cache();
     // Clear the group content entity field cache.
     cache_clear_all('field:'. $this->entity_type . ':' . $this->etid, 'cache_field');
+
+    // Supporting the entity cache module.
+    if (module_exists('entitycache')) {
+      cache_clear_all($this->etid, 'cache_entity_' . $this->entity_type);
+    }
   }
 
   /**
diff --git a/profiles/commons/modules/contrib/og/og.info b/profiles/commons/modules/contrib/og/og.info
index 05b105c..7d89500 100644
--- a/profiles/commons/modules/contrib/og/og.info
+++ b/profiles/commons/modules/contrib/og/og.info
@@ -47,6 +47,10 @@ files[] = includes/migrate/7000/og_content.inc
 files[] = includes/migrate/7000/og_group.inc
 files[] = includes/migrate/7000/og_user.inc
 
+; Migrate OGUR data from 6.x to 7.x-2.x
+files[] = includes/migrate/7000/og_ogur_roles.migrate.inc
+files[] = includes/migrate/7000/og_ogur.migrate.inc
+
 ; Migrate from 7.x-1.x to 7.x-2.x
 files[] = includes/migrate/og.migrate.inc
 files[] = includes/migrate/7200/og_og_membership.migrate.inc
@@ -55,9 +59,9 @@ files[] = includes/migrate/7200/og_user_roles.migrate.inc
 
 
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og.install b/profiles/commons/modules/contrib/og/og.install
index a05ce75..6f2fb8b 100644
--- a/profiles/commons/modules/contrib/og/og.install
+++ b/profiles/commons/modules/contrib/og/og.install
@@ -1020,6 +1020,9 @@ function og_update_7200() {
   // See http://drupal.org/node/996236
   entity_info_cache_clear();
 
+  // Temporary variable to indicate we need to migrate OGUR data.
+  variable_set('og_7200_ogur_roles', TRUE);
+
   return t('Enable "Migrate-UI" module to continue the migration of data. Once migration is done you may disable "Migrate" module');
 }
 
diff --git a/profiles/commons/modules/contrib/og/og.module b/profiles/commons/modules/contrib/og/og.module
index 0cd5410..614fc78 100644
--- a/profiles/commons/modules/contrib/og/og.module
+++ b/profiles/commons/modules/contrib/og/og.module
@@ -529,7 +529,7 @@ function og_node_access($node, $op, $account) {
       // Set the "field mode" to default, before passing it to the
       // selection handler.
       $instance['field_mode'] = 'default';
-      if (entityreference_get_selection_handler($field, $instance)->getReferencableEntities(NULL, 'CONTAINS', 1)) {
+      if (entityreference_get_selection_handler($field, $instance)->countReferencableEntities()) {
         return NODE_ACCESS_ALLOW;
       }
 
@@ -717,19 +717,68 @@ function og_field_delete_instance($instance) {
 }
 
 /**
- * Implements hook_form_alter().
+ * Implements hook_field_attach_form().
  */
-function og_form_alter(&$form, $form_state, $form_id) {
-  if (empty($form['#entity_type']) || empty($form['#bundle'])) {
+function og_field_attach_form($entity_type, $entity, &$form, &$form_state, $langcode) {
+  list(,, $bundle) = entity_extract_ids($entity_type, $entity);
+
+  if (og_get_group_audience_fields($entity_type, $bundle)) {
+    $form['#validate'][] = 'og_form_group_reference_validate';
+  }
+
+  if ($entity_type == 'user' || !og_is_group_type($entity_type, $bundle)) {
     return;
   }
+  $form['#validate'][] = 'og_form_group_manager_validate';
+}
+
+/**
+ * Validate handler; Make sure group-only content permissions are honored.
+ *
+ * If a user does not have site-wide node permissions, throw an error if they
+ * try to post site-wide instead of within a group.
+ *
+ * Note: This function does not check group -access- just if a group has been
+ * Selected.
+ */
+function og_form_group_reference_validate($form, &$form_state) {
+  global $user;
   $entity_type = $form['#entity_type'];
+  if (empty($form_state[$entity_type])) {
+    // We are inside field settings page.
+    return;
+  }
+
+  $account = user_load($user->uid);
   $bundle = $form['#bundle'];
+  $entity = $form['#entity'];
+  list($id) = entity_extract_ids($entity_type, $entity);
 
-  if ($entity_type == 'user' || !og_is_group_type($entity_type, $bundle)) {
+  $op = empty($id) ? 'create' : 'update';
+
+  if ($entity_type == 'node') {
+    $node = empty($id) ? $bundle : $entity;
+    // We call node_node_access() directly as we just want to check the
+    // permissions using user_acces().
+    if (node_node_access($node, $op, $account)) {
+      // User has site-wide permissions to create or edit the node.
+      return;
+    }
+  }
+  elseif (entity_access($op, $entity_type, $entity, $account)) {
+    // User has site-wide permissions to create or edit the entity.
     return;
   }
-  $form['#validate'][] = 'og_form_group_manager_validate';
+
+  foreach (array_keys(og_get_group_audience_fields($entity_type, $bundle)) as $field_name) {
+    // If there is at least one group selected, return.
+    if (!empty($form_state['values'][$field_name][LANGUAGE_NONE])) {
+      return;
+    }
+  }
+
+  // No group selected, throw an error.
+  form_set_error('og', t('You must select one or more groups for this content.'));
 }
 
 /**
@@ -808,11 +857,11 @@ function og_form_group_manager_validate($form, &$form_state) {
  *   The entity from which to extract values.
  * @param $entity_type
  *   The entity type.
- * @param $gid
+ * @param $rid
  *   The default OG role ID.
  *
  * @return
- *   The corresponding overridden OG role ID, if any.
+ *   The corresponding overridden OG role ID, or default.
  */
 function og_roles_get_overridden_role($entity, $entity_type, $rid) {
   list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
@@ -820,13 +869,17 @@ function og_roles_get_overridden_role($entity, $entity_type, $rid) {
   $og_overridden_roles = og_roles($entity_type, $bundle, $id);
   // Get og default roles.
   $og_default_roles = og_roles($entity_type, $bundle, 0, FALSE, FALSE);
-  $role_name = $og_default_roles[$rid];
-  foreach ($og_overridden_roles as $overridden_rid => $overridden_role) {
-    if ($overridden_role == $role_name) {
-      $rid = $overridden_rid;
-      return $rid;
+  if(isset($og_default_roles[$rid])) {
+    $role_name = $og_default_roles[$rid];
+    foreach ($og_overridden_roles as $overridden_rid => $overridden_role) {
+      if ($overridden_role == $role_name) {
+        $rid = $overridden_rid;
+        return $rid;
+      }
     }
   }
+  //Return the default $rid if no overridden one is found.
+  return $rid;
 }
 
 /**
@@ -890,10 +943,10 @@ function og_entity_update($entity, $entity_type) {
       }
     }
   }
-  $origianl_entity = $entity->original;
+  $original_entity = $entity->original;
   $property = OG_DEFAULT_ACCESS_FIELD;
 
-  if (!empty($entity->{$property}) && $entity->{$property} != $origianl_entity->{$property}) {
+  if (!empty($entity->{$property}) && $entity->{$property} != $original_entity->{$property}) {
     if (!og_is_group_default_access($entity_type, $entity)) {
       // Override default roles.
       og_roles_override($entity_type, $bundle, $id);
@@ -2417,7 +2470,7 @@ function og_is_group_content_type($entity_type, $bundle_name) {
 }
 
 /**
- * Return all the entities that are a group.
+ * Return all entity types that have bundles that are a group type.
  *
  * @return
  *   Array keyed with the entity type machine name and the entity human readable
@@ -2976,7 +3029,7 @@ function og_role_grant($group_type, $gid, $uid, $rid) {
     return;
   }
 
-  // Get the existiong user roles.
+  // Get the existing user roles.
   $user_roles = og_get_user_roles($group_type, $gid, $uid);
   if (empty($user_roles[$rid])) {
     $role = new stdClass();
@@ -2988,6 +3041,10 @@ function og_role_grant($group_type, $gid, $uid, $rid) {
     drupal_write_record('og_users_roles', $role);
     og_invalidate_cache();
     module_invoke_all('og_role_grant', $group_type, $gid, $uid, $rid);
+
+    if (module_exists('rules'))  {
+      rules_invoke_event('og_role_grant', og_get_membership($group_type, $gid, 'user', $uid), entity_metadata_wrapper('user', $uid), $rid);
+    }
   }
 }
 
@@ -3013,6 +3070,10 @@ function og_role_revoke($group_type, $gid, $uid, $rid) {
       ->condition('gid', $gid)
       ->execute();
     module_invoke_all('og_role_revoke', $group_type, $gid, $uid, $rid);
+
+    if (module_exists('rules'))  {
+      rules_invoke_event('og_role_revoke', og_get_membership($group_type, $gid, 'user', $uid), entity_metadata_wrapper('user', $uid), $rid);
+    }
   }
 }
 
@@ -3377,7 +3438,7 @@ function og_list_permissions($type) {
  * @param $destination
  *   (optional) The destiantion after a node is created. Defaults to the
  *   destination passed in the URL if exists, otherwise back to the current
- *   page.
+ *   page. FALSE to not append any destination to node create links.
  * @param $types
  *   (optional) An array of type names. Restrict the created links to the given
  *   types.
@@ -3416,7 +3477,7 @@ function og_node_create_links($group_type, $gid, $field_name, $destination = NUL
   if ($destination) {
     $options['query']['destination'] = $destination;
   }
-  else {
+  elseif ($destination !== FALSE) {
     $options['query'] += drupal_get_destination();
   }
 
@@ -3587,6 +3648,12 @@ function og_migrate_api() {
         'bundle' => $bundle,
       );
     }
+
+    if (db_table_exists('d6_og_users_roles')) {
+      // OG user roles (OGUR) related migrations.
+      $migrations['OgMigrateOgurRoles'] = array('class_name' => 'OgMigrateOgurRoles');
+      $migrations['OgMigrateOgur'] = array('class_name' => 'OgMigrateOgur');
+    }
   }
   elseif (db_field_exists('og_membership', 'group_type') && db_table_exists('og') && !db_table_exists('d6_og')) {
     $migrations['OgMigrateMembership'] = array('class_name' => 'OgMigrateMembership');
diff --git a/profiles/commons/modules/contrib/og/og.rules.inc b/profiles/commons/modules/contrib/og/og.rules.inc
index ccfa6e3..4f95deb 100644
--- a/profiles/commons/modules/contrib/og/og.rules.inc
+++ b/profiles/commons/modules/contrib/og/og.rules.inc
@@ -41,8 +41,30 @@ function og_rules_event_info() {
     'og_user_delete' => $defaults + array(
       'label' => t('User has been removed from group'),
       'help' => t("A user has been removed from group and is no longer a group member."),
-   ),
- );
+    ),
+    'og_role_grant' => array_merge_recursive($defaults, array(
+      'label' => t('OG role granted to user'),
+      'help' => t("An OG role has been granted to this user."),
+      'variables' => array(
+        'og_rid' => array(
+          'type' => 'integer',
+          'label' => t('OG role ID'),
+          'description' => t('The id of the OG user role.'),
+        ),
+      ),
+    )),
+    'og_role_revoke' => array_merge_recursive($defaults, array(
+      'label' => t('OG role revoked from user'),
+      'help' => t("An OG role has been revoked from this user."),
+      'variables' => array(
+        'og_rid' => array(
+          'type' => 'integer',
+          'label' => t('OG role ID'),
+          'description' => t('The id of the OG user role.'),
+        ),
+      ),
+    )),
+  );
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/og/og.test b/profiles/commons/modules/contrib/og/og.test
index 026c8c4..b71f953 100644
--- a/profiles/commons/modules/contrib/og/og.test
+++ b/profiles/commons/modules/contrib/og/og.test
@@ -1260,7 +1260,7 @@ class OgMigrate7200TestCase extends UpdatePathTestCase {
 
     // Assert field name was registered in the OG membership.
     $og_membership = entity_load_single('og_membership', 1);
-    $this->assertEqual($og_membership->field_name, 'og_node', 'Field name was registered in the OG membership.');
+    $this->assertTrue($og_membership->field_name, 'Field name was registered in the OG membership.');
   }
 }
 
@@ -1869,6 +1869,228 @@ class OgNonMembersPublishingContentTestCase extends DrupalWebTestCase {
 }
 
 /**
+ * Verify that users only with OG permissions can post only inside a group
+ *
+ */
+class OgUserCanPublishGroupContentTypeOnlyInGroup extends DrupalWebTestCase {
+  public $group;
+  public $site_user;
+  public $group_user;
+  public $group_content;
+
+  public static function getInfo() {
+    return array(
+      'name' => 'User can publish group content only inside group',
+      'description' => "User with permission to create a group content only in a group can't publish outside of a group.",
+      'group' => 'Organic groups',
+    );
+  }
+
+  public function setUp() {
+    parent::setUp('og');
+
+    // Create a group content type.
+    $group = $this->drupalCreateContentType();
+    og_create_field(OG_GROUP_FIELD, 'node', $group->type);
+
+    // Create the group.
+    $settings = array(
+      'type' => $group->type,
+      OG_GROUP_FIELD . '[und][0][value]' => 1,
+      'uid' => 1,
+    );
+    $this->group = $this->drupalCreateNode($settings);
+
+    // Create the group content content type.
+    $this->group_content = $this->drupalCreateContentType();
+
+    // Attach the audience field.
+    og_create_field(OG_AUDIENCE_FIELD, 'node', $this->group_content->type);
+
+    // Add permission to the group.
+    $og_roles = og_roles('node', $group->type);
+    $rid = array_search(OG_AUTHENTICATED_ROLE, $og_roles);
+    og_role_change_permissions($rid, array(
+      'create ' . $this->group_content->type . ' content' => 1,
+      'update own ' . $this->group_content->type . ' content' => 1,
+    ));
+
+    // Creating users.
+    $this->group_user = $this->drupalCreateUser();
+    $this->site_user = $this->drupalCreateUser(array('create ' . $this->group_content->type . ' content', 'edit own ' . $this->group_content->type . ' content'));
+
+    og_group('node', $this->group->nid, array('entity' => $this->group_user));
+  }
+
+  /**
+   * Grant to a user the permission to publish a node of a group content and
+   * verify that he can't create a node of that content type outside a group.
+   */
+  public function testGroupUserCanPostGroupContentOnlyInGroup() {
+    $node_title = $this->randomName();
+    $this->drupalLogin($this->group_user);
+    $this->drupalPost('node/add', array('title' => $node_title), t('Save'));
+    $this->assertText("You must select one or more groups for this content", "The user can't publish a content outside a group");
+
+    // Check the user can publish node inside the group.
+    $edit = array(
+      'title' => $node_title,
+      'og_group_ref[und][0][default][]' => array($this->group->nid),
+    );
+    $this->drupalPost('node/add', $edit, t('Save'));
+
+    $this->assertText($this->group_content->type . " " . $node_title . " has been created.", "The user can create content inside a group.");
+
+    // Check the user can edit the node.
+    $query = new entityFieldQuery();
+    $result = $query
+      ->entityCondition('entity_type', 'node')
+      ->propertyCondition('title', $node_title)
+      ->fieldCondition(OG_AUDIENCE_FIELD, 'target_id', $this->group->nid)
+      ->execute();
+    $node_title = $this->randomName();
+
+    $edit = array(
+      'title' => $node_title,
+      'og_group_ref[und][0][default][]' => array(),
+    );
+    $this->drupalPost('node/' . reset($result['node'])->nid . '/edit', $edit, t('Save'));
+    $this->assertText("You must select one or more groups for this content", "The user can't edit a content outside a group");
+
+    $edit = array(
+      'title' => $node_title,
+      'og_group_ref[und][0][default][]' => array($this->group->nid),
+    );
+    $this->drupalPost('node/' . reset($result['node'])->nid . '/edit', $edit, t('Save'));
+    $this->assertText($this->group_content->type . " " . $node_title . " has been updated.", "The user can edit content inside a group.");
+  }
+
+  /**
+   * Verify that non-group user can post group content outside of a group.
+   */
+  public function testNonGroupUserCanPostGroupContentOutsideGroup() {
+    $this->drupalLogin($this->site_user);
+
+    // Set node access strict variable to FALSE for posting outside groups.
+    variable_set('og_node_access_strict', FALSE);
+
+    // Verify that the user can publish group content outside a group.
+    $node_title = $this->randomName();
+    $this->drupalPost('node/add', array('title' => $node_title), t('Save'));
+
+    $params = array(
+      '@type' => $this->group_content->type,
+      '@title' => $node_title,
+    );
+    $this->assertText(format_string("@type @title has been created.", $params), "The user can create content outside a group.");
+
+    // Check the user can edit the node.
+    $query = new entityFieldQuery();
+    $result = $query
+      ->entityCondition('entity_type', 'node')
+      ->propertyCondition('title', $node_title)
+      ->execute();
+
+    $node_title = $this->randomName();
+    $edit = array(
+      'title' => $node_title,
+    );
+    $this->drupalPost('node/' . reset($result['node'])->nid . '/edit', $edit, t('Save'));
+    $this->assertText($this->group_content->type . " " . $node_title . " has been updated.", "The user can edit content outside a group.");
+  }
+}
+
+/**
+ * Test for publishing content into group the user is not a member.
+ */
+class OgAutoCompleteAccessibleGroupsValidation extends DrupalWebTestCase {
+
+  var $dummy_content_type;
+
+  var $group_node_1;
+  var $group_node_2;
+
+  var $group_owner;
+  var $group_member;
+
+  public static function getInfo() {
+    return array(
+      'name' => 'Auto complete for non accessible groups',
+      'description' => "Verify the user cannot fill in the auto complete field with the name of a un-accessible group name.",
+      'group' => 'Organic groups',
+    );
+  }
+
+  function setUp() {
+    parent::setUp('og');
+
+    // Create group content.
+    $this->drupalCreateContentType(array( 'name' => 'Group content', 'type' => 'group_content'));
+    $this->drupalCreateContentType(array( 'name' => 'Group', 'type' => 'group'));
+
+    $og_field = og_fields_info(OG_AUDIENCE_FIELD);
+    $og_field['instance']['settings']['behaviors']['og_widget']['default']['widget_type'] = 'entityreference_autocomplete';
+    og_create_field(OG_AUDIENCE_FIELD, 'node', 'group_content', $og_field);
+    og_create_field(OG_GROUP_FIELD, 'node', 'group');
+
+    // Create users.
+    $this->group_owner = $this->drupalCreateUser(array('create group_content content', 'administer group'));
+    $this->group_member = $this->drupalCreateUser(array('create group_content content'));
+
+    // Create a group node.
+    $settings = array();
+    $settings['type'] = 'group';
+    $settings[OG_GROUP_FIELD][LANGUAGE_NONE][0]['value'] = TRUE;
+    $settings['uid'] = $this->group_owner->uid;
+    $this->group_node_1 = $this->drupalCreateNode($settings);
+    og_group('node', $this->group_node_1, array(
+      'entity' => $this->group_member,
+    ));
+
+    $settings = array();
+    $settings['type'] = 'group';
+    $settings[OG_GROUP_FIELD][LANGUAGE_NONE][0]['value'] = TRUE;
+    $settings['uid'] = $this->drupalCreateUser()->uid;
+    $this->group_node_2 = $this->drupalCreateNode($settings);
+  }
+
+  /**
+   * Verify that a user can't publish content into group that he isn't a member.
+   */
+  function testAuthenticatedUserCantReferenceToPrivateGroup() {
+    $this->drupalLogin($this->group_member);
+
+    // Try to publish content into group the user is not a member.
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content', 'og_group_ref[und][0][default][0][target_id]' => $this->group_node_2->title . '(' . $this->group_node_2->nid . ')'), 'Save');
+    $this->assertText('The referenced group (node: ' . $this->group_node_2->nid . ') is invalid.', 'The reference to group the user is not accessible has achieved');
+
+    // Try to publish content into group that doesn't exist.
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content', 'og_group_ref[und][0][default][0][target_id]' => 'foo (900)'), 'Save');
+    $this->assertText('The referenced group (node: 900) is invalid.', 'The reference to group the user is not accessible has achieved');
+
+    // Try to publish content into the group the user is a member of.
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content 2', 'og_group_ref[und][0][default][0][target_id]' => $this->group_node_1->title . '(' . $this->group_node_1->nid . ')'), 'Save');
+    $this->assertText('Group content New group content 2 has been created.', 'The group content created successfully');
+
+    // Testing the widgets my group and other groups.
+    $this->drupalLogin($this->group_owner);
+
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content 3', 'og_group_ref[und][0][default][0][target_id]' => $this->group_node_2->title . '(' . $this->group_node_2->nid . ')'), 'Save');
+    $this->assertText('The referenced group (node: ' . $this->group_node_2->nid . ') is invalid.', 'The reference to group the user is not accessible has achieved');
+
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content 3', 'og_group_ref[und][0][admin][0][target_id]' => $this->group_node_2->title . '(' . $this->group_node_2->nid . ')'), 'Save');
+    $this->assertText('Group content New group content 3 has been created.', 'The group content created successfully');
+
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content 3', 'og_group_ref[und][0][admin][0][target_id]' => 'foo (900)'), 'Save');
+    $this->assertText('The referenced group (node: 900) is invalid.', 'The reference to group the user is not accessible has achieved');
+
+    // Try to publish content into the group the user is a member of.
+    $this->drupalPost('node/add/group_content', array('title' => 'New group content 4', 'og_group_ref[und][0][default][0][target_id]' => $this->group_node_1->title . '(' . $this->group_node_1->nid . ')'), 'Save');
+    $this->assertText('Group content New group content 4 has been created.', 'The group content created successfully');
+  }
+}
+
+/**
  * Auto assign roles.
  */
 class OgAutoAssignRoleTestCase extends DrupalWebTestCase {
@@ -1886,7 +2108,7 @@ class OgAutoAssignRoleTestCase extends DrupalWebTestCase {
   public function setUp() {
     parent::setUp('og');
     // Create a group content type.
-    $this->drupalCreateContentType(array( 'name' => 'Group', 'type' => 'group'));
+    $this->drupalCreateContentType(array('name' => 'Group', 'type' => 'group'));
     og_create_field(OG_GROUP_FIELD, 'node', 'group');
     og_create_field(OG_DEFAULT_ACCESS_FIELD, 'node', 'group');
 
@@ -1894,66 +2116,67 @@ class OgAutoAssignRoleTestCase extends DrupalWebTestCase {
     $role = user_role_load_by_name('administrator');
     variable_set('og_group_manager_default_rids_node_group', array($role->rid));
 
-    $this->roles = db_select('og_role', 'ogr')
+    $this->defaultRoles = db_select('og_role', 'ogr')
       ->fields('ogr')
       ->execute()
       ->fetchAllAssoc('rid');
   }
 
   /**
-   * Create a new group and verify that new OG roles has been created and
+   * Create a new group and verify that OG roles have been created and
    * attached to the group owner.
+   * This test overrides role permissions to use its own for the group.
    */
-  public function testAutoAssignNewRoles() {
+  public function testAutoAssignRolesDefaultAccessGroup() {
+    $entity_type = 'node';
+    $entity_bundle = 'group';
+    $group_owner_id = 1;
+
     // Create the group.
-    $node = entity_create('node', array(
+    $node = $this->drupalCreateNode(array(
       'title' => $this->randomString(),
-      'type' => 'group',
-      'language' => LANGUAGE_NONE,
-      'uid' => 1,
-    ));
-    $wrapper = entity_metadata_Wrapper('node', $node);
+      'type' => $entity_bundle,
+      'uid' => $group_owner_id,));
+    $wrapper = entity_metadata_Wrapper($entity_type, $node);
     $wrapper->{OG_GROUP_FIELD}->set(1);
     $wrapper->{OG_DEFAULT_ACCESS_FIELD}->set(1);
     $wrapper->save();
 
     // Verify that the group received new roles.
-    $group_roles = db_select('og_users_roles', 'ogur')
-      ->fields('ogur')
-      ->condition('ogur.group_type', 'node')
-      ->condition('ogur.gid', $wrapper->getIdentifier())
-      ->condition('ogur.rid', array_keys($this->roles), 'NOT IN')
-      ->execute()
-      ->fetchAllAssoc('rid');
-
-    $this->assertTrue(!empty($group_roles), 'A new role has been automatically assigned to the group owner.');
+    $roles = og_roles($entity_type, $entity_bundle, $wrapper->getIdentifier());
+    $og_roles = og_get_user_roles($entity_type, $wrapper->getIdentifier(), $group_owner_id);
+    $array_compare = array_diff($roles, $og_roles);
+    $this->assertTrue(!array_search('administrator member', $array_compare), '(Group Roles/Permissions) Administrator role has been automatically assigned to the group owner.');
+    $this->assertTrue(!array_search('member', $array_compare), '(Group Roles/Permissions) The basic OG member role has been assigned to the group owner.');
   }
 
   /**
-   * Create a new group and verify that the basic OG roles has been assigned to
-   * the group owner.
+   * Create a new group and verify that OG roles have been created and
+   * attached to the group owner.
+   * This test uses the default role permissions.
    */
-  public function testAutoAssignCurrentRoles() {
+  public function testAutoAssignRolesNotDefaultAccessGroup() {
+    $entity_type = 'node';
+    $entity_bundle = 'group';
+    $group_owner_id = 1;
+
     // Create the group.
-    $node = entity_create('node', array(
+    $node = entity_create($entity_type, array(
       'title' => $this->randomString(),
-      'type' => 'group',
+      'type' => $entity_bundle,
       'language' => LANGUAGE_NONE,
       'uid' => 1,
     ));
-    $wrapper = entity_metadata_Wrapper('node', $node);
+    $wrapper = entity_metadata_Wrapper($entity_type, $node);
     $wrapper->{OG_GROUP_FIELD}->set(1);
     $wrapper->{OG_DEFAULT_ACCESS_FIELD}->set(0);
     $wrapper->save();
 
-    $group_roles = db_select('og_users_roles', 'ogur')
-      ->fields('ogur')
-      ->condition('ogur.group_type', 'node')
-      ->condition('ogur.gid', $wrapper->getIdentifier())
-      ->condition('ogur.rid', array_keys($this->roles), 'IN')
-      ->execute()
-      ->fetchAllAssoc('rid');
-
-    $this->assertTrue(!empty($group_roles), 'The basic OG roles has been assigned to the group owner.');
+    // Verify that the group received new roles.
+    $roles = og_roles($entity_type, $entity_bundle, $wrapper->getIdentifier());
+    $og_roles = og_get_user_roles($entity_type, $wrapper->getIdentifier(), $group_owner_id);
+    $array_compare = array_diff($roles, $og_roles);
+    $this->assertTrue(!array_search('administrator member', $array_compare), '(Default Roles/Permissions)Administrator role has been automatically assigned to the group owner.');
+    $this->assertTrue(!array_search('member', $array_compare), '(Default Roles/Permissions) The basic OG member role has been assigned to the group owner.');
   }
 }
diff --git a/profiles/commons/modules/contrib/og/og_access/og_access.info b/profiles/commons/modules/contrib/og/og_access/og_access.info
index 5407f2a..45d6f99 100644
--- a/profiles/commons/modules/contrib/og/og_access/og_access.info
+++ b/profiles/commons/modules/contrib/og/og_access/og_access.info
@@ -9,9 +9,9 @@ files[] = og_access.install
 
 ; Tests
 files[] = og_access.test
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_access/og_access.module b/profiles/commons/modules/contrib/og/og_access/og_access.module
index bdeccdd..6d7354b 100644
--- a/profiles/commons/modules/contrib/og/og_access/og_access.module
+++ b/profiles/commons/modules/contrib/og/og_access/og_access.module
@@ -234,9 +234,12 @@ function _og_access_verify_access_field_existence($node) {
   // Verify that the OG access field is attached to the group(s) content.
   $fields_names = og_get_group_audience_fields('node', $node->type);
 
+  $groups_bundles = og_get_all_group_bundle();
+
+  // Check each group audience field on this node type.
   foreach (array_keys($fields_names) as $field_name) {
+    // Get the group entity type that this field points to.
     $field_info = field_info_field($field_name);
-    $groups_bundles = og_get_all_group_bundle();
     $target_type = $field_info['settings']['target_type'];
 
     foreach (array_keys($groups_bundles[$target_type]) as $bundle) {
@@ -244,10 +247,11 @@ function _og_access_verify_access_field_existence($node) {
       // Verify that the OG access field is attached to the group bundles.
       if (empty($instances[OG_ACCESS_FIELD])) {
         $params = array(
-          '@nid' => $node->nid,
-          '@bundle' => $bundle,
+          '!nid' => $node->nid,
+          '%entity_type' => $target_type,
+          '%bundle' => $bundle,
         );
-        throw new OgException(format_string('Cannot set visibility of node ID @nid as the group of type "@bundle" does not have the "Group visibility" field attached to it.', $params));
+        throw new OgException(format_string('Cannot set visibility of node ID !nid as the %entity_type group of type %bundle does not have the "Group visibility" field attached to it.', $params));
       }
     }
   }
diff --git a/profiles/commons/modules/contrib/og/og_context/og_context.info b/profiles/commons/modules/contrib/og/og_context/og_context.info
index 8a1004c..040bf4d 100644
--- a/profiles/commons/modules/contrib/og/og_context/og_context.info
+++ b/profiles/commons/modules/contrib/og/og_context/og_context.info
@@ -12,9 +12,9 @@ files[] = includes/views/handlers/og_context_plugin_argument_default_group_conte
 ; Views access plugin
 files[] = includes/views/handlers/og_context_plugin_access_og_perm.inc
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_example/og_example.info b/profiles/commons/modules/contrib/og/og_example/og_example.info
index 7c357c6..b936136 100644
--- a/profiles/commons/modules/contrib/og/og_example/og_example.info
+++ b/profiles/commons/modules/contrib/og/og_example/og_example.info
@@ -27,9 +27,9 @@ name = "OG example"
 package = "Features"
 php = "5.2.4"
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info b/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
index cdb08e2..0cb15b6 100644
--- a/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
+++ b/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
@@ -8,9 +8,9 @@ files[] = og_field_access.module
 ; Tests
 files[] = og_field_access.test
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_register/og_register.info b/profiles/commons/modules/contrib/og/og_register/og_register.info
index 7df1631..f794463 100644
--- a/profiles/commons/modules/contrib/og/og_register/og_register.info
+++ b/profiles/commons/modules/contrib/og/og_register/og_register.info
@@ -6,9 +6,9 @@ dependencies[] = og
 core = 7.x
 files[] = og_register.module
 files[] = og_register.install
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.info b/profiles/commons/modules/contrib/og/og_ui/og_ui.info
index 3c3f445..23eb170 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.info
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.info
@@ -16,9 +16,9 @@ files[] = includes/migrate/7000/add_field.inc
 files[] = includes/migrate/7000/populate_field.inc
 files[] = includes/migrate/7000/set_roles.inc
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc b/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
index 6d2f3e8..2169d76 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
@@ -9,14 +9,16 @@
 /**
  * Subscribe the current user to a group.
  *
- * @param $node
- *   The group node entity.
- * @param $uid
- *   Optional; The user ID of the subscribing user. If empty the current user
- *   will be used.
+ * @param $entity_type
+ *   The group entity type.
+ * @param $etid
+ *   The group entity ID.
+ * @param $field_name
+ *   Optional; Group audience field name. Defaults to first best matching field.
  */
 function og_ui_subscribe($entity_type, $etid, $field_name = NULL) {
   global $user;
+
   $entity_info = entity_get_info($entity_type);
   if (!$entity_type || !$entity_info) {
     // Not a valid entity type.
diff --git a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
index 4d67801..e61cb62 100644
--- a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
+++ b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
@@ -227,4 +227,56 @@ class OgBehaviorHandler extends EntityReference_BehaviorHandler_Abstract {
       unset($data['field_revision_' . $field['field_name']]);
     }
   }
+
+  /**
+   * Implements EntityReference_BehaviorHandler_Abstract::validate().
+   *
+   * Re-build $errors array to be keyed correctly by "default" and "admin" field
+   * modes.
+   *
+   * @todo: Try to get the correct delta so we can highlight the invalid
+   * reference.
+   *
+   * @see entityreference_field_validate().
+   */
+  public function validate($entity_type, $entity, $field, $instance, $langcode, $items, &$errors) {
+    $new_errors = array();
+    $values = array('default' => array(), 'admin' => array());
+    foreach ($items as $item) {
+      $values[$item['field_mode']][] = $item['target_id'];
+    }
+
+    list(,, $bundle) = entity_extract_ids($entity_type, $entity);
+
+    $field_name = $field['field_name'];
+
+    foreach ($values as $field_mode => $ids) {
+      if (!$ids) {
+        continue;
+      }
+
+      if ($field_mode == 'admin' && !user_access('administer group')) {
+        // No need to validate the admin, as the user has no access to it.
+        continue;
+      }
+
+      $instance['field_mode'] = $field_mode;
+      $valid_ids = entityreference_get_selection_handler($field, $instance, $entity_type, $entity)->validateReferencableEntities($ids);
+
+      if ($invalid_entities = array_diff($ids, $valid_ids)) {
+        foreach ($invalid_entities as $id) {
+          $new_errors[$field_mode][] = array(
+            'error' => 'og_invalid_entity',
+            'message' => t('The referenced group (@type: @id) is invalid.', array('@type' => $field['settings']['target_type'], '@id' => $id)),
+          );
+        }
+      }
+    }
+
+    if ($new_errors) {
+      og_field_widget_register_errors($field_name, $new_errors);
+    }
+
+    $errors = array();
+  }
 }
diff --git a/profiles/commons/modules/contrib/og/tests/og_test.info b/profiles/commons/modules/contrib/og/tests/og_test.info
index 4950f3f..0a322c2 100644
--- a/profiles/commons/modules/contrib/og/tests/og_test.info
+++ b/profiles/commons/modules/contrib/og/tests/og_test.info
@@ -4,9 +4,9 @@ core = 7.x
 dependencies[] = og
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-07
-version = "7.x-2.3"
+; Information added by  packaging script on 2013-11-20
+version = "7.x-2.4"
 core = "7.x"
 project = "og"
-datestamp = "1375899483"
+datestamp = "1384971519"
 
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/README.txt b/profiles/commons/modules/contrib/panels/i18n_panels/README.txt
new file mode 100644
index 0000000..119fcdb
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/README.txt
@@ -0,0 +1,96 @@
+
+This module provides by default the ability to translate panel display and
+panel pane titles.
+Further it introduced an extension to the ctools content_types plugin.
+You can now define translatable settings which will be registered in i18n.
+Out of the box the module extends the custom content content_type to allow
+translation of the content.
+
+Attention: Currently this module needs a patched panels version.
+Please apply the patches included in this module or visit:
+Additional hooks: http://drupal.org/node/1179034#comment-5664050
+UUID support: http://drupal.org/node/1277908#comment-5667824
+
+
+
+Plugin definition extension:
+------------------------------
+
+This example shows how the content_type custom is extended:
+
+#### Default: ####
+/**
+ * Plugins are described by creating a $plugin array which will be used
+ * by the system that includes this file.
+ */
+$plugin = array(
+  'title' => t('Custom content'),
+  'no title override' => TRUE,
+  'defaults' => array('admin_title' => '', 'title' => '', 'body' => '', 'format' => filter_fallback_format(), 'substitute' => TRUE),
+  'js' => array('misc/autocomplete.js', 'misc/textarea.js', 'misc/collapse.js'),
+  // Make sure the edit form is only used for some subtypes.
+  'edit form' => '',
+  'add form' => '',
+  'edit text' => t('Edit'),
+  'all contexts' => TRUE,
+);
+
+#### Extended Configuration: ####
+/**
+ * Plugins are described by creating a $plugin array which will be used
+ * by the system that includes this file.
+ */
+$plugin = array(
+  'title' => t('Custom content'),
+  'no title override' => TRUE,
+  'defaults' => array('admin_title' => '', 'title' => '', 'body' => '', 'format' => filter_fallback_format(), 'substitute' => TRUE),
+  'js' => array('misc/autocomplete.js', 'misc/textarea.js', 'misc/collapse.js'),
+  // Make sure the edit form is only used for some subtypes.
+  'edit form' => '',
+  'add form' => '',
+  'edit text' => t('Edit'),
+  'all contexts' => TRUE,
+  'i18n_settings' = array(
+    'title',
+    'body' => array('format' => 'plain_text'),
+    'items|0|title'
+  ),
+);
+
+The new key "i18n_settings" defines an array with the settings that are
+translatable. The array contains the names of the settings, they have to be
+available in the "defaults" array of the content definition. If you need to
+define a format use the name of the setting as the array item key and as item
+another array with the detail configuration. E.g
+'i18n_settings' = array('body' => array('format' => 'plain_text'))
+
+If i18n_settings is a string it's used as callback. The expected return is an
+array equal to the one used in the fix configuration.
+You can even declare nested settings  as translatable, to do so use '|' as
+delimiter.
+E.g. 'items|0|title' is evaluated as $settings['items'][0]['title']
+
+#### Callback: ####
+/**
+ * Plugins are described by creating a $plugin array which will be used
+ * by the system that includes this file.
+ */
+$plugin = array(
+  'title' => t('Custom content'),
+  'no title override' => TRUE,
+  'defaults' => array('admin_title' => '', 'title' => '', 'body' => '', 'format' => filter_fallback_format(), 'substitute' => TRUE),
+  'js' => array('misc/autocomplete.js', 'misc/textarea.js', 'misc/collapse.js'),
+  // Make sure the edit form is only used for some subtypes.
+  'edit form' => '',
+  'add form' => '',
+  'edit text' => t('Edit'),
+  'all contexts' => TRUE,
+  'i18n_settings' => 'ctools_custom_content_type_i18n_settings',
+);
+
+function ctools_custom_content_type_i18n_settings($conf) {
+  return array(
+    'title',
+    'body' => array('format' => $conf['format']),
+  );
+}
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.i18n.inc b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.i18n.inc
new file mode 100644
index 0000000..71fdafb
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.i18n.inc
@@ -0,0 +1,50 @@
+<?php
+/**
+ * @file
+ * Internationalization (i18n) hooks
+ */
+
+/**
+ * Implements hook_i18n_object_info().
+ */
+function i18n_panels_i18n_object_info() {
+  $info['pane_configuration'] = array(
+    'title' => t('Pane Configuration'),
+    'key' => 'uuid',
+    'string translation' => array(
+      'textgroup' => 'panels',
+      'type' => 'pane_configuration',
+      'properties' => array(
+        'title' => t('Pane Title'),
+      ),
+    ),
+  );
+  $info['display_configuration'] = array(
+    'title' => t('Display Configuration'),
+    'key' => 'uuid',
+    'string translation' => array(
+      'textgroup' => 'panels',
+      'type' => 'display_configuration',
+      'properties' => array(
+        'title' => t('Display Title'),
+      ),
+    ),
+  );
+
+  return $info;
+}
+
+/**
+ * Implements hook_i18n_string_info().
+ */
+function i18n_panels_i18n_string_info() {
+  $groups['panels'] = array(
+    'title' => t('Panels'),
+    'description' => t('Translatable panels items: display and pane configuration items. E.g. Title.'),
+    // This group doesn't have strings with format.
+    'format' => FALSE,
+    // This group can list all strings.
+    'list' => FALSE,
+  );
+  return $groups;
+}
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info
new file mode 100644
index 0000000..0948e8b
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info
@@ -0,0 +1,16 @@
+name = Panels translation
+description = Supports translatable panels items.
+dependencies[] = i18n
+dependencies[] = panels
+dependencies[] = i18n_string
+dependencies[] = i18n_translation
+package = Multilingual - Internationalization
+core = 7.x
+
+
+; Information added by drush on 2013-12-20
+version = "7.x-3.x-i18n-dev"
+core = "7.x"
+project = "panels"
+datestamp = "1387568916"
+
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.install b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.install
new file mode 100644
index 0000000..ff7631b
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.install
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ * @file
+ * Internationalization (i18n) submodule: Panels translation.
+ */
+
+/**
+ * Implements hook_requirements().
+ */
+function i18n_panels_requirements($phase) {
+  $requirements = array();
+  // Check only for status report, to allow update / install.
+  if ($phase == 'runtime') {
+    // Check if the panels module runs with uuids.
+    $requirements['uuid'] = array(
+      'title' => t('Panels uuid support.'),
+      'severity' => REQUIREMENT_OK,
+      'value' => t('Available'),
+    );
+    if (!db_field_exists('panels_pane', 'uuid')) {
+      $requirements['uuid']['severity'] = REQUIREMENT_ERROR;
+      $requirements['uuid']['value'] = t('Not found. Please apply the provided patches and run the update script.');
+    }
+  }
+  return $requirements;
+}
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.module b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.module
new file mode 100644
index 0000000..8214495
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.module
@@ -0,0 +1,433 @@
+<?php
+
+/**
+ * @file
+ * Internationalization (i18n) submodule: Panels translation.
+ */
+
+/**
+ * Fetch the i18n_settings of the content type if there are any.
+ *
+ * @param stdClass $pane
+ *   The pane to deal with.
+ *
+ * @return array|false
+ *   Settings or FALSE if none are present.
+ */
+function i18n_panels_get_i18n_settings($pane) {
+  ctools_include('content');
+  $content_type = ctools_get_content_type($pane->type);
+  if (isset($content_type['i18n_settings'])) {
+    if (is_string($content_type['i18n_settings']) && function_exists($content_type['i18n_settings'])) {
+      $content_type['i18n_settings'] = $content_type['i18n_settings']($pane->configuration);
+    }
+  }
+  // Provide the override title string as translation for all panes that have
+  // this setting enabled.
+  if (isset($pane->configuration['override_title']) && $pane->configuration['override_title']) {
+    if (isset($content_type['i18n_settings']) && is_array($content_type['i18n_settings'])) {
+      $content_type['i18n_settings'][] = 'override_title_text';
+    }
+    else {
+      $content_type['i18n_settings'] = array('override_title_text');
+    }
+  }
+  return isset($content_type['i18n_settings']) ? $content_type['i18n_settings'] : FALSE;
+}
+
+/**
+ * Returns the translation object of the pane.
+ *
+ * @param stdClass $pane
+ *   The pane to deal with.
+ *
+ * @return stdClass|FALSE
+ *   Returns FALSE if no translation is necessary.
+ */
+function i18n_panels_get_i18n_translation_object($pane) {
+  $translation_object = array();
+
+  // Handle content type specific i18n settings.
+  if ($i18n_settings = i18n_panels_get_i18n_settings($pane)) {
+    // Register translatable settings.
+    foreach ($i18n_settings as $i18n_setting => $settings) {
+      if (!is_array($settings)) {
+        $i18n_setting = $settings;
+        $settings = array('format' => 'plain_text');
+      }
+      $translation_object[$i18n_setting] = NULL;
+      $key_exists = FALSE;
+      // Ensure a nested setting is "unpacked".
+      $config_value = drupal_array_get_nested_value($pane->configuration, explode('|', $i18n_setting), $key_exists);
+      // If we reached the end of the nested setting use the value as source.
+      if ($key_exists) {
+        $translation_object[$i18n_setting] = array(
+          'string' => $config_value,
+          'format' => $settings['format'],
+        );
+        $translation_object['panels_i18n_settings'][$i18n_setting] = $settings;
+      }
+    }
+  }
+
+  // Check if this pane has a custom title enabled.
+  if (!empty($pane->configuration['override_title'])) {
+    $translation_object['title']['string'] = $pane->configuration['override_title_text'];
+  }
+  if (!empty($translation_object)) {
+    return (object) $translation_object;
+  }
+  return FALSE;
+}
+
+/**
+ * Implements hook_panels_pane_insert().
+ *
+ * @param stdClass $pane
+ *   The pane to deal with.
+ */
+function i18n_panels_panels_pane_insert($pane) {
+  i18n_panels_panels_pane_update($pane);
+}
+
+/**
+ * Implements hook_panels_pane_update().
+ *
+ * @param stdClass $pane
+ *   The pane to deal with.
+ */
+function i18n_panels_panels_pane_update($pane) {
+  if ($translation_object = i18n_panels_get_i18n_translation_object($pane)) {
+    $translation_object->uuid = $pane->uuid;
+    $status = i18n_string_object_update('pane_configuration', $translation_object);
+  }
+}
+
+/**
+ * Implements hook_panels_pane_delete().
+ *
+ * @param array $pids
+ *   Array with the panel ids to delete.
+ */
+function i18n_panels_panels_pane_delete($pids) {
+  if (!empty($pids)) {
+    // Fetch the uuids from the db.
+    $uuids = db_select('panels_pane')
+      ->fields('panels_pane', array('uuid'))
+      ->condition('pid', $pids)
+      ->execute()
+      ->fetchCol();
+    foreach ($uuids as $uuid) {
+      // Create dummy pane with uuid as property.
+      $pane = (object) array('uuid' => $uuid);
+      i18n_string_object_remove('pane_configuration', $pane);
+    }
+  }
+}
+
+/**
+ * Implements hook_panels_pane_prerender().
+ *
+ * @param stdClass $pane
+ *   The pane to deal with.
+ */
+function i18n_panels_panels_pane_prerender($pane) {
+  // Check if this pane has translations.
+  if (isset($pane->uuid) && $translation_object = i18n_panels_get_i18n_translation_object($pane)) {
+    $translation_object->uuid = $pane->uuid;
+    // Send to translation.
+    $translation_object = i18n_string_object_translate('pane_configuration', $translation_object);
+    unset($translation_object->uuid, $translation_object->i18n_settings);
+    foreach ($translation_object as $i18n_setting => $translated_setting) {
+      if ($i18n_setting != 'panels_i18n_settings') {
+        if (is_array($translated_setting)) {
+          $translated_setting = $translated_setting['string'];
+        }
+        drupal_array_set_nested_value($pane->configuration, explode('|', $i18n_setting), $translated_setting);
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_panels_display_save().
+ *
+ * @param panels_display $display
+ *   The display to deal with.
+ */
+function i18n_panels_panels_display_save($display) {
+  $status = i18n_string_object_update('display_configuration', $display);
+}
+
+/**
+ * Implements hook_panels_display_delete().
+ *
+ * @param int $did
+ *   Id of the display to delete.
+ */
+function i18n_panels_panels_delete_display($did) {
+  // Fetch uuid to delete the translations.
+  $uuid = db_select('panels_display')
+    ->fields('panels_display', array('uuid'))
+    ->condition('did', $did)
+    ->execute()
+    ->fetchColumn();
+  // Build a dummy display.
+  $display = (object) array('uuid' => $uuid);
+
+  // Check if this display was just saved in the db.
+  if (!_18n_panels_is_exported_panels_display($display)) {
+    // If the display was just saved in the db remove all translations.
+    i18n_string_object_remove('display_configuration', $display);
+    // Remove related pane translations too.
+    $pids = db_select('panels_pane')
+      ->fields('panels_pane', array('pid'))
+      ->condition('did', $did)
+      ->execute()
+      ->fetchCol();
+    i18n_panels_panels_pane_delete($pids);
+  }
+  else {
+    // If the display is exported leave the translated strings but give the user
+    // a hint how to clean up.
+    drupal_set_message(
+      t(
+        'The reverted panels display(s) were exported, please run a <a href="!link">string refresh</a> to update the translatable strings.',
+        array('!link' => url('admin/config/regional/translate/i18n_string'))
+      ),
+      'warning',
+      FALSE
+    );
+  }
+}
+
+/**
+ * Implements hook_panels_pre_render().
+ *
+ * This function must not rely on the passed $renderer parameter. The parameter
+ * could be empty because this function is reused in i18n_ctools_render_alter().
+ * @todo Check if a drupal_alter() in panels_display::get_title() is applicable.
+ *
+ * @see i18n_ctools_render_alter()
+ *
+ * @param panels_display $display
+ *   The display to deal with.
+ * @param panels_renderer_standard $renderer
+ *   The renderer to deal with.
+ */
+function i18n_panels_panels_pre_render(&$display, $renderer) {
+  // Avoid double translations.
+  if (!isset($display->i18n_panels_title_translated)) {
+    $translation = i18n_string_object_translate('display_configuration', $display);
+    if (is_array($translation->title)) {
+      $display->title = $translation->title['string'];
+    }
+    else {
+      $display->title = $translation->title;
+    }
+    $display->i18n_panels_title_translated = TRUE;
+  }
+}
+
+/**
+ * Implements hook_ctools_render_alter().
+ *
+ * Under some circumstances the title of the panel page is set before
+ * hook_panels_pre_render() is fired. Such cases can be handled with this hook.
+ * @todo Check if a drupal_alter() in panels_display::get_title() is applicable.
+ */
+function i18n_ctools_render_alter(&$info, $page, $context) {
+  // @todo Find a better way to detect a panels page.
+  if ($page === TRUE && !empty($info['content']['#display']) && $info['content']['#display'] instanceof panels_display) {
+    i18n_panels_panels_pre_render($info['content']['#display'], NULL);
+    // Set the info title. This is used to set the page title.
+    $info['title'] = $info['content']['#display']->get_title();
+  }
+}
+
+
+/**
+ * Implements hook_ctools_plugin_post_alter().
+ *
+ * Register some translatable configuration settings for plugins.
+ *
+ */
+function i18n_panels_ctools_plugin_post_alter(&$plugin, $plugin_type_info) {
+  if ($plugin_type_info['type'] == 'content_types') {
+    // Modify custom content.
+    if ($plugin['name'] == 'custom') {
+      // Register callback to get the translatable settings.
+      $plugin['i18n_settings'] = 'ctools_custom_content_type_i18n_settings';
+    }
+  }
+}
+
+/**
+ * Callback to provide the translatable settings appropriate to the config.
+ *
+ * @param array $conf
+ *   Content type configuration.
+ *
+ * @return array
+ *   i18n_settings configuration.
+ */
+function ctools_custom_content_type_i18n_settings($conf) {
+  return array(
+    'title',
+    'body' => array('format' => $conf['format']),
+  );
+}
+
+/**
+ * Implements hook_i18n_string_list_TEXTGROUP_alter().
+ *
+ * Necessary to support the dynamic translatable settings defined by ctools
+ * content types.
+ */
+function i18n_panels_i18n_string_list_panels_alter(&$strings, $type = NULL, $object = NULL) {
+  if (isset($object->panels_i18n_settings)) {
+    foreach ($object->panels_i18n_settings as $i18n_setting => $settings) {
+      if (isset($object->{$i18n_setting})) {
+        $strings['panels'][$type][$object->uuid][$i18n_setting] = $object->{$i18n_setting};
+      }
+    }
+  }
+}
+
+/**
+ * Implements hook_i18n_string_list().
+ *
+ * @todo Figure out a generic solution to fetch exported displays.
+ */
+function i18n_panels_i18n_string_list($group) {
+  $strings = array();
+  if ($group == 'panels') {
+
+    // Fetch all available displays.
+    $displays = _18n_panels_fetch_all_panel_displays();
+
+    foreach ($displays as $display) {
+      if (empty($display->uuid)) {
+        drupal_set_message(t('The display %display has no uuid, please resave or re-export it.', array('%display' => $display->did)), 'warning');
+        continue;
+      }
+      // Avoid duplicated runs _18n_panels_fetch_all_panel_displays() probably
+      // returns the same display twice, one for the db based and one for the
+      // exported one.
+      if (isset($strings['panels']['display_configuration'][$display->uuid])) {
+        continue;
+      }
+      $strings['panels']['display_configuration'][$display->uuid]['title']['string'] = $display->title;
+      foreach ($display->content as $pane) {
+        if (empty($pane->uuid)) {
+          // Fetch exported uuid and validate it.
+          $uuid = str_replace('new-', '', $pane->pid);
+          if (!panels_uuid_is_valid($uuid)) {
+            drupal_set_message(t('The pane %pane has no uuid, please resave or re-export it.', array('%pane' => $pane->pid)), 'warning');
+            continue;
+          }
+          $pane->uuid = $uuid;
+        }
+        if ($translation_object = i18n_panels_get_i18n_translation_object($pane)) {
+          // Split up all strings and add them to the list.
+          $pane_strings = (array) $translation_object;
+          unset($pane_strings['panels_i18n_settings']);
+          foreach ($pane_strings as $key => $pane_string) {
+            $strings['panels']['pane_configuration'][$pane->uuid][$key] = $pane_string;
+          }
+        }
+      }
+    }
+  }
+  return $strings;
+}
+
+/**
+ * Checks if the give display is exported or only stored in the db.
+ *
+ * @return boolean
+ *   TRUE if the display is available from code.
+ */
+function _18n_panels_is_exported_panels_display($display) {
+  if (isset($display->uuid)) {
+    $displays = _18n_panels_fetch_all_panel_displays();
+    return isset($displays['exported-' . $display->uuid]);
+  }
+  return FALSE;
+}
+
+/**
+ * Returns a list of really all available panel displays.
+ *
+ * The list is statically cached. Use the parameter $reset to refresh the list
+ * during the same request.
+ * Probably returns the same display twice - once with the db based and once
+ * the exported one.
+ *
+ * @todo I bet there are better ways to solve this mess.
+ *
+ * @param boolean $reset
+ *   Reset the static cache.
+ *
+ * @return array
+ *   List of all panel displays.
+ */
+function _18n_panels_fetch_all_panel_displays($reset = FALSE) {
+  $displays = &drupal_static(__FUNCTION__, array());
+  if (!empty($displays) && !$reset) {
+    return $displays;
+  }
+
+  // Fetch db based displays.
+  $dids = db_select('panels_display')->fields('panels_display', array('did'))->execute()->fetchCol();
+  $displays = panels_load_displays($dids);
+
+  // Fetch exported displays.
+  ctools_include('export');
+  foreach (ctools_export_crud_load_all('panels_display') as $panels_display) {
+    if (!empty($panels_display->uuid)) {
+      $displays['exported-' . $panels_display->uuid] = $panels_display;
+    }
+  }
+
+  // Fetch mini panels.
+  $mini_panels = ctools_export_crud_load_all('panels_mini');
+  foreach ($mini_panels as $pane) {
+    if (!empty($pane->display->uuid)) {
+      $displays['exported-' . $pane->display->uuid] = $pane->display;
+    }
+  }
+
+  // Fetch in page manager embedded displays.
+  if (module_exists('page_manager')) {
+    module_load_include('inc', 'page_manager', 'page_manager.admin');
+    $tasks = page_manager_get_tasks_by_type('page');
+    $pages = array('operations' => array(), 'tasks' => array());
+    page_manager_get_pages($tasks, $pages);
+
+    foreach ($pages['tasks'] as $task) {
+      $page = page_manager_cache_load($task);
+      $task_info = page_manager_get_task_subtasks($page->task);
+      foreach ($page->handler_info as $id => $info) {
+        $page_manager_handler = $page->handlers[$id];
+        if ($page_manager_handler->handler == 'panel_context') {
+
+          // @todo Is there really no better way to check this?
+          $is_exported = ($page_manager_handler->export_type == (EXPORT_IN_CODE | EXPORT_IN_DATABASE) || (isset($page->subtask['storage']) && $page->subtask['storage'] == t('Overridden')));
+
+          if (!empty($page_manager_handler->conf['display'])) {
+            $panels_display = $page_manager_handler->conf['display'];
+            $displays['exported-' . $panels_display->uuid] = $panels_display;
+          }
+          elseif ($is_exported && isset($page_manager_handler->conf['did'])) {
+            $panels_display = panels_load_display($page_manager_handler->conf['did']);
+            if (isset($panels_display->uuid)) {
+              $displays['exported-' . $panels_display->uuid] = $panels_display;
+            }
+          }
+        }
+      }
+    }
+  }
+  return $displays;
+}
diff --git a/profiles/commons/modules/contrib/panels/includes/callbacks.inc b/profiles/commons/modules/contrib/panels/includes/callbacks.inc
index 5188394..255a3cd 100644
--- a/profiles/commons/modules/contrib/panels/includes/callbacks.inc
+++ b/profiles/commons/modules/contrib/panels/includes/callbacks.inc
@@ -172,6 +172,22 @@ function panels_admin_settings_page() {
     }
   }
 
+  ctools_include('plugins', 'panels');
+  $pipelines = panels_get_renderer_pipelines();
+  $options = array();
+  foreach ($pipelines as $key => $value) {
+    $options[$key] = $value->admin_title;
+  }
+  if (count($options) > 1) {
+    $form['panels_renderer_default'] = array(
+      '#type' => 'select',
+      '#title' => t('Default renderer'),
+      '#options' => $options,
+      '#default_value' => variable_get('panels_renderer_default', 'standard'),
+      '#description' => t('The default renderer for new panel pages.'),
+    );
+  }
+
   if (empty($form)) {
     return array('#value' => t('There are currently no settings to change, but additional plugins or modules may provide them in the future.'));
   }
diff --git a/profiles/commons/modules/contrib/panels/js/display_editor.js b/profiles/commons/modules/contrib/panels/js/display_editor.js
index d873c9d..40e1146 100644
--- a/profiles/commons/modules/contrib/panels/js/display_editor.js
+++ b/profiles/commons/modules/contrib/panels/js/display_editor.js
@@ -16,7 +16,7 @@ Drupal.Panels.bindClickDelete = function(context) {
   $('a.pane-delete:not(.pane-delete-processed)', context)
     .addClass('pane-delete-processed')
     .click(function() {
-    if (confirm('Remove this pane?')) {
+    if (confirm(Drupal.t('Remove this pane?'))) {
       var id = '#' + $(this).attr('id').replace('pane-delete-', '');
       $(id).remove();
       Drupal.Panels.Draggable.savePositions();
diff --git a/profiles/commons/modules/contrib/panels/panels.api.php b/profiles/commons/modules/contrib/panels/panels.api.php
new file mode 100644
index 0000000..1aa1c6a
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/panels.api.php
@@ -0,0 +1,264 @@
+<?php
+
+/**
+ * @file
+ * Hooks provided by Panels.
+ */
+
+/**
+ * Allow modules to provide their own caching mechanism for the display editor.
+ *
+ * @param string $argument
+ *   The second half of the cache key. Full key module:TASK_NAME:HANDLER_NAME
+ *   passed part: TASK_NAME:HANDLER_NAME
+ * @param stdClass $cache
+ *   The display to cache.
+ */
+function hook_panels_cache_set($argument, $cache) {
+  list($handler, $item) = _panels_mini_panels_cache_get($argument);
+  $item->mini_panels_display_cache = $cache;
+  $handler->edit_cache_set_key($item, $argument);
+}
+
+/**
+ * Allow modules to provide their own caching mechanism for the display editor.
+ *
+ * @param string $argument
+ *   The second half of the cache key. Full key module:TASK_NAME:HANDLER_NAME
+ *   passed part: TASK_NAME:HANDLER_NAME
+ *
+ * @return stdClass|NULL
+ *   The cached display or NULL if the cache wasn't hit.
+ */
+function hook_panels_cache_get($argument) {
+  ctools_include('common', 'panels');
+  list($handler, $item) = _panels_mini_panels_cache_get($argument);
+  if (isset($item->mini_panels_display_cache)) {
+    return $item->mini_panels_display_cache;
+  }
+
+  $cache = new stdClass();
+  $cache->display = $item->display;
+  $cache->display->context = ctools_context_load_contexts($item);
+  $cache->display->cache_key = 'panels_mini:' . $argument;
+  $cache->content_types = panels_common_get_allowed_types('panels_mini', $cache->display->context);
+  $cache->display_title = TRUE;
+
+  // @TODO support locking.
+  $cache->locked = FALSE;
+
+  return $cache;
+}
+
+/**
+ * Allow modules to provide their own caching mechanism for the display editor.
+ *
+ * @param string $argument
+ *   The second half of the cache key. Full key module:TASK_NAME:HANDLER_NAME
+ *   passed part: TASK_NAME:HANDLER_NAME
+ * @param stdClass $cache
+ *   The display to cache.
+ *
+ * @return stdClass
+ *   The cached display.
+ */
+function hook_panels_cache_save($argument, $cache) {
+  list($handler, $item) = _panels_mini_panels_cache_get($argument);
+  $item->display = $cache->display;
+  panels_mini_save($item);
+
+  $handler->edit_cache_clear($item);
+
+  return $item;
+}
+
+/**
+ * Allow modules to provide their own caching mechanism for the display editor.
+ *
+ * @param string $argument
+ *   The second half of the cache key. Full key module:TASK_NAME:HANDLER_NAME
+ *   passed part: TASK_NAME:HANDLER_NAME
+ * @param stdClass $cache
+ *   The cached display.
+ */
+function hook_panels_cache_clear($argument, $cache) {
+  list($handler, $item) = _panels_mini_panels_cache_get($argument);
+  $handler->edit_cache_clear($item);
+}
+
+/**
+ * Allow modules to adjust the rendering array of the panels dashboard.
+ *
+ * @param array $vars
+ *   The output variables.
+ */
+function hook_panels_dashboard_blocks(&$vars) {
+  $vars['links']['panels_node'] = array(
+    'title' => l(t('Panel node'), 'node/add/panel'),
+    'description' => t('Panel nodes are node content and appear in your searches, but are more limited than panel pages.'),
+    'weight' => -1,
+  );
+}
+
+/**
+ * Allow to alter the pane content to render.
+ *
+ * This happens after the keyword substitution.
+ *
+ * @param stdClass $content
+ *   The content block to render.
+ * @param stdClass $pane
+ *   The pane object.
+ * @param array $args
+ *   The display arguments.
+ * @param array $contexts
+ *   Array with the used contexts.
+ */
+function hook_panels_pane_content_alter($content, $pane, $args, $contexts) {
+  // Don't display titles.
+  unset($content->title);
+}
+
+/**
+ * Allow modules to provide a mechanism to break locks.
+ *
+ * @param string $argument
+ *   The second half of the cache key. Full key module:TASK_NAME:HANDLER_NAME
+ *   passed part: TASK_NAME:HANDLER_NAME
+ * @param stdClass $cache
+ *   The cached display.
+ */
+function hook_panels_edit_cache_break_lock($argument, $cache) {
+  $cache->locked = FALSE;
+}
+
+/**
+ * Fired before a panels display is rendered.
+ *
+ * Last chance to modify the panels display or add output before the keyword
+ * substitution runs and the panels display is rendered.
+ *
+ * @param panels_display $panels_display
+ *   The panels display that will be rendered.
+ * @param stdClass $renderer
+ *   The renderer object that will be used to render.
+ *
+ * @return string
+ *   Additional output to add before the panels display.
+ */
+function hook_panels_pre_render($panels_display, $renderer) {
+  $translation = i18n_string_object_translate('panels_display_configuration', $panels_display);
+  $panels_display->title = $translation->title;
+}
+
+/**
+ * Fired after a panels display is rendered.
+ *
+ * Allow to add additional output after the output of the panels display.
+ *
+ * @param panels_display $panels_display
+ *   The rendered panels display.
+ * @param stdClass $renderer
+ *   The used renderer object.
+ *
+ * @return string
+ *   Additional output to add after the panels display.
+ */
+function hook_panels_post_render($panels_display, $renderer) {
+  return t('Output proudly sponsored by panels.');
+}
+
+/**
+ * Fired before a new pane is inserted in the storage.
+ *
+ * @param stdClass $pane
+ *   Pane that will be rendered.
+ */
+function hook_panels_pane_insert($pane) {
+  // Check if this pane has a custom title enabled.
+  if (!empty($pane->configuration['override_title'])) {
+    $translation_object = (object) array(
+      'pid' => $pane->pid,
+      'title' => $pane->configuration['override_title_text'],
+    );
+    $status = i18n_string_object_update('panels_pane_configuration', $translation_object);
+  }
+}
+
+/**
+ * Fired before a changed pane is updated in the storage.
+ *
+ * @param stdClass $pane
+ *   Pane that will be rendered.
+ */
+function hook_panels_pane_update($pane) {
+  // Check if this pane has a custom title enabled.
+  if (!empty($pane->configuration['override_title'])) {
+    $translation_object = (object) array(
+      'pid' => $pane->pid,
+      'title' => $pane->configuration['override_title_text'],
+    );
+    $status = i18n_string_object_update('panels_pane_configuration', $translation_object);
+  }
+}
+
+/**
+ * Fired before a panel is rendered.
+ *
+ * Last chance to modify the pane before the keyword substitution runs and the
+ * pane is rendered.
+ *
+ * @param stdClass $pane
+ *   Pane that will be rendered.
+ */
+function hook_panels_pane_prerender($pane) {
+  // Check if this pane has a custom title enabled.
+  if (!empty($pane->configuration['override_title'])) {
+    $translation_object = (object) array(
+      'pid' => $pane->pid,
+      'title' => $pane->configuration['override_title_text'],
+    );
+    $translation_object = i18n_string_object_translate('panels_pane_configuration', $translation_object);
+    $pane->configuration['override_title_text'] = $translation_object->title;
+  }
+}
+
+/**
+ * Fired before panes are deleted.
+ *
+ * @param array $pids
+ *   Array with the panel id's to delete.
+ */
+function hook_panels_pane_delete($pids) {
+  foreach ($pids as $pid) {
+    // Create dummy pane with pid as property.
+    $pane = (object) array('pid' => $pid);
+    i18n_string_object_remove('panels_pane_configuration', $pane);
+  }
+}
+
+/**
+ * Fired after a display is saved.
+ *
+ * @param panels_display $display
+ *   The display to save.
+ */
+function hook_panels_display_save($display) {
+  i18n_string_object_update('display_configuration', $display);
+}
+
+/**
+ * Fired before a display is deleted.
+ *
+ * @param integer $did
+ *   Id of the display to delete.
+ */
+function hook_panels_delete_display($did) {
+  $uuid = db_select('panels_display')
+    ->fields('panels_display', array('uuid'))
+    ->condition('did', $did)
+    ->execute()
+    ->fetchColumn();
+  $display = (object) array('uuid' => $uuid);
+  i18n_string_object_remove('display_configuration', $display);
+}
diff --git a/profiles/commons/modules/contrib/panels/panels.info b/profiles/commons/modules/contrib/panels/panels.info
index e198305..d5d4e6a 100644
--- a/profiles/commons/modules/contrib/panels/panels.info
+++ b/profiles/commons/modules/contrib/panels/panels.info
@@ -10,9 +10,10 @@ files[] = includes/legacy.inc
 files[] = includes/plugins.inc
 files[] = plugins/views/panels_views_plugin_row_fields.inc
 
-; Information added by drupal.org packaging script on 2012-08-18
-version = "7.x-3.3"
+
+; Information added by drush on 2013-12-20
+version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1345319572"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/panels/panels.module b/profiles/commons/modules/contrib/panels/panels.module
index 6192960..c82d465 100644
--- a/profiles/commons/modules/contrib/panels/panels.module
+++ b/profiles/commons/modules/contrib/panels/panels.module
@@ -308,6 +308,10 @@ function panels_permission() {
       'title' => t('Use panel locks'),
       'description' => t('Allows a user to lock and unlock panes in a panel display.'),
     ),
+    'use ipe with page manager' => array(
+      'title' => t("Use the Panels In-Place Editor with Page Manager"),
+      'description' => t('Allows users with access to the In-Place editor to administer page manager pages. This permission is only needed for users without "use page manager" access.'),
+    ),
   );
 }
 
@@ -1090,6 +1094,9 @@ function panels_render_display(&$display, $renderer = NULL) {
   if (!empty($display->context)) {
     if ($form_context = ctools_context_get_form($display->context)) {
       $form_context->form['#theme'] = 'panels_render_display_form';
+      if (empty($form_context->form['#theme_wrappers']) || !in_array('form', $form_context->form['#theme_wrappers'])) {
+        $form_context['#theme_wrappers'][] = 'form';
+      }
       $form_context->form['#display'] = &$display;
       return $form_context->form;
     }
@@ -1106,10 +1113,7 @@ function panels_render_display(&$display, $renderer = NULL) {
  * then operate as a theme function of the form.
  */
 function theme_panels_render_display_form($vars) {
-  // @todo this is probably broken in D7
-  $render = $vars['element']['#display']->render();
-  $vars['element']['#children'] = $render;
-  return theme('form', $vars);
+  return $vars['element']['#display']->render();
 }
 
 // @layout
@@ -1246,7 +1250,9 @@ function template_preprocess_panels_pane(&$vars) {
       }
 
       $element = contextual_pre_render_links($element);
-      $links += $element['#links'];
+      if(!empty($element['#links'])) {
+        $links += $element['#links'];
+      }
     }
 
     if ($links) {
@@ -1296,7 +1302,7 @@ function template_preprocess_panels_pane(&$vars) {
 
   // Add template file suggestion for content type and sub-type.
   $vars['theme_hook_suggestions'][] = $base . $delimiter . $content->type;
-  $vars['theme_hook_suggestions'][] = $base . $delimiter . strtr($content->type, '-', '_') . $delimiter . strtr($content->subtype, '-', '_');
+  $vars['theme_hook_suggestions'][] = $base . $delimiter . strtr(ctools_cleanstring($content->type, array('lower case' => TRUE)), '-', '_') . $delimiter . strtr(ctools_cleanstring($content->subtype, array('lower case' => TRUE)), '-', '_');
 
   $vars['pane_prefix'] = !empty($content->pane_prefix) ? $content->pane_prefix : '';
   $vars['pane_suffix'] = !empty($content->pane_suffix) ? $content->pane_suffix : '';
@@ -1546,7 +1552,7 @@ function panels_edit_cache_break_lock($cache) {
  * Get display edit cache on behalf of panel context.
  *
  * The key is the second half of the key in this form:
- * panel_context:TASK_NAME:HANDLER_NAME;
+ * panel_context:TASK_NAME::HANDLER_NAME::args::url;
  */
 function panel_context_panels_cache_get($key) {
   ctools_include('common', 'panels');
@@ -1555,7 +1561,7 @@ function panel_context_panels_cache_get($key) {
   // this loads the panel context inc even if we don't use the plugin.
   $plugin = page_manager_get_task_handler('panel_context');
 
-  list($task_name, $handler_name) = explode(':', $key, 2);
+  list($task_name, $handler_name, $args, $q) = explode('::', $key, 4);
   $page = page_manager_get_page_cache($task_name);
   if (isset($page->display_cache[$handler_name])) {
     return $page->display_cache[$handler_name];
@@ -1569,8 +1575,20 @@ function panel_context_panels_cache_get($key) {
   }
   $cache = new stdClass();
 
+  $task = page_manager_get_task($page->task_id);
+  //ctools_context_handler_get_all_contexts($page->task, $page->subtask, $handler);
+  $arguments = array();
+  if ($args) {
+    $arguments = explode('\\', $args);
+    $contexts = ctools_context_handler_get_task_contexts($task, $page->subtask, $arguments);
+    $contexts = ctools_context_handler_get_handler_contexts($contexts, $handler);
+  }
+  else {
+    $contexts = ctools_context_handler_get_all_contexts($page->task, $page->subtask, $handler);
+  }
+
   $cache->display = &panels_panel_context_get_display($handler);
-  $cache->display->context = ctools_context_handler_get_all_contexts($page->task, $page->subtask, $handler);
+  $cache->display->context = $contexts;
   $cache->display->cache_key = 'panel_context:' . $key;
   $cache->content_types = panels_common_get_allowed_types('panels_page', $cache->display->context);
   $cache->display_title = TRUE;
@@ -1583,7 +1601,7 @@ function panel_context_panels_cache_get($key) {
  * Get the Page Manager cache for the panel_context plugin.
  */
 function _panel_context_panels_cache_get_page_cache($key, $cache) {
-  list($task_name, $handler_name) = explode(':', $key, 2);
+  list($task_name, $handler_name, $args, $q) = explode('::', $key, 4);
   $page = page_manager_get_page_cache($task_name);
   $page->display_cache[$handler_name] = $cache;
   if ($handler_name) {
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe-rtl.css b/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe-rtl.css
new file mode 100644
index 0000000..ef78afb
--- /dev/null
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe-rtl.css
@@ -0,0 +1,67 @@
+
+div.panels-ipe-handlebar-wrapper ul {
+  float: right;
+  text-align: left;
+}
+
+div.panels-ipe-handlebar-wrapper li {
+  margin: 0 0 0 .5em;
+  float: right;
+}
+
+div.panels-ipe-draghandle span.panels-ipe-draghandle-icon {
+  float: left;
+}
+
+div.panels-ipe-placeholder {
+  text-align: right;
+}
+
+div.panels-ipe-newblock {
+  left: 30px;
+  right: auto;
+}
+
+div.panels-ipe-handlebar-wrapper li a span,
+div.panels-ipe-newblock a span {
+  text-align: right;
+}
+
+div.panels-ipe-newblock a.style {
+  margin-left: .5em;
+  margin-right: auto;
+}
+
+.panels-ipe-editing .panels-ipe-region {
+  float: right;
+}
+
+/** ============================================================================
+ * Controller form markup
+ */
+
+.ipe-throbber {
+  right: 49%;
+  right: auto;
+}
+
+div.panels-ipe-control .form-submit {
+  padding: 0 34px 2px 0.8em;
+}
+
+input#panels-ipe-save,
+input#panels-ipe-cancel {
+  background-position: 86% 0;
+}
+
+div.panels-ipe-pseudobutton-container a.panels-ipe-startedit {
+  padding-right: 34px;
+  padding-left: 10px;
+  background-position: 93% 9px;
+}
+
+div.panels-ipe-pseudobutton-container a.panels-ipe-change-layout {
+  padding-right: 34px;
+  padding-left: 10px;
+  background-position: 93% 9px;
+}
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe.css b/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe.css
index 7d71db0..ec372c6 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe.css
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/css/panels_ipe.css
@@ -27,6 +27,7 @@ div.panels-ipe-handlebar-wrapper {
 .panels-ipe-editing div.panels-ipe-portlet-wrapper {
   margin-top: 1em;
   border: 1px solid #CCC;
+  width: 100%;
 }
 
 /* Hide empty panes when not editing them. */
@@ -163,6 +164,10 @@ div.panels-ipe-newblock {
   z-index: 99;
 }
 
+div.panels-ipe-newblock li {
+  padding: 0;
+}
+
 div.panels-ipe-handlebar-wrapper li a,
 div.panels-ipe-dragtitle span,
 div.panels-ipe-newblock a,
@@ -375,9 +380,9 @@ div.panels-ipe-control .form-submit {
   padding: 0 0.8em 2px 34px;
 }
 
-input#panels-ipe-save, input#panels-ipe-cancel,
-input#panels-ipe-save:hover, input#panels-ipe-cancel:hover,
-input#panels-ipe-save:active, input#panels-ipe-cancel:active {
+div.panels-ipe-control input.panels-ipe-save, div.panels-ipe-control input.panels-ipe-cancel,
+div.panels-ipe-control input.panels-ipe-save:hover, div.panels-ipe-control input.panels-ipe-cancel:hover,
+div.panels-ipe-control input.panels-ipe-save:active, div.panels-ipe-control input.panels-ipe-cancel:active {
   background-repeat: no-repeat;
 }
 
@@ -389,7 +394,7 @@ div.panels-ipe-pseudobutton-container a {
   text-decoration: none;
 }
 
-input#panels-ipe-save {
+div.panels-ipe-control input.panels-ipe-save {
   background-image: url(../images/icon-save.png);
   background-image: url(../images/icon-save.png), linear-gradient(bottom, #383838 0%, #666666 100%);
   background-image: url(../images/icon-save.png), -o-linear-gradient(bottom, #383838 0%, #666666 100%);
@@ -406,7 +411,7 @@ input#panels-ipe-save {
   );
 }
 
-input#panels-ipe-cancel {
+div.panels-ipe-control input.panels-ipe-cancel {
   background-image: url(../images/icon-close.png);
   background-image: url(../images/icon-close.png), linear-gradient(bottom, #383838 0%, #666666 100%);
   background-image: url(../images/icon-close.png), -o-linear-gradient(bottom, #383838 0%, #666666 100%);
@@ -446,7 +451,7 @@ div.panels-ipe-pseudobutton-container a:hover {
   color: #FFF;
 }
 
-input#panels-ipe-cancel:hover {
+div.panels-ipe-control input.panels-ipe-cancel:hover {
   background-image: url(../images/icon-close.png), linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
   background-image: url(../images/icon-close.png), -o-linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
   background-image: url(../images/icon-close.png), -moz-linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
@@ -462,7 +467,7 @@ input#panels-ipe-cancel:hover {
   );
 }
 
-input#panels-ipe-save:hover {
+div.panels-ipe-control input.panels-ipe-save:hover {
   background-image: url(../images/icon-save.png), linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
   background-image: url(../images/icon-save.png), -o-linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
   background-image: url(../images/icon-save.png), -moz-linear-gradient(bottom, #3D3D3D 0%, #999999 100%);
@@ -502,7 +507,7 @@ div.panels-ipe-pseudobutton-container a:active {
   color: #CCC;
 }
 
-input#panels-ipe-cancel:active {
+div.panels-ipe-control input.panels-ipe-cancel:active {
   background-image: url(../images/icon-close.png), linear-gradient(bottom, #616161 0%, #333333 100%);
   background-image: url(../images/icon-close.png), -o-linear-gradient(bottom, #616161 0%, #333333 100%);
   background-image: url(../images/icon-close.png), -moz-linear-gradient(bottom, #616161 0%, #333333 100%);
@@ -518,7 +523,7 @@ input#panels-ipe-cancel:active {
   );
 }
 
-input#panels-ipe-save:active {
+div.panels-ipe-control input.panels-ipe-save:active {
   background-image: url(../images/icon-save.png), linear-gradient(bottom, #616161 0%, #333333 100%);
   background-image: url(../images/icon-save.png), -o-linear-gradient(bottom, #616161 0%, #333333 100%);
   background-image: url(../images/icon-save.png), -moz-linear-gradient(bottom, #616161 0%, #333333 100%);
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-close.png b/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-close.png
old mode 100755
new mode 100644
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-configure.png b/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-configure.png
old mode 100755
new mode 100644
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-save.png b/profiles/commons/modules/contrib/panels/panels_ipe/images/icon-save.png
old mode 100755
new mode 100644
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/js/panels_ipe.js b/profiles/commons/modules/contrib/panels/panels_ipe/js/panels_ipe.js
index ec34780..1f40698 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/js/panels_ipe.js
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/js/panels_ipe.js
@@ -15,9 +15,11 @@ Drupal.PanelsIPE = {
     $('a.pane-delete:not(.pane-delete-processed)', context)
       .addClass('pane-delete-processed')
       .click(function() {
-        if (confirm('Remove this pane?')) {
+        if (confirm(Drupal.t('Remove this pane?'))) {
           $(this).parents('div.panels-ipe-portlet-wrapper').fadeOut('medium', function() {
+            var $sortable = $(this).closest('.ui-sortable');
             $(this).empty().remove();
+            $sortable.trigger('sortremove');
           });
           $(this).parents('div.panels-ipe-display-container').addClass('changed');
         }
@@ -34,6 +36,10 @@ Drupal.behaviors.PanelsIPE = {
       $('div#panels-ipe-display-' + key + ':not(.panels-ipe-processed)')
         .addClass('panels-ipe-processed')
         .each(function() {
+          // If we're replacing an old IPE, clean it up a little.
+          if (Drupal.PanelsIPE.editors[key]) {
+            Drupal.PanelsIPE.editors[key].editing = false;
+          }
           Drupal.PanelsIPE.editors[key] = new DrupalPanelsIPE(key);
           Drupal.PanelsIPE.editors[key].showContainer();
         });
@@ -92,6 +98,22 @@ function DrupalPanelsIPE(cache_key, cfg) {
     }
   });
 
+
+  // If a user navigates away from a locked IPE, cancel the lock in the background.
+  $(window).bind('beforeunload', function() {
+    if (!ipe.editing) {
+      return;
+    }
+
+    if (ipe.topParent && ipe.topParent.hasClass('changed')) {
+      ipe.changed = true;
+    }
+
+    if (ipe.changed) {
+      return Drupal.t('This will discard all unsaved changes. Are you sure?');
+    }
+  });
+
   // If a user navigates away from a locked IPE, cancel the lock in the background.
   $(window).bind('unload', function() {
     ipe.cancelLock(true);
@@ -170,6 +192,7 @@ function DrupalPanelsIPE(cache_key, cfg) {
   };
 
   this.initEditing = function(formdata) {
+    ipe.editing = true;
     ipe.topParent = $('div#panels-ipe-display-' + cache_key);
     ipe.backup = this.topParent.clone();
 
@@ -212,17 +235,6 @@ function DrupalPanelsIPE(cache_key, cfg) {
     ipe.showForm();
     ipe.topParent.addClass('panels-ipe-editing');
 
-    //Reposition the "Add new pane" button
-    $('.panels-ipe-newblock').each(function() {
-      var link_width_half = parseInt($(this).children('a').outerWidth() / 2);
-
-      $(this).css('margin-left', '-' + link_width_half + 'px');
-
-      $(this).css('margin-top', '-' + parseInt($(this).children('a').outerHeight() / 2) + 'px');
-
-      $(this).parents('.panels-ipe-placeholder').find('h3').css('width', parseInt(($(this).parents('.panels-ipe-placeholder').width() / 2) - link_width_half) + 'px');
-    });
-
   };
 
   this.hideContainer = function() {
@@ -246,18 +258,18 @@ function DrupalPanelsIPE(cache_key, cfg) {
   };
 
   this.endEditing = function() {
+    ipe.editing = false;
     ipe.lockPath = null;
-    $('.panels-ipe-form-container', ipe.control).empty();
+    $('.panels-ipe-form-container').empty();
     // Re-show all the IPE non-editing meta-elements
     $('div.panels-ipe-off').show('fast');
 
     ipe.showButtons();
     // Re-hide all the IPE meta-elements
     $('div.panels-ipe-on').hide();
-    if (ipe.topParent) {
-      ipe.topParent.removeClass('panels-ipe-editing');
-      $('div.panels-ipe-sort-container', ipe.topParent).sortable("destroy");
-    }
+
+    $('.panels-ipe-editing').removeClass('panels-ipe-editing');
+    $('div.panels-ipe-sort-container', ipe.topParent).sortable("destroy");
   };
 
   this.saveEditing = function() {
@@ -334,6 +346,8 @@ $(function() {
       Drupal.PanelsIPE.editors[data.key].initEditing(data.data);
       Drupal.PanelsIPE.editors[data.key].lockPath = data.lockPath;
     }
+    Drupal.attachBehaviors();
+
   };
 
   Drupal.ajax.prototype.commands.IPEsetLockState = function(ajax, data, status) {
@@ -342,6 +356,12 @@ $(function() {
     }
   };
 
+  Drupal.ajax.prototype.commands.addNewPane = function(ajax, data, status) {
+    if (Drupal.PanelsIPE.editors[data.key]) {
+      Drupal.PanelsIPE.editors[data.key].changed = true;
+    }
+  };
+
   Drupal.ajax.prototype.commands.cancelIPE = function(ajax, data, status) {
     if (Drupal.PanelsIPE.editors[data.key]) {
       Drupal.PanelsIPE.editors[data.key].cancelIPE();
@@ -372,6 +392,11 @@ $(function() {
    */
   Drupal.ajax.prototype.ipeReplacedEventResponse = Drupal.ajax.prototype.eventResponse;
   Drupal.ajax.prototype.eventResponse = function (element, event) {
+    if (element.ipeCancelThis) {
+      element.ipeCancelThis = null;
+      return false;
+    }
+
     if ($(this.element).attr('id') == 'panels-ipe-cancel') {
       if (!Drupal.PanelsIPE.editors[this.element_settings.ipe_cache_key].cancelEditing()) {
         return false;
@@ -404,7 +429,7 @@ $(function() {
 
   Drupal.ajax.prototype.ipeReplacedBeforeSerialize = Drupal.ajax.prototype.beforeSerialize;
   Drupal.ajax.prototype.beforeSerialize = function (element_settings, options) {
-    if ($(this.element).attr('id') == 'panels-ipe-save') {
+    if ($(this.element).hasClass('panels-ipe-save')) {
       Drupal.PanelsIPE.editors[this.element_settings.ipe_cache_key].saveEditing();
     };
     return this.ipeReplacedBeforeSerialize(element_settings, options);
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
index 204e6c7..3568386 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
@@ -6,9 +6,10 @@ core = 7.x
 configure = admin/structure/panels
 files[] = panels_ipe.module
 
-; Information added by drupal.org packaging script on 2012-08-18
-version = "7.x-3.3"
+
+; Information added by drush on 2013-12-20
+version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1345319572"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.module b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.module
index 7aeb915..c309684 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.module
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.module
@@ -73,18 +73,17 @@ function theme_panels_ipe_placeholder_pane($vars) {
   return $output;
 }
 
-function theme_panels_ipe_pane_wrapper($vars) {
-  $output = $vars['output'];
+function template_preprocess_panels_ipe_pane_wrapper(&$vars) {
   $pane = $vars['pane'];
   $display = $vars['display'];
   $renderer = $vars['renderer'];
 
   $content_type = ctools_get_content_type($pane->type);
   $subtype = ctools_content_get_subtype($content_type, $pane->subtype);
-  $links = array();
+  $vars['links'] = array();
 
   if (ctools_content_editable($content_type, $subtype, $pane->configuration)) {
-    $links['edit'] = array(
+    $vars['links']['edit'] = array(
       'title' => isset($content_type['edit text']) ? '<span>' . $content_type['edit text'] . '</span>' : '<span>' . t('Settings') . '</span>',
       'href' => $renderer->get_url('edit-pane', $pane->pid),
       'html' => TRUE,
@@ -98,7 +97,7 @@ function theme_panels_ipe_pane_wrapper($vars) {
 
   // Add option to configure style in IPE
   if (user_access('administer panels styles')) {
-    $links['style'] = array(
+    $vars['links']['style'] = array(
       'title' => '<span>' . t('Style') . '</span>',
       'href' => $renderer->get_url('style-type', 'pane', $pane->pid),
       'html' => TRUE,
@@ -111,7 +110,7 @@ function theme_panels_ipe_pane_wrapper($vars) {
 
   // Deleting is managed entirely in the js; this is just an attachment point
   // for it
-  $links['delete'] = array(
+  $vars['links']['delete'] = array(
     'title' => '<span>' . t('Delete') . '</span>',
     'href' => '#',
     'html' => TRUE,
@@ -122,11 +121,25 @@ function theme_panels_ipe_pane_wrapper($vars) {
     ),
   );
 
+  $context = array(
+    'pane' => $pane,
+    'display' => $display,
+    'renderer' => $renderer
+  );
+  drupal_alter('panels_ipe_pane_links', $vars['links'], $context);
+
+}
+
+function theme_panels_ipe_pane_wrapper($vars) {
+  $output = $vars['output'];
+  $pane = $vars['pane'];
+
   $attributes = array(
     'class' => 'panels-ipe-linkbar',
   );
 
-  $links = theme('links', array('links' => $links, 'attributes' => $attributes));
+  $links = theme('links', array('links' => $vars['links'], 'attributes' => $attributes));
+
   if (!empty($pane->locks['type']) && $pane->locks['type'] == 'immovable') {
     $links = '<div class="panels-ipe-dragbar panels-ipe-nodraghandle clearfix">' . $links . '</div>';
   }
@@ -135,6 +148,7 @@ function theme_panels_ipe_pane_wrapper($vars) {
   }
 
   $handlebar = '<div class="panels-ipe-handlebar-wrapper panels-ipe-on">' . $links . '</div>';
+
   return $handlebar . $output;
 }
 
@@ -142,33 +156,53 @@ function theme_panels_ipe_region_wrapper($vars) {
   return $vars['controls'] . $vars['output'];
 }
 
-function theme_panels_ipe_add_pane_button($vars) {
+function template_preprocess_panels_ipe_add_pane_button(&$vars) {
   $region_id = $vars['region_id'];
   $display = $vars['display'];
   $renderer = $vars['renderer'];
-  $link = '';
+  $vars['links'] = '';
 
   // Add option to configure style in IPE
   if (user_access('administer panels styles')) {
-    $link .= ' ' . l('<span>' . t('Region style') . '</span>', $renderer->get_url('style-type', 'region', $region_id), array(
+    $vars['links']['style'] = array(
+      'title' => '<span>' . t('Region style') . '</span>',
+      'href' => $renderer->get_url('style-type', 'region', $region_id),
+      'html' => TRUE,
       'attributes' => array(
-        'class' => array('ctools-use-modal', 'style', 'panels-ipe-hide-bar'),
+        'class' => array('ctools-use-modal', 'panels-ipe-hide-bar', 'style'),
         'title' => t('Region style'),
       ),
-      'html' => TRUE,
-    ));
+    );
   }
 
   // Add option to add items in the IPE
-  $link .= ' ' . l('<span>' . t('Add new pane') . '</span>', $renderer->get_url('select-content', $region_id), array(
-      'attributes' => array(
-        'class' => array('ctools-use-modal', 'add', 'panels-ipe-hide-bar'),
-        'title' => t('Add new pane'),
-      ),
-      'html' => TRUE,
-  ));
+  $vars['links']['add-pane'] = array(
+    'title' => '<span>' . t('Add new pane') . '</span>',
+    'href' => $renderer->get_url('select-content', $region_id),
+    'attributes' => array(
+      'class' => array('ctools-use-modal', 'add', 'panels-ipe-hide-bar'),
+      'title' => t('Add new pane'),
+    ),
+    'html' => TRUE,
+  );
+
+  $context = array(
+    'region_id' => $region_id,
+    'display' => $display,
+    'renderer' => $renderer,
+  );
+  drupal_alter('panels_ipe_region_links', $vars['links'], $context);
+
+}
+
+function theme_panels_ipe_add_pane_button($vars) {
+  $attributes = array(
+    'class' => array('panels-ipe-linkbar', 'inline'),
+  );
+
+  $links = theme('links', array('links' => $vars['links'], 'attributes' => $attributes));
 
-  return '<div class="panels-ipe-newblock panels-ipe-on">' . $link . '</div>';
+  return '<div class="panels-ipe-newblock panels-ipe-on">' . $links . '</div>';
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/plugins/display_renderers/panels_renderer_ipe.class.php b/profiles/commons/modules/contrib/panels/panels_ipe/plugins/display_renderers/panels_renderer_ipe.class.php
index 5f016fd..bccb122 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/plugins/display_renderers/panels_renderer_ipe.class.php
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/plugins/display_renderers/panels_renderer_ipe.class.php
@@ -134,18 +134,28 @@ class panels_renderer_ipe extends panels_renderer_editor {
     return "<div id=\"panels-ipe-paneid-{$pane->pid}\" class=\"panels-ipe-portlet-wrapper panels-ipe-portlet-marker\">" . $output . "</div>";
   }
 
+  function prepare_panes($panes) {
+    // Set to admin mode just for this to ensure all panes are represented.
+    $this->admin = TRUE;
+    $panes = parent::prepare_panes($panes);
+    $this->admin = FALSE;
+  }
+
   function render_pane_content(&$pane) {
-    $content = parent::render_pane_content($pane);
+    if (!empty($pane->shown) && panels_pane_access($pane, $this->display)) {
+      $content = parent::render_pane_content($pane);
+    }
     // Ensure that empty panes have some content.
-    if (empty($content) || !is_object($content) || empty($content->content)) {
-      if (!is_object($content)) {
-        $content = new StdClass();
+    if (empty($content) || empty($content->content)) {
+      if (empty($content)) {
+        $content = new stdClass();
       }
+
       // Get the administrative title.
       $content_type = ctools_get_content_type($pane->type);
       $title = ctools_content_admin_title($content_type, $pane->subtype, $pane->configuration, $this->display->context);
 
-      $content->content = t('Placeholder for empty "@title"', array('@title' => $title));
+      $content->content = t('Placeholder for empty or inaccessible "@title"', array('@title' => html_entity_decode($title, ENT_QUOTES)));
       // Add these to prevent notices.
       $content->type = 'panels_ipe';
       $content->subtype = 'panels_ipe';
@@ -230,6 +240,7 @@ class panels_renderer_ipe extends panels_renderer_editor {
     $_POST['ajax_html_ids'] = array();
 
     $form_state = array(
+      'renderer' => $this,
       'display' => &$this->display,
       'content_types' => $this->cache->content_types,
       'rerender' => FALSE,
@@ -247,7 +258,7 @@ class panels_renderer_ipe extends panels_renderer_editor {
         'command' => 'initIPE',
         'key' => $this->clean_key,
         'data' => drupal_render($output),
-        'lockPath' => $this->get_url('unlock_ipe'),
+        'lockPath' => url($this->get_url('unlock_ipe')),
       );
       return;
     }
@@ -318,7 +329,7 @@ class panels_renderer_ipe extends panels_renderer_editor {
     $this->commands[] = array(
       'command' => 'IPEsetLockState',
       'key' => $this->clean_key,
-      'lockPath' => $this->get_url('unlock_ipe'),
+      'lockPath' => url($this->get_url('unlock_ipe')),
     );
   }
 
@@ -347,7 +358,7 @@ class panels_renderer_ipe extends panels_renderer_editor {
       if (!empty($form_state['clicked_button']['#save-display'])) {
         // Saved. Save the cache.
         panels_edit_cache_save($this->cache);
-        $this->display->skip_cache;
+        $this->display->skip_cache = TRUE;
 
         // Since the layout changed, we have to update these things in the
         // renderer in order to get the right settings.
@@ -396,6 +407,10 @@ class panels_renderer_ipe extends panels_renderer_editor {
 
     $this->commands[] = ajax_command_prepend("#panels-ipe-regionid-{$pane->panel} div.panels-ipe-sort-container", $this->render_pane($pane));
     $this->commands[] = ajax_command_changed("#panels-ipe-display-{$this->clean_key}");
+    $this->commands[] = array(
+      'command' => 'addNewPane',
+      'key' => $this->clean_key,
+    );
   }
 }
 
@@ -433,12 +448,14 @@ function panels_ipe_edit_control_form($form, &$form_state) {
     '#type' => 'submit',
     '#value' => t('Save'),
     '#id' => 'panels-ipe-save',
+    '#attributes' => array('class' => array('panels-ipe-save')),
     '#submit' => array('panels_edit_display_form_submit'),
     '#save-display' => TRUE,
   );
   $form['buttons']['cancel'] = array(
     '#type' => 'submit',
     '#id' => 'panels-ipe-cancel',
+    '#attributes' => array('class' => array('panels-ipe-cancel')),
     '#value' => t('Cancel'),
   );
   return $form;
diff --git a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
index 96d17b6..634f08c 100644
--- a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
+++ b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
@@ -4,9 +4,10 @@ package = "Panels"
 dependencies[] = panels
 core = 7.x
 files[] = plugins/export_ui/panels_mini_ui.class.php
-; Information added by drupal.org packaging script on 2012-08-18
-version = "7.x-3.3"
+
+; Information added by drush on 2013-12-20
+version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1345319572"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.module b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.module
index a0aa662..2691efe 100644
--- a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.module
+++ b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.module
@@ -130,8 +130,8 @@ function panels_mini_block_view($delta = 0) {
  */
 function panels_mini_block_configure($delta = 0) {
   return array(
-    'admin-shortcut' => array(
-      '#value' => l(t('Manage this mini-panel'), 'admin/structure/mini-panels/' . $delta . '/edit')
+    'admin_shortcut' => array(
+      '#markup' => l(t('Manage this mini-panel'), 'admin/structure/mini-panels/list/' . $delta . '/edit')
     ),
   );
 }
@@ -285,7 +285,8 @@ function panels_mini_load_all($reset = FALSE) {
     }
   }
 
-  return $cache;
+  // Strip out NULL entries that may have been added by panels_mini_load().
+  return array_filter($cache);
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/panels/panels_mini/plugins/content_types/panels_mini.inc b/profiles/commons/modules/contrib/panels/panels_mini/plugins/content_types/panels_mini.inc
index 6bd4d94..2170111 100644
--- a/profiles/commons/modules/contrib/panels/panels_mini/plugins/content_types/panels_mini.inc
+++ b/profiles/commons/modules/contrib/panels/panels_mini/plugins/content_types/panels_mini.inc
@@ -109,6 +109,16 @@ function panels_mini_panels_mini_content_type_render($subtype, $conf, $panel_arg
   $block->content = panels_render_display($mini->display);
   $block->title = $mini->display->get_title();
 
+  if (user_access('administer mini panels')) {
+    $block->admin_links = array(
+      array(
+        'title' => t('Configure mini panel'),
+        'href' => "admin/structure/mini-panels/list/$subtype/edit/content",
+        'query' => drupal_get_destination(),
+      ),
+    );
+  }
+
   unset($viewing[$mini->name]);
   return $block;
 }
@@ -137,3 +147,30 @@ function panels_mini_panels_mini_content_type_admin_title($subtype, $conf) {
   return $title;
 }
 
+/**
+ * Callback to provide administrative info. Provide links to edit the mini
+ * panel.
+ */
+function panels_mini_panels_mini_content_type_admin_info($subtype, $conf) {
+  $mini = panels_mini_load($subtype);
+  if (!$mini) {
+    return FALSE;
+  }
+
+  $block = new stdClass();
+  $block->title = $mini->admin_title;
+  $admin_pages = array(
+    t('Settings') => 'basic',
+    t('Context') => 'context',
+    t('Layout') => 'layout',
+    t('Content') => 'content',
+  );
+
+  $links = array();
+  foreach ($admin_pages as $title => $tail) {
+    $links[] = l($title, 'admin/structure/mini-panels/list/' . $subtype . '/edit/' . $tail, array('query' => drupal_get_destination()));
+  }
+
+  $block->content = theme('item_list', array('items' => $links));
+  return $block;
+}
diff --git a/profiles/commons/modules/contrib/panels/panels_mini/plugins/export_ui/panels_mini_ui.class.php b/profiles/commons/modules/contrib/panels/panels_mini/plugins/export_ui/panels_mini_ui.class.php
index 6c7d084..cff8fe6 100644
--- a/profiles/commons/modules/contrib/panels/panels_mini/plugins/export_ui/panels_mini_ui.class.php
+++ b/profiles/commons/modules/contrib/panels/panels_mini/plugins/export_ui/panels_mini_ui.class.php
@@ -118,6 +118,13 @@ class panels_mini_ui extends ctools_export_ui {
     // Get the basic edit form
     parent::edit_form($form, $form_state);
 
+    // Set the admin title machine name length.
+    // We need to do this because the system block name length is
+    // limited to 32 chars.
+    $form['info']['name']['#maxlength'] = 32;
+    $form['info']['name']['#size'] = 34;
+    $form['info']['name']['#description'] .= ' ' . t('The machine name length is limited to 32 characters, due to a limitation in the core block system.');
+
     $form['category'] = array(
       '#type' => 'textfield',
       '#size' => 24,
diff --git a/profiles/commons/modules/contrib/panels/panels_node/panels_node.info b/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
index bb63d58..3e5a497 100644
--- a/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
+++ b/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
@@ -6,9 +6,10 @@ configure = admin/structure/panels
 core = 7.x
 files[] = panels_node.module
 
-; Information added by drupal.org packaging script on 2012-08-18
-version = "7.x-3.3"
+
+; Information added by drush on 2013-12-20
+version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1345319572"
+datestamp = "1387568916"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_node/panels_node.module b/profiles/commons/modules/contrib/panels/panels_node/panels_node.module
index 4044c5a..894dc67 100644
--- a/profiles/commons/modules/contrib/panels/panels_node/panels_node.module
+++ b/profiles/commons/modules/contrib/panels/panels_node/panels_node.module
@@ -339,6 +339,7 @@ function panels_node_hook_view($node, $view_mode) {
       $display->css_id = $node->panels_node['css_id'];
       // TODO: Find a way to make sure this can't node_view.
       $display->context = panels_node_get_context($node);
+      $display->cache_key = 'panels_node:' . $node->nid;
       $renderer = panels_get_renderer($node->panels_node['pipeline'], $display);
       $node->content['body'] = array(
         '#markup' => panels_render_display($display, $renderer),
@@ -429,3 +430,59 @@ function panels_node_panels_dashboard_blocks(&$vars) {
     'weight' => -1,
   );
 }
+
+// ---------------------------------------------------------------------------
+// Callbacks for panel caching.
+
+/**
+ * Get display edit cache for a panel node being edited.
+ *
+ * The key is the second half of the key in this form:
+ * panels_node:NID;
+ */
+function panels_node_panels_cache_get($nid) {
+  ctools_include('object-cache');
+  $cache = ctools_object_cache_get('panels_node_display_cache', $nid);
+  if (empty($cache)) {
+    $cache = new stdClass();
+    $node = node_load($nid);
+    if (empty($node)) {
+      return;
+    }
+
+    ctools_include('common', 'panels');
+    $cache->display = panels_load_display($node->panels_node['did']);
+    $cache->display->css_id = $node->panels_node['css_id'];
+    $cache->display->context = panels_node_get_context($node);
+    $cache->display->cache_key = 'panels_node:' . $node->nid;
+    $cache->content_types =   panels_common_get_allowed_types('panels_node', $cache->display->context);
+    $cache->allwed_layouts = panels_common_get_allowed_layouts('panels_node');
+  }
+
+  return $cache;
+}
+
+/**
+ * Store a display edit in progress in the panels cache.
+ */
+function panels_node_panels_cache_set($nid, $cache) {
+  ctools_include('object-cache');
+  ctools_object_cache_set('panels_node_display_cache', $nid, $cache);
+}
+
+/**
+ * Clear all changes made to a display using the panels cache.
+ */
+function panels_node_panels_cache_clear($nid, $cache) {
+  ctools_include('object-cache');
+  ctools_object_cache_clear('panels_node_display_cache', $nid);
+}
+
+/**
+ * React to a cache save and save the display and clear cache.
+ */
+function panels_node_panels_cache_save($nid, $cache) {
+  panels_save_display($cache->display);
+  ctools_include('object-cache');
+  ctools_object_cache_clear('panels_node_display_cache', $nid);
+}
diff --git a/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_editor.class.php b/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_editor.class.php
index 7aa9700..4f4db4a 100644
--- a/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_editor.class.php
+++ b/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_editor.class.php
@@ -153,7 +153,7 @@ class panels_renderer_editor extends panels_renderer_standard {
 
     $output = '<div class="' . $class . '" id="panel-pane-' . $pane->pid . '">';
 
-    if (!$block->title) {
+    if (empty($block->title)) {
       $block->title = t('No title');
     }
 
@@ -581,7 +581,7 @@ class panels_renderer_editor extends panels_renderer_standard {
    * @todo -- this should be in CTools.
    */
   function get_category($content_type) {
-    if (isset($content_type['top level'])) {
+    if (!empty($content_type['top level'])) {
       $category = 'root';
     }
     else if (isset($content_type['category'])) {
@@ -757,6 +757,11 @@ class panels_renderer_editor extends panels_renderer_standard {
       // References get blown away with AJAX caching. This will fix that.
       $this->cache->display->content[$pid] = $form_state['pane'];
 
+      // Conditionally overwrite the context for this panel if present in the form state.
+      if (!empty($form_state['display_cache']->display->context)) {
+        $this->cache->display->context = $form_state['display_cache']->display->context;
+      }
+
       panels_edit_cache_set($this->cache);
       $this->command_update_pane($pid);
       $this->commands[] = ctools_modal_command_dismiss();
@@ -1158,7 +1163,11 @@ class panels_renderer_editor extends panels_renderer_standard {
       unset($this->cache->style);
     }
 
-    // $conf was a reference so it should just modify.
+    // Copy settings from form state back into the cache.
+    if(!empty($form_state['values']['settings'])) {
+      $this->cache->display->content[$pid]->style['settings'] = $form_state['values']['settings'];
+    }
+
     panels_edit_cache_set($this->cache);
 
     $this->commands[] = ctools_modal_command_dismiss();
diff --git a/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_standard.class.php b/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_standard.class.php
index f38fd8f..aebf191 100644
--- a/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_standard.class.php
+++ b/profiles/commons/modules/contrib/panels/plugins/display_renderers/panels_renderer_standard.class.php
@@ -259,6 +259,10 @@ class panels_renderer_standard {
       }
     }
     $this->prepared['panes'] = $first + $normal + $last;
+
+    // Allow other modules the alter the prepared panes array.
+    drupal_alter('panels_panes_prepared', $this->prepared['panes'], $this);
+
     return $this->prepared['panes'];
   }
 
@@ -436,7 +440,7 @@ class panels_renderer_standard {
         break;
       case 'inline':
         $url = base_path() . $filename;
-        $this->prefix .= '<link type="text/css" rel="stylesheet" href="' . $url . '" />'."\n";
+        $this->prefix .= '<link type="text/css" rel="stylesheet" href="' . file_create_url($url) . '" />'."\n";
         break;
     }
   }
diff --git a/profiles/commons/modules/contrib/panels/plugins/export_ui/panels_layouts_ui.class.php b/profiles/commons/modules/contrib/panels/plugins/export_ui/panels_layouts_ui.class.php
index 256cdaa..ecf3b7b 100644
--- a/profiles/commons/modules/contrib/panels/plugins/export_ui/panels_layouts_ui.class.php
+++ b/profiles/commons/modules/contrib/panels/plugins/export_ui/panels_layouts_ui.class.php
@@ -125,9 +125,19 @@ class panels_layouts_ui extends ctools_export_ui {
 
   function edit_form_submit(&$form, &$form_state) {
     parent::edit_form_submit($form, $form_state);
+
+    // While we short circuited the main submit hook, we need to keep this one.
+    panels_edit_display_settings_form_submit($form, $form_state);
     $form_state['item']->settings = $form_state['display']->layout_settings;
   }
 
+  function edit_form_validate(&$form, &$form_state) {
+    parent::edit_form_validate($form, $form_state);
+
+    // While we short circuited the main validate hook, we need to keep this one.
+    panels_edit_display_settings_form_validate($form, $form_state);
+  }
+
   function list_form(&$form, &$form_state) {
     ctools_include('plugins', 'panels');
     $this->builders = panels_get_layout_builders();
diff --git a/profiles/commons/modules/contrib/panels/plugins/layouts/flexible/flexible.inc b/profiles/commons/modules/contrib/panels/plugins/layouts/flexible/flexible.inc
index 93a7c93..f49886b 100644
--- a/profiles/commons/modules/contrib/panels/plugins/layouts/flexible/flexible.inc
+++ b/profiles/commons/modules/contrib/panels/plugins/layouts/flexible/flexible.inc
@@ -747,47 +747,47 @@ function panels_flexible_render_css_group($renderer, $list, $owner_id, $type, $i
   $css = array();
 
   // Start off with some generic CSS to properly pad regions
-  $css['.' . $renderer->item_class['region']] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['region']] = array(
     'padding' => '0',
   );
 
-  $css['.' . $renderer->item_class['region'] . '-inside'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['region'] . '-inside'] = array(
     'padding-right' => $renderer->region_separation,
     'padding-left' => $renderer->region_separation,
   );
 
-  $css['.' . $renderer->item_class['region'] . '-inside-first'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['region'] . '-inside-first'] = array(
     'padding-left' => '0',
   );
 
-  $css['.' . $renderer->item_class['region'] . '-inside-last'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['region'] . '-inside-last'] = array(
     'padding-right' => '0',
   );
 
-  $css['.' . $renderer->item_class['column']] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['column']] = array(
     'padding' => '0',
   );
 
-  $css['.' . $renderer->item_class['column'] . '-inside'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['column'] . '-inside'] = array(
     'padding-right' => $renderer->column_separation,
     'padding-left' => $renderer->column_separation,
   );
 
-  $css['.' . $renderer->item_class['column'] . '-inside-first'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['column'] . '-inside-first'] = array(
     'padding-left' => '0',
   );
 
-  $css['.' . $renderer->item_class['column'] . '-inside-last'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['column'] . '-inside-last'] = array(
     'padding-right' => '0',
   );
 
   // And properly pad rows too
-  $css['.' . $renderer->item_class['row']] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['row']] = array(
     'padding' => '0 0 ' . $renderer->row_separation . ' 0',
     'margin' => '0',
   );
 
-  $css['.' . $renderer->item_class['row'] . '-last'] = array(
+  $css[$owner_id . ' .' . $renderer->item_class['row'] . '-last'] = array(
     'padding-bottom' => '0',
   );
 
diff --git a/profiles/commons/modules/contrib/panels/plugins/styles/block.inc b/profiles/commons/modules/contrib/panels/plugins/styles/block.inc
index 4614ee4..58815a3 100644
--- a/profiles/commons/modules/contrib/panels/plugins/styles/block.inc
+++ b/profiles/commons/modules/contrib/panels/plugins/styles/block.inc
@@ -31,6 +31,9 @@ function theme_panels_block_style_render_pane($vars) {
   if (!empty($block->title)) {
     $block->subject = $block->title;
   }
+  if (!isset($block->subject)) {
+    $block->subject = '';
+  }
 
   $block->region = $pane->panel;
   if (!isset($block->module)) {
diff --git a/profiles/commons/modules/contrib/panels/plugins/styles/naked.inc b/profiles/commons/modules/contrib/panels/plugins/styles/naked.inc
old mode 100755
new mode 100644
diff --git a/profiles/commons/modules/contrib/panels/plugins/task_handlers/panel_context.inc b/profiles/commons/modules/contrib/panels/plugins/task_handlers/panel_context.inc
index c2b5c44..c3bb07f 100644
--- a/profiles/commons/modules/contrib/panels/plugins/task_handlers/panel_context.inc
+++ b/profiles/commons/modules/contrib/panels/plugins/task_handlers/panel_context.inc
@@ -184,7 +184,7 @@ $plugin = array(
   'default conf' => array(
     'title' => t('Panel'),
     'no_blocks' => FALSE,
-    'pipeline' => 'standard',
+    'pipeline' => variable_get('panels_renderer_default', 'standard'),
     'body_classes_to_remove' => '',
     'body_classes_to_add' => '',
     'css_id' => '',
@@ -239,6 +239,28 @@ function &panels_panel_context_get_display(&$handler) {
 }
 
 /**
+ * Build the cache key so that the editor and IPE can properly find
+ * everything needed for this display.
+ */
+function panels_panel_context_cache_key($task_name, $handler_id, $args) {
+  $arguments = array();
+  foreach ($args as $arg) {
+    // Sadly things like panels everywhere actually use non-string arguments
+    // and they basically can't be represented here. Luckily, PE also does
+    // not use a system where this matters, so replace its args with a 0
+    // for a placeholder.
+    if (is_string($arg)) {
+      $arguments[] = $arg;
+    }
+    else {
+      $arguments[] = '0';
+    }
+  }
+  $cache_key = 'panel_context:' . $task_name . '::' . $handler_id . '::' . implode('\\', $arguments) . '::';
+  return $cache_key;
+}
+
+/**
  * Check selection rules and, if passed, render the contexts.
  */
 function panels_panel_context_render($handler, $base_contexts, $args, $test = TRUE) {
@@ -267,7 +289,7 @@ function panels_panel_context_render($handler, $base_contexts, $args, $test = TR
   $display->css_id = $handler->conf['css_id'];
   $task_name = page_manager_make_task_name($handler->task, $handler->subtask);
 
-  $display->cache_key = 'panel_context:' . $task_name . ':' . $handler->name;
+  $display->cache_key = panels_panel_context_cache_key($task_name, $handler->name, $args);
 
   // Check to see if there is any CSS.
   if (!empty($handler->conf['css'])) {
@@ -284,6 +306,13 @@ function panels_panel_context_render($handler, $base_contexts, $args, $test = TR
   panels_get_current_page_display($display);
 
   $renderer = panels_get_renderer($handler->conf['pipeline'], $display);
+  // If the IPE is enabled, but the user does not have access to edit
+  // load the standard renderer instead.
+
+  $parents = class_parents($renderer);
+  if (!empty($parents['panels_renderer_editor']) && !user_access('user page manager') && !user_access('use ipe with page manager')) {
+    $renderer = panels_get_renderer_handler('standard', $display);
+  }
 
   // Remove and add body element classes
   $panel_body_css = &drupal_static('panel_body_css');
@@ -632,7 +661,7 @@ function panels_panel_context_edit_move($form, &$form_state) {
   $form_state['display'] = &panels_panel_context_get_display($form_state['handler']);
   $form_state['layout'] = $form_state['handler']->conf['temp_layout'];
 
-  $form_state['cache_key'] = 'panel_context:' . $form_state['task_name'] . ':' . $form_state['handler_id'];
+  $form_state['cache_key'] = panels_panel_context_cache_key($form_state['task_name'], $form_state['handler_id'], array());
 
   ctools_include('common', 'panels');
   ctools_include('display-layout', 'panels');
@@ -669,7 +698,7 @@ function panels_panel_context_edit_content($form, &$form_state) {
   ctools_include('context');
   ctools_include('context-task-handler');
 
-  $cache = panels_edit_cache_get('panel_context:' . $form_state['task_name'] . ':' . $form_state['handler_id']);
+  $cache = panels_edit_cache_get(panels_panel_context_cache_key($form_state['task_name'], $form_state['handler_id'], array()));
 
   $form_state['renderer'] = panels_get_renderer_handler('editor', $cache->display);
   $form_state['renderer']->cache = &$cache;
@@ -871,15 +900,28 @@ function panels_panel_context_get_addressable($task, $subtask_name, $handler, $a
   $display->context = $contexts;
   $display->args = $arguments;
   $display->css_id = $handler->conf['css_id'];
-  $display->cache_key = 'panel_context:' . $task->name . ':' . $handler->name;
+  $display->cache_key = panels_panel_context_cache_key($task->name, $handler->name, $arguments);
 
   $renderer = panels_get_renderer($handler->conf['pipeline'], $display);
-  if ($type == 'content') {
-    $renderer->prepare();
+  $renderer->prepare();
 
+  if ($address) {
     $pid = array_shift($address);
     if (!empty($renderer->prepared['panes'][$pid])) {
-      return $renderer->render_pane($renderer->prepared['panes'][$pid]);
+      if ($type == 'content') {
+        return $renderer->render_pane($renderer->prepared['panes'][$pid]);
+      }
+      elseif ($type == 'pane') {
+        return $renderer->prepared['panes'][$pid];
+      }
+    }
+  }
+  else {
+    if ($type == 'content') {
+      return $renderer->render();
+    }
+    elseif ($type == 'renderer') {
+      return $renderer;
     }
   }
 }
diff --git a/profiles/commons/modules/contrib/paranoia/LICENSE.txt b/profiles/commons/modules/contrib/paranoia/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/paranoia/paranoia.drush.inc b/profiles/commons/modules/contrib/paranoia/paranoia.drush.inc
index 6d6cadb..74929cf 100644
--- a/profiles/commons/modules/contrib/paranoia/paranoia.drush.inc
+++ b/profiles/commons/modules/contrib/paranoia/paranoia.drush.inc
@@ -24,6 +24,7 @@ function paranoia_drush_sql_sync_sanitize($site) {
     dt('Remove history, which contains info on where users have browsed on a site.'),
     "TRUNCATE history;");
   // Since people may not enable the dblog module, ensure it exists first.
+  drupal_bootstrap(DRUPAL_BOOTSTRAP_DATABASE);
   if (db_table_exists('watchdog')) {
     drush_sql_register_post_sync_op('watchdog',
       dt('Watchdog usually contains user id, IP, e-mail addresses, filesystem paths.'),
diff --git a/profiles/commons/modules/contrib/paranoia/paranoia.info b/profiles/commons/modules/contrib/paranoia/paranoia.info
index 5e30f64..303f964 100644
--- a/profiles/commons/modules/contrib/paranoia/paranoia.info
+++ b/profiles/commons/modules/contrib/paranoia/paranoia.info
@@ -3,9 +3,9 @@ description = Protects a site from some insecure configurations.
 core = 7.x
 
 
-; Information added by drupal.org packaging script on 2013-06-29
-version = "7.x-1.2"
+; Information added by  packaging script on 2013-11-12
+version = "7.x-1.3"
 core = "7.x"
 project = "paranoia"
-datestamp = "1372482351"
+datestamp = "1384278805"
 
diff --git a/profiles/commons/modules/contrib/paranoia/paranoia.module b/profiles/commons/modules/contrib/paranoia/paranoia.module
index 0e3c1ad..e2f571d 100644
--- a/profiles/commons/modules/contrib/paranoia/paranoia.module
+++ b/profiles/commons/modules/contrib/paranoia/paranoia.module
@@ -19,8 +19,16 @@ function paranoia_form_system_modules_alter(&$form, &$form_state) {
   foreach ($hidden_modules as $module => $package) {
     // Unset instead of using #access because #access => FALSE shows an empty
     // table row.
-    unset($form['modules'][$package][$module]);
+    if (isset($form['modules'][$module])) {
+      unset($form['modules'][$module]);
+    }
+    // Adds support for module_filter.
+    if (isset($form['modules'][$package][$module])) {
+      unset($form['modules'][$package][$module]);
+    }
   }
+  // Invoke custom validation function to disable banned modules on submit
+  $form['#validate'][] = 'paranoia_module_validate';
 }
 
 /**
@@ -135,6 +143,15 @@ function paranoia_permissions_submit($form, &$form_state) {
 }
 
 /**
+ * Implements hook_paranoia_disable_modules().
+ */
+function paranoia_paranoia_disable_modules() {
+  return array(
+    'php',
+  );
+}
+
+/**
  * Implements hook_paranoia_hide_permissions().
  *
  * On behalf of Drupal Core.
@@ -204,3 +221,32 @@ function auto_nodetitle_paranoia_hide_permissions() {
   return array('use PHP for title patterns');
 }
 
+/**
+ * Custom validation function to make sure php_filter can't be enabled.
+ */
+function paranoia_module_validate($form, &$form_state) {
+  $disabled_modules = module_invoke_all('paranoia_disable_modules');
+  foreach ($disabled_modules as $module) {
+    if (module_exists($module)) {
+      drupal_set_message(t('You attempted to enable %module which is not allowed on this site.',
+        array('%module' => $module)));
+      module_disable(array($module));
+    }
+  }
+}
+
+/**
+ * Implements hook_paranoia_hide_permissions().
+ * On behalf of visual_website_optimizer.module.
+ */
+function visual_website_optimizer_paranoia_hide_permissions() {
+  return array('use PHP for filtering condition');
+}
+
+/**
+  * Implements hook_paranoia_hide_permissions().
+  * On behalf of live_person.module.
+  */
+function live_person_paranoia_hide_permissions() {
+  return array('use PHP for live person visibility');
+}
diff --git a/profiles/commons/modules/contrib/r4032login/r4032login.info b/profiles/commons/modules/contrib/r4032login/r4032login.info
index acb3cae..bf6f247 100644
--- a/profiles/commons/modules/contrib/r4032login/r4032login.info
+++ b/profiles/commons/modules/contrib/r4032login/r4032login.info
@@ -7,9 +7,9 @@ files[] = r4032login.module
 
 configure = admin/config/system/site-information
 
-; Information added by drupal.org packaging script on 2013-08-30
-version = "7.x-1.6"
+; Information added by drupal.org packaging script on 2013-10-25
+version = "7.x-1.7"
 core = "7.x"
 project = "r4032login"
-datestamp = "1377882711"
+datestamp = "1382739328"
 
diff --git a/profiles/commons/modules/contrib/r4032login/r4032login.install b/profiles/commons/modules/contrib/r4032login/r4032login.install
index 18b9a6a..940a74b 100644
--- a/profiles/commons/modules/contrib/r4032login/r4032login.install
+++ b/profiles/commons/modules/contrib/r4032login/r4032login.install
@@ -26,6 +26,8 @@ function r4032login_uninstall() {
   variable_del('r4032login_display_denied_message');
   variable_del('r4032login_access_denied_message');
   variable_del('r4032login_user_login_path');
+  variable_del('r4032login_default_redirect_code');
+  variable_del('r4032login_match_noredirect_pages');
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/r4032login/r4032login.module b/profiles/commons/modules/contrib/r4032login/r4032login.module
index 45928fa..497c85f 100644
--- a/profiles/commons/modules/contrib/r4032login/r4032login.module
+++ b/profiles/commons/modules/contrib/r4032login/r4032login.module
@@ -39,7 +39,8 @@ function r4032login_form_system_site_information_settings_alter(&$form, &$form_s
     '#default_value' => variable_get('r4032login_display_denied_message', TRUE),
   );
   $form['error_page']['r4032login_access_denied_message'] = array(
-    '#type' => 'textfield',
+    '#type' => 'textarea',
+    '#rows' => 1,
     '#weight' => 6,
     '#title' => t("User login 'access denied' message"),
     '#default_value' => variable_get('r4032login_access_denied_message', t('Access denied. You must log in to view this page.')),
@@ -63,6 +64,28 @@ function r4032login_form_system_site_information_settings_alter(&$form, &$form_s
     '#description' => t('The path to the user login form. Omit the beginning slash, ie: user/login'),
     '#default_value' => variable_get('r4032login_user_login_path', 'user/login'),
   );
+  $options = array('301' => '301 Moved Permanently', '302' => '302 Found');
+  $form['error_page']['r4032login_default_redirect_code'] = array(
+    '#type' => 'select',
+    '#weight' => 9,
+    '#title' => t("HTTP redirect code"),
+    '#description' => t('The redirect code to send. 301 responses may be cached by browsers and proxies, so 302 is normally the correct choice.'),
+    '#options' => $options,
+    '#default_value' => variable_get('r4032login_default_redirect_code', 302),
+  );
+  $form['error_page']['matching_paths'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Skip redirect for matching pages'),
+    '#collapsible' => TRUE,
+    '#collapsed' => TRUE,
+    '#weight' => 10,
+  );
+  $form['error_page']['matching_paths']['r4032login_match_noredirect_pages'] = array(
+    '#type' => 'textarea',
+    '#title' => '<span class="element-invisible">' . t('Only the listed pages') . '</span>',
+    '#default_value' => variable_get('r4032login_match_noredirect_pages', ''),
+    '#description' => t('Instead of redirecting, the user will get an access deined response and see the standard login form. This may be useful when the response code is important - such as for removing outdated content from search engines.  Use the path node/* for all content.') . ' ' . t("Specify pages by using their paths. Enter one path per line. The '*' character is a wildcard. Example paths are %blog for the blog page and %blog-wildcard for every personal blog. %front is the front page.", array('%blog' => 'blog', '%blog-wildcard' => 'blog/*', '%front' => '<front>')),
+  );
   return system_settings_form($form);
 }
 
@@ -87,13 +110,41 @@ function r4032login_theme() {
 function r4032login_redirect() {
   global $user, $language;
   if (user_is_anonymous()) {
-    if (variable_get('r4032login_display_denied_message', TRUE)) {
+    // Show the access denied message.
+    if (variable_get('r4032login_display_denied_message', TRUE) && empty($_POST)) {
       $message = variable_get('r4032login_access_denied_message', t('Access denied. You must log in to view this page.'));
-      drupal_set_message(t($message), 'error');
+      drupal_set_message($message, 'error');
     }
+    $page_match = FALSE;
+    $pages = variable_get('r4032login_match_noredirect_pages', '');
+    if ($pages) {
+      // When on an access denied page, Drupal stores the original path in
+      // $_GET['destination'] in drupal_deliver_html_page().
+      // Convert the Drupal path to lowercase.
+      $path = drupal_strtolower(drupal_get_path_alias($_GET['destination']));
+      // Compare the lowercase internal and lowercase path alias (if any).
+      $page_match = drupal_match_path($path, $pages);
+      if ($path != $_GET['destination']) {
+        $page_match = $page_match || drupal_match_path($_GET['destination'], $pages);
+      }
+    }
+    if ($page_match) {
+      // Display the default login page.
+      return drupal_get_form('user_login');
+    }
+    // Handle redirection to the login form.
     // using drupal_goto() with destination set causes a recursive redirect loop
     $login_path = variable_get('r4032login_user_login_path', 'user/login');
-    header('Location: ' . url($login_path, array('query' => drupal_get_destination(), 'absolute' => TRUE)), TRUE, 302);
+    $code = variable_get('r4032login_default_redirect_code', 302);
+    // The code in drupal_get_destination() doesn't preserve any query string
+    // on 403 pages, so reproduce the part we want here.
+    $path = $_GET['destination'];
+    $query = drupal_http_build_query(drupal_get_query_parameters(NULL, array('q', 'destination')));
+    if ($query != '') {
+      $path .= '?' . $query;
+    }
+    $destination = array('destination' => $path);
+    header('Location: ' . url($login_path, array('query' => $destination, 'absolute' => TRUE)), TRUE, $code);
     drupal_exit();
   }
   else {
diff --git a/profiles/commons/modules/contrib/r4032login/r4032login.variable.inc b/profiles/commons/modules/contrib/r4032login/r4032login.variable.inc
new file mode 100644
index 0000000..65159de
--- /dev/null
+++ b/profiles/commons/modules/contrib/r4032login/r4032login.variable.inc
@@ -0,0 +1,75 @@
+<?php
+
+/**
+ * @file
+ * Variable information.
+ */
+
+/**
+ * Implements hook_variable_info().
+ */
+function r4032login_variable_info($options) {
+  $variables['r4032login_display_denied_message'] = array(
+    'type' => 'boolean',
+    'title' => t('Display access denied message on login page', array(), $options),
+    'default' => 1,
+    'description' => t('Displays an access denied message on the user login page.', array(), $options),
+    'group' => 'r4032login',
+  );
+  $variables['r4032login_access_denied_message'] = array(
+    'type' => 'string',
+    'title' => t("User login 'access denied' message", array(), $options),
+    'default' => t('Access denied. You must log in to view this page.', array(), $options),
+    'description' => t('The message text displayed to users who are denied access to the page.', array(), $options),
+    'group' => 'r4032login',
+  );
+  $variables['r4032login_redirect_authenticated_users_to'] = array(
+    'type' => 'drupal_path',
+    'title' => t('Redirect authenticated users to', array(), $options),
+    'default' => '',
+    'description' => t('If an authenticated user tries to access a page they can not, redirect them to the given page. Use &lt;front&gt; for the front page, leave blank for a default access denied page.', array(), $options),
+    'group' => 'r4032login',
+  );
+  $variables['r4032login_user_login_path'] = array(
+    'type' => 'drupal_path',
+    'title' => t('Path to user login form', array(), $options),
+    'default' => 'user/login',
+    'description' => t('The path to the user login form. Omit the beginning slash, ie: user/login', array(), $options),
+    'group' => 'r4032login',
+  );
+  $variables['r4032login_default_redirect_code'] = array(
+    'type' => 'select',
+    'title' => t("HTTP default redirect code"),
+    'description' => t('The redirect code to send by default. 301 responses may be cached by browsers and proxies.'),
+    'default_value' => 302,
+    'group' => 'r4032login',
+  );
+  $variables['r4032login_match_redirect_code'] = array(
+    'type' => 'select',
+    'title' => t("HTTP redirect code to use for matching pages"),
+    'description' => t('The redirect code to send for paths that match. 301 responses may be cached by browsers and proxies.'),
+    'default' => 301,
+  );
+  $variables['r4032login_match_redirect_pages'] = array(
+    'type' => 'drupal_path',
+    'title' => t('Specify matching pages by using their paths.'),
+    'default' =>  '',
+    'description' => t("Specify pages by using their paths. Enter one path per line. The '*' character is a wildcard. Example paths are %blog for the blog page and %blog-wildcard for every personal blog. %front is the front page.", array('%blog' => 'blog', '%blog-wildcard' => 'blog/*', '%front' => '<front>')),
+    'group' => 'r4032login',
+  );
+  return $variables;
+}
+
+/**
+ * Implements hook_variable_group_info().
+ */
+function r4032login_variable_group_info() {
+  $groups['r4032login'] = array(
+    'title' => t('Redirect 403 to User Login'),
+    'description' => t('Redirect anonymous users from 403 Access Denied pages to the user/login page.'),
+    'access' => 'administer site configuration',
+    'path' => array('admin/config/system/site-information'),
+  );
+
+  return $groups;
+}
diff --git a/profiles/commons/modules/contrib/radioactivity/LICENSE.txt b/profiles/commons/modules/contrib/radioactivity/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/radioactivity/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
index da95162..799f14c 100644
--- a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
+++ b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
@@ -12,9 +12,9 @@ features[radioactivity_decay_profile][] = default_now
 features[radioactivity_decay_profile][] = default_weekly
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1382042534"
+datestamp = "1387568914"
 
diff --git a/profiles/commons/modules/contrib/radioactivity/radioactivity.info b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
index 35e94a2..e1c771d 100644
--- a/profiles/commons/modules/contrib/radioactivity/radioactivity.info
+++ b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
@@ -13,9 +13,9 @@ files[] = includes/RadioactivityMemcachedIncidentStorage.inc
 files[] = includes/RadioactivityIncident.inc
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1382042534"
+datestamp = "1387568914"
 
diff --git a/profiles/commons/modules/contrib/registration/PATCHES.txt b/profiles/commons/modules/contrib/registration/PATCHES.txt
deleted file mode 100644
index 9bd8d15..0000000
--- a/profiles/commons/modules/contrib/registration/PATCHES.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-The following patches have been applied to this project:
-- http://drupal.org/files/entity_cache_support-1867564-4.patch
-
-This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/registration/registration.js b/profiles/commons/modules/contrib/registration/registration.js
deleted file mode 100644
index 5748b74..0000000
--- a/profiles/commons/modules/contrib/registration/registration.js
+++ /dev/null
@@ -1,19 +0,0 @@
-(function ($) {
-
-  /**
-   * Ensure only a single default is selected.
-   */
-  Drupal.behaviors.registration = {
-    attach:function (context, settings) {
-      $('.reg-default').click(function () {
-        var $checked = $(this);
-        $('.reg-default').each(function () {
-          if ($(this).attr('id') !== $checked.attr('id')) {
-            $(this).removeAttr('checked');
-          }
-        });
-      });
-    }
-  };
-
-})(jQuery);
diff --git a/profiles/commons/modules/contrib/registry_rebuild/LICENSE.txt b/profiles/commons/modules/contrib/registry_rebuild/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/registry_rebuild/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/registry_rebuild/README.txt b/profiles/commons/modules/contrib/registry_rebuild/README.txt
deleted file mode 100644
index ed6fb4a..0000000
--- a/profiles/commons/modules/contrib/registry_rebuild/README.txt
+++ /dev/null
@@ -1,70 +0,0 @@
-Registry Rebuild
-----------------
-
-THIS IS NOT A MODULE. PLEASE READ BELOW.
-
-There are times in Drupal 7+ when the registry gets hopelessly hosed and you
-need to rebuild the registry (a list of PHP classes and the files they go with).
-Sometimes, though, you can't do this regular cache-clear activity because some
-class is required when the system is trying to bootstrap. 
-
-When would you need Registry Rebuild?
--------------------------------------
-
-You might get something like:
-
-PHP Fatal error:  Class 'EntityAPIControllerExportable' not found in 
-...sites/all/modules/rules/includes/rules.core.inc on line 11
-
-If this happens when you're trying to run update.php, and happens when you're 
-trying to clear your cache, well, you have some trouble. That's what Registry
-Rebuild is for.
-
-When would you *not* need Registry Rebuild?
--------------------------------------------
-If you can access any page, or install a module, or run update.php, you almost
-certainly don't need Registry Rebuild.
-
-You can run registry_rebuild with or without drush. See below.
-
-How To Use It (with drush)
---------------------------
-1. Make a backup of your database.
-2. drush dl registry_rebuild will download the current recommended version and
-   place it in your .drush folder. Or you can copy the directory 
-   registry_rebuild from this package into your
-   ~/.drush folder (or other appropriate folder)
-3. Run "drush rr"
-
-How To Use It (without drush)
------------------------------
-This isn't really a module, but it's just packaged as a module to make it so 
-it's easy to find and people can download it as a package.
-
-1. Make a backup of your database.
-2. Download and install as usual where you put modules (sites/all/modules is 
-   most common)
-3. You don't need to enable it. If you were able to enable it you wouldn't 
-   need it. See above.
-4. Either run it from the command line:
-   cd sites/all/modules/registry_rebuild
-   php registry_rebuild.php
-   OR
-   point your web browser to 
-   http://example.com/sites/all/modules/registry_rebuild/registry_rebuild.php
-   Changing "example.com" to your own site's base URL of course.
-4. You should see something like this:
-
-DRUPAL_ROOT is /home/rfay/workspace/commerce.
-There were 631 files in the registry before and 508 files now.
-If you don't see any crazy fatal errors, your registry has been rebuilt. You will probably want to flush your caches now.
-
-5. Hopefully you'll now be able to go about your affairs in peace, updating,
-   clearing cache, etc.
-   
-This package comes with no guarantee explicit or implicit.
-
-There's no reason it should do any harm to your install. But there can be lots
-of things wrong with a system, and the registry problem is not the fix for
-everything.
-
diff --git a/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.drush.inc b/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.drush.inc
deleted file mode 100644
index c67b859..0000000
--- a/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.drush.inc
+++ /dev/null
@@ -1,229 +0,0 @@
-<?php
-/**
- * @file
- * Provide Drush integration for release building and dependency building.
- */
-
-/**
- * Implements hook_drush_help().
- */
-function registry_rebuild_drush_help($section) {
-  switch ($section) {
-    case 'drush:registry-rebuild':
-      return dt('Rebuild the registry or module cache in a Drupal install.');
-  }
-}
-
-/**
- * Implements hook_drush_command().
- */
-function registry_rebuild_drush_command() {
-  $items = array();
-
-  $items['registry-rebuild'] = array(
-    'description' => 'Rebuild the registry table (for classes) and the system table (for module locations) in a Drupal install.',
-    'callback' => 'drush_registry_rebuild',
-    'bootstrap' => DRUSH_BOOTSTRAP_DRUSH, // No bootstrap.
-    'options' => array(
-      'no-cache-clear' => 'Rebuild the registry only, do not clear caches.',
-      'fire-bazooka' => 'Truncate registry and registry_file tables to build them from scratch.',
-    ),
-    'examples' => array(
-      'drush rr --no-cache-clear' => 'Rebuild the registry only, do not clear caches.',
-      'drush rr --fire-bazooka' => 'Truncate registry and registry_file tables to build them from scratch.',
-    ),
-    'aliases' => array('rr'),
-  );
-
-  return $items;
-}
-
-/**
- * Rebuild the registry.
- *
- * Before calling this we need to be bootstrapped to DRUPAL_BOOTSTRAP_DATABASE.
- */
-function drush_registry_rebuild() {
-  define('MAINTENANCE_MODE', 'update');
-  ini_set('memory_limit', -1);
-  if (!drush_bootstrap_to_phase(DRUSH_BOOTSTRAP_DRUPAL_DATABASE)) {
-    return drush_set_error('DRUPAL_SITE_NOT_FOUND', dt('You need to specify an alias or run this command within a drupal site.'));
-  }
-  $include_dir = DRUPAL_ROOT . '/includes';
-  $module_dir = DRUPAL_ROOT . '/modules';
-  // Use core directory if it exists.
-  if (file_exists(DRUPAL_ROOT . '/core/includes/bootstrap.inc')) {
-    $include_dir = DRUPAL_ROOT . '/core/includes';
-    $module_dir = DRUPAL_ROOT . '/core/modules';
-  }
-
-  $includes = array(
-    $include_dir . '/bootstrap.inc',
-    $include_dir . '/common.inc',
-    $include_dir . '/database.inc',
-    $include_dir . '/schema.inc',
-    $include_dir . '/actions.inc',
-    $include_dir . '/entity.inc',
-    $module_dir . '/entity/entity.module',
-    $module_dir . '/entity/entity.controller.inc',
-    $module_dir . '/system/system.module',
-    $include_dir . '/database/query.inc',
-    $include_dir . '/database/select.inc',
-    $include_dir . '/registry.inc',
-    $include_dir . '/module.inc',
-    $include_dir . '/menu.inc',
-    $include_dir . '/file.inc',
-    $include_dir . '/theme.inc',
-  );
-
-  if (drush_drupal_major_version() == 7) {
-    $cache_lock_path = DRUPAL_ROOT . '/'. variable_get('lock_inc', 'includes/lock.inc');
-    // Ensure that the configured lock.inc really exists at that location and
-    // is accessible. Otherwise we use the core lock.inc as fallback.
-    if (!is_readable($cache_lock_path)) {
-      drush_log(dt('Could not load configured variant of lock.inc. Use core implementation as fallback.'), 'warning');
-      $cache_lock_path = DRUPAL_ROOT . '/includes/lock.inc';
-    }
-    $includes[] = $cache_lock_path;
-  }
-  elseif (drush_drupal_major_version() > 7) {
-    // TODO
-    // http://api.drupal.org/api/drupal/namespace/Drupal!Core!Lock/8
-  }
-  // In Drupal 6 the configured lock.inc is already loaded during
-  // DRUSH_BOOTSTRAP_DRUPAL_DATABASE
-
-  foreach ($includes as $include) {
-    if (file_exists($include)) {
-      require_once($include);
-    }
-  }
-
-  // This section is not functionally important. It's just getting the
-  // registry_parsed_files() so that it can report the change.
-  // Note that it works with Drupal 7 only.
-  if (drush_drupal_major_version() == 7) {
-    $connection_info = Database::getConnectionInfo();
-    $driver = $connection_info['default']['driver'];
-    require_once $include_dir . '/database/' . $driver . '/query.inc';
-    $parsed_before = registry_get_parsed_files();
-  }
-
-  if (drush_drupal_major_version() == 7) {
-    cache_clear_all('lookup_cache', 'cache_bootstrap');
-    cache_clear_all('variables', 'cache_bootstrap');
-    cache_clear_all('module_implements', 'cache_bootstrap');
-    drush_log(dt('Bootstrap caches have been cleared in the pre-DRUPAL_BOOTSTRAP_FULL phase.'));
-  }
-  elseif (drush_drupal_major_version() > 7) {
-    cache('bootstrap')->deleteAll();
-    drush_log(dt('Bootstrap caches have been cleared in the pre-DRUPAL_BOOTSTRAP_FULL phase.'));
-  }
-
-  if (drush_drupal_major_version() == 7) {
-    registry_rebuild();  // Drupal 7 compatible only
-  }
-  elseif (drush_drupal_major_version() > 7) {
-    system_rebuild_module_data();  // Drupal 8 compatible
-  }
-  else {
-    return drush_module_cache_rebuild(); // Drupal 5 and 6 compatible
-  }
-
-  drush_log(dt('The registry has been rebuilt in the pre-DRUPAL_BOOTSTRAP_FULL phase.'), 'success');
-
-  drush_log(dt('Bootstrapping to DRUPAL_BOOTSTRAP_FULL.'));
-  drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);
-  drush_log(dt('Doing registry_rebuild() in DRUPAL_BOOTSTRAP_FULL.'));
-
-  if (!drush_get_option('no-cache-clear')) {
-    db_truncate('cache');
-    drush_log(dt('The cache table truncated in DRUPAL_BOOTSTRAP_FULL.'));
-  }
-  if (drush_get_option('fire-bazooka')) {
-    db_truncate('registry');
-    drush_log(dt('The registry table truncated in DRUPAL_BOOTSTRAP_FULL.'));
-    db_truncate('registry_file');
-    drush_log(dt('The registry_file table truncated in DRUPAL_BOOTSTRAP_FULL.'));
-  }
-
-  if (drush_drupal_major_version() == 7) {
-    registry_rebuild();  // Drupal 7 compatible only
-  }
-  elseif (drush_drupal_major_version() > 7) {
-    system_rebuild_module_data();  // Drupal 8 compatible
-  }
-  else {
-    return drush_module_cache_rebuild(); // Drupal 5 and 6 compatible
-  }
-
-  if (drush_drupal_major_version() == 7) {
-    $parsed_after = registry_get_parsed_files();
-    // Remove files which don't exist anymore.
-    $filenames = array();
-    foreach ($parsed_after as $filename => $file) {
-      if (!file_exists($filename)) {
-        $filenames[] = $filename;
-      }
-    }
-    if (!empty($filenames)) {
-      db_delete('registry_file')
-        ->condition('filename', $filenames)
-        ->execute();
-      db_delete('registry')
-        ->condition('filename', $filenames)
-        ->execute();
-      $dt_args = array(
-        '@files' => implode(', ', $filenames),
-      );
-      $singular = 'Manually deleted 1 stale file from the registry.';
-      $plural   = 'Manually deleted @count stale files from the registry.';
-      drush_log(format_plural(count($filenames), $singular, $plural), 'success');
-      $singular = "A file has been declared in a module's .info, but could not be found. This is probably indicative of a bug. The missing file is @files.";
-      $plural   = "@count files were declared in a module's .info, but could not be found. This is probably indicative of a bug. The missing files are @files.";
-      drush_log(format_plural(count($filenames), $singular, $plural, $dt_args), 'warning');
-    }
-    $parsed_after = registry_get_parsed_files();
-    $message = 'There were @parsed_before files in the registry before and @parsed_after files now.';
-    $dt_args = array(
-      '@parsed_before' => count($parsed_before),
-      '@parsed_after'  => count($parsed_after),
-    );
-    drush_log(dt($message, $dt_args));
-  }
-
-  drush_log(dt('The registry has been rebuilt in DRUPAL_BOOTSTRAP_FULL.'), 'success');
-
-  if (!drush_get_option('no-cache-clear')) {
-    if (drush_drupal_major_version() <= 7) {
-      drush_drupal_cache_clear_all();
-      drush_log(dt('All caches have been cleared with drush_drupal_cache_clear_all.'));
-    }
-    else {
-      drupal_flush_all_caches();
-      drush_log(dt('All caches have been cleared with drupal_flush_all_caches.'));
-    }
-  }
-  else {
-    drush_log(dt('The caches have not been cleared. It is recommended you clear the Drupal caches as soon as possible.'), 'warning');
-  }
-}
-
-/**
- * Rebuild for D6 (which really just means rebuilding the menu/system table).
- */
-function drush_module_cache_rebuild() {
-  drush_log(dt('module_rebuild_cache() in DRUSH_BOOTSTRAP_DRUPAL_DATABASE.'));
-  module_list(TRUE, FALSE);
-  module_rebuild_cache();
-  drush_log(dt('Module cache has been rebuilt.'));
-  drush_log(dt('Bootstrapping to DRUPAL_BOOTSTRAP_FULL.'));
-  drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);
-  if (!drush_get_option('no-cache-clear')) {
-    drush_drupal_cache_clear_all();
-    drush_log(dt('All caches have been cleared with drush_drupal_cache_clear_all.'));
-  }
-  else {
-    drush_log(dt('The caches have not been cleared. It is recommended you clear the Drupal caches as soon as possible.'), 'warning');
-  }
-}
diff --git a/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.php b/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.php
deleted file mode 100644
index f495501..0000000
--- a/profiles/commons/modules/contrib/registry_rebuild/registry_rebuild.php
+++ /dev/null
@@ -1,178 +0,0 @@
-<?php
-
-/**
- * Root directory of Drupal installation. Note that you can change this
- * if you need to. It just has to point to the actual root. This assumes
- * that the php file is being run in sites/all/modules/registry_rebuild.
- */
-
-ini_set('memory_limit', -1);
-define('DRUPAL_ROOT', define_drupal_root());
-chdir(DRUPAL_ROOT);
-print "DRUPAL_ROOT is " . DRUPAL_ROOT . ".<br/>\n";
-define('MAINTENANCE_MODE', 'update');
-
-global $_SERVER;
-$_SERVER['REMOTE_ADDR'] = 'nothing';
-
-global $include_dir;
-$include_dir = DRUPAL_ROOT . '/includes';
-$module_dir = DRUPAL_ROOT . '/modules';
-// Use core directory if it exists.
-if (file_exists(DRUPAL_ROOT . '/core/includes/bootstrap.inc')) {
-  $include_dir = DRUPAL_ROOT . '/core/includes';
-  $module_dir = DRUPAL_ROOT . '/core/modules';
-}
-
-$includes = array(
-  $include_dir . '/bootstrap.inc',
-  $include_dir . '/common.inc',
-  $include_dir . '/database.inc',
-  $include_dir . '/schema.inc',
-  $include_dir . '/actions.inc',
-  $include_dir . '/entity.inc',
-  $module_dir . '/entity/entity.module',
-  $module_dir . '/entity/entity.controller.inc',
-  $module_dir . '/system/system.module',
-  $include_dir . '/database/query.inc',
-  $include_dir . '/database/select.inc',
-  $include_dir . '/registry.inc',
-  $include_dir . '/module.inc',
-  $include_dir . '/menu.inc',
-  $include_dir . '/file.inc',
-  $include_dir . '/theme.inc',
-);
-
-if (function_exists('registry_rebuild')) { // == D7
-  $cache_lock_path = DRUPAL_ROOT . '/'. variable_get('lock_inc', 'includes/lock.inc');
-  // Ensure that the configured lock.inc really exists at that location and
-  // is accessible. Otherwise we use the core lock.inc as fallback.
-  if (!is_readable($cache_lock_path)) {
-    print "Could not load configured variant of lock.inc. Use core implementation as fallback.<br/>\n";
-    $cache_lock_path = DRUPAL_ROOT . '/includes/lock.inc';
-  }
-  $includes[] = $cache_lock_path;
-}
-elseif (!function_exists('cache_clear_all')) { // D8+
-  // TODO
-  // http://api.drupal.org/api/drupal/namespace/Drupal!Core!Lock/8
-}
-// In Drupal 6 the configured lock.inc is already loaded during
-// DRUSH_BOOTSTRAP_DRUPAL_DATABASE
-
-foreach ($includes as $include) {
-  if (file_exists($include)) {
-    require_once($include);
-  }
-}
-
-print "Bootstrapping to DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-drupal_bootstrap(DRUPAL_BOOTSTRAP_SESSION);
-
-registry_rebuild_rebuild();
-
-/**
- * Find the drupal root directory by looking in parent directories.
- * If unable to discover it, fail and exit.
- */
-function define_drupal_root() {
-  // This is the smallest number of directories to go up: from /sites/all/modules/registry_rebuild.
-  $parent_count = 4;
-  // 8 seems reasonably far to go looking up.
-  while ($parent_count < 8) {
-    $dir = realpath(getcwd() . str_repeat('/..', $parent_count));
-    if (file_exists($dir . '/index.php')) {
-      return $dir;
-    }
-    $parent_count++;
-  }
-  print "Failure: Unable to discover DRUPAL_ROOT. You may want to explicitly define it near the top of registry_rebuild.php";
-  exit(1);
-}
-
-/**
- * Before calling this we need to be bootstrapped to DRUPAL_BOOTSTRAP_SESSION.
- */
-function registry_rebuild_rebuild() {
-  // This section is not functionally important. It's just getting the
-  // registry_parsed_files() so that it can report the change.
-  // Note that it works with Drupal 7 only.
-  if (function_exists('registry_rebuild')) {
-    $connection_info = Database::getConnectionInfo();
-    $driver = $connection_info['default']['driver'];
-    global $include_dir;
-    require_once $include_dir . '/database/' . $driver . '/query.inc';
-    $parsed_before = registry_get_parsed_files();
-  }
-
-  if (function_exists('registry_rebuild')) { // == D7
-    cache_clear_all('lookup_cache', 'cache_bootstrap');
-    cache_clear_all('variables', 'cache_bootstrap');
-    cache_clear_all('module_implements', 'cache_bootstrap');
-    print "Bootstrap caches have been cleared in DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-  }
-  elseif (!function_exists('cache_clear_all')) { // D8+
-    cache('bootstrap')->deleteAll();
-    print "Bootstrap caches have been cleared in DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-  }
-
-  if (function_exists('registry_rebuild')) {
-    print "Doing registry_rebuild() in DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-    registry_rebuild();  // Drupal 7 compatible only
-  }
-  elseif (function_exists('module_rebuild_cache')) {
-    print "Doing module_rebuild_cache() in DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-    module_rebuild_cache();  // Drupal 5 and 6 compatible only
-  }
-  else {
-    print "Doing system_rebuild_module_data() in DRUPAL_BOOTSTRAP_SESSION<br/>\n";
-    system_rebuild_module_data();  // Drupal 8 compatible
-  }
-
-  print "Bootstrapping to DRUPAL_BOOTSTRAP_FULL<br/>\n";
-  drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);
-  db_truncate('cache');
-
-  if (function_exists('registry_rebuild')) {
-    print "Doing registry_rebuild() in DRUPAL_BOOTSTRAP_FULL<br/>\n";
-    registry_rebuild();  // Drupal 7 compatible only
-  }
-  elseif (function_exists('module_rebuild_cache')) {
-    print "Doing module_rebuild_cache() in DRUPAL_BOOTSTRAP_FULL<br/>\n";
-    module_rebuild_cache();  // Drupal 5 and 6 compatible only
-  }
-  else {
-    print "Doing system_rebuild_module_data() in DRUPAL_BOOTSTRAP_FULL<br/>\n";
-    system_rebuild_module_data();  // Drupal 8 compatible
-  }
-
-  if (function_exists('registry_rebuild')) { // Drupal 7 compatible only
-    $parsed_after = registry_get_parsed_files();
-    // Remove files which don't exist anymore.
-    $filenames = array();
-    foreach ($parsed_after as $filename => $file) {
-      if (!file_exists($filename)) {
-        $filenames[] = $filename;
-      }
-    }
-    if (!empty($filenames)) {
-      db_delete('registry_file')
-        ->condition('filename', $filenames)
-        ->execute();
-      db_delete('registry')
-        ->condition('filename', $filenames)
-        ->execute();
-      print("Deleted " . count($filenames) . ' stale files from registry manually.');
-    }
-    $parsed_after = registry_get_parsed_files();
-    print "Flushing all caches<br/>\n";
-    drupal_flush_all_caches();
-    print "There were " . count($parsed_before) . " files in the registry before and " . count($parsed_after) . " files now.<br/>\n";
-    print "If you don't see any crazy fatal errors, your registry has been rebuilt.<br/>\n";
-  }
-  else {
-    print "Flushing all caches<br/>\n";
-    drupal_flush_all_caches();
-    print "If you don't see any crazy fatal errors, your registry has been rebuilt.<br/>\n";
-  }
-}
diff --git a/profiles/commons/modules/contrib/rich_snippets/rich_snippets.preprocess.inc b/profiles/commons/modules/contrib/rich_snippets/rich_snippets.preprocess.inc
index 4023937..afec902 100644
--- a/profiles/commons/modules/contrib/rich_snippets/rich_snippets.preprocess.inc
+++ b/profiles/commons/modules/contrib/rich_snippets/rich_snippets.preprocess.inc
@@ -12,10 +12,7 @@
  *   An associative array of template variables.
  */
 function rich_snippets_default_preprocessor(&$variables) {
-  // Rich snippets should not go any further if the result doesn't contain a node object
-  if (!isset($variables['result']['node'])) {
-    return;
-  }
+
   // Build the date, remove it from search info.
   if (isset($variables['result']['date'])) {
     $date = theme('rich_snippets_date', array('date' => $variables['result']['date']));
diff --git a/profiles/commons/modules/contrib/rules/modules/system.eval.inc b/profiles/commons/modules/contrib/rules/modules/system.eval.inc
index a15f217..a27225f 100644
--- a/profiles/commons/modules/contrib/rules/modules/system.eval.inc
+++ b/profiles/commons/modules/contrib/rules/modules/system.eval.inc
@@ -123,11 +123,17 @@ function rules_action_mail_to_users_of_role($roles, $subject, $message, $from =
   $message = array('result' => TRUE);
   foreach ($result as $row) {
     $message = drupal_mail('rules', $key, $row->mail, language_default(), $params, $from);
-    if (!$message['result']) {
+    // If $message['result'] is FALSE, then it's likely that email sending is
+    // failing at the moment, and we should just abort sending any more. If
+    // however, $mesage['result'] is NULL, then it's likely that a module has
+    // aborted sending this particular email to this particular user, and we
+    // should just keep on sending emails to the other users.
+    // For more information on the result value, see drupal_mail().
+    if ($message['result'] === FALSE) {
       break;
     }
   }
-  if ($message['result']) {
+  if ($message['result'] !== FALSE) {
     $role_names = array_intersect_key(user_roles(TRUE), array_flip($roles));
     watchdog('rules', 'Successfully sent email to the role(s) %roles.', array('%roles' => implode(', ', $role_names)));
   }
diff --git a/profiles/commons/modules/contrib/rules/modules/user.eval.inc b/profiles/commons/modules/contrib/rules/modules/user.eval.inc
index 57e255c..d7bb823 100644
--- a/profiles/commons/modules/contrib/rules/modules/user.eval.inc
+++ b/profiles/commons/modules/contrib/rules/modules/user.eval.inc
@@ -98,5 +98,36 @@ function rules_action_user_unblock($account) {
 }
 
 /**
+ * Action: Send a user account e-mail.
+ */
+function rules_action_user_send_account_email($account, $email_type) {
+  // If we received an authenticated user account...
+  if (!empty($account->uid)) {
+    $types = rules_user_account_email_options_list();
+
+    // Attempt to send the account e-mail.
+    // This code is adapted from _user_mail_notify().
+    $params = array('account' => $account);
+    $language = user_preferred_language($account);
+    $mail = drupal_mail('user', $email_type, $account->mail, $language, $params);
+    if ($email_type == 'register_pending_approval') {
+      // If a user registered requiring admin approval, notify the admin, too.
+      // We use the site default language for this.
+      drupal_mail('user', 'register_pending_approval_admin', variable_get('site_mail', ini_get('sendmail_from')), language_default(), $params);
+    }
+
+    $result = empty($mail) ? NULL : $mail['result'];
+
+    // Log the success or failure.
+    if ($result) {
+      watchdog('rules', '%type e-mail sent to %recipient.', array('%type' => $types[$email_type], '%recipient' => $account->mail));
+    }
+    else {
+      watchdog('rules', 'Failed to send %type e-mail to %recipient.', array('%type' => $types[$email_type], '%recipient' => $account->mail));
+    }
+  }
+}
+
+/**
  * @}
  */
diff --git a/profiles/commons/modules/contrib/rules/modules/user.rules.inc b/profiles/commons/modules/contrib/rules/modules/user.rules.inc
index f5148e4..3e06b1a 100644
--- a/profiles/commons/modules/contrib/rules/modules/user.rules.inc
+++ b/profiles/commons/modules/contrib/rules/modules/user.rules.inc
@@ -214,6 +214,24 @@ function rules_user_action_info() {
     'label' => t('Unblock a user'),
     'base' => 'rules_action_user_unblock',
   );
+  $items['user_send_account_email'] = array(
+    'label' => t('Send account e-mail'),
+    'parameter' => array(
+      'account' => array(
+        'type' => 'user',
+        'label' => t('Account'),
+      ),
+      'email_type' => array(
+        'type' => 'text',
+        'label' => t('E-mail type'),
+        'description' => t("Select the e-mail based on your site's account settings to send to the user."),
+        'options list' => 'rules_user_account_email_options_list',
+      ),
+    ),
+    'group' => t('User'),
+    'base' => 'rules_action_user_send_account_email',
+    'access callback' => 'rules_user_integration_access',
+  );
   return $items;
 }
 
@@ -232,5 +250,23 @@ function rules_user_roles_options_list($element) {
 }
 
 /**
+ * Options list callback for user account e-mail types.
+ *
+ * @see _user_mail_notify()
+ */
+function rules_user_account_email_options_list() {
+  return array(
+    'register_admin_created' => t('Welcome (new user created by administrator)'),
+    'register_no_approval_required' => t('Welcome (no approval required)'),
+    'register_pending_approval' => t('Welcome (awaiting approval)'),
+    'password_reset' => t('Password recovery'),
+    'status_activated' => t('Account activation'),
+    'status_blocked' => t('Account blocked'),
+    'cancel_confirm' => t('Account cancellation confirmation'),
+    'status_canceled' => t('Account canceled'),
+  );
+}
+
+/**
  * @}
  */
diff --git a/profiles/commons/modules/contrib/rules/rules.info b/profiles/commons/modules/contrib/rules/rules.info
index 9d249b7..adb9856 100644
--- a/profiles/commons/modules/contrib/rules/rules.info
+++ b/profiles/commons/modules/contrib/rules/rules.info
@@ -22,10 +22,9 @@ files[] = ui/ui.plugins.inc
 dependencies[] = entity_token
 dependencies[] = entity
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/rules/rules.install b/profiles/commons/modules/contrib/rules/rules.install
index 8833383..1a81d2f 100644
--- a/profiles/commons/modules/contrib/rules/rules.install
+++ b/profiles/commons/modules/contrib/rules/rules.install
@@ -479,3 +479,24 @@ function rules_update_7212() {
   drupal_static_reset('system_rebuild_module_data');
   registry_rebuild();
 }
+
+/**
+ * Recover the "owner" property for broken configurations.
+ */
+function rules_update_7213() {
+  $rows= db_select('rules_config', 'c')
+    ->fields('c')
+    ->condition('status', ENTITY_OVERRIDDEN)
+    ->condition('owner', 'rules', '<>')
+    ->execute()
+    ->fetchAllAssoc('id');
+
+  foreach ($rows as $id => $row) {
+    if ($row->module == $row->owner) {
+      db_update('rules_config')
+        ->condition('id', $id)
+        ->fields(array('owner' => 'rules'))
+        ->execute();
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info b/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
index 4ffe957..d8d731b 100644
--- a/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
+++ b/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
@@ -6,10 +6,9 @@ files[] = rules_admin.module
 files[] = rules_admin.inc
 dependencies[] = rules
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info b/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
index 0be6b0f..6e006fc 100644
--- a/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
+++ b/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
@@ -7,10 +7,9 @@ core = 7.x
 files[] = rules_i18n.i18n.inc
 files[] = rules_i18n.rules.inc
 files[] = rules_i18n.test
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info b/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
index 435f264..65463e7 100644
--- a/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
+++ b/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
@@ -13,10 +13,9 @@ files[] = includes/rules_scheduler.views_default.inc
 files[] = includes/rules_scheduler.views.inc
 files[] = includes/rules_scheduler_views_filter.inc
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/rules/rules_scheduler/tests/rules_scheduler_test.info b/profiles/commons/modules/contrib/rules/rules_scheduler/tests/rules_scheduler_test.info
index 73dfb65..a9fc9d3 100644
--- a/profiles/commons/modules/contrib/rules/rules_scheduler/tests/rules_scheduler_test.info
+++ b/profiles/commons/modules/contrib/rules/rules_scheduler/tests/rules_scheduler_test.info
@@ -5,10 +5,9 @@ core = 7.x
 files[] = rules_scheduler_test.inc
 hidden = TRUE
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/rules/tests/rules_test.info b/profiles/commons/modules/contrib/rules/tests/rules_test.info
index c6feb4f..42373b4 100644
--- a/profiles/commons/modules/contrib/rules/tests/rules_test.info
+++ b/profiles/commons/modules/contrib/rules/tests/rules_test.info
@@ -6,10 +6,9 @@ files[] = rules_test.rules.inc
 files[] = rules_test.rules_defaults.inc
 hidden = TRUE
 
-
-; Information added by drush on 2013-10-17
-version = "7.x-2.5+2-dev"
+; Information added by drupal.org packaging script on 2013-10-29
+version = "7.x-2.6"
 core = "7.x"
 project = "rules"
-datestamp = "1382042520"
+datestamp = "1383063052"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/LICENSE.txt b/profiles/commons/modules/contrib/schemaorg/LICENSE.txt
old mode 100644
new mode 100755
diff --git a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_event/schemaorg_event.info b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_event/schemaorg_event.info
index 82102ac..923aed6 100644
--- a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_event/schemaorg_event.info
+++ b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_event/schemaorg_event.info
@@ -37,9 +37,9 @@ features[variable][] = "node_preview_schemaorg_event"
 features[variable][] = "node_submitted_schemaorg_event"
 features[views_view][] = "events"
 
-; Information added by drupal.org packaging script on 2012-05-21
-version = "7.x-1.0-beta3"
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
 core = "7.x"
 project = "schemaorg"
-datestamp = "1337625394"
+datestamp = "1384874931"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_person/schemaorg_person.info b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_person/schemaorg_person.info
index ff81020..218adf3 100644
--- a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_person/schemaorg_person.info
+++ b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_person/schemaorg_person.info
@@ -28,9 +28,9 @@ features[variable][] = "node_options_schemaorg_person"
 features[variable][] = "node_preview_schemaorg_person"
 features[variable][] = "node_submitted_schemaorg_person"
 
-; Information added by drupal.org packaging script on 2012-05-21
-version = "7.x-1.0-beta3"
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
 core = "7.x"
 project = "schemaorg"
-datestamp = "1337625394"
+datestamp = "1384874931"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_recipe/schemaorg_recipe.info b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_recipe/schemaorg_recipe.info
index 22dbbcf..a670a8e 100644
--- a/profiles/commons/modules/contrib/schemaorg/example/schemaorg_recipe/schemaorg_recipe.info
+++ b/profiles/commons/modules/contrib/schemaorg/example/schemaorg_recipe/schemaorg_recipe.info
@@ -10,9 +10,9 @@ dependencies[] = "schemaorg"
 features[field][] = "node-recipe-field_schemaorg_image"
 features[schemaorg][] = "node-recipe"
 
-; Information added by drupal.org packaging script on 2012-05-21
-version = "7.x-1.0-beta3"
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
 core = "7.x"
 project = "schemaorg"
-datestamp = "1337625394"
+datestamp = "1384874931"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.addressfield.inc b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.addressfield.inc
new file mode 100644
index 0000000..d753076
--- /dev/null
+++ b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.addressfield.inc
@@ -0,0 +1,49 @@
+<?php
+
+/**
+ * @file
+ * Addressfield field formatter specific code for schema.org.
+ */
+
+function schemaorg_contrib_field_preprocess_addressfield(&$variables) {
+  $element = $variables['element'];
+
+  foreach ($element['#items'] as $delta => $item) {
+    // Add typeof attribute to the field item wrapper.
+    $variables['item_attributes_array'][$delta]['typeof'] = 'schema:PostalAddress';
+    // Inject property RDFa attribute on each element of the address field
+    // formatter output.
+    _schemaorg_contrib_addressfield_add_attributes($variables['items'][$delta], $element['#items'][$delta]);
+  }
+}
+
+/**
+ * Helper function to recursively inject RDFa attributes in an address item.
+ */
+function _schemaorg_contrib_addressfield_add_attributes(&$address, $values) {
+  // Define schema.org mappings which will be injected in the addressfield
+  // formatter output.
+  static $mappings = array(
+    'thoroughfare' => 'schema:streetAddress',
+    // 'premise' => // not defined on schema.org
+    'postal_code' => 'schema:postalCode',
+    'locality' => 'schema:addressLocality',
+    'administrative_area' => 'schema:addressRegion',
+    'country' => 'schema:addressCountry',
+  );
+
+  foreach (element_children($address) as $key) {
+    $child = &$address[$key];
+    // Automatically add RDFa property attribute to each address element.
+    if (in_array($key, array_keys($mappings), TRUE)) {
+      $child['#attributes']['property'][] = $mappings[$key];
+      // Use ISO country code as country value.
+      if ($key == 'country' && $values['country']) {
+        $child['#attributes']['content'] = $values['country'];
+      }
+    }
+
+    // Recurse through the child.
+    _schemaorg_contrib_addressfield_add_attributes($child, $values);
+  }
+}
diff --git a/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.fivestar.inc b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.fivestar.inc
new file mode 100644
index 0000000..f2c6f0e
--- /dev/null
+++ b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.fivestar.inc
@@ -0,0 +1,35 @@
+<?php
+
+/**
+ * @file
+ * Fivestar field formatter specific code for schema.org.
+ */
+
+function schemaorg_contrib_field_preprocess_fivestar(&$variables) {
+  $element = $variables['element'];
+
+  foreach ($element['#items'] as $delta => $item) {
+    // Add typeof attribute to the field item wrapper.
+    $variables['item_attributes_array'][$delta]['typeof'] = 'schema:AggregateReview';
+    // Generate RDFa markup for the vote average and count.
+    $metadata_markup = '';
+    if (!empty($element['#items'][$delta]['average'])) {
+      $average = round(($element['#items'][$delta]['average']/100) * 5, 1);
+      $metadata_markup .= '<meta property="schema:average" content="' . $average . '"/>';
+    }
+    if (!empty($element['#items'][$delta]['count'])) {
+      $metadata_markup .= '<meta property="schema:count" content="' . $element['#items'][$delta]['count'] . '"/>';
+    }
+    // Insert markup after fivestar summary.
+    if ($metadata_markup) {
+      // The render array can differ depending on the field formatter settings,
+      // such as for example whether users can vote while viewing (form).
+      if (!empty($variables['items'][$delta]['average']['#description'])) {
+        $variables['items'][$delta]['average']['#description'] .= $metadata_markup;
+      }
+      elseif (!empty($variables['items'][$delta]['vote']['vote']['#description'])) {
+        $variables['items'][$delta]['vote']['vote']['#description'] .= $metadata_markup;
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.info b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.info
new file mode 100644
index 0000000..4797859
--- /dev/null
+++ b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.info
@@ -0,0 +1,13 @@
+name = Schema.org support for contributed modules
+description = Add support for fields from contributed modules such as addressfield and fivestar.
+package = "Schema.org"
+dependencies[] = schemaorg
+core = 7.x
+files[] = schemaorg_contrib.test
+
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
+core = "7.x"
+project = "schemaorg"
+datestamp = "1384874931"
+
diff --git a/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.module b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.module
new file mode 100644
index 0000000..2238286
--- /dev/null
+++ b/profiles/commons/modules/contrib/schemaorg/modules/schemaorg_contrib/schemaorg_contrib.module
@@ -0,0 +1,26 @@
+<?php
+
+/**
+ * @file
+ * Add schema.org support for compound fields from contributed modules.
+ */
+
+/**
+ * Implements MODULE_preprocess_HOOK().
+ */
+function schemaorg_contrib_preprocess_field(&$variables) {
+  $element = $variables['element'];
+  $field_name = $element['#field_name'];
+
+  // Address field module integration.
+  if ($element['#field_type'] == 'addressfield' && $element['#formatter'] == 'addressfield_default' && !empty($element['#object']->rdf_mapping[$field_name]['predicates'])) {
+    module_load_include('inc', 'schemaorg_contrib', 'schemaorg_contrib.addressfield');
+    schemaorg_contrib_field_preprocess_addressfield($variables);
+  }
+
+  // Fivestar module integration.
+  if ($element['#field_type'] == 'fivestar' && !empty($element['#object']->rdf_mapping[$field_name]['predicates'])) {
+    module_load_include('inc', 'schemaorg_contrib', 'schemaorg_contrib.fivestar');
+    schemaorg_contrib_field_preprocess_fivestar($variables);
+  }
+}
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg.features.inc b/profiles/commons/modules/contrib/schemaorg/schemaorg.features.inc
index c84724d..98efd72 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg.features.inc
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg.features.inc
@@ -16,7 +16,7 @@ function schemaorg_features_export($data, &$export, $module_name = '') {
     $bundle_name = $parts[1];
 
     if ($rdf_mapping = rdf_mapping_load($entity_type, $bundle_name)) {
-      $export['features']['schemaorg'][$entity_type . '-' . $bundle_name] = $rdf_mapping;
+      $export['features']['schemaorg'][$entity_type . '-' . $bundle_name] = $entity_type . '-' . $bundle_name;
     }
   }
 
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg.info b/profiles/commons/modules/contrib/schemaorg/schemaorg.info
index 732dc58..f1adea0 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg.info
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg.info
@@ -5,9 +5,9 @@ dependencies[] = rdf
 core = 7.x
 files[] = schemaorg.test
 
-; Information added by drupal.org packaging script on 2012-05-21
-version = "7.x-1.0-beta3"
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
 core = "7.x"
 project = "schemaorg"
-datestamp = "1337625394"
+datestamp = "1384874931"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg.module b/profiles/commons/modules/contrib/schemaorg/schemaorg.module
index 64b260c..9aafa81 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg.module
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg.module
@@ -3,7 +3,7 @@
 /**
  * @file
  * Enables administrators to annotate their structured content with vocabularies
- * from schema.org
+ * from schema.org.
  */
 
 /**
@@ -64,7 +64,7 @@ function schemaorg_rdf_namespaces() {
 }
 
 /**
- * Implementation of hook_features_api().
+ * Implements hook_features_api().
  */
 function schemaorg_features_api() {
   return array(
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/js/schemaorg_ui.terms.json b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/js/schemaorg_ui.terms.json
index 98d113e..81d133e 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/js/schemaorg_ui.terms.json
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/js/schemaorg_ui.terms.json
@@ -1 +1 @@
-{"datatypes":["Boolean","DataType","Date","Float","Integer","Number","Text","URL"],"properties":["about","acceptsReservations","accountablePerson","actors","additionalName","address","addressCountry","addressLocality","addressRegion","affiliation","aggregateRating","albums","alternativeHeadline","alumni","alumniOf","articleBody","articleSection","associatedArticle","associatedMedia","attendees","audio","author","availability","awards","baseSalary","benefits","bestRating","birthDate","bitrate","blogPosts","bookEdition","bookFormat","box","branchOf","brand","breadcrumb","byArtist","calories","caption","carbohydrateContent","children","cholesterolContent","circle","colleagues","comment","commentText","commentTime","contactPoints","contactType","containedIn","contentLocation","contentRating","contentSize","contentURL","contributor","cookTime","cookingMethod","copyrightHolder","copyrightYear","creator","currenciesAccepted","dateCreated","dateModified","datePosted","datePublished","dateline","deathDate","description","director","discusses","discussionUrl","duration","editor","educationRequirements","elevation","email","embedURL","employees","employmentType","encodesCreativeWork","encodingFormat","encodings","endDate","episodeNumber","episodes","events","exifData","experienceRequirements","expires","familyName","fatContent","faxNumber","fiberContent","follows","founders","foundingDate","gender","genre","geo","givenName","headline","height","highPrice","hiringOrganization","homeLocation","honorificPrefix","honorificSuffix","illustrator","image","inAlbum","inLanguage","inPlaylist","incentives","industry","ingredients","interactionCount","isFamilyFriendly","isPartOf","isbn","itemCondition","itemListElement","itemListOrder","itemOffered","itemReviewed","jobLocation","jobTitle","keywords","knows","latitude","line","location","longitude","lowPrice","mainContentOfPage","manufacturer","maps","memberOf","members","mentions","menu","model","musicBy","musicGroupMember","name","nationality","numTracks","numberOfEpisodes","numberOfPages","nutrition","occupationalCategory","offerCount","offers","openingHours","parents","partOfSeason","partOfTVSeries","paymentAccepted","performerIn","performers","photos","playerType","polygon","postOfficeBoxNumber","postalCode","prepTime","price","priceCurrency","priceRange","priceValidUntil","primaryImageOfPage","printColumn","printEdition","printPage","printSection","producer","productID","productionCompany","proteinContent","provider","publisher","publishingPrinciples","qualifications","ratingCount","ratingValue","recipeCategory","recipeCuisine","recipeInstructions","recipeYield","regionsAllowed","relatedTo","replyToUrl","representativeOfPage","requiresSubscription","responsibilities","reviewBody","reviewCount","reviewRating","reviews","salaryCurrency","saturatedFatContent","seasonNumber","seasons","seller","servesCuisine","servingSize","siblings","significantLinks","skills","sodiumContent","sourceOrganization","specialCommitments","spouse","startDate","streetAddress","subEvents","sugarContent","superEvent","telephone","thumbnail","thumbnailUrl","tickerSymbol","title","totalTime","tracks","trailer","transFatContent","transcript","unsaturatedFatContent","uploadDate","url","version","video","videoFrameSize","videoQuality","width","wordCount","workHours","workLocation","worksFor","worstRating"],"types":["AboutPage","AccountingService","AdministrativeArea","AdultEntertainment","AggregateOffer","AggregateRating","Airport","AmusementPark","AnimalShelter","ApartmentComplex","Aquarium","ArtGallery","Article","Attorney","AudioObject","AutoBodyShop","AutoDealer","AutoPartsStore","AutoRental","AutoRepair","AutoWash","AutomatedTeller","AutomotiveBusiness","Bakery","BankOrCreditUnion","BarOrPub","Beach","BeautySalon","BedAndBreakfast","BikeStore","Blog","BlogPosting","BodyOfWater","Book","BookFormatType","BookStore","BowlingAlley","Brewery","BuddhistTemple","BusStation","BusStop","BusinessEvent","CafeOrCoffeeShop","Campground","Canal","Casino","CatholicChurch","Cemetery","CheckoutPage","ChildCare","ChildrensEvent","Church","City","CityHall","CivicStructure","ClothingStore","CollectionPage","CollegeOrUniversity","ComedyClub","ComedyEvent","ComputerStore","ContactPage","ContactPoint","Continent","ConvenienceStore","Corporation","Country","Courthouse","CreativeWork","Crematorium","DanceEvent","DanceGroup","DaySpa","DefenceEstablishment","Dentist","DepartmentStore","Distance","DryCleaningOrLaundry","Duration","EducationEvent","EducationalOrganization","Electrician","ElectronicsStore","ElementarySchool","Embassy","EmergencyService","EmploymentAgency","Energy","EntertainmentBusiness","Enumeration","Event","EventVenue","ExerciseGym","FastFoodRestaurant","Festival","FinancialService","FireStation","Florist","FoodEstablishment","FoodEvent","FurnitureStore","GardenStore","GasStation","GatedResidenceCommunity","GeneralContractor","GeoCoordinates","GeoShape","GolfCourse","GovernmentBuilding","GovernmentOffice","GovernmentOrganization","GroceryStore","HVACBusiness","HairSalon","HardwareStore","HealthAndBeautyBusiness","HealthClub","HighSchool","HinduTemple","HobbyShop","HomeAndConstructionBusiness","HomeGoodsStore","Hospital","Hostel","Hotel","HousePainter","IceCreamShop","ImageGallery","ImageObject","InsuranceAgency","Intangible","InternetCafe","ItemAvailability","ItemList","ItemPage","JewelryStore","JobPosting","LakeBodyOfWater","Landform","LandmarksOrHistoricalBuildings","Language","LegislativeBuilding","Library","LiquorStore","LiteraryEvent","LocalBusiness","Locksmith","LodgingBusiness","Map","Mass","MediaObject","MedicalClinic","MedicalOrganization","MensClothingStore","MiddleSchool","MobilePhoneStore","Mosque","Motel","MotorcycleDealer","MotorcycleRepair","Mountain","Movie","MovieRentalStore","MovieTheater","MovingCompany","Museum","MusicAlbum","MusicEvent","MusicGroup","MusicPlaylist","MusicRecording","MusicStore","MusicVenue","MusicVideoObject","NGO","NailSalon","NewsArticle","NightClub","Notary","NutritionInformation","OceanBodyOfWater","Offer","OfferItemCondition","OfficeEquipmentStore","Optician","Organization","OutletStore","Painting","Park","ParkingFacility","PawnShop","PerformingArtsTheater","PerformingGroup","Person","PetStore","Pharmacy","Photograph","Physician","Place","PlaceOfWorship","Playground","Plumber","PoliceStation","Pond","PostOffice","PostalAddress","Preschool","Product","ProfessionalService","ProfilePage","PublicSwimmingPool","Quantity","RVPark","RadioStation","Rating","RealEstateAgent","Recipe","RecyclingCenter","Reservoir","Residence","Restaurant","Review","RiverBodyOfWater","RoofingContractor","SaleEvent","ScholarlyArticle","School","Sculpture","SeaBodyOfWater","SearchResultsPage","SelfStorage","ShoeStore","ShoppingCenter","SingleFamilyResidence","SiteNavigationElement","SkiResort","SocialEvent","SportingGoodsStore","SportsActivityLocation","SportsClub","SportsEvent","SportsTeam","StadiumOrArena","State","Store","StructuredValue","SubwayStation","Synagogue","TVEpisode","TVSeason","TVSeries","Table","TattooParlor","TaxiStand","TelevisionStation","TennisComplex","TheaterEvent","TheaterGroup","Thing","TireShop","TouristAttraction","TouristInformationCenter","ToyStore","TrainStation","TravelAgency","UserBlocks","UserCheckins","UserComments","UserDownloads","UserInteraction","UserLikes","UserPageVisits","UserPlays","UserPlusOnes","UserTweets","VeterinaryCare","VideoGallery","VideoObject","VisualArtsEvent","Volcano","WPAdBlock","WPFooter","WPHeader","WPSideBar","Waterfall","WebPage","WebPageElement","WholesaleStore","Winery","Zoo"]}
\ No newline at end of file
+{"datatypes":["Boolean","DataType","Date","DateTime","Float","Integer","Number","Text","Time","URL"],"properties":["about","acceptedPaymentMethod","acceptsReservations","accountablePerson","acquiredFrom","action","activeIngredient","activityDuration","activityFrequency","actor","actors","addOn","additionalName","additionalType","additionalVariable","address","addressCountry","addressLocality","addressRegion","administrationRoute","advanceBookingRequirement","adverseOutcome","affectedBy","affiliation","agent","aggregateRating","album","albums","alcoholWarning","algorithm","alignmentType","alternateName","alternativeHeadline","alumni","alumniOf","amountOfThisGood","antagonist","applicableLocation","applicationCategory","applicationSubCategory","applicationSuite","appliesToDeliveryMethod","appliesToPaymentMethod","arterialBranch","articleBody","articleSection","aspect","assembly","assemblyVersion","associatedAnatomy","associatedArticle","associatedMedia","associatedPathophysiology","attendee","attendees","audience","audio","author","availability","availabilityEnds","availabilityStarts","availableAtOrFrom","availableDeliveryMethod","availableIn","availableService","availableStrength","availableTest","award","awards","background","baseSalary","benefits","bestRating","billingIncrement","biomechnicalClass","birthDate","bitrate","blogPost","blogPosts","bloodSupply","bodyLocation","bookEdition","bookFormat","borrower","box","branch","branchOf","brand","breadcrumb","breastfeedingWarning","browserRequirements","businessFunction","buyer","byArtist","calories","candidate","caption","carbohydrateContent","carrierRequirements","catalog","category","cause","causeOf","childMaxAge","childMinAge","children","cholesterolContent","circle","citation","clincalPharmacology","closes","code","codeRepository","codeValue","codingSystem","colleague","colleagues","collection","color","comment","commentText","commentTime","comprisedOf","connectedTo","contactPoint","contactPoints","contactType","containedIn","contentLocation","contentRating","contentSize","contentUrl","contraindication","contributor","cookTime","cookingMethod","copyrightHolder","copyrightYear","cost","costCategory","costCurrency","costOrigin","costPerUnit","countriesNotSupported","countriesSupported","course","creator","currenciesAccepted","dataset","dateCreated","dateModified","datePosted","datePublished","dateline","dayOfWeek","deathDate","deliveryLeadTime","deliveryMethod","dependencies","depth","description","device","diagnosis","diagram","diet","dietFeatures","differentialDiagnosis","director","discusses","discussionUrl","distance","distinguishingSign","distribution","domainIncludes","dosageForm","doseSchedule","doseUnit","doseValue","downloadUrl","drainsTo","drug","drugClass","drugUnit","duns","duplicateTherapy","duration","durationOfWarranty","editor","educationRequirements","educationalAlignment","educationalFramework","educationalRole","educationalUse","elevation","eligibleCustomerType","eligibleDuration","eligibleQuantity","eligibleRegion","eligibleTransactionVolume","email","embedUrl","employee","employees","employmentType","encodesCreativeWork","encoding","encodingFormat","encodings","endDate","endTime","endorsee","endorsers","entertainmentBusiness","epidemiology","episode","episodeNumber","episodes","equal","estimatesRiskOf","event","events","evidenceLevel","evidenceOrigin","exercisePlan","exerciseType","exifData","expectedPrognosis","experienceRequirements","expertConsiderations","expires","familyName","fatContent","faxNumber","featureList","fiberContent","fileFormat","fileSize","followee","follows","followup","foodEstablishment","foodEvent","foodWarning","founder","founders","foundingDate","frequency","fromLocation","function","functionalClass","gender","genre","geo","givenName","globalLocationNumber","greater","greaterOrEqual","gtin13","gtin14","gtin8","guideline","guidelineDate","guidelineSubject","hasPOS","headline","healthCondition","height","highPrice","hiringOrganization","homeLocation","honorificPrefix","honorificSuffix","hospitalAffiliation","howPerformed","identifyingExam","identifyingTest","illustrator","image","imagingTechnique","inAlbum","inLanguage","inPlaylist","incentives","includedRiskFactor","includesObject","increasesRiskOf","indication","industry","infectiousAgent","infectiousAgentClass","ingredients","insertion","installUrl","instrument","intensity","interactingDrug","interactionCount","interactivityType","inventoryLevel","isAccessoryOrSparePartFor","isAvailableGenerically","isBasedOnUrl","isConsumableFor","isFamilyFriendly","isPartOf","isProprietary","isRelatedTo","isSimilarTo","isVariantOf","isbn","isicV4","itemCondition","itemListElement","itemListOrder","itemOffered","itemReviewed","jobLocation","jobTitle","keywords","knows","labelDetails","landlord","language","lastReviewed","latitude","learningResourceType","legalName","legalStatus","lender","lesser","lesserOrEqual","line","location","logo","longitude","loser","lowPrice","mainContentOfPage","makesOffer","manufacturer","map","maps","maxPrice","maxValue","maximumIntake","mechanismOfAction","medicalSpecialty","medicineSystem","member","memberOf","members","memoryRequirements","mentions","menu","minPrice","minValue","model","mpn","musicBy","musicGroupMember","naics","name","nationality","naturalProgression","nerve","nerveMotor","nonEqual","nonProprietaryName","normalRange","numTracks","numberOfEpisodes","numberOfPages","nutrition","object","occupationalCategory","offerCount","offers","openingHours","openingHoursSpecification","opens","operatingSystem","oponent","option","origin","originatesFrom","outcome","overdosage","overview","ownedFrom","ownedThrough","owns","parent","parents","partOfSeason","partOfSystem","partOfTVSeries","participant","pathophysiology","paymentAccepted","performer","performerIn","performers","permissions","phase","photo","photos","physiologicalBenefits","playerType","polygon","population","possibleComplication","possibleTreatment","postOfficeBoxNumber","postOp","postalCode","preOp","predecessorOf","pregnancyCategory","pregnancyWarning","prepTime","preparation","prescribingInfo","prescriptionStatus","price","priceCurrency","priceRange","priceSpecification","priceType","priceValidUntil","primaryImageOfPage","primaryPrevention","printColumn","printEdition","printPage","printSection","procedure","procedureType","processorRequirements","producer","productID","productionCompany","proficiencyLevel","programmingLanguage","programmingModel","proprietaryName","proteinContent","provider","publicationType","publisher","publishingPrinciples","purpose","qualifications","query","question","rangeIncludes","ratingCount","ratingValue","realEstateAgent","recipe","recipeCategory","recipeCuisine","recipeInstructions","recipeYield","recipient","recognizingAuthority","recommendationStrength","recommendedIntake","regionDrained","regionsAllowed","relatedAnatomy","relatedCondition","relatedDrug","relatedLink","relatedStructure","relatedTherapy","relatedTo","releaseDate","releaseNotes","relevantSpecialty","repetitions","replacee","replacer","replyToUrl","representativeOfPage","requirements","requiresSubscription","responsibilities","restPeriods","result","resultReview","review","reviewBody","reviewCount","reviewRating","reviewedBy","reviews","riskFactor","risks","runsTo","runtime","safetyConsideration","salaryCurrency","sameAs","sampleType","saturatedFatContent","scheduledTime","screenshot","season","seasonNumber","seasons","secondaryPrevention","seeks","seller","sender","sensoryUnit","serialNumber","seriousAdverseOutcome","servesCuisine","servingSize","sibling","siblings","signDetected","signOrSymptom","significance","significantLink","significantLinks","skills","sku","sodiumContent","softwareVersion","source","sourceOrganization","sourcedFrom","spatial","specialCommitments","specialty","sponsor","sportsActivityLocation","sportsEvent","sportsTeam","spouse","stage","stageAsNumber","startDate","startTime","status","storageRequirements","streetAddress","strengthUnit","strengthValue","structuralClass","study","studyDesign","studyLocation","studySubject","subEvent","subEvents","subStageSuffix","subStructure","subTest","subtype","successorOf","sugarContent","suggestedGender","suggestedMaxAge","suggestedMinAge","superEvent","supplyTo","targetDescription","targetName","targetPlatform","targetPopulation","targetProduct","targetUrl","taxID","telephone","temporal","text","thumbnail","thumbnailUrl","tickerSymbol","timeRequired","tissueSample","title","toLocation","totalTime","track","tracks","trailer","transFatContent","transcript","transmissionMethod","trialDesign","tributary","typeOfGood","typicalAgeRange","typicalTest","unitCode","unsaturatedFatContent","uploadDate","url","usedToDiagnose","usesDevice","validFrom","validThrough","value","valueAddedTaxIncluded","valueReference","vatID","vendor","version","video","videoFrameSize","videoQuality","warning","warranty","warrantyPromise","warrantyScope","weight","width","winner","wordCount","workHours","workLocation","workload","worksFor","worstRating"],"types":["APIReference","AboutPage","AcceptAction","AccountingService","AchieveAction","Action","AddAction","AdministrativeArea","AdultEntertainment","AggregateOffer","AggregateRating","AgreeAction","Airport","AlignmentObject","AllocateAction","AmusementPark","AnatomicalStructure","AnatomicalSystem","AnimalShelter","ApartmentComplex","AppendAction","ApplyAction","ApprovedIndication","Aquarium","ArriveAction","ArtGallery","Artery","Article","AskAction","AssessAction","AssignAction","Attorney","Audience","AudioObject","AuthorizeAction","AutoBodyShop","AutoDealer","AutoPartsStore","AutoRental","AutoRepair","AutoWash","AutomatedTeller","AutomotiveBusiness","Bakery","BankOrCreditUnion","BarOrPub","Beach","BeautySalon","BedAndBreakfast","BefriendAction","BikeStore","Blog","BlogPosting","BloodTest","BodyOfWater","Bone","Book","BookFormatType","BookStore","BookmarkAction","BorrowAction","BowlingAlley","BrainStructure","Brand","Brewery","BuddhistTemple","BusStation","BusStop","BusinessEntityType","BusinessEvent","BusinessFunction","BuyAction","CafeOrCoffeeShop","Campground","Canal","CancelAction","Casino","CatholicChurch","Cemetery","CheckAction","CheckInAction","CheckOutAction","CheckoutPage","ChildCare","ChildrensEvent","ChooseAction","Church","City","CityHall","CivicStructure","Class","ClothingStore","Code","CollectionPage","CollegeOrUniversity","ComedyClub","ComedyEvent","Comment","CommentAction","CommunicateAction","ComputerStore","ConfirmAction","ConsumeAction","ContactPage","ContactPoint","Continent","ConvenienceStore","CookAction","Corporation","Country","Courthouse","CreateAction","CreativeWork","CreditCard","Crematorium","DDxElement","DanceEvent","DanceGroup","DataCatalog","DataDownload","Dataset","DayOfWeek","DaySpa","DefenceEstablishment","DeleteAction","DeliveryChargeSpecification","DeliveryMethod","Demand","Dentist","DepartAction","DepartmentStore","DiagnosticLab","DiagnosticProcedure","Diet","DietarySupplement","DisagreeAction","DiscoverAction","DislikeAction","Distance","DonateAction","DoseSchedule","DownloadAction","DrawAction","DrinkAction","Drug","DrugClass","DrugCost","DrugCostCategory","DrugLegalStatus","DrugPregnancyCategory","DrugPrescriptionStatus","DrugStrength","DryCleaningOrLaundry","Duration","EatAction","EducationEvent","EducationalAudience","EducationalOrganization","Electrician","ElectronicsStore","ElementarySchool","Embassy","EmergencyService","EmploymentAgency","EndorseAction","Energy","EntertainmentBusiness","Enumeration","Event","EventVenue","ExerciseAction","ExerciseGym","ExercisePlan","FastFoodRestaurant","Festival","FilmAction","FinancialService","FindAction","FireStation","Florist","FollowAction","FoodEstablishment","FoodEvent","FurnitureStore","GardenStore","GasStation","GatedResidenceCommunity","GeneralContractor","GeoCoordinates","GeoShape","GiveAction","GolfCourse","GovernmentBuilding","GovernmentOffice","GovernmentOrganization","GroceryStore","HVACBusiness","HairSalon","HardwareStore","HealthAndBeautyBusiness","HealthClub","HighSchool","HinduTemple","HobbyShop","HomeAndConstructionBusiness","HomeGoodsStore","Hospital","Hostel","Hotel","HousePainter","IceCreamShop","IgnoreAction","ImageGallery","ImageObject","ImagingTest","IndividualProduct","InfectiousAgentClass","InfectiousDisease","InformAction","InsertAction","InstallAction","InsuranceAgency","Intangible","InteractAction","InternetCafe","InviteAction","ItemAvailability","ItemList","ItemPage","JewelryStore","JobPosting","JoinAction","Joint","LakeBodyOfWater","Landform","LandmarksOrHistoricalBuildings","Language","LeaveAction","LegislativeBuilding","LendAction","Library","LifestyleModification","Ligament","LikeAction","LiquorStore","ListenAction","LiteraryEvent","LocalBusiness","Locksmith","LodgingBusiness","LoseAction","LymphaticVessel","Map","MarryAction","Mass","MaximumDoseSchedule","MediaObject","MedicalAudience","MedicalCause","MedicalClinic","MedicalCode","MedicalCondition","MedicalConditionStage","MedicalContraindication","MedicalDevice","MedicalDevicePurpose","MedicalEntity","MedicalEnumeration","MedicalEvidenceLevel","MedicalGuideline","MedicalGuidelineContraindication","MedicalGuidelineRecommendation","MedicalImagingTechnique","MedicalIndication","MedicalIntangible","MedicalObservationalStudy","MedicalObservationalStudyDesign","MedicalOrganization","MedicalProcedure","MedicalProcedureType","MedicalRiskCalculator","MedicalRiskEstimator","MedicalRiskFactor","MedicalRiskScore","MedicalScholarlyArticle","MedicalSign","MedicalSignOrSymptom","MedicalSpecialty","MedicalStudy","MedicalStudyStatus","MedicalSymptom","MedicalTest","MedicalTestPanel","MedicalTherapy","MedicalTrial","MedicalTrialDesign","MedicalWebPage","MedicineSystem","MensClothingStore","MiddleSchool","MobileApplication","MobilePhoneStore","Mosque","Motel","MotorcycleDealer","MotorcycleRepair","Mountain","MoveAction","Movie","MovieRentalStore","MovieTheater","MovingCompany","Muscle","Museum","MusicAlbum","MusicEvent","MusicGroup","MusicPlaylist","MusicRecording","MusicStore","MusicVenue","MusicVideoObject","NGO","NailSalon","Nerve","NewsArticle","NightClub","Notary","NutritionInformation","OceanBodyOfWater","Offer","OfferItemCondition","OfficeEquipmentStore","OpeningHoursSpecification","Optician","OrderAction","Organization","OrganizeAction","OutletStore","OwnershipInfo","PaintAction","Painting","PalliativeProcedure","ParcelService","ParentAudience","Park","ParkingFacility","PathologyTest","PawnShop","PayAction","PaymentChargeSpecification","PaymentMethod","PeopleAudience","PerformAction","PerformingArtsTheater","PerformingGroup","Person","PetStore","Pharmacy","Photograph","PhotographAction","PhysicalActivity","PhysicalActivityCategory","PhysicalExam","PhysicalTherapy","Physician","Place","PlaceOfWorship","PlanAction","PlayAction","Playground","Plumber","PoliceStation","Pond","PostOffice","PostalAddress","PrependAction","Preschool","PreventionIndication","PriceSpecification","Product","ProductModel","ProfessionalService","ProfilePage","Property","PsychologicalTreatment","PublicSwimmingPool","QualitativeValue","QuantitativeValue","Quantity","QuoteAction","RVPark","RadiationTherapy","RadioStation","Rating","ReactAction","ReadAction","RealEstateAgent","ReceiveAction","Recipe","RecommendedDoseSchedule","RecyclingCenter","RegisterAction","RejectAction","RentAction","ReplaceAction","ReplyAction","ReportedDoseSchedule","ReserveAction","Reservoir","Residence","Restaurant","ReturnAction","Review","ReviewAction","RiverBodyOfWater","RoofingContractor","RsvpAction","SaleEvent","ScheduleAction","ScholarlyArticle","School","Sculpture","SeaBodyOfWater","SearchAction","SearchResultsPage","SelfStorage","SellAction","SendAction","ShareAction","ShoeStore","ShoppingCenter","SingleFamilyResidence","SiteNavigationElement","SkiResort","SocialEvent","SoftwareApplication","SomeProducts","Specialty","SportingGoodsStore","SportsActivityLocation","SportsClub","SportsEvent","SportsTeam","StadiumOrArena","State","Store","StructuredValue","SubscribeAction","SubwayStation","SuperficialAnatomy","Synagogue","TVEpisode","TVSeason","TVSeries","Table","TakeAction","TattooParlor","TaxiStand","TechArticle","TelevisionStation","TennisComplex","TheaterEvent","TheaterGroup","TherapeuticProcedure","Thing","TieAction","TipAction","TireShop","TouristAttraction","TouristInformationCenter","ToyStore","TrackAction","TradeAction","TrainStation","TransferAction","TravelAction","TravelAgency","TreatmentIndication","TypeAndQuantityNode","UnRegisterAction","UnitPriceSpecification","UpdateAction","UseAction","UserBlocks","UserCheckins","UserComments","UserDownloads","UserInteraction","UserLikes","UserPageVisits","UserPlays","UserPlusOnes","UserTweets","Vein","Vessel","VeterinaryCare","VideoGallery","VideoObject","ViewAction","VisualArtsEvent","Volcano","VoteAction","WPAdBlock","WPFooter","WPHeader","WPSideBar","WantAction","WarrantyPromise","WarrantyScope","WatchAction","Waterfall","WearAction","WebApplication","WebPage","WebPageElement","WholesaleStore","WinAction","Winery","WriteAction","Zoo"]}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.info b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.info
index 4041bd4..0f9017d 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.info
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.info
@@ -6,9 +6,9 @@ dependencies[] = schemaorg
 core = 7.x
 files[] = schemaorg.test
 
-; Information added by drupal.org packaging script on 2012-05-21
-version = "7.x-1.0-beta3"
+; Information added by  packaging script on 2013-11-19
+version = "7.x-1.0-beta4"
 core = "7.x"
 project = "schemaorg"
-datestamp = "1337625394"
+datestamp = "1384874931"
 
diff --git a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.module b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.module
index aefb0d5..0f1432d 100644
--- a/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.module
+++ b/profiles/commons/modules/contrib/schemaorg/schemaorg_ui/schemaorg_ui.module
@@ -153,8 +153,10 @@ function schemaorg_ui_field_ui_field_edit_form_submit($form, &$form_state) {
     }
     // Sets the mapping for the url of the entity. This mapping is always set
     // to schema:url and is not exposed in the UI.
-    $mapping['url']['predicates'] = array('schema:url');
-    $mapping['url']['type'] = 'rel';
+    if ($entity_type != 'profile2') {
+      $mapping['url']['predicates'] = array('schema:url');
+      $mapping['url']['type'] = 'rel';
+    }
     // Add schema:Person type to user mapping.
     if ($entity_type == 'user' && $bundle == 'user' ) {
       $mapping['rdftype'] = schemaorg_ui_terms_merge('Person', $mapping['rdftype']);
@@ -184,6 +186,24 @@ function schemaorg_ui_field_ui_field_edit_form_submit($form, &$form_state) {
     'mapping' => $mapping,
     )
   );
+
+  // Handle profile2 and schema.org mappings by setting the right type and
+  // properties for the user entity type. The profile should not be seen as a
+  // separate resource in the RDFa, but instead it should be part of the user.
+  if (module_exists('profile2')) {
+    $user_mapping = rdf_mapping_load('user', 'user');
+    $user_mapping['rdftype'] = schemaorg_ui_terms_merge('Person', isset($user_mapping['rdftype']) ? $user_mapping['rdftype'] : array());
+    $user_mapping['name']['predicates'] = array('schema:name');
+    $user_mapping['url']['predicates'] = array('schema:url');
+    $user_mapping['url']['type'] = 'rel';
+
+    rdf_mapping_save(array(
+      'type' => 'user',
+      'bundle' => 'user',
+      'mapping' => $user_mapping,
+      )
+    );
+  }
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/strongarm/LICENSE.txt b/profiles/commons/modules/contrib/strongarm/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/modules/contrib/strongarm/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/strongarm/strongarm.info b/profiles/commons/modules/contrib/strongarm/strongarm.info
index a74f289..ee40d4b 100644
--- a/profiles/commons/modules/contrib/strongarm/strongarm.info
+++ b/profiles/commons/modules/contrib/strongarm/strongarm.info
@@ -8,9 +8,9 @@ files[] = strongarm.install
 files[] = strongarm.module
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-2.0+2-dev"
 core = "7.x"
 project = "strongarm"
-datestamp = "1382042512"
+datestamp = "1387568913"
 
diff --git a/profiles/commons/modules/contrib/views_load_more/.travis.yml b/profiles/commons/modules/contrib/views_load_more/.travis.yml
new file mode 100644
index 0000000..c52b551
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/.travis.yml
@@ -0,0 +1,23 @@
+language: php
+
+php:
+  - 5.3
+
+mysql:
+  database: drupal
+  username: root
+  encoding: utf8
+
+before_script:
+ - mysql -e 'create database drupal;'
+ - pyrus channel-discover pear.drush.org
+ - pyrus install drush/drush
+ - phpenv rehash
+ - wget http://ftp.drupal.org/files/projects/drupal-7.14.tar.gz
+ - tar -xf drupal-7.14.tar.gz
+ - cd drupal-7.14
+ - drush site-install standard --db-url=mysql://root:@localhost/drupal --yes
+ - "export PHANTOMJS_EXECUTABLE='phantomjs --local-to-remote-url-access=yes --ignore-ssl'"
+
+script:
+ - ./bin/casperjs test test/casperjs
diff --git a/profiles/commons/modules/contrib/views_load_more/CHANGELOG.txt b/profiles/commons/modules/contrib/views_load_more/CHANGELOG.txt
new file mode 100644
index 0000000..4af4cc0
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/CHANGELOG.txt
@@ -0,0 +1,19 @@
+
+views_load_more 7.x-1.x, xxxx-xx-xx
+-----------------------------------
+
+views_load_more 7.x-1.2, 2013-11-27
+-----------------------------------
+#1372206 by andremolnar, attilafekete: provide default target selectors for specific view styles
+#1703436 by agalitsyn, attilafekete: avoid undefined AJAX error
+#1919894 by caiosba: Trigger a custom event when new content is loaded
+#1459860 by Kleve: Fixed Views load more does not follow the No results behavior
+#1404664 by justin2pin, jyee: Fixed Circumvent Views Ajax Scrolling
+#1322642 by ericduran, johnste: Fixed Full page reload on 2nd click of load more. (works the first time)
+#1332386 by ericduran: Add advance options for custom classes
+#1272562 by andremolnar, ericduran: Added provide option to change the text per view
+#1320164 by andremolnar: Added Provide more descriptive description in info file
+#1264222 by EndEd: Fixing behaviors when the result set is being rendered by an exposed filter
+#1234680 by ericduran: Adding support for effects, right now fade is supported
+#1237888 by moonray: Add class to distinguish from regular pager
+#1234664 by ericduran, moonray: Add waypoint support Fixes
diff --git a/profiles/commons/modules/contrib/views_load_more/LICENSE.txt b/profiles/commons/modules/contrib/views_load_more/LICENSE.txt
old mode 100644
new mode 100755
index 2c095c8..d159169
--- a/profiles/commons/modules/contrib/views_load_more/LICENSE.txt
+++ b/profiles/commons/modules/contrib/views_load_more/LICENSE.txt
@@ -1,274 +1,339 @@
-GNU GENERAL PUBLIC LICENSE
-
-              Version 2, June 1991
-
-Copyright (C) 1989, 1991 Free Software Foundation, Inc. 675 Mass Ave,
-Cambridge, MA 02139, USA. Everyone is permitted to copy and distribute
-verbatim copies of this license document, but changing it is not allowed.
-
-                  Preamble
-
-The licenses for most software are designed to take away your freedom to
-share and change it. By contrast, the GNU General Public License is
-intended to guarantee your freedom to share and change free software--to
-make sure the software is free for all its users. This General Public License
-applies to most of the Free Software Foundation's software and to any other
-program whose authors commit to using it. (Some other Free Software
-Foundation software is covered by the GNU Library General Public License
-instead.) You can apply it to your programs, too.
-
-When we speak of free software, we are referring to freedom, not price. Our
-General Public Licenses are designed to make sure that you have the
-freedom to distribute copies of free software (and charge for this service if
-you wish), that you receive source code or can get it if you want it, that you
-can change the software or use pieces of it in new free programs; and that
-you know you can do these things.
-
-To protect your rights, we need to make restrictions that forbid anyone to
-deny you these rights or to ask you to surrender the rights. These restrictions
-translate to certain responsibilities for you if you distribute copies of the
-software, or if you modify it.
-
-For example, if you distribute copies of such a program, whether gratis or for
-a fee, you must give the recipients all the rights that you have. You must make
-sure that they, too, receive or can get the source code. And you must show
-them these terms so they know their rights.
-
-We protect your rights with two steps: (1) copyright the software, and (2)
-offer you this license which gives you legal permission to copy, distribute
-and/or modify the software.
-
-Also, for each author's protection and ours, we want to make certain that
-everyone understands that there is no warranty for this free software. If the
-software is modified by someone else and passed on, we want its recipients
-to know that what they have is not the original, so that any problems
-introduced by others will not reflect on the original authors' reputations.
-
-Finally, any free program is threatened constantly by software patents. We
-wish to avoid the danger that redistributors of a free program will individually
-obtain patent licenses, in effect making the program proprietary. To prevent
-this, we have made it clear that any patent must be licensed for everyone's
-free use or not licensed at all.
-
-The precise terms and conditions for copying, distribution and modification
-follow.
-
-           GNU GENERAL PUBLIC LICENSE
- TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND
-               MODIFICATION
-
-0. This License applies to any program or other work which contains a notice
-placed by the copyright holder saying it may be distributed under the terms
-of this General Public License. The "Program", below, refers to any such
-program or work, and a "work based on the Program" means either the
-Program or any derivative work under copyright law: that is to say, a work
-containing the Program or a portion of it, either verbatim or with
-modifications and/or translated into another language. (Hereinafter, translation
-is included without limitation in the term "modification".) Each licensee is
-addressed as "you".
-
-Activities other than copying, distribution and modification are not covered
-by this License; they are outside its scope. The act of running the Program is
-not restricted, and the output from the Program is covered only if its contents
-constitute a work based on the Program (independent of having been made
-by running the Program). Whether that is true depends on what the Program
-does.
-
-1. You may copy and distribute verbatim copies of the Program's source
-code as you receive it, in any medium, provided that you conspicuously and
-appropriately publish on each copy an appropriate copyright notice and
-disclaimer of warranty; keep intact all the notices that refer to this License
-and to the absence of any warranty; and give any other recipients of the
-Program a copy of this License along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and you
-may at your option offer warranty protection in exchange for a fee.
-
-2. You may modify your copy or copies of the Program or any portion of it,
-thus forming a work based on the Program, and copy and distribute such
-modifications or work under the terms of Section 1 above, provided that you
-also meet all of these conditions:
-
-a) You must cause the modified files to carry prominent notices stating that
-you changed the files and the date of any change.
-
-b) You must cause any work that you distribute or publish, that in whole or in
-part contains or is derived from the Program or any part thereof, to be
-licensed as a whole at no charge to all third parties under the terms of this
-License.
-
-c) If the modified program normally reads commands interactively when run,
-you must cause it, when started running for such interactive use in the most
-ordinary way, to print or display an announcement including an appropriate
-copyright notice and a notice that there is no warranty (or else, saying that
-you provide a warranty) and that users may redistribute the program under
-these conditions, and telling the user how to view a copy of this License.
-(Exception: if the Program itself is interactive but does not normally print such
-an announcement, your work based on the Program is not required to print
-an announcement.)
-
-These requirements apply to the modified work as a whole. If identifiable
-sections of that work are not derived from the Program, and can be
-reasonably considered independent and separate works in themselves, then
-this License, and its terms, do not apply to those sections when you distribute
-them as separate works. But when you distribute the same sections as part
-of a whole which is a work based on the Program, the distribution of the
-whole must be on the terms of this License, whose permissions for other
-licensees extend to the entire whole, and thus to each and every part
-regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest your rights to
-work written entirely by you; rather, the intent is to exercise the right to
-control the distribution of derivative or collective works based on the
-Program.
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
 
 In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of a
-storage or distribution medium does not bring the other work under the scope
-of this License.
-
-3. You may copy and distribute the Program (or a work based on it, under
-Section 2) in object code or executable form under the terms of Sections 1
-and 2 above provided that you also do one of the following:
-
-a) Accompany it with the complete corresponding machine-readable source
-code, which must be distributed under the terms of Sections 1 and 2 above
-on a medium customarily used for software interchange; or,
-
-b) Accompany it with a written offer, valid for at least three years, to give
-any third party, for a charge no more than your cost of physically performing
-source distribution, a complete machine-readable copy of the corresponding
-source code, to be distributed under the terms of Sections 1 and 2 above on
-a medium customarily used for software interchange; or,
-
-c) Accompany it with the information you received as to the offer to distribute
-corresponding source code. (This alternative is allowed only for
-noncommercial distribution and only if you received the program in object
-code or executable form with such an offer, in accord with Subsection b
-above.)
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
 
 The source code for a work means the preferred form of the work for
-making modifications to it. For an executable work, complete source code
-means all the source code for all modules it contains, plus any associated
-interface definition files, plus the scripts used to control compilation and
-installation of the executable. However, as a special exception, the source
-code distributed need not include anything that is normally distributed (in
-either source or binary form) with the major components (compiler, kernel,
-and so on) of the operating system on which the executable runs, unless that
-component itself accompanies the executable.
-
-If distribution of executable or object code is made by offering access to
-copy from a designated place, then offering equivalent access to copy the
-source code from the same place counts as distribution of the source code,
-even though third parties are not compelled to copy the source along with the
-object code.
-
-4. You may not copy, modify, sublicense, or distribute the Program except as
-expressly provided under this License. Any attempt otherwise to copy,
-modify, sublicense or distribute the Program is void, and will automatically
-terminate your rights under this License. However, parties who have received
-copies, or rights, from you under this License will not have their licenses
-terminated so long as such parties remain in full compliance.
-
-5. You are not required to accept this License, since you have not signed it.
-However, nothing else grants you permission to modify or distribute the
-Program or its derivative works. These actions are prohibited by law if you
-do not accept this License. Therefore, by modifying or distributing the
-Program (or any work based on the Program), you indicate your acceptance
-of this License to do so, and all its terms and conditions for copying,
-distributing or modifying the Program or works based on it.
-
-6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the original
-licensor to copy, distribute or modify the Program subject to these terms and
-conditions. You may not impose any further restrictions on the recipients'
-exercise of the rights granted herein. You are not responsible for enforcing
-compliance by third parties to this License.
-
-7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues), conditions
-are imposed on you (whether by court order, agreement or otherwise) that
-contradict the conditions of this License, they do not excuse you from the
-conditions of this License. If you cannot distribute so as to satisfy
-simultaneously your obligations under this License and any other pertinent
-obligations, then as a consequence you may not distribute the Program at all.
-For example, if a patent license would not permit royalty-free redistribution
-of the Program by all those who receive copies directly or indirectly through
-you, then the only way you could satisfy both it and this License would be to
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
 refrain entirely from distribution of the Program.
 
-If any portion of this section is held invalid or unenforceable under any
-particular circumstance, the balance of the section is intended to apply and
-the section as a whole is intended to apply in other circumstances.
-
-It is not the purpose of this section to induce you to infringe any patents or
-other property right claims or to contest validity of any such claims; this
-section has the sole purpose of protecting the integrity of the free software
-distribution system, which is implemented by public license practices. Many
-people have made generous contributions to the wide range of software
-distributed through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing to
-distribute software through any other system and a licensee cannot impose
-that choice.
-
-This section is intended to make thoroughly clear what is believed to be a
-consequence of the rest of this License.
-
-8. If the distribution and/or use of the Program is restricted in certain
-countries either by patents or by copyrighted interfaces, the original copyright
-holder who places the Program under this License may add an explicit
-geographical distribution limitation excluding those countries, so that
-distribution is permitted only in or among countries not thus excluded. In such
-case, this License incorporates the limitation as if written in the body of this
-License.
-
-9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time. Such new versions will be
-similar in spirit to the present version, but may differ in detail to address new
-problems or concerns.
-
-Each version is given a distinguishing version number. If the Program specifies
-a version number of this License which applies to it and "any later version",
-you have the option of following the terms and conditions either of that
-version or of any later version published by the Free Software Foundation. If
-the Program does not specify a version number of this License, you may
-choose any version ever published by the Free Software Foundation.
-
-10. If you wish to incorporate parts of the Program into other free programs
-whose distribution conditions are different, write to the author to ask for
-permission. For software which is copyrighted by the Free Software
-Foundation, write to the Free Software Foundation; we sometimes make
-exceptions for this. Our decision will be guided by the two goals of
-preserving the free status of all derivatives of our free software and of
-promoting the sharing and reuse of software generally.
-
-               NO WARRANTY
-
-11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE,
-THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT
-PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE
-STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
-OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT
-WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED,
-INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
-OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
-PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND
-PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL
-NECESSARY SERVICING, REPAIR OR CORRECTION.
-
-12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR
-AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR
-ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE
-LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL,
-SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
-ARISING OUT OF THE USE OR INABILITY TO USE THE
-PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA
-OR DATA BEING RENDERED INACCURATE OR LOSSES
-SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE
-PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS), EVEN
-IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF
-THE POSSIBILITY OF SUCH DAMAGES.
-
-          END OF TERMS AND CONDITIONS
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
diff --git a/profiles/commons/modules/contrib/views_load_more/readme.md b/profiles/commons/modules/contrib/views_load_more/readme.md
new file mode 100644
index 0000000..59bf932
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/readme.md
@@ -0,0 +1,7 @@
+#Views Load More#
+
+----
+
+[![Build Status](https://secure.travis-ci.org/ericduran/views_load_more.png?branch=master)](http://travis-ci.org/ericduran/views_load_more)
+
+Built by Robots&trade;
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/views_load_more/test/casperjs/test1.js b/profiles/commons/modules/contrib/views_load_more/test/casperjs/test1.js
new file mode 100644
index 0000000..ae255b3
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/test/casperjs/test1.js
@@ -0,0 +1,3 @@
+casper.test.comment('My first test file');
+casper.test.assert(true, "true is so true");
+casper.test.done(); // I must be called!
diff --git a/profiles/commons/modules/contrib/views_load_more/test/ci/drupal_setup.sh b/profiles/commons/modules/contrib/views_load_more/test/ci/drupal_setup.sh
new file mode 100644
index 0000000..791b356
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/test/ci/drupal_setup.sh
@@ -0,0 +1,9 @@
+#!/bin/bash
+mysql -e 'create database drupal;'
+pyrus channel-discover pear.drush.org
+pyrus install drush/drush
+phpenv rehash
+wget http://ftp.drupal.org/files/projects/drupal-7.14.tar.gz
+tar -xf drupal-7.14.tar.gz
+cd drupal-7.14
+drush site-install standard --db-url=mysql://root:@localhost/drupal --yes
diff --git a/profiles/commons/modules/contrib/views_load_more/test/ci/run_build.sh b/profiles/commons/modules/contrib/views_load_more/test/ci/run_build.sh
new file mode 100644
index 0000000..a9bf588
--- /dev/null
+++ b/profiles/commons/modules/contrib/views_load_more/test/ci/run_build.sh
@@ -0,0 +1 @@
+#!/bin/bash
diff --git a/profiles/commons/modules/contrib/views_load_more/views_load_more.info b/profiles/commons/modules/contrib/views_load_more/views_load_more.info
index 3e6b27c..ca3caa4 100644
--- a/profiles/commons/modules/contrib/views_load_more/views_load_more.info
+++ b/profiles/commons/modules/contrib/views_load_more/views_load_more.info
@@ -1,14 +1,14 @@
 name = Views Load More
-description = Yet another load more pager for views
+description = A pager plugin for views. Gives users the option to add a 'more' button to a view and have the results appended to existing results being displayed.
 core = 7.x
 package = Views
 dependencies[] = views
 files[] = views_load_more.views.inc
 files[] = views_plugin_pager_load_more.inc
 
-; Information added by drupal.org packaging script on 2011-07-31
-version = "7.x-1.1"
+; Information added by  packaging script on 2013-11-27
+version = "7.x-1.2"
 core = "7.x"
 project = "views_load_more"
-datestamp = "1312075027"
+datestamp = "1385582308"
 
diff --git a/profiles/commons/modules/contrib/views_load_more/views_load_more.js b/profiles/commons/modules/contrib/views_load_more/views_load_more.js
index 44e1e30..15c03c4 100644
--- a/profiles/commons/modules/contrib/views_load_more/views_load_more.js
+++ b/profiles/commons/modules/contrib/views_load_more/views_load_more.js
@@ -13,6 +13,7 @@
     // our presets.
     var wrapper = response.selector ? $(response.selector) : $(ajax.wrapper);
     var method = response.method || ajax.method;
+    var targetList = response.targetList || '';
     var effect = ajax.getEffect(response);
 
     // We don't know what response.data contains: it might be a string of text
@@ -39,38 +40,85 @@
     // If removing content from the wrapper, detach behaviors first.
     var settings = response.settings || ajax.settings || Drupal.settings;
     Drupal.detachBehaviors(wrapper, settings);
+    if ($.waypoints != undefined) {
+      $.waypoints('refresh');
+    }
+
+    // Set up our default query options. This is for advance users that might
+    // change there views layout classes. This allows them to write there own
+    // jquery selector to replace the content with.
+    // Provide sensible defaults for unordered list, ordered list and table
+    // view styles.
+    var content_query = targetList && !response.options.content ? '.view-content ' + targetList : response.options.content || '.view-content';
+
+    // If we're using any effects. Hide the new content before adding it to the DOM.
+    if (effect.showEffect != 'show') {
+      new_content.find(content_query).children().hide();
+    }
 
     // Add the new content to the page.
     wrapper.find('.pager a').remove();
-    wrapper.find('.pager').html(new_content.find('.pager'));
-    wrapper.find('.view-content')[method](new_content.find('.views-row'));
+    wrapper.find('.pager').parent('.item-list').html(new_content.find('.pager'));
+    wrapper.find(content_query)[method](new_content.find(content_query).children());
+
+    // Re-class the loaded content.
+    wrapper.find(content_query).children()
+      .removeClass('views-row-first views-row-last views-row-odd views-row-even')
+      .filter(':first')
+        .addClass('views-row-first')
+        .end()
+      .filter(':last')
+        .addClass('views-row-last')
+        .end()
+      .filter(':even')
+        .addClass('views-row-odd')
+        .end()
+      .filter(':odd')
+        .addClass('views-row-even')
+        .end();
+
+    if (effect.showEffect != 'show') {
+      wrapper.find(content_query).children(':not(:visible)')[effect.showEffect](effect.showSpeed);
+    }
+
+    // Additional processing over new content
+    wrapper.trigger('views_load_more.new_content', new_content.clone());
 
     // Attach all JavaScript behaviors to the new content
-    wrapper.removeClass('views-processed');
+    // Remove the Jquery once Class, TODO: There needs to be a better
+    // way of doing this, look at .removeOnce() :-/
+    var classes = wrapper.attr('class');
+    var onceClass = classes.match(/jquery-once-[0-9]*-[a-z]*/);
+    wrapper.removeClass(onceClass[0]);
     var settings = response.settings || ajax.settings || Drupal.settings;
     Drupal.attachBehaviors(wrapper, settings);
-
-    if (new_content.parents('html').length > 0) {
-      // Apply any settings from the returned JSON if available.
-    }
   }
 
   /**
    * Attaches the AJAX behavior to Views Load More waypoint support.
    */
-  Drupal.behaviors.ViewsLoadMore = {};
-  Drupal.behaviors.ViewsLoadMore.attach = function() {
-    if (Drupal.settings && Drupal.settings.viewsLoadMore && Drupal.settings.views.ajaxViews) {
-      opts = {
-        offset: '100%'
-      };
-      $.each(Drupal.settings.viewsLoadMore, function(i, settings) {
-        var view = '.view-' + settings.view_name + '.view-display-id-' + settings.view_display_id + ' .pager-next a';
-        $(view).bind('waypoint.reached', function(event, direction) {
-           $(view).click();
+  Drupal.behaviors.ViewsLoadMore = {
+    attach: function (context, settings) {
+      if (settings && settings.viewsLoadMore && settings.views.ajaxViews) {
+        opts = {
+          offset: '100%'
+        };
+        $.each(settings.viewsLoadMore, function(i, setting) {
+          var view = '.view-id-' + setting.view_name + '.view-display-id-' + setting.view_display_id + ' .pager-next a';
+          $(view).waypoint(function(event, direction) {
+            $(view).waypoint('remove');
+            $(view).click();
+          }, opts);
+        });
+      }
+    },
+    detach: function (context, settings, trigger) {
+      if (settings && Drupal.settings.viewsLoadMore && settings.views.ajaxViews) {
+        $.each(settings.viewsLoadMore, function(i, setting) {
+          var view = '.view-id-' + setting.view_name + '.view-display-id-' + setting.view_display_id + ' .pager-next a';
+          $(view, context).waypoint('destroy');
         });
-        $(view).waypoint(opts);
-      });
+      }
     }
-  };
+     };
 })(jQuery);
diff --git a/profiles/commons/modules/contrib/views_load_more/views_load_more.module b/profiles/commons/modules/contrib/views_load_more/views_load_more.module
index 93648c9..00403c0 100644
--- a/profiles/commons/modules/contrib/views_load_more/views_load_more.module
+++ b/profiles/commons/modules/contrib/views_load_more/views_load_more.module
@@ -1,6 +1,13 @@
 <?php
 
 /**
+ * @file views_load_more.module
+ *
+ * A Views pager module to allow new content to be appended to the bottom
+ * of a view instead of replacing it.
+ */
+
+/**
  * Implementation of hook_views_api().
  */
 function views_load_more_views_api() {
@@ -25,29 +32,56 @@ function views_load_more_theme() {
  * Implements hook_views_ajax_data_alter().
  */
 function views_load_more_views_ajax_data_alter(&$commands, $view) {
+  // Support No results behavior.
+  if (!$view->total_rows) {
+    return;
+  }
+
   if (is_a($view->query->pager, 'views_plugin_pager_load_more')) {
+    // This is a work-around for allowing exposed for on the page.
+    if ($view->query->pager->current_page == 0) {
+      return;
+    }
     foreach ($commands as $key => $command) {
-      // the replace should the only one, but just incase, we'll make sure.
+      // remove "viewsScrollTop" command, as this behavior is unnecessary.
+      if ($command['command'] == 'viewsScrollTop') {
+        unset($commands[$key]);
+      }
+      // the replace should the only one, but just in case, we'll make sure.
       if ($command['command'] == 'insert' && $command['selector'] == '.view-dom-id-' . $view->dom_id) {
+        if ($view->style_plugin->options['type'] == 'ul' || $view->style_plugin->options['type'] == 'ol') {
+          $target = ".{$view->style_plugin->options['wrapper_class']} > {$view->style_plugin->options['type']}:not(.links)";
+          $commands[$key]['targetList'] = $target;
+        }
+        if ($view->style_plugin->plugin_name == 'table') {
+          $target = '.views-table tbody';
+          $commands[$key]['targetList'] = $target;
+        }
+
         $commands[$key]['command'] = 'viewsLoadMoreAppend';
         $commands[$key]['method'] = 'append';
+        if (isset($view->query->pager->options['effects']) && $view->query->pager->options['effects']['type'] != 'none') {
+          $commands[$key]['effect'] = $view->query->pager->options['effects']['type'];
+          $commands[$key]['speed'] = $view->query->pager->options['effects']['speed'];
+        }
+        $commands[$key]['options'] = array(
+          'content' => $view->query->pager->options['advance']['content_class'],
+        );
       }
     }
   }
 }
 
 function theme_views_load_more_pager($vars) {
-  global $pager_page_array, $pager_total;  
+  global $pager_page_array, $pager_total;
 
-  drupal_add_js(drupal_get_path('module', 'views_load_more').'/views_load_more.js');
-  
   $tags = $vars['tags'];
   $element = $vars['element'];
   $parameters = $vars['parameters'];
 
   $li_next = theme('pager_next',
     array(
-      'text' => (isset($tags[3]) ? $tags[3] : t('Load More')),
+      'text' => (isset($tags[3]) ? $tags[3] : t($vars['more_button_text'])),
       'element' => $element,
       'interval' => 1,
       'parameters' => $parameters,
@@ -67,8 +101,21 @@ function theme_views_load_more_pager($vars) {
         'items' => $items,
         'title' => NULL,
         'type' => 'ul',
-        'attributes' => array('class' => array('pager')),
+        'attributes' => array('class' => array('pager', 'pager-load-more')),
       )
     );
   }
 }
+
+/**
+ * Implements hook_views_pre_render().
+ *
+ * Load js file only if ajax is enabled.
+ */
+function views_load_more_views_pre_render(&$view) {
+  if (!$view->use_ajax) {
+    return;
+  }
+
+  drupal_add_js(drupal_get_path('module', 'views_load_more') . '/views_load_more.js');
+}
diff --git a/profiles/commons/modules/contrib/views_load_more/views_load_more.views.inc b/profiles/commons/modules/contrib/views_load_more/views_load_more.views.inc
index 023e8a1..6a1ec7f 100644
--- a/profiles/commons/modules/contrib/views_load_more/views_load_more.views.inc
+++ b/profiles/commons/modules/contrib/views_load_more/views_load_more.views.inc
@@ -1,11 +1,12 @@
 <?php
 /**
  * @file
+ *
  *  Provides the views plugin information.
  */
 
 /**
- * Implements hook_views_plugins
+ * Implements hook_views_plugins().
  */
 function views_load_more_views_plugins() {
   return array(
@@ -20,4 +21,4 @@ function views_load_more_views_plugins() {
       ),
     ),
   );
-}
\ No newline at end of file
+}
diff --git a/profiles/commons/modules/contrib/views_load_more/views_plugin_pager_load_more.inc b/profiles/commons/modules/contrib/views_load_more/views_plugin_pager_load_more.inc
index 759c035..936bba4 100644
--- a/profiles/commons/modules/contrib/views_load_more/views_plugin_pager_load_more.inc
+++ b/profiles/commons/modules/contrib/views_load_more/views_plugin_pager_load_more.inc
@@ -1,11 +1,18 @@
 <?php
 
 /**
+ * @file
+ *
  * The plugin to handle Load More pager.
  *
  * @ingroup views_pager_plugins
  */
+
 class views_plugin_pager_load_more extends views_plugin_pager_full {
+
+  /**
+   * Summary title overwrite.
+   */
   function summary_title() {
     if (!empty($this->options['offset'])) {
       return format_plural($this->options['items_per_page'], 'Load more pager, @count item, skip @skip', 'Load more pager, @count items, skip @skip', array('@count' => $this->options['items_per_page'], '@skip' => $this->options['offset']));
@@ -13,18 +20,48 @@ class views_plugin_pager_load_more extends views_plugin_pager_full {
       return format_plural($this->options['items_per_page'], 'Load more pager, @count item', 'Load more pager, @count items', array('@count' => $this->options['items_per_page']));
   }
 
+  /**
+   * Options definition overwrite.
+   */
   function option_definition() {
     $options = parent::option_definition();
     $options['waypoint'] = array(
       'contains' => array(
         'infinite' => array('default' => FALSE),
-      )
+      ),
+    );
+    $options['more_button_text'] = array(
+      'default' => t('Load more'),
+      'translateable' => TRUE,
+    );
+    $options['advance'] = array(
+      'contains' => array(
+        'row_class' => array('default' => ''),
+        'content_class' => array('default' => ''),
+      ),
     );
     return $options;
   }
 
+  /**
+   * Options form overwrite.
+   */
   function options_form(&$form, &$form_state) {
     parent::options_form($form, $form_state);
+
+    // Keep items per page as the first form element on the page followed by
+    // the option to change the 'load more' button text
+    $form['items_per_page']['#weight'] = -2;
+
+    // Option for users to specify the text used on the 'load more' button.
+    $form['more_button_text'] = array(
+      '#type' => 'textfield',
+      '#title' => t('More link text'),
+      '#description' => t('The text that will be displayed on the link that is used to load more elements. For example "Show me more"'),
+      '#default_value' => $this->options['more_button_text'] ? $this->options['more_button_text'] : t('Load more'),
+      '#weight' => -1,
+    );
+
     if (module_exists('waypoints')) {
       $form['waypoint'] = array(
         '#type' => 'fieldset',
@@ -42,8 +79,58 @@ class views_plugin_pager_load_more extends views_plugin_pager_full {
         '#default_value' => $this->options['waypoint']['infinite'],
       );
     }
+    $form['advance'] = array(
+      '#type' => 'fieldset',
+      '#collapsible' => TRUE,
+      '#collapsed' => TRUE,
+      '#tree' => TRUE,
+      '#title' =>  t('Advance Options'),
+      '#input' => TRUE,
+      '#description' => t('Configure advance options.'),
+    );
+    $form['advance']['content_class'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Content selection selector'),
+      '#description' => t('Use for advance replace selector, extremely useful when overwriting the views tpl.'),
+      '#default_value' => $this->options['advance']['content_class'],
+    );
+    $form['effects'] = array(
+      '#type' => 'fieldset',
+      '#collapsible' => TRUE,
+      '#collapsed' => TRUE,
+      '#tree' => TRUE,
+      '#title' =>  t('JQuery Effects'),
+      '#input' => TRUE,
+    );
+    $form['effects']['type'] = array(
+      '#type' => 'select',
+      '#options' => array(
+        'none' => t('None'),
+        'fade' => t('Fade'),
+      ),
+      '#default_vaue' => 'none',
+      '#title' => t('Effect Type'),
+      '#default_value' => $this->options['effects']['type'],
+    );
+    $form['effects']['speed'] = array(
+      '#type' => 'select',
+      '#options' => array(
+        'slow' => t('Slow'),
+        'fast' => t('Fast'),
+      ),
+      '#states' => array(
+        'visible' => array(
+          '#edit-pager-options-effects-type' => array('value' => t('fade')),
+        ),
+      ),
+      '#title' => t('Effect Speed'),
+      '#default_value' => $this->options['effects']['speed'],
+    );
   }
 
+  /**
+   * render overwrite.
+   */
   function render($input) {
     if (module_exists('waypoints') && $this->options['waypoint']['infinite'] == 1) {
       $viewsLoadMore = array();
@@ -57,8 +144,13 @@ class views_plugin_pager_load_more extends views_plugin_pager_full {
     }
 
     $pager_theme = views_theme_functions('views_load_more_pager', $this->view, $this->display);
-    return theme($pager_theme, array(
-      'parameters' => $input, 'element' => $this->options['id']));
+
+    $vars = array(
+      'parameters' => $input,
+      'element' => $this->options['id'],
+      'more_button_text' => $this->options['more_button_text'],
+    );
+
+    return theme($pager_theme, $vars);
   }
 }
-
diff --git a/profiles/commons/scripts/build_distro.sh b/profiles/commons/scripts/build_distro.sh
index c0a9aae..3396ac3 100755
--- a/profiles/commons/scripts/build_distro.sh
+++ b/profiles/commons/scripts/build_distro.sh
@@ -1,5 +1,5 @@
 #!/bin/bash
-set -e
+#set -e
 
 #modules=(commons_activity_streams commons_featured commons_notices commons_profile_social commons_user_profile_pages commons_body commons_follow commons_notify commons_q_a commons_utility_links commons_bw commons_groups commons_pages commons_radioactivity commons_wikis commons_content_moderation commons_like commons_polls commons_search commons_wysiwyg commons_documents commons_location commons_posts commons_site_homepage commons_events commons_misc commons_profile_base commons_topics commons_social_sharing commons_trusted_contacts)
 themes=(commons_origins)
@@ -42,17 +42,15 @@ pull_git() {
     git pull origin 7.x-3.x
 
     cd $BUILD_PATH/repos/modules
-    for i in "${modules[@]}"; do
+    for i in `ls | awk -F/ '{print $1}'`; do
       echo $i
       cd $i
       if [[ -n $RESET ]]; then
         git reset --hard HEAD
       fi
-      git pull origin 7.x-3.x
+      git pull origin
       cd ..
     done
-    cd $BUILD_PATH/repos/themes/commons_origins
-    git pull origin 7.x-3.x
 }
 
 release_notes() {
@@ -84,36 +82,72 @@ release_notes() {
 }
 
 build_distro() {
-    if [[ -d $BUILD_PATH ]]; then
-        cd $BUILD_PATH
-        rm -rf ./publish
-        # do we have the profile?
-        if [[ -d $BUILD_PATH/commons_profile ]]; then
-          if [[ -d $BUILD_PATH/repos ]]; then
-            rm -f /tmp/commons.tar.gz
-            drush make --no-cache --no-core --contrib-destination --tar $BUILD_PATH/commons_profile/drupal-org.make /tmp/commons
-            drush make --no-cache --prepare-install --drupal-org=core $BUILD_PATH/commons_profile/drupal-org-core.make ./publish
-          else
-            mkdir $BUILD_PATH/repos
-            mkdir $BUILD_PATH/repos/modules
-            mkdir $BUILD_PATH/repos/themes
-            build_distro $BUILD_PATH
-          fi
-          # symlink the profile to our dev copy
-          chmod -R 777 $BUILD_PATH/publish/sites/default
-          rm -rf publish/profiles/commons
-          ln -s $BUILD_PATH/commons_profile publish/profiles/commons
-          cd publish/profiles
-          tar -zxvf /tmp/commons.tar.gz
-          chmod -R 775 $BUILD_PATH/publish/profiles/commons
+  if [[ -d $BUILD_PATH ]]; then
+      cd $BUILD_PATH
+      #backup the sites directory
+      if [[ -d docroot ]]; then
+        rm -rf ./docroot
+      fi
+      # do we have the profile?
+      if [[ -d $BUILD_PATH/commons_profile ]]; then
+        if [[ -d $BUILD_PATH/repos ]]; then
+          rm -f /tmp/commons.tar.gz
+          drush make --no-cache --prepare-install --drupal-org=core $BUILD_PATH/commons_profile/drupal-org-core.make $BUILD_PATH/docroot
+          drush make --no-cache --no-core --contrib-destination --tar $BUILD_PATH/commons_profile/drupal-org.make /tmp/commons
         else
-          git clone --branch 7.x-3.x-merged ${USERNAME}@git.drupal.org:project/commons.git commons_profile
+          mkdir $BUILD_PATH/repos
+          mkdir $BUILD_PATH/repos/modules
+          mkdir $BUILD_PATH/repos/themes
           build_distro $BUILD_PATH
         fi
-    else
-      mkdir $BUILD_PATH
-      build_distro $BUILD_PATH $USERNAME
-    fi
+        # symlink the profile sites folder to our dev copy
+        cd docroot
+        if [[ -d $BUILD_PATH/sites ]]; then
+          rm -rf $BUILD_PATH/docroot/sites
+          ln -s ../sites $BUILD_PATH/docroot/sites
+        else
+          mv $BUILD_PATH/docroot/sites $BUILD_PATH/sites
+          ln -s ../sites $BUILD_PATH/docroot/sites
+        fi
+        chmod -R 777 $BUILD_PATH/docroot/sites/default
+
+        ## put commons profile and modules into the profile folder
+        rm -rf docroot/profiles/commons
+        if [ -a $BUILD_PATH/repos.txt ]; then
+          UNTAR="tar -zxvf /tmp/commons.tar.gz -X $BUILD_PATH/repos.txt"
+        else
+          cd $BUILD_PATH/repos
+          find * -mindepth 1 -maxdepth 1 -type d -not -name '.*' | awk -F/ '{print $1 "/" $2}' > /tmp/repos.txt
+          # exclude repos since we're updating already by linking it to the repos directory.
+          UNTAR="tar -zxvf /tmp/commons.tar.gz -X /tmp/repos.txt"
+        fi
+        cd $BUILD_PATH/docroot/profiles
+        eval $UNTAR
+        cd commons
+        ln -s ../../../commons_profile/* .
+        ln -s ../../../../commons_profile/modules/commons ${BUILD_PATH}/docroot/profiles/commons/modules/
+        ln -s ../../../../commons_profile/themes/commons ${BUILD_PATH}/docroot/profiles/commons/themes/
+        for line in $(cat $BUILD_PATH/repos.txt); do
+          ln -s ../../../../../../repos/${line} ${BUILD_PATH}/docroot/profiles/commons/$(echo ${line} | awk -F/ '{print $1}')/contrib/
+        done
+        chmod -R 775 $BUILD_PATH/docroot/profiles/commons
+      else
+        git clone --branch 7.x-3.x ${USERNAME}@git.drupal.org:project/commons.git commons_profile
+        build_distro $BUILD_PATH
+      fi
+  else
+    mkdir $BUILD_PATH
+    build_distro $BUILD_PATH $USERNAME
+  fi
+}
+
+site_install() {
+  read -p "You're about to DESTROY all data for site ${SITE} Are you sure? " -n 1 -r
+  if [[ $REPLY =~ ^[Yy]$ ]]; then
+    cd ${BUILD_PATH}/docroot/sites/${SITE}
+    drush -y sql-drop
+    drush site-install --site-name=${SITE} --account-name=admin --account-pass=${ADMIN_PASS} --account-mail=${ADMIN_EMAIL} --site-mail=commons_site@example.com -v -y commons commons_anonymous_welcome_text_form.commons_install_example_content=${DEMO_CONTENT} commons_anonymous_welcome_text_form.commons_anonymous_welcome_title="Commons Example Site" commons_anonymous_welcome_text_form.commons_anonymous_welcome_body="Using the site-install version of commons." commons_create_first_group.commons_first_group_title="Sales Group" commons_create_first_group.commons_first_group_body="This is the sales group from site-install."
+  fi
 }
 
 # This allows you to test the make file without needing to upload it to drupal.org and run the main make file.
@@ -123,15 +157,16 @@ update() {
     # do we have the profile?
     if [[ -d $DOCROOT/profiles/commons ]]; then
       # do we have an installed commons profile?
-        rm -f /tmp/publish.tar.gz
+        rm -f /tmp/docroot.tar.gz
         rm -f /tmp/commons.tar.gz
-        drush make --tar --drupal-org=core profiles/commons/drupal-org-core.make /tmp/publish
-        drush make --tar --drupal-org profiles/commons/drupal-org.make /tmp/commons
+        drush make --no-cache --tar --drupal-org=core profiles/commons/drupal-org-core.make /tmp/docroot
+        drush make --no-core --no-cache --tar --drupal-org profiles/commons/drupal-org.make /tmp/commons
         cd ..
-        tar -zxvf /tmp/publish.tar.gz
-        cd publish/profiles
+        tar -zxvf /tmp/docroot.tar.gz
+        cd docroot/profiles/commons/modules/contrib
         # remove the symlinks in the repos before we execute
-        find . -mindepth 2 -type l | awk -F/ '{print $5}' | sed '/^$/d' > /tmp/repos.txt
+        find . -type l | awk -F/ '{print $2}' > /tmp/repos.txt
+        cd $DOCROOT/profiles
         # exclude repos since we're updating already by linking it to the repos directory.
         UNTAR="tar -zxvf /tmp/commons.tar.gz -X /tmp/repos.txt"
         eval $UNTAR
@@ -144,6 +179,34 @@ update() {
 }
 
 case $1 in
+  site-install)
+    if [[ -n $2 ]] && [[ -n $3 ]]; then
+      BUILD_PATH=$2
+    else
+      echo "Usage build_distro.sh site-install [build_path] [site] [admin-email] [admin-pass]"
+    fi
+    if [[ -n $3 ]]; then
+      SITE=$3
+    else
+      SITE='default'
+    fi
+    if [[ -n $4 ]]; then
+      DEMO_CONTENT='TRUE'
+    else
+      DEMO_CONTENT='FALSE'
+    fi
+    if [[ -n $5 ]]; then
+      ADMIN_EMAIL=$4
+    else
+      ADMIN_EMAIL='admin@example.com'
+    fi
+    if [[ -n $6 ]]; then
+      ADMIN_PASS=$4
+    else
+      ADMIN_PASS='admin'
+    fi
+
+    site_install $BUILD_PATH $SITE $DEMO_CONTENT $ADMIN_EMAIL $ADMIN_PASS;;
   pull)
     if [[ -n $2 ]]; then
       BUILD_PATH=$2
@@ -181,7 +244,7 @@ case $1 in
     if [[ -n $2 ]]; then
       DOCROOT=$2
     else
-      echo "Usage: build_distro.sh test_makefile [build_path]"
+      echo "Usage: build_distro.sh update [DOCROOT]"
       exit 1
     fi
     if [[ -n $3 ]]; then
diff --git a/profiles/commons/tests/bin/behat b/profiles/commons/tests/bin/behat
new file mode 120000
index 0000000..ec35dd9
--- /dev/null
+++ b/profiles/commons/tests/bin/behat
@@ -0,0 +1 @@
+../vendor/behat/behat/bin/behat
\ No newline at end of file
diff --git a/profiles/commons/tests/bin/webunit b/profiles/commons/tests/bin/webunit
new file mode 120000
index 0000000..8f25c7b
--- /dev/null
+++ b/profiles/commons/tests/bin/webunit
@@ -0,0 +1 @@
+../vendor/instaclick/php-webdriver/bin/webunit
\ No newline at end of file
diff --git a/profiles/commons/themes/commons/commons_origins/commons_origins.info b/profiles/commons/themes/commons/commons_origins/commons_origins.info
index 761fa85..94db1af 100644
--- a/profiles/commons/themes/commons/commons_origins/commons_origins.info
+++ b/profiles/commons/themes/commons/commons_origins/commons_origins.info
@@ -420,9 +420,9 @@
 
   ;
 
-; Information added by drupal.org packaging script on 2013-10-17
-version = "7.x-3.4"
+; Information added by Drupal.org packaging script on 2013-12-20
+version = "7.x-3.6"
 core = "7.x"
 project = "commons"
-datestamp = "1382042464"
+datestamp = "1387568907"
 
diff --git a/profiles/commons/themes/commons/commons_origins/css/global.styles.css b/profiles/commons/themes/commons/commons_origins/css/global.styles.css
index 9fa7ba6..2c47c1a 100644
--- a/profiles/commons/themes/commons/commons_origins/css/global.styles.css
+++ b/profiles/commons/themes/commons/commons_origins/css/global.styles.css
@@ -875,6 +875,7 @@ html.js fieldset.collapsed .fieldset-legend, html.js fieldset.collapsible .field
  * Button styles
  */
 /* Common styles for all buttons. */
+a.button,
 button,
 [type="reset"],
 [type="submit"],
@@ -908,6 +909,7 @@ button,
   outline: 0;
   cursor: pointer;
 }
+a.button:focus,
 button:focus,
 [type="reset"]:focus,
 [type="submit"]:focus,
@@ -921,6 +923,7 @@ button:focus,
 .commons-login:hover, [class*="action-item-large"]:hover {
   text-decoration: none;
 }
+a.button:active,
 button:active,
 [type="reset"]:active,
 [type="submit"]:active,
@@ -932,6 +935,7 @@ button:active,
   box-shadow: inset rgba(0, 0, 0, 0.25) 0 1px 2px 0;
   text-decoration: none;
 }
+a.button::-moz-focus-inner,
 button::-moz-focus-inner,
 [type="reset"]::-moz-focus-inner,
 [type="submit"]::-moz-focus-inner,
@@ -943,6 +947,7 @@ button::-moz-focus-inner,
 }
 
 /* Dimensions for the default button type. */
+a.button,
 button,
 [type="reset"],
 [type="submit"],
@@ -965,6 +970,7 @@ button,
   font-size: 1.2em;
 }
 
+a.button,
 button,
 [type="reset"],
 [type="submit"],
@@ -979,6 +985,7 @@ button,
   border-color: #cbcbcb;
   text-shadow: -1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, 1px 1px 2px white;
 }
+a.button,
 button,
 [type="reset"],
 [type="submit"],
@@ -994,6 +1001,7 @@ button,
 [class*="action-item"]:visited, .commons-login:visited {
   color: #323232;
 }
+a.button:hover,
 button:hover,
 [type="reset"]:hover,
 [type="submit"]:hover,
@@ -1007,8 +1015,10 @@ button:hover,
   background: -o-linear-gradient(#fefefe, #e5e5e5);
   background: linear-gradient(#fefefe, #e5e5e5);
   border-color: #b2b2b2;
+  text-decoration: none;
   text-shadow: -1px 1px 2px #fefefe, -1px -1px 2px #fefefe, 1px -1px 2px #fefefe, 1px 1px 2px #fefefe;
 }
+a.button:focus,
 button:focus,
 [type="reset"]:focus,
 [type="submit"]:focus,
@@ -1027,6 +1037,7 @@ button:focus,
   border-color: #cbcbcb;
   text-shadow: -1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, 1px 1px 2px white;
 }
+a.button[disabled],
 button[disabled],
 [disabled][type="reset"],
 [disabled][type="submit"],
@@ -1049,7 +1060,7 @@ button[disabled],
 .action-item-large-active,
 .action-item-large-active[type="reset"],
 .action-item-large-active[type="submit"],
-.action-item-large-active[type="button"], [class*="flag-commons-follow-"] .unflag-action {
+.action-item-large-active[type="button"], [class*="flag-commons-follow-"] a.unflag-action {
   background-color: #f3f3f3;
   -webkit-box-shadow: inset 0.1em 0.1em 0.2em #a6a6a6;
   -moz-box-shadow: inset 0.1em 0.1em 0.2em #a6a6a6;
@@ -1065,16 +1076,16 @@ button[disabled],
 .action-item-large-active,
 .action-item-large-active[type="reset"],
 .action-item-large-active[type="submit"],
-.action-item-large-active[type="button"], [class*="flag-commons-follow-"] .unflag-action, .action-item-active:link,
+.action-item-large-active[type="button"], [class*="flag-commons-follow-"] a.unflag-action, .action-item-active:link,
 .action-item-small-active:link,
-.action-item-large-active:link, [class*="flag-commons-follow-"] .unflag-action:link, .action-item-active:visited,
+.action-item-large-active:link, [class*="flag-commons-follow-"] a.unflag-action:link, .action-item-active:visited,
 .action-item-small-active:visited,
-.action-item-large-active:visited, [class*="flag-commons-follow-"] .unflag-action:visited {
+.action-item-large-active:visited, [class*="flag-commons-follow-"] a.unflag-action:visited {
   color: #272727;
 }
 .action-item-active:hover,
 .action-item-small-active:hover,
-.action-item-large-active:hover, [class*="flag-commons-follow-"] .unflag-action:hover {
+.action-item-large-active:hover, [class*="flag-commons-follow-"] a.unflag-action:hover {
   color: #343434;
   background-color: #e6e6e6;
   -webkit-box-shadow: inset 0.1em 0.1em 0.2em #9a9a9a;
@@ -1085,9 +1096,9 @@ button[disabled],
 }
 .action-item-active:focus,
 .action-item-small-active:focus,
-.action-item-large-active:focus, [class*="flag-commons-follow-"] .unflag-action:focus, .action-item-active:active,
+.action-item-large-active:focus, [class*="flag-commons-follow-"] a.unflag-action:focus, .action-item-active:active,
 .action-item-small-active:active,
-.action-item-large-active:active, [class*="flag-commons-follow-"] .unflag-action:active {
+.action-item-large-active:active, [class*="flag-commons-follow-"] a.unflag-action:active {
   background: #f3f3f3;
   -webkit-box-shadow: inset 0.1em 0.1em 0.2em #a6a6a6;
   -moz-box-shadow: inset 0.1em 0.1em 0.2em #a6a6a6;
@@ -1395,6 +1406,12 @@ button,
 }
 
 /* Report as inappropriate */
+.flag-inappropriate-node,
+.flag-inappropriate-comment {
+  display: block;
+  clear: both;
+  margin: 1em 0 0;
+}
 .flag-inappropriate-node .flag-action:before,
 .flag-inappropriate-comment .flag-action:before {
   content: "";
@@ -2256,6 +2273,13 @@ h1.node-title a:hover {
   margin-bottom: .2em;
 }
 
+ul.comment-links {
+  margin: .7em 0;
+}
+ul.comment-links li {
+  padding-left: 0;
+}
+
 .comment-reply {
   float: right;
 }
@@ -4382,7 +4406,11 @@ body.front.logged-in .view-commons-homepage-content .article.node.node-page .lin
 #quicktabs-commons_follow_ui .flag-email-group a span,
 #quicktabs-commons_follow_ui .flag-email-node a span,
 #quicktabs-commons_follow_ui .flag-email-user a span,
-#quicktabs-commons_follow_ui .flag-email-term a span {
+#quicktabs-commons_follow_ui .flag-email-term a span,
+#quicktabs-commons_follow_ui .flag-email-group span span,
+#quicktabs-commons_follow_ui .flag-email-node span span,
+#quicktabs-commons_follow_ui .flag-email-user span span,
+#quicktabs-commons_follow_ui .flag-email-term span span {
   display: none;
 }
 
diff --git a/profiles/commons/themes/commons/commons_origins/css/responsive.desktop.css b/profiles/commons/themes/commons/commons_origins/css/responsive.desktop.css
index 295f711..3c4eb6a 100644
--- a/profiles/commons/themes/commons/commons_origins/css/responsive.desktop.css
+++ b/profiles/commons/themes/commons/commons_origins/css/responsive.desktop.css
@@ -7,19 +7,3 @@
  *
  * - Read the _README file in this directory, it contains useful help and other information.
  */
-.flag-inappropriate-node {
-  position: absolute;
-  margin: 0;
-  right: 0;
-  bottom: 0;
-  filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=0);
-  opacity: 0;
-  -webkit-transition: opacity 0.5s;
-  -moz-transition: opacity 0.5s;
-  -o-transition: opacity 0.5s;
-  transition: opacity 0.5s;
-}
-.node:hover .flag-inappropriate-node {
-  filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=100);
-  opacity: 1;
-}
diff --git a/profiles/commons/themes/commons/commons_origins/sass/global.styles.scss b/profiles/commons/themes/commons/commons_origins/sass/global.styles.scss
index b904a44..ca98417 100755
--- a/profiles/commons/themes/commons/commons_origins/sass/global.styles.scss
+++ b/profiles/commons/themes/commons/commons_origins/sass/global.styles.scss
@@ -1027,6 +1027,10 @@ button,
 /* Report as inappropriate */
 .flag-inappropriate-node,
 .flag-inappropriate-comment, {
+  display: block;
+  clear: both;
+  margin: 1em 0 0;
+
   .flag-action {
     &:before {
       content: "";
@@ -1745,6 +1749,14 @@ h1.node-title {
   margin-bottom: .2em;
 }
 
+ul.comment-links {
+  margin: .7em 0;
+
+  li {
+    padding-left: 0;
+  }
+}
+
 .comment-reply {
   float: right;
 
diff --git a/profiles/commons/themes/commons/commons_origins/sass/responsive.desktop.scss b/profiles/commons/themes/commons/commons_origins/sass/responsive.desktop.scss
index 5d4f619..75eb2e7 100755
--- a/profiles/commons/themes/commons/commons_origins/sass/responsive.desktop.scss
+++ b/profiles/commons/themes/commons/commons_origins/sass/responsive.desktop.scss
@@ -11,16 +11,3 @@
  *
  * - Read the _README file in this directory, it contains useful help and other information.
  */
-
-.flag-inappropriate-node {
-  position: absolute;
-  margin: 0;
-  right: 0;
-  bottom: 0;
-  @include opacity(0);
-  @include transition(opacity 0.5s);
-
-  .node:hover & {
-    @include opacity(1);
-  }
-}
diff --git a/profiles/commons/themes/commons/commons_origins/scripts/commons_origins.js b/profiles/commons/themes/commons/commons_origins/scripts/commons_origins.js
index 43f28eb..0949fe5 100644
--- a/profiles/commons/themes/commons/commons_origins/scripts/commons_origins.js
+++ b/profiles/commons/themes/commons/commons_origins/scripts/commons_origins.js
@@ -20,6 +20,22 @@ jQuery(document).ready(function($){
     });
   };
 
+  var set_disabled_checkboxes = function(){
+    $('#quicktabs-commons_follow_ui .flag-email-group span, #quicktabs-commons_follow_ui .flag-email-node span, #quicktabs-commons_follow_ui .flag-email-user span, #quicktabs-commons_follow_ui .flag-email-term span').each(function(){
+      var a_target = $(this).addClass('formatted-as-checkbox').removeClass('action-item-small action-item-small-active');
+
+      if (a_target.children('span').length === 0) {
+        a_target.wrapInner('<span></span>');
+      }
+
+      if (a_target.hasClass('flag-action') && a_target.children('input').length === 0) {
+        a_target.prepend('<input type="checkbox" disabled="disabled">');
+      } else if (a_target.children('input').length === 0) {
+        a_target.prepend('<input type="checkbox" disabled="disabled" checked>');
+      }
+    });
+  };
+
   $(document).delegate('.views-exposed-widgets .form-select', 'change', function() {
     $('.views-exposed-widgets').addClass('widget-changed');
   });
@@ -27,12 +43,16 @@ jQuery(document).ready(function($){
   $(document).delegate('.views-exposed-widgets .form-select', 'click', function() {
     $('.views-exposed-widgets').addClass('widgets-active');
   });
+  console.log($('#quicktabs-commons_follow_ui a.flag').length);
+  if($('#quicktabs-commons_follow_ui a.flag').length > 0) {
+      set_follow_checkboxes();
 
-  set_follow_checkboxes();
-
-  $(document).ajaxComplete(function(){
-    set_follow_checkboxes();
-  });
+      $(document).ajaxComplete(function(){
+        set_follow_checkboxes();
+      });
+  } else {
+      set_disabled_checkboxes();
+  }
 });
 
 (function ($) {
@@ -78,7 +98,7 @@ jQuery(document).ready(function($){
         });
       }
     }
-  }
+  };
 
   /**
    * Define a variable height on fieldsets to accommodate multi-line layouts.
@@ -94,12 +114,12 @@ jQuery(document).ready(function($){
 
         // Adjust the height on window resize.
         $(window).resize(function () {
-          var minHeight = $fieldset.find('legend').height();
+          var minHeight = fieldset.find('legend').height();
           fieldset.css('min-height', minHeight + 'px');
         });
       });
     }
-  }
+  };
 
   /**
    * Make an item follow the page when an item is in view.
@@ -133,7 +153,7 @@ jQuery(document).ready(function($){
         var filters = $(this),
             filterTrigger = $('<a/>', {'href': '#filter-drawer', 'class': 'filter-trigger', 'id': 'filter-drawer'}).text(Drupal.t('Filter results')),
             filterOverlay = $('<div/>', {'class': 'filter-overlay'}),
-            results = $('.search-results-content, .pane-search-result');
+            results = $('.search-results-content, .pane-search-result'),
             size = $(window).width(),
             triggerWidth = '';
 
@@ -199,5 +219,5 @@ jQuery(document).ready(function($){
         }
       });
     }
-  }
+  };
 })(jQuery);
diff --git a/profiles/commons/themes/commons/commons_origins/template.php b/profiles/commons/themes/commons/commons_origins/template.php
index 672c0af..1f408a5 100755
--- a/profiles/commons/themes/commons/commons_origins/template.php
+++ b/profiles/commons/themes/commons/commons_origins/template.php
@@ -461,6 +461,19 @@ function commons_origins_process_comment_wrapper(&$variables, $hook) {
 }
 
 /**
+ * Implements hook_preprocess_comment().
+ */
+function commons_origins_preprocess_comment(&$variables, $hook) {
+  $variables['content']['links']['#attributes']['class'][] = 'comment-links';
+
+  // Push the reporting link to the end.
+  if (!empty($variables['content']['links']['flag']['#links']['flag-inappropriate_comment'])) {
+    $variables['content']['report_link'] = array('#markup' => $variables['content']['links']['flag']['#links']['flag-inappropriate_comment']['title']);
+    $variables['content']['links']['flag']['#links']['flag-inappropriate_comment']['#access'] = FALSE;
+  }
+}
+
+/**
  * Implements hook_preprocess_flag().
  */
 function commons_origins_preprocess_flag(&$variables, $hook) {
diff --git a/profiles/commons/themes/commons/commons_origins/templates/comment/comment.tpl.php b/profiles/commons/themes/commons/commons_origins/templates/comment/comment.tpl.php
index 9aa8b26..9c4c7d8 100644
--- a/profiles/commons/themes/commons/commons_origins/templates/comment/comment.tpl.php
+++ b/profiles/commons/themes/commons/commons_origins/templates/comment/comment.tpl.php
@@ -58,6 +58,8 @@
  *
  * @ingroup themeable
  */
+
+hide($content['report_link']);
 ?>
 <div class="<?php print $classes; ?> clearfix"<?php print $attributes; ?>>
   <h3 class="comment-title"><?php print $title; ?></h3>
@@ -77,5 +79,5 @@
     ?>
   </div>
   <?php print render($content['links']) ?>
-
+  <?php print render($content['report_link']); ?>
 </div>
diff --git a/profiles/commons/themes/contrib/adaptivetheme/LICENSE.txt b/profiles/commons/themes/contrib/adaptivetheme/LICENSE.txt
deleted file mode 100644
index d159169..0000000
--- a/profiles/commons/themes/contrib/adaptivetheme/LICENSE.txt
+++ /dev/null
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff --git a/profiles/commons/themes/contrib/adaptivetheme/PATCHES.txt b/profiles/commons/themes/contrib/adaptivetheme/PATCHES.txt
index f54c33d..7db79d4 100644
--- a/profiles/commons/themes/contrib/adaptivetheme/PATCHES.txt
+++ b/profiles/commons/themes/contrib/adaptivetheme/PATCHES.txt
@@ -1,4 +1,5 @@
 The following patches have been applied to this project:
 - http://drupal.org/files/remove-comment-creation-link-2018081-1.patch
+- https://drupal.org/files/issues/add-link-button-styling-2159783-1.patch
 
 This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
index 9d777f2..754d634 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
@@ -349,9 +349,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1382042524"
+datestamp = "1387568912"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_admin/css/at_admin.css b/profiles/commons/themes/contrib/adaptivetheme/at_admin/css/at_admin.css
index a5a7272..78e9347 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_admin/css/at_admin.css
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_admin/css/at_admin.css
@@ -985,6 +985,7 @@ div.resizable-textarea textarea {
   width: 98.5%;
   font-size: 1.231em;
 }
+a.button,
 input.form-submit,
 input.teaser-button {
   background-color: transparent;
@@ -1015,12 +1016,14 @@ input[value~=Update],
 input#edit-save.form-submit {
   background-image: url(images/green-button.png);
 }
+a.button-no,
 input[value~=Cancel],
 input#edit-delete.form-submit,
 #system-modules-uninstall input#edit-submit,
 #user-multiple-delete-confirm input#edit-submit {
   background-image: url(images/red-button.png);
 }
+a.button:hover,
 input[value~=Update]:hover,
 input[value~=Save]:hover,
 #system-theme-settings input#edit-submit:hover,
@@ -1033,6 +1036,7 @@ input#edit-delete.form-submit:hover,
 #user-multiple-delete-confirm input#edit-submit:hover {
   background-position: bottom;
   cursor: pointer;
+  text-decoration:none;
 }
 #edit-views-apply,
 #edit-views-reset {
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
index 6ca05c4..e8e14be 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
@@ -374,9 +374,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1382042524"
+datestamp = "1387568912"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
index 1049748..fd431c9 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
@@ -454,9 +454,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2013-10-17
+; Information added by drush on 2013-12-20
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1382042524"
+datestamp = "1387568912"
 
diff --git a/profiles/minimal/minimal.info b/profiles/minimal/minimal.info
index 9cb012f..dfd7b4f 100644
--- a/profiles/minimal/minimal.info
+++ b/profiles/minimal/minimal.info
@@ -2,12 +2,11 @@ name = Minimal
 description = Start with only a few modules enabled.
 version = VERSION
 core = 7.x
-hidden = TRUE
 dependencies[] = block
 dependencies[] = dblog
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/profiles/standard/standard.info b/profiles/standard/standard.info
index 7c463ac..0326fc8 100644
--- a/profiles/standard/standard.info
+++ b/profiles/standard/standard.info
@@ -2,7 +2,6 @@ name = Standard
 description = Install with commonly used features pre-configured.
 version = VERSION
 core = 7.x
-hidden = TRUE
 dependencies[] = block
 dependencies[] = color
 dependencies[] = comment
@@ -25,8 +24,8 @@ dependencies[] = field_ui
 dependencies[] = file
 dependencies[] = rdf
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index b51837f..bfa225a 100644
--- a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 files[] = drupal_system_listing_compatible_test.test
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index 0bfcd89..5f7fb46 100644
--- a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -8,8 +8,8 @@ version = VERSION
 core = 6.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/profiles/testing/testing.info b/profiles/testing/testing.info
index 07bcf47..ffb2821 100644
--- a/profiles/testing/testing.info
+++ b/profiles/testing/testing.info
@@ -4,8 +4,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/themes/bartik/bartik.info b/themes/bartik/bartik.info
index b80138b..850c58e 100644
--- a/themes/bartik/bartik.info
+++ b/themes/bartik/bartik.info
@@ -34,8 +34,8 @@ regions[footer] = Footer
 settings[shortcut_module_link] = 0
 
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/themes/garland/garland.info b/themes/garland/garland.info
index fc252f6..a1f9fbb 100644
--- a/themes/garland/garland.info
+++ b/themes/garland/garland.info
@@ -7,8 +7,8 @@ stylesheets[all][] = style.css
 stylesheets[print][] = print.css
 settings[garland_width] = fluid
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/themes/seven/seven.info b/themes/seven/seven.info
index 30ac6d5..efec4c2 100644
--- a/themes/seven/seven.info
+++ b/themes/seven/seven.info
@@ -13,8 +13,8 @@ regions[page_bottom] = Page bottom
 regions[sidebar_first] = First sidebar
 regions_hidden[] = sidebar_first
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/themes/stark/stark.info b/themes/stark/stark.info
index 519539a..1c365cc 100644
--- a/themes/stark/stark.info
+++ b/themes/stark/stark.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 stylesheets[all][] = layout.css
 
-; Information added by drupal.org packaging script on 2013-08-08
-version = "7.23"
+; Information added by  packaging script on 2013-11-20
+version = "7.24"
 project = "drupal"
-datestamp = "1375928238"
+datestamp = "1384983240"
 
diff --git a/update.php b/update.php
index 331e632..c3d4045 100644
--- a/update.php
+++ b/update.php
@@ -467,13 +467,13 @@ if (update_access_allowed()) {
     // update.php ops.
 
     case 'selection':
-      if (isset($_GET['token']) && $_GET['token'] == drupal_get_token('update')) {
+      if (isset($_GET['token']) && drupal_valid_token($_GET['token'], 'update')) {
         $output = update_selection_page();
         break;
       }
 
     case 'Apply pending updates':
-      if (isset($_GET['token']) && $_GET['token'] == drupal_get_token('update')) {
+      if (isset($_GET['token']) && drupal_valid_token($_GET['token'], 'update')) {
         // Generate absolute URLs for the batch processing (using $base_root),
         // since the batch API will pass them to url() which does not handle
         // update.php correctly by default.
