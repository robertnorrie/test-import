diff --git a/CHANGELOG.txt b/CHANGELOG.txt
index 750aabb..69d94de 100644
--- a/CHANGELOG.txt
+++ b/CHANGELOG.txt
@@ -1,4 +1,9 @@
 
+Drupal 7.21, 2013-03-06
+-----------------------
+- Allowed sites using the 'image_allow_insecure_derivatives' variable to still
+  have partial protection from the security issues fixed in Drupal 7.20.
+
 Drupal 7.20, 2013-02-20
 -----------------------
 - Fixed security issues (denial of service). See SA-CORE-2013-002.
diff --git a/includes/bootstrap.inc b/includes/bootstrap.inc
index 2cfdfe9..93322de 100644
--- a/includes/bootstrap.inc
+++ b/includes/bootstrap.inc
@@ -8,7 +8,7 @@
 /**
  * The current system version.
  */
-define('VERSION', '7.20');
+define('VERSION', '7.21');
 
 /**
  * Core API compatibility.
diff --git a/modules/aggregator/aggregator.info b/modules/aggregator/aggregator.info
index 557d055..53683b6 100644
--- a/modules/aggregator/aggregator.info
+++ b/modules/aggregator/aggregator.info
@@ -7,8 +7,8 @@ files[] = aggregator.test
 configure = admin/config/services/aggregator/settings
 stylesheets[all][] = aggregator.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/aggregator/tests/aggregator_test.info b/modules/aggregator/tests/aggregator_test.info
index 00836d1..d1e0bcc 100644
--- a/modules/aggregator/tests/aggregator_test.info
+++ b/modules/aggregator/tests/aggregator_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/block/block.info b/modules/block/block.info
index 2ffb628..470a378 100644
--- a/modules/block/block.info
+++ b/modules/block/block.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = block.test
 configure = admin/structure/block
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/block/tests/block_test.info b/modules/block/tests/block_test.info
index e70f391..d5a6af3 100644
--- a/modules/block/tests/block_test.info
+++ b/modules/block/tests/block_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/block/tests/themes/block_test_theme/block_test_theme.info b/modules/block/tests/themes/block_test_theme/block_test_theme.info
index 65e240e..46291e4 100644
--- a/modules/block/tests/themes/block_test_theme/block_test_theme.info
+++ b/modules/block/tests/themes/block_test_theme/block_test_theme.info
@@ -13,8 +13,8 @@ regions[footer] = Footer
 regions[highlighted] = Highlighted
 regions[help] = Help
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/blog/blog.info b/modules/blog/blog.info
index 9dc8f3b..16ef24a 100644
--- a/modules/blog/blog.info
+++ b/modules/blog/blog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = blog.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/book/book.info b/modules/book/book.info
index eb920e1..4a96b2c 100644
--- a/modules/book/book.info
+++ b/modules/book/book.info
@@ -7,8 +7,8 @@ files[] = book.test
 configure = admin/content/book/settings
 stylesheets[all][] = book.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/color/color.info b/modules/color/color.info
index 3da8cc6..4e70155 100644
--- a/modules/color/color.info
+++ b/modules/color/color.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = color.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/comment/comment.info b/modules/comment/comment.info
index bef4c55..fd2f91b 100644
--- a/modules/comment/comment.info
+++ b/modules/comment/comment.info
@@ -9,8 +9,8 @@ files[] = comment.test
 configure = admin/content/comment
 stylesheets[all][] = comment.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/contact/contact.info b/modules/contact/contact.info
index 3c317c0..6a355df 100644
--- a/modules/contact/contact.info
+++ b/modules/contact/contact.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = contact.test
 configure = admin/structure/contact
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/contextual/contextual.info b/modules/contextual/contextual.info
index f2aa021..cd3ba08 100644
--- a/modules/contextual/contextual.info
+++ b/modules/contextual/contextual.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = contextual.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/dashboard/dashboard.info b/modules/dashboard/dashboard.info
index ada3e53..448fdcc 100644
--- a/modules/dashboard/dashboard.info
+++ b/modules/dashboard/dashboard.info
@@ -7,8 +7,8 @@ files[] = dashboard.test
 dependencies[] = block
 configure = admin/dashboard/customize
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/dblog/dblog.info b/modules/dblog/dblog.info
index 5e35048..1e36fc7 100644
--- a/modules/dblog/dblog.info
+++ b/modules/dblog/dblog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = dblog.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/field.info b/modules/field/field.info
index 223587c..c194d6e 100644
--- a/modules/field/field.info
+++ b/modules/field/field.info
@@ -10,8 +10,8 @@ dependencies[] = field_sql_storage
 required = TRUE
 stylesheets[all][] = theme/field.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/field_sql_storage/field_sql_storage.info b/modules/field/modules/field_sql_storage/field_sql_storage.info
index ab4cf34..3dec0c4 100644
--- a/modules/field/modules/field_sql_storage/field_sql_storage.info
+++ b/modules/field/modules/field_sql_storage/field_sql_storage.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = field_sql_storage.test
 required = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/list/list.info b/modules/field/modules/list/list.info
index a84296c..ee82df0 100644
--- a/modules/field/modules/list/list.info
+++ b/modules/field/modules/list/list.info
@@ -7,8 +7,8 @@ dependencies[] = field
 dependencies[] = options
 files[] = tests/list.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/list/tests/list_test.info b/modules/field/modules/list/tests/list_test.info
index 2e961de..4020c37 100644
--- a/modules/field/modules/list/tests/list_test.info
+++ b/modules/field/modules/list/tests/list_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/number/number.info b/modules/field/modules/number/number.info
index 74ba621..efc5403 100644
--- a/modules/field/modules/number/number.info
+++ b/modules/field/modules/number/number.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = number.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/options/options.info b/modules/field/modules/options/options.info
index 3e989d3..61cd19d 100644
--- a/modules/field/modules/options/options.info
+++ b/modules/field/modules/options/options.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = options.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/modules/text/text.info b/modules/field/modules/text/text.info
index e09eaa7..15f87ce 100644
--- a/modules/field/modules/text/text.info
+++ b/modules/field/modules/text/text.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = text.test
 required = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field/tests/field_test.info b/modules/field/tests/field_test.info
index c457fe9..81010dc 100644
--- a/modules/field/tests/field_test.info
+++ b/modules/field/tests/field_test.info
@@ -6,8 +6,8 @@ files[] = field_test.entity.inc
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/field_ui/field_ui.info b/modules/field_ui/field_ui.info
index 0957d1e..4497bcb 100644
--- a/modules/field_ui/field_ui.info
+++ b/modules/field_ui/field_ui.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = field_ui.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/file/file.info b/modules/file/file.info
index 5a70a1e..25b9033 100644
--- a/modules/file/file.info
+++ b/modules/file/file.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = tests/file.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/file/tests/file_module_test.info b/modules/file/tests/file_module_test.info
index 4f74a9c..7b2fcbb 100644
--- a/modules/file/tests/file_module_test.info
+++ b/modules/file/tests/file_module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/filter/filter.info b/modules/filter/filter.info
index 2c0b0fe..baf12a9 100644
--- a/modules/filter/filter.info
+++ b/modules/filter/filter.info
@@ -7,8 +7,8 @@ files[] = filter.test
 required = TRUE
 configure = admin/config/content/formats
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/forum/forum.info b/modules/forum/forum.info
index 22c1775..b2fac60 100644
--- a/modules/forum/forum.info
+++ b/modules/forum/forum.info
@@ -9,8 +9,8 @@ files[] = forum.test
 configure = admin/structure/forum
 stylesheets[all][] = forum.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/help/help.info b/modules/help/help.info
index 58562c0..91c34ee 100644
--- a/modules/help/help.info
+++ b/modules/help/help.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = help.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/image/image.info b/modules/image/image.info
index 2919d36..fdbc98c 100644
--- a/modules/image/image.info
+++ b/modules/image/image.info
@@ -7,8 +7,8 @@ dependencies[] = file
 files[] = image.test
 configure = admin/config/media/image-styles
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/image/image.module b/modules/image/image.module
index d7178ad..a9cc1a5 100644
--- a/modules/image/image.module
+++ b/modules/image/image.module
@@ -780,9 +780,11 @@ function image_style_deliver($style, $scheme) {
   // derivative token is valid. (Sites which require image derivatives to be
   // generated without a token can set the 'image_allow_insecure_derivatives'
   // variable to TRUE to bypass the latter check, but this will increase the
-  // site's vulnerability to denial-of-service attacks.)
+  // site's vulnerability to denial-of-service attacks. To prevent this
+  // variable from leaving the site vulnerable to the most serious attacks, a
+  // token is always required when a derivative of a derivative is requested.)
   $valid = !empty($style) && file_stream_wrapper_valid_scheme($scheme);
-  if (!variable_get('image_allow_insecure_derivatives', FALSE)) {
+  if (!variable_get('image_allow_insecure_derivatives', FALSE) || strpos(ltrim($target, '\/'), 'styles/') === 0) {
     $valid = $valid && isset($_GET[IMAGE_DERIVATIVE_TOKEN]) && $_GET[IMAGE_DERIVATIVE_TOKEN] === image_style_path_token($style['name'], $scheme . '://' . $target);
   }
   if (!$valid) {
@@ -867,6 +869,11 @@ function image_style_deliver($style, $scheme) {
  * @see image_style_load()
  */
 function image_style_create_derivative($style, $source, $destination) {
+  // If the source file doesn't exist, return FALSE without creating folders.
+  if (!$image = image_load($source)) {
+    return FALSE;
+  }
+
   // Get the folder for the final location of this style.
   $directory = drupal_dirname($destination);
 
@@ -876,10 +883,6 @@ function image_style_create_derivative($style, $source, $destination) {
     return FALSE;
   }
 
-  if (!$image = image_load($source)) {
-    return FALSE;
-  }
-
   foreach ($style['effects'] as $effect) {
     image_effect_apply($image, $effect);
   }
diff --git a/modules/image/image.test b/modules/image/image.test
index d4db213..25fddf6 100644
--- a/modules/image/image.test
+++ b/modules/image/image.test
@@ -249,6 +249,51 @@ class ImageStylesPathAndUrlTestCase extends DrupalWebTestCase {
       $this->drupalGet(str_replace(IMAGE_DERIVATIVE_TOKEN . '=', IMAGE_DERIVATIVE_TOKEN . '=Zo', $generate_url));
       $this->assertResponse(200, 'Existing image was accessible at the URL wih an invalid token.');
     }
+
+    // Allow insecure image derivatives to be created for the remainder of this
+    // test.
+    variable_set('image_allow_insecure_derivatives', TRUE);
+
+    // Create another working copy of the file.
+    $files = $this->drupalGetTestFiles('image');
+    $file = array_shift($files);
+    $image_info = image_get_info($file->uri);
+    $original_uri = file_unmanaged_copy($file->uri, $scheme . '://', FILE_EXISTS_RENAME);
+    // Let the image_module_test module know about this file, so it can claim
+    // ownership in hook_file_download().
+    variable_set('image_module_test_file_download', $original_uri);
+
+    // Get the URL of a file that has not been generated and try to create it.
+    $generated_uri = image_style_path($this->style_name, $original_uri);
+    $this->assertFalse(file_exists($generated_uri), 'Generated file does not exist.');
+    $generate_url = image_style_url($this->style_name, $original_uri);
+
+    // Check that the image is accessible even without the security token.
+    $this->drupalGet(str_replace(IMAGE_DERIVATIVE_TOKEN . '=', 'wrongparam=', $generate_url));
+    $this->assertResponse(200, 'Image was accessible at the URL with a missing token.');
+
+    // Check that a security token is still required when generating a second
+    // image derivative using the first one as a source.
+    $nested_uri = image_style_path($this->style_name, $generated_uri);
+    $nested_url = image_style_url($this->style_name, $generated_uri);
+    $nested_url_with_wrong_token = str_replace(IMAGE_DERIVATIVE_TOKEN . '=', 'wrongparam=', $nested_url);
+    $this->drupalGet($nested_url_with_wrong_token);
+    $this->assertResponse(403, 'Image generated from an earlier derivative was inaccessible at the URL with a missing token.');
+    // Check that this restriction cannot be bypassed by adding extra slashes
+    // to the URL.
+    $this->drupalGet(substr_replace($nested_url_with_wrong_token, '//styles/', strrpos($nested_url_with_wrong_token, '/styles/'), strlen('/styles/')));
+    $this->assertResponse(403, 'Image generated from an earlier derivative was inaccessible at the URL with a missing token, even with an extra forward slash in the URL.');
+    $this->drupalGet(substr_replace($nested_url_with_wrong_token, '/\styles/', strrpos($nested_url_with_wrong_token, '/styles/'), strlen('/styles/')));
+    $this->assertResponse(403, 'Image generated from an earlier derivative was inaccessible at the URL with a missing token, even with an extra backslash in the URL.');
+    // Make sure the image can still be generated if a correct token is used.
+    $this->drupalGet($nested_url);
+    $this->assertResponse(200, 'Image was accessible when a correct token was provided in the URL.');
+
+    // Check that requesting a nonexistent image does not create any new
+    // directories in the file system.
+    $directory = $scheme . '://styles/' . $this->style_name . '/' . $scheme . '/' . $this->randomName();
+    $this->drupalGet(file_create_url($directory . '/' . $this->randomName()));
+    $this->assertFalse(file_exists($directory), 'New directory was not created in the filesystem when requesting an unauthorized image.');
   }
 }
 
diff --git a/modules/image/tests/image_module_test.info b/modules/image/tests/image_module_test.info
index 7f46493..40b45ab 100644
--- a/modules/image/tests/image_module_test.info
+++ b/modules/image/tests/image_module_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = image_module_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/locale/locale.info b/modules/locale/locale.info
index 147ce84..fcacaec 100644
--- a/modules/locale/locale.info
+++ b/modules/locale/locale.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = locale.test
 configure = admin/config/regional/language
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/locale/tests/locale_test.info b/modules/locale/tests/locale_test.info
index 06c0eee..afad365 100644
--- a/modules/locale/tests/locale_test.info
+++ b/modules/locale/tests/locale_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/menu/menu.info b/modules/menu/menu.info
index 16b08ae..f4e0cc9 100644
--- a/modules/menu/menu.info
+++ b/modules/menu/menu.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = menu.test
 configure = admin/structure/menu
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/node/node.info b/modules/node/node.info
index 26805f6..c02a537 100644
--- a/modules/node/node.info
+++ b/modules/node/node.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/structure/types
 stylesheets[all][] = node.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/node/tests/node_access_test.info b/modules/node/tests/node_access_test.info
index d620c7d..bb7a5a7 100644
--- a/modules/node/tests/node_access_test.info
+++ b/modules/node/tests/node_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/node/tests/node_test.info b/modules/node/tests/node_test.info
index fe157e0..005bb4f 100644
--- a/modules/node/tests/node_test.info
+++ b/modules/node/tests/node_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/node/tests/node_test_exception.info b/modules/node/tests/node_test_exception.info
index c4f4270..afd1ec7 100644
--- a/modules/node/tests/node_test_exception.info
+++ b/modules/node/tests/node_test_exception.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/openid/openid.info b/modules/openid/openid.info
index bd63243..e5ff501 100644
--- a/modules/openid/openid.info
+++ b/modules/openid/openid.info
@@ -5,8 +5,8 @@ package = Core
 core = 7.x
 files[] = openid.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/openid/tests/openid_test.info b/modules/openid/tests/openid_test.info
index b562e5c..0205ca8 100644
--- a/modules/openid/tests/openid_test.info
+++ b/modules/openid/tests/openid_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = openid
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/overlay/overlay.info b/modules/overlay/overlay.info
index 73bfc1b..6dd4b95 100644
--- a/modules/overlay/overlay.info
+++ b/modules/overlay/overlay.info
@@ -4,8 +4,8 @@ package = Core
 version = VERSION
 core = 7.x
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/path/path.info b/modules/path/path.info
index 52d277a..4abfa03 100644
--- a/modules/path/path.info
+++ b/modules/path/path.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = path.test
 configure = admin/config/search/path
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/php/php.info b/modules/php/php.info
index bcd8a92..c5e57d5 100644
--- a/modules/php/php.info
+++ b/modules/php/php.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = php.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/poll/poll.info b/modules/poll/poll.info
index 0033ec0..2ae2ac2 100644
--- a/modules/poll/poll.info
+++ b/modules/poll/poll.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = poll.test
 stylesheets[all][] = poll.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/profile/profile.info b/modules/profile/profile.info
index a60c2a2..4867fd3 100644
--- a/modules/profile/profile.info
+++ b/modules/profile/profile.info
@@ -11,8 +11,8 @@ configure = admin/config/people/profile
 ; See user_system_info_alter().
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/rdf/rdf.info b/modules/rdf/rdf.info
index 322527e..2877b2d 100644
--- a/modules/rdf/rdf.info
+++ b/modules/rdf/rdf.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = rdf.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/rdf/tests/rdf_test.info b/modules/rdf/tests/rdf_test.info
index 88ebd82..fb18967 100644
--- a/modules/rdf/tests/rdf_test.info
+++ b/modules/rdf/tests/rdf_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/search/search.info b/modules/search/search.info
index 32a4999..780c52f 100644
--- a/modules/search/search.info
+++ b/modules/search/search.info
@@ -8,8 +8,8 @@ files[] = search.test
 configure = admin/config/search/settings
 stylesheets[all][] = search.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/search/tests/search_embedded_form.info b/modules/search/tests/search_embedded_form.info
index 10a15ff..1ea2234 100644
--- a/modules/search/tests/search_embedded_form.info
+++ b/modules/search/tests/search_embedded_form.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/search/tests/search_extra_type.info b/modules/search/tests/search_extra_type.info
index 1917148..fce90a5 100644
--- a/modules/search/tests/search_extra_type.info
+++ b/modules/search/tests/search_extra_type.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/shortcut/shortcut.info b/modules/shortcut/shortcut.info
index 00a88e0..e27160c 100644
--- a/modules/shortcut/shortcut.info
+++ b/modules/shortcut/shortcut.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = shortcut.test
 configure = admin/config/user-interface/shortcut
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/simpletest.info b/modules/simpletest/simpletest.info
index c3d3e92..687f236 100644
--- a/modules/simpletest/simpletest.info
+++ b/modules/simpletest/simpletest.info
@@ -55,8 +55,8 @@ files[] = tests/upgrade/update.trigger.test
 files[] = tests/upgrade/update.field.test
 files[] = tests/upgrade/update.user.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/actions_loop_test.info b/modules/simpletest/tests/actions_loop_test.info
index e684a3b..bd440bf 100644
--- a/modules/simpletest/tests/actions_loop_test.info
+++ b/modules/simpletest/tests/actions_loop_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/ajax_forms_test.info b/modules/simpletest/tests/ajax_forms_test.info
index d96d7de..19ff8a1 100644
--- a/modules/simpletest/tests/ajax_forms_test.info
+++ b/modules/simpletest/tests/ajax_forms_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/ajax_test.info b/modules/simpletest/tests/ajax_test.info
index d48c68f..042426d 100644
--- a/modules/simpletest/tests/ajax_test.info
+++ b/modules/simpletest/tests/ajax_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/batch_test.info b/modules/simpletest/tests/batch_test.info
index c03fb4d..c4e00dd 100644
--- a/modules/simpletest/tests/batch_test.info
+++ b/modules/simpletest/tests/batch_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/common_test.info b/modules/simpletest/tests/common_test.info
index 1702d73..aec732b 100644
--- a/modules/simpletest/tests/common_test.info
+++ b/modules/simpletest/tests/common_test.info
@@ -7,8 +7,8 @@ stylesheets[all][] = common_test.css
 stylesheets[print][] = common_test.print.css
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/common_test_cron_helper.info b/modules/simpletest/tests/common_test_cron_helper.info
index 9662122..3834dfa 100644
--- a/modules/simpletest/tests/common_test_cron_helper.info
+++ b/modules/simpletest/tests/common_test_cron_helper.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/database_test.info b/modules/simpletest/tests/database_test.info
index 8129705..a21a08a 100644
--- a/modules/simpletest/tests/database_test.info
+++ b/modules/simpletest/tests/database_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index 7918eae..ee0ce89 100644
--- a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index 73120f6..225e516 100644
--- a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/entity_cache_test.info b/modules/simpletest/tests/entity_cache_test.info
index 5cf393f..f9249fc 100644
--- a/modules/simpletest/tests/entity_cache_test.info
+++ b/modules/simpletest/tests/entity_cache_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = entity_cache_test_dependency
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/entity_cache_test_dependency.info b/modules/simpletest/tests/entity_cache_test_dependency.info
index 22ebd0a..b03e244 100644
--- a/modules/simpletest/tests/entity_cache_test_dependency.info
+++ b/modules/simpletest/tests/entity_cache_test_dependency.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/entity_crud_hook_test.info b/modules/simpletest/tests/entity_crud_hook_test.info
index bede4cd..a27e9eb 100644
--- a/modules/simpletest/tests/entity_crud_hook_test.info
+++ b/modules/simpletest/tests/entity_crud_hook_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/entity_query_access_test.info b/modules/simpletest/tests/entity_query_access_test.info
index 10c6db2..396f07e 100644
--- a/modules/simpletest/tests/entity_query_access_test.info
+++ b/modules/simpletest/tests/entity_query_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/error_test.info b/modules/simpletest/tests/error_test.info
index 62ed657..e009ed4 100644
--- a/modules/simpletest/tests/error_test.info
+++ b/modules/simpletest/tests/error_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/file_test.info b/modules/simpletest/tests/file_test.info
index 1f9be7f..047e5a8 100644
--- a/modules/simpletest/tests/file_test.info
+++ b/modules/simpletest/tests/file_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = file_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/filter_test.info b/modules/simpletest/tests/filter_test.info
index c6c5a3c..dd95f92 100644
--- a/modules/simpletest/tests/filter_test.info
+++ b/modules/simpletest/tests/filter_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/form_test.info b/modules/simpletest/tests/form_test.info
index 04abff4..d868663 100644
--- a/modules/simpletest/tests/form_test.info
+++ b/modules/simpletest/tests/form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/image_test.info b/modules/simpletest/tests/image_test.info
index 8dbb281..50d5158 100644
--- a/modules/simpletest/tests/image_test.info
+++ b/modules/simpletest/tests/image_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/menu_test.info b/modules/simpletest/tests/menu_test.info
index 6c9514d..404cd8d 100644
--- a/modules/simpletest/tests/menu_test.info
+++ b/modules/simpletest/tests/menu_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/module_test.info b/modules/simpletest/tests/module_test.info
index 7f4ba7d..40eaced 100644
--- a/modules/simpletest/tests/module_test.info
+++ b/modules/simpletest/tests/module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/path_test.info b/modules/simpletest/tests/path_test.info
index d2cab0a..29b5f76 100644
--- a/modules/simpletest/tests/path_test.info
+++ b/modules/simpletest/tests/path_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/requirements1_test.info b/modules/simpletest/tests/requirements1_test.info
index 13e388f..d3ad033 100644
--- a/modules/simpletest/tests/requirements1_test.info
+++ b/modules/simpletest/tests/requirements1_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/requirements2_test.info b/modules/simpletest/tests/requirements2_test.info
index 371f1f1..322b37e 100644
--- a/modules/simpletest/tests/requirements2_test.info
+++ b/modules/simpletest/tests/requirements2_test.info
@@ -7,8 +7,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/session_test.info b/modules/simpletest/tests/session_test.info
index d1c6101..b4b5ea9 100644
--- a/modules/simpletest/tests/session_test.info
+++ b/modules/simpletest/tests/session_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_dependencies_test.info b/modules/simpletest/tests/system_dependencies_test.info
index a6efc8d..f556fd8 100644
--- a/modules/simpletest/tests/system_dependencies_test.info
+++ b/modules/simpletest/tests/system_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = _missing_dependency
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
index bda7979..a1701b0 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = system_incompatible_core_version_test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_test.info b/modules/simpletest/tests/system_incompatible_core_version_test.info
index a9de42e..8133d3b 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 5.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
index 1f58f63..e174c76 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
@@ -7,8 +7,8 @@ hidden = TRUE
 ; system_incompatible_module_version_test declares version 1.0
 dependencies[] = system_incompatible_module_version_test (>2.0)
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_test.info b/modules/simpletest/tests/system_incompatible_module_version_test.info
index ea9a42b..558a4cb 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_test.info
@@ -5,8 +5,8 @@ version = 1.0
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/system_test.info b/modules/simpletest/tests/system_test.info
index 068755b..884a65a 100644
--- a/modules/simpletest/tests/system_test.info
+++ b/modules/simpletest/tests/system_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = system_test.module
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/taxonomy_test.info b/modules/simpletest/tests/taxonomy_test.info
index 42ed05f..6cf0823 100644
--- a/modules/simpletest/tests/taxonomy_test.info
+++ b/modules/simpletest/tests/taxonomy_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = taxonomy
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/theme_test.info b/modules/simpletest/tests/theme_test.info
index d05453a..4ac92f8 100644
--- a/modules/simpletest/tests/theme_test.info
+++ b/modules/simpletest/tests/theme_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
index cc583f0..79dd3da 100644
--- a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
+++ b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 settings[basetheme_only] = base theme value
 settings[subtheme_override] = base theme value
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
index e744045..cb63c50 100644
--- a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
+++ b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 
 settings[subtheme_override] = subtheme value
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/themes/test_theme/test_theme.info b/modules/simpletest/tests/themes/test_theme/test_theme.info
index ae04477..654495a 100644
--- a/modules/simpletest/tests/themes/test_theme/test_theme.info
+++ b/modules/simpletest/tests/themes/test_theme/test_theme.info
@@ -17,8 +17,8 @@ stylesheets[all][] = system.base.css
 
 settings[theme_test_setting] = default value
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/update_script_test.info b/modules/simpletest/tests/update_script_test.info
index ed8c967..6250658 100644
--- a/modules/simpletest/tests/update_script_test.info
+++ b/modules/simpletest/tests/update_script_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/update_test_1.info b/modules/simpletest/tests/update_test_1.info
index 40dad06..640724d 100644
--- a/modules/simpletest/tests/update_test_1.info
+++ b/modules/simpletest/tests/update_test_1.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/update_test_2.info b/modules/simpletest/tests/update_test_2.info
index 40dad06..640724d 100644
--- a/modules/simpletest/tests/update_test_2.info
+++ b/modules/simpletest/tests/update_test_2.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/update_test_3.info b/modules/simpletest/tests/update_test_3.info
index 40dad06..640724d 100644
--- a/modules/simpletest/tests/update_test_3.info
+++ b/modules/simpletest/tests/update_test_3.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/url_alter_test.info b/modules/simpletest/tests/url_alter_test.info
index c5691f4..c34b15e 100644
--- a/modules/simpletest/tests/url_alter_test.info
+++ b/modules/simpletest/tests/url_alter_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/simpletest/tests/xmlrpc_test.info b/modules/simpletest/tests/xmlrpc_test.info
index ac5af5c..37b45dc 100644
--- a/modules/simpletest/tests/xmlrpc_test.info
+++ b/modules/simpletest/tests/xmlrpc_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/statistics/statistics.info b/modules/statistics/statistics.info
index f73dab1..695bc64 100644
--- a/modules/statistics/statistics.info
+++ b/modules/statistics/statistics.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = statistics.test
 configure = admin/config/system/statistics
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/syslog/syslog.info b/modules/syslog/syslog.info
index e0ea374..b88a5f6 100644
--- a/modules/syslog/syslog.info
+++ b/modules/syslog/syslog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = syslog.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/system/system.info b/modules/system/system.info
index dca4780..5336502 100644
--- a/modules/system/system.info
+++ b/modules/system/system.info
@@ -12,8 +12,8 @@ files[] = system.test
 required = TRUE
 configure = admin/config/system
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/taxonomy/taxonomy.info b/modules/taxonomy/taxonomy.info
index fa3363f..ec6e2e6 100644
--- a/modules/taxonomy/taxonomy.info
+++ b/modules/taxonomy/taxonomy.info
@@ -8,8 +8,8 @@ files[] = taxonomy.module
 files[] = taxonomy.test
 configure = admin/structure/taxonomy
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/toolbar/toolbar.info b/modules/toolbar/toolbar.info
index c0aa88b..70d98c3 100644
--- a/modules/toolbar/toolbar.info
+++ b/modules/toolbar/toolbar.info
@@ -4,8 +4,8 @@ core = 7.x
 package = Core
 version = VERSION
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/tracker/tracker.info b/modules/tracker/tracker.info
index 4342207..0158a65 100644
--- a/modules/tracker/tracker.info
+++ b/modules/tracker/tracker.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = tracker.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/translation/tests/translation_test.info b/modules/translation/tests/translation_test.info
index d84803e..eed01c8 100644
--- a/modules/translation/tests/translation_test.info
+++ b/modules/translation/tests/translation_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/translation/translation.info b/modules/translation/translation.info
index ca65d35..b15e758 100644
--- a/modules/translation/translation.info
+++ b/modules/translation/translation.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = translation.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/trigger/tests/trigger_test.info b/modules/trigger/tests/trigger_test.info
index f81749a..278d6cd 100644
--- a/modules/trigger/tests/trigger_test.info
+++ b/modules/trigger/tests/trigger_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/trigger/trigger.info b/modules/trigger/trigger.info
index 0586f45..fba5029 100644
--- a/modules/trigger/trigger.info
+++ b/modules/trigger/trigger.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = trigger.test
 configure = admin/structure/trigger
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/aaa_update_test.info b/modules/update/tests/aaa_update_test.info
index 7029293..b0e8d6a 100644
--- a/modules/update/tests/aaa_update_test.info
+++ b/modules/update/tests/aaa_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/bbb_update_test.info b/modules/update/tests/bbb_update_test.info
index 2e84546..e58911a 100644
--- a/modules/update/tests/bbb_update_test.info
+++ b/modules/update/tests/bbb_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/ccc_update_test.info b/modules/update/tests/ccc_update_test.info
index b8fd231..c852adf 100644
--- a/modules/update/tests/ccc_update_test.info
+++ b/modules/update/tests/ccc_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
index 3c5fa32..201ca82 100644
--- a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
+++ b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
@@ -3,8 +3,8 @@ description = Test theme which acts as a base theme for other test subthemes.
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
index 7f23938..e388390 100644
--- a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
+++ b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
@@ -4,8 +4,8 @@ core = 7.x
 base theme = update_test_basetheme
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/tests/update_test.info b/modules/update/tests/update_test.info
index 8cec919..fea86ae 100644
--- a/modules/update/tests/update_test.info
+++ b/modules/update/tests/update_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/update/update.info b/modules/update/update.info
index fef63c5..64183b3 100644
--- a/modules/update/update.info
+++ b/modules/update/update.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = update.test
 configure = admin/reports/updates/settings
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/user/tests/user_form_test.info b/modules/user/tests/user_form_test.info
index ff4cd76..871e1fb 100644
--- a/modules/user/tests/user_form_test.info
+++ b/modules/user/tests/user_form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/modules/user/user.info b/modules/user/user.info
index eef6b45..1430b68 100644
--- a/modules/user/user.info
+++ b/modules/user/user.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/config/people
 stylesheets[all][] = user.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/profiles/commons/build-commons-dev.make b/profiles/commons/build-commons-dev.make
index a8996ac..581a227 100644
--- a/profiles/commons/build-commons-dev.make
+++ b/profiles/commons/build-commons-dev.make
@@ -9,5 +9,5 @@ projects[commons][type] = "profile"
 projects[commons][download][type] = "git"
 projects[commons][download][url] = "http://git.drupal.org/project/commons.git"
 ; http://drupal.org/node/1908812#comment-7045196
-projects[commons][patch][] = "http://drupal.org/files/1908812-drupal-org-dev-make-5.patch"
+projects[commons][patch][] = "http://drupal.org/files/1908812-drupal-org-dev-make-17.patch"
 projects[commons][download][branch] = "7.x-3.x"
\ No newline at end of file
diff --git a/profiles/commons/build_distro.sh b/profiles/commons/build_distro.sh
index 9b4617c..714f5ca 100755
--- a/profiles/commons/build_distro.sh
+++ b/profiles/commons/build_distro.sh
@@ -3,12 +3,18 @@ repos=(commons_activity_streams commons_featured commons_notices commons_profile
 
 pull_git() {
     cd $BUILD_PATH/commons_profile
+    if [[ -n $RESET ]]; then
+      git reset --hard HEAD
+    fi
     git pull origin 7.x-3.x
 
     cd $BUILD_PATH/repos/modules
     for i in "${repos[@]}"; do
       echo $i
       cd $i
+      if [[ -n $RESET ]]; then
+        git reset --hard HEAD
+      fi
       git pull origin 7.x-3.x
       cd ..
     done
@@ -17,15 +23,19 @@ pull_git() {
 }
 
 release_notes() {
-  OUTPUT="Release Notes for $RELEASE"
+  rm -rf rn.txt
+  OUTPUT="<h2>Release Notes for $RELEASE</h2>"
   cd $BUILD_PATH/commons_profile
-  OUTPUT="$OUTPUT <h3>$i:</h3>  `drush rn --date $FROM_DATE $TO_DATE`"
+  OUTPUT="$OUTPUT <h3>Commons Profile:</h3> `drush rn --date $FROM_DATE $TO_DATE`"
 
   cd $BUILD_PATH/repos/modules
   for i in "${repos[@]}"; do
     echo $i
     cd $i
-    OUTPUT="$OUTPUT <h3>$i:</h3> `drush rn --date $FROM_DATE $TO_DATE`"
+    RN=`drush rn --date $FROM_DATE $TO_DATE`
+    if [[ -n $RN ]]; then
+      OUTPUT="$OUTPUT <h3>$i:</h3> $RN"
+    fi
     cd ..
   done
   echo $OUTPUT >> $BUILD_PATH/rn.txt
@@ -67,15 +77,41 @@ build_distro() {
     fi
 }
 
+# This allows users to build the most recent release from git and apply it to their directory. No-dev removes the symlinks and puts in real versions of the module.
+update() {
+    if [[ -d $BUILD_PATH ]]; then
+        cd $BUILD_PATH
+        # do we have the profile?
+        if [[ -d $BUILD_PATH/commons_profile ]]; then
+          if [[ $DEV == dev ]]; then
+            tar -czvf sites-tmp.tar.gz publish/sites/default
+            build_distro $BUILD_PATH
+            tar -zxvf sites-tmp.tar.gz
+          fi
+
+          if [[ $DEV == nodev ]]; then
+            drush make commons_profile/build-commons.make --no-cache --tar publish
+            tar -zxvf publish.tar.gz
+          fi
+        fi
+    else
+      echo "invalid build path"
+      exit 1
+    fi
+}
+
 case $1 in
   pull)
     if [[ -n $2 ]]; then
       BUILD_PATH=$2
+      if [[ -n $3 ]]; then
+       RESET=1
+      fi
     else
       echo "Usage: build_distro.sh pull [build_path]"
       exit 1
     fi
-    pull_git $BUILD_PATH;;
+    pull_git $BUILD_PATH $RESET;;
   build)
     if [[ -n $2 ]]; then
       BUILD_PATH=$2
@@ -84,6 +120,19 @@ case $1 in
       exit 1
     fi
     build_distro;;
+  update)
+    if [[ -n $2 ]]; then
+      BUILD_PATH=$2
+      if [[ $3 == 'dev' ]] || [[ $3 == 'nodev' ]]; then
+        DEV=$3
+      else
+        DEV='dev'
+      fi
+    else
+      echo "Usage: build_distro.sh update [build_path] [dev|nodev]"
+      exit 1
+    fi
+    update $BUILD_PATH $DEV;;
   rn)
     if [[ -n $2 ]] && [[ -n $3 ]] && [[ -n $4 ]] && [[ -n $5 ]]; then
       BUILD_PATH=$2
@@ -95,4 +144,4 @@ case $1 in
       exit 1
     fi
     release_notes $BUILD_PATH $RELEASE $FROM_DATE $TO_DATE;;
-esac
+esac
\ No newline at end of file
diff --git a/profiles/commons/commons.info b/profiles/commons/commons.info
index cf22af1..2b2d954 100644
--- a/profiles/commons/commons.info
+++ b/profiles/commons/commons.info
@@ -96,9 +96,9 @@ dependencies[] = commons_location
 dependencies[] = commons_wysiwyg
 dependencies[] = commons_social_sharing
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-28
+version = "7.x-3.1"
 core = "7.x"
 project = "commons"
-datestamp = "1361827541"
+datestamp = "1364431811"
 
diff --git a/profiles/commons/commons.install b/profiles/commons/commons.install
index e75e762..c0effe6 100644
--- a/profiles/commons/commons.install
+++ b/profiles/commons/commons.install
@@ -95,3 +95,28 @@ function commons_update_3101() {
   variable_set('node_admin_theme', FALSE);
   return array();
 }
+
+/**
+ * Reset the default avatar if the associated file doesn't exist in the file_managed table.
+ */
+function commons_update_3102() {
+  $reset_avatar = FALSE;
+  $file = variable_get('user_picture_default', '');
+  if(!$file) {
+    $reset_avatar = TRUE;
+  }
+  if(!$reset_avatar) {
+    $results = db_select('file_managed', 'f')
+      ->fields('f', array('fid'))
+      ->condition('filename', $file,'=')
+      ->execute()
+      ->fetchAll();
+    if(count($results) === 0) {
+      $reset_avatar = TRUE;
+    }
+  }
+  if($reset_avatar) {
+    commons_set_default_avatar();
+  }
+  return array();
+}
\ No newline at end of file
diff --git a/profiles/commons/commons.profile b/profiles/commons/commons.profile
index a589360..818c45c 100644
--- a/profiles/commons/commons.profile
+++ b/profiles/commons/commons.profile
@@ -117,8 +117,8 @@ function commons_install_tasks() {
   }
 
   //make sure we have more memory than 196M. if not lets try to increase it.
-  if (ini_get('max_execution_time') != '-1' && ini_get('max_execution_time') <= '60') {
-    ini_set('max_execution_time', '60');
+  if ((int)ini_get('max_execution_time') != -1 && (int)ini_get('max_execution_time') != 0 && (int)ini_get('max_execution_time') <= 120) {
+    ini_set('max_execution_time', 120);
   }
 
   $demo_content = variable_get('commons_install_example_content', FALSE);
@@ -131,7 +131,7 @@ function commons_install_tasks() {
       'run' => $acquia_connector ? INSTALL_TASK_RUN_IF_NOT_COMPLETED : INSTALL_TASK_SKIP,
     ),
     'commons_installer_palette' => array(
-      'display_name' => st('Chose site color palette'),
+      'display_name' => st('Choose site color palette'),
       'display' => TRUE,
       'type' => 'form',
       'function' => 'commons_installer_palette',
@@ -617,8 +617,7 @@ function commons_install_finished(&$install_state) {
   drupal_flush_all_caches();
 
   // We make custom code for the footer here because we want people to be able to freely edit it if they wish.
-  $footer_body = '<h3>'.variable_get('site_name', 'Drupal Commons').'</h3>
-  <p>'. st('A Commons Community, powered by <a href="@acquia">Acquia</a>', array('@acquia' => url('https://www.acquia.com/products-services/drupal-commons-social-business-software'))) . '</p>';
+  $footer_body = '<p>'. st('A Commons Community, powered by <a href="@acquia">Acquia</a>', array('@acquia' => url('https://www.acquia.com/products-services/drupal-commons-social-business-software'))) . '</p>';
 
   $footer_block_text = array(
     'body' => st($footer_body),
@@ -636,7 +635,7 @@ function commons_install_finished(&$install_state) {
       'status' => 1,
       'pages' => 0,
       'weight' => 1,
-      'title' => '<none>',
+      'title' => variable_get('site_name', 'Drupal Commons'),
     );
     drupal_write_record('block', $footer_block);
   }
diff --git a/profiles/commons/drupal-org-core.make b/profiles/commons/drupal-org-core.make
index 9c9ec39..8f50959 100644
--- a/profiles/commons/drupal-org-core.make
+++ b/profiles/commons/drupal-org-core.make
@@ -3,7 +3,7 @@ core = 7.x
 
 ; Download Drupal core and apply core patches if needed.
 projects[drupal][type] = "core"
-projects[drupal][version] = "7.20"
+projects[drupal][version] = "7.21"
 
 ; Hide the profiles under /profiles, so Commons is the only one. This allows
 ; the installation to start at the Language selection screen, bypassing a
diff --git a/profiles/commons/drupal-org.make b/profiles/commons/drupal-org.make
index 0a174e7..4236b85 100644
--- a/profiles/commons/drupal-org.make
+++ b/profiles/commons/drupal-org.make
@@ -5,32 +5,40 @@ core = 7.x
 
 projects[addressfield][type] = "module"
 projects[addressfield][subdir] = "contrib"
+projects[addressfield][version] = "1.0-beta3"
 
 projects[acquia_connector][type] = "module"
 projects[acquia_connector][subdir] = "contrib"
+projects[acquia_connector][version] = "2.8"
 
 projects[advancedqueue][type] = "module"
 projects[advancedqueue][subdir] = "contrib"
+projects[advancedqueue][version] = "1.0-alpha2"
 
 projects[apachesolr][type] = "module"
 projects[apachesolr][subdir] = "contrib"
+projects[apachesolr][version] = "1.1"
 
-projects[apachesolr_og][version] = "1.x-dev"
 projects[apachesolr_og][type] = "module"
 projects[apachesolr_og][subdir] = "contrib"
+projects[apachesolr_og][download][type] = "git"
+projects[apachesolr_og][download][url] = "http://git.drupal.org/project/apachesolr_og.git"
+projects[apachesolr_og][download][branch] = "7.x-1.x"
+projects[apachesolr_og][download]revision] = "49820b4a4fcff7c1c4efe449da033fb6d8711ac5"
 
 projects[apachesolr_proximity][type] = "module"
 projects[apachesolr_proximity][subdir] = "contrib"
+projects[apachesolr_proximity][version] = "1.0-rc1"
 
-projects[connector][version] = "1.x-dev"
 projects[connector][type] = "module"
 projects[connector][subdir] = "contrib"
+projects[connector][version] = "1.0-beta2"
 
 projects[ckeditor][type] = "module"
 projects[ckeditor][subdir] = "contrib"
 projects[ckeditor][download][type] = "git"
 projects[ckeditor][download][url] = "http://git.drupal.org/project/ckeditor.git"
-; Use Libraries API for ckeditor
+; Use Libraries API for ckeditor.
 ; http://drupal.org/node/1063482#comment-6964504
 projects[ckeditor][download][branch] = "7.x-1.x"
 projects[ckeditor][download][revision] = "f6abbda"
@@ -41,48 +49,73 @@ projects[ckeditor][patch][] = "http://drupal.org/files/ckeditor-install-lib-1898
 
 projects[ctools][type] = "module"
 projects[ctools][subdir] = "contrib"
+projects[ctools][version] = "1.2"
+
 ; http://drupal.org/node/1494860#comment-6204438
 projects[ctools][patch][] = "http://drupal.org/files/ctools-dependent-js-broken-with-jquery-1.7-1494860-30.patch"
 
 projects[custom_search][type] = "module"
 projects[custom_search][subdir] = "contrib"
-projects[custom_search][version] = "1.x-dev"
+projects[custom_search][download][type] = "git"
+projects[custom_search][download][url] = "http://git.drupal.org/project/custom_search.git"
+projects[custom_search][download][branch] = "7.x-1.x"
+projects[custom_search][download][revision] = "e6be0ee6f5f7c7e56f09e79d0d3351fd193c0840"
 
 projects[date][type] = "module"
 projects[date][subdir] = "contrib"
+projects[date][version] = "2.6"
 
 projects[date_facets][type] = "module"
 projects[date_facets][subdir] = "contrib"
+projects[date_facets][version] = "1.0-beta1"
 
+; Keeping this to the latest version, since it should only be used for development.
 projects[devel][version] = "1.x-dev"
 projects[devel][type] = "module"
 projects[devel][subdir] = "contrib"
 
 projects[diff][type] = "module"
 projects[diff][subdir] = "contrib"
+projects[diff][version] = "3.2"
 
 projects[email_registration][type] = "module"
 projects[email_registration][subdir] = "contrib"
+projects[email_registration][version] = "1.1"
 
 projects[entity][type] = "module"
 projects[entity][subdir] = "contrib"
+projects[entity][version] = "1.0"
+
+; Force LANGUAGE_NONE entities to still display within rendered entities.
+; http://drupal.org/node/1782134
+projects[entity][patch][] = "http://drupal.org/files/entity-translatable_fields_not_overriding_und_with_empty_values.patch"
 
 projects[entitycache][type] = "module"
 projects[entitycache][subdir] = "contrib"
+projects[entitycache][version] = "1.1"
 
-projects[entityreference][version] = "1.x-dev"
 projects[entityreference][type] = "module"
 projects[entityreference][subdir] = "contrib"
+projects[entityreference][download][type] = "git"
+projects[entityreference][download][url] = "http://git.drupal.org/project/entityreference.git"
+projects[entityreference][download][branch] = "7.x-1.x"
+projects[entityreference][download][revision] = "06089a92ee8b269f153064ad3090ce6b464f38aa"
 
+; Profile has no recommended release
 projects[edit_profile][type] = "module"
 projects[edit_profile][subdir] = "contrib"
+projects[edit_profile][version] = "1.0-beta2"
 
 projects[entityreference_prepopulate][type] = "module"
 projects[entityreference_prepopulate][subdir] = "contrib"
+projects[entityreference_prepopulate][version] = "1.2"
 
-projects[features][version] = "2.x-dev"
 projects[features][type] = "module"
 projects[features][subdir] = "contrib"
+projects[features][download][type] = "git"
+projects[features][download][url] = "http://git.drupal.org/project/features.git"
+projects[features][download][branch] = "7.x-2.x"
+projects[features][download][revision] = "63db687c75d7880bb5d2652fa9227e3ca6e4e9f0"
 
 ; Separate fields from field instances.
 ; http://drupal.org/node/1064472#comment-7042482
@@ -90,79 +123,103 @@ projects[features][patch][] = "http://drupal.org/files/features-instances-106447
 
 projects[flag][type] = "module"
 projects[flag][subdir] = "contrib"
+projects[flag][version] = "2.0"
 
 projects[flag_abuse][type] = "module"
 projects[flag_abuse][subdir] = "contrib"
-projects[flag_abuse][version] = "2.x-dev"
+projects[flag_abuse][version] = "2.0-alpha1"
+
 
 projects[redirect][type] = "module"
 projects[redirect][subdir] = "contrib"
+projects[redirect][version] = "1.0-rc1"
 
-projects[http_client][version] = "2.x-dev"
 projects[http_client][type] = "module"
 projects[http_client][subdir] = "contrib"
+projects[http_client][version] = "2.4"
 
-projects[admin_icons][version] = "1.x-dev"
 projects[admin_icons][type] = "module"
 projects[admin_icons][subdir] = "contrib"
+projects[admin_icons][download][type] = "git"
+projects[admin_icons][download][url] = "http://git.drupal.org/project/admin_icons.git"
+projects[admin_icons][download][branch] = "7.x-1.x"
+projects[admin_icons][download][revision] = "60d9f28801533fecc92216a60d444d89d80e7611"
 
 projects[libraries][type] = "module"
 projects[libraries][subdir] = "contrib"
+projects[libraries][version] = "2.1"
 
 projects[link][type] = "module"
 projects[link][subdir] = "contrib"
+projects[link][version] = "1.1"
 
 projects[menu_attributes][type] = "module"
 projects[menu_attributes][subdir] = "contrib"
+projects[menu_attributes][version] = "1.0-rc2"
 
 projects[message][type] = "module"
 projects[message][subdir] = "contrib"
-projects[message][version] = "1.x-dev"
+projects[message][download][type] = "git"
+projects[message][download][url] = "http://git.drupal.org/project/message.git"
+projects[message][download][branch] = "7.x-1.x"
+projects[message][download][revision] = "5ae12e8c0b7482f8525106825009409f3b9b7140"
+
 ; Make message access alterable.
 ; http://drupal.org/node/1920560#comment-7080942
 projects[message][patch][] = "http://drupal.org/files/1920560-message-access-alterable.patch"
 
 projects[message_notify][type] = "module"
 projects[message_notify][subdir] = "contrib"
-projects[message_notify][version] = "2.x-dev"
+projects[message_notify][download][type] = "git"
+projects[message_notify][download][url] = "http://git.drupal.org/project/message_notify.git"
+projects[message_notify][download][branch] = "7.x-2.x"
+projects[message_notify][download][revision] = "f8731d574f427dda3bc99e75f541549305655309"
 
 projects[message_subscribe][type] = "module"
 projects[message_subscribe][subdir] = "contrib"
-projects[message_subscribe][version] = "1.x-dev"
+projects[message_subscribe][download][type] = "git"
+projects[message_subscribe][download][url] = "http://git.drupal.org/project/message_subscribe.git"
+projects[message_subscribe][download][branch] = "7.x-1.x"
+projects[message_subscribe][download][revision] = "0063ab0fd922a5dbd2a052114a75a60e10e6ab07"
 
-; Remove "email" as default notifier
+; Remove "email" as default notifier.
 ; http://drupal.org/node/1828184#comment-7081868
 projects[message_subscribe][patch][] = "http://drupal.org/files/email-notifiers-1828184-15.patch"
 
-
 projects[memcache][type] = "module"
 projects[memcache][subdir] = "contrib"
+projects[memcache][version] = "1.0"
 
 projects[metatag][type] = "module"
 projects[metatag][subdir] = "contrib"
+projects[metatag][version] = "1.0-beta5"
+
 ; Support for rel=author link in head
 ; http://drupal.org/node/1865228#comment-6839604
 projects[metatag][patch][] = "http://drupal.org/files/metatag-n1865228-3.patch"
 
 projects[module_filter][type] = "module"
 projects[module_filter][subdir] = "contrib"
+projects[module_filter][version] = "1.7"
 
 projects[mollom][type] = "module"
 projects[mollom][subdir] = "contrib"
+projects[mollom][version] = "2.4"
 
-projects[oauth][version] = "3.x-dev"
 projects[oauth][type] = "module"
 projects[oauth][subdir] = "contrib"
+projects[oauth][version] = "3.1"
 
-projects[oauthconnector][version] = "1.x-dev"
 projects[oauthconnector][type] = "module"
 projects[oauthconnector][subdir] = "contrib"
+projects[oauthconnector][download][type] = "git"
+projects[oauthconnector][download][url] = "http://git.drupal.org/project/oauthconnector.git"
+projects[oauthconnector][download][branch] = "7.x-1.x"
+projects[oauthconnector][download][revision] = "0ce7ac9614710c0f68d0a58cb4ae4667f8bd6fa7"
 
 projects[og][type] = "module"
 projects[og][subdir] = "contrib"
-; Language tweak for 'user has been added to [group]'
-; http://drupal.org/node/1842830
-projects[og][patch][] = "http://drupal.org/files/og-add-group-message.patch"
+projects[og][version] = "2.1"
 
 ; og_group_ref field should respect og_user_access()
 ; http://drupal.org/node/1902086#comment-7026516
@@ -170,9 +227,12 @@ projects[og][patch][] = "http://drupal.org/files/1902086-og-ref-respect-og-user-
 
 projects[panelizer][type] = "module"
 projects[panelizer][subdir] = "contrib"
+projects[panelizer][version] = "3.1"
 
 projects[panels][type] = "module"
 projects[panels][subdir] = "contrib"
+projects[panels][version] = "3.3"
+
 ; Fatal error: Call to undefined function panels_get_layouts()
 ; http://drupal.org/node/1828684#comment-6694732
 projects[panels][patch][] = "http://drupal.org/files/1828684-layout-fix-6.patch"
@@ -183,17 +243,25 @@ projects[panels][patch][] = "http://drupal.org/files/panels-n1632898-15.patch"
 
 projects[pathauto][type] = "module"
 projects[pathauto][subdir] = "contrib"
+projects[pathauto][version] = "1.2"
 
 projects[pm_existing_pages][type] = "module"
 projects[pm_existing_pages][subdir] = "contrib"
+projects[pm_existing_pages][version] = "1.4"
 
 projects[quicktabs][type] = "module"
 projects[quicktabs][subdir] = "contrib"
-projects[quicktabs][version] = "3.x-dev"
+projects[quicktabs][download][type] = "git"
+projects[quicktabs][download][url] = "http://git.drupal.org/project/quicktabs.git"
+projects[quicktabs][download][branch] = "7.x-3.x"
+projects[quicktabs][download][revision] = "0788eba"
 
 projects[radioactivity][type] = "module"
 projects[radioactivity][subdir] = "contrib"
-projects[radioactivity][version] = "2.x-dev"
+projects[radioactivity][download][type] = "git"
+projects[radioactivity][download][url] = "http://git.drupal.org/project/radioactivity.git"
+projects[radioactivity][download][branch] = "7.x-2.x"
+projects[radioactivity][download][revision] = "aee21dbed4f54d0e626e3c19ecc550bf1ec656f6"
 
 ; Radioactivity not compatible with Memcache module
 ; http://drupal.org/node/1860216
@@ -201,15 +269,19 @@ projects[radioactivity][patch][] = "http://drupal.org/files/radioactivity-memcac
 
 projects[r4032login][type] = "module"
 projects[r4032login][subdir] = "contrib"
+projects[r4032login][version] = "1.5"
 
 projects[rate][type] = "module"
 projects[rate][subdir] = "contrib"
+projects[rate][version] = "1.6"
+
 ; Add widget to node/comment $links
 ; http://drupal.org/node/947516#comment-6979780
 projects[rate][patch][] = "http://drupal.org/files/947516-rate-node-links-15.patch"
 
 projects[realname][type] = "module"
 projects[realname][subdir] = "contrib"
+projects[realname][version] = "1.1"
 
 projects[registration][subdir] = "contrib"
 projects[registration][type] = "module"
@@ -224,64 +296,94 @@ projects[registration][patch][] = "http://drupal.org/files/entity_cache_support-
 
 projects[rules][type] = "module"
 projects[rules][subdir] = "contrib"
+projects[rules][version] = "2.3"
 
 projects[search_facetapi][type] = "module"
 projects[search_facetapi][subdir] = "contrib"
+projects[search_facetapi][version] = "1.0-beta2"
 
 projects[sharethis][type] = "module"
 projects[sharethis][subdir] = "contrib"
+projects[sharethis][version] = "2.5"
 
 projects[facetapi][type] = "module"
 projects[facetapi][subdir] = "contrib"
+projects[facetapi][version] = "1.2"
 
-; Remove snippets from non-node type searches:
-; http://drupal.org/node/1923904#comment-7094488
 projects[rich_snippets][type] = "module"
 projects[rich_snippets][subdir] = "contrib"
+projects[rich_snippets][version] = "1.0-beta2"
+
+; Remove snippets from non-node type searches:
+; http://drupal.org/node/1923904#comment-7094488
 projects[rich_snippets][patch][] = "http://drupal.org/files/1923904-search-nodes-only.patch"
 
 projects[schemaorg][type] = "module"
 projects[schemaorg][subdir] = "contrib"
+projects[schemaorg][version] = "1.0-beta3"
 
-projects[strongarm][version] = "2.x-dev"
 projects[strongarm][type] = "module"
 projects[strongarm][subdir] = "contrib"
+projects[strongarm][download][type] = "git"
+projects[strongarm][download][url] = "http://git.drupal.org/project/strongarm.git"
+projects[strongarm][download][branch] = "7.x-2.x"
+projects[strongarm][download][revision] = "5a2326ba67e59923ecce63d9bb5e0ed6548abdf8"
 
 projects[timeago][type] = "module"
 projects[timeago][subdir] = "contrib"
 projects[timeago][version] = "2.x-dev"
+projects[timeago][download][type] = "git"
+projects[timeago][download][url] = "http://git.drupal.org/project/timeago.git"
+projects[timeago][download][branch] = "7.x-2.x"
+projects[timeago][download][revision] = "768ea66"
 
 ; Provide a dedicated date type:
 ; http://drupal.org/node/1427226#comment-6638836
 projects[timeago][patch][] = "http://drupal.org/files/1427226-timeago-date-type.patch"
 
+; Redundant call to drupal_add_js() when Libraries module is enabled.
+; http://drupal.org/node/1945942
+projects[timeago][patch][] = "http://drupal.org/files/timeago-libraries-a.patch"
+
 projects[title][type] = "module"
 projects[title][subdir] = "contrib"
+projects[title][version] = "1.0-alpha7"
 
 projects[token][type] = "module"
 projects[token][subdir] = "contrib"
+projects[token][version] = "1.5"
+
 
 projects[views][type] = "module"
 projects[views][subdir] = "contrib"
-projects[views][version] = "3.x-dev"
+projects[views][version] = "3.6"
+
 
 projects[views_field_view][type] = "module"
 projects[views_field_view][subdir] = "contrib"
+projects[views_field_view][version] = "1.0"
 
 projects[views_load_more][type] = "module"
 projects[views_load_more][subdir] = "contrib"
+projects[views_load_more][version] = "1.1"
 
 projects[views_bulk_operations][type] = "module"
 projects[views_bulk_operations][subdir] = "contrib"
+projects[views_bulk_operations][version] = "3.1"
 
 projects[views_litepager][type] = "module"
 projects[views_litepager][subdir] = "contrib"
+projects[views_litepager][version] = "3.0"
 
+; We have the version of voting api at the top so it doesn't get included in our dev make patch.
+projects[votingapi][version] = "2.11"
 projects[votingapi][type] = "module"
 projects[votingapi][subdir] = "contrib"
 
 ; Commons contrib modules:
+; We don't tag a release here because want them to auto-increment.. and we are the ones who test it.
 
+; We don't have a release for this?!?!
 projects[commons_activity_streams][type] = "module"
 projects[commons_activity_streams][subdir] = "contrib"
 
@@ -373,10 +475,14 @@ projects[commons_topics][subdir] = "contrib"
 
 projects[adaptivetheme][type] = "theme"
 projects[adaptivetheme][subdir] = "contrib"
-projects[adaptivetheme][version] = "3.x-dev"
+projects[adaptivetheme][download][type] = "git"
+projects[adaptivetheme][download][url] = "git://git.drupal.org/project/adaptivetheme.git"
+projects[adaptivetheme][download][branch] = "7.x-3.x"
+projects[adaptivetheme][download][revision] = "4e29d43"
 
 projects[sky][type] = "theme"
 projects[sky][subdir] = "contrib"
+projects[sky][version] = "3.0-rc1"
 
 projects[commons_origins][type] = "theme"
 projects[commons_origins][subdir] = "contrib"
diff --git a/profiles/commons/libraries/timeago/jquery.timeago.js b/profiles/commons/libraries/timeago/jquery.timeago.js
index 54da8af..04a9012 100644
--- a/profiles/commons/libraries/timeago/jquery.timeago.js
+++ b/profiles/commons/libraries/timeago/jquery.timeago.js
@@ -3,7 +3,7 @@
  * updating fuzzy timestamps (e.g. "4 minutes ago" or "about 1 day ago").
  *
  * @name timeago
- * @version 1.0.2
+ * @version 1.1.0
  * @requires jQuery v1.2.3+
  * @author Ryan McGeary
  * @license MIT License - http://www.opensource.org/licenses/mit-license.php
@@ -40,6 +40,7 @@
     settings: {
       refreshMillis: 60000,
       allowFuture: false,
+      localeTitle: false,
       strings: {
         prefixAgo: null,
         prefixFromNow: null,
@@ -117,15 +118,34 @@
     }
   });
 
-  $.fn.timeago = function() {
-    var self = this;
-    self.each(refresh);
+  // functions that can be called via $(el).timeago('action')
+  // init is default when no action is given
+  // functions are called with context of a single element
+  var functions = {
+    init: function(){
+      var refresh_el = $.proxy(refresh, this);
+      refresh_el();
+      var $s = $t.settings;
+      if ($s.refreshMillis > 0) {
+        setInterval(refresh_el, $s.refreshMillis);
+      }
+    },
+    update: function(time){
+      $(this).data('timeago', { datetime: $t.parse(time) });
+      refresh.apply(this);
+    }
+  };
 
-    var $s = $t.settings;
-    if ($s.refreshMillis > 0) {
-      setInterval(function() { self.each(refresh); }, $s.refreshMillis);
+  $.fn.timeago = function(action, options) {
+    var fn = action ? functions[action] : functions.init;
+    if(!fn){
+      throw new Error("Unknown function name '"+ action +"' for timeago");
     }
-    return self;
+    // each over objects here and call the requested function
+    this.each(function(){
+      fn.call(this, options);
+    });
+    return this;
   };
 
   function refresh() {
@@ -141,7 +161,9 @@
     if (!element.data("timeago")) {
       element.data("timeago", { datetime: $t.datetime(element) });
       var text = $.trim(element.text());
-      if (text.length > 0 && !($t.isTime(element) && element.attr("title"))) {
+      if ($t.settings.localeTitle) {
+        element.attr("title", element.data('timeago').datetime.toLocaleString())
+      } else if (text.length > 0 && !($t.isTime(element) && element.attr("title"))) {
         element.attr("title", text);
       }
     }
diff --git a/profiles/commons/modules/contrib/admin_icons/admin_icons.info b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
index cb94ffa..2b0ceb8 100644
--- a/profiles/commons/modules/contrib/admin_icons/admin_icons.info
+++ b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
@@ -3,9 +3,9 @@ description = Icon font library for use with other modules and themes.
 core = 7.x
 
 
-; Information added by drupal.org packaging script on 2012-10-01
-version = "7.x-1.x-dev"
-core = "7.x"
+
+; Information added by drush on 2013-03-28
+version = ""
 project = "admin_icons"
-datestamp = "1349049710"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
index 006622f..67d9b35 100644
--- a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
+++ b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
@@ -6,9 +6,10 @@ core = 7.x
 dependencies[] = apachesolr
 dependencies[] = og
 
-; Information added by drupal.org packaging script on 2012-11-15
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+2-dev"
 core = "7.x"
 project = "apachesolr_og"
-datestamp = "1352939745"
+datestamp = "1364431825"
 
diff --git a/profiles/commons/modules/contrib/ckeditor/ckeditor.info b/profiles/commons/modules/contrib/ckeditor/ckeditor.info
index cb2045e..6fd2c22 100644
--- a/profiles/commons/modules/contrib/ckeditor/ckeditor.info
+++ b/profiles/commons/modules/contrib/ckeditor/ckeditor.info
@@ -5,9 +5,9 @@ package     = User interface
 configure   = admin/config/content/ckeditor
 files[]     = includes/ckeditor.user.inc
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.12+7-dev"
 core = "7.x"
 project = "ckeditor"
-datestamp = "1361827582"
+datestamp = "1364431826"
 
diff --git a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_page/commons_activity_page.info b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_page/commons_activity_page.info
index cefae79..c5b39e7 100644
--- a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_page/commons_activity_page.info
+++ b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_page/commons_activity_page.info
@@ -2,18 +2,19 @@ name = Commons Activity Page
 description = Allows users to view a stream of site-wide and personalized activity.
 core = 7.x
 package = Commons - Landing pages
-version = 7.x-3.0-alpha1
 project = commons_activity_page
 dependencies[] = ctools
+dependencies[] = panels
+dependencies[] = panels_ipe
 dependencies[] = page_manager
 dependencies[] = commons_featured
 dependencies[] = commons_activity_streams
 features[ctools][] = page_manager:pages_default:1
 features[features_api][] = api:1
 features[page_manager_pages][] = commons_activity_streams_activity
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.x-dev"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_activity_streams"
-datestamp = "1361753001"
+datestamp = "1364415912"
 
diff --git a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams.info b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams.info
index 80342f2..8888df4 100644
--- a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams.info
+++ b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams.info
@@ -41,9 +41,9 @@ features_exclude[field][message-commons_activity_streams_comment_created-field_t
 features_exclude[field][message-commons_activity_streams_node_created-field_target_nodes] = message-commons_activity_streams_node_created-field_target_nodes
 features_exclude[field][message-commons_activity_streams_user_profile_updated-field_target_users] = message-commons_activity_streams_user_profile_updated-field_target_users
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.x-dev"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_activity_streams"
-datestamp = "1361753001"
+datestamp = "1364415912"
 
diff --git a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
index 6c41d09..776f6c6 100644
--- a/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
+++ b/profiles/commons/modules/contrib/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
@@ -3,7 +3,6 @@ description = Contains Organic Groups integration for Commons Activity Streams
 core = 7.x
 package = Commons - Building blocks
 php = 5.2.4
-version = 7.x-3.0-alpha1
 project = commons_activity_streams_groups
 dependencies[] = commons_activity_streams
 dependencies[] = entity
@@ -13,9 +12,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:1
 features[views_view][] = activity_group
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.x-dev"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_activity_streams"
-datestamp = "1361753001"
+datestamp = "1364415912"
 
diff --git a/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.info b/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.info
index 9358259..5f3cba5 100644
--- a/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.info
+++ b/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.info
@@ -21,9 +21,9 @@ features[views_view][] = commons_content_moderation_reported_comments
 features[views_view][] = commons_content_moderation_reported_nodes
 features_exclude[dependencies][features] = features
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_content_moderation"
-datestamp = "1361820311"
+datestamp = "1364416512"
 
diff --git a/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.module b/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.module
index 69f8689..3e9c917 100644
--- a/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.module
+++ b/profiles/commons/modules/contrib/commons_content_moderation/commons_content_moderation.module
@@ -83,6 +83,9 @@ function commons_content_moderation_views_default_views_alter(&$views) {
   * Implements hook_views_bulk_operations_form_alter().
   */
 function commons_content_moderation_views_bulk_operations_form_alter(&$form, $form_state, $vbo) {
+  if(!isset($vbo->options['vbo_operations']['action::commons_content_moderation_delete_node_block_user'])) {
+    return;
+  }
   if ($form_state['step'] == 'views_form_views_form' && $vbo->options['vbo_operations']['action::commons_content_moderation_delete_node_block_user']['selected'] == 1) {
     if (module_exists('mollom') && _mollom_status()) {
       $form['mollom_text'] = array(
@@ -94,6 +97,5 @@ function commons_content_moderation_views_bulk_operations_form_alter(&$form, $fo
         '#markup' => t('When the !mollom module is installed and configured, content deleted here will also be reported to Mollom.', array('!mollom' => l('Mollom', 'http://drupal.org/project/mollom'))),
       );
     }
-
   }
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.features.field_base.inc b/profiles/commons/modules/contrib/commons_events/commons_events.features.field_base.inc
index 2377d7f..038c9c6 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.features.field_base.inc
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.features.field_base.inc
@@ -142,6 +142,47 @@ function commons_events_field_default_field_bases() {
     'type' => 'text',
   );
 
+  // Exported field_base: 'field_organizers'
+  $field_bases['field_organizers'] = array(
+    'active' => '1',
+    'cardinality' => '-1',
+    'deleted' => '0',
+    'entity_types' => array(),
+    'field_name' => 'field_organizers',
+    'foreign keys' => array(
+      'users' => array(
+        'columns' => array(
+          'target_id' => 'uid',
+        ),
+        'table' => 'users',
+      ),
+    ),
+    'indexes' => array(
+      'target_id' => array(
+        0 => 'target_id',
+      ),
+    ),
+    'locked' => '0',
+    'module' => 'entityreference',
+    'settings' => array(
+      'handler' => 'base',
+      'handler_settings' => array(
+        'behaviors' => array(
+          'views-select-list' => array(
+            'status' => 0,
+          ),
+        ),
+        'sort' => array(
+          'type' => 'none',
+        ),
+        'target_bundles' => array(),
+      ),
+      'target_type' => 'user',
+    ),
+    'translatable' => '0',
+    'type' => 'entityreference',
+  );
+
   // Exported field_base: 'field_registration'
   $field_bases['field_registration'] = array(
     'active' => '1',
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.features.field_instance.inc b/profiles/commons/modules/contrib/commons_events/commons_events.features.field_instance.inc
index 3abaa5d..242060e 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.features.field_instance.inc
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.features.field_instance.inc
@@ -31,7 +31,7 @@ function commons_events_field_default_field_instances() {
           'trim_length' => 600,
         ),
         'type' => 'text_summary_or_trimmed',
-        'weight' => 0,
+        'weight' => '3',
       ),
     ),
     'entity_type' => 'node',
@@ -85,10 +85,16 @@ function commons_events_field_default_field_instances() {
         'weight' => '2',
       ),
       'teaser' => array(
-        'label' => 'above',
-        'settings' => array(),
-        'type' => 'hidden',
-        'weight' => 0,
+        'label' => 'hidden',
+        'module' => 'addressfield',
+        'settings' => array(
+          'format_handlers' => array(
+            0 => 'address'
+          ),
+          'use_widget_handlers' => 1,
+        ),
+        'type' => 'addressfield_default',
+        'weight' => '2',
       ),
     ),
     'entity_type' => 'node',
@@ -112,7 +118,7 @@ function commons_events_field_default_field_instances() {
         ),
       ),
       'type' => 'addressfield_standard',
-      'weight' => '6',
+      'weight' => '8',
     ),
   );
 
@@ -126,7 +132,7 @@ function commons_events_field_default_field_instances() {
         'label' => 'hidden',
         'module' => 'date',
         'settings' => array(
-          'format_type' => 'long',
+          'format_type' => 'event_datetime',
           'fromto' => 'both',
           'multiple_from' => '',
           'multiple_number' => '',
@@ -136,10 +142,14 @@ function commons_events_field_default_field_instances() {
         'weight' => '1',
       ),
       'teaser' => array(
-        'label' => 'above',
-        'settings' => array(),
-        'type' => 'hidden',
-        'weight' => 0,
+        'label' => 'hidden',
+        'module' => 'date',
+        'settings' => array(
+          'format_type' => 'event_datetime',
+          'fromto' => 'both',
+        ),
+        'type' => 'date_default',
+        'weight' => '1',
       ),
     ),
     'entity_type' => 'node',
@@ -165,7 +175,7 @@ function commons_events_field_default_field_instances() {
         'year_range' => '-3:+3',
       ),
       'type' => 'date_popup',
-      'weight' => '4',
+      'weight' => '5',
     ),
   );
 
@@ -190,7 +200,7 @@ function commons_events_field_default_field_instances() {
         'label' => 'above',
         'settings' => array(),
         'type' => 'hidden',
-        'weight' => 0,
+        'weight' => '0',
       ),
     ),
     'entity_type' => 'node',
@@ -205,7 +215,7 @@ function commons_events_field_default_field_instances() {
       'module' => 'options',
       'settings' => array(),
       'type' => 'options_select',
-      'weight' => '5',
+      'weight' => '7',
     ),
   );
 
@@ -220,16 +230,19 @@ function commons_events_field_default_field_instances() {
         'module' => 'image',
         'settings' => array(
           'image_link' => '',
-          'image_style' => '',
+          'image_style' => '50x50',
         ),
         'type' => 'image',
         'weight' => '0',
       ),
       'teaser' => array(
         'label' => 'hidden',
-        'settings' => array(),
-        'type' => 'hidden',
-        'weight' => 0,
+        'module' => 'image',
+        'settings' => array(
+          'image_style' => '50x50',
+        ),
+        'type' => 'image',
+        'weight' => '0',
       ),
     ),
     'entity_type' => 'node',
@@ -251,11 +264,11 @@ function commons_events_field_default_field_instances() {
       'active' => 1,
       'module' => 'image',
       'settings' => array(
-        'preview_image_style' => 'thumbnail',
+        'preview_image_style' => '50x50',
         'progress_indicator' => 'throbber',
       ),
       'type' => 'image_image',
-      'weight' => '8',
+      'weight' => '9',
     ),
   );
 
@@ -299,7 +312,7 @@ function commons_events_field_default_field_instances() {
       'module' => 'number',
       'settings' => array(),
       'type' => 'number',
-      'weight' => '11',
+      'weight' => '12',
     ),
   );
 
@@ -339,6 +352,55 @@ function commons_events_field_default_field_instances() {
         'size' => '60',
       ),
       'type' => 'text_textfield',
+      'weight' => '3',
+    ),
+  );
+
+  // Exported field_instance: 'node-event-field_organizers'
+  $field_instances['node-event-field_organizers'] = array(
+    'bundle' => 'event',
+    'default_value' => NULL,
+    'default_value_function' => '',
+    'deleted' => '0',
+    'description' => '',
+    'display' => array(
+      'default' => array(
+        'label' => 'above',
+        'module' => 'entityreference',
+        'settings' => array(
+          'link' => FALSE,
+        ),
+        'type' => 'hidden',
+        'weight' => 12,
+      ),
+      'teaser' => array(
+        'label' => 'above',
+        'settings' => array(),
+        'type' => 'hidden',
+        'weight' => 0,
+      ),
+    ),
+    'entity_type' => 'node',
+    'field_name' => 'field_organizers',
+    'label' => 'Organizers',
+    'required' => 1,
+    'settings' => array(
+      'behaviors' => array(
+        'prepopulate' => array(
+          'status' => 0,
+        ),
+      ),
+      'user_register_form' => FALSE,
+    ),
+    'widget' => array(
+      'active' => 1,
+      'module' => 'entityreference',
+      'settings' => array(
+        'match_operator' => 'CONTAINS',
+        'path' => '',
+        'size' => '60',
+      ),
+      'type' => 'entityreference_autocomplete_tags',
       'weight' => '2',
     ),
   );
@@ -398,7 +460,7 @@ function commons_events_field_default_field_instances() {
       'module' => 'registration',
       'settings' => array(),
       'type' => 'registration_select',
-      'weight' => '9',
+      'weight' => '10',
     ),
   );
 
@@ -434,7 +496,7 @@ function commons_events_field_default_field_instances() {
       'module' => 'options',
       'settings' => array(),
       'type' => 'options_select',
-      'weight' => '10',
+      'weight' => '11',
     ),
   );
 
@@ -474,7 +536,7 @@ function commons_events_field_default_field_instances() {
         'size' => 60,
       ),
       'type' => 'taxonomy_autocomplete',
-      'weight' => '12',
+      'weight' => '13',
     ),
   );
 
@@ -487,6 +549,7 @@ function commons_events_field_default_field_instances() {
   t('Event logo');
   t('Location');
   t('Maximum number of attendees');
+  t('Organizers');
   t('Registration');
   t('Registration type');
   t('URL');
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.info b/profiles/commons/modules/contrib/commons_events/commons_events.info
index 6e390f5..10d049f 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.info
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.info
@@ -49,6 +49,7 @@ features[field_base][] = field_location
 features[field_base][] = field_logo
 features[field_base][] = field_number_of_attendees
 features[field_base][] = field_offsite_url
+features[field_base][] = field_organizers
 features[field_base][] = field_registration
 features[field_base][] = field_registration_type
 features[field_instance][] = node-event-body
@@ -58,6 +59,7 @@ features[field_instance][] = node-event-field_location
 features[field_instance][] = node-event-field_logo
 features[field_instance][] = node-event-field_number_of_attendees
 features[field_instance][] = node-event-field_offsite_url
+features[field_instance][] = node-event-field_organizers
 features[field_instance][] = node-event-field_registration
 features[field_instance][] = node-event-field_registration_type
 features[field_instance][] = node-event-field_topics
@@ -93,6 +95,7 @@ features[variable][] = node_options_event
 features[variable][] = node_preview_event
 features[variable][] = node_submitted_event
 features[views_view][] = commons_events_event_attendee_list
+features[views_view][] = commons_events_organizers
 features[views_view][] = commons_events_upcoming
 features[views_view][] = commons_events_user_upcoming_events
 files[] = commons_events.features.inc
@@ -101,9 +104,9 @@ files[] = commons_events.features.field_instance.inc
 files[] = commons_events.strongarm.inc
 files[] = includes/commons_events.forms.inc
 files[] = includes/commons_events.theme.inc
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_events"
-datestamp = "1361820316"
+datestamp = "1364416515"
 
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.install b/profiles/commons/modules/contrib/commons_events/commons_events.install
index 2c3ab27..72ebe55 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.install
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.install
@@ -1,11 +1,132 @@
 <?php
 
 /**
+ * Implements hook_install().
+ * Creates a default datetime format for events.
+ */
+function commons_events_install() {
+  db_insert('date_formats')
+    ->fields(array(
+      'format' => 'M d Y - g:ia T',
+      'type' => 'event_datetime',
+      'locked' => 1,
+    ))
+    ->execute();
+
+  db_insert('date_format_type')
+    ->fields(array(
+      'type' => 'event_datetime',
+      'title' => 'Event Datetime',
+      'locked' => 0,
+    ))
+    ->execute();
+
+  variable_set('date_format_event_datetime', 'M d Y - g:ia T');
+}
+
+/**
  * Disable summary on Event nodes.
  */
 function commons_events_update_7000() {
-    $revert = array(
-      'commons_events' => array('field_instance'),
+  $revert = array(
+    'commons_events' => array('field_instance'),
+  );
+  features_revert($revert);
+  return array();
+}
+
+/**
+ * Switch attendee view and event logo to use 50x50 image style.
+ */
+function commons_events_update_7001() {
+  $revert = array(
+    'commons_events' => array('views', 'node'),
+  );
+  features_revert($revert);
+  return array();
+}
+
+/**
+ * Add the Organizers entity reference field to Events and update existing nodes
+ * with the event's creator as the default value.
+ */
+function commons_events_update_7002() {
+  // Revert node and views to use default implementations. This resets field
+  // weights to configuration due to new Organizers field.
+  $revert = array(
+    'commons_events' => array('node'),
+  );
+  features_revert($revert);
+  if (field_info_field('field_organizers') == NULL) {
+    // Create the field so we can update the default values for existing events.
+    module_load_include('inc', 'commons_events', 'commons_events.features.field_base');
+    $fields = commons_events_field_default_field_bases();
+    field_create_field($fields['field_organizers']);
+  }
+  if (field_info_instance('node', 'field_organizers', 'event') == NULL) {
+    // Create the instance on Events.
+    module_load_include('inc', 'commons_events', 'commons_events.features.field_instance');
+    $instances = commons_events_field_default_field_instances();
+    field_create_instance($instances['node-event-field_organizers']);
+  }
+  // Now update all existing Events to have the creator as the default organizer.
+  $events = new EntityFieldQuery();
+  $events->entityCondition('entity_type', 'node')
+    ->entityCondition('bundle', 'event');
+  $events = $events->execute();
+  $events = entity_load('node', array_keys($events['node']));
+  foreach($events as $nid => $event) {
+    if (!property_exists($event, 'field_organizers') || empty($event->field_organizers)) {
+      $event->field_organizers = array(
+        $event->language => array(
+          0 => array(
+            'target_id' => $event->uid
+          )
+        ),
+      );
+      node_save($event);
+    }
+  }
+  return array();
+}
+
+/**
+ * Change event teaser display to show logo, date, and address.
+ */
+function commons_events_update_7003() {
+  $revert = array(
+    'commons_events' => array('field_instance'),
+  );
+  features_revert($revert);
+  return array();
+}
+
+/**
+* Create the event_datetime date format.
+*/
+function commons_events_update_7004() {
+  db_insert('date_formats')
+    ->fields(array(
+      'format' => 'M d Y - g:ia T',
+      'type' => 'event_datetime',
+      'locked' => 1,
+    ))
+    ->execute();
+
+  db_insert('date_format_type')
+    ->fields(array(
+      'type' => 'event_datetime',
+      'title' => 'Event Datetime',
+      'locked' => 0,
+    ))
+    ->execute();
+
+  variable_set('date_format_event_datetime', 'M d Y - g:ia T');
+
+  // Revert commons_events to make sure its referencing the event_datetime module.
+  $revert = array(
+    'commons_events' => array('field_instance'),
+    'commons_events' => array('views_view'),
   );
   features_revert($revert);
   return array();
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.module b/profiles/commons/modules/contrib/commons_events/commons_events.module
index c894d8d..fda15bd 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.module
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.module
@@ -7,23 +7,6 @@
 include_once 'commons_events.features.inc';
 
 /**
- * Implements hook_menu().
- */
-function commons_events_menu() {
-  $items = array();
-  $items['node/%node/attendees'] = array(
-    'title' => 'Attendees',
-    'page callback' => 'commons_events_event_attendees_page',
-    'page arguments' => array(1),
-    'access callback' => 'commons_events_attendee_access',
-    'access arguments' => array(1),
-    'type' => MENU_LOCAL_TASK,
-    'weight' => 5,
-  );
-  return $items;
-}
-
-/**
  * Implements hook_menu_alter().
  */
 function commons_events_menu_alter(&$items) {
@@ -94,6 +77,65 @@ function commons_events_theme($existing, $type, $theme, $path) {
 }
 
 /**
+ * Implements hook_element_info_alter().
+ */
+function commons_events_element_info_alter(&$type) {
+  // Extend date_combo processing to alter the label text on the fields.
+  if (isset($type['date_combo'])) {
+    $type['date_combo']['#process'][] = 'commons_events_date_combo_element_process';
+  }
+
+  // Extend date_popup processing to remove the redundant descriptions on
+  // fields.
+  if (isset($type['date_popup'])) {
+    $type['date_popup']['#process'][] = 'commons_events_date_popup_element_process';
+  }
+}
+
+/**
+ * Process date_combo field output.
+ *
+ * This is an extension of the Date module's own processing.
+ *
+ * @see date_combo_element_process()
+ * @see commons_events_element_info_alter()
+ */
+function commons_events_date_combo_element_process($element, &$form_state, $form) {
+  $field = field_widget_field($element, $form_state);
+
+  // Change the labels for from and to dates to something more meaningful.
+  if (!empty($field['settings']['todate'])) {
+    $element['value']['#title'] = t('Start date');
+    $element['value2']['#title'] = t('End date');
+  }
+
+  return $element;
+}
+
+/**
+ * Process date_popup field output.
+ *
+ * This is an extension of the Date module's own processing.
+ *
+ * @see date_popup_element_process()
+ * @see commons_events_element_info_alter()
+ */
+function commons_events_date_popup_element_process($element, &$form_state, $form) {
+  // If a date_popup field is part of a larger range widget, simplify the
+  // output.
+  if (!empty($element['#field']['settings']['todate'])) {
+    foreach (array('date', 'time') as $type) {
+      if (!empty($element[$type])) {
+        // The description and title are unnecessary.
+        unset($element[$type]['#description']);
+        $element[$type]['#title'] = '';
+      }
+    }
+  }
+  return $element;
+}
+
+/**
  * Implements hook_entity_view_alter().
  */
 function commons_events_entity_view_alter(&$build, $type) {
@@ -171,12 +213,6 @@ function commons_events_form_node_form_alter(&$form, &$form_state) {
     );
     $form['field_number_of_attendees']['#weight'] = 11;
     $form['field_topics']['#weight'] = 12;
-    // URL field shown if registration is offsite only.
-    $form['field_offsite_url']['#states'] = array(
-      'visible' => array(
-        ':input[name^="field_registration_type"]' => array('value' => 'external'),
-      ),
-    );
     $form['#validate'] = array_merge(array('commons_events_node_form_validate'), $form['#validate']);
     $form['#submit'][] = 'commons_events_node_form_submit';
     // Move registration settings into a fieldset so we can move the group.
@@ -188,6 +224,13 @@ function commons_events_form_node_form_alter(&$form, &$form_state) {
       '#group' => 'additional_settings',
       '#weight' => -10,
     );
+    if (empty($form['field_organizers'][$form['field_organizers']['#language']]['#default_value'])) {
+      global $user;
+      $user_wrapper = entity_metadata_wrapper('user', $user);
+      $name = $user_wrapper->field_name_first->value() . " " . $user_wrapper->field_name_last->value() . " (" . $user->uid . ")";
+      $form['field_organizers'][$form['field_organizers']['#language']]['#default_value'] = $name;
+    }
+    $form['event_registration_settings']['field_organizers'] = $form['field_organizers'];
     $form['event_registration_settings']['field_registration_type'] = $form['field_registration_type'];
     $form['event_registration_settings']['field_status'] = $form['field_status'];
     $form['event_registration_settings']['field_number_of_attendees'] = $form['field_number_of_attendees'];
@@ -199,11 +242,12 @@ function commons_events_form_node_form_alter(&$form, &$form_state) {
       '#group' => 'additional_settings',
       '#weight' => -9,
     );
+    $form['field_organizers'] = array('#language' => NULL);
     $form['event_topics']['field_topics'] = $form['field_topics'];
-    unset($form['field_topics']);
-    unset($form['field_registration_type']);
-    unset($form['field_status']);
-    unset($form['field_number_of_attendees']);
+    $form['field_topics'] = array('#language' => NULL);
+    $form['field_registration_type'] = array('#language' => NULL);
+    $form['field_status'] = array('#language' => NULL);
+    $form['field_number_of_attendees'] = array('#language' => NULL);
   }
 }
 
@@ -257,6 +301,28 @@ function commons_events_node_form_submit($form, $form_state) {
     }
     $settings['settings'] = serialize($settings['settings']);
     registration_update_entity_settings('node', $node->nid, $settings);
+    // Automatically register the node creator for the event.
+    $registration_type = registration_get_entity_registration_type('node', $node);
+    $registration = entity_get_controller('registration')->create(array(
+      'entity_type' => 'node',
+      'entity_id' => $node->nid,
+      'type' => $registration_type,
+    ));
+    if (!isset($node->uid)) {
+      global $user;
+      $uid = $user->uid;
+    }
+    else {
+      $uid = $node->uid;
+    }
+    if ($settings['status'] == 1
+      && !registration_is_registered($registration, NULL, $uid)) {
+      $registration->user_uid = $uid;
+      $registration->author_uid = $uid;
+      $registration->state = NULL;
+      $registration->count = 1;
+      registration_save($registration);
+    }
   }
 }
 
@@ -380,3 +446,67 @@ function commons_events_block_view($delta = '') {
     );
   }
 }
+
+/**
+ * Implements hook_theme_registry_alter().
+ * Gives us the ability to insert our pretty date formatter for the dates we choose below.
+ */
+function commons_events_theme_registry_alter(&$theme_registry) {
+  $theme_registry['date_display_range']['theme path'] = drupal_get_path('module', 'commons_events');
+  $theme_registry['date_display_range']['function'] = 'commons_events_theme_date_display_range';
+}
+
+/**
+ * Returns specific HTML for a date element formatted with the event formatter M j Y - g:ia
+ * We the do some awesome stuff with regular expressions to take all the different formats available to us and format it pretty.
+ */
+function commons_events_theme_date_display_range($variables) {
+  // Use the regular date formatter if we are any other date format than below.
+  if (!preg_match('/[FmMnt|dDjlNSwz|oYy] - [gGhH]:[i][Aa]{0,1}/', $variables['dates']['format'])) {
+    return theme_date_display_range($variables);
+  }
+
+  // If the difference is over a year:
+  if ($variables['dates']['value']['db']['object']->difference($variables['dates']['value2']['db']['object'], 'years') > 0) {
+    return theme_date_display_range($variables);
+  } else {
+    preg_match('/[oYy]/', $variables['dates']['format'], $year_format);
+    $year = $variables['dates']['value']['db']['object']->format($year_format[0]);
+  }
+  // Remove the time and year.
+  $stripped_format = preg_replace('/\s\s+/', ' ', preg_filter(array('/[oYy]/', '/[-:aABgGhHisuT]/'), array('', ''), $variables['dates']['format']));
+  if (!empty($variables['dates']['value2']['formatted_time'])) {
+    $end_time = TRUE;
+  }
+  // If the difference is over a month:
+  if ($variables['dates']['value']['db']['object']->difference($variables['dates']['value2']['db']['object'], 'months') > 0) {
+    $dm_seg = $variables['dates']['value']['db']['object']->format($stripped_format) . '-' . $variables['dates']['value2']['db']['object']->format($stripped_format);
+    $date = preg_filter(array('/[FmMntdDjlNSwz] [FmMntdDjlNSwz]/', '/[oYy]/', '/- [gGhH]:[i][Aa]{0,1} [T]/'), array($dm_seg, $year, ''), $variables['dates']['format']);
+  }
+  // If the difference is under a month but over a day:
+  else if ($variables['dates']['value']['db']['object']->difference($variables['dates']['value2']['db']['object'], 'days') > 0) {
+    $days = $variables['dates']['value']['db']['object']->format(preg_filter(array('/[FmMnt]/'), array(''), $stripped_format)) . '-' .
+      $variables['dates']['value2']['db']['object']->format(preg_filter(array('/[FmMnt]/'), array(''), $stripped_format));
+    $months = $variables['dates']['value']['db']['object']->format(preg_filter(array('/[dDjlNSwz]/'), array(''), $stripped_format));
+    $date = preg_filter(array('/[FmMnt]/', '/[dDjlNSwz]/', '/[oYy]/', '/- [gGhH]:[i][Aa]{0,1} [T]/'), array($months, $days, $year, ''), $variables['dates']['format']);
+  }
+  // Same day event, output the formatted start date and strip the end time if its the same as start time.
+  else {
+    $date = $variables['dates']['value']['formatted_date'];
+    if($variables['dates']['value']['formatted_time'] === $variables['dates']['value2']['formatted_time']) {
+      $end_time = FALSE;
+    }
+  }
+  if ($end_time) {
+    $time = $variables['dates']['value']['formatted_time'] . '-' . $variables['dates']['value2']['formatted_time'];
+  } else {
+    $time = $variables['dates']['value']['formatted_time'];
+  }
+  $timezone = $variables['timezone'];
+  $attributes_start = $variables['attributes_start'];
+
+  // Wrap the result with the attributes.
+  return t('!start-date', array(
+    '!start-date' => '<span class="date-display-start"' . drupal_attributes($attributes_start) . '>' . $date . $time . $timezone . '</span>',
+  ));
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_events/commons_events.views_default.inc b/profiles/commons/modules/contrib/commons_events/commons_events.views_default.inc
index 2d9d17a..86240a5 100644
--- a/profiles/commons/modules/contrib/commons_events/commons_events.views_default.inc
+++ b/profiles/commons/modules/contrib/commons_events/commons_events.views_default.inc
@@ -51,7 +51,7 @@ function commons_events_views_default_views() {
   $handler->display->display_options['fields']['picture']['relationship'] = 'user_uid';
   $handler->display->display_options['fields']['picture']['label'] = '';
   $handler->display->display_options['fields']['picture']['element_label_colon'] = FALSE;
-  $handler->display->display_options['fields']['picture']['image_style'] = 'thumbnail';
+  $handler->display->display_options['fields']['picture']['image_style'] = '50x50';
   /* Field: User: Name */
   $handler->display->display_options['fields']['name']['id'] = 'name';
   $handler->display->display_options['fields']['name']['table'] = 'users';
@@ -148,7 +148,7 @@ function commons_events_views_default_views() {
   $handler->display->display_options['fields']['field_date']['label'] = '';
   $handler->display->display_options['fields']['field_date']['element_label_colon'] = FALSE;
   $handler->display->display_options['fields']['field_date']['settings'] = array(
-    'format_type' => 'long',
+    'format_type' => 'event_datetime',
     'fromto' => 'both',
     'multiple_number' => '',
     'multiple_from' => '',
@@ -265,7 +265,7 @@ function commons_events_views_default_views() {
   $handler->display->display_options['fields']['field_date']['label'] = '';
   $handler->display->display_options['fields']['field_date']['element_label_colon'] = FALSE;
   $handler->display->display_options['fields']['field_date']['settings'] = array(
-    'format_type' => 'long',
+    'format_type' => 'event_datetime',
     'fromto' => 'both',
     'multiple_number' => '',
     'multiple_from' => '',
@@ -327,16 +327,18 @@ function commons_events_views_default_views() {
   $handler->display->display_options['defaults']['row_options'] = FALSE;
   $handler->display->display_options['defaults']['header'] = FALSE;
   $handler->display->display_options['defaults']['sorts'] = FALSE;
-  /* Sort criterion: Content: Date -  start date (field_date) */
-  $handler->display->display_options['sorts']['field_date_value']['id'] = 'field_date_value';
-  $handler->display->display_options['sorts']['field_date_value']['table'] = 'field_data_field_date';
-  $handler->display->display_options['sorts']['field_date_value']['field'] = 'field_date_value';
   /* Sort criterion: Content: Promoted to front page */
   $handler->display->display_options['sorts']['promote']['id'] = 'promote';
   $handler->display->display_options['sorts']['promote']['table'] = 'node';
   $handler->display->display_options['sorts']['promote']['field'] = 'promote';
   $handler->display->display_options['sorts']['promote']['exposed'] = TRUE;
   $handler->display->display_options['sorts']['promote']['expose']['label'] = 'Featured';
+  /* Sort criterion: Content: Date -  start date (field_date) */
+  $handler->display->display_options['sorts']['field_date_value']['id'] = 'field_date_value';
+  $handler->display->display_options['sorts']['field_date_value']['table'] = 'field_data_field_date';
+  $handler->display->display_options['sorts']['field_date_value']['field'] = 'field_date_value';
+  $handler->display->display_options['sorts']['field_date_value']['exposed'] = TRUE;
+  $handler->display->display_options['sorts']['field_date_value']['expose']['label'] = 'Date';
   $export['commons_events_upcoming'] = $view;
 
   $view = new view();
@@ -621,5 +623,64 @@ function commons_events_views_default_views() {
   $handler->display->display_options['defaults']['arguments'] = FALSE;
   $export['commons_events_user_upcoming_events'] = $view;
 
+  $view = new view();
+  $view->name = 'commons_events_organizers';
+  $view->description = 'Event organizer panel pane.';
+  $view->tag = 'commons_events';
+  $view->base_table = 'node';
+  $view->human_name = 'Commons Events - Organizers';
+  $view->core = 7;
+  $view->api_version = '3.0';
+  $view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */
+
+  /* Display: Master */
+  $handler = $view->new_display('default', 'Master', 'default');
+  $handler->display->display_options['title'] = 'Organizers';
+  $handler->display->display_options['use_more_always'] = FALSE;
+  $handler->display->display_options['access']['type'] = 'perm';
+  $handler->display->display_options['cache']['type'] = 'none';
+  $handler->display->display_options['query']['type'] = 'views_query';
+  $handler->display->display_options['exposed_form']['type'] = 'basic';
+  $handler->display->display_options['pager']['type'] = 'none';
+  $handler->display->display_options['pager']['options']['offset'] = '0';
+  $handler->display->display_options['style_plugin'] = 'grid';
+  $handler->display->display_options['row_plugin'] = 'fields';
+  /* Relationship: Entity Reference: Referenced Entity */
+  $handler->display->display_options['relationships']['field_organizers_target_id']['id'] = 'field_organizers_target_id';
+  $handler->display->display_options['relationships']['field_organizers_target_id']['table'] = 'field_data_field_organizers';
+  $handler->display->display_options['relationships']['field_organizers_target_id']['field'] = 'field_organizers_target_id';
+  $handler->display->display_options['relationships']['field_organizers_target_id']['required'] = TRUE;
+  /* Field: User: Picture */
+  $handler->display->display_options['fields']['picture']['id'] = 'picture';
+  $handler->display->display_options['fields']['picture']['table'] = 'users';
+  $handler->display->display_options['fields']['picture']['field'] = 'picture';
+  $handler->display->display_options['fields']['picture']['relationship'] = 'field_organizers_target_id';
+  $handler->display->display_options['fields']['picture']['label'] = '';
+  $handler->display->display_options['fields']['picture']['element_label_colon'] = FALSE;
+  $handler->display->display_options['fields']['picture']['image_style'] = '50x50';
+  /* Contextual filter: Content: Nid */
+  $handler->display->display_options['arguments']['nid']['id'] = 'nid';
+  $handler->display->display_options['arguments']['nid']['table'] = 'node';
+  $handler->display->display_options['arguments']['nid']['field'] = 'nid';
+  $handler->display->display_options['arguments']['nid']['default_action'] = 'not found';
+  $handler->display->display_options['arguments']['nid']['default_argument_type'] = 'fixed';
+  $handler->display->display_options['arguments']['nid']['summary']['number_of_records'] = '0';
+  $handler->display->display_options['arguments']['nid']['summary']['format'] = 'default_summary';
+  $handler->display->display_options['arguments']['nid']['summary_options']['items_per_page'] = '25';
+
+  /* Display: Content pane */
+  $handler = $view->new_display('panel_pane', 'Content pane', 'panel_pane_1');
+  $handler->display->display_options['argument_input'] = array(
+    'nid' => array(
+      'type' => 'context',
+      'context' => 'entity:node.nid',
+      'context_optional' => 0,
+      'panel' => '0',
+      'fixed' => '',
+      'label' => 'Content: Nid',
+    ),
+  );
+  $export['commons_events_organizers'] = $view;
+
   return $export;
 }
diff --git a/profiles/commons/modules/contrib/commons_events/includes/commons_events.theme.inc b/profiles/commons/modules/contrib/commons_events/includes/commons_events.theme.inc
index 4487f69..1975ef6 100644
--- a/profiles/commons/modules/contrib/commons_events/includes/commons_events.theme.inc
+++ b/profiles/commons/modules/contrib/commons_events/includes/commons_events.theme.inc
@@ -19,6 +19,7 @@ function theme_commons_events_attending_event($variables = array()) {
     'entity_type' => 'node',
     'entity_id' => $event->nid,
     'type' => $registration_type,
+    'author_uid' => $user->uid,
   ));
   if (!function_exists('commons_events_attend_event_form')
     || !function_exists('commons_events_cancel_event_form')) {
diff --git a/profiles/commons/modules/contrib/commons_events/js/commons_events.js b/profiles/commons/modules/contrib/commons_events/js/commons_events.js
index e69822c..334fc15 100644
--- a/profiles/commons/modules/contrib/commons_events/js/commons_events.js
+++ b/profiles/commons/modules/contrib/commons_events/js/commons_events.js
@@ -1,9 +1,11 @@
 (function ($) {
   $.fn.changeElementType = function(newType) {
     var attrs = {};
-    $.each(this[0].attributes, function(idx, attr) {
-      attrs[attr.nodeName] = attr.nodeValue;
-    });
+    if ($(this).length) {
+      $.each(this[0].attributes, function(idx, attr) {
+        attrs[attr.nodeName] = attr.nodeValue;
+      });
+    }
     this.replaceWith(function() {
       return $("<" + newType + "/>", attrs).append($(this).contents());
     });
diff --git a/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.info b/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.info
index 08708e6..74d73f2 100644
--- a/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.info
+++ b/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.info
@@ -15,9 +15,9 @@ features[variable][] = panelizer_defaults_node_event
 files[] = commons_events_pages.features.inc
 files[] = commons_events_pages.strongarm.inc
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_events"
-datestamp = "1361820316"
+datestamp = "1364416515"
 
diff --git a/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.panelizer.inc b/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.panelizer.inc
index 2dd12e4..d5b36f1 100644
--- a/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.panelizer.inc
+++ b/profiles/commons/modules/contrib/commons_events/modules/commons_events_pages/commons_events_pages.panelizer.inc
@@ -77,6 +77,28 @@ function commons_events_pages_panelizer_defaults() {
     $pane->pid = 'new-2';
     $pane->panel = 'two_66_33_second';
     $pane->type = 'views_panes';
+    $pane->subtype = 'commons_events_organizers-panel_pane_1';
+    $pane->shown = TRUE;
+    $pane->access = array();
+    $pane->configuration = array(
+      'context' => array(
+        0 => 'panelizer',
+      ),
+    );
+    $pane->cache = array();
+    $pane->style = array(
+      'settings' => NULL,
+    );
+    $pane->css = array();
+    $pane->extras = array();
+    $pane->position = 0;
+    $pane->locks = array();
+    $display->content['new-2'] = $pane;
+    $display->panels['two_66_33_second'][0] = 'new-2';
+    $pane = new stdClass();
+    $pane->pid = 'new-3';
+    $pane->panel = 'two_66_33_second';
+    $pane->type = 'views_panes';
     $pane->subtype = 'commons_events_event_attendee_list-panel_pane_1';
     $pane->shown = TRUE;
     $pane->access = array();
@@ -95,10 +117,10 @@ function commons_events_pages_panelizer_defaults() {
     );
     $pane->css = array();
     $pane->extras = array();
-    $pane->position = 0;
+    $pane->position = 1;
     $pane->locks = array();
-    $display->content['new-2'] = $pane;
-    $display->panels['two_66_33_second'][0] = 'new-2';
+    $display->content['new-3'] = $pane;
+    $display->panels['two_66_33_second'][1] = 'new-3';
   $display->hide_title = PANELS_TITLE_NONE;
   $display->title_pane = '0';
   $panelizer->display = $display;
diff --git a/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.info b/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.info
index ee70f4e..f9309fa 100644
--- a/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.info
+++ b/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.info
@@ -21,9 +21,9 @@ features[page_manager_existing_pages][] = solr_events_search
 features[page_manager_handlers][] = pm_existing_pages_solr_events_search_panel_context
 features[variable][] = pm_existing_pages_disabled_solr_events_search
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_events"
-datestamp = "1361820316"
+datestamp = "1364416515"
 
diff --git a/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.module b/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.module
index b3d6032..c37a5e7 100644
--- a/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.module
+++ b/profiles/commons/modules/contrib/commons_events/modules/commons_events_solr/commons_events_solr.module
@@ -241,9 +241,9 @@ function commons_events_solr_apachesolr_process_results(&$results, DrupalSolrQue
 /**
  * Implements hook_preprocess_hook().
  */
-function commons_events_solr_preprocess_search_results(&$variables) {
+function commons_events_solr_process_search_results(&$variables) {
   if ($variables['search_page']['page_id'] == 'solr_events') {
-    $variables['search_title'] = format_plural(count($variables['results']), '1 event', '@count events');
+    $variables['title'] = format_plural(count($variables['results']), '1 event', '@count events');
   }
 }
 
@@ -284,12 +284,10 @@ function commons_events_solr_environment_form_submit($form, $form_state) {
 }
 
 /**
- * Implements hook_modules_enabled().
+ *  Implements hook_node_presave to display a message warning the user that results won't occur immediately
  */
-function commons_events_solr_modules_enabled($modules) {
-  if (in_array('acquia_search', $modules)) {
-    // If Acquia Search is enabled later, we need to force update our facets,
-    // otherwise our Events Solr page has no facets.
-    commons_events_solr_create_facets(ACQUIA_SEARCH_ENVIRONMENT_ID);
+function commons_events_solr_node_presave($node) {
+  if ($node->type == 'event') {
+    drupal_set_message(t('Your event may take a few minutes to appear on the listing page.'));
   }
-}
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_base.inc b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_base.inc
index e1b9d59..cd8b2c0 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_base.inc
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_base.inc
@@ -42,6 +42,7 @@ function commons_groups_field_default_field_bases() {
     'cardinality' => '-1',
     'deleted' => '0',
     'entity_types' => array(),
+    'description' => 'Separate group names with commas',
     'field_name' => 'og_group_ref',
     'foreign keys' => array(
       'node' => array(
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_instance.inc b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_instance.inc
index df71673..653dfdf 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_instance.inc
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.field_instance.inc
@@ -209,7 +209,7 @@ function commons_groups_field_definition(&$field_instances, $entity_type, $bundl
     'default_value' => NULL,
     'default_value_function' => 'commons_groups_entityreference_default_value',
     'deleted' => '0',
-    'description' => '',
+    'description' => 'Separate group names with commas',
     'display' => array(
       'default' => array(
         'label' => 'above',
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.features.user_permission.inc b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.user_permission.inc
new file mode 100644
index 0000000..6535493
--- /dev/null
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.features.user_permission.inc
@@ -0,0 +1,34 @@
+<?php
+/**
+ * @file
+ * commons_groups.features.user_permission.inc
+ */
+
+/**
+ * Implements hook_user_default_permissions().
+ */
+function commons_groups_user_default_permissions() {
+  $permissions = array();
+
+  // Exported permission: create group content.
+  $permissions['create group content'] = array(
+    'name' => 'create group content',
+    'roles' => array(
+      'administrator' => 'administrator',
+      'authenticated user' => 'authenticated user',
+    ),
+    'module' => 'node',
+  );
+
+  // Exported permission: edit own group content.
+  $permissions['edit own group content'] = array(
+    'name' => 'edit own group content',
+    'roles' => array(
+      'administrator' => 'administrator',
+      'authenticated user' => 'authenticated user',
+    ),
+    'module' => 'node',
+  );
+
+  return $permissions;
+}
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.info b/profiles/commons/modules/contrib/commons_groups/commons_groups.info
index 6b9c796..1f284ad 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.info
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.info
@@ -34,6 +34,8 @@ features[field_instance][] = og_membership-og_membership_type_default-og_members
 features[image][] = 35x35
 features[image][] = 50x50
 features[node][] = group
+features[user_permission][] = create group content
+features[user_permission][] = edit own group content
 features[variable][] = comment_anonymous_group
 features[variable][] = comment_default_mode_group
 features[variable][] = comment_default_per_page_group
@@ -47,6 +49,7 @@ features[variable][] = menu_parent_group
 features[variable][] = node_options_group
 features[variable][] = node_preview_group
 features[variable][] = node_submitted_group
+features[variable][] = og_group_manager_default_rids_node_group
 features[variable][] = pathauto_node_group_pattern
 features[variable][] = pathauto_node_pattern
 features[views_view][] = commons_bw_all
@@ -56,9 +59,9 @@ features[views_view][] = commons_groups_contributors
 features[views_view][] = commons_groups_directory
 features[views_view][] = commons_groups_recent_content
 features[views_view][] = commons_groups_user_groups
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_groups"
-datestamp = "1361820323"
+datestamp = "1364416518"
 
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.install b/profiles/commons/modules/contrib/commons_groups/commons_groups.install
index a7bc43c..23b8375 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.install
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.install
@@ -6,4 +6,90 @@
 function commons_groups_update_3100() {
   features_revert(array('commons_groups' => array('variable')));
   return array();
+}
+/**
+* Grant users the "group organizer" role after she's created a group.
+*/
+function commons_groups_update_3101() {
+  // We've updated the og_group_manager_default_rids_node_group variable.
+  features_revert(array('commons_groups' => array('variable')));
+  return array();
+}
+
+/**
+* Ensure that the anonymous users is not listed as a group member,
+* per http://drupal.org/node/1910874.
+*/
+function commons_groups_update_3102() {
+  $delete = db_delete('og_users_roles')
+    ->condition('uid', 0, '=')
+    ->execute();
+  return array();
+}
+
+/**
+* Grant authenticated users permission to create group nodes
+* per http://drupal.org/node/1936714.
+*/
+function commons_groups_update_3103() {
+  features_revert(array('commons_groups' => array('user_permission')));
+  return array();
+}
+
+/**
+* Grant authenticated users permission to create group nodes
+* per http://drupal.org/node/1936714.
+*/
+function commons_groups_update_3104() {
+  features_revert(array('commons_groups' => array('field_base', 'field_instance')));
+  return array();
+}
+
+/**
+ * Change the OG Organizer role back to Administrator member.
+ * See http://drupal.org/node/1940150 for more information.
+ */
+function commons_groups_update_3105() {
+  $result = db_update('og_role')
+    ->fields(array('name' => 'administrator member'))
+    ->condition('rid', 3, '=')
+    ->execute();
+  return array();
+}
+
+/**
+ * Update contributor view to show the titles per the interactive prototype.
+ * (http://drupal.org/node/1821808).
+ */
+function commons_groups_update_3106() {
+    $revert = array(
+      'commons_groups' => array('views_view'),
+  );
+  features_revert($revert);
+  return array();
+}
+
+/**
+ * Give group owners the organizer role for their own group
+ */
+function commons_groups_update_3107() {
+  // Ensure that the group creator is also listed as an organizer.
+  $group_nodes = db_select('node', 'n')
+    ->fields('n', array('nid', 'uid'))
+    ->condition('n.type', 'group','=')
+    ->execute()
+    ->fetchAll();
+  $organizer_role = db_select('og_role', 'o')
+    ->fields('o', array('rid'))
+    ->condition('o.group_bundle', 'group')
+    ->condition('o.name', 'administrator member')
+    ->execute()
+    ->fetchField();
+
+  foreach($group_nodes as $record) {
+    if (!empty($organizer_role)) {
+      og_role_grant('node', $record->nid, $record->uid, $organizer_role);
+    }
+  }
+  return array();
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.module b/profiles/commons/modules/contrib/commons_groups/commons_groups.module
index c731676..40c407f 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.module
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.module
@@ -151,6 +151,11 @@ function commons_groups_module_implements_alter(&$implementations, $hook) {
 * Implements hook_form_alter().
 */
 function commons_groups_form_alter(&$form, &$form_state, $form_id) {
+  if($form_id == 'views_exposed_form' && strstr($form['#id'], 'views-exposed-form-commons-groups-directory')) {
+    $form['groups-keys']['#attributes'] = array(
+        'placeholder' => t('Separate keywords with commas'),
+      );
+  }
   if((strstr($form_id, 'views_form_commons_group_moderation_page'))) {
     $form['select']['action::views_bulk_operations_delete_item']['#weight'] = 9;
   }
@@ -165,7 +170,8 @@ function commons_groups_form_alter(&$form, &$form_state, $form_id) {
       $types = node_type_get_types();
       $type = $form['#node']->type;
       // Use 'a' or 'an' appropriately.
-      $verb = strtolower($type[0]) == 'a' ? 'Create an' : 'Create a';
+      $vowels = array('a', 'e', 'i', 'o', 'u');
+      $verb = strtolower(in_array($type[0], $vowels)) ? 'Create an' : 'Create a';
       drupal_set_title(t("$verb @name", array('@name' => $types[$type]->name)), PASS_THROUGH);
     }
     // Customizations to the node form for entitites that are group content.
@@ -241,11 +247,13 @@ function commons_groups_og_user_access_alter(&$temp_perm, $context) {
   $user_is_member = (bool)og_is_member('node', $context['group']->nid, 'user', $context['account']);
   foreach ($commons_groups_entity_types['node'] as $type => $options) {
     // We do a literal user_access() check on the create permission here
-    // because we can't call node_access() without causing recursion.
+    // because we can't call node_access() OR og_user_access without causing recursion.
     // The code flow is:
     // node_access()>og_node_access()=>og_user_access_entity=>og_user_access=>
     // og_user_access_alter()=>commons_groups_og_user_access_alter().
     // See also: http://drupal.org/node/1910874.
+
+    // If a group is not restricted, or the user is a member, and the user can create content of a certain type, let them post temporarily
     if ($context['string'] == "create $type content" && (!$group_content_restricted || $user_is_member) && user_access("create $type content", $context['account'])) {
       $temp_perm["create $type content"] = TRUE;
       return;
@@ -432,12 +440,14 @@ function commons_groups_entityreference_default_value($entity_type, $entity, $fi
   }
 }
 
- function commons_groups_default_rules_configuration_alter(&$configs) {
+function commons_groups_default_rules_configuration_alter(&$configs) {
   // Disable default OG new content notifications.
   // The language doesn't correspond to Commons' open groups model and we use
   // commons_follow and commons_follow_notify for new content notifications.
-  $configs['rules_og_member_active']->active = FALSE;
- }
+  if (isset($configs['rules_og_member_active'])) {
+    $configs['rules_og_member_active']->active = FALSE;
+  }
+}
 
 /**
 * Implements hook_node_update().
@@ -486,6 +496,11 @@ function commons_groups_get_group_content_entity_types() {
 * grant her the contributor role within that group.
 */
 function commons_groups_first_contribution($account, $node) {
+  // Anonymous users should never be added to a group automatically
+  if ($account->uid == 0) {
+    return;
+  }
+
   // Find the groups that this piece of content belongs to.
   $groups = og_get_entity_groups('node', $node);
   if (!empty($groups)) {
@@ -496,6 +511,10 @@ function commons_groups_first_contribution($account, $node) {
       $account_groups = array();
     }
     // For groups where this user is not already a member, add her to the group.
+    // Anonymous users should never be added to a group automatically
+    if ($account->uid == 0) {
+      return;
+    }
     $new_groups = array_diff($node_groups, $account_groups);
     if (!empty($new_groups)) {
       foreach ($new_groups as $new_group_nid) {
@@ -520,3 +539,14 @@ function commons_groups_commons_bw_group_widget() {
     ),
   );
 }
+
+/**
+ * Implements hook_preprocess_views_view_grid().
+ */
+function commons_groups_preprocess_views_view_grid(&$variables, $hook) {
+  // Change the displayed role name in the group contributors block to
+  // "Organizers".
+  if ($variables['view']->name == 'commons_contributors_group' && !empty($variables['title']) && $variables['title'] == 'administrator member') {
+    $variables['title'] = t('Organizers');
+  }
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.strongarm.inc b/profiles/commons/modules/contrib/commons_groups/commons_groups.strongarm.inc
index eac0507..999b285 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.strongarm.inc
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.strongarm.inc
@@ -125,6 +125,15 @@ function commons_groups_strongarm() {
   $strongarm = new stdClass();
   $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
   $strongarm->api_version = 1;
+  $strongarm->name = 'og_group_manager_default_rids_node_group';
+  $strongarm->value = array(
+    3 => '3',
+  );
+  $export['og_group_manager_default_rids_node_group'] = $strongarm;
+
+  $strongarm = new stdClass();
+  $strongarm->disabled = FALSE; /* Edit this to true to make a default strongarm disabled initially */
+  $strongarm->api_version = 1;
   $strongarm->name = 'pathauto_node_pattern';
   $strongarm->value = 'groups/[node:og-group-ref:0:title]/[node:title]';
   $export['pathauto_node_pattern'] = $strongarm;
diff --git a/profiles/commons/modules/contrib/commons_groups/commons_groups.views_default.inc b/profiles/commons/modules/contrib/commons_groups/commons_groups.views_default.inc
index 936ca79..f8d7129 100644
--- a/profiles/commons/modules/contrib/commons_groups/commons_groups.views_default.inc
+++ b/profiles/commons/modules/contrib/commons_groups/commons_groups.views_default.inc
@@ -119,7 +119,7 @@ function commons_groups_views_default_views() {
 
   /* Display: Master */
   $handler = $view->new_display('default', 'Master', 'default');
-  $handler->display->display_options['title'] = 'Contributors';
+  $handler->display->display_options['title'] = 'Group contributors';
   $handler->display->display_options['use_more'] = TRUE;
   $handler->display->display_options['use_more_always'] = FALSE;
   $handler->display->display_options['access']['type'] = 'perm';
@@ -172,6 +172,8 @@ function commons_groups_views_default_views() {
 
   /* Display: group teaser */
   $handler = $view->new_display('panel_pane', 'group teaser', 'panel_pane_1');
+  $handler->display->display_options['defaults']['title'] = FALSE;
+  $handler->display->display_options['title'] = 'Recent contributors';
   $handler->display->display_options['defaults']['hide_admin_links'] = FALSE;
   $handler->display->display_options['defaults']['pager'] = FALSE;
   $handler->display->display_options['pager']['type'] = 'some';
@@ -257,7 +259,7 @@ function commons_groups_views_default_views() {
   $handler->display->display_options['fields']['og_roles']['label'] = '';
   $handler->display->display_options['fields']['og_roles']['exclude'] = TRUE;
   $handler->display->display_options['fields']['og_roles']['element_label_colon'] = FALSE;
-  $handler->display->display_options['fields']['og_roles']['type'] = 'ul';
+  $handler->display->display_options['fields']['og_roles']['empty'] = 'Contributors';
   $handler->display->display_options['argument_input'] = array(
     'gid' => array(
       'type' => 'context',
@@ -884,7 +886,7 @@ function commons_groups_views_default_views() {
   /* Display: Master */
   $handler = $view->new_display('default', 'Master', 'default');
   $handler->display->display_options['title'] = 'Groups';
-  $handler->display->display_options['use_ajax'] = TRUE;
+  $handler->display->display_options['use_ajax'] = FALSE;
   $handler->display->display_options['use_more_always'] = FALSE;
   $handler->display->display_options['access']['type'] = 'perm';
   $handler->display->display_options['cache']['type'] = 'none';
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.features.field_instance.inc b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.features.field_instance.inc
index 0539b58..6ff12af 100644
--- a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.features.field_instance.inc
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.features.field_instance.inc
@@ -11,12 +11,11 @@ function commons_group_privacy_field_default_field_instances() {
   $field_instances = array();
    // Get a list of content types that should have the og_groups_ref field added.
   // Modules can alter this list by implementing hook_strongarm_alter().
-  $commons_groups_entity_types = variable_get('commons_groups_entity_types', array());
-  if (!empty($commons_groups_entity_types['node'])) {
-    $field_instances = array();
-    foreach($commons_groups_entity_types['node'] as $type => $enabled) {
-      if ($enabled) {
-        commons_group_privacy_field_definition($field_instances, $type);
+  $commons_groups_entity_types = commons_groups_get_group_content_entity_types();
+  if (!empty($commons_groups_entity_types)) {
+    foreach ($commons_groups_entity_types as $entity_type => $bundles) {
+      foreach(array_keys($bundles) as $bundle) {
+        commons_group_privacy_field_definition($field_instances, $entity_type, $bundle);
       }
     }
   }
@@ -133,10 +132,10 @@ function commons_group_privacy_field_default_field_instances() {
   return $field_instances;
 }
 
-function commons_group_privacy_field_definition(&$field_instances, $type) {
+function commons_group_privacy_field_definition(&$field_instances, $entity_type, $bundle) {
   // Exported field_instance: 'node-TYPE-group_content_access'
-  $field_instances["node-$type-group_content_access"] = array(
-    'bundle' => $type,
+  $field_instances["$entity_type-$bundle-group_content_access"] = array(
+    'bundle' => $bundle,
     'default_value' => array(
       0 => array(
         'value' => 0,
@@ -159,7 +158,7 @@ function commons_group_privacy_field_definition(&$field_instances, $type) {
         'weight' => 0,
       ),
     ),
-    'entity_type' => 'node',
+    'entity_type' => $entity_type,
     'field_name' => 'group_content_access',
     'label' => 'Group content visibility',
     'required' => TRUE,
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.info b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.info
index d5c6899..a912ec2 100644
--- a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.info
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.info
@@ -12,9 +12,9 @@ features[field_base][] = og_roles_permissions
 features[field_instance][] = node-group-group_access
 features[field_instance][] = node-group-og_roles_permissions
 features[field_instance][] = node-post-group_content_access
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_groups"
-datestamp = "1361820323"
+datestamp = "1364416518"
 
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.install b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.install
new file mode 100644
index 0000000..104f051
--- /dev/null
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.install
@@ -0,0 +1,10 @@
+<?php
+
+/**
+* Revert field instances for group content privacy,
+* which where not added per http://drupal.org/node/1936446.
+*/
+function commons_group_privacy_update_3100() {
+  features_revert(array('commons_group_privacy' => array('field_instance')));
+  return array();
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.module b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.module
index 18d699c..1a431fc 100644
--- a/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.module
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_group_privacy/commons_group_privacy.module
@@ -33,3 +33,25 @@ function commons_group_privacy_features_pipe_alter(&$pipe, $data, $export) {
   }
 }
 
+/**
+* Implements hook_system_info_alter().
+*/
+function commons_group_privacy_system_info_alter(&$info, $file, $type) {
+  // Commons Groups dynamically adds the og_group_ref field to
+  // content types that request it by altering the
+  // commons_groups_entity_types variable.
+  // We must add a corresponding line for each field instance
+  // to commons_groups.info so that Features is aware of the instance
+  // and can sucessfully revert the field_instance component back
+  // to its default state.
+  if ($file->name == 'commons_group_privacy') {
+    $group_content_entity_types = commons_groups_get_group_content_entity_types();
+    if (!empty($group_content_entity_types)) {
+      foreach ($group_content_entity_types as $entity_type => $bundles) {
+        foreach(array_keys($bundles) as $bundle) {
+          $info['features']['field_instance'][] = "$entity_type-$bundle-group_content_access";
+        }
+      }
+    }
+  }
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_directory/commons_groups_directory.info b/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
index 0490af5..bbe3c41 100644
--- a/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
@@ -18,9 +18,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:1
 features[page_manager_pages][] = groups_directory
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_groups"
-datestamp = "1361820323"
+datestamp = "1364416518"
 
diff --git a/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_pages/commons_groups_pages.info b/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
index 5bcd5b1..393e80b 100644
--- a/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
+++ b/profiles/commons/modules/contrib/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
@@ -19,9 +19,9 @@ features[panelizer_defaults][] = node:group:default
 features[panelizer_defaults][] = node:group:default:teaser
 features[variable][] = panelizer_defaults_node_group
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_groups"
-datestamp = "1361820323"
+datestamp = "1364416518"
 
diff --git a/profiles/commons/modules/contrib/commons_misc/commons_misc.info b/profiles/commons/modules/contrib/commons_misc/commons_misc.info
index bd37ef2..cfd7da1 100644
--- a/profiles/commons/modules/contrib/commons_misc/commons_misc.info
+++ b/profiles/commons/modules/contrib/commons_misc/commons_misc.info
@@ -26,9 +26,9 @@ features[variable][] = theme_commons_origins_settings
 features[variable][] = user_register
 features_exclude[dependencies][page_manager] = page_manager
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_misc"
-datestamp = "1361820328"
+datestamp = "1364416521"
 
diff --git a/profiles/commons/modules/contrib/commons_misc/commons_misc.module b/profiles/commons/modules/contrib/commons_misc/commons_misc.module
index 883a318..32fbc63 100644
--- a/profiles/commons/modules/contrib/commons_misc/commons_misc.module
+++ b/profiles/commons/modules/contrib/commons_misc/commons_misc.module
@@ -30,11 +30,18 @@ function commons_misc_form_post_node_form_alter(&$form, &$form_state, $form_id)
  */
 function commons_misc_form_system_theme_settings_alter(&$form, &$form_state, $form_id) {
   $themes_list = list_themes(TRUE);
+
+  // Filter down to just the commons_origins theme:
+  // If commons_origins theme exists
+  // If commons_origins is enabled
+  // If we're not on the general settings tab -- because args aren't set yet
+  // And we're on the commons_origin settings page, then show the color palette
   if (isset($themes_list['commons_origins'])
     && $themes_list['commons_origins']->status == 1
+    && !empty($form_state['build_info']['args'])
     && $form_state['build_info']['args'][0] == 'commons_origins') {
     // Add the color palette selection form to the apperance settings form.
     require_once(drupal_get_path('theme', 'commons_origins') . '/commons_origins.palettes.inc');
     commons_origins_palettes_form($form);
   }
-}
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_profile_social/commons_profile_social.info b/profiles/commons/modules/contrib/commons_profile_social/commons_profile_social.info
index f6eaad3..2c12e47 100644
--- a/profiles/commons/modules/contrib/commons_profile_social/commons_profile_social.info
+++ b/profiles/commons/modules/contrib/commons_profile_social/commons_profile_social.info
@@ -2,7 +2,6 @@ name = Commons Profile (Social fields)
 description = Provides a set of link fields to the user's profile for the user's Facebook, Linkedin and Twitter accounts.
 core = 7.x
 package = Commons - Building blocks
-version = 7.x-3.0-alpha1
 project = commons_profile_social
 dependencies[] = features
 dependencies[] = field_sql_storage
@@ -14,10 +13,9 @@ features[field_base][] = field_twitter_url
 features[field_instance][] = user-user-field_facebook_url
 features[field_instance][] = user-user-field_linkedin_url
 features[field_instance][] = user-user-field_twitter_url
-
-; Information added by drupal.org packaging script on 2013-02-02
+; Information added by drupal.org packaging script on 2013-02-26
 version = "7.x-3.x-dev"
 core = "7.x"
 project = "commons_profile_social"
-datestamp = "1359766074"
+datestamp = "1361839475"
 
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.css b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.css
index b488fc1..e16520b 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.css
+++ b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.css
@@ -1,49 +1,131 @@
 .rate-widget-commons_thumbs_up_down {
-  width: 68px;
-  height: 75px;
+  width: 4.5em;
+  margin: 1.7em 0;
+}
+
+.rate-info {
   position: relative;
+  width: 100%;
+  height: 3.5em;
+  -webkit-box-sizing: border-box;
+  -moz-box-sizing: border-box;
+  box-sizing: border-box;
+  margin-bottom: .4em;
+  padding: .1em .4em;
+  border: 1px solid #ccc;
+  -webkit-border-radius: 0.3em;
+  -moz-border-radius: 0.3em;
+  -ms-border-radius: 0.3em;
+  -o-border-radius: 0.3em;
+  border-radius: 0.3em;
+  font-size: .8em;
+  line-height: 1.2em;
+  text-align: center;
+  background: #fff;
+  color: #333;
+  z-index: 0;
 }
-.rate-widget-commons_thumbs_up_down ul {
-  margin: 0;
+.rate-info:before, .rate-info:after {
+  content: "";
+  display: block;
+  width: 0;
+  height: 0;
+  overflow: hidden;
   position: absolute;
-  bottom: 0;
-  width: 68px;
+  bottom: -0.85em;
+  left: 50%;
+  margin-left: -0.5em;
+  border: 0.5em solid transparent;
 }
-.rate-widget-commons_thumbs_up_down ul li {
-  margin: 0;
-  list-style-type: none;
+.rate-info:before {
+  border-top-color: #ccc;
+  margin-bottom: -1px;
+}
+.rate-info:after {
+  border-top-color: #fff;
 }
-.rate-widget-commons_thumbs_up_down ul li .rate-button {
+
+.rate-info-value {
   display: block;
-  width: 32px;
-  height: 30px;
-  background-image: url('images/updown.png?1361226127');
-  text-indent: -9999px;
+  font-size: 1.8em;
+  font-weight: bold;
+  line-height: 1em;
 }
-.rate-widget-commons_thumbs_up_down ul li .rate-number-up-down-btn-up {
-  background-position: left top;
-  float: left;
+
+.rate-info-label {
+  line-height: 1em;
+  color: #888;
 }
-.rate-widget-commons_thumbs_up_down ul li .rate-number-up-down-btn-down {
-  background-position: right top;
-  float: right;
+
+.commons-q-a-rate-buttons {
+  margin: 0;
+  line-height: 100%;
 }
-.rate-widget-commons_thumbs_up_down ul li span {
-  filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=60);
-  opacity: 0.6;
+
+.commons-q-a-rate-trigger {
+  margin: 0;
+  width: 50%;
+  height: 2em;
+  -webkit-box-sizing: border-box;
+  -moz-box-sizing: border-box;
+  box-sizing: border-box;
+  line-height: 2em;
 }
-.rate-widget-commons_thumbs_up_down .rate-info {
-  position: absolute;
-  top: 0;
-  width: 52px;
-  height: 36px;
-  padding: 4px 8px;
-  background: url('images/bkg_updown.png?1361226127');
-  text-align: center;
+.commons-q-a-rate-trigger .rate-button {
+  display: block;
+  height: 100%;
+  overflow: hidden;
+  -webkit-box-sizing: border-box;
+  -moz-box-sizing: border-box;
+  box-sizing: border-box;
+  border: 1px solid #ccc;
+  -webkit-border-radius: 0.3em;
+  -moz-border-radius: 0.3em;
+  -ms-border-radius: 0.3em;
+  -o-border-radius: 0.3em;
+  border-radius: 0.3em;
+  color: transparent;
+  background: #fefefe;
+  background: -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #fefefe), color-stop(100%, #e8e8e8));
+  background: -webkit-linear-gradient(top, #fefefe, #e8e8e8);
+  background: -moz-linear-gradient(top, #fefefe, #e8e8e8);
+  background: -o-linear-gradient(top, #fefefe, #e8e8e8);
+  background: linear-gradient(top, #fefefe, #e8e8e8);
 }
-.rate-widget-commons_thumbs_up_down .rate-info-value {
+.commons-q-a-rate-trigger .rate-button:before {
   display: block;
-  font-size: 18px;
+  margin: 0 auto;
+  text-align: center;
+  font-size: 2.4em;
+  color: #333;
   font-weight: bold;
-  line-height: 1em;
+  font-family: monospace;
+}
+.commons-q-a-rate-trigger .rate-button:hover {
+  text-decoration: none;
+}
+.commons-q-a-rate-trigger .rate-voted {
+  background: #f3f3f3;
+  border-color: #f3f3f3;
+  -webkit-box-shadow: inset 0.1em 0.1em 0.1em rgba(0, 0, 0, 0.4);
+  -moz-box-shadow: inset 0.1em 0.1em 0.1em rgba(0, 0, 0, 0.4);
+  box-shadow: inset 0.1em 0.1em 0.1em rgba(0, 0, 0, 0.4);
+}
+
+.commons-q-a-rate-up {
+  float: left;
+  padding-right: .2em;
+}
+
+.commons-q-a-rate-down {
+  float: right;
+  padding-left: .2em;
+}
+
+.rate-number-up-down-btn-up:before {
+  content: "+";
+}
+
+.rate-number-up-down-btn-down:before {
+  content: "-";
 }
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.scss b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.scss
index a2afc60..723c676 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.scss
+++ b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.scss
@@ -1,51 +1,127 @@
 @import "compass";
 
+$arrow-width: 1em;
+
 .rate-widget-commons_thumbs_up_down {
-  width: 68px;
-  height: 75px;
+  width: 4.5em;
+  margin: 1.7em 0;
+}
+
+.rate-info {
   position: relative;
-  ul {
-    margin: 0;
+  width: 100%;
+  height: 3.5em;
+  @include box-sizing(border-box);
+  margin-bottom: .4em;
+  padding: .1em .4em;
+  border: 1px solid #ccc;
+  @include border-radius(.3em);
+  font-size: .8em;
+  line-height: 1.2em;
+  text-align: center;
+  background: #fff;
+  color: #333;
+  z-index: 0;
+
+  &:before,
+  &:after {
+    content: "";
+    display: block;
+    width: 0;
+    height: 0;
+    overflow: hidden;
     position: absolute;
-    bottom: 0;
-    width: 68px;
-    li {
-      margin: 0;
-      list-style-type:none;
-      .rate-button {
-        display:block;
-        width: 32px;
-        height: 30px;
-        background-image: image-url('updown.png');
-        text-indent: -9999px;
-      }
-      .rate-number-up-down-btn-up {
-        background-position: left top;
-        float:left;
-      }
-      .rate-number-up-down-btn-down {
-        background-position: right top;
-        float:right;
-      }
-      span {
-        @include opacity(.6);
-      }
-    }
+    bottom: -($arrow-width - .15);
+    left: 50%;
+    margin-left: -($arrow-width / 2);
+    border: ($arrow-width / 2) solid transparent;
   }
-  .rate-info {
-    position: absolute;
-    top: 0;
-    width: 52px;
-    height: 36px;
-    padding: 4px 8px;
-    background: image-url('bkg_updown.png');
-    text-align: center;
+
+  &:before {
+    border-top-color: #ccc;
+    margin-bottom: -1px;
   }
 
-  .rate-info-value {
+  &:after {
+    border-top-color: #fff;
+  }
+}
+
+.rate-info-value {
+  display: block;
+  font-size: 1.8em;
+  font-weight: bold;
+  line-height: 1em;
+}
+
+.rate-info-label {
+  line-height: 1em;
+  color: #888;
+}
+
+.commons-q-a-rate-buttons {
+  margin: 0;
+  line-height: 100%;
+}
+
+.commons-q-a-rate-trigger {
+  margin: 0;
+  width: 50%;
+  height: 2em;
+  @include box-sizing(border-box);
+  line-height: 2em;
+
+  .rate-button {
     display: block;
-    font-size: 18px;
-    font-weight: bold;
-    line-height: 1em;
+    height: 100%;
+    overflow: hidden;
+    @include box-sizing(border-box);
+    border: 1px solid #ccc;
+    @include border-radius(.3em);
+    color: transparent;
+    background: #fefefe;
+    @include background(linear-gradient(top, #fefefe, #e8e8e8));
+
+    &:before {
+      display: block;
+      margin: 0 auto;
+      text-align: center;
+      font-size: 2.4em;
+      color: #333;
+      font-weight: bold;
+      font-family: monospace;
+    }
+
+    &:hover {
+      text-decoration: none;
+    }
+  }
+
+  .rate-voted {
+    background: #f3f3f3;
+    border-color: #f3f3f3;
+    @include box-shadow(inset .1em .1em .1em rgba(0, 0, 0, .4));
+  }
+}
+
+.commons-q-a-rate-up {
+  float: left;
+  padding-right: .2em;
+}
+
+.commons-q-a-rate-down {
+  float: right;
+  padding-left: .2em;
+}
+
+.rate-number-up-down-btn-up {
+  &:before {
+    content: "+";
+  }
+}
+
+.rate-number-up-down-btn-down {
+  &:before {
+    content: "-";
   }
 }
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.tpl.php b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.tpl.php
index 430b22d..17cdfa1 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.tpl.php
+++ b/profiles/commons/modules/contrib/commons_q_a/commons-thumbs-up-down.tpl.php
@@ -5,20 +5,21 @@
  */
 ?>
 
-<ul>
-  <li class="thumb-up">
-    <?php print $up_button; ?>
-  </li>
-  <li class="thumb-down">
-    <?php print $down_button; ?>
-  </li>
-</ul>
-<?php
+<div class="commons-q-a-rate-up-down clearfix">
+  <?php
+  print '<div class="rate-info"><span class="rate-info-value">' . $results['rating'] . '</span> <span class="rate-info-label">' . format_plural($results['rating'], 'point', 'points') . '</span></div>';
 
-if ($info) {
-  print '<div class="rate-info"><span class="rate-info-value">' . $score . '</span> <span class="rate-info-label">' . format_plural($score, t('point'), t('points')) . '</span></div>';
-}
+  if ($display_options['description']) {
+    print '<div class="rate-description">' . $display_options['description'] . '</div>';
+  }
+  ?>
 
-if ($display_options['description']) {
-  print '<div class="rate-description">' . $display_options['description'] . '</div>';
-}
+  <div class="commons-q-a-rate-buttons">
+    <div class="commons-q-a-rate-trigger commons-q-a-rate-up">
+      <?php print $up_button; ?>
+    </div>
+    <div class="commons-q-a-rate-trigger commons-q-a-rate-down">
+      <?php print $down_button; ?>
+    </div>
+  </div>
+</div>
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.info b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.info
index cd2a057..02a9dc0 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.info
+++ b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.info
@@ -88,9 +88,9 @@ features_exclude[field_instance][node-question-og_group_ref_other_groups] = node
 features_exclude[field_instance][og_group_ref] = og_group_ref
 features_exclude[field_instance][node-answer-og_group_ref] = node-answer-og_group_ref
 features_exclude[field_instance][node-question-og_group_ref] = node-question-og_group_ref
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_q_a"
-datestamp = "1361820346"
+datestamp = "1364416212"
 
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.install b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.install
index dcc9dcf..7fa319b 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.install
+++ b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.install
@@ -32,4 +32,17 @@ function commons_q_a_update_3102() {
   );
   features_revert($revert);
   return array();
+}
+
+/**
+ * Update the Commons Q&A widget per http://drupal.org/node/1940644.
+ */
+function commons_q_a_update_3103() {
+  // The Commons Q&A widget is defined via a hook_strongarm_alter()
+  // implementation altering rate_widgets variable, defined by commons_like.
+    $revert = array(
+      'commons_like' => array('variable'),
+  );
+  features_revert($revert);
+  return array();
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.module b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.module
index b2573a0..4d75d32 100644
--- a/profiles/commons/modules/contrib/commons_q_a/commons_q_a.module
+++ b/profiles/commons/modules/contrib/commons_q_a/commons_q_a.module
@@ -118,6 +118,18 @@ function commons_q_a_views_pre_render(&$view) {
   }
 }
 
+/*
+ * Implements hook_module_implements_alter().
+ * Set commons_q_a form alter to happen after node so the title doesn't get reset.
+ */
+function commons_q_a_module_implements_alter(&$implementations, $hook) {
+  if ($hook == 'form_alter') {
+    $group = $implementations['commons_q_a'];
+    unset($implementations['commons_q_a']);
+    $implementations['commons_q_a'] = $group;
+  }
+}
+
 /**
 * Implements hook_form_alter().
 */
@@ -128,8 +140,8 @@ function commons_q_a_form_alter(&$form, &$form_state, $form_id) {
     $form['og_group_ref']['#access'] = FALSE;
     $form['actions']['submit']['#submit'][] = 'commons_q_a_answer_submit';
   }
-  if ($form_id == 'question_node_form' && empty($form['node']->nid)) {
-    drupal_set_title(t('Ask a question'));
+  if ($form_id == 'question_node_form' && empty($form['#node']->nid)) {
+    drupal_set_title('Ask a question');
   }
   if ($form_id == 'comment_node_question_form' || $form_id == 'comment_node_answer_form') {
     $form['container'] = array(
@@ -331,7 +343,7 @@ function commons_q_a_rate_widget() {
     'allow_voting_by_author' => 1,
     'noperm_behaviour' => '3',
     'displayed' => '1',
-    'displayed_just_voted' => '2',
+    'displayed_just_voted' => '1',
     'description' => '',
     'description_in_compact' => TRUE,
     'delete_vote_on_second_click' => '1',
diff --git a/profiles/commons/modules/contrib/commons_q_a/config.rb b/profiles/commons/modules/contrib/commons_q_a/config.rb
index 1983ae6..ae8fc12 100644
--- a/profiles/commons/modules/contrib/commons_q_a/config.rb
+++ b/profiles/commons/modules/contrib/commons_q_a/config.rb
@@ -6,20 +6,15 @@ css_dir = "/"
 sass_dir = "/"
 images_dir = "images"
 
-
+# output_style = :expanded or :nested or :compact or :compressed
 output_style = :expanded
-environment = :production
 
-# To enable relative paths to assets via compass helper functions. Uncomment:
 relative_assets = true
 
-# To disable debugging comments that display the original location of your selectors. Uncomment:
-# line_comments = false
-color_output = false
-
+# line_comments and debug_info can be activated by setting the environment
+# flag to "development"
+line_comments = (environment == :development) ? true : false
 
-# If you prefer the indented syntax, you might want to regenerate this
-# project again passing --syntax sass, or you can uncomment this:
-# preferred_syntax = :sass
-# and then run:
-# sass-convert -R --from scss --to sass sass scss && rm -rf sass && mv scss sass
+sass_options = {
+  :debug_info => (environment == :development) ? true : false
+}
diff --git a/profiles/commons/modules/contrib/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info b/profiles/commons/modules/contrib/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
index adf326e..b2c0a2d 100644
--- a/profiles/commons/modules/contrib/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
+++ b/profiles/commons/modules/contrib/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
@@ -13,9 +13,9 @@ features[panelizer_defaults][] = node:question:default
 features[variable][] = panelizer_defaults_node_answer
 features[variable][] = panelizer_defaults_node_question
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_q_a"
-datestamp = "1361820346"
+datestamp = "1364416212"
 
diff --git a/profiles/commons/modules/contrib/commons_search/commons_search.info b/profiles/commons/modules/contrib/commons_search/commons_search.info
index 5856b1a..5d20fda 100644
--- a/profiles/commons/modules/contrib/commons_search/commons_search.info
+++ b/profiles/commons/modules/contrib/commons_search/commons_search.info
@@ -64,9 +64,9 @@ features[variable][] = custom_search_type_selector_all
 features[variable][] = custom_search_type_selector_label
 features[variable][] = custom_search_type_selector_label_visibility
 features[views_view][] = group_search
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_search"
-datestamp = "1361820350"
+datestamp = "1364416524"
 
diff --git a/profiles/commons/modules/contrib/commons_search/commons_search.module b/profiles/commons/modules/contrib/commons_search/commons_search.module
index a957f48..837a8fb 100644
--- a/profiles/commons/modules/contrib/commons_search/commons_search.module
+++ b/profiles/commons/modules/contrib/commons_search/commons_search.module
@@ -97,24 +97,21 @@ function commons_search_search_form_submit($form, &$form_state) {
 /**
  * Implements hook_preprocess_hook().
  */
-function commons_search_preprocess_search_results(&$variables) {
+function commons_search_process_search_results(&$variables) {
   $variables['result_count'] = count($variables['results']);
-  $title = t('Search results');
   if (isset($variables['response'])
     && isset($variables['response']->request)
     && preg_match('/sm_og_group_ref:"node:([0-9]+)"&/', urldecode($variables['response']->request), $match)) {
     $group = node_load($match[1]);
     $title = t('Search within !group', array('!group' => '<em>' . $group->title . '</em>'));
+    $variables['title'] = $title;
   }
-  $variables['search_title'] = $title;
 }
 
 /**
  * Implements hook_theme_registry_alter().
  */
 function commons_search_theme_registry_alter(&$theme_registry) {
-  $theme_registry['search_results']['path'] = drupal_get_path('module', 'commons_search') . '/theme';
-  $theme_registry['search_results']['template'] = 'commons_search__search_results';
   // Remove AT breadcrumb preprocess since it adds raw RDFa data into the title.
   $theme_registry['breadcrumb']['preprocess functions'] = array_flip($theme_registry['breadcrumb']['preprocess functions']);
   unset($theme_registry['breadcrumb']['preprocess functions']['adaptivetheme_preprocess_breadcrumb']);
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.info b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.info
index a61a15f..3fe80c8 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.info
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.info
@@ -25,15 +25,16 @@ features[facetapi][] = search:block:created
 features[facetapi][] = search:block:field_topics
 features[features_api][] = api:1
 features[page_manager_handlers][] = search_search_facetapi_panel_context
+features[page_manager_handlers][] = search_search_facetapi_panel_context_2
 features[variable][] = page_manager_search_disabled_search_facetapi
 features[variable][] = custom_search_other
 features[variable][] = search_active_modules
 features[variable][] = search_default_module
 features_exclude[dependencies][ctools] = ctools
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_search"
-datestamp = "1361820350"
+datestamp = "1364416524"
 
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.install b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.install
index ef19b68..48d0e50 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.install
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.install
@@ -26,3 +26,14 @@ function commons_search_core_enable() {
   variable_set('search_default_module', 'search_facetapi');
   cache_clear_all('*', 'cache_block', TRUE);
 }
+
+/**
+ * Revert the core search page to have a single column variant when no search
+ * has happened and the normal two column variant when a search has happened.
+ */
+function commons_search_core_update_7001() {
+  $revert = array(
+    'commons_search_core' => array('page_manager_handlers'),
+  );
+  features_revert($revert);
+}
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.pages_default.inc b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.pages_default.inc
index 8fbd238..353731e 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.pages_default.inc
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_core/commons_search_core.pages_default.inc
@@ -19,7 +19,7 @@ function commons_search_core_default_page_manager_handlers() {
   $handler->handler = 'panel_context';
   $handler->weight = 0;
   $handler->conf = array(
-    'title' => '',
+    'title' => 'Non-empty keywords, two column',
     'no_blocks' => 0,
     'pipeline' => 'ipe',
     'body_classes_to_remove' => '',
@@ -28,6 +28,20 @@ function commons_search_core_default_page_manager_handlers() {
     'css' => '',
     'contexts' => array(),
     'relationships' => array(),
+    'access' => array(
+      'plugins' => array(
+        0 => array(
+          'name' => 'string_length',
+          'settings' => array(
+            'operator' => '>',
+            'length' => '0',
+          ),
+          'context' => 'argument_string_1',
+          'not' => FALSE,
+        ),
+      ),
+      'logic' => 'and',
+    ),
   );
   $display = new panels_display();
   $display->layout = 'two_33_66';
@@ -215,5 +229,88 @@ function commons_search_core_default_page_manager_handlers() {
   $handler->conf['display'] = $display;
   $export['search_search_facetapi_panel_context'] = $handler;
 
+  $handler = new stdClass();
+  $handler->disabled = FALSE; /* Edit this to true to make a default handler disabled initially */
+  $handler->api_version = 1;
+  $handler->name = 'search_search_facetapi_panel_context_2';
+  $handler->task = 'search';
+  $handler->subtask = 'search_facetapi';
+  $handler->handler = 'panel_context';
+  $handler->weight = 1;
+  $handler->conf = array(
+    'title' => 'Empty keywords, single column',
+    'no_blocks' => 0,
+    'pipeline' => 'ipe',
+    'body_classes_to_remove' => '',
+    'body_classes_to_add' => '',
+    'css_id' => '',
+    'css' => '',
+    'contexts' => array(),
+    'relationships' => array(),
+    'access' => array(
+      'plugins' => array(
+        0 => array(
+          'name' => 'string_length',
+          'settings' => array(
+            'operator' => '=',
+            'length' => '0',
+          ),
+          'context' => 'argument_string_1',
+          'not' => FALSE,
+        ),
+      ),
+      'logic' => 'and',
+    ),
+  );
+  $display = new panels_display();
+  $display->layout = 'one';
+  $display->layout_settings = array();
+  $display->panel_settings = array(
+    'style_settings' => array(
+      'default' => NULL,
+      'two_33_66_top' => NULL,
+      'two_33_66_first' => NULL,
+      'two_33_66_second' => NULL,
+      'two_33_66_bottom' => NULL,
+      'one_main' => NULL,
+    ),
+  );
+  $display->cache = array();
+  $display->title = '';
+  $display->content = array();
+  $display->panels = array();
+    $pane = new stdClass();
+    $pane->pid = 'new-8';
+    $pane->panel = 'one_main';
+    $pane->type = 'search_form';
+    $pane->subtype = 'search_form';
+    $pane->shown = TRUE;
+    $pane->access = array();
+    $pane->configuration = array(
+      'type' => 'search_facetapi',
+      'form' => 'simple',
+      'path_type' => 'default',
+      'path' => '',
+      'override_prompt' => 0,
+      'prompt' => '',
+      'context' => 'argument_string_1',
+      'override_title' => 0,
+      'override_title_text' => '',
+    );
+    $pane->cache = array();
+    $pane->style = array(
+      'settings' => NULL,
+    );
+    $pane->css = array();
+    $pane->extras = array();
+    $pane->position = 0;
+    $pane->locks = array();
+    $display->content['new-8'] = $pane;
+    $display->panels['one_main'][0] = 'new-8';
+  $display->hide_title = PANELS_TITLE_PANE;
+  $display->title_pane = '0';
+  $handler->conf['display'] = $display;
+  $export['search_search_facetapi_panel_context_2'] = $handler;
+
   return $export;
 }
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.apachesolr_search_defaults.inc b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.apachesolr_search_defaults.inc
index d3fe714..1bf367f 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.apachesolr_search_defaults.inc
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.apachesolr_search_defaults.inc
@@ -20,12 +20,15 @@ function commons_search_solr_apachesolr_search_default_searchers() {
   $searcher->page_title = 'Site';
   $searcher->env_id = apachesolr_default_environment();
   $searcher->settings = array(
+    'fq' => array(),
+    'apachesolr_search_custom_enable' => FALSE,
     'apachesolr_search_search_type' => 'custom',
+    'apachesolr_search_search_box' => TRUE,
     'apachesolr_search_per_page' => 10,
-    'apachesolr_search_browse' => 'browse',
+    'apachesolr_search_browse' => 'blocks',
     'apachesolr_search_spellcheck' => TRUE,
+    'apachesolr_search_allow_user_input' => FALSE,
     'apachesolr_search_not_removable' => TRUE,
-    'apachesolr_search_search_box' => TRUE,
   );
   $export['core_search'] = $searcher;
 
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.info b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.info
index 6e76367..72a52cc 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.info
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.info
@@ -28,9 +28,9 @@ features[variable][] = custom_search_other
 features[variable][] = search_active_modules
 features[variable][] = search_default_module
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_search"
-datestamp = "1361820350"
+datestamp = "1364416524"
 
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.install b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.install
index 1f1e7c4..36f29a9 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.install
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.install
@@ -26,3 +26,13 @@ function commons_search_solr_enable() {
   cache_clear_all();
   commons_search_solr_create_facets();
 }
+
+/**
+ * Set default environment to display facet blocks in configured regions.
+ */
+function commons_search_solr_update_7001() {
+  $revert = array(
+    'commons_search_solr' => array('apachesolr_search_page'),
+  );
+  features_revert($revert);
+}
diff --git a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.module b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.module
index 66b6eff..91de0e3 100644
--- a/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.module
+++ b/profiles/commons/modules/contrib/commons_search/modules/commons_search_solr/commons_search_solr.module
@@ -431,3 +431,14 @@ function commons_search_solr_environment_form_submit($form, $form_state) {
     cache_clear_all('*', 'cache_apachesolr', TRUE);
   }
 }
+
+/**
+ * Implements hook_modules_enabled().
+ */
+function commons_search_solr_modules_enabled($modules) {
+  if (in_array('acquia_search', $modules)) {
+    // If Acquia Search is enabled later, we need to force update our facets,
+    // otherwise our Events Solr page has no facets.
+    commons_search_solr_create_facets(ACQUIA_SEARCH_ENVIRONMENT_ID);
+  }
+}
diff --git a/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.info b/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.info
index 9e8b3c0..9b58dce 100644
--- a/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.info
+++ b/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.info
@@ -1,9 +1,9 @@
 core = 7.x
 name = Commons Utility links block
 package = "Commons - Building blocks"
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_utility_links"
-datestamp = "1361820357"
+datestamp = "1364416214"
 
diff --git a/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.module b/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.module
index 9a23b4f..3cff3fe 100644
--- a/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.module
+++ b/profiles/commons/modules/contrib/commons_utility_links/commons_utility_links.module
@@ -31,6 +31,18 @@ function commons_utility_links_block_view() {
       'title' => t('Logout'),
     );
   }
+  else {
+    if (variable_get('user_register', USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL)) {
+      $links['signup'] = array(
+        'href' => 'user/register',
+        'title' => t('Signup'),
+      );
+    }
+    $links['login'] = array(
+      'href' => 'user/login',
+      'title' => t('Login'),
+    );
+  }
   drupal_alter('commons_utility_links', $links);
   $block['content'] = theme('links', array('links' => $links, 'attributes' => array('class' => 'commons-utility-links')));
   return $block;
diff --git a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.info b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.info
index 4d70063..d0c1530 100644
--- a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.info
+++ b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.info
@@ -64,9 +64,9 @@ features[variable][] = show_diff_inline_wiki
 features[variable][] = show_preview_changes_wiki
 features[views_view][] = commons_bw_wikis
 features[views_view][] = commons_wikis_contributor_list
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_wikis"
-datestamp = "1361820359"
+datestamp = "1364416811"
 
diff --git a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.install b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.install
index 1f90514..3d53788 100644
--- a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.install
+++ b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.install
@@ -4,9 +4,20 @@
  * Disable summary on Wiki nodes.
  */
 function commons_wikis_update_7000() {
-    $revert = array(
-      'commons_wikis' => array('field_instance'),
+  $revert = array(
+    'commons_wikis' => array('field_instance'),
   );
   features_revert($revert);
   return array();
-}
\ No newline at end of file
+}
+
+/**
+ * Update Wiki message type to remove error messages.
+ */
+function commons_wikis_update_7001() {
+  $revert = array(
+    'commons_wikis' => array('message_type', 'variable'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.module b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.module
index 447097d..74f8c65 100644
--- a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.module
+++ b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.module
@@ -73,11 +73,12 @@ function commons_wikis_og_user_access_alter(&$temp_perm, $context) {
   // where the group node is public and content is public within the group.
   $commons_groups_entity_types = commons_groups_get_group_content_entity_types();
   $group_content_restricted = (bool) (isset($context['group']->group_content_access[LANGUAGE_NONE][0]['value']) && $context['group']->group_content_access[LANGUAGE_NONE][0]['value'] == 2);
-  // @TODO: Consider using a static here.
-  $user_is_member = (bool)og_is_member('node', $context['group']->nid, 'user', $context['account']);
-  if ($context['string'] == "update any wiki content" && (!$group_content_restricted || $user_is_member)) {
-      $temp_perm["update any wiki content"] = TRUE;
-  }
+  $user_is_member = (bool) og_is_member('node', $context['group']->nid, 'user', $context['account']);
+  if ($context['string'] == "update any wiki content"
+    && user_access('edit any wiki content', $context['account'])
+    && (!$group_content_restricted || $user_is_member)) {
+    $temp_perm["update any wiki content"] = TRUE;
+   }
 }
 
 
diff --git a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.strongarm.inc b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.strongarm.inc
index eead02a..d76fb68 100644
--- a/profiles/commons/modules/contrib/commons_wikis/commons_wikis.strongarm.inc
+++ b/profiles/commons/modules/contrib/commons_wikis/commons_wikis.strongarm.inc
@@ -78,20 +78,7 @@ function commons_wikis_strongarm() {
   $strongarm->api_version = 1;
   $strongarm->name = 'field_bundle_settings_message__commons_wikis_wiki_updated';
   $strongarm->value = array(
-    'view_modes' => array(
-      'message_notify_email_subject' => array(
-        'custom_settings' => TRUE,
-      ),
-      'message_notify_email_body' => array(
-        'custom_settings' => TRUE,
-      ),
-      'full' => array(
-        'custom_settings' => FALSE,
-      ),
-      'token' => array(
-        'custom_settings' => FALSE,
-      ),
-    ),
+    'view_modes' => array(),
     'extra_fields' => array(
       'form' => array(),
       'display' => array(
@@ -104,10 +91,6 @@ function commons_wikis_strongarm() {
             'visible' => FALSE,
             'weight' => 0,
           ),
-          'default' => array(
-            'weight' => '2',
-            'visible' => FALSE,
-          ),
         ),
         'message__message_text__1' => array(
           'message_notify_email_subject' => array(
@@ -118,16 +101,6 @@ function commons_wikis_strongarm() {
             'visible' => TRUE,
             'weight' => 0,
           ),
-          'default' => array(
-            'weight' => '0',
-            'visible' => TRUE,
-          ),
-        ),
-        'message__message_text__2' => array(
-          'default' => array(
-            'weight' => '1',
-            'visible' => TRUE,
-          ),
         ),
       ),
     ),
diff --git a/profiles/commons/modules/contrib/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info b/profiles/commons/modules/contrib/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
index 70ad18c..75ef22a 100644
--- a/profiles/commons/modules/contrib/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
+++ b/profiles/commons/modules/contrib/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
@@ -14,9 +14,9 @@ features[features_api][] = api:1
 features[panelizer_defaults][] = node:wiki:default
 features[variable][] = panelizer_defaults_node_wiki
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_wikis"
-datestamp = "1361820359"
+datestamp = "1364416811"
 
diff --git a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.features.ckeditor_profile.inc b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.features.ckeditor_profile.inc
index ac4c364..3b20ed1 100644
--- a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.features.ckeditor_profile.inc
+++ b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.features.ckeditor_profile.inc
@@ -18,7 +18,7 @@ function commons_wysiwyg_ckeditor_profile_defaults() {
         'uicolor' => 'default',
         'uicolor_user' => 'default',
         'toolbar' => '[
-    [\'Format\',\'Bold\',\'Italic\',\'-\',\'NumberedList\',\'BulletedList\',\'Strike\',\'Blockquote\',\'-\',\'Link\',\'Unlink\',\'Image\']
+    [\'Format\'],[\'Bold\',\'Italic\',\'Strike\'],[\'NumberedList\',\'BulletedList\',\'Indent\',\'Outdent\',\'Blockquote\'],[\'Link\',\'Unlink\',\'Image\']
 ]',
         'expand' => 't',
         'width' => '100%',
diff --git a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.info b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.info
index aa08fac..bb9439c 100644
--- a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.info
+++ b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.info
@@ -14,9 +14,9 @@ features[features_api][] = api:1
 features[filter][] = filtered_html
 features[filter][] = full_html
 features[user_permission][] = use text format filtered_html
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-3.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-3.1"
 core = "7.x"
 project = "commons_wysiwyg"
-datestamp = "1361820361"
+datestamp = "1364416526"
 
diff --git a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.install b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.install
new file mode 100644
index 0000000..e9c5686
--- /dev/null
+++ b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.install
@@ -0,0 +1,13 @@
+<?php
+
+/**
+ * Update CKEditor config to be more friendly on devices with smaller
+ * screen sizes per http://drupal.org/node/1948466.
+ */
+function commons_wysiwyg_update_3100() {
+  $revert = array(
+      'commons_wysiwyg' => array('ckeditor_profile'),
+  );
+  features_revert($revert);
+  return array();
+}
diff --git a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.module b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.module
index 44788b0..98f2347 100644
--- a/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.module
+++ b/profiles/commons/modules/contrib/commons_wysiwyg/commons_wysiwyg.module
@@ -1,5 +1,22 @@
 <?php
 /**
- * @file
- * Drupal needs this blank file.
+ * Implements hook_element_info_alter().
+ * Sets the default format if the user's default format is filtered_html.
  */
+function commons_wysiwyg_element_info_alter(&$type) {
+  $type['text_format']['#pre_render'][] = 'commons_wysiwyg_process_filter_format';
+}
+
+/**
+ * Callback function to process the filter format and remove the fieldset.
+ * More info:  http://drupal.org/node/1949552
+ */
+function commons_wysiwyg_process_filter_format($element) {
+  global $user;
+  $formats = filter_formats($user);
+  if (count($formats) <= 2 && array_key_exists('filtered_html', $formats)) {
+    unset($element['format']);
+    $element['#format'] = 'filtered_html';
+  }
+  return $element;
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/connector/connector.info b/profiles/commons/modules/contrib/connector/connector.info
index f09a896..e085fbc 100644
--- a/profiles/commons/modules/contrib/connector/connector.info
+++ b/profiles/commons/modules/contrib/connector/connector.info
@@ -3,9 +3,9 @@ description = Provides base functionality for one-click login with eg. Facebook
 core = 7.x
 package = "Connector"
 
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-1.0-beta2+0-dev"
+; Information added by drupal.org packaging script on 2013-02-24
+version = "7.x-1.0-beta2"
 core = "7.x"
 project = "connector"
-datestamp = "1361753033"
+datestamp = "1361736072"
 
diff --git a/profiles/commons/modules/contrib/connector/modules/connector_action_default_register_form/connector_action_default_register_form.info b/profiles/commons/modules/contrib/connector/modules/connector_action_default_register_form/connector_action_default_register_form.info
index a585e68..2a75165 100644
--- a/profiles/commons/modules/contrib/connector/modules/connector_action_default_register_form/connector_action_default_register_form.info
+++ b/profiles/commons/modules/contrib/connector/modules/connector_action_default_register_form/connector_action_default_register_form.info
@@ -3,9 +3,9 @@ description = "Adepts the default action for new accounts."
 core = 7.x
 package = "Connector Action"
 dependencies[] = connector
-; Information added by drupal.org packaging script on 2013-02-25
-version = "7.x-1.0-beta2+0-dev"
+; Information added by drupal.org packaging script on 2013-02-24
+version = "7.x-1.0-beta2"
 core = "7.x"
 project = "connector"
-datestamp = "1361753033"
+datestamp = "1361736072"
 
diff --git a/profiles/commons/modules/contrib/custom_search/custom_search.info b/profiles/commons/modules/contrib/custom_search/custom_search.info
index 11dd0f4..be604e7 100644
--- a/profiles/commons/modules/contrib/custom_search/custom_search.info
+++ b/profiles/commons/modules/contrib/custom_search/custom_search.info
@@ -12,9 +12,10 @@ files[] = custom_search.module
 files[] = custom_search.install
 
 configure = admin/config/search/custom_search
-; Information added by drupal.org packaging script on 2013-02-22
-version = "7.x-1.11+8-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-1.11+9-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1361537316"
+datestamp = "1364431825"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
index 94d7c32..e8f4be3 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
@@ -11,9 +11,10 @@ files[] = custom_search_blocks.module
 files[] = custom_search_blocks.install
 
 configure = admin/config/search/custom_search/blocks
-; Information added by drupal.org packaging script on 2013-02-22
-version = "7.x-1.11+8-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-1.11+9-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1361537316"
+datestamp = "1364431825"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
index ef95a50..cac099d 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
@@ -9,9 +9,10 @@ dependencies[] = i18n_string
 files[] = custom_search_i18n.module
 files[] = custom_search_i18n.admin.inc
 files[] = custom_search_i18n.install
-; Information added by drupal.org packaging script on 2013-02-22
-version = "7.x-1.11+8-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-1.11+9-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1361537316"
+datestamp = "1364431825"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
index 26ca28c..ed50288 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
@@ -11,9 +11,10 @@ files[] = custom_search_taxonomy.module
 files[] = custom_search_taxonomy.install
 
 configure = admin/config/search/custom_search/taxonomy
-; Information added by drupal.org packaging script on 2013-02-22
-version = "7.x-1.11+8-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-1.11+9-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1361537316"
+datestamp = "1364431825"
 
diff --git a/profiles/commons/modules/contrib/custom_search/theme/custom_search.pages.inc b/profiles/commons/modules/contrib/custom_search/theme/custom_search.pages.inc
index 5735d74..e0209b5 100644
--- a/profiles/commons/modules/contrib/custom_search/theme/custom_search.pages.inc
+++ b/profiles/commons/modules/contrib/custom_search/theme/custom_search.pages.inc
@@ -41,6 +41,7 @@ function custom_search_preprocess_search_results(&$variables) {
       if (!isset($variables['filter-title'])) $variables['filter-title'] = variable_get('custom_search_filter_label', CUSTOM_SEARCH_FILTER_LABEL_DEFAULT);
       if (count($items) > 2) $variables['filter'] = theme('item_list', array('items' => $items, 'title' => $variables['filter-title']));
     }
+  $variables['theme_hook_suggestions'][] = 'custom_search_results';
   }
 }
 
@@ -61,4 +62,5 @@ function custom_search_preprocess_search_result(&$variables) {
     }
   }
   $variables['info'] = implode(' - ', $infos);
+  $variables['theme_hook_suggestions'][] = 'custom_search_result';
 }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/devel/devel.info b/profiles/commons/modules/contrib/devel/devel.info
index 01a7acb..36cfe7e 100644
--- a/profiles/commons/modules/contrib/devel/devel.info
+++ b/profiles/commons/modules/contrib/devel/devel.info
@@ -7,9 +7,9 @@ tags[] = developer
 files[] = devel.test
 files[] = devel.mail.inc
 
-; Information added by drupal.org packaging script on 2013-02-24
-version = "7.x-1.3+41-dev"
+; Information added by drupal.org packaging script on 2013-03-06
+version = "7.x-1.3+43-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1361668291"
+datestamp = "1362575417"
 
diff --git a/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info b/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
index 91eb503..25a0435 100644
--- a/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
+++ b/profiles/commons/modules/contrib/devel/devel_generate/devel_generate.info
@@ -7,9 +7,9 @@ tags[] = developer
 configure = admin/config/development/generate
 files[] = devel_generate.test
 
-; Information added by drupal.org packaging script on 2013-02-24
-version = "7.x-1.3+41-dev"
+; Information added by drupal.org packaging script on 2013-03-06
+version = "7.x-1.3+43-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1361668291"
+datestamp = "1362575417"
 
diff --git a/profiles/commons/modules/contrib/devel/devel_generate/file.devel_generate.inc b/profiles/commons/modules/contrib/devel/devel_generate/file.devel_generate.inc
index 6577ef9..c4e76ea 100644
--- a/profiles/commons/modules/contrib/devel/devel_generate/file.devel_generate.inc
+++ b/profiles/commons/modules/contrib/devel/devel_generate/file.devel_generate.inc
@@ -18,8 +18,7 @@ function _file_devel_generate($object, $field, $instance, $bundle) {
       $source->uri = $path;
       $source->uid = 1; // TODO: randomize? use case specific.
       $source->filemime = 'text/plain';
-      $path_exploded = explode("//", $path);
-      $source->filename = array_pop($path_exploded);
+      $source->filename = basename($path);
       $destination_dir = $field['settings']['uri_scheme'] . '://' . $instance['settings']['file_directory'];
       file_prepare_directory($destination_dir, FILE_CREATE_DIRECTORY);
       $destination = $destination_dir . '/' . basename($path);
diff --git a/profiles/commons/modules/contrib/devel/devel_generate/image.devel_generate.inc b/profiles/commons/modules/contrib/devel/devel_generate/image.devel_generate.inc
index 772b016..ab6c00e 100644
--- a/profiles/commons/modules/contrib/devel/devel_generate/image.devel_generate.inc
+++ b/profiles/commons/modules/contrib/devel/devel_generate/image.devel_generate.inc
@@ -33,8 +33,7 @@ function _image_devel_generate($object, $field, $instance, $bundle) {
       $source->uri = $path;
       $source->uid = 1; // TODO: randomize? Use case specific.
       $source->filemime = 'image/' . pathinfo($path, PATHINFO_EXTENSION);
-      $filename = explode("//", $path);
-      $source->filename = array_pop($filename);
+      $source->filename = basename($path);
       $destination_dir = $field['settings']['uri_scheme'] . '://' . $instance['settings']['file_directory'];
       file_prepare_directory($destination_dir, FILE_CREATE_DIRECTORY);
       $destination = $destination_dir . '/' . basename($path);
diff --git a/profiles/commons/modules/contrib/devel/devel_krumo_path.js b/profiles/commons/modules/contrib/devel/devel_krumo_path.js
index fa01f77..cb17cff 100644
--- a/profiles/commons/modules/contrib/devel/devel_krumo_path.js
+++ b/profiles/commons/modules/contrib/devel/devel_krumo_path.js
@@ -7,7 +7,7 @@ Drupal.behaviors.devel = {
   attach: function (context, settings) {
 
     // Add hint to footnote
-    $('.krumo-footnote .krumo-call').before('<img style="vertical-align: middle;" title="Click to expand. Double-click to show path." src="' + Drupal.settings.basePath + 'misc/help.png"/>');
+    $('.krumo-footnote .krumo-call').once().before('<img style="vertical-align: middle;" title="Click to expand. Double-click to show path." src="' + Drupal.settings.basePath + 'misc/help.png"/>');
 
     var krumo_name = [];
     var krumo_type = [];
diff --git a/profiles/commons/modules/contrib/devel/devel_node_access.info b/profiles/commons/modules/contrib/devel/devel_node_access.info
index a94b6e8..c3e94c4 100644
--- a/profiles/commons/modules/contrib/devel/devel_node_access.info
+++ b/profiles/commons/modules/contrib/devel/devel_node_access.info
@@ -6,9 +6,9 @@ core = 7.x
 configure = admin/config/development/devel
 tags[] = developer
 
-; Information added by drupal.org packaging script on 2013-02-24
-version = "7.x-1.3+41-dev"
+; Information added by drupal.org packaging script on 2013-03-06
+version = "7.x-1.3+43-dev"
 core = "7.x"
 project = "devel"
-datestamp = "1361668291"
+datestamp = "1362575417"
 
diff --git a/profiles/commons/modules/contrib/entity/PATCHES.txt b/profiles/commons/modules/contrib/entity/PATCHES.txt
new file mode 100644
index 0000000..bf42cb1
--- /dev/null
+++ b/profiles/commons/modules/contrib/entity/PATCHES.txt
@@ -0,0 +1,4 @@
+The following patches have been applied to this project:
+- http://drupal.org/files/entity-translatable_fields_not_overriding_und_with_empty_values.patch
+
+This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/entity/modules/callbacks.inc b/profiles/commons/modules/contrib/entity/modules/callbacks.inc
index dca9e1d..654c067 100644
--- a/profiles/commons/modules/contrib/entity/modules/callbacks.inc
+++ b/profiles/commons/modules/contrib/entity/modules/callbacks.inc
@@ -519,6 +519,12 @@ function entity_metadata_field_get_language($entity_type, $entity, $field, $lang
 
   // Determine the right language to use.
   if ($default_langcode != LANGUAGE_NONE && field_is_translatable($entity_type, $field)) {
+    // If the field has a value under LANGUAGE_NONE and doesn't have a value
+    // under the default language, don't force the default language.
+    if (empty($entity->{$field['field_name']}[$default_langcode]) && !empty($entity->{$field['field_name']}[LANGUAGE_NONE])) {
+      return LANGUAGE_NONE;
+    }
+
     $langcode = ($langcode != LANGUAGE_NONE) ? field_valid_language($langcode, $default_langcode) : $default_langcode;
     if (!isset($entity->{$field['field_name']}[$langcode]) && $fallback) {
       $langcode = $default_langcode;
diff --git a/profiles/commons/modules/contrib/entityreference/entityreference.info b/profiles/commons/modules/contrib/entityreference/entityreference.info
index d0b109a..6db20d0 100644
--- a/profiles/commons/modules/contrib/entityreference/entityreference.info
+++ b/profiles/commons/modules/contrib/entityreference/entityreference.info
@@ -23,9 +23,10 @@ files[] = tests/entityreference.taxonomy.test
 files[] = tests/entityreference.admin.test
 files[] = tests/entityreference.feeds.test
 
-; Information added by drupal.org packaging script on 2013-02-01
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+4-dev"
 core = "7.x"
 project = "entityreference"
-datestamp = "1359680274"
+datestamp = "1364431824"
 
diff --git a/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info b/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
index 4f4422e..1754921 100644
--- a/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
+++ b/profiles/commons/modules/contrib/entityreference/examples/entityreference_behavior_example/entityreference_behavior_example.info
@@ -4,9 +4,10 @@ core = 7.x
 package = Fields
 dependencies[] = entityreference
 
-; Information added by drupal.org packaging script on 2013-02-01
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+4-dev"
 core = "7.x"
 project = "entityreference"
-datestamp = "1359680274"
+datestamp = "1364431824"
 
diff --git a/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info b/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
index efbbbda..79f8b0d 100644
--- a/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
+++ b/profiles/commons/modules/contrib/entityreference/tests/modules/entityreference_feeds_test/entityreference_feeds_test.info
@@ -8,9 +8,10 @@ dependencies[] = feeds
 dependencies[] = feeds_ui
 dependencies[] = entityreference
 
-; Information added by drupal.org packaging script on 2013-02-01
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+4-dev"
 core = "7.x"
 project = "entityreference"
-datestamp = "1359680274"
+datestamp = "1364431824"
 
diff --git a/profiles/commons/modules/contrib/features/features.info b/profiles/commons/modules/contrib/features/features.info
index 915a612..42d9aaa 100644
--- a/profiles/commons/modules/contrib/features/features.info
+++ b/profiles/commons/modules/contrib/features/features.info
@@ -4,9 +4,10 @@ core = 7.x
 package = "Features"
 files[] = tests/features.test
 
-; Information added by drupal.org packaging script on 2012-12-08
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.0-beta1+5-dev"
 core = "7.x"
 project = "features"
-datestamp = "1354928180"
+datestamp = "1364431824"
 
diff --git a/profiles/commons/modules/contrib/features/tests/features_test.info b/profiles/commons/modules/contrib/features/tests/features_test.info
index 53be60f..dbd229e 100644
--- a/profiles/commons/modules/contrib/features/tests/features_test.info
+++ b/profiles/commons/modules/contrib/features/tests/features_test.info
@@ -20,9 +20,10 @@ features[user_permission][] = create features_test content
 features[views_view][] = features_test
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2012-12-08
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.0-beta1+5-dev"
 core = "7.x"
 project = "features"
-datestamp = "1354928180"
+datestamp = "1364431824"
 
diff --git a/profiles/commons/modules/contrib/flag_abuse/flag_abuse.info b/profiles/commons/modules/contrib/flag_abuse/flag_abuse.info
index ffcd77b..8ed8f97 100644
--- a/profiles/commons/modules/contrib/flag_abuse/flag_abuse.info
+++ b/profiles/commons/modules/contrib/flag_abuse/flag_abuse.info
@@ -5,9 +5,9 @@ dependencies[] = flag
 dependencies[] = views
 core = 7.x
 
-; Information added by drupal.org packaging script on 2012-11-09
-version = "7.x-2.0-alpha1+0-dev"
+; Information added by drupal.org packaging script on 2012-11-08
+version = "7.x-2.0-alpha1"
 core = "7.x"
 project = "flag_abuse"
-datestamp = "1352422998"
+datestamp = "1352408207"
 
diff --git a/profiles/commons/modules/contrib/http_client/http_client.info b/profiles/commons/modules/contrib/http_client/http_client.info
index 7736ef2..84a8c56 100644
--- a/profiles/commons/modules/contrib/http_client/http_client.info
+++ b/profiles/commons/modules/contrib/http_client/http_client.info
@@ -8,9 +8,9 @@ files[] = includes/HttpClientCurlDelegate.inc
 package = Services - clients
 core = 7.x
 
-; Information added by drupal.org packaging script on 2012-08-23
-version = "7.x-2.4+0-dev"
+; Information added by drupal.org packaging script on 2012-08-22
+version = "7.x-2.4"
 core = "7.x"
 project = "http_client"
-datestamp = "1345681779"
+datestamp = "1345646840"
 
diff --git a/profiles/commons/modules/contrib/http_client/http_client_oauth.info b/profiles/commons/modules/contrib/http_client/http_client_oauth.info
index 5a0c019..90a30b5 100644
--- a/profiles/commons/modules/contrib/http_client/http_client_oauth.info
+++ b/profiles/commons/modules/contrib/http_client/http_client_oauth.info
@@ -8,9 +8,9 @@ files[] = includes/HttpClientOAuth.inc
 package = Services - clients
 core = 7.x
 
-; Information added by drupal.org packaging script on 2012-08-23
-version = "7.x-2.4+0-dev"
+; Information added by drupal.org packaging script on 2012-08-22
+version = "7.x-2.4"
 core = "7.x"
 project = "http_client"
-datestamp = "1345681779"
+datestamp = "1345646840"
 
diff --git a/profiles/commons/modules/contrib/libraries/CHANGELOG.txt b/profiles/commons/modules/contrib/libraries/CHANGELOG.txt
index 889664a..4738559 100644
--- a/profiles/commons/modules/contrib/libraries/CHANGELOG.txt
+++ b/profiles/commons/modules/contrib/libraries/CHANGELOG.txt
@@ -1,4 +1,11 @@
 
+Libraries 7.x-2.1, 2013-03-09
+-----------------------------
+#1937446 by Pol, tstoeckler: Add a 'pre-dependencies-load' callback group.
+#1775668 by tstoeckler: Fix bogus assertion message in assertLibraryFiles().
+#1773640 by tstoeckler: Use drupal_get_path() to find the profile directory.
+#1565426 by tstoeckler: Invoke hook_libraries_info() in enabled themes.
+
 Libraries 7.x-2.0, 2012-07-29
 -----------------------------
 #1606018 by chemical: Tests fail if the module is downloaded from Drupal.org.
diff --git a/profiles/commons/modules/contrib/libraries/libraries.api.php b/profiles/commons/modules/contrib/libraries/libraries.api.php
index ac09743..9ae1b32 100644
--- a/profiles/commons/modules/contrib/libraries/libraries.api.php
+++ b/profiles/commons/modules/contrib/libraries/libraries.api.php
@@ -162,10 +162,13 @@
  *         variant, a boolean indicating whether the variant is installed or
  *         not.
  *       Note that in this group the 'versions' property is no longer available.
- *     - pre-load: Callbacks registered in this group are applied directly
- *       before this library is loaded. At this point the library contains
- *       variant-specific information, if specified. Note that in this group the
- *       'variants' property is no longer available.
+ *     - pre-dependencies-load: Callbacks registered in this group are applied
+ *       directly before the library's dependencies are loaded. At this point
+ *       the library contains variant-specific information, if specified. Note
+ *       that in this group the 'variants' property is no longer available.
+ *     - pre-load: Callbacks registered in this group are applied directly after
+ *       the library's dependencies are loaded and before the library itself is
+ *       loaded.
  *     - post-load: Callbacks registered in this group are applied directly
  *       after this library is loaded. At this point, the library contains a
  *       'loaded' key, which contains the number of files that were loaded.
@@ -295,6 +298,10 @@ function hook_libraries_info() {
       'post-detect' => array(
         'mymodule_example_libraries_postdetect_callback',
       ),
+      // Called before the library's dependencies are loaded.
+      'pre-dependencie-load' => array(
+        'mymodule_example_libraries_pre_dependencies_load_callback',
+      ),
       // Called before the library is loaded.
       'pre-load' => array(
         'mymodule_example_libraries_preload_callback',
diff --git a/profiles/commons/modules/contrib/libraries/libraries.info b/profiles/commons/modules/contrib/libraries/libraries.info
index 4c98f77..d4b2af3 100644
--- a/profiles/commons/modules/contrib/libraries/libraries.info
+++ b/profiles/commons/modules/contrib/libraries/libraries.info
@@ -1,11 +1,11 @@
 name = Libraries
-description = Allows version dependent and shared usage of external libraries.
+description = Allows version-dependent and shared usage of external libraries.
 core = 7.x
 files[] = tests/libraries.test
 
-; Information added by drupal.org packaging script on 2012-07-29
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-09
+version = "7.x-2.1"
 core = "7.x"
 project = "libraries"
-datestamp = "1343561873"
+datestamp = "1362848412"
 
diff --git a/profiles/commons/modules/contrib/libraries/libraries.module b/profiles/commons/modules/contrib/libraries/libraries.module
index 194e287..687fa29 100644
--- a/profiles/commons/modules/contrib/libraries/libraries.module
+++ b/profiles/commons/modules/contrib/libraries/libraries.module
@@ -65,34 +65,27 @@ function libraries_get_path($name, $base_path = FALSE) {
  * @ingroup libraries
  */
 function libraries_get_libraries() {
-  $directory = 'libraries';
   $searchdir = array();
-  $profile = drupal_get_profile();
+  $profile = drupal_get_path('profile', drupal_get_profile());
   $config = conf_path();
 
   // Similar to 'modules' and 'themes' directories in the root directory,
   // certain distributions may want to place libraries into a 'libraries'
   // directory in Drupal's root directory.
-  $searchdir[] = $directory;
-
-  // The 'profiles' directory contains pristine collections of modules and
-  // themes as organized by a distribution.  It is pristine in the same way
-  // that /modules is pristine for core; users should avoid changing anything
-  // there in favor of sites/all or sites/<domain> directories.
-  if (file_exists("profiles/$profile/$directory")) {
-    $searchdir[] = "profiles/$profile/$directory";
-  }
+  $searchdir[] = 'libraries';
+
+  // Similar to 'modules' and 'themes' directories inside an installation
+  // profile, installation profiles may want to place libraries into a
+  // 'libraries' directory.
+  $searchdir[] = "$profile/libraries";
 
-  // Always search sites/all/*.
-  $searchdir[] = 'sites/all/' . $directory;
+  // Always search sites/all/libraries.
+  $searchdir[] = 'sites/all/libraries';
 
   // Also search sites/<domain>/*.
-  if (file_exists("$config/$directory")) {
-    $searchdir[] = "$config/$directory";
-  }
+  $searchdir[] = "$config/libraries";
 
   // Retrieve list of directories.
-  // @todo Core: Allow to scan for directories.
   $directories = array();
   $nomask = array('CVS');
   foreach ($searchdir as $dir) {
@@ -126,13 +119,13 @@ function libraries_get_libraries() {
  *   the files.
  */
 function libraries_scan_info_files() {
-  $profile = drupal_get_profile();
+  $profile = drupal_get_path('profile', drupal_get_profile());
   $config = conf_path();
 
   // Build a list of directories.
   $directories = module_invoke_all('libraries_info_file_paths');
   $directories[] = 'libraries';
-  $directories[] = "profiles/$profile/libraries";
+  $directories[] = "$profile/libraries";
   $directories[] = 'sites/all/libraries';
   $directories[] = "$config/libraries";
 
@@ -347,6 +340,26 @@ function &libraries_info($name = NULL) {
         $libraries[$machine_name] = $properties;
       }
     }
+    // Gather information from hook_libraries_info() in enabled themes.
+    // @see drupal_alter()
+    global $theme, $base_theme_info;
+    if (isset($theme)) {
+      $theme_keys = array();
+      foreach ($base_theme_info as $base) {
+        $theme_keys[] = $base->name;
+      }
+      $theme_keys[] = $theme;
+      foreach ($theme_keys as $theme_key) {
+        $function = $theme_key . '_' . 'libraries_info';
+        if (function_exists($function)) {
+          foreach ($function() as $machine_name => $properties) {
+            $properties['theme'] = $theme_key;
+            $libraries[$machine_name] = $properties;
+          }
+        }
+      }
+    }
+
     // Gather information from .info files.
     // .info files override module definitions.
     foreach (libraries_scan_info_files() as $machine_name => $file) {
@@ -410,6 +423,7 @@ function libraries_info_defaults(&$library, $name) {
     'info' => array(),
     'pre-detect' => array(),
     'post-detect' => array(),
+    'pre-dependencies-load' => array(),
     'pre-load' => array(),
     'post-load' => array(),
   );
@@ -599,6 +613,9 @@ function libraries_load($name, $variant = NULL) {
     // only be one variant of a library within a single request.
     unset($library['variants']);
 
+    // Invoke callbacks in the 'pre-dependencies-load' group.
+    libraries_invoke('pre-dependencies-load', $library);
+
     // If the library (variant) is installed, load it.
     $library['loaded'] = FALSE;
     if ($library['installed']) {
diff --git a/profiles/commons/modules/contrib/libraries/tests/example/example_info_file.libraries.info b/profiles/commons/modules/contrib/libraries/tests/example/example_info_file.libraries.info
index 9840481..7853721 100644
--- a/profiles/commons/modules/contrib/libraries/tests/example/example_info_file.libraries.info
+++ b/profiles/commons/modules/contrib/libraries/tests/example/example_info_file.libraries.info
@@ -3,9 +3,9 @@
 name = Example info file
 
 
-; Information added by drupal.org packaging script on 2012-07-29
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-09
+version = "7.x-2.1"
 core = "7.x"
 project = "libraries"
-datestamp = "1343561873"
+datestamp = "1362848412"
 
diff --git a/profiles/commons/modules/contrib/libraries/tests/libraries.test b/profiles/commons/modules/contrib/libraries/tests/libraries.test
index 6e8da0e..1770162 100644
--- a/profiles/commons/modules/contrib/libraries/tests/libraries.test
+++ b/profiles/commons/modules/contrib/libraries/tests/libraries.test
@@ -320,6 +320,7 @@ class LibrariesTestCase extends DrupalWebTestCase {
               'info callback' => 'not applied',
               'pre-detect callback' => 'not applied',
               'post-detect callback' => 'not applied',
+              'pre-dependencies-load callback' => 'not applied',
               'pre-load callback' => 'not applied',
               'post-load callback' => 'not applied',
             ),
@@ -327,6 +328,7 @@ class LibrariesTestCase extends DrupalWebTestCase {
           'info callback' => 'not applied',
           'pre-detect callback' => 'not applied',
           'post-detect callback' => 'not applied',
+          'pre-dependencies-load callback' => 'not applied',
           'pre-load callback' => 'not applied',
           'post-load callback' => 'not applied',
         ),
@@ -336,6 +338,7 @@ class LibrariesTestCase extends DrupalWebTestCase {
           'info callback' => 'not applied',
           'pre-detect callback' => 'not applied',
           'post-detect callback' => 'not applied',
+          'pre-dependencies-load callback' => 'not applied',
           'pre-load callback' => 'not applied',
           'post-load callback' => 'not applied',
         ),
@@ -344,12 +347,14 @@ class LibrariesTestCase extends DrupalWebTestCase {
         'info' => array('_libraries_test_info_callback'),
         'pre-detect' => array('_libraries_test_pre_detect_callback'),
         'post-detect' => array('_libraries_test_post_detect_callback'),
+        'pre-dependencies-load' => array('_libraries_test_pre_dependencies_load_callback'),
         'pre-load' => array('_libraries_test_pre_load_callback'),
         'post-load' => array('_libraries_test_post_load_callback'),
       ),
       'info callback' => 'not applied',
       'pre-detect callback' => 'not applied',
       'post-detect callback' => 'not applied',
+      'pre-dependencies-load callback' => 'not applied',
       'pre-load callback' => 'not applied',
       'post-load callback' => 'not applied',
       'module' => 'libraries_test',
@@ -387,11 +392,13 @@ class LibrariesTestCase extends DrupalWebTestCase {
     $this->verbose('Actual:<pre>' . var_export($library, TRUE) . '</pre>');
     $this->assertEqual($library, $expected, 'Detect callback was applied correctly.');
 
-    // Test a callback in the 'pre-load' and 'post-load' phases.
+    // Test a callback in the 'pre-dependencies-load', 'pre-load' and
+    // 'post-load' phases.
     // Successfully loaded libraries should only contain information about the
     // already loaded variant.
     unset($expected['variants']);
     $expected['loaded'] = 0;
+    $expected['pre-dependencies-load callback'] = 'applied (top-level)';
     $expected['pre-load callback'] = 'applied (top-level)';
     $expected['post-load callback'] = 'applied (top-level)';
     $library = libraries_load('example_callback');
@@ -520,7 +527,7 @@ class LibrariesTestCase extends DrupalWebTestCase {
           $this->assertRaw($raw, "$label$name.$extension found.");
         }
         else {
-          $this->assertNoRaw($raw, "$label$name.$extension found.");
+          $this->assertNoRaw($raw, "$label$name.$extension not found.");
         }
       }
     }
diff --git a/profiles/commons/modules/contrib/libraries/tests/libraries_test.info b/profiles/commons/modules/contrib/libraries/tests/libraries_test.info
index 7ec45cc..cc17f3a 100644
--- a/profiles/commons/modules/contrib/libraries/tests/libraries_test.info
+++ b/profiles/commons/modules/contrib/libraries/tests/libraries_test.info
@@ -4,9 +4,9 @@ core = 7.x
 dependencies[] = libraries
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2012-07-29
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-09
+version = "7.x-2.1"
 core = "7.x"
 project = "libraries"
-datestamp = "1343561873"
+datestamp = "1362848412"
 
diff --git a/profiles/commons/modules/contrib/libraries/tests/libraries_test.module b/profiles/commons/modules/contrib/libraries/tests/libraries_test.module
index 67ed7f7..faae509 100644
--- a/profiles/commons/modules/contrib/libraries/tests/libraries_test.module
+++ b/profiles/commons/modules/contrib/libraries/tests/libraries_test.module
@@ -245,6 +245,7 @@ function libraries_test_libraries_info() {
             'info callback' => 'not applied',
             'pre-detect callback' => 'not applied',
             'post-detect callback' => 'not applied',
+            'pre-dependencies-load callback' => 'not applied',
             'pre-load callback' => 'not applied',
             'post-load callback' => 'not applied',
           ),
@@ -253,6 +254,7 @@ function libraries_test_libraries_info() {
         'info callback' => 'not applied',
         'pre-detect callback' => 'not applied',
         'post-detect callback' => 'not applied',
+        'pre-dependencies-load callback' => 'not applied',
         'pre-load callback' => 'not applied',
         'post-load callback' => 'not applied',
       ),
@@ -263,6 +265,7 @@ function libraries_test_libraries_info() {
         'info callback' => 'not applied',
         'pre-detect callback' => 'not applied',
         'post-detect callback' => 'not applied',
+        'pre-dependencies-load callback' => 'not applied',
         'pre-load callback' => 'not applied',
         'post-load callback' => 'not applied',
       ),
@@ -271,6 +274,7 @@ function libraries_test_libraries_info() {
       'info' => array('_libraries_test_info_callback'),
       'pre-detect' => array('_libraries_test_pre_detect_callback'),
       'post-detect' => array('_libraries_test_post_detect_callback'),
+      'pre-dependencies-load' => array('_libraries_test_pre_dependencies_load_callback'),
       'pre-load' => array('_libraries_test_pre_load_callback'),
       'post-load' => array('_libraries_test_post_load_callback'),
     ),
@@ -278,6 +282,7 @@ function libraries_test_libraries_info() {
     'info callback' => 'not applied',
     'pre-detect callback' => 'not applied',
     'post-detect callback' => 'not applied',
+    'pre-dependencies-load callback' => 'not applied',
     'pre-load callback' => 'not applied',
     'post-load callback' => 'not applied',
   );
@@ -397,6 +402,18 @@ function _libraries_test_post_detect_callback(&$library, $version, $variant) {
 }
 
 /**
+ * Sets the 'pre-dependencies-load callback' key.
+ *
+ * This function is used as a test callback for the 'pre-dependencies-load'
+ * callback group.
+ *
+ * @see _libraries_test_callback()
+ */
+function _libraries_test_pre_dependencies_load_callback(&$library, $version, $variant) {
+  _libraries_test_callback($library, $version, $variant, 'pre-dependencies-load');
+}
+
+/**
  * Sets the 'pre-load callback' key.
  *
  * This function is used as a test callback for the 'pre-load' callback group.
diff --git a/profiles/commons/modules/contrib/message/message.info b/profiles/commons/modules/contrib/message/message.info
index ea1a343..8fa786b 100644
--- a/profiles/commons/modules/contrib/message/message.info
+++ b/profiles/commons/modules/contrib/message/message.info
@@ -22,9 +22,10 @@ files[] = includes/views/handlers/message_handler_field_message_render.inc
 files[] = includes/views/handlers/message_handler_filter_message_type.inc
 files[] = includes/views/handlers/message_handler_filter_message_type_category.inc
 
-; Information added by drupal.org packaging script on 2013-01-30
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.7+2-dev"
 core = "7.x"
 project = "message"
-datestamp = "1359509464"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message/message_example/message_example.info b/profiles/commons/modules/contrib/message/message_example/message_example.info
index 8415da3..760c183 100644
--- a/profiles/commons/modules/contrib/message/message_example/message_example.info
+++ b/profiles/commons/modules/contrib/message/message_example/message_example.info
@@ -24,9 +24,10 @@ features[message_type][] = "example_user_register"
 features[views_view][] = "message_example"
 stylesheets[all][] = "css/message_example.css"
 
-; Information added by drupal.org packaging script on 2013-01-30
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.7+2-dev"
 core = "7.x"
 project = "message"
-datestamp = "1359509464"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message/message_og_example/message_og_example.info b/profiles/commons/modules/contrib/message/message_og_example/message_og_example.info
index 290d46a..34e26dc 100644
--- a/profiles/commons/modules/contrib/message/message_og_example/message_og_example.info
+++ b/profiles/commons/modules/contrib/message/message_og_example/message_og_example.info
@@ -20,9 +20,10 @@ name = "Message OG example"
 package = "Message"
 php = "5.2.4"
 
-; Information added by drupal.org packaging script on 2013-01-30
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.7+2-dev"
 core = "7.x"
 project = "message"
-datestamp = "1359509464"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_notify/message_notify.info b/profiles/commons/modules/contrib/message_notify/message_notify.info
index 9bcafbf..21d60bb 100644
--- a/profiles/commons/modules/contrib/message_notify/message_notify.info
+++ b/profiles/commons/modules/contrib/message_notify/message_notify.info
@@ -11,9 +11,10 @@ files[] = plugins/notifier/abstract.inc
 
 ; Tests
 files[] = message_notify.test
-; Information added by drupal.org packaging script on 2013-01-18
-version = "7.x-2.3+1-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-2.3+3-dev"
 core = "7.x"
 project = "message_notify"
-datestamp = "1358477834"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_notify/message_notify.module b/profiles/commons/modules/contrib/message_notify/message_notify.module
index 41b04b7..987d5f0 100644
--- a/profiles/commons/modules/contrib/message_notify/message_notify.module
+++ b/profiles/commons/modules/contrib/message_notify/message_notify.module
@@ -70,9 +70,8 @@ function message_notify_plugin_process(&$plugin, $info) {
  * Add a the notifiers view modes.
  */
 function message_notify_entity_info_alter(&$entity_info) {
-  foreach (message_notify_get_notifiers() as $notifier_name => $plugin) {
-    $class = ctools_plugin_load_class('message_notify', 'notifier', $notifier_name, 'class');
-    $view_modes = call_user_func(array($class, 'viewModes'));
+  foreach (message_notify_get_notifiers() as $plugin) {
+    $view_modes = $plugin['view_modes'];
     // Set default values.
     foreach ($view_modes as &$view_mode) {
       $view_mode += array('custom settings' => TRUE);
diff --git a/profiles/commons/modules/contrib/message_notify/message_notify_example/message_notify_example.info b/profiles/commons/modules/contrib/message_notify/message_notify_example/message_notify_example.info
index 05dcef2..9ec83b6 100644
--- a/profiles/commons/modules/contrib/message_notify/message_notify_example/message_notify_example.info
+++ b/profiles/commons/modules/contrib/message_notify/message_notify_example/message_notify_example.info
@@ -16,9 +16,10 @@ features[field][] = "message-comment_insert-field_message_rendered_subject"
 features[message_type][] = "comment_insert"
 features[views_view][] = "message_notify_example"
 
-; Information added by drupal.org packaging script on 2013-01-18
-version = "7.x-2.3+1-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-2.3+3-dev"
 core = "7.x"
 project = "message_notify"
-datestamp = "1358477834"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_notify/plugins/notifier/abstract.inc b/profiles/commons/modules/contrib/message_notify/plugins/notifier/abstract.inc
index 1713ed4..4283e77 100644
--- a/profiles/commons/modules/contrib/message_notify/plugins/notifier/abstract.inc
+++ b/profiles/commons/modules/contrib/message_notify/plugins/notifier/abstract.inc
@@ -21,6 +21,9 @@ interface MessageNotifierInterface {
 
   /**
    * Entry point to send and process a message.
+   *
+   * @return
+   *   TRUE or FALSE based on delivery status.
    */
   public function send();
 
@@ -45,13 +48,6 @@ interface MessageNotifierInterface {
    * Determine if user can access notifier.
    */
   public function access();
-
-  /**
-   * Allow notifier to define its own view modes.
-   *
-   * Those view modes are later going to be rendered and sent.
-   */
-  public static function viewModes();
 }
 
 /**
@@ -77,12 +73,13 @@ abstract class MessageNotifierBase implements MessageNotifierInterface {
   public function send() {
     $message = $this->message;
     $output = array();
-    foreach ($this->viewModes() as $view_mode => $value) {
+    foreach ($this->plugin['view_modes'] as $view_mode => $value) {
       $content = $message->buildContent($view_mode);
       $output[$view_mode] = render($content);
     }
     $result = $this->deliver($output);
     $this->postSend($result, $output);
+    return $result;
   }
 
   public function deliver(array $output = array()) {}
@@ -113,7 +110,7 @@ abstract class MessageNotifierBase implements MessageNotifierInterface {
     if ($options['rendered fields']) {
       // Save the rendered output into matching fields.
       $wrapper = entity_metadata_wrapper('message', $message);
-      foreach ($this->viewModes() as $view_mode => $mode) {
+      foreach ($this->plugin['view_modes'] as $view_mode => $mode) {
         if (empty($options['rendered fields'][$view_mode])) {
           throw new MessageNotifyException(format_string('The rendered view mode @mode cannot be saved to field, as there is not a matching one.', array('@mode' => $mode['label'])));
         }
@@ -143,9 +140,4 @@ abstract class MessageNotifierBase implements MessageNotifierInterface {
   public function access() {
     return TRUE;
   }
-
-  public static function viewModes() {
-    return array();
-  }
-
 }
diff --git a/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/MessageNotifierEmail.class.php b/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/MessageNotifierEmail.class.php
index fc29444..b0e5da4 100644
--- a/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/MessageNotifierEmail.class.php
+++ b/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/MessageNotifierEmail.class.php
@@ -5,16 +5,6 @@
  */
 class MessageNotifierEmail extends MessageNotifierBase {
 
-  /**
-   * Add Message notify view mode.
-   */
-  public static function viewModes() {
-    return array(
-      'message_notify_email_subject' => array('label' => t('Notify - Email subject')),
-      'message_notify_email_body' => array('label' => t('Notify - Email body')),
-    );
-  }
-
   public function deliver(array $output = array()) {
     $plugin = $this->plugin;
     $message = $this->message;
@@ -38,7 +28,8 @@ class MessageNotifierEmail extends MessageNotifierBase {
     // Pass the message entity along to hook_drupal_mail().
     $output['message_entity'] = $message;
 
-    return drupal_mail('message_notify', $message->type, $mail, $lang, $output);
+    $result =  drupal_mail('message_notify', $message->type, $mail, $lang, $output);
+    return $result['result'];
   }
 
 }
diff --git a/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/email.inc b/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/email.inc
index 8ac91eb..f81d499 100644
--- a/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/email.inc
+++ b/profiles/commons/modules/contrib/message_notify/plugins/notifier/email/email.inc
@@ -8,4 +8,10 @@ $plugin = array(
     // Override mail. Don't use the email that is assigned to the user.
     'mail' => FALSE,
   ),
+   // A notifier must define its own view modes.
+   // Those view modes are later going to be rendered and sent.
+  'view_modes' => array(
+    'message_notify_email_subject' => array('label' => t('Notify - Email subject')),
+    'message_notify_email_body' => array('label' => t('Notify - Email body')),
+  ),
 );
diff --git a/profiles/commons/modules/contrib/message_notify/tests/message_notify_test.info b/profiles/commons/modules/contrib/message_notify/tests/message_notify_test.info
index ab5eda9..077eb15 100644
--- a/profiles/commons/modules/contrib/message_notify/tests/message_notify_test.info
+++ b/profiles/commons/modules/contrib/message_notify/tests/message_notify_test.info
@@ -6,9 +6,10 @@ hidden = TRUE
 
 files[] = plugins/notifier/MessageNotifierTest.class.php
 
-; Information added by drupal.org packaging script on 2013-01-18
-version = "7.x-2.3+1-dev"
+
+; Information added by drush on 2013-03-28
+version = "7.x-2.3+3-dev"
 core = "7.x"
 project = "message_notify"
-datestamp = "1358477834"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/MessageNotifierTest.class.php b/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/MessageNotifierTest.class.php
index 3ed700b..1efc3e1 100644
--- a/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/MessageNotifierTest.class.php
+++ b/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/MessageNotifierTest.class.php
@@ -5,16 +5,6 @@
  */
 class MessageNotifierTest extends MessageNotifierBase {
 
-  /**
-   * Add Message notify view mode.
-   */
-  public static function viewModes() {
-    return array(
-      'foo' => array('label' => t('Foo')),
-      'bar' => array('label' => t('Bar')),
-    );
-  }
-
   public function deliver(array $output = array()) {
     $this->message->output = $output;
     // Return TRUE or FALSE as it was set on the Message.
diff --git a/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/test.inc b/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/test.inc
index 0de31d2..454ca25 100644
--- a/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/test.inc
+++ b/profiles/commons/modules/contrib/message_notify/tests/plugins/notifier/test.inc
@@ -4,4 +4,10 @@ $plugin = array(
   'title' => t('Test'),
   'description' => t('Notifier used for testing.'),
   'class' => 'MessageNotifierTest',
+  // A notifier must define its own view modes.
+  // Those view modes are later going to be rendered and sent.
+  'view_modes' => array(
+    'foo' => array('label' => t('Foo')),
+    'bar' => array('label' => t('Bar')),
+  ),
 );
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
index e944180..f298e59 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe.info
@@ -11,9 +11,10 @@ dependencies[] = message_notify
 
 files[] = message_subscribe.test
 
-; Information added by drupal.org packaging script on 2013-02-19
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0-alpha3+3-dev"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1361280744"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
index 47fdeca..f3d8cc1 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_email/message_subscribe_email.info
@@ -8,9 +8,10 @@ dependencies[] = list
 dependencies[] = message_subscribe_ui
 dependencies[] = views
 
-; Information added by drupal.org packaging script on 2013-02-19
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0-alpha3+3-dev"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1361280744"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
index cd7fa32..e2553d8 100644
--- a/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
+++ b/profiles/commons/modules/contrib/message_subscribe/message_subscribe_ui/message_subscribe_ui.info
@@ -14,9 +14,10 @@ features[views_view][] = subscribe_node
 features[views_view][] = subscribe_taxonomy_term
 features[views_view][] = subscribe_user
 
-; Information added by drupal.org packaging script on 2013-02-19
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0-alpha3+3-dev"
 core = "7.x"
 project = "message_subscribe"
-datestamp = "1361280744"
+datestamp = "1364431823"
 
diff --git a/profiles/commons/modules/contrib/metatag/CHANGELOG.txt b/profiles/commons/modules/contrib/metatag/CHANGELOG.txt
index 9618d80..aeba62f 100644
--- a/profiles/commons/modules/contrib/metatag/CHANGELOG.txt
+++ b/profiles/commons/modules/contrib/metatag/CHANGELOG.txt
@@ -1,3 +1,113 @@
+Metatag 7.x-1.0-beta5, 2013-03-23
+---------------------------------
+#1844638 by DamienMcKenna: Updated help messages around update 7004, when ran
+  via Drush it will no longer used Batch API.
+#1844764 by Devin Carlson, DamienMcKenna: Fix arg placeholders in t() calls.
+#1846516 by Staratel: Incorrect arguments for watchdog().
+#1846516 by DamienMcKenna: Further incorrect arguments for watchdog().
+#1844638 by DamienMcKenna: Correctly used drupal_is_cli() instead of just
+  php_sapi_name().
+#1846978 by edulterado: Corrected the theme function name used with the
+  Twitter Cards submodule.
+#1307804 by juampy: Support for Select_or_Other for use with the OpenGraph
+  'type' field.
+#1854522 by DamienMcKenna: Redundant return statements in the MetaTag classes.
+#1852600 by DamienMcKenna: Only use the first page argument in the Views and
+  Panels preprocessors if it is numerical.
+#1850014 by plopesc: Not all contexts that may be shown on the admin page will
+  have a path condition defined.
+#1846080 by DamienMcKenna: Only support entities that have the 'metatags'
+  option specifically enabled.
+#1857116 by DamienMcKenna: Purge {metatag} records for a few known unsupported
+  entities that old versions would have saved.
+#1857116 by DamienMcKenna: Don't purge 'file' {metatag} records until #1857334
+  is decided.
+#1857360 by DamienMcKenna: Purge {metatag} records for nodes, taxonomy terms
+  and users that were purged but where the APIs of older versions failed to
+  remove them.
+#1857116 by DamienMcKenna: Purge {metatag} records for Profile2.
+#1852600 by helmo: Typo in Views integration function.
+#1852022 by DamienMcKenna: Don't export the {metatag_config}.cid field.
+#1862570 by DamienMcKenna: Purge any empty values that may have been added by
+  very early releases.
+#1862570 by DamienMcKenna: Follow-up to correctly handle the serialized empty
+  array.
+#1864340 by cdoyle, DamienMcKenna: Incorrect output for certain Twitter Card
+  tags.
+#1865170 by DamienMcKenna: Fix metatag_requirements() return array when the
+  Page Title module is also installed.
+#1722564 by DamienMcKenna: Provide a hook_requirements() message and README.txt
+  note about a possible conflict with the Exclude Node Title module.
+#1284756 by damiankloip, sylus, alanburke, lancee: Migrate module integration.
+#1865228 by greggles, DamienMcKenna: Added the rel=author link meta tag.
+#1866122 by DamienMcKenna: Added the twitter:site:id and twitter:creator:id
+  meta tags.
+#1866980 by makangus: Corrected metatag_features_revert().
+#1862818 by DYdave, DamienMcKenna: Added documentation for
+  hook_metatag_config_default().
+#1778534 by DamienMcKenna: Added the original-source meta tag.
+#1886170 by DamienMcKenna: Typo in the API docs regarding enabling metatag
+  support in custom entities.
+#1871020 by DamienMcKenna: Compatibility problem with Workbench_Moderation.
+#1773926 by Dave Reid: Fixed token validation fails on config edit if the
+  instance context is not an entity type.
+#1814736 by plach, Dave Reid: metatag_page_build() did not check if the
+  global:frontpage metatag configuration is disabled.
+#1871852: Fixed metatag_update_7005() did not check if the watchdog table
+  exists.
+#1891082 by bago, Dave Reid: Fixed metatag_config_instance_label() failed to
+  recurse properly.
+#1915284: Fixed metatag_html_head_alter() stopped removing duplicate tags too
+  soon. Fixed duplicate canonical links when global redirect is enabled.
+#1845326 by DamienMcKenna, Peacog: Resolved language handling problems to
+  correctly identify the langcode to properly work with or without
+  Entity_Translation.
+#1876042 by DamienMcKenna: Rename variables to use $entity_id instead of $id
+  and $entity_type instead of $type.
+#1859136 by splatio, DamienMcKenna, multpix: Feeds integration - allow meta tag
+  fields to be the target for data imported using the Feeds module.
+#1880302 by olli, DamienMcKenna: Resolve problems with Features integration.
+#1923030 by krlucas, DamienMcKenna: Only run metatag_entity_update() on
+  supported entities.
+#1844638 by DamienMcKenna, mikeytown2: Remove unnecessary duplicate {metatag}
+  records, fix language values for all entities.
+#1935084 by DamienMcKenna: Remove unnecessary items from metatag_hook_info()
+  that was causing problems with PHP 5.4.
+#1791720 by kbasarab: Added the news_keywords meta tag.
+#1934492 by juampy, DamienMcKenna: Added a page for reverting meta tags for
+  specific entity or bundle.
+#1386320: Note a known issue of using custom template files that do not output
+  the $page['content'] variable.
+#1917902 by DamienMcKenna: Ensure strings returned from token replacement of
+  text fields ([node:summary]) is passed through the appropriate text filters.
+#1919070 by DamienMcKenna: Fix any records that may have been corrupted by e.g.
+  #1871020.
+#1861656 by DamienMcKenna, torrance123: Optionally load the global meta tags on
+  all pages, enabled by default.
+#1871798 by mstrelan: Clear the Context plugin cache when metatag_context is
+  enabled so that the new plugin becomes available.
+#1932192 by DamienMcKenna: Only run metatag_entity_view() once per page view.
+#1900434 by Dustin Currie, j0rd, DamienMcKenna: Added several new OpenGraph meta
+  tags, including ones for videos, location and contact information.
+#1883118 by DamienMcKenna: Improve the help message on Metatag:Context's Path
+  field as neither relative nor absolute URLs will work.
+#1945114 by SergO, DamienMcKenna: A query from #1919070 was missing the
+  preproccess wrapper around the table name.
+#1908586 by DamienMcKenna: Added a line to README.txt explaining how to
+  customize the tokens used to generate the meta tags.
+#1350610 by DamienMcKenna: metatag_update_7001 needed to drop the primary key
+  before customizing it.
+#1859136 by DamienMcKenna: Fixed scenarios when updating an entity there are two
+  copies of the data submitted, e.g. Feeds integration.
+#1308790 by DamienMcKenna: Documented that [current-user] tokens should not be
+  used.
+#1318294 by DamienMcKenna: Documented how to use Imagecache Token to resize
+  images that are being used as tokens for meta tags.
+#1871534 by DamienMcKenna: Documented how some browser plugins can make the page
+  title appear to be wrapped with doublequotes though the output doesn't
+  actually show them.
+
+
 Metatag 7.x-1.0-beta4, 2012-11-17
 ---------------------------------
 #1842764 by DamienMcKenna: Work around problems in metatag_entity_load()
diff --git a/profiles/commons/modules/contrib/metatag/README.txt b/profiles/commons/modules/contrib/metatag/README.txt
index 6ff0df6..5e2f5a7 100644
--- a/profiles/commons/modules/contrib/metatag/README.txt
+++ b/profiles/commons/modules/contrib/metatag/README.txt
@@ -10,7 +10,7 @@ results. Additionally, using meta tags can help control the summary content
 that is used within social networks when visitors link to your site,
 particularly the Open Graph submodule for use with Facebook (see below).
 
-This version of the module only works with Drupal 7.x.
+This version of the module only works with Drupal 7.15 and newer.
 
 
 Features
@@ -61,24 +61,85 @@ Configuration
     values that are not overridden per object will automatically update should
     the defaults be updated.
 
+ 4. As the meta tags are output using Tokens, it may be necessary to customize
+    the token display for the site's entities (content types, vocabularies,
+    etc). To do this go to e.g. admin/structure/types/manage/article/display, in
+    the "Custom Display Settings" section ensure that "Tokens" is checked (save
+    the form if necessary), then to customize the tokens go to:
+    admin/structure/types/manage/article/display/token
 
-Known Issues
+
+Fine Tuning
+------------------------------------------------------------------------------
+* By default Metatag will load the global default values for all pages that do
+  not have meta tags assigned via the normal entity display or via Metatag
+  Context. This may be disabled by setting the variable 'metatag_load_all_pages'
+  to FALSE through one of the following methods:
+  * Use Drush to set the value:
+    drush vset metatag_load_all_pages FALSE
+  * Hardcode the value in the site's settings.php file:
+    $conf['metatag_load_all_pages'] = FALSE;
+  To re-enable this option simply set the value to TRUE.
+
+
+Developers
+------------------------------------------------------------------------------
+Full API documentation is available in metatag.api.php.
+
+To enable Metatag support in custom entities, add 'metatag' => TRUE to either
+the entity or bundle definition in hook_entity_info(); see metatag.api.php for
+further details and example code.
+
+
+Troubleshooting / Known Issues
 ------------------------------------------------------------------------------
+* When using custom page template files, e.g. page--front.tpl.php, it is
+  important to ensure that the following code is present in the template file:
+    <?php render($page['content']); ?>
+  or
+    <?php render($page['content']['metatags']); ?>
+  Without one of these being present the meta tags will not be displayed.
 * Versions of Drupal older than v7.17 were missing necessary functionality for
   taxonomy term pages to work correctly.
 * Using Metatag with values assigned for the page title and the Page Title
   module simultaneously can cause conflicts and unexpected results.
+* Using the Exclude Node Title module will cause the [node:title] token to be
+  empty on node pages, so using [current-page:title] will work around the
+  issue. Note: it isn't possible to "fix" this as it's a by-product of what
+  Exclude Node Title does - it removes the node title from display.
+* When customizing the meta tags for user pages, it is strongly recommended to
+  not use the [current-user] tokens, these pertain to the person *viewing* the
+  page and not e.g. the person who authored a page.
+* If images being displayed in image tags need to be resized to fit a specific
+  requirements, use the Imagecache Token module to customize the value.
+* Certain browser plugins, e.g. on Chrome, can cause the page title so be
+  displayed with additional doublequotes, e.g. instead of:
+    <title>The page title | My cool site</title>
+  it will show:
+    <title>"The page title | My cool site"</title>
+  The solution is to remove the browser plugin - the page's actual output is not
+  affected, it is just a problem in the browser.
 
 
 Related modules
 ------------------------------------------------------------------------------
-Some modules are available that extend Nodewords with additional functionality:
+Some modules are available that extend Metatag with additional functionality:
 
 * Domain Meta Tags
   http://drupal.org/project/domain_meta
   Integrates with the Domain Access module, so each site of a multi-domain
   install can separately control their meta tags.
 
+* Select or Other
+  http://drupal.org/project/select_or_other
+  Enhances the user experience of the metatag_opengraph submodule by allowing
+  the creation of custom Open Graph types.
+
+* Imagecache Token
+  http://drupal.org/project/imagecache_token
+  Provide tokens to load fields using an image style preset, for when meta tags
+  need to fix exact requirements.
+
 
 Credits / Contact
 ------------------------------------------------------------------------------
diff --git a/profiles/commons/modules/contrib/metatag/metatag.admin.inc b/profiles/commons/modules/contrib/metatag/metatag.admin.inc
index 17c5911..0b4278a 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.admin.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag.admin.inc
@@ -273,7 +273,14 @@ function metatag_config_edit_form($form, &$form_state, $config) {
   $contexts = explode(':', $config->instance);
   $options['context'] = $contexts[0];
   if ($contexts[0] != 'global') {
-    $options['token types'] = array(token_get_entity_mapping('entity', $contexts[0]));
+    // The context part of the instance may not map to an entity type, so allow
+    // the token_get_entity_mapping() function to fallback to the provided type.
+    if ($token_type = token_get_entity_mapping('entity', $contexts[0], TRUE)) {
+      $options['token types'] = array($token_type);
+    }
+    else {
+      $options['token types'] = array($contexts[0]);
+    }
   }
 
   // Ensure that this configuration is properly compared to its parent 'default'
@@ -385,3 +392,141 @@ function metatag_config_export_form($config) {
   ctools_include('export');
   return drupal_get_form('ctools_export_form', ctools_export_crud_export('metatag_config', $config), t('Export'));
 }
+
+/**
+ * Form constructor to revert nodes to their default metatags.
+ *
+ * @see metatag_bulk_revert_form_submit()
+ * @ingroup forms
+ */
+function metatag_bulk_revert_form() {
+  // Get the list of entity:bundle options
+  $options = array();
+  foreach (entity_get_info() as $entity_type => $entity_info) {
+    foreach (array_keys($entity_info['bundles']) as $bundle) {
+      if (metatag_entity_supports_metatags($entity_type, $bundle)) {
+        $options[$entity_type . ':' . $bundle] =
+          $entity_info['label'] . ': ' . $entity_info['bundles'][$bundle]['label'];
+      }
+    }
+  }
+
+  $form['update'] = array(
+    '#type' => 'checkboxes',
+    '#required' => TRUE,
+    '#title' => t('Select the entities to revert'),
+    '#options' => $options,
+    '#default_value' => array(),
+    '#description' => t('All meta tags will be removed for all content of the selected entities.'),
+  );
+
+  $form['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Revert'),
+  );
+
+  return $form;
+}
+
+/**
+ * Form submit handler for metatag reset bulk revert form.
+ *
+ * @see metatag_batch_revert_form()
+ * @see metatag_bulk_revert_batch_finished()
+ */
+function metatag_bulk_revert_form_submit($form, &$form_state) {
+  $batch = array(
+    'title' => t('Bulk updating metatags'),
+    'operations' => array(),
+    'finished' => 'metatag_bulk_revert_batch_finished',
+    'file' => drupal_get_path('module', 'metatag') . '/metatag.admin.inc',
+  );
+
+  // Set a batch operation per entity:bundle.
+  foreach (array_filter($form_state['values']['update']) as $option) {
+    list($entity_type, $bundle) = explode(':', $option);
+    $batch['operations'][] = array('metatag_bulk_revert_batch_operation', array($entity_type, $bundle));
+  }
+
+  batch_set($batch);
+}
+
+/**
+ * Batch callback: delete custom metatags for selected bundles.
+ */
+function metatag_bulk_revert_batch_operation($entity_type, $bundle, &$context) {
+  if (!isset($context['sandbox']['current'])) {
+    $context['sandbox']['count'] = 0;
+    $context['sandbox']['current'] = 0;
+  }
+
+  // Query the selected entity table.
+  $entity_info = entity_get_info($entity_type);
+  $query = new EntityFieldQuery();
+  $query->entityCondition('entity_type', $entity_type)
+    ->propertyCondition($entity_info['entity keys']['id'], $context['sandbox']['current'], '>')
+    ->propertyOrderBy($entity_info['entity keys']['id']);
+  if ($entity_type != 'user') {
+    /**
+     * Entities which do not define a bundle such as User fail returning no results.
+     * @see http://drupal.org/node/1054168#comment-5266208
+     */
+    $query->entityCondition('bundle', $bundle);
+  }
+  // Get the total amount of entities to process.
+  if (!isset($context['sandbox']['total'])) {
+    $context['sandbox']['total'] = $query->count()->execute();
+    $query->count = FALSE;
+
+    // If there are no bundles to revert, stop immediately.
+    if (!$context['sandbox']['total']) {
+      $context['finished'] = 1;
+      return;
+    }
+  }
+
+  // Process 25 entities per iteration.
+  $query->range(0, 25);
+  $result = $query->execute();
+  $ids = !empty($result[$entity_type]) ? array_keys($result[$entity_type]) : array();
+  foreach ($ids as $id) {
+    $metatags = metatag_metatags_load($entity_type, $id);
+    if (!empty($metatags)) {
+      db_delete('metatag')->condition('entity_type', $entity_type)
+        ->condition('entity_id', $id)
+        ->execute();
+      metatag_metatags_cache_clear($entity_type, $id);
+      $context['results'][] = t('Reverted metatags for @bundle with id @id.', array(
+        '@bundle' => $entity_type . ': ' . $bundle,
+        '@id' => $id,
+      ));
+    }
+  }
+
+  $context['sandbox']['count'] += count($ids);
+  $context['sandbox']['current'] = max($ids);
+
+  if ($context['sandbox']['count'] != $context['sandbox']['total']) {
+    $context['finished'] = $context['sandbox']['count'] / $context['sandbox']['total'];
+  }
+}
+
+/**
+ * Batch finished callback.
+ */
+function metatag_bulk_revert_batch_finished($success, $results, $operations) {
+  if ($success) {
+    if (!count($results)) {
+      drupal_set_message(t('No metatags were reverted.'));
+    }
+    else {
+      $message = theme('item_list', array('items' => $results));
+      drupal_set_message($message);
+    }
+  }
+  else {
+    $error_operation = reset($operations);
+    drupal_set_message(t('An error occurred while processing @operation with arguments : @args',
+      array('@operation' => $error_operation[0], '@args' => print_r($error_operation[0], TRUE))));
+  }
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.api.php b/profiles/commons/modules/contrib/metatag/metatag.api.php
index 217469b..b2d97dd 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.api.php
+++ b/profiles/commons/modules/contrib/metatag/metatag.api.php
@@ -5,10 +5,113 @@
  */
 
 /**
+ * To enable Metatag support in custom entities, add 'metatags' => TRUE to the
+ * entity definition in hook_entity_info(), e.g.:
  * 
+ * /**
+ *  * Implements hook_entity_info().
+ *  *
+ *  * Taken from the Examples module.
+ *  * /
+ * function entity_example_entity_info() {
+ *   $info['entity_example_basic'] = array(
+ *     'label' => t('Example Basic Entity'),
+ *     'controller class' => 'EntityExampleBasicController',
+ *     'base table' => 'entity_example_basic',
+ *     'uri callback' => 'entity_example_basic_uri',
+ *     'fieldable' => TRUE,
+ *     'metatags' => TRUE,
+ *     'entity keys' => array(
+ *       'id' => 'basic_id' , // The 'id' (basic_id here) is the unique id.
+ *       'bundle' => 'bundle_type' // Bundle will be determined by the 'bundle_type' field
+ *     ),
+ *     'bundle keys' => array(
+ *       'bundle' => 'bundle_type',
+ *     ),
+ *     'static cache' => TRUE,
+ *     'bundles' => array(
+ *       'first_example_bundle' => array(
+ *         'label' => 'First example bundle',
+ *         'admin' => array(
+ *           'path' => 'admin/structure/entity_example_basic/manage',
+ *           'access arguments' => array('administer entity_example_basic entities'),
+ *         ),
+ *       ),
+ *     ),
+ *     'view modes' => array(
+ *       'tweaky' => array(
+ *         'label' => t('Tweaky'),
+ *         'custom settings' =>  FALSE,
+ *       ),
+ *     )
+ *   );
+ * 
+ *   return $info;
+ * }
+ *
+ * The definition of each bundle may be handled separately, thus support may be
+ * disabled for the entity as a whole but enabled for individual bundles. This
+ * is handled via the 'metatags' value on the bundle definition, e.g.:
+ *
+ *     'bundles' => array(
+ *       'first_example_bundle' => array(
+ *         'label' => 'First example bundle',
+ *         'metatags' => TRUE,
+ *         'admin' => array(
+ *           'path' => 'admin/structure/entity_example_basic/manage',
+ *           'access arguments' => array('administer entity_example_basic entities'),
+ *         ),
+ *       ),
+ *     ),
+ */
+
+/**
+ * Provides a default configuration for Metatag intances.
+ *
+ * This hook allows modules to provide their own Metatag instances which can
+ * either be used as-is or as a "starter" for users to build from.
+ *
+ * This hook should be placed in MODULENAME.metatag.inc and it will be auto-
+ * loaded. MODULENAME.metatag.inc *must* be in the same directory as the
+ * .module file which *must* also contain an implementation of
+ * hook_ctools_plugin_api, preferably with the same code as found in
+ * metatag_ctools_plugin_api().
+ *
+ * The $config->disabled boolean attribute indicates whether the Metatag
+ * instance should be enabled (FALSE) or disabled (TRUE) by default.
+ *
+ * @return
+ *   An associative array containing the structures of Metatag instances, as
+ *   generated from the Export tab, keyed by the Metatag config name.
+ *
+ * @see metatag_metatag_config_default()
+ * @see metatag_ctools_plugin_api()
  */
 function hook_metatag_config_default() {
-  return array();
+  $configs = array();
+
+  $config = new stdClass();
+  $config->instance = 'config1';
+  $config->api_version = 1;
+  $config->disabled = FALSE;
+  $config->config = array(
+    'title' => array('value' => '[current-page:title] | [site:name]'),
+    'generator' => array('value' => 'Drupal 7 (http://drupal.org)'),
+    'canonical' => array('value' => '[current-page:url:absolute]'),
+    'shortlink' => array('value' => '[current-page:url:unaliased]'),
+  );
+  $configs[$config->instance] = $config;
+
+  $config = new stdClass();
+  $config->instance = 'config2';
+  $config->api_version = 1;
+  $config->disabled = FALSE;
+  $config->config = array(
+    'title' => array('value' => '[user:name] | [site:name]'),
+  );
+  $configs[$config->instance] = $config;
+
+  return $configs;
 }
 
 /**
@@ -20,7 +123,7 @@ function hook_metatag_config_default_alter(&$config) {
 /**
  * 
  */
-function hook_metatag_config_delete($type, $ids) {
+function hook_metatag_config_delete($entity_type, $entity_ids) {
 }
 
 /**
@@ -112,5 +215,5 @@ function hook_metatag_page_cache_cid_parts_alter(&$cid_parts) {
 /**
  * 
  */
-function hook_metatag_presave(&$metatags, $type, $id) {
+function hook_metatag_presave(&$metatags, $entity_type, $entity_id) {
 }
diff --git a/profiles/commons/modules/contrib/metatag/metatag.features.inc b/profiles/commons/modules/contrib/metatag/metatag.features.inc
index b40ab1e..5f8ab54 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.features.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag.features.inc
@@ -11,7 +11,9 @@ function metatag_features_export($data, &$export, $module_name = '', $type = 'me
   $pipe = array();
 
   foreach ($data as $name) {
-    $export['features'][$type][$name] = metatag_config_load($name);
+    if (metatag_config_load($name)) {
+      $export['features'][$type][$name] = $name;
+    }
   }
 
   $export['dependencies']['metatag'] = 'metatag';
@@ -51,18 +53,18 @@ function metatag_features_export_render($module_name, $data, $export = NULL) {
  * Implements hook_features_revert().
  */
 function metatag_features_revert($module) {
-  $function = "{$module}_metatag_export_default";
-  $feature_conf = $function();
-  foreach (array_keys($feature_conf) as $config) {
-    if ($conf = metatag_config_load($config)) {
-      db_delete('metatag_config')->condition('instance', $config)->execute();
+  if ($feature_conf = features_get_default('metatag', $module)) {
+    foreach (array_keys($feature_conf) as $config) {
+      if ($conf = metatag_config_load($config)) {
+        db_delete('metatag_config')->condition('instance', $config)->execute();
+      }
+      unset($feature_conf[$config]['cid']);
+      $object = new stdClass();
+      $object->cid = NULL;
+      $object->instance = $config;
+      $object->config = $feature_conf[$config]['config'];
+      metatag_config_save($object);
     }
-    unset($feature_conf[$config]['cid']);
-    $object = new stdClass();
-    $object->cid = NULL;
-    $object->instance = $config;
-    $object->config = $feature_conf[$config]['config'];
-    metatag_config_save($object);
   }
 }
 
@@ -76,3 +78,10 @@ function metatag_features_export_options() {
   };
   return $options;
 }
+
+/**
+ * Implements hook_features_rebuild().
+ */
+function metatag_features_rebuild($module) {
+  metatag_features_revert($module);
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.feeds.inc b/profiles/commons/modules/contrib/metatag/metatag.feeds.inc
new file mode 100644
index 0000000..3ee0acf
--- /dev/null
+++ b/profiles/commons/modules/contrib/metatag/metatag.feeds.inc
@@ -0,0 +1,37 @@
+<?php
+/**
+ * @file
+ * Feeds mapping implementation for the Metatag module.
+ */
+
+/**
+ * Implements hook_feeds_processor_targets_alter().
+ */
+function metatag_feeds_processor_targets_alter(&$targets, $entity_type, $bundle) {
+  if (metatag_entity_supports_metatags($entity_type)) {
+    $info = metatag_get_info();
+    foreach ($info['tags'] as $name => $tag) {
+      $targets['meta_' . $name] = array(
+        'name' => 'Meta tag: ' . check_plain($tag['label']),
+        'callback' => 'metatag_feeds_set_target',
+        'description' => $tag['description'],
+      );
+    }
+  }
+}
+
+/**
+ * Callback function to set value of a metatag tag.
+ */
+function metatag_feeds_set_target($source, $entity, $target, $value) {
+  // Don't do anything if we weren't given any data.
+  if (empty($value)) {
+    return;
+  }
+
+  // Strip the prefix that was added above. 
+  $name = str_replace('meta_', '', $target);
+
+  // Assign the value.
+  $entity->metatags[$name]['value'] = $value;
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.inc b/profiles/commons/modules/contrib/metatag/metatag.inc
index 0f0d0a1..d2f9aac 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag.inc
@@ -65,7 +65,6 @@ class DrupalDefaultMetaTag implements DrupalMetaTagInterface {
     return array(
       '#attached' => array('drupal_add_html_head' => array(array($element, $element['#id']))),
     );
-    return $element;
   }
 }
 
@@ -98,7 +97,7 @@ class DrupalTextMetaTag extends DrupalDefaultMetaTag {
     $options += array(
       'token data' => array(),
       'clear' => TRUE,
-      'sanitize' => FALSE,
+      'sanitize' => TRUE,
       'raw' => FALSE,
     );
 
@@ -142,7 +141,6 @@ class DrupalLinkMetaTag extends DrupalTextMetaTag {
     return array(
       '#attached' => array('drupal_add_html_head' => array(array($element, $element['#id']))),
     );
-    return $element;
   }
 }
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag.info b/profiles/commons/modules/contrib/metatag/metatag.info
index 254e319..4a61acd 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.info
+++ b/profiles/commons/modules/contrib/metatag/metatag.info
@@ -2,16 +2,23 @@ name = Meta tags
 description = "Adds support and an API to implement meta tags."
 package = Meta tags
 core = 7.x
-dependencies[] = token
+
+# This requires Drupal 7.15 or newer.
+dependencies[] = system (>=7.15)
+
+# CTools and Token are also required.
 dependencies[] = ctools
+dependencies[] = token
+
 configure = admin/config/search/metatags
 
 files[] = metatag.inc
+files[] = metatag.migrate.inc
 files[] = metatag.test
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag.install b/profiles/commons/modules/contrib/metatag/metatag.install
index b1174c8..f1ee370 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.install
+++ b/profiles/commons/modules/contrib/metatag/metatag.install
@@ -32,6 +32,7 @@ function metatag_schema() {
         'unsigned' => TRUE,
         'not null' => TRUE,
         'description' => 'The primary identifier for a metatag configuration set.',
+        'no export' => TRUE,
       ),
       'instance' => array(
         'type' => 'varchar',
@@ -111,9 +112,19 @@ function metatag_requirements($phase) {
       list($minor, $suffix) = explode('-', $minor);
     }
 
+    // Releases of Drupal older than 7.15 did not have entity_language(), which
+    // is now required.
+    if ($minor < 15) {
+      $requirements['metatag'] = array(
+        'severity' => REQUIREMENT_WARNING,
+        'title' => 'Metatag',
+        'value' => $t('Upgrade Drupal core to v7.15 or newer'),
+        'description' => $t("This older version of Drupal core is missing functionality necessary for the module's multilingual support, it must be upgraded to at least version 7.15."),
+      );
+    }
     // Releases of Drupal older than 7.17 did not trigger hook_entity_view on
     // term pages, so recommend updating.
-    if ($minor < 17) {
+    elseif ($minor < 17) {
       $requirements['metatag'] = array(
         'severity' => REQUIREMENT_WARNING,
         'title' => 'Metatag',
@@ -121,6 +132,7 @@ function metatag_requirements($phase) {
         'description' => $t('Your older version of Drupal core is missing functionality necessary for taxonomy term pages to work correctly, it is strongly recommended to upgrade to the latest release.'),
       );
     }
+    // Everything's OK.
     else {
       $requirements['metatag'] = array(
         'severity' => REQUIREMENT_OK,
@@ -132,13 +144,23 @@ function metatag_requirements($phase) {
 
     // Add a note if Page Title is also installed.
     if (module_exists('page_title')) {
-      $requirements['metatag'] = array(
+      $requirements['metatag_page_title'] = array(
         'severity' => REQUIREMENT_INFO,
         'title' => 'Metatag',
         'value' => $t('Possible conflicts with Page Title module'),
         'description' => $t('The Metatag module is able to customize page titles so running the Page Title module simultaneously can lead to complications.'),
       );
     }
+
+    // Add a note if Page Title is also installed.
+    if (module_exists('exclude_node_title')) {
+      $requirements['metatag_exclude_node_title'] = array(
+        'severity' => REQUIREMENT_INFO,
+        'title' => 'Metatag',
+        'value' => $t('Possible conflicts with Exclude Node Title module'),
+        'description' => $t('The Metatag module\'s default setitngs for content types (nodes) uses [node:title] for the page title. Unfortunately, Exclude Node Title hides this so the page title ends up blank. It is recommended to <a href="!config">change the "title" field\'s default value</a> to "[current-page:title]" instead of "[node:title]" for any content types affected by Exclude Node Title.', array('!config' => 'admin/config/search/metatags')),
+      );
+    }
   }
 
   return $requirements;
@@ -182,16 +204,24 @@ function metatag_update_7000() {
 }
 
 /**
- * Fix the {metatag_config}.cid column cannot be NULL.
+ * Fix the "{metatag_config}.cid column cannot be NULL" error.
  */
 function metatag_update_7001() {
-  $field = array(
+  $table_name = 'metatag_config';
+  $field_name = 'cid';
+  $field_spec = array(
     'type' => 'serial',
     'unsigned' => TRUE,
     'not null' => TRUE,
     'description' => 'The primary identifier for a metatag configuration set.',
   );
-  db_change_field('metatag_config', 'cid', 'cid', $field);
+  $keys = array('primary key' => array($field_name));
+
+  // Before making any changes, drop the existing primary key.
+  db_drop_primary_key($table_name);
+
+  // Rejig the field, and turn on the primary key again.
+  db_change_field($table_name, $field_name, $field_name, $field_spec, $keys);
 }
 
 /**
@@ -217,7 +247,7 @@ function metatag_update_7003() {
   // Don't add the new field if it already exists.
   if (!db_field_exists($table_name, $field_name)) {
     // Describe the new field.
-    $field_definition = array(
+    $field_spec = array(
       'type' => 'varchar',
       'length' => 32,
       'not null' => TRUE,
@@ -226,17 +256,197 @@ function metatag_update_7003() {
     );
 
     // Add it and update the primary key.
-    db_add_field($table_name, $field_name, $field_definition);
+    db_add_field($table_name, $field_name, $field_spec);
     db_drop_primary_key($table_name);
     db_add_primary_key($table_name, array('entity_type', 'entity_id', 'language'));
   }
 }
 
 /**
- * Update all language values in the metatag table, will also resolve problems
- * created during the release of beta3.
+ * Replaced by updates 7009, 7010, 7011, 7012 and 7013.
+ */
+function metatag_update_7004() {
+  // Do nothing.
+}
+
+/**
+ * Removing wrong metatag watchdog entries that break the admin/reports/dblog
+ * page.
+ */
+function metatag_update_7005() {
+  if (db_table_exists('watchdog')) {
+    db_delete('watchdog')
+      ->condition('type', 'metatag')
+      ->condition('variables', serialize('info'))
+      ->execute();
+  }
+}
+
+/**
+ * Remove {metatag} records that were added by old versions of the module for
+ * entities that don't actually support meta tags. A more complete version of
+ * this will be added later on after it's (hopefully) guaranteed that all
+ * modules have updated to the correct API usage.
+ */
+function metatag_update_7006() {
+  $entity_types = array(
+    // Core.
+    'comment',
+    'menu_link',
+    'taxonomy_vocabulary',
+    // Some contrib entities.
+    'mailchimp_list',
+    'profile2',
+    'profile2_type',
+    'redirect',
+    'rules_config',
+    'wysiwyg_profile',
+  );
+  foreach ($entity_types as $entity_type) {
+    $num_deleted = db_delete('metatag')
+      ->condition('entity_type', $entity_type)
+      ->execute();
+    if ($num_deleted > 0) {
+      drupal_set_message(t('Removed @count meta tag record(s) for the @type entity type, it does not support meta tags.', array('@count' => $num_deleted, '@type' => $entity_type)));
+    }
+  }
+}
+
+/**
+ * Remove {metatag} records for objects that have been deleted; older versions
+ * of Metatag may have failed to purge these.
+ */
+function metatag_update_7007() {
+  $result = db_query("DELETE m
+    FROM {metatag} m
+    LEFT OUTER JOIN {node} n
+    	ON m.entity_id=n.nid
+    WHERE m.entity_type='node'
+    	AND n.nid IS NULL");
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Removed @count meta tag record(s) for nodes that had been purged.', array('@count' => $result->rowCount())));
+  }
+
+  $result = db_query("DELETE m
+    FROM {metatag} m
+    LEFT OUTER JOIN {users} u
+    	ON m.entity_id=u.uid
+    WHERE m.entity_type='user'
+    	AND u.uid IS NULL");
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Removed @count meta tag record(s) for users that had been purged.', array('@count' => $result->rowCount())));
+  }
+
+  $result = db_query("DELETE m
+    FROM {metatag} m
+    LEFT OUTER JOIN {taxonomy_term_data} t
+    	ON m.entity_id=t.tid
+    WHERE m.entity_type='taxonomy_term'
+    	AND t.tid IS NULL");
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Removed @count meta tag record(s) for taxonomy terms that had been purged.', array('@count' => $result->rowCount())));
+  }
+}
+
+/**
+ * Remove any empty records that may be hanging around from old releases.
+ */
+function metatag_update_7008() {
+  $result = db_query("DELETE m FROM {metatag} m WHERE m.data IS NULL or m.data = '' OR m.data = :empty", array(':empty' => serialize(array())));
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Purged @count empty meta tag record(s).', array('@count' => $result->rowCount())));
+  }
+}
+
+/**
+ * Fix {metatag} records for taxonomy terms.
+ */
+function metatag_update_7009() {
+  // Remove duplicates.
+  _metatag_remove_dupes('taxonomy_term');
+
+  // The taxonomy term entity doesn't support a 'language' option, so reset it
+  // to LANGUAGE_NONE.
+  $result = db_query("UPDATE {metatag} SET language = :language WHERE entity_type='taxonomy_term'", array(':language' => LANGUAGE_NONE));
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Fixed language values for @count taxonomy terms.', array('@count' => $result->rowCount())));
+  }
+}
+
+/**
+ * Fix {metatag} records for users.
+ */
+function metatag_update_7010() {
+  // Remove duplicates.
+  _metatag_remove_dupes('user');
+
+  // Update User values.
+  $result = db_query("UPDATE {metatag} SET language = :language WHERE entity_type='user'", array(':language' => LANGUAGE_NONE));
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Fixed language values for @count user records.', array('@count' => $result->rowCount())));
+  }
+}
+
+/**
+ * Fix {metatag} records for nodes.
+ */
+function metatag_update_7011() {
+  // Only proceed if Entity_Translation is not enabled as it allows each node
+  // record to have multiple languages available.
+  if (module_exists('entity_translation')) {
+    drupal_set_message(t("Entity Translation is enabled, so node meta tags will not be updated, to avoid accidental dataloss."));
+    return;
+  }
+
+  // Remove duplicates.
+  _metatag_remove_dupes('node');
+
+  // Update Node values.
+  $result = db_query("UPDATE {metatag} AS m INNER JOIN {node} n ON m.entity_id=n.nid AND m.entity_type='node' SET m.language = n.language");
+  if ($result->rowCount() > 0) {
+    drupal_set_message(t('Fixed language values for @count nodes.', array('@count' => $result->rowCount())));
+  }
+}
+
+/**
+ * Remove duplicate {metatag} records for non-core entities.
  */
-function metatag_update_7004(&$sandbox) {
+function metatag_update_7012() {
+  if (module_exists('entity_translation')) {
+    drupal_set_message(t("Entity Translation is enabled, duplicate meta tags will not be removed for custom entities, to avoid accidental dataloss."));
+    return;
+  }
+
+  $records = db_select('metatag', 'm')
+    ->fields('m', array('entity_type'))
+    ->condition('m.entity_type', array('node', 'taxonomy_term', 'user'), 'NOT IN')
+    ->orderBy('m.entity_type', 'ASC')
+    ->orderBy('m.entity_id', 'ASC')
+    ->distinct()
+    ->execute();
+
+  $entity_types = array();
+  foreach ($records as $record) {
+    $entity_types[] = $record->entity_type;
+    // Remove duplicates.
+    _metatag_remove_dupes($record->entity_type);
+  }
+
+  if (empty($entity_types)) {
+    drupal_set_message(t('There were no other records to fix.'));
+  }
+}
+
+/**
+ * Fix the {metatag} language value for all non-core entity records. This might
+ * take a while, depending on how much data needs to be converted.
+ */
+function metatag_update_7013(&$sandbox) {
+  if (module_exists('entity_translation')) {
+    drupal_set_message(t("Entity Translation is enabled, meta tags will not be updated for custom entities, to avoid accidental dataloss."));
+    return;
+  }
+
   // Use the sandbox at your convenience to store the information needed
   // to track progression between successive calls to the function.
   if (!isset($sandbox['progress'])) {
@@ -247,123 +457,275 @@ function metatag_update_7004(&$sandbox) {
     // way to do this, so we're going to cache all record keys and manually
     // step through them.
     $records = db_select('metatag', 'm')
-      ->fields('m', array('entity_type', 'entity_id', 'language'))
-      ->orderBy('entity_type', 'ASC')
-      ->orderBy('entity_id', 'ASC')
+      ->fields('m', array('entity_type', 'entity_id'))
+      ->condition('m.entity_type', array('node', 'taxonomy_term', 'user'), 'NOT IN')
+      ->orderBy('m.entity_type', 'ASC')
+      ->orderBy('m.entity_id', 'ASC')
       ->execute();
     $sandbox['records'] = array();
     foreach ($records as $record) {
       $sandbox['records'][] = $record;
     }
+
+    // If there's no data, don't bother with the extra work.
+    if (empty($sandbox['records'])) {
+      watchdog('metatag', 'Update 7013: No meta tag records need updating.', array(), WATCHDOG_INFO);
+      if (drupal_is_cli()) {
+        drupal_set_message(t('Update 7013: No meta tag records need updating.'));
+      }
+      return t('No meta tag records need updating.');
+    }
+
     // Total records that must be visited.
     $sandbox['max'] = count($sandbox['records']);
 
     // A place to store messages during the run.
     $sandbox['messages'] = array();
 
+    // An initial record of the number of records to be updated.
+    watchdog('metatag', 'Update 7013: !count records to update.', array('!count' => $sandbox['max']), WATCHDOG_INFO);
+    if (drupal_is_cli()) {
+      drupal_set_message(t('Update 7013: !count records to update.', array('!count' => $sandbox['max'])));
+    }
+
     // Last record processed.
     $sandbox['current_record'] = -1;
   }
 
-  // If there's no data, don't bother with the extra work.
-  if (empty($sandbox['max'])) {
-    return t('No records needed to be updated.');
+  // Process records by groups of 10 (arbitrary value).
+  // When a group is processed, the batch update engine determines whether it
+  // should continue processing in the same request or provide progress
+  // feedback to the user and wait for the next request.
+  $limit = 10;
+
+  // The for loop will run as normal when ran via update.php, but when ran via
+  // Drush it'll just run 'til it's finished.
+  $increment = 1;
+  if (drupal_is_cli()) {
+    $increment = 0;
   }
 
-  // Proceed as normal.
-  else {
-    // Process records by groups of 10 (arbitrary value).
-    // When a group is processed, the batch update engine determines
-    // whether it should continue processing in the same request or provide
-    // progress feedback to the user and wait for the next request.
-    $limit = 10;
-
-    // Set default values.
-    for ($x = 0; $x < $limit; $x++) {
-      $sandbox['current_record']++;
-      if (empty($sandbox['records'][$sandbox['current_record']])) {
-        break;
+  // Set default values.
+  for ($ctr = 0; $ctr < $limit; $ctr += $increment) {
+    $sandbox['current_record']++;
+    if (empty($sandbox['records'][$sandbox['current_record']])) {
+      break;
+    }
+
+    // Shortcuts for later.
+    $entity_type = $sandbox['records'][$sandbox['current_record']]->entity_type;
+    $entity_id = $sandbox['records'][$sandbox['current_record']]->entity_id;
+
+    // Load the entity.
+    $entities = entity_load($entity_type, array($entity_id));
+    if (!empty($entities)) {
+      $entity = array_pop($entities);
+
+      // Make sure that the entity has a language set.
+      if (!empty($entity)) {
+        // If there's a (non-empty) language value, use it.
+        $new_language = entity_language($entity_type, $entity);
+        if (empty($new_language)) {
+          $new_language = LANGUAGE_NONE;
+        }
+        // Update the 'language' value.
+        db_update('metatag')
+          ->fields(array('language' => $new_language))
+          ->condition('entity_type', $entity_type)
+          ->condition('entity_id', $entity_id)
+          ->execute();
+      }
+    }
+
+    // Update our progress information.
+    $sandbox['progress']++;
+  }
+
+  // Set the "finished" status, to tell batch engine whether this function
+  // needs to run again. If you set a float, this will indicate the progress of
+  // the batch so the progress bar will update.
+  $sandbox['#finished'] = ($sandbox['progress'] >= $sandbox['max']) ? TRUE : ($sandbox['progress'] / $sandbox['max']);
+
+  if ($sandbox['#finished']) {
+    // Clear all caches so the fixed data will be reloaded.
+    cache_clear_all('*', 'cache_metatag', TRUE);
+
+    // A final log of the number of records that were converted.
+    watchdog('metatag', 'Update 7013: !count records were updated in total.', array('!count' => $sandbox['progress']), WATCHDOG_INFO);
+    if (drupal_is_cli()) {
+      drupal_set_message(t('Update 7013: !count records were updated.', array('!count' => $sandbox['progress'])));
+    }
+
+    // hook_update_N() may optionally return a string which will be displayed
+    // to the user.
+    return t('!count records were updated in total.', array('!count' => $sandbox['progress']));
+  }
+}
+
+/**
+ * Remove duplicate records for a given entity.
+ *
+ * It should be OK to run this without doing a separate batch process as there
+ * shouldn't be many records that have this problem. Hopefully.
+ *
+ * @param $entity_type
+ *   The name of an entity type to check for.
+ */
+function _metatag_remove_dupes($entity_type) {
+  $purge_count = 0;
+
+  // First step: fix the records. There should not be multiple records for the
+  // same entity_id with different languages.
+  $dupe_records = db_query("SELECT m.entity_id, count(m.language) AS the_count
+    FROM {metatag} m
+    WHERE
+      m.entity_type = :type
+    GROUP BY m.entity_id
+    HAVING the_count > 1", array(':type' => $entity_type));
+
+  if (!empty($dupe_records)) {
+    foreach ($dupe_records as $record) {
+      $entity_id = $record->entity_id;
+      $langs = db_query("SELECT m.entity_id, m.language, m.data FROM {metatag} m WHERE m.entity_type = :type AND m.entity_id = :id", array(':type' => $entity_type, ':id' => $entity_id))->fetchAll();
+
+      // Work out which language record to remove. Will need to store this as
+      // an array incase there are multiple records to purge.
+      $langs_to_remove = array();
+
+      // Check for duplicate records.
+      // Outer loop starts from the beginning.
+      for ($outer = 0; $outer < count($langs); $outer++) {
+        // This record may have been removed already.
+        if (isset($langs[$outer])) {
+          // Inner loop starts from the end.
+          for ($inner = count($langs) - 1; $inner > 0; $inner--) {
+            // Work out if the outer loop's data is the same as the inner
+            // loop's.
+            if (isset($langs[$inner]) && $langs[$outer]->data == $langs[$inner]->data) {
+              // Remove the second record.
+              $langs_to_remove[] = $langs[$inner]->language;
+              unset($langs[$inner]);
+            }
+          }
+        }
+      }
+
+      // Only one record left.
+      if (count($langs) == 1) {
+        // This is how it should be, this record is fine.
       }
+      // More than one record, work out which one to keep.
+      elseif (count($langs) > 1) {
+        // Work out the entity's language.
+        $entity = entity_load($entity_type, $entity_id);
+        $entity_language = entity_language($entity_type, $entity);
+        if (empty($language)) {
+          $entity_language = LANGUAGE_NONE;
+        }
 
-      // Shortcuts for later.
-      $entity_type = $sandbox['records'][$sandbox['current_record']]->entity_type;
-      $entity_id = $sandbox['records'][$sandbox['current_record']]->entity_id;
-      $language = $sandbox['records'][$sandbox['current_record']]->language;
-
-      // Load the entity.
-      $entities = entity_load($entity_type, array($entity_id));
-      if (!empty($entities)) {
-        $entity = array_pop($entities);
-
-        // Make sure that the entity has a language set and that it isn't the
-        // same as the meta tag record's language.
-        if (!empty($entity)) {
-          // If the record has multiple values already, i.e. someone saved a
-          // new record because they thought the records were missing.
-          try {
-            // If there's a (non-empty) language value, use it.
-            if (!empty($entity->language)) {
-              // The language values are different.
-              if ($entity->language != $language) {
-                // Update the record with the entity's language value.
-                db_update('metatag')
-                  ->fields(array('language' => $entity->language))
-                  ->condition('entity_type', $entity_type)
-                  ->condition('entity_id', $entity_id)
-                  ->condition('language', $language)
-                  ->execute();
+        // Work out if the entity's language record exists.
+        $lang_pos = NULL;
+        foreach ($langs as $key => $record) {
+          if ($record->language == $entity_language) {
+            $lang_pos = $key;
+            break;
+          }
+        }
+        // If the language record exists, delete the others.
+        if (isset($lang_pos)) {
+          foreach ($langs as $key => $record) {
+            if ($record->language != $entity_language) {
+              $langs_to_remove[] = $record->language;
+            }
+          }
+        }
+        // Otherwise look for a record for the site's default language.
+        else {
+          foreach ($langs as $key => $record) {
+            if ($record->language == $GLOBALS['language']->language) {
+              $lang_pos = $key;
+              break;
+            }
+          }
+          if (isset($lang_pos)) {
+            foreach ($langs as $key => $record) {
+              if ($record->language != $GLOBALS['language']->language) {
+                $langs_to_remove[] = $record->language;
               }
-              // The language values are the same.
-              else {
-                // Do nothing.
+            }
+          }
+          // Finally check for LANGUAGE_NONE.
+          else {
+            foreach ($langs as $key => $record) {
+              if ($record->language == LANGUAGE_NONE) {
+                $lang_pos = $key;
+                break;
               }
             }
-            // There's no language value.
-            else {
-              // Assign the global 'no language' value.
-              db_update('metatag')
-                ->fields(array('language' => LANGUAGE_NONE))
-                ->condition('entity_type', $entity_type)
-                ->condition('entity_id', $entity_id)
-                ->condition('language', $language)
-                ->execute();
+            if (isset($lang_pos)) {
+              foreach ($langs as $key => $record) {
+                if ($record->language != LANGUAGE_NONE) {
+                  $langs_to_remove[] = $record->language;
+                }
+              }
             }
           }
-          catch (Exception $e) {
-            // Delete the newer record.
-            db_delete('metatag')
-              ->condition('language', $entity->language)
-              ->condition('entity_type', $entity_type)
-              ->condition('entity_id', $entity_id)
-              ->execute();
-            // Update the old one again.
-            db_update('metatag')
-              ->fields(array('language' => $entity->language))
-              ->condition('entity_type', $entity_type)
-              ->condition('entity_id', $entity_id)
-              ->condition('language', $language)
-              ->execute();
-            $sandbox['messages'][] = t('The duplicate record for :type record #:id has been removed, leaving the older record in place.', array(':type' => $entity_type, ':id' => $entity_id));
-          }
         }
       }
 
-      // Update our progress information.
-      $sandbox['progress']++;
+      // Purge the redundant records.
+      if (!empty($langs_to_remove)) {
+        $purge_count += db_delete('metatag')
+          ->condition('entity_type', $entity_type)
+          ->condition('entity_id', $entity_id)
+          ->condition('language', $langs_to_remove)
+          ->execute();
+      }
     }
+  }
+
+  if (empty($purge_count)) {
+    drupal_set_message(t('No duplicate :entity_type records were found (this is a good thing).', array(':entity_type' => $entity_type)));
+    watchdog('metatag', 'No duplicate :entity_type records were found (this is a good thing).', array(':entity_type' => $entity_type));
+  }
+  else {
+    drupal_set_message(t('Purged :count duplicate :entity_type record(s).', array(':count' => $purge_count, ':entity_type' => $entity_type)));
+    watchdog('metatag', 'Purged :count duplicate :entity_type record(s).', array(':count' => $purge_count, ':entity_type' => $entity_type));
+    return;
+  }
+}
 
-    // Set the "finished" status, to tell batch engine whether this function
-    // needs to run again. If you set a float, this will indicate the progress
-    // of the batch so the progress bar will update.
-    $sandbox['#finished'] = ($sandbox['progress'] >= $sandbox['max']) ? TRUE : ($sandbox['progress'] / $sandbox['max']);
+/**
+ * Fix {metatag} records that may have been corrupted by #1871020.
+ */
+function metatag_update_7014() {
+  $records = db_query("SELECT *
+  FROM {metatag} m
+  WHERE
+       m.`data` LIKE :nolang
+    OR m.`data` LIKE :lang
+    OR m.`data` LIKE :und",
+    array(
+      ':nolang' => 'a:1:{s:0:"";a:%:{s:%;a:%:{%;}}}',
+      ':lang' => 'a:1:{s:2:"__";a:%:{s:%;a:%:{%;}}}',
+      ':und' => 'a:1:{s:3:"___";a:%:{s:%;a:%:{%;}}}',
+    ));
+
+  // Nothing to fix.
+  if ($records->rowCount() == 0) {
+    drupal_set_message(t('No corrupt records to fix, this is good news :-)'));
+  }
 
-    if ($sandbox['#finished']) {
-      // Clear all caches so the fixed data will be reloaded.
-      cache_clear_all('*', 'cache_metatag', TRUE);
+  // Fix the faulty records.
+  else {
+    foreach ($records as $record) {
+      // Extract the data and get the first element of the array, this should be
+      // valid data.
+      $record->data = reset(unserialize($record->data));
 
-      // hook_update_N() may optionally return a string which will be displayed
-      // to the user.
-      return t('%count records were updated.', array('%count' => $sandbox['progress']));
+      // Update the record.
+      drupal_write_record('metatag', $record, array('entity_type', 'entity_id', 'language'));
     }
+    drupal_set_message(t('Fixed @count corrupt meta tag record(s).', array('@count' => $records->rowCount())));
   }
 }
diff --git a/profiles/commons/modules/contrib/metatag/metatag.metatag.inc b/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
index ffb6b62..0c699fb 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag.metatag.inc
@@ -158,6 +158,13 @@ function metatag_metatag_info() {
     'group' => 'advanced',
   );
 
+  $info['tags']['news_keywords'] = array(
+    'label' => t('Google News Keywords'),
+    'description' => t('A comma-separated list of keywords about the page. This meta tag is used as an indicator in <a href="@google_news">Google News</a>.', array('@google_news' => 'http://support.google.com/news/publisher/bin/answer.py?hl=en&answer=68297')),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'advanced',
+  );
+
   $info['tags']['generator'] = array(
     'label' => t('Generator'),
     'description' => t("Describes the name and version number of the software or publishing tool used to create the page."),
@@ -204,6 +211,21 @@ function metatag_metatag_info() {
 
   $info['tags']['author'] = array(
     'label' => t('Author URL'),
+    'description' => "Used by some search engines to confirm authorship of the content on a page. Should be either the full URL for the author's Google+ profile page or a local page with information about the author.",
+    'class' => 'DrupalLinkMetaTag',
+    'group' => 'advanced',
+  );
+
+  $info['tags']['original-source'] = array(
+    'label' => t('Original Source'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'advanced',
+    'description' => "Used to indicate the URL that broke the story, and can link to either an internal URL or an external source. If the full URL is not known it is acceptable to use a partial URL or just the domain name.",
+  );
+
+  $info['tags']['author'] = array(
+    'label' => t('Author URL'),
     'description' => 'Used by some search engines to aid confirm authorship of the content on a page. Should be either the full URL for the author\'s Google+ profile page or a local page with information about the author.',
     'class' => 'DrupalLinkMetaTag',
     'group' => 'advanced',
diff --git a/profiles/commons/modules/contrib/metatag/metatag.migrate.inc b/profiles/commons/modules/contrib/metatag/metatag.migrate.inc
new file mode 100644
index 0000000..b189ef0
--- /dev/null
+++ b/profiles/commons/modules/contrib/metatag/metatag.migrate.inc
@@ -0,0 +1,53 @@
+<?php
+
+/**
+ * @file
+ * Metatag support for migrate.
+ */
+
+/**
+ * Implements hook_migrate_api().
+ */
+function metatag_migrate_api() {
+  return array('api' => 2);
+}
+
+/**
+ * Metatags destination handler.
+ */
+class MigrateMetatagHandler extends MigrateDestinationHandler {
+
+  public function __construct() {
+    $this->registerTypes(array('node', 'user', 'taxonomy_term'));
+  }
+
+  /**
+   * Implements MigrateDestinationHandler::fields().
+   */
+  public function fields() {
+    $fields = array();
+    $elements = metatag_get_info();
+
+    foreach ($elements['tags'] as $value) {
+      $metatag_field = 'metatag_' . $value['name'];
+      $fields[$metatag_field] = $value['description'];
+    }
+
+    return $fields;
+  }
+
+  /**
+   * Implements MigrateDestinationHandler::prepare().
+   */
+  public function prepare($entity, stdClass $row) {
+    $elements = metatag_get_info();
+
+    foreach ($elements['tags'] as $value) {
+      $metatag_field = 'metatag_' . $value['name'];
+      if (isset($entity->$metatag_field)) {
+        $entity->metatags[$value['name']]['value'] = $entity->$metatag_field;
+        unset($entity->$metatag_field);
+      }
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.module b/profiles/commons/modules/contrib/metatag/metatag.module
index 0774385..6f0a493 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.module
+++ b/profiles/commons/modules/contrib/metatag/metatag.module
@@ -4,11 +4,6 @@
  * @todo Add revisionable support for metatag data.
  */
 
-// Load the translation functionality when appropriate.
-if (module_exists('entity_translation')) {
-  include_once dirname(__FILE__) . '/metatag.entity_translation.inc';
-}
-
 /**
  * Implements hook_help().
  */
@@ -19,6 +14,10 @@ function metatag_help($path, $arg) {
   elseif ($path == 'admin/help#metatag') {
     return '<p>' . t('The Meta tags module provides a options to let each page have customized meta data added to the "meta" tags in the HEAD section of the document.') . '</p>';
   }
+  elseif ($path == 'admin/config/search/metatags/bulk-revert') {
+    return '<p>' . t('This form <strong>will wipe out</strong> all custom meta tags for the selected entities, reverting them to the default configuration assigned at the <a href="@url">Defaults tab</a>. For example, if the meta tags are changed for an article they will be removed if the "Node: Article" checkbox is selected.', array('@url' => url('admin/config/search/metatags'))) . '</p>';
+  }
+
 }
 
 /**
@@ -58,7 +57,7 @@ function metatag_ctools_plugin_api($owner, $api) {
  * Implements hook_hook_info().
  */
 function metatag_hook_info() {
-  $hooks_metatag = array(
+  $hooks = array(
     'metatag_config_default',
     'metatag_config_default_alter',
     'metatag_config_delete',
@@ -71,16 +70,8 @@ function metatag_hook_info() {
     'metatag_info',
     'metatag_info_alter',
   );
-  $hooks_metatag = array_fill_keys($hooks_metatag, array('group' => 'metatag'));
 
-  $hooks_entity_translation = array(
-    'entity_translation_insert',
-    'entity_translation_update',
-    'entity_translation_delete',
-  );
-  $hooks_entity_translation = array_fill_keys($hooks_entity_translation, array('group' => 'entity_translation'));
-
-  return $hooks_metatag + $hooks_entity_translation;
+  return array_fill_keys($hooks, array('group' => 'metatag'));
 }
 
 /**
@@ -178,6 +169,15 @@ function metatag_menu() {
     'type' => MENU_LOCAL_TASK,
     'weight' => 10,
   );
+  $items['admin/config/search/metatags/bulk-revert'] = array(
+    'title' => 'Bulk revert',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('metatag_bulk_revert_form'),
+    'access arguments' => array('administer meta tags'),
+    'type' => MENU_LOCAL_TASK,
+    'weight' => 30,
+    'file' => 'metatag.admin.inc',
+  );
 
   return $items;
 }
@@ -303,32 +303,32 @@ function metatag_config_cache_clear() {
 /**
  * Load an entity's tags.
  *
- * @param $type
+ * @param $entity_type
  *   The entity type to load
- * @param $id
+ * @param $entity_id
  *   The ID of the entity to load
  * @return
  *   An array of tag data keyed by language.
  */
-function metatag_metatags_load($type, $id) {
-  $metatags = metatag_metatags_load_multiple($type, array($id));
+function metatag_metatags_load($entity_type, $entity_id) {
+  $metatags = metatag_metatags_load_multiple($entity_type, array($entity_id));
   return !empty($metatags) ? reset($metatags) : array();
 }
 
 /**
  * Load tags for multiple entities.
  *
- * @param $type
+ * @param $entity_type
  *   The entity type to load
- * @param $ids
+ * @param $entity_ids
  *   The list of entity IDs
  * @return
  *   An array of tag data, keyed by ID.
  */
-function metatag_metatags_load_multiple($type, array $ids) {
+function metatag_metatags_load_multiple($entity_type, array $entity_ids) {
   // Double check entity IDs are numeric thanks to Entity API module.
-  $ids = array_filter($ids, 'is_numeric');
-  if (empty($ids)) {
+  $entity_ids = array_filter($entity_ids, 'is_numeric');
+  if (empty($entity_ids)) {
     return array();
   }
 
@@ -346,8 +346,8 @@ function metatag_metatags_load_multiple($type, array $ids) {
 
   // Get all translations of tag data for this entity.
   $result = db_query("SELECT entity_id, data, language FROM {metatag} WHERE (entity_type = :type) AND (entity_id IN (:ids))", array(
-    ':type' => $type,
-    ':ids' => $ids,
+    ':type' => $entity_type,
+    ':ids' => $entity_ids,
   ));
 
   // Marshal it into an array keyed by entity ID. Each value is an array of
@@ -363,40 +363,55 @@ function metatag_metatags_load_multiple($type, array $ids) {
 /**
  * Save an entity's tags.
  *
- * @param $type
+ * @param $entity_type
  *   The entity type to load
- * @param $id
+ * @param $entity_id
  *   The entity's ID
  * @param $metatags
  *   All of the tag information
  * @param $language
  *   The language of the translation set
  */
-function metatag_metatags_save($type, $id, $metatags, $language) {
-  // Use the default content language if the entity doesn't have language
-  // support.
+function metatag_metatags_save($entity_type, $entity_id, $metatags, $language) {
+  // If no language assigned, use the has-no-language language.
   if (!$language) {
-    $language = $GLOBALS['language_content']->language;
+    $language = LANGUAGE_NONE;
   }
 
-  // Check that $id is numeric because of Entity API and string IDs.
-  if (!is_numeric($id)) {
+  // Check that $entity_id is numeric because of Entity API and string IDs.
+  if (!is_numeric($entity_id)) {
     return;
   }
 
+  // Certain modules, e.g. Workbench Moderation, will cause the data to be in
+  // an unsupported format; the problem needs to be resolved elsewhere so this
+  // can only be considered a temporary fix.
+  // TODO: Solve the core problem, which will probably entail something
+  // similar to http://drupal.org/node/1876034.
+  if (isset($metatags[$language])) {
+    // There are certain occasions when the old data and the new data are
+    // *both* added to the $metatags array, in this case throw away the language
+    // data.
+    $lang_data = $metatags[$language];
+    unset($metatags[$language]);
+    if (empty($metatags)) {
+      $metatags = $lang_data;
+    }
+  }
+
   // Allow other modules to alter the meta tags prior to saving using
   // hook_metatag_presave().
   foreach (module_implements('metatag_presave') as $module) {
     $function = "{$module}_metatag_presave";
-    $function($metatags, $type, $id, $language);
+    $function($metatags, $entity_type, $entity_id, $language);
   }
 
   if (empty($metatags)) {
     // If the data array is empty, there is no data to actually save, so
     // just delete the record from the database.
     db_delete('metatag')
-      ->condition('entity_type', $type)
-      ->condition('entity_id', $id)
+      ->condition('entity_type', $entity_type)
+      ->condition('entity_id', $entity_id)
       ->condition('language', $language)
       ->execute();
   }
@@ -404,8 +419,8 @@ function metatag_metatags_save($type, $id, $metatags, $language) {
     // Otherwise save the data for this entity.
     db_merge('metatag')
       ->key(array(
-        'entity_type' => $type,
-        'entity_id' => $id,
+        'entity_type' => $entity_type,
+        'entity_id' => $entity_id,
         'language' => $language,
       ))
       ->fields(array(
@@ -415,50 +430,50 @@ function metatag_metatags_save($type, $id, $metatags, $language) {
   }
 
   // Clear cached data.
-  metatag_metatags_cache_clear($type, $id);
+  metatag_metatags_cache_clear($entity_type, $entity_id);
 }
 
 /**
  * Delete an entity's tags.
  *
- * @param $type
+ * @param $entity_type
  *   The entity type
- * @param $id
+ * @param $entity_id
  *   The entity's ID
  * @param $langcode
  *   The language ID of the entry to delete.  If left blank, all language
  *   entries for this entity will be deleted.
  */
-function metatag_metatags_delete($type, $id, $langcode = NULL) {
-  return metatag_metatags_delete_multiple($type, array($id), $langcode);
+function metatag_metatags_delete($entity_type, $entity_id, $langcode = NULL) {
+  return metatag_metatags_delete_multiple($entity_type, array($entity_id), $langcode);
 }
 
 /**
  * Delete multiple entities' tags.
  *
- * @param $type
+ * @param $entity_type
  *   The entity type
- * @param $ids
+ * @param $entity_ids
  *   The list of IDs
  * @param $langcode
  *   The language ID of the entities to delete.  If left blank, all language
  *   entries for the enities will be deleted.
  */
-function metatag_metatags_delete_multiple($type, array $ids, $langcode = NULL) {
+function metatag_metatags_delete_multiple($entity_type, array $entity_ids, $langcode = NULL) {
   // Double check entity IDs are numeric thanks to Entity API module.
-  $ids = array_filter($ids, 'is_numeric');
+  $entity_ids = array_filter($entity_ids, 'is_numeric');
 
-  if ($metatags = metatag_metatags_load_multiple($type, $ids)) {
+  if ($metatags = metatag_metatags_load_multiple($entity_type, $entity_ids)) {
     $transaction = db_transaction();
     try {
       // Let other modules know about the records being deleted using
       // hook_metatag_metatags_delete().
-      module_invoke_all('metatag_metatags_delete', $type, $ids, $langcode);
+      module_invoke_all('metatag_metatags_delete', $entity_type, $entity_ids, $langcode);
 
       // Set the entity to delete.
       $query = db_delete('metatag')
-        ->condition('entity_type', $type)
-        ->condition('entity_id', $ids, 'IN');
+        ->condition('entity_type', $entity_type)
+        ->condition('entity_id', $entity_ids, 'IN');
 
       // Specify a language if there is one.
       if ($langcode) {
@@ -469,7 +484,7 @@ function metatag_metatags_delete_multiple($type, array $ids, $langcode = NULL) {
       $query->execute();
 
       // Clear cached data.
-      metatag_metatags_cache_clear($type, $ids);
+      metatag_metatags_cache_clear($entity_type, $entity_ids);
     }
     catch (Exception $e) {
       $transaction->rollback();
@@ -479,14 +494,14 @@ function metatag_metatags_delete_multiple($type, array $ids, $langcode = NULL) {
   }
 }
 
-function metatag_metatags_cache_clear($type, $id = NULL) {
-  if (empty($id)) {
-    cache_clear_all("output:$type", 'cache_metatag', TRUE);
+function metatag_metatags_cache_clear($entity_type, $entity_id = NULL) {
+  if (empty($entity_id)) {
+    cache_clear_all("output:$entity_type", 'cache_metatag', TRUE);
   }
   else {
-    $ids = (array) $id;
-    foreach ($ids as $id) {
-      cache_clear_all("output:$type:$id", 'cache_metatag', TRUE);
+    $entity_ids = (array) $entity_id;
+    foreach ($entity_ids as $entity_id) {
+      cache_clear_all("output:$entity_type:$entity_id", 'cache_metatag', TRUE);
     }
   }
 }
@@ -494,22 +509,22 @@ function metatag_metatags_cache_clear($type, $id = NULL) {
 /**
  * Implements hook_entity_load().
  */
-function metatag_entity_load($entities, $type) {
+function metatag_entity_load($entities, $entity_type) {
   // Wrap this in a try-catch block to work around occasions when the schema
   // hasn't been updated yet.
   try {
-    if (metatag_entity_supports_metatags($type)) {
-      $metatags = metatag_metatags_load_multiple($type, array_keys($entities));
-      foreach ($entities as $id => $entity) {
-        $entities[$id]->metatags = isset($metatags[$id]) ? $metatags[$id] : array();
+    if (metatag_entity_supports_metatags($entity_type)) {
+      $metatags = metatag_metatags_load_multiple($entity_type, array_keys($entities));
+      foreach ($entities as $entity_id => $entity) {
+        $entities[$entity_id]->metatags = isset($metatags[$entity_id]) ? $metatags[$entity_id] : array();
       }
     }
   }
   catch (Exception $e) {
-    watchdog('metatag', 'Error loading meta tag data, do the database updates need to be ran? do the <a href=":url:">database updates</a> need to be ran? The error occurred when loading record(s) :ids for the :type entity type. The error message was: :error', array(':ids' => implode(', ', array_keys($entities)), ':type' => $type, ':error' => $e->getMessage()), WATCHDOG_CRITICAL);
+    watchdog('metatag', 'Error loading meta tag data, do the <a href="@update">database updates</a> need to be run? The error occurred when loading record(s) %ids for the %type entity type. The error message was: %error', array('@update' => base_path() . 'update.php', '%ids' => implode(', ', array_keys($entities)), '%type' => $entity_type, '%error' => $e->getMessage()), WATCHDOG_CRITICAL);
     // Don't display the same message twice for Drush.
     if (php_sapi_name() != 'cli') {
-      drupal_set_message(t('Error loading meta tag data, do the <a href=":url">database updates</a> need to be ran?', array('url' => url('update.php'))), 'error');
+      drupal_set_message(t('Error loading meta tag data, do the <a href="@update">database updates</a> need to be run?', array('@update' => base_path() . 'update.php')), 'error');
     }
   }
 }
@@ -519,13 +534,12 @@ function metatag_entity_load($entities, $type) {
  */
 function metatag_entity_insert($entity, $entity_type) {
   if (isset($entity->metatags)) {
-    list($id) = entity_extract_ids($entity_type, $entity);
+    list($entity_id) = entity_extract_ids($entity_type, $entity);
 
-    // Determine the language as per http://drupal.org/node/1626346.
-    $language = function_exists('entity_language') ?
-      entity_language($entity_type, $entity) : $entity->language;
+    // Determine the entity's language.
+    $language = metatag_entity_get_language($entity_type, $entity);
 
-    metatag_metatags_save($entity_type, $id, $entity->metatags, $language);
+    metatag_metatags_save($entity_type, $entity_id, $entity->metatags, $language);
   }
 }
 
@@ -533,19 +547,38 @@ function metatag_entity_insert($entity, $entity_type) {
  * Implements hook_entity_update().
  */
 function metatag_entity_update($entity, $entity_type) {
-  list($id) = entity_extract_ids($entity_type, $entity);
+  if (!metatag_entity_supports_metatags($entity_type)) {
+    return;
+  }
 
-  if (isset($entity->metatags)) {
+  list($entity_id) = entity_extract_ids($entity_type, $entity);
 
-    // Determine the language as per http://drupal.org/node/1626346.
-    $language = function_exists('entity_language') ?
-      entity_language($entity_type, $entity) : $entity->language;
+  if (isset($entity->metatags)) {
+    // Determine the entity's language.
+    $new_language = metatag_entity_get_language($entity_type, $entity);
+
+    // Determine the language for this entity object.
+    if (isset($entity->original)) {
+      $old_language = metatag_entity_get_language($entity_type, $entity->original);
+
+      // If the language has changed then remove the old one. When a new
+      // translation is being saved using Entity Translation both values will
+      // be the same, so this is safe to do.
+      if ($old_language != $new_language) {
+        db_delete('metatag')
+          ->condition('entity_type', $entity_type)
+          ->condition('entity_id', $entity_id)
+          ->condition('language', $old_language)
+          ->execute();
+      }
+    }
 
-    metatag_metatags_save($entity_type, $id, $entity->metatags, $language);
+    // Save the record.
+    metatag_metatags_save($entity_type, $entity_id, $entity->metatags, $new_language);
   }
   else {
     // Still ensure the meta tag output is cached.
-    metatag_metatags_cache_clear($entity_type, $id);
+    metatag_metatags_cache_clear($entity_type, $entity_id);
   }
 }
 
@@ -553,8 +586,8 @@ function metatag_entity_update($entity, $entity_type) {
  * Implements hook_entity_delete().
  */
 function metatag_entity_delete($entity, $entity_type) {
-  list($id) = entity_extract_ids($entity_type, $entity);
-  metatag_metatags_delete($entity_type, $id);
+  list($entity_id) = entity_extract_ids($entity_type, $entity);
+  metatag_metatags_delete($entity_type, $entity_id);
 }
 
 /**
@@ -567,12 +600,12 @@ function metatag_field_attach_delete_revision($entity_type, $entity) {
 /**
  * Implements hook_taxonomy_term_view_alter().
  */
-function metatag_taxonomy_term_view_alter(&$build, &$type) {
+function metatag_taxonomy_term_view_alter(&$build, &$entity_type) {
   // This is only needed if hook_entity_view has not been added to core.
   // @see http://drupal.org/node/1067120
   if (isset($build['#term']) && !function_exists('taxonomy_term_view_multiple')) {
     $entity = taxonomy_term_load($build['#term']->tid);
-    metatag_entity_view($entity, $type, 'full', NULL);
+    metatag_entity_view($entity, $entity_type, 'full', NULL);
   }
 }
 
@@ -580,16 +613,47 @@ function metatag_taxonomy_term_view_alter(&$build, &$type) {
  * Implements hook_entity_view().
  */
 function metatag_entity_view($entity, $entity_type, $view_mode, $langcode) {
+  // Only run this function once per page load.
+  static $i_will_say_this_only_once = FALSE;
+
   // Only proceed if this entity object is the page being viewed.
   if (_metatag_entity_is_page($entity_type, $entity)) {
+    // Only run this function once per page load.
+    if ($i_will_say_this_only_once) {
+      return;
+    }
+    $i_will_say_this_only_once = TRUE;
+
     // If this entity object isn't allowed meta tags, skip it.
     if (!metatag_entity_has_metatags($entity_type, $entity)) {
       return;
     }
 
+    // Obbtain some details of the entity that are needed elsewhere.
     list($entity_id, $revision_id, $bundle) = entity_extract_ids($entity_type, $entity);
     $instance = "{$entity_type}:{$bundle}";
 
+    // Determine the language this entity actually uses.
+    $entity_language = metatag_entity_get_language($entity_type, $entity);
+
+    // The requested language is different to the entity's language, look for
+    // a language elsewhere.
+    if ($entity_language != $langcode) {
+      // If no language was defined for the entity then use that for the 
+      if ($entity_language == LANGUAGE_NONE) {
+        $langcode = LANGUAGE_NONE;
+      }
+      else {
+        $enabled_languages = field_content_languages();
+        foreach (field_language($entity_type, $entity) as $field => $lang) {
+          // Only accept actual language values that are properly enabled.
+          if ($lang != LANGUAGE_NONE && in_array($lang, $enabled_languages)) {
+            $langcode = $lang;
+          }
+        }
+      }
+    }
+
     // All applicable pieces for this current page.
     $cid_parts = array(
       'entity_type' => $entity_type,
@@ -609,12 +673,13 @@ function metatag_entity_view($entity, $entity_type, $view_mode, $langcode) {
     // hook_metatag_page_cache_cid_parts_alter().
     drupal_alter('metatag_page_cache_cid_parts', $cid_parts);
 
-    $cid = "output:{$entity_type}:{$entity_id}:" . hash('sha256', serialize($cid_parts));
+    $cid = "output:{$entity_type}:{$entity_id}:{$langcode}:" . hash('sha256', serialize($cid_parts));
 
     if ($cache = cache_get($cid, 'cache_metatag')) {
-      $entity->content['metatags'] = $cache->data;
+      $output = $cache->data;
     }
     else {
+      // Separate the meta tags.
       $metatags = isset($entity->metatags) ? $entity->metatags : array();
 
       // Build options for meta tag rendering.
@@ -626,7 +691,7 @@ function metatag_entity_view($entity, $entity_type, $view_mode, $langcode) {
 
       // Ensure we actually pass a language object rather than language code.
       $languages = language_list();
-      if (isset($langcode) && isset($languages[$langcode])) {
+      if (isset($languages[$langcode])) {
         $options['language'] = $languages[$langcode];
       }
 
@@ -637,13 +702,13 @@ function metatag_entity_view($entity, $entity_type, $view_mode, $langcode) {
       $options['entity'] = $entities[$entity_id];
 
       // Render the metatags and save to the cache.
-      $entity->content['metatags'] = metatag_metatags_view($instance, $metatags, $options);
-      cache_set($cid, $entity->content['metatags'], 'cache_metatag');
+      $output = metatag_metatags_view($instance, $metatags, $options);
+      cache_set($cid, $output, 'cache_metatag');
     }
 
     // We need to register the term's metatags, so we can later fetch them.
     // @see metatag_page_build().
-    metatag_page_set_metatags($instance, $entity->content['metatags']);
+    metatag_page_set_metatags($instance, $output);
   }
 }
 
@@ -672,25 +737,11 @@ function metatag_metatags_view($instance, array $metatags = array(), array $opti
 
   // If there are any tags, determine the translation to display.
   if (!empty($metatags)) {
-    // Get the display language.
-    if (isset($options['language']->language)) {
-      // Use the passed-in option.
-      $translation = $options['language']->language;
-    }
-    elseif (isset($metatags[$GLOBALS['language_content']->language])) {
-      // We weren't given a language; use the global content one.
-      $translation = $GLOBALS['language_content']->language;
-    }
-    else {
-      // The language is not defined.
-      $translation = LANGUAGE_NONE;
-    }
-
-    // Choose the derived translation, fail over to the language-agnostic
-    // values if applicable.
-    if (!empty($metatags[$translation])) {
-      $metatags = $metatags[$translation];
+    // Get the display language; default to the entity's language.
+    if (isset($options['language']) && isset($options['language']->language) && isset($metatags[$options['language']->language])) {
+      $metatags = $metatags[$options['language']->language];
     }
+    // If no language requested, use the no-language value.
     elseif (!empty($metatags[LANGUAGE_NONE])) {
       $metatags = $metatags[LANGUAGE_NONE];
     }
@@ -909,69 +960,67 @@ function metatag_entity_has_metatags($entity_type, $entity) {
   }
   $instance = "{$entity_type}:{$bundle}";
   if (!isset($config_exists[$instance])) {
-    $config_exists[$instance] = NULL;
-    $instances = metatag_config_get_parent_instances($instance, FALSE);
-    $configs = metatag_config_load_multiple($instances);
-    foreach ($instances as $key) {
-      if (!empty($configs[$key]) && empty($configs[$key]->disabled)) {
-        $config_exists[$instance] = TRUE;
-      }
-    }
+    // Check if the intstance or its parents (excluding global) are enabled.
+    $config_exists[$instance] = metatag_config_is_enabled($instance, TRUE, FALSE);
   }
 
   return isset($config_exists[$instance]);
 }
 
+/**
+ * Check whether the requested entity type (and bundle) support metatag.
+ *
+ * By default this will be FALSE, support has to be specifically enabled by
+ * assigning 'metatag' => TRUE within the hook_entity_info() definition for the
+ * entity.
+ */
 function metatag_entity_supports_metatags($entity_type = NULL, $bundle = NULL) {
-  $types = &drupal_static(__FUNCTION__);
+  $entity_types = &drupal_static(__FUNCTION__);
 
-  if (!isset($types)) {
-    $types = array();
+  if (!isset($entity_types)) {
+    $entity_types = array();
     foreach (entity_get_info() as $entity_type_key => $entity_info) {
-      if (!isset($entity_info['metatags'])) {
-        // By default allow entities that have fields or have paths and are not
-        // configuration entities (Entity API setting).
-        $entity_info['metatags'] = (!empty($entity_info['uri callback']) || !empty($entity_info['fieldable'])) && empty($entity_info['configuration']);
-      }
       if (empty($entity_info['metatags'])) {
-        $types[$entity_type_key] = FALSE;
+        $entity_types[$entity_type_key] = FALSE;
         continue;
       }
-      $types[$entity_type_key] = array();
+      $entity_types[$entity_type_key] = array();
       foreach ($entity_info['bundles'] as $bundle_key => $bundle_info) {
-        $types[$entity_type_key][$bundle_key] = !isset($bundle_info['metatags']) || !empty($bundle_info['metatags']);
+        $entity_types[$entity_type_key][$bundle_key] = !isset($bundle_info['metatags']) || !empty($bundle_info['metatags']);
       }
     }
   }
 
   if (isset($entity_type) && isset($bundle)) {
-    return isset($types[$entity_type][$bundle]) ? $types[$entity_type][$bundle] : FALSE;
+    return isset($entity_types[$entity_type][$bundle]) ? $entity_types[$entity_type][$bundle] : FALSE;
   }
   elseif (isset($entity_type)) {
-    return isset($types[$entity_type]) ? ($types[$entity_type] !== FALSE) : FALSE;
+    return isset($entity_types[$entity_type]) ? ($entity_types[$entity_type] !== FALSE) : FALSE;
   }
 
-  return $types;
+  return $entity_types;
 }
 
 /**
  * Implements hook_entity_info_alter().
+ *
+ * Enables Metatag support for the core entities.
  */
 function metatag_entity_info_alter(&$info) {
   $defaults['node'] = array(
     'path' => 'node/%node',
+    'metatags' => TRUE,
   );
   $defaults['taxonomy_term'] = array(
     'path' => 'taxonomy/term/%taxonomy_term',
+    'metatags' => TRUE,
   );
   if (module_exists('forum') && ($vid = variable_get('forum_nav_vocabulary', 0)) && $vocabulary = taxonomy_vocabulary_load($vid)) {
     $defaults['taxonomy_term']['bundles'][$vocabulary->machine_name]['path'] = 'forum/%taxonomy_term';
   }
   $defaults['user'] = array(
     'path' => 'user/%user',
-  );
-  $defaults['comment'] = array(
-    'metatags' => FALSE,
+    'metatags' => TRUE,
   );
 
   foreach ($defaults as $key => $entity_defaults) {
@@ -1055,7 +1104,8 @@ function metatag_page_build(&$page) {
   }
 
   // The front page has special consideration.
-  if (drupal_is_front_page()) {
+  $instance = 'global:frontpage';
+  if (drupal_is_front_page() && metatag_config_is_enabled($instance)) {
     $instance = 'global:frontpage';
 
     // These two parts are sufficient given that the homepage is unique.
@@ -1074,7 +1124,7 @@ function metatag_page_build(&$page) {
     drupal_alter('metatag_page_cache_cid_parts', $cid_parts);
 
     $cid = "output:{$instance}:" . hash('sha256', serialize($cid_parts));
-    
+
     if ($cache = cache_get($cid, 'cache_metatag')) {
       $metatags = $cache->data;
     }
@@ -1082,7 +1132,7 @@ function metatag_page_build(&$page) {
       $metatags = metatag_metatags_view($instance, array());
       cache_set($cid, $metatags, 'cache_metatag');
     }
-    
+
     $page['content']['metatags'][$instance] = $metatags;
   }
 
@@ -1091,12 +1141,44 @@ function metatag_page_build(&$page) {
   else {
     $page['content']['metatags'] += metatag_page_get_metatags();
   }
+
+  // If no meta tags were loaded, and this is not an admin path, at least load
+  // the global defaults. This may be disabled, see README.txt for details.
+  if (empty($page['content']['metatags']) && variable_get('metatag_load_all_pages', TRUE) && !path_is_admin(current_path())) {
+    $instance = 'global';
+
+    // These two parts are sufficient given that the homepage is unique.
+    $cid_parts = array(
+      'langcode' => $GLOBALS['language_content']->language,
+      'url' => $GLOBALS['base_url'] . $_SERVER['REQUEST_URI'],
+    );
+
+    // Allow each page in a sequence to have different values.
+    if (isset($_GET['page'])) {
+      $cid_parts['page'] = $_GET['page'];
+    }
+
+    // Allow other modules to customize the data using
+    // hook_metatag_page_cache_cid_parts_alter().
+    drupal_alter('metatag_page_cache_cid_parts', $cid_parts);
+
+    $cid = "output:{$instance}:" . hash('sha256', serialize($cid_parts));
+
+    if ($cache = cache_get($cid, 'cache_metatag')) {
+      $metatags = $cache->data;
+    }
+    else {
+      $metatags = metatag_metatags_view($instance, array());
+      cache_set($cid, $metatags, 'cache_metatag');
+    }
+    $page['content']['metatags'][$instance] = $metatags;
+  }
 }
 
 /**
  * Returns whether the current page is the page of the passed in entity.
  *
- * @param $type
+ * @param $entity_type
  *    The entity type; e.g. 'node' or 'user'.
  * @param $entity
  *    The entity object.
@@ -1105,8 +1187,8 @@ function metatag_page_build(&$page) {
  *   TRUE if the current page is the page of the specified entity, or FALSE
  *   otherwise.
  */
-function _metatag_entity_is_page($type, $entity) {
-  $uri = entity_uri($type, $entity);
+function _metatag_entity_is_page($entity_type, $entity) {
+  $uri = entity_uri($entity_type, $entity);
   return !empty($uri['path']) && current_path() == $uri['path'];
 }
 
@@ -1138,45 +1220,41 @@ function metatag_field_attach_form($entity_type, $entity, &$form, &$form_state,
   if (!metatag_entity_has_metatags($entity_type, $entity)) {
     return;
   }
+  // Entity_Translation will trigger this hook again, skip it.
+  if (!empty($form_state['entity_translation']['is_translation'])) {
+    return;
+  }
 
   list($entity_id, $revision_id, $bundle) = entity_extract_ids($entity_type, $entity);
   $instance = "{$entity_type}:{$bundle}";
 
   // Grab the meta tags for display in the form if there are any.
-  if (isset($entity->metatags)) {
-
-    // Determine the entity language as per http://drupal.org/node/1626346.
-    $entity_language = function_exists('entity_language') ?
-      entity_language($entity_type, $entity) : $entity->language;
-
-    // Determine from where we should get the tags.
-    if (!(isset($entity->metatags[$langcode]) || isset($entity->metatags[$entity_language]))) {
+  if (!empty($entity->metatags)) {
+    // Identify the language to use with this entity.
+    $entity_language = metatag_entity_get_language($entity_type, $entity);
 
-      // This is a preview so set the tags to the raw submission data.  No
-      // language has been set.
-      $metatags = $entity->metatags;
+    // If this is a new translation using Entity Translation, load the meta
+    // tags from the entity's original language.
+    if (module_exists('entity_translation') && empty($form['#entity_translation_source_form']) && ($handler = entity_translation_entity_form_get_handler($form, $form_state)) && isset($entity->metatags[$handler->getSourceLanguage()])) {
+      $metatags = $entity->metatags[$handler->getSourceLanguage()];
     }
+    // Determine from where we should get the tags.
     elseif (isset($entity->metatags[$langcode])) {
       // Set the tags to the translation set matching that of the form.
       $metatags = $entity->metatags[$langcode];
-
-      // For tags that aren't set in the current form language, fill them in
-      // with default data from the original translation, the entity language.
-      if (isset($entity->metatags[$entity_language])) {
-        foreach ($entity->metatags[$entity_language] as $tag_id => $tag_data) {
-          if (!isset($metatags[$tag_id])) {
-            $metatags[$tag_id] = $tag_data;
-          }
-        }
-      }
     }
     // There is no translation for this entity's tags in the current
     // language. Instead, display tags in the language of the entity, the
     // source language of translations. The will provide translators with the
     // original text to translate.
-    else {
+    elseif (isset($entity->metatags[$entity_language])) {
       $metatags = $entity->metatags[$entity_language];
     }
+    // This is a preview so set the tags to the raw submission data.  No
+    // language has been set.
+    else {
+      $metatags = $entity->metatags;
+    }
   }
   else {
     $metatags = array();
@@ -1226,7 +1304,7 @@ function metatag_get_info($type = NULL, $name = NULL) {
   if (!isset($info)) {
     // hook_metatag_info() includes translated strings, so each language is cached
     // separately.
-    $cid = 'info:' . $GLOBALS['language']->language;
+    $cid = 'info:' . LANGUAGE_NONE;
 
     if ($cache = cache_get($cid, 'cache_metatag')) {
       $info = $cache->data;
@@ -1352,7 +1430,6 @@ function metatag_html_head_alter(&$elements) {
     foreach (array_keys($elements) as $key) {
       if (strpos($key, 'drupal_add_html_head_link:' . $name . ':') === 0) {
         unset($elements[$key]);
-        break;
       }
     }
   }
@@ -1457,12 +1534,20 @@ function metatag_config_instance_label($instance) {
   $labels = &drupal_static(__FUNCTION__, array());
 
   if (!isset($labels[$instance])) {
-    $context = metatag_config_instance_info($instance);
-    $labels[$instance] = isset($context['label']) ? $context['label'] : t('Unknown');
-    $parents = metatag_config_get_parent_instances($instance, FALSE);
-    array_shift($parents);
-    if (!empty($parents)) {
-      $labels[$instance] = metatag_config_instance_label(implode(':', $parents)) . ': ' . $labels[$instance];
+    $instance_parts = explode(':', $instance);
+    $instance_part = array_pop($instance_parts);
+    if ($context = metatag_config_instance_info($instance)) {
+      $labels[$instance] = $context['label'];
+    }
+    else {
+      $labels[$instance] = t('Unknown (@instance)', array('@instance' => $instance_part));
+    }
+    // Normally the following would use metatag_config_get_parent_instances()
+    // but since we already sliced the instance by separator and removed the
+    // last segment, putting the array back together gives us this instance's
+    // parent.
+    if (!empty($instance_parts)) {
+      $labels[$instance] = metatag_config_instance_label(implode(':', $instance_parts)) . ': ' . $labels[$instance];
     }
   }
 
@@ -1501,13 +1586,60 @@ function metatag_config_access($op, $config = NULL) {
 }
 
 /**
+ * Checks if a metatag configuration record is enabled.
+ *
+ * @param string $instance
+ *   The configuration instance machine name.
+ *
+ * @return bool
+ *   TRUE if the configuration is enabled, or FALSE otherwise.
+ */
+function metatag_config_is_enabled($instance, $include_defaults = FALSE, $include_global = TRUE) {
+  if ($include_defaults) {
+    return (bool) metatag_config_load_with_defaults($instance, $include_global);
+  }
+  else {
+    $config = metatag_config_load($instance);
+    return !empty($config) && empty($config->disabled);
+  }
+}
+
+/**
+ * Wrapper around entity_language() to use LANGUAGE_NONE if the entity does not
+ * have a language assigned.
+ *
+ * @param $entity_type
+ *   An entity type's machine name.
+ * @param $entity
+ *   The entity to review;
+ *
+ * @return
+ *   A string indicating the language code to be used.
+ */
+function metatag_entity_get_language($entity_type, $entity) {
+  // Determine the entity's language.
+  $langcode = entity_language($entity_type, $entity);
+
+  // If no matching language was found, which will happen for e.g. terms and
+  // users, it is normally recommended to use the system default language.
+  // However, as the system default language can change, this could potentially
+  // cause data loss / confusion problems; as a result use the system "no
+  // language" value to avoid any potential problems.
+  if (empty($langcode)) {
+    $langcode = LANGUAGE_NONE;
+  }
+
+  return $langcode;
+}
+
+/**
  * Implements of hook_features_api().
  */
 function metatag_features_api() {
   $components = array(
     'metatag' => array(
       'name' => t('Meta tags'),
-      'features_source' => TRUE,
+      'feature_source' => TRUE,
       'default_hook' => 'metatag_export_default',
       'default_file' => FEATURES_DEFAULTS_INCLUDED,
       'file' => drupal_get_path('module', 'metatag') . '/metatag.features.inc',
@@ -1534,9 +1666,14 @@ function metatag_views_post_render(&$view, &$output, &$cache) {
       if (isset($entity_type['path']) && ($display->display_options['path'] . $entity_name) == $entity_type['path']) {
         // Only proceed if this entity type supports meta tags.
         if (metatag_entity_supports_metatags($entity_name)) {
-          $entities = entity_load($entity_name, $view->args);
-          $entity = array_pop($entities);
-          metatag_entity_view($entity, $entity_name, 'full', NULL);
+          // There must be at least one argument and the first argument must be
+          // numerical.
+          if (!empty($view->args) && is_numeric($view->args[0])) {
+            // Only the first argument is used.
+            $entities = entity_load($entity_name, array($view->args[0]));
+            $entity = array_pop($entities);
+            metatag_entity_view($entity, $entity_name, 'full', NULL);
+          }
         }
       }
     }
@@ -1561,11 +1698,31 @@ function metatag_ctools_render_alter(&$info, $page, $context) {
       if (isset($entity_type['path']) && $context['task']['admin path'] == $entity_type['path']) {
         // Only proceed if this entity type supports meta tags.
         if (metatag_entity_supports_metatags($entity_name)) {
-          $entities = entity_load($entity_name, $context['args']);
-          $entity = array_pop($entities);
-          metatag_entity_view($entity, $entity_name, 'full', NULL);
+          // There must be at least one argument and the first argument must be
+          // numerical.
+          if (!empty($context['args']) && is_numeric($context['args'][0])) {
+            // Only the first argument is used.
+            $entities = entity_load($entity_name, array($context['args'][0]));
+            $entity = array_pop($entities);
+            metatag_entity_view($entity, $entity_name, 'full', NULL);
+          }
         }
       }
     }
   }
 }
+
+/**
+ * Implements hook_entity_translation_delete().
+ *
+ * Required for content translations being handled via Entity_Translation to
+ * remove the appropriate record when a translation is removed without the
+ * corresponding entity record also being removed.
+ */
+function metatag_entity_translation_delete($entity_type, $entity, $langcode) {
+  // Get the entity's ID.
+  list($entity_id) = entity_extract_ids($entity_type, $entity);
+  
+  // Delete the translation.
+  metatag_metatags_delete($entity_type, $entity_id, $langcode);
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag.test b/profiles/commons/modules/contrib/metatag/metatag.test
index 49f6743..ad5076e 100644
--- a/profiles/commons/modules/contrib/metatag/metatag.test
+++ b/profiles/commons/modules/contrib/metatag/metatag.test
@@ -58,17 +58,39 @@ class MetaTagsUnitTest extends MetaTagsTestHelper {
     }
   }
 
-  function assertMetatagEntityHasMetatags($type, $bundle, $expected) {
-    $entity = entity_create_stub_entity($type, array(0, NULL, $bundle));
+  function assertMetatagEntityHasMetatags($entity_type, $bundle, $expected) {
+    $entity = entity_create_stub_entity($entity_type, array(0, NULL, $bundle));
     return $this->assertEqual(
-      metatag_entity_has_metatags($type, $entity),
+      metatag_entity_has_metatags($entity_type, $entity),
       $expected,
       t("metatag_entity_has_metatags(:type, :entity) is :expected", array(
-        ':type' => var_export($type, TRUE),
+        ':type' => var_export($entity_type, TRUE),
         ':entity' => var_export($entity, TRUE),
         ':expected' => var_export($expected, TRUE),
       ))
     );
   }
 
+  /**
+   * Test the metatag_config_instance_label() function.
+   */
+  public function testConfigLabels() {
+    $test_cases = array(
+      'node' => 'Node',
+      'node:article' => 'Node: Article',
+      'node:article:c' => 'Node: Article: Unknown (c)',
+      'node:b' => 'Node: Unknown (b)',
+      'node:b:c' => 'Node: Unknown (b): Unknown (c)',
+      'a' => 'Unknown (a)',
+      'a:b' => 'Unknown (a): Unknown (b)',
+      'a:b:c' => 'Unknown (a): Unknown (b): Unknown (c)',
+      'a:b:c:d' => 'Unknown (a): Unknown (b): Unknown (c): Unknown (d)',
+    );
+
+    foreach ($test_cases as $input => $expected_output) {
+      drupal_static_reset('metatag_config_instance_label');
+      $actual_output = metatag_config_instance_label($input);
+      $this->assertEqual($actual_output, $expected_output);
+    }
+  }
 }
diff --git a/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.admin.inc b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.admin.inc
index a09c8ff..d776cb2 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.admin.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.admin.inc
@@ -23,9 +23,9 @@ function metatag_context_context_overview() {
         l('Delete', 'admin/config/search/metatags/context/' . $context->name . '/delete', array('query' => array('destination' => 'admin/config/search/metatags/context'))),
       );
       $rows[] = array(
-          $context->name,
-          implode(', ', $context->conditions['path']['values']),
-          implode(' | ', $ops),
+        $context->name,
+        isset($context->conditions['path']) ? implode(', ', $context->conditions['path']['values']) : t('No path condition.'),
+        implode(' | ', $ops),
       );
     }
   }
@@ -94,7 +94,7 @@ function metatag_context_config_edit_form($form, &$form_state, $context) {
 
   $form['paths'] = array(
     '#title' => 'Path',
-    '#description' => 'Set this metatag context when any of the paths above match the page path. Put each path on a separate line. You can use the <code>*</code> character (asterisk) as a wildcard and the <code>~</code> character (tilde) to exclude one or more paths. Use <code>&lt;front&gt;</code> for the site front page.',
+    '#description' => t('Set this metatag context when any of the paths above match the page path. Put each path on a separate line. You can use the <code>*</code> character (asterisk) as a wildcard and the <code>~</code> character (tilde) to exclude one or more paths. Use <code>&lt;front&gt;</code> for the site front page. Only local paths (e.g. "example/page") will work, do not use relative URLs ("/example/page") or absolute URLs ("http://example.com/example/page").'),
     '#type' => 'textarea',
     '#default_value' => isset($context->conditions['path']['values']) ? html_entity_decode(implode('&#13;&#10;', $context->conditions['path']['values'])) : '',
     '#required' => 1,
diff --git a/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.info b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.info
index de417fc..14d32b9 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.info
+++ b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.info
@@ -5,9 +5,9 @@ core = 7.x
 dependencies[] = context
 dependencies[] = metatag
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.install b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.install
new file mode 100644
index 0000000..78415ce
--- /dev/null
+++ b/profiles/commons/modules/contrib/metatag/metatag_context/metatag_context.install
@@ -0,0 +1,13 @@
+<?php
+/**
+ * @file
+ * Installation and update hooks for Metatag:Context.
+ */
+
+/**
+ * Implements hook_enable().
+ */
+function metatag_context_enable() {
+  // Clear the cache so Context and CTools know about this plugin.
+  cache_clear_all('plugins:context:plugins', 'cache');
+}
diff --git a/profiles/commons/modules/contrib/metatag/metatag_dc/metatag_dc.info b/profiles/commons/modules/contrib/metatag/metatag_dc/metatag_dc.info
index 8adf2b3..7e05d4e 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_dc/metatag_dc.info
+++ b/profiles/commons/modules/contrib/metatag/metatag_dc/metatag_dc.info
@@ -4,9 +4,9 @@ package = Meta tags
 core = 7.x
 dependencies[] = metatag
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.info b/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.info
index 39e2652..6b32cfd 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.info
+++ b/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.info
@@ -4,9 +4,9 @@ package = Meta tags
 core = 7.x
 dependencies[] = metatag
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.metatag.inc b/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.metatag.inc
index e987554..f6c6a1b 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.metatag.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag_opengraph/metatag_opengraph.metatag.inc
@@ -65,6 +65,25 @@ function metatag_opengraph_metatag_info() {
     ),
   );
 
+  $info['tags']['fb:admins'] = array(
+    'label' => t('Facebook Admins'),
+    'description' => t('A comma-separated list of Facebook user IDs of people who are considered administrators or moderators of this page. Most sites will only need to assign this on the global settings page.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['fb:app_id'] = array(
+    'label' => t('Facebook Application ID'),
+    'description' => t('A comma-separated list of Facebook Platform Application IDs applicable for this site. Most sites will only need to assign this on the global settings page.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+
   $info['tags']['og:site_name'] = array(
     'label' => t('Open Graph site name'),
     'description' => t('A human-readable name for your site, e.g., <em>IMDb</em>.'),
@@ -89,8 +108,8 @@ function metatag_opengraph_metatag_info() {
   $info['tags']['og:description'] = array(
     'label' => t('Open Graph description'),
     'description' => t('A one to two sentence description of your page.'),
-    'group' => 'open-graph',
     'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
     'element' => array(
       '#theme' => 'metatag_opengraph',
     ),
@@ -101,16 +120,25 @@ function metatag_opengraph_metatag_info() {
     'description' => t('The type of your object, e.g., <em>movie</em>.'),
     'class' => 'DrupalTextMetaTag',
     'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
     'form' => array(
       '#type' => 'select',
       '#options' => _metatag_opengraph_type_options(),
       '#empty_option' => t('- None -'),
     ),
-    'element' => array(
-      '#theme' => 'metatag_opengraph',
-    ),
   );
 
+  if (module_exists('select_or_other')) {
+    // Enhance the og:type field to support custom types.
+    $info['tags']['og:type']['form']['#type'] = 'select_or_other';
+    $info['tags']['og:type']['form']['#other'] = t('Other (please type a value)');
+    $info['tags']['og:type']['form']['#other_unknown_defaults'] = 'other';
+    $info['tags']['og:type']['form']['#theme'] = 'select_or_other';
+    $info['tags']['og:type']['form']['#element_validate'] = array('select_or_other_element_validate');
+  }
+
   $info['tags']['og:image'] = array(
     'label' => t('Open Graph image'),
     'description' => t('An image URL which should represent your object within the graph. The image must be at least 50px by 50px and have a maximum aspect ratio of 3:1. We support PNG, JPEG and GIF formats.'),
@@ -131,9 +159,18 @@ function metatag_opengraph_metatag_info() {
     ),
   );
 
-  $info['tags']['fb:admins'] = array(
-    'label' => t('Facebook Admins'),
-    'description' => t('A comma-separated list of Facebook user IDs of people who are considered administrators or moderators of this page. Most sites will only need to assign this on the global settings page.'),
+  $info['tags']['og:latitude'] = array(
+    'label' => t('Open Graph Latitude'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:longitude'] = array(
+    'label' => t('Open Graph Longitude'),
+    'description' => '',
     'class' => 'DrupalTextMetaTag',
     'group' => 'open-graph',
     'element' => array(
@@ -141,15 +178,133 @@ function metatag_opengraph_metatag_info() {
     ),
   );
 
-  $info['tags']['fb:app_id'] = array(
-    'label' => t('Facebook Application ID'),
-    'description' => t('A comma-separated list of Facebook Platform Application IDs applicable for this site. Most sites will only need to assign this on the global settings page.'),
+  $info['tags']['og:street-address'] = array(
+    'label' => t('Open Graph Street Address'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:locality'] = array(
+    'label' => t('Open Graph Locality'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:region'] = array(
+    'label' => t('Open Graph Region'),
+    'description' => '',
     'class' => 'DrupalTextMetaTag',
     'group' => 'open-graph',
     'element' => array(
       '#theme' => 'metatag_opengraph',
     ),
   );
+  $info['tags']['og:postal-code'] = array(
+    'label' => t('Open Graph Postal Code'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:country-name'] = array(
+    'label' => t('Open Graph Country Name'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+
+  $info['tags']['og:email'] = array(
+    'label' => t('Open Graph Email'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:phone_number'] = array(
+    'label' => t('Open Graph Phone Number'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:fax_number'] = array(
+    'label' => t('Open Graph Fax Number'),
+    'description' => '',
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+
+  $info['tags']['og:video'] = array(
+    'label' => t('Open Graph Video (URL)'),
+    'description' => t('A URL to a video file that complements this object.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:video:secure_url'] = array(
+    'label' => t('Open Graph Video Secure'),
+    'description' => t('A URL to a video file that complements this object using the HTTPS protocol.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:video:width'] = array(
+    'label' => t('Open Graph Video Width'),
+    'description' => t('The width of the video.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:video:height'] = array(
+    'label' => t('Open Graph Video Height'),
+    'description' => t('The height of the video.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+  );
+  $info['tags']['og:video:type'] = array(
+    'label' => t('Open Graph Video Type'),
+    'description' => t('The type of the video file.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'open-graph',
+    'element' => array(
+      '#theme' => 'metatag_opengraph',
+    ),
+    'form' => array(
+      '#type' => 'select',
+      '#options' => array(
+        'application/x-shockwave-flash' => 'Flash - playable directly from the feed',
+        'text/html' => 'Separate HTML page',
+      ),
+      '#empty_option' => t('- None -'),
+    ),
+  );
 
   return $info;
 }
diff --git a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.info b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.info
index 453784f..6700946 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.info
+++ b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.info
@@ -3,9 +3,9 @@ description = "Provides support for Twitter's Card meta tags. NOTE: Only use if
 package = Meta tags
 core = 7.x
 dependencies[] = metatag
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.metatag.inc b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.metatag.inc
index 69022f0..3d705a6 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.metatag.inc
+++ b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.metatag.inc
@@ -83,22 +83,41 @@ function metatag_twitter_cards_metatag_info() {
       '#theme' => 'metatag_twitter_cards',
     ),
   );
+  $info['tags']['twitter:site:id'] = array(
+    'label' => t('Site\'s Twitter account ID'),
+    'description' => t('The numerical Twitter account ID for the website, which will be displayed in the Card\'s footer.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'twitter-cards',
+    'context' => array('global'),
+    'element' => array(
+      '#theme' => 'metatag_twitter_cards',
+    ),
+  );
   $info['tags']['twitter:creator'] = array(
     'label' => t('Creator\'s Twitter account'),
     'description' => t('The @username for the content creator / author for this page, including the @ symbol.'),
     'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
-      '#theme' => 'metatag_twittercard',
+      '#theme' => 'metatag_twitter_cards',
+    ),
+  );
+  $info['tags']['twitter:creator:id'] = array(
+    'label' => t('Creator\'s Twitter account ID'),
+    'description' => t('The numerical Twitter account ID for the content creator / author for this page.'),
+    'class' => 'DrupalTextMetaTag',
+    'group' => 'twitter-cards',
+    'element' => array(
+      '#theme' => 'metatag_twitter_cards',
     ),
   );
   $info['tags']['twitter:url'] = array(
     'label' => t('Page URL'),
     'description' => t('The permalink / canonical URL of the current page.'),
-    'class' => 'DrupalLinkMetaTag',
+    'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
-      '#theme' => 'metatag_twittercard',
+      '#theme' => 'metatag_twitter_cards',
     ),
   );
   $info['tags']['twitter:title'] = array(
@@ -107,7 +126,7 @@ function metatag_twitter_cards_metatag_info() {
     'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
-      '#theme' => 'metatag_twittercard',
+      '#theme' => 'metatag_twitter_cards',
     ),
   );
   $info['tags']['twitter:description'] = array(
@@ -122,7 +141,7 @@ function metatag_twitter_cards_metatag_info() {
   $info['tags']['twitter:image'] = array(
     'label' => t('Image URL'),
     'description' => t('The URL to a unique image representing the content of the page. Do not use a generic image such as your website logo, author photo, or other image that spans multiple pages. Images larger than 120x120px will be resized and cropped square based on longest dimension. Images smaller than 60x60px will not be shown. If the \'type\' is set to <em>Photo</em> then the image must be at least 280x150px.'),
-    'class' => 'DrupalLinkMetaTag',
+    'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
       '#theme' => 'metatag_twitter_cards',
@@ -149,7 +168,7 @@ function metatag_twitter_cards_metatag_info() {
   $info['tags']['twitter:player'] = array(
     'label' => t('Media player URL'),
     'description' => t('The full URL for loading a media player. Required when using a <em>Media player</em> card.'),
-    'class' => 'DrupalLinkMetaTag',
+    'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
       '#theme' => 'metatag_twitter_cards',
@@ -176,7 +195,7 @@ function metatag_twitter_cards_metatag_info() {
   $info['tags']['twitter:player:stream'] = array(
     'label' => t('MP4 media stream URL'),
     'description' => t('The full URL for an MP4 video (h.264) or audio (AAC) stream, takes precidence over the other media player field.'),
-    'class' => 'DrupalLinkMetaTag',
+    'class' => 'DrupalTextMetaTag',
     'group' => 'twitter-cards',
     'element' => array(
       '#theme' => 'metatag_twitter_cards',
diff --git a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.module b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.module
index 63bc1e3..2f835c4 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.module
+++ b/profiles/commons/modules/contrib/metatag/metatag_twitter_cards/metatag_twitter_cards.module
@@ -17,7 +17,7 @@ function metatag_twitter_cards_ctools_plugin_api($owner, $api) {
  * Implements hook_theme().
  */
 function metatag_twitter_cards_theme() {
-  $info['metatag_twittercard'] = array(
+  $info['metatag_twitter_cards'] = array(
     'render element' => 'element',
   );
 
diff --git a/profiles/commons/modules/contrib/metatag/metatag_ui/metatag_ui.info b/profiles/commons/modules/contrib/metatag/metatag_ui/metatag_ui.info
index 3c78474..30fcb4b 100644
--- a/profiles/commons/modules/contrib/metatag/metatag_ui/metatag_ui.info
+++ b/profiles/commons/modules/contrib/metatag/metatag_ui/metatag_ui.info
@@ -6,9 +6,9 @@ dependencies[] = metatag
 dependencies[] = ctools
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/metatag/tests/metatag_test.info b/profiles/commons/modules/contrib/metatag/tests/metatag_test.info
index 100d70e..57114e4 100644
--- a/profiles/commons/modules/contrib/metatag/tests/metatag_test.info
+++ b/profiles/commons/modules/contrib/metatag/tests/metatag_test.info
@@ -4,9 +4,9 @@ core = 7.x
 dependencies[] = metatag
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2012-11-18
-version = "7.x-1.0-beta4"
+; Information added by drupal.org packaging script on 2013-03-24
+version = "7.x-1.0-beta5"
 core = "7.x"
 project = "metatag"
-datestamp = "1353209208"
+datestamp = "1364088611"
 
diff --git a/profiles/commons/modules/contrib/oauth/CHANGELOG b/profiles/commons/modules/contrib/oauth/CHANGELOG
index 6c4c674..d6787b3 100644
--- a/profiles/commons/modules/contrib/oauth/CHANGELOG
+++ b/profiles/commons/modules/contrib/oauth/CHANGELOG
@@ -1,6 +1,3 @@
-OAuth 7.x-3.x, 2013--
-------------------------------
-
 OAuth 7.x-3.1, 2013-2-3
 ------------------------------
 #1529166 by barraponto: implement hook_requirements() to check that cURL library is available.
diff --git a/profiles/commons/modules/contrib/oauth/oauth_common.info b/profiles/commons/modules/contrib/oauth/oauth_common.info
index a004de7..be16227 100644
--- a/profiles/commons/modules/contrib/oauth/oauth_common.info
+++ b/profiles/commons/modules/contrib/oauth/oauth_common.info
@@ -18,8 +18,8 @@ files[] = includes/DrupalOAuthClient.inc
 files[] = includes/OAuthSignatureMethod_HMAC.inc
 
 ; Information added by drupal.org packaging script on 2013-02-04
-version = "7.x-3.1+1-dev"
+version = "7.x-3.1"
 core = "7.x"
 project = "oauth"
-datestamp = "1359940850"
+datestamp = "1359936562"
 
diff --git a/profiles/commons/modules/contrib/oauth/oauth_common_providerui.info b/profiles/commons/modules/contrib/oauth/oauth_common_providerui.info
index 8d889da..cd5ca1a 100644
--- a/profiles/commons/modules/contrib/oauth/oauth_common_providerui.info
+++ b/profiles/commons/modules/contrib/oauth/oauth_common_providerui.info
@@ -7,8 +7,8 @@ dependencies[] = oauth_common
 core = 7.x
 
 ; Information added by drupal.org packaging script on 2013-02-04
-version = "7.x-3.1+1-dev"
+version = "7.x-3.1"
 core = "7.x"
 project = "oauth"
-datestamp = "1359940850"
+datestamp = "1359936562"
 
diff --git a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
index fdd752a..602fbdc 100644
--- a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
+++ b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
@@ -6,9 +6,10 @@ core = 7.x
 files[] = lib/DrupalOAuth2Client.inc
 
 
-; Information added by drupal.org packaging script on 2012-04-01
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0-beta1+6-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1333242145"
+datestamp = "1364431822"
 
diff --git a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
index b5fc34e..e7799d7 100644
--- a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
+++ b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
@@ -9,9 +9,10 @@ dependencies[] = http_client
 dependencies[] = http_client_oauth
 dependencies[] = ctools
 
-; Information added by drupal.org packaging script on 2012-04-01
+
+; Information added by drush on 2013-03-28
 version = "7.x-1.0-beta1+6-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1333242145"
+datestamp = "1364431822"
 
diff --git a/profiles/commons/modules/contrib/og/PATCHES.txt b/profiles/commons/modules/contrib/og/PATCHES.txt
index 37ee047..8a87892 100644
--- a/profiles/commons/modules/contrib/og/PATCHES.txt
+++ b/profiles/commons/modules/contrib/og/PATCHES.txt
@@ -1,5 +1,4 @@
 The following patches have been applied to this project:
-- http://drupal.org/files/og-add-group-message.patch
 - http://drupal.org/files/1902086-og-ref-respect-og-user-access-3.patch
 
 This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/og/README.txt b/profiles/commons/modules/contrib/og/README.txt
index fb54ccb..94f3e6d 100644
--- a/profiles/commons/modules/contrib/og/README.txt
+++ b/profiles/commons/modules/contrib/og/README.txt
@@ -112,6 +112,15 @@ DEVELOPERS & SITE BUILDERS
   http://drupal.org/project/entityreference_prepopulate
   and configuring the correct settings in the field UI. Read more about
   it in Entity reference prepopulate's README file.
+  Further more, when Entity reference prepopulate module is enabled the node
+  "create" permissions will be enabled even for non-members. In order to allow
+  a non member to create a node to a group they don't belong to, you should
+  craft the URL in the same way. OG will recognize this situation and add the
+  group as a valid option under the "My groups" widget.
+- When deleting groups, it is possible to delete orphan group-content, or move
+  it under another group. In order to do it in a scalable way, enable the
+  "Use queue" option, and process it using for example:
+  drush queue-run og_membership_orphans
 
 FAQ
 ----
diff --git a/profiles/commons/modules/contrib/og/includes/migrate/7200/og_og_membership.migrate.inc b/profiles/commons/modules/contrib/og/includes/migrate/7200/og_og_membership.migrate.inc
index b940d43..6137ba5 100644
--- a/profiles/commons/modules/contrib/og/includes/migrate/7200/og_og_membership.migrate.inc
+++ b/profiles/commons/modules/contrib/og/includes/migrate/7200/og_og_membership.migrate.inc
@@ -48,7 +48,10 @@ class OgMigrateMembership extends OgEntityMigration {
     }
   }
 
-  public function prepare($entity, $row) {
+  /**
+   * Reject the source row if the group or group content are missing.
+   */
+  public function prepareRow($row) {
     $entity_type = $row->entity_type;
     $etid = $row->etid;
     $group_type = $row->group_type;
@@ -57,27 +60,46 @@ class OgMigrateMembership extends OgEntityMigration {
     if (!$group_content = entity_load_single($entity_type, $etid)) {
       // The OG membership was somehow not deleted when the entity
       // was deleted.
-      return;
+      return FALSE;
     }
 
     if (!$group = entity_load_single($group_type, $gid)) {
-      return;
+      return FALSE;
     }
+    return parent::prepareRow($row);
+  }
+
+  public function prepare($entity, $row) {
+    $entity_type = $row->entity_type;
+    $etid = $row->etid;
+    $group_type = $row->group_type;
+    $gid = $row->gid;
+
+    $group_content = entity_load_single($entity_type, $etid);
+    $group = entity_load_single($group_type, $gid);
 
     list(,, $group_bundle) = entity_extract_ids($group_type, $group);
     if (!$field_name = og_get_best_group_audience_field($entity_type, $group_content, $group_type, $group_bundle)) {
-      // Create a new field. Pick an unused name.
-      $field_name = substr("og_$group_type", 0, 32);
+      // Create a new field. Pick an unused name, if the settings don't match.
+      // To maintain some backwards compatibility, if the group type is a node,
+      // we try to set its name to OG_AUDIENCE FIELD.
+      $field_name = $group_type == 'node' ? OG_AUDIENCE_FIELD : substr("og_$group_type", 0, 32);
       $i = 1;
-      while (field_info_field($field_name)) {
-        $field_name = substr("og_$group_type", 0, 32 - strlen($i)) . $i;
-        ++$i;
-      }
 
       $og_field = og_fields_info(OG_AUDIENCE_FIELD);
       $og_field['field']['settings']['target_type'] = $group_type;
-
       list(,, $bundle) = entity_extract_ids($entity_type, $group_content);
+
+      while ($field = field_info_field($field_name)) {
+        if ($field['settings']['target_type'] == $group_type && empty($field['settings']['handler_settings']['target_bundles']) || in_array($bundle, $field['settings']['handler_settings']['target_bundles'])) {
+          // An existing field.
+          $field_name = $field['field_name'];
+          break;
+        }
+        $field_name = substr("og_$group_type", 0, 32 - strlen($i)) . $i;
+        ++$i;
+      }
+
       og_create_field($field_name, $entity_type, $bundle, $og_field);
     }
     $entity->field_name = $field_name;
@@ -86,8 +108,7 @@ class OgMigrateMembership extends OgEntityMigration {
   /**
    * Override Migration::postImport().
    *
-   * Remove OG-memberships that should hae been deleted.
-   *
+   * Remove OG-memberships that should have been deleted.
    */
   protected function postImport() {
     if (!$this->isComplete()) {
diff --git a/profiles/commons/modules/contrib/og/includes/migrate/7200/og_roles.migrate.inc b/profiles/commons/modules/contrib/og/includes/migrate/7200/og_roles.migrate.inc
index 7a08e5f..fae9b32 100644
--- a/profiles/commons/modules/contrib/og/includes/migrate/7200/og_roles.migrate.inc
+++ b/profiles/commons/modules/contrib/og/includes/migrate/7200/og_roles.migrate.inc
@@ -15,8 +15,6 @@ class OgMigrateRoles extends OgEntityMigration {
 
   public $keyName = 'rid';
 
-  protected $dependencies = array('OgMigrateMembership');
-
   /**
    * Indicate we are updating existing data.
    */
diff --git a/profiles/commons/modules/contrib/og/includes/migrate/plugins/destinations/og_membership.inc b/profiles/commons/modules/contrib/og/includes/migrate/plugins/destinations/og_membership.inc
index 869946d..e216f79 100644
--- a/profiles/commons/modules/contrib/og/includes/migrate/plugins/destinations/og_membership.inc
+++ b/profiles/commons/modules/contrib/og/includes/migrate/plugins/destinations/og_membership.inc
@@ -78,15 +78,13 @@ class MigrateDestinationOGMembership extends MigrateDestination {
     else {
       $state = OG_STATE_ACTIVE;
     }
-
-    $values = array(
-      'entity_type' => $entity->entity_type,
-      'entity' => $entity->etid,
-      'state' => $state,
-      'created' => isset($entity->created) ? $entity->created : REQUEST_TIME,
-    );
-
     $this->prepare($entity, $row);
+    // Allow passing OG-membership fields via og_group().
+    $values = (array) $entity;
+    $values['entity'] = $entity->etid;
+    $values['state'] = $state;
+    $values['created'] = isset($entity->created) ? $entity->created : REQUEST_TIME;
+
     $og_membership = og_group($entity->group_type, $entity->gid, $values);
 
     if ($entity->entity_type == 'user') {
diff --git a/profiles/commons/modules/contrib/og/includes/og.field.inc b/profiles/commons/modules/contrib/og/includes/og.field.inc
index 1b11fb1..7f419de 100644
--- a/profiles/commons/modules/contrib/og/includes/og.field.inc
+++ b/profiles/commons/modules/contrib/og/includes/og.field.inc
@@ -31,7 +31,7 @@ function og_field_widget_form(&$form, &$form_state, $field, $instance, $langcode
     return;
   }
 
-  if ($field['settings']['handler'] != 'og') {
+  if ($field['settings']['handler'] != 'og' && strpos($field['settings']['handler'], 'og_') !== 0) {
     $params = array('%label' => $instance['label']);
     form_error($form, t('Field %label is a group-audience but its Entity selection mode is not defined as "Organic groups" in the field settings page.', $params));
     return;
diff --git a/profiles/commons/modules/contrib/og/includes/og.membership.inc b/profiles/commons/modules/contrib/og/includes/og.membership.inc
index 2d4d105..23464e5 100644
--- a/profiles/commons/modules/contrib/og/includes/og.membership.inc
+++ b/profiles/commons/modules/contrib/og/includes/og.membership.inc
@@ -18,6 +18,11 @@ class OgMembership extends Entity {
   public function save() {
     $entity_type = $this->entity_type;
     $etid = $this->etid;
+
+    if ($entity_type == 'user' && !$etid) {
+      throw new OgException('OG membership can not be created for anonymous user.');
+    }
+
     $wrapper = entity_metadata_wrapper($entity_type, $etid);
     $bundle = $wrapper->getBundle();
 
@@ -27,7 +32,6 @@ class OgMembership extends Entity {
     list(,,$group_bundle) = entity_extract_ids($group_type, $group);
 
     $field_name = $this->field_name;
-    $state = !empty($this->state) ? $this->state : OG_STATE_ACTIVE;
 
     // Placeholder for exceptions, in case we need to throw one.
     $params = array(
diff --git a/profiles/commons/modules/contrib/og/includes/views/handlers/og_handler_field_og_membership_link_edit.inc b/profiles/commons/modules/contrib/og/includes/views/handlers/og_handler_field_og_membership_link_edit.inc
new file mode 100644
index 0000000..6b93a66
--- /dev/null
+++ b/profiles/commons/modules/contrib/og/includes/views/handlers/og_handler_field_og_membership_link_edit.inc
@@ -0,0 +1,75 @@
+<?php
+
+/**
+ * @file
+ * Definition of og_handler_field_og_membership_link_edit.
+ */
+
+/**
+ * Field handler to present a link to edit membership.
+ *
+ * @ingroup views_field_handlers
+ */
+class og_handler_field_og_membership_link_edit extends views_handler_field_entity {
+
+  function construct() {
+    parent::construct();
+  }
+
+  function option_definition() {
+    $options = parent::option_definition();
+    $options['text'] = array('default' => '', 'translatable' => TRUE);
+    $options['destination'] = array('default' => FALSE, 'bool' => TRUE);
+    return $options;
+  }
+
+  function options_form(&$form, &$form_state) {
+    $form['text'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Text to display'),
+      '#default_value' => $this->options['text'],
+    );
+    $form['destination'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Use destination'),
+      '#description' => t('Add destination to the link'),
+      '#default_value' => $this->options['destination'],
+      '#fieldset' => 'more',
+    );
+    parent::options_form($form, $form_state);
+  }
+
+  function query() {
+    $this->ensure_my_table();
+    $this->add_additional_fields();
+  }
+
+  function render($values) {
+    $value = $this->get_value($values, 'id');
+    return $this->render_link($this->sanitize_value($value), $values);
+  }
+
+  function render_link($data, $values) {
+    $this->options['alter']['make_link'] = TRUE;
+    $this->options['alter']['html'] = TRUE;
+
+    // Ensure user has access to edit this membership.
+    $og_membership = $this->get_value($values);
+    $group_type = $og_membership->group_type;
+    $gid = $og_membership->gid;
+    if (!og_ui_user_access_group('manage members', $group_type, $gid)) {
+      return;
+    }
+
+    $text = !empty($this->options['text']) ? $this->options['text'] : t('edit');
+    unset($this->options['alter']['fragment']);
+
+    if (!empty($this->options['destination'])) {
+      $this->options['alter']['query'] = drupal_get_destination();
+    }
+
+    $this->options['alter']['path'] = "group/" . $group_type . "/" . $gid  . "/admin/people/edit-membership/" . $og_membership->id;
+
+    return $text;
+  }
+}
diff --git a/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_default_user_groups.inc b/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_default_user_groups.inc
index 6c73ca7..85c6360 100644
--- a/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_default_user_groups.inc
+++ b/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_default_user_groups.inc
@@ -33,7 +33,7 @@ class og_plugin_argument_default_user_groups extends views_plugin_argument_defau
       '#description' => t('Select the group type.'),
       '#options' => og_get_all_group_entity(),
       '#default_value' => $this->options['group_type'],
-      '#required' => TRUE,
+      '#required' => og_get_all_group_entity(),
     );
     $form['glue'] = array(
       '#type' => 'select',
diff --git a/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_validate_group.inc b/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_validate_group.inc
index 6eb027d..a987e8b 100644
--- a/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_validate_group.inc
+++ b/profiles/commons/modules/contrib/og/includes/views/handlers/og_plugin_argument_validate_group.inc
@@ -30,7 +30,7 @@ class og_plugin_argument_validate_group extends views_plugin_argument_validate {
       '#description' => t('Select the group type.'),
       '#options' => og_get_all_group_entity(),
       '#default_value' => $this->options['group_type'],
-      '#required' => TRUE,
+      '#required' => og_get_all_group_entity(),
     );
   }
 
diff --git a/profiles/commons/modules/contrib/og/includes/views/og.views.inc b/profiles/commons/modules/contrib/og/includes/views/og.views.inc
index d2a2d4a..0def1f5 100644
--- a/profiles/commons/modules/contrib/og/includes/views/og.views.inc
+++ b/profiles/commons/modules/contrib/og/includes/views/og.views.inc
@@ -86,6 +86,15 @@ class OgMembershipViewsController extends EntityDefaultViewsController {
       ),
     );
 
+    // Link to edit membership
+    $data['og_membership']['edit_membership'] = array(
+      'field' => array(
+        'title' => t('Edit link'),
+        'help' => t('Provide a simple link to edit the membership.'),
+        'handler' => 'og_handler_field_og_membership_link_edit',
+      ),
+    );
+
     return $data;
   }
 }
diff --git a/profiles/commons/modules/contrib/og/og.api.php b/profiles/commons/modules/contrib/og/og.api.php
index 9a7ba62..d6d73fd 100644
--- a/profiles/commons/modules/contrib/og/og.api.php
+++ b/profiles/commons/modules/contrib/og/og.api.php
@@ -19,7 +19,12 @@ function hook_og_permission() {
     'subscribe' => array(
       'title' => t('Subscribe user to group'),
       'description' => t("Allow user to be a member of a group (approval required)."),
+      // Determine to which role to limit the permission. For example the
+      // "subscribe" can't be assigned only to a non-member, as a member doesn't
+      // need it.
       'roles' => array(OG_ANONYMOUS_ROLE),
+      // Determine to which roles the permissions will be enabled by default.
+      'default role' => array(OG_ANONYMOUS_ROLE),
     ),
   );
 }
diff --git a/profiles/commons/modules/contrib/og/og.info b/profiles/commons/modules/contrib/og/og.info
index fada5d5..2db9149 100644
--- a/profiles/commons/modules/contrib/og/og.info
+++ b/profiles/commons/modules/contrib/og/og.info
@@ -29,6 +29,7 @@ files[] = includes/views/handlers/og_handler_field_group_audience_state.inc
 files[] = includes/views/handlers/og_handler_field_prerender_list.inc
 files[] = includes/views/handlers/og_handler_field_user_roles.inc
 files[] = includes/views/handlers/og_handler_field_group_permissions.inc
+files[] = includes/views/handlers/og_handler_field_og_membership_link_edit.inc
 
 ; Views filters
 files[] = includes/views/handlers/og_handler_filter_group_audience_state.inc
@@ -54,9 +55,9 @@ files[] = includes/migrate/7200/og_user_roles.migrate.inc
 
 
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og.install b/profiles/commons/modules/contrib/og/og.install
index 87375c5..d956d92 100644
--- a/profiles/commons/modules/contrib/og/og.install
+++ b/profiles/commons/modules/contrib/og/og.install
@@ -73,7 +73,7 @@ function og_uninstall() {
         }
         else {
           $field = field_info_field($instance['field_name']);
-          if ($field['type'] == 'entityreference' && $field['settings']['handler'] == 'og') {
+          if ($field['type'] == 'entityreference' && ($field['settings']['handler'] == 'og' || strpos($field['settings']['handler'], 'og_') === 0)) {
             // Last instance will take care also of deleting the field itself.
             field_delete_instance($instance);
           }
diff --git a/profiles/commons/modules/contrib/og/og.module b/profiles/commons/modules/contrib/og/og.module
index b124339..e42cf6d 100644
--- a/profiles/commons/modules/contrib/og/og.module
+++ b/profiles/commons/modules/contrib/og/og.module
@@ -674,7 +674,13 @@ function og_field_create_instance($instance) {
   $og_field = og_fields_info(OG_AUDIENCE_FIELD);
   $og_field['field']['settings']['target_type'] = $entity_type;
   $og_field['instance']['label'] = t('Group membership');
-  og_create_field($field_name, 'user', 'user', $og_field);
+
+  // If the user entity type has multiple bundles, make sure to attach a field
+  // instance to all of them.
+  $entity_info = entity_get_info('user');
+  foreach (array_keys($entity_info['bundles']) as $user_bundle) {
+    og_create_field($field_name, 'user', $user_bundle, $og_field);
+  }
 }
 
 /**
@@ -1187,12 +1193,16 @@ function og_membership_invalidate_cache() {
  *
  * If a group membership already exists, an exception will be thrown.
  *
+ * @param $group_type
+ *   The entity type of the group.
  * @param $gid
- *   The group ID
+ *   The group ID.
  * @param $entity_type
  *   The entity type of the group content.
  * @param $etid
  *   The entity ID of the group content.
+ * @param $field_name
+ *   The group audience field name.
  * @param $values
  *   Optional; Array of fields values to be attached to the OG membership, that
  *   will be processed using entity-metadata wrapper.
@@ -1531,26 +1541,23 @@ function og_membership_delete_multiple($ids = array()) {
 }
 
 /**
- * Implements hook_advanced_queue_info().
+ * Implements hook_cron_queue_info().
  */
-function og_advanced_queue_info() {
+function og_cron_queue_info() {
   $items['og_membership_orphans'] = array(
+    'title' => t('OG orphans'),
     'worker callback' => 'og_membership_orphans_worker',
-    // Message-subscribe will deal itself with deleting claimed items.
-    'delete when completed' => FALSE,
+    'time' => 60,
   );
   return $items;
 }
 
 /**
- * Advanced queue worker; Process a queue item.
+ * Queue worker; Process a queue item.
  *
  * Delete memberships, and if needed all related group-content.
  */
-function og_membership_orphans_worker($item, $end_time = FALSE) {
-  $queue = DrupalQueue::get('og_membership_orphans');
-  $data = $item->data;
-
+function og_membership_orphans_worker($data) {
   $group_type = $data['group_type'];
   $gid = $data['gid'];
 
@@ -1564,23 +1571,21 @@ function og_membership_orphans_worker($item, $end_time = FALSE) {
     ->execute();
 
   if (empty($result['og_membership'])) {
-    // We can delete the item.
-    $queue->deleteItem($item);
-    return TRUE;
+    return;
   }
 
   $ids = array_keys($result['og_membership']);
   if ($data['orphans']['move']) {
     _og_orphans_move($ids, $data['orphans']['move']['group_type'], $data['orphans']['move']['gid']);
-    // Delete the item.
-    $queue->deleteItem($item);
+    $queue = DrupalQueue::get('og_membership_orphans');
+    return $queue->createItem($data);
   }
   elseif ($data['orphans']['delete']) {
     _og_orphans_delete($ids);
-    // Release the item.
-    $queue->releaseItem($item);
+    // Create a new item.
+    $queue = DrupalQueue::get('og_membership_orphans');
+    return $queue->createItem($data);
   }
-  return TRUE;
 }
 
 /**
@@ -1673,10 +1678,21 @@ function og_membership_delete_by_group($entity_type, $entity) {
   }
 
   list($gid) = entity_extract_ids($entity_type, $entity);
-  if (variable_get('og_use_queue', FALSE) && module_exists('advancedqueue')) {
+  $query = new EntityFieldQuery();
+  $result = $query
+    ->entityCondition('entity_type', 'og_membership')
+    ->propertyCondition('group_type', $entity_type, '=')
+    ->propertyCondition('gid', $gid, '=')
+    ->execute();
+
+  if (empty($result['og_membership'])) {
+    return;
+  }
+
+  if (variable_get('og_use_queue', FALSE)) {
     $queue = DrupalQueue::get('og_membership_orphans');
     // Add item to the queue.
-    $task = array(
+    $data = array(
       'group_type' => $entity_type,
       'gid' => $gid,
       // Allow implementing modules to determine the disposition (e.g. delete
@@ -1687,21 +1703,12 @@ function og_membership_delete_by_group($entity_type, $entity) {
       ),
     );
 
-    // Exit now, as the task will be processed via advanced-queue.
-    return $queue->createItem($task);
+    // Exit now, as the task will be processed via queue.
+    return $queue->createItem($data);
   }
 
   // No scalable solution was chosen, so just delete OG memberships.
-  $query = new EntityFieldQuery();
-  $result = $query
-    ->entityCondition('entity_type', 'og_membership')
-    ->propertyCondition('group_type', $entity_type, '=')
-    ->propertyCondition('gid', $gid, '=')
-    ->execute();
-
-  if (!empty($result['og_membership'])) {
-    og_membership_delete_multiple(array_keys($result['og_membership']));
-  }
+  og_membership_delete_multiple(array_keys($result['og_membership']));
 }
 
 /**
@@ -1834,7 +1841,7 @@ function og_get_best_group_audience_field($entity_type, $entity, $group_type, $g
 }
 
 /**
- * Return TRUE if a field can be used and has not reached maxium values.
+ * Return TRUE if a field can be used and has not reached maximum values.
  *
  * @param $entity_type
  *   The entity type.
@@ -2244,7 +2251,7 @@ function og_get_entity_groups($entity_type = 'user', $entity = NULL, $states = a
  */
 function og_is_group_audience_field($field_name) {
   $field = field_info_field($field_name);
-  return $field['type'] == 'entityreference' && $field['settings']['handler'] == 'og';
+  return $field['type'] == 'entityreference' && ($field['settings']['handler'] == 'og' || strpos($field['settings']['handler'], 'og_') === 0);
 }
 
 /**
@@ -2509,6 +2516,9 @@ function og_role_permissions($roles = array()) {
  *   The group might be set to "Default access" but infact there are inactive
  *   group roles. Thus, we are forcing the function to return the overriden
  *   roles. see og_delete_user_roles_by_group().
+ * @param $include_all
+ *   Optional; If TRUE then the anonymous and authenticated default roles will
+ *   be included.
  *
  * @return
  *   An associative array with the role id as the key and the role name as
@@ -3191,10 +3201,7 @@ function og_list_permissions($type) {
     $perms += array(
       "create $type content" => array(
         'title' => t('Create %type_name content', array('%type_name' => $info->name)),
-        // We allow the create permission only on members, as otherwise we would
-        // have to iterate over every single group to decide if the user has
-        // permissions for it.
-        'roles' => array(OG_AUTHENTICATED_ROLE),
+
       ),
       "update own $type content" => array(
         'title' => t('Edit own %type_name content', array('%type_name' => $info->name)),
@@ -3210,6 +3217,13 @@ function og_list_permissions($type) {
       ),
     );
 
+    if (!module_exists('entityreference_prepopulate')) {
+      // We allow the create permission only on members, as otherwise we would
+      // have to iterate over every single group to decide if the user has
+      // permissions for it.
+      $perms["create $type content"]['roles'] = array(OG_AUTHENTICATED_ROLE);
+    }
+
     // Add default permissions.
     foreach ($perms as $key => $value) {
       $perms[$key]['default role'] = array(OG_AUTHENTICATED_ROLE);
@@ -3446,3 +3460,14 @@ function og_migrate_api() {
   );
   return $api;
 }
+
+/**
+ * Implements hook_flush_caches().
+ */
+function og_flush_caches() {
+  $bins = array(
+    'cache_entity_og_membership',
+    'cache_entity_og_membership_type',
+  );
+  return $bins;
+}
diff --git a/profiles/commons/modules/contrib/og/og.test b/profiles/commons/modules/contrib/og/og.test
index 9f78b23..6f31dfa 100644
--- a/profiles/commons/modules/contrib/og/og.test
+++ b/profiles/commons/modules/contrib/og/og.test
@@ -458,6 +458,15 @@ class OgGroupAndUngroup extends DrupalWebTestCase {
     $settings['uid'] = $user2->uid;
     $node = $this->drupalCreateNode($settings);
 
+    // Exception on OG membership for anonymous user.
+    try {
+      og_membership_create('entity_test', $entity1->pid, 'user', 0, OG_AUDIENCE_FIELD)->save();
+      $this->fail('OG membership can be created for anonymous user.');
+    }
+    catch (OgException $e) {
+      $this->pass('OG membership can not be created for anonymous user.');
+    }
+
     $this->assertFalse(og_is_member('entity_test', $entity1->pid, 'node', $node), t('Node is not assigned to group1.'));
     $values = array('entity_type' => 'node', 'entity' => $node);
     og_group('entity_test', $entity1->pid, $values);
@@ -1632,12 +1641,11 @@ class OgDeleteOrphansTestCase extends DrupalWebTestCase {
       'name' => 'OG orphan delete',
       'description' => 'Verifying for deleting orphan group content.',
       'group' => 'Organic groups',
-      'dependencies' => array('advancedqueue'),
     );
   }
 
   function setUp() {
-    parent::setUp('og_test', 'advancedqueue');
+    parent::setUp('og_test');
 
     // Create a group content type.
     $group = $this->drupalCreateContentType();
@@ -1682,7 +1690,7 @@ class OgDeleteOrphansTestCase extends DrupalWebTestCase {
     // Execute manually the queue worker.
     $queue = DrupalQueue::get('og_membership_orphans');
     $item = $queue->claimItem();
-    og_membership_orphans_worker($item);
+    og_membership_orphans_worker($item->data);
 
     // Load the nodes we used during the test.
     $first_node = node_load($first_node->nid);
@@ -1712,7 +1720,7 @@ class OgDeleteOrphansTestCase extends DrupalWebTestCase {
     // Execute manually the queue worker.
     $queue = DrupalQueue::get('og_membership_orphans');
     $item = $queue->claimItem();
-    og_membership_orphans_worker($item);
+    og_membership_orphans_worker($item->data);
 
     // Load the node into a wrapper and verify we moved him to another group.
     $wrapper = entity_metadata_wrapper('node', $first_node->nid);
diff --git a/profiles/commons/modules/contrib/og/og_access/og_access.info b/profiles/commons/modules/contrib/og/og_access/og_access.info
index 011d917..7b2cd33 100644
--- a/profiles/commons/modules/contrib/og/og_access/og_access.info
+++ b/profiles/commons/modules/contrib/og/og_access/og_access.info
@@ -9,9 +9,9 @@ files[] = og_access.install
 
 ; Tests
 files[] = og_access.test
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_context/og_context.info b/profiles/commons/modules/contrib/og/og_context/og_context.info
index 7bf2e17..5f56a7e 100644
--- a/profiles/commons/modules/contrib/og/og_context/og_context.info
+++ b/profiles/commons/modules/contrib/og/og_context/og_context.info
@@ -12,9 +12,9 @@ files[] = includes/views/handlers/og_context_plugin_argument_default_group_conte
 ; Views access plugin
 files[] = includes/views/handlers/og_context_plugin_access_og_perm.inc
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_example/og_example.info b/profiles/commons/modules/contrib/og/og_example/og_example.info
index ff885ea..56d0d0f 100644
--- a/profiles/commons/modules/contrib/og/og_example/og_example.info
+++ b/profiles/commons/modules/contrib/og/og_example/og_example.info
@@ -27,9 +27,9 @@ name = "OG example"
 package = "Features"
 php = "5.2.4"
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_example/og_example.module b/profiles/commons/modules/contrib/og/og_example/og_example.module
index c6d58f6..1fd3024 100644
--- a/profiles/commons/modules/contrib/og/og_example/og_example.module
+++ b/profiles/commons/modules/contrib/og/og_example/og_example.module
@@ -1,3 +1,12 @@
 <?php
 
 include_once('og_example.features.inc');
+
+/**
+ * Implements hook_ctools_plugin_directory().
+ */
+function og_example_ctools_plugin_directory($module, $plugin) {
+  if ($module == 'entityreference') {
+    return "plugins/entityreference/$plugin";
+  }
+}
diff --git a/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/OgExampleSelectionHandler.class.php b/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/OgExampleSelectionHandler.class.php
new file mode 100644
index 0000000..52ac0dd
--- /dev/null
+++ b/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/OgExampleSelectionHandler.class.php
@@ -0,0 +1,62 @@
+<?php
+
+
+/**
+ * @file
+ * OG example selection handler.
+ */
+
+class OgExampleSelectionHandler extends OgSelectionHandler {
+
+  /**
+   * Overrides OgSelectionHandler::getInstance().
+   */
+  public static function getInstance($field, $instance = NULL, $entity_type = NULL, $entity = NULL) {
+    return new OgExampleSelectionHandler($field, $instance, $entity_type, $entity);
+  }
+
+  /**
+   * Overrides OgSelectionHandler::buildEntityFieldQuery().
+   *
+   * This is an example of "subgroups" (but without getting into the logic of
+   * sub-grouping).
+   * The idea here is to show we can set "My groups" and "Other groups" to
+   * reference different groups by different
+   * logic. In this example, all group nodes below node ID 5, will appear under
+   * "My groups", and the rest will appear under "Other groups",
+   * for administrators.
+   */
+  public function buildEntityFieldQuery($match = NULL, $match_operator = 'CONTAINS') {
+    $group_type = $this->field['settings']['target_type'];
+
+
+    if (empty($this->instance['field_mode']) || $group_type != 'node') {
+      return parent::buildEntityFieldQuery($match, $match_operator);
+    }
+
+    $field_mode = $this->instance['field_mode'];
+    $handler = EntityReference_SelectionHandler_Generic::getInstance($this->field, $this->instance, $this->entity_type, $this->entity);
+    $query = $handler->buildEntityFieldQuery($match, $match_operator);
+
+    // Show only the entities that are active groups.
+    $query->fieldCondition(OG_GROUP_FIELD, 'value', 1, '=');
+
+    if ($field_mode == 'default') {
+      $query->propertyCondition('nid', '5', '<=');
+    }
+    else {
+      $query->propertyCondition('nid', '5', '>');
+    }
+
+    // FIXME: http://drupal.org/node/1325628
+    unset($query->tags['node_access']);
+
+    // FIXME: drupal.org/node/1413108
+    unset($query->tags['entityreference']);
+
+    $query->addTag('entity_field_access');
+    $query->addTag('og');
+
+    return $query;
+  }
+}
diff --git a/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/og_example.inc b/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/og_example.inc
new file mode 100644
index 0000000..5f6e37c
--- /dev/null
+++ b/profiles/commons/modules/contrib/og/og_example/plugins/entityreference/selection/og_example.inc
@@ -0,0 +1,7 @@
+<?php
+
+$plugin = array(
+  'title' => t('Organic groups example'),
+  'class' => 'OgExampleSelectionHandler',
+);
+
diff --git a/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info b/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
index 2aa8f5c..5aec3b2 100644
--- a/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
+++ b/profiles/commons/modules/contrib/og/og_field_access/og_field_access.info
@@ -8,9 +8,9 @@ files[] = og_field_access.module
 ; Tests
 files[] = og_field_access.test
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_register/og_register.info b/profiles/commons/modules/contrib/og/og_register/og_register.info
index 1d04f1e..fdd55d1 100644
--- a/profiles/commons/modules/contrib/og/og_register/og_register.info
+++ b/profiles/commons/modules/contrib/og/og_register/og_register.info
@@ -6,9 +6,9 @@ dependencies[] = og
 core = 7.x
 files[] = og_register.module
 files[] = og_register.install
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_ui/includes/views/og_ui.views_default.inc b/profiles/commons/modules/contrib/og/og_ui/includes/views/og_ui.views_default.inc
index bb6cc3a..fbf56f4 100644
--- a/profiles/commons/modules/contrib/og/og_ui/includes/views/og_ui.views_default.inc
+++ b/profiles/commons/modules/contrib/og/og_ui/includes/views/og_ui.views_default.inc
@@ -209,6 +209,14 @@ function og_ui_views_default_views() {
   $handler->display->display_options['fields']['og_membership_request']['table'] = 'field_data_og_membership_request';
   $handler->display->display_options['fields']['og_membership_request']['field'] = 'og_membership_request';
   $handler->display->display_options['fields']['og_membership_request']['relationship'] = 'og_membership_rel';
+  /* Field: OG membership: Edit link */
+  $handler->display->display_options['fields']['edit_membership']['id'] = 'edit_membership';
+  $handler->display->display_options['fields']['edit_membership']['table'] = 'og_membership';
+  $handler->display->display_options['fields']['edit_membership']['field'] = 'edit_membership';
+  $handler->display->display_options['fields']['edit_membership']['relationship'] = 'og_membership_rel';
+  $handler->display->display_options['fields']['edit_membership']['label'] = '';
+  $handler->display->display_options['fields']['edit_membership']['element_label_colon'] = FALSE;
+  $handler->display->display_options['fields']['edit_membership']['destination'] = TRUE;
   /* Sort criterion: User: Name */
   $handler->display->display_options['sorts']['name']['id'] = 'name';
   $handler->display->display_options['sorts']['name']['table'] = 'users';
@@ -265,4 +273,4 @@ function og_ui_views_default_views() {
   $views[$view->name] = $view;
 
   return $views;
-}
\ No newline at end of file
+}
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.admin.inc b/profiles/commons/modules/contrib/og/og_ui/og_ui.admin.inc
index 8657b82..52bc0e7 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.admin.inc
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.admin.inc
@@ -76,9 +76,8 @@ function og_ui_admin_settings($form_state) {
   $form['og_use_queue'] = array(
     '#type' => 'checkbox',
     '#title' => t('Use queue'),
-    '#description' => t('Use <a href="@url">Advanced queue</a> module to process operations such as deleting memberships when groups are deleted.', array('@url' => 'http://drupal.org/project/advancedqueue')),
+    '#description' => t("Use the core's queue process to operations such as deleting memberships when groups are deleted."),
     '#default_value' => variable_get('og_use_queue', FALSE),
-    '#disabled' => !module_exists('advancedqueue'),
   );
 
   $form['og_orphans_delete'] = array(
@@ -86,7 +85,6 @@ function og_ui_admin_settings($form_state) {
     '#title' => t('Delete orphans'),
     '#description' => t('Delete "Orphan" group-content (not including useres), when the group is deleted.'),
     '#default_value' => variable_get('og_orphans_delete', FALSE),
-    '#disabled' => !module_exists('advancedqueue'),
     '#states' => array(
       'visible' => array(
         ':input[name="og_use_queue"]' => array('checked' => TRUE),
@@ -134,6 +132,7 @@ function og_ui_add_users($form, &$form_state, $group_type, $gid) {
   og_set_breadcrumb($group_type, $gid, array(l(t('Group'), "$group_type/$gid/group")));
   $group = entity_load_single($group_type, $gid);
   $label = entity_label($group_type, $group);
+  list(,, $bundle) = entity_extract_ids($group_type, $group);
 
   $form['group_type'] = array('#type' => 'value', '#value' => $group_type);
   $form['gid'] = array('#type' => 'value', '#value' => $gid);
@@ -154,6 +153,15 @@ function og_ui_add_users($form, &$form_state, $group_type, $gid) {
     '#value' => OG_STATE_ACTIVE,
   );
 
+  // Get all the non-default roles.
+  if ($og_roles = og_roles($group_type, $bundle, $gid, FALSE, FALSE)) {
+    $form['og_user']['roles'] = array(
+      '#type' => 'checkboxes',
+      '#options' => $og_roles,
+      '#title' => t('Roles'),
+    );
+  }
+
   $field_names = og_get_group_audience_fields();
   $field_name = !empty($form_state['values']['field_name']) ? $form_state['values']['field_name'] : key($field_names);
 
@@ -254,11 +262,107 @@ function og_ui_add_users_submit($form, &$form_state) {
   $og_membership->etid = $account->uid;
   $og_membership->state = $state;
   $og_membership->save();
-  $group = node_load($gid);
-  drupal_set_message(t('%user has been added to the group %group-title.', array('%user' => format_username($account), '%group-title' => $group->title)));
+  // Assign roles.
+  if (!empty($form_state['values']['roles'])) {
+    foreach ($form_state['values']['roles'] as $rid) {
+      og_role_grant($group_type, $gid, $og_membership->etid, $rid);
+    }
+  }
+
+  $group = entity_load_single($group_type, $gid);
+  drupal_set_message(t('%user has been added to the group %group-title.', array('%user' => format_username($account), '%group-title' => entity_label($group_type, $group))));
 }
 
 /**
+ * Add Edit membership form.
+ */
+function og_ui_edit_membership($form, &$form_state, $group_type, $gid, $og_membership) {
+  og_set_breadcrumb($group_type, $gid, array(l(t('Group'), "$group_type/$gid/group")));
+  $group = entity_load_single($group_type, $gid);
+  $label = entity_label($group_type, $group);
+  $account = user_load($og_membership->etid);
+  list(,, $bundle) = entity_extract_ids($group_type, $group);
+  // Get all the non-default roles.
+  $og_roles = og_roles($group_type, $bundle, $gid, FALSE, FALSE);
+
+  $form['group_type'] = array('#type' => 'value', '#value' => $group_type);
+  $form['gid'] = array('#type' => 'value', '#value' => $gid);
+  $form['id'] = array('#type' => 'value', '#value' => $og_membership->id);
+
+  $form['og_user'] = array(
+    '#type' => 'fieldset',
+    '#title' => t('Edit a group membership in %group', array('%group' => $label)),
+  );
+  $form['og_user']['name'] = array(
+    '#type' => 'markup',
+    '#title' => t('User name'),
+    '#markup' => $account->name,
+  );
+  if ($og_roles) {
+    $form['og_user']['roles'] = array(
+      '#type' => 'checkboxes',
+      '#options' => $og_roles,
+      '#title' => t('Roles'),
+      '#default_value' => array_keys(og_get_user_roles($group_type, $gid, $account->uid)),
+    );
+  }
+
+ // Add group membership form.
+  $values = array();
+
+  // Add group membership form. We still don't have the user or state.
+  $form_state['og_membership'] = $og_membership;
+
+  $form['membership_fields'] = array(
+    '#prefix' => '<div id="og-ui-field-name">',
+    '#suffix' => '</div>',
+    '#tree' => TRUE,
+    '#parents' => array('membership_fields'),
+  );
+  field_attach_form('og_membership', $og_membership, $form['membership_fields'], $form_state);
+
+  $form['actions'] = array('#type' => 'actions');
+  $form['actions']['submit'] = array('#type' => 'submit', '#value' => t('Update membership'));
+
+  return $form;
+}
+
+/**
+ * Validate handler; Edit membership in group.
+ */
+function og_ui_edit_membership_validate($form, &$form_state) {
+  $og_membership = $form_state['og_membership'];
+  field_attach_form_validate('og_membership', $og_membership, $form['membership_fields'], $form_state);
+}
+
+/**
+ * Submit handler; Edit membership in group.
+ */
+function og_ui_edit_membership_submit($form, &$form_state) {
+  $group_type = $form_state['values']['group_type'];
+  $gid = $form_state['values']['gid'];
+  $og_membership = $form_state['og_membership'];
+  field_attach_submit('og_membership', $og_membership, $form['membership_fields'], $form_state);
+  $og_membership->save();
+  $account = user_load($og_membership->etid);
+  // Assign roles.
+  $og_roles = og_get_user_roles($group_type, $gid, $account->uid);
+  foreach (array_keys($og_roles) as $rid) {
+    if (!in_array($rid, $form_state['values']['roles'])) {
+      og_role_revoke($group_type, $gid, $account->uid, $rid);
+    }
+  }
+  if (!empty($form_state['values']['roles'])) {
+    foreach ($form_state['values']['roles'] as $rid) {
+      og_role_grant($group_type, $gid, $og_membership->etid, $rid);
+    }
+  }
+  drupal_set_message(t('The membership has been updated.'));
+}
+
+
+
+/**
  * Form builder; OG user administration page.
  */
 function og_ui_admin_account($group_type, $gid) {
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.info b/profiles/commons/modules/contrib/og/og_ui/og_ui.info
index e8667f5..5d25be6 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.info
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.info
@@ -16,9 +16,9 @@ files[] = includes/migrate/7000/add_field.inc
 files[] = includes/migrate/7000/populate_field.inc
 files[] = includes/migrate/7000/set_roles.inc
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.module b/profiles/commons/modules/contrib/og/og_ui/og_ui.module
index 98cf98a..6fda0ef 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.module
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.module
@@ -58,6 +58,18 @@ function og_ui_menu() {
     'file' => 'og_ui.admin.inc',
   );
 
+  // User listing pages.
+  $items['group/%/%/admin/people/edit-membership/%og_membership'] = array(
+    'title callback' => 'og_ui_menu_title_callback',
+    'title arguments' => array('Edit membership in group @group', 1, 2),
+    'type' => MENU_CALLBACK,
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('og_ui_edit_membership', 1, 2, 6),
+    'access callback' => 'og_ui_user_access_group',
+    'access arguments' => array('manage members', 1, 2),
+    'file' => 'og_ui.admin.inc',
+  );
+
   // Permission administration pages.
   $items['group/%/%/admin/roles'] = array(
     'title callback' => 'og_ui_menu_title_callback',
@@ -574,7 +586,7 @@ function og_ui_field_formatter_view($entity_type, $entity, $field, $instance, $l
         return;
       }
 
-      if (!empty($entity->uid) && ($entity->uid == $user->uid)) {
+      if (!empty($entity->uid) && ($entity->uid == $account->uid)) {
         // User is the group manager.
         $element[0] = array('#markup' => t('You are the group manager'));
         return $element;
@@ -595,7 +607,7 @@ function og_ui_field_formatter_view($entity_type, $entity, $field, $instance, $l
         }
 
         // Check if user can subscribe to the field.
-        if (empty($settings['field_name']) && $audience_field_name = og_get_best_group_audience_field('user', $user->uid, $entity_type, $bundle)) {
+        if (empty($settings['field_name']) && $audience_field_name = og_get_best_group_audience_field('user', $account, $entity_type, $bundle)) {
           $settings['field_name'] = $audience_field_name;
         }
         if (!$settings['field_name']) {
@@ -614,7 +626,7 @@ function og_ui_field_formatter_view($entity_type, $entity, $field, $instance, $l
           return;
         }
 
-        if (!og_check_field_cardinality('user', $user->uid, $settings['field_name'])) {
+        if (!og_check_field_cardinality('user', $account, $settings['field_name'])) {
           $element[0] = array('#markup' => format_plural($field_info['cardinality'], 'You are already registered to another group', 'You are already registered to @count groups'));
           return $element;
         }
diff --git a/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc b/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
index ee600cd..db30d4f 100644
--- a/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
+++ b/profiles/commons/modules/contrib/og/og_ui/og_ui.pages.inc
@@ -114,6 +114,7 @@ function og_ui_subscribe($entity_type, $etid, $field_name = NULL) {
     // Show the user a subscription confirmation.
     return drupal_get_form('og_ui_confirm_subscribe', $entity_type, $id, $user, $field_name);
   }
+  drupal_access_denied();
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
index 68f0247..4d67801 100644
--- a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
+++ b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgBehaviorHandler.class.php
@@ -9,7 +9,7 @@ class OgBehaviorHandler extends EntityReference_BehaviorHandler_Abstract {
    * Implements EntityReference_BehaviorHandler_Abstract::access().
    */
   public function access($field, $instance) {
-    return $field['settings']['handler'] == 'og';
+    return $field['settings']['handler'] == 'og' || strpos($field['settings']['handler'], 'og_') === 0;
   }
 
   /**
diff --git a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgWidgetHandler.class.php b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgWidgetHandler.class.php
index dcd04c3..85c2659 100644
--- a/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgWidgetHandler.class.php
+++ b/profiles/commons/modules/contrib/og/plugins/entityreference/behavior/OgWidgetHandler.class.php
@@ -6,7 +6,7 @@
 class OgWidgetHandler extends EntityReference_BehaviorHandler_Abstract {
 
   public function access($field, $instance) {
-    return $field['settings']['handler'] == 'og' && $instance['widget']['type'] == 'og_complex';
+    return ($field['settings']['handler'] == 'og' || strpos($field['settings']['handler'], 'og_') === 0) && $instance['widget']['type'] == 'og_complex';
   }
 
   /**
diff --git a/profiles/commons/modules/contrib/og/plugins/entityreference/selection/OgSelectionHandler.class.php b/profiles/commons/modules/contrib/og/plugins/entityreference/selection/OgSelectionHandler.class.php
index 54e6c1a..801d4d4 100644
--- a/profiles/commons/modules/contrib/og/plugins/entityreference/selection/OgSelectionHandler.class.php
+++ b/profiles/commons/modules/contrib/og/plugins/entityreference/selection/OgSelectionHandler.class.php
@@ -147,6 +147,10 @@ class OgSelectionHandler extends EntityReference_SelectionHandler_Generic {
 
     $field_mode = $this->instance['field_mode'];
     $user_groups = og_get_groups_by_user(NULL, $group_type);
+    $user_groups = $user_groups ? $user_groups : array();
+    $user_groups = array_merge($user_groups, $this->getGidsForCreate());
+
+
     // Show the user only the groups they belong to.
     if ($field_mode == 'admin' && $user_groups) {
       // Show only groups the user doesn't belong to.
@@ -172,4 +176,32 @@ class OgSelectionHandler extends EntityReference_SelectionHandler_Generic {
     // FIXME: Allow altering, after fixing http://drupal.org/node/1413108
     // $handler->entityFieldQueryAlter($query);
   }
+
+  /**
+   * Get group IDs from URL or OG-context, with access to create group-content.
+   *
+   * @return
+   *   Array with group IDs a user (member or non-member) is allowed to
+   * create, or empty array.
+   */
+  private function getGidsForCreate() {
+    if ($this->instance['entity_type'] != 'node') {
+      return array();
+    }
+
+    if (!module_exists('entityreference_prepopulate') || empty($this->instance['settings']['behaviors']['prepopulate'])) {
+      return array();
+    }
+    // Don't try to validate the IDs.
+    if (!$ids = entityreference_prepopulate_get_values($this->field, $this->instance, TRUE, FALSE)) {
+      return array();
+    }
+    $node_type = $this->instance['bundle'];
+    foreach ($ids as $delta => $id) {
+      if (!is_numeric($id) || !$id || !og_user_access('node', $id, "create $node_type content")) {
+        unset($ids[$delta]);
+      }
+    }
+    return $ids;
+  }
 }
diff --git a/profiles/commons/modules/contrib/og/tests/og_test.info b/profiles/commons/modules/contrib/og/tests/og_test.info
index a67e9f4..91bea9f 100644
--- a/profiles/commons/modules/contrib/og/tests/og_test.info
+++ b/profiles/commons/modules/contrib/og/tests/og_test.info
@@ -4,9 +4,9 @@ core = 7.x
 dependencies[] = og
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-18
-version = "7.x-2.0"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.1"
 core = "7.x"
 project = "og"
-datestamp = "1361203341"
+datestamp = "1364376614"
 
diff --git a/profiles/commons/modules/contrib/quicktabs/quicktabs.info b/profiles/commons/modules/contrib/quicktabs/quicktabs.info
index 35ec7fc..9843d86 100644
--- a/profiles/commons/modules/contrib/quicktabs/quicktabs.info
+++ b/profiles/commons/modules/contrib/quicktabs/quicktabs.info
@@ -8,9 +8,10 @@ files[] = tests/quicktabs.test
 configure = admin/structure/quicktabs
 dependencies[] = "ctools"
 
-; Information added by drupal.org packaging script on 2012-11-23
+
+; Information added by drush on 2013-03-28
 version = "7.x-3.4+2-dev"
 core = "7.x"
 project = "quicktabs"
-datestamp = "1353633326"
+datestamp = "1364431822"
 
diff --git a/profiles/commons/modules/contrib/quicktabs/quicktabs_tabstyles/quicktabs_tabstyles.info b/profiles/commons/modules/contrib/quicktabs/quicktabs_tabstyles/quicktabs_tabstyles.info
index f001347..ac7ec21 100644
--- a/profiles/commons/modules/contrib/quicktabs/quicktabs_tabstyles/quicktabs_tabstyles.info
+++ b/profiles/commons/modules/contrib/quicktabs/quicktabs_tabstyles/quicktabs_tabstyles.info
@@ -3,9 +3,10 @@ description = Adds predefined tab styles to choose from per Quicktabs instance.
 core = 7.x
 configure=admin/structure/quicktabs/styles
 dependencies[] = "quicktabs"
-; Information added by drupal.org packaging script on 2012-11-23
+
+; Information added by drush on 2013-03-28
 version = "7.x-3.4+2-dev"
 core = "7.x"
 project = "quicktabs"
-datestamp = "1353633326"
+datestamp = "1364431822"
 
diff --git a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
index 7963624..d96f784 100644
--- a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
+++ b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
@@ -11,9 +11,10 @@ features[radioactivity_decay_profile][] = default_daily
 features[radioactivity_decay_profile][] = default_now
 features[radioactivity_decay_profile][] = default_weekly
 
-; Information added by drupal.org packaging script on 2013-02-07
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1360243991"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/radioactivity/radioactivity.info b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
index 664e651..aebc56d 100644
--- a/profiles/commons/modules/contrib/radioactivity/radioactivity.info
+++ b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
@@ -12,9 +12,10 @@ files[] = includes/RadioactivityFileIncidentStorage.inc
 files[] = includes/RadioactivityMemcachedIncidentStorage.inc
 files[] = includes/RadioactivityIncident.inc
 
-; Information added by drupal.org packaging script on 2013-02-07
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1360243991"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/registration/modules/registration_entity_access/registration_entity_access.info b/profiles/commons/modules/contrib/registration/modules/registration_entity_access/registration_entity_access.info
index d780cbf..367397d 100644
--- a/profiles/commons/modules/contrib/registration/modules/registration_entity_access/registration_entity_access.info
+++ b/profiles/commons/modules/contrib/registration/modules/registration_entity_access/registration_entity_access.info
@@ -6,9 +6,9 @@ core = 7.x
 dependencies[] = registration
 
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+3-dev"
 core = "7.x"
 project = "registration"
-datestamp = "1361827561"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/registration/modules/registration_views/registration_views.info b/profiles/commons/modules/contrib/registration/modules/registration_views/registration_views.info
index ccd11bc..dd70c76 100644
--- a/profiles/commons/modules/contrib/registration/modules/registration_views/registration_views.info
+++ b/profiles/commons/modules/contrib/registration/modules/registration_views/registration_views.info
@@ -19,9 +19,9 @@ files[] = includes/registration_handler_field_entity_settings_link.inc
 files[] = includes/registration_handler_field_entity_registration_status.inc
 
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+3-dev"
 core = "7.x"
 project = "registration"
-datestamp = "1361827561"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/registration/modules/registration_waitlist/registration_waitlist.info b/profiles/commons/modules/contrib/registration/modules/registration_waitlist/registration_waitlist.info
index 8922702..df4596e 100644
--- a/profiles/commons/modules/contrib/registration/modules/registration_waitlist/registration_waitlist.info
+++ b/profiles/commons/modules/contrib/registration/modules/registration_waitlist/registration_waitlist.info
@@ -8,9 +8,9 @@ dependencies[] = registration
 files[] = registration_waitlist.test
 
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+3-dev"
 core = "7.x"
 project = "registration"
-datestamp = "1361827561"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/registration/registration.info b/profiles/commons/modules/contrib/registration/registration.info
index 5a82334..a8eed6d 100644
--- a/profiles/commons/modules/contrib/registration/registration.info
+++ b/profiles/commons/modules/contrib/registration/registration.info
@@ -16,9 +16,9 @@ files[] = lib/registration_type.ui_controller.inc
 
 
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+3-dev"
 core = "7.x"
 project = "registration"
-datestamp = "1361827561"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/registration/tests/registration_test_api/registration_test_api.info b/profiles/commons/modules/contrib/registration/tests/registration_test_api/registration_test_api.info
index cb26071..bd9da04 100644
--- a/profiles/commons/modules/contrib/registration/tests/registration_test_api/registration_test_api.info
+++ b/profiles/commons/modules/contrib/registration/tests/registration_test_api/registration_test_api.info
@@ -6,9 +6,9 @@ core = 7.x
 dependencies[] = registration
 hidden = TRUE
 
-; Information added by drush on 2013-02-25
+; Information added by drush on 2013-03-28
 version = "7.x-1.0+3-dev"
 core = "7.x"
 project = "registration"
-datestamp = "1361827561"
+datestamp = "1364431821"
 
diff --git a/profiles/commons/modules/contrib/rules/includes/rules.upgrade.inc b/profiles/commons/modules/contrib/rules/includes/rules.upgrade.inc
index 863f53e..e70d3ec 100644
--- a/profiles/commons/modules/contrib/rules/includes/rules.upgrade.inc
+++ b/profiles/commons/modules/contrib/rules/includes/rules.upgrade.inc
@@ -190,8 +190,8 @@ function rules_upgrade_convert_rule_set($name, $cfg_old) {
   $config = rules_plugin_factory('rule set');
   $config->name = $name;
   foreach (array('label', 'weight') as $key) {
-    if (isset($element[$key])) {
-      $target->$key = $element[$key];
+    if (isset($cfg_old[$key])) {
+      $config->$key = $cfg_old[$key];
     }
   }
   if (isset($cfg_old['arguments'])) {
diff --git a/profiles/commons/modules/contrib/rules/modules/data.eval.inc b/profiles/commons/modules/contrib/rules/modules/data.eval.inc
index 341f0d3..5370e70 100644
--- a/profiles/commons/modules/contrib/rules/modules/data.eval.inc
+++ b/profiles/commons/modules/contrib/rules/modules/data.eval.inc
@@ -74,7 +74,8 @@ function rules_action_data_calc($input1, $op, $input2, $settings, $state, $eleme
   }
   if (isset($result)) {
     // Ensure results are valid integer values if necessary.
-    $var_info = rules_array_key($element->providesVariables());
+    $variables = $element->providesVariables();
+    $var_info = reset($variables);
     if ($var_info['type'] == 'integer') {
       $result = (int) $result;
     }
diff --git a/profiles/commons/modules/contrib/rules/modules/entity.eval.inc b/profiles/commons/modules/contrib/rules/modules/entity.eval.inc
index 6ae5331..0f4c36a 100644
--- a/profiles/commons/modules/contrib/rules/modules/entity.eval.inc
+++ b/profiles/commons/modules/contrib/rules/modules/entity.eval.inc
@@ -141,14 +141,14 @@ function rules_action_entity_delete($wrapper, $settings, $state, $element) {
  * Condition: Entity is new.
  */
 function rules_condition_entity_is_new($wrapper, $settings, $state, $element) {
-  return !$wrapper->getIdentifier() || !empty($entity->is_new);
+  return !$wrapper->getIdentifier() || !empty($wrapper->value()->is_new);
 }
 
 /**
  * Condition: Entity has field.
  */
 function rules_condition_entity_has_field($wrapper, $field_name, $settings, $state) {
-  return isset($wrapper->$field_name) || isset($entity->$field_name);
+  return isset($wrapper->$field_name) || isset($wrapper->value()->$field_name);
 }
 
 /**
@@ -157,3 +157,18 @@ function rules_condition_entity_has_field($wrapper, $field_name, $settings, $sta
 function rules_condition_entity_is_of_type($wrapper, $type) {
   return $wrapper->type() == $type;
 }
+
+/**
+ * Condition: Entity is of type and bundle.
+ */
+function rules_condition_entity_is_of_bundle($wrapper, $type, $bundles) {
+  return $wrapper->type() == $type && in_array($wrapper->getBundle(), $bundles);
+}
+
+/**
+ * Condition: User has access to field.
+ */
+function rules_condition_entity_field_access(EntityDrupalWrapper $wrapper, $field_name, $op, $account = NULL) {
+  $field = field_info_field($field_name);
+  return !empty($field) && field_access($op, $field, $wrapper->type(), $wrapper->value(), $account = NULL);
+}
diff --git a/profiles/commons/modules/contrib/rules/modules/entity.rules.inc b/profiles/commons/modules/contrib/rules/modules/entity.rules.inc
index 4d16907..76ec4ee 100644
--- a/profiles/commons/modules/contrib/rules/modules/entity.rules.inc
+++ b/profiles/commons/modules/contrib/rules/modules/entity.rules.inc
@@ -269,6 +269,23 @@ function rules_entity_type_options($key = NULL) {
 }
 
 /**
+ * Options list callback for getting a list of possible entity bundles.
+ *
+ * @param $element
+ *   The element to return options for.
+ */
+function rules_entity_bundle_options(RulesAbstractPlugin $element) {
+  $bundles = array();
+  if (isset($element->settings['type'])) {
+    $entity_info = entity_get_info($element->settings['type']);
+    foreach ($entity_info['bundles'] as $bundle_name => $bundle_info) {
+      $bundles[$bundle_name] = $bundle_info['label'];
+    }
+  }
+  return $bundles;
+}
+
+/**
  * Entity actions access callback.
  *
  * Returns TRUE if at least one type is available for configuring the action.
@@ -348,6 +365,69 @@ function rules_entity_condition_info() {
       'group' => t('Entities'),
       'base' => 'rules_condition_entity_is_of_type',
     ),
+    'entity_is_of_bundle' => array(
+      'label' => t('Entity is of bundle'),
+      'parameter' => array(
+        'entity' => array(
+          'type' => 'entity',
+          'label' => t('Entity'),
+          'description' => t('Specifies the entity for which to evaluate the condition.'),
+        ),
+        'type' => array(
+          'type' => 'token',
+          'label' => t('Entity type'),
+          'description' => t('The type of the checked entity.'),
+          'options list' => 'rules_entity_action_type_options',
+          'restriction' => 'input',
+        ),
+        'bundle' => array(
+          'type' => 'list<text>',
+          'label' => t('Entity bundle'),
+          'description' => t('The condition is met if the entity is of one of the selected bundles.'),
+          'options list' => 'rules_entity_bundle_options',
+          'restriction' => 'input',
+        ),
+      ),
+      'group' => t('Entities'),
+      'base' => 'rules_condition_entity_is_of_bundle',
+    ),
+    'entity_field_access' => array(
+      'label' => t('User has field access'),
+      'parameter' => array(
+        'entity' => array(
+          'type' => 'entity',
+          'label' => t('Entity'),
+          'description' => t('Specifies the entity for which to evaluate the condition.'),
+          'restriction' => 'selector',
+          'wrapped' => TRUE,
+        ),
+        'field' => array(
+          'type' => 'token',
+          'label' => t('Field name'),
+          'description' => t('The name of the field to check for.'),
+          'options list' => 'rules_condition_entity_has_field_options',
+          'restriction' => 'input',
+        ),
+        'op' => array(
+          'type' => 'text',
+          'label' => t('Access operation'),
+          'options list' => 'rules_condition_entity_field_access_op_options',
+          'restriction' => 'input',
+          'optional' => TRUE,
+          'default value' => 'view',
+        ),
+        'account' => array(
+          'type' => 'user',
+          'label' => t('User account'),
+          'description' => t('Specifies the user account for which to check access. If left empty, the currently logged in user will be used.'),
+          'restriction' => 'selector',
+          'optional' => TRUE,
+          'default value' => NULL,
+        ),
+      ),
+      'group' => t('Entities'),
+      'base' => 'rules_condition_entity_field_access',
+    ),
   );
 }
 
@@ -370,6 +450,16 @@ function rules_condition_entity_has_field_options(RulesAbstractPlugin $element)
 }
 
 /**
+ * Returns options for choosing a field_access() operation.
+ */
+function rules_condition_entity_field_access_op_options(RulesAbstractPlugin $element) {
+  return array(
+    'view' => t('View'),
+    'edit' => t('Edit'),
+  );
+}
+
+/**
  * Assert that the entity has the field, if there is metadata for the field.
  */
 function rules_condition_entity_has_field_assertions($element) {
@@ -397,5 +487,80 @@ function rules_condition_entity_is_of_type_assertions($element) {
 }
 
 /**
+ * Assert the selected entity type and bundle.
+ */
+function rules_condition_entity_is_of_bundle_assertions($element) {
+  if ($bundle = $element->settings['bundle']) {
+    $assertions = array();
+    $assertions['entity']['type'] = $element->settings['type'];
+    $assertions['entity']['bundle'] = $bundle;
+    return $assertions;
+  }
+}
+
+/**
+ * Process callback for the condition entity_is_of_bundle.
+ */
+function rules_condition_entity_is_of_bundle_process(RulesAbstractPlugin $element) {
+  // If we know the entity type, auto-populate it.
+  if (($info = $element->getArgumentInfo('entity')) && $info['type'] != 'entity') {
+    $element->settings['type'] = $info['type'];
+  }
+}
+
+/**
+ * Form alter callback for the condition entity_is_of_bundle.
+ *
+ * Use multiple steps to configure the condition as the needed bundle field list
+ * depends on the selected entity type.
+ */
+function rules_condition_entity_is_of_bundle_form_alter(&$form, &$form_state, $options, RulesAbstractPlugin $element) {
+  if (empty($element->settings['entity:select'])) {
+    $step = 1;
+  }
+  elseif (empty($element->settings['type'])) {
+    $step = 2;
+  }
+  else {
+    $step = 3;
+  }
+
+  $form['reload'] = array(
+    '#weight' => $form['submit']['#weight'] + 1,
+    '#type' => 'submit',
+    '#name' => 'reload',
+    '#value' => $step != 3 ? t('Continue') : t('Reload form'),
+    '#limit_validation_errors' => array(array('parameter', 'entity'), array('parameter', 'type')),
+    '#submit' => array('rules_form_submit_rebuild'),
+    '#ajax' => rules_ui_form_default_ajax('fade'),
+    '#attributes' => array('class' => array('rules-hide-js')),
+  );
+  // Use ajax and trigger as the reload button.
+  $form['parameter']['type']['settings']['type']['#ajax'] = $form['reload']['#ajax'] + array(
+    'event' => 'change',
+    'trigger_as' => array('name' => 'reload'),
+  );
+
+  switch ($step) {
+    case 1:
+      $form['reload']['#limit_validation_errors'] = array(array('parameter', 'entity'));
+      unset($form['parameter']['type']);
+      unset($form['reload']['#attributes']['class']);
+      // NO break;
+    case 2:
+      $form['negate']['#access'] = FALSE;
+      unset($form['parameter']['bundle']);
+      unset($form['submit']);
+      break;
+    case 3:
+      if (($info = $element->getArgumentInfo('entity')) && $info['type'] != 'entity') {
+        // Hide the entity type parameter if not needed.
+        unset($form['parameter']['type']);
+      }
+      break;
+  }
+}
+
+/**
  * @}
  */
diff --git a/profiles/commons/modules/contrib/rules/modules/rules_core.rules.inc b/profiles/commons/modules/contrib/rules/modules/rules_core.rules.inc
index 81c0d0d..9edf446 100644
--- a/profiles/commons/modules/contrib/rules/modules/rules_core.rules.inc
+++ b/profiles/commons/modules/contrib/rules/modules/rules_core.rules.inc
@@ -27,11 +27,13 @@ function rules_rules_core_data_info() {
     'text' => array(
       'label' => t('text'),
       'ui class' => 'RulesDataUIText',
+      'token type' => 'rules_text',
     ),
-   'token' => array(
+    'token' => array(
       'label' => t('text token'),
       'parent' => 'text',
       'ui class' => 'RulesDataUITextToken',
+      'token type' => 'rules_token',
     ),
     // A formatted text as used by entity metadata.
     'text_formatted' => array(
@@ -40,49 +42,55 @@ function rules_rules_core_data_info() {
       'wrap' => TRUE,
       'property info' => entity_property_text_formatted_info(),
     ),
-   'decimal' => array(
+    'decimal' => array(
       'label' => t('decimal number'),
       'parent' => 'text',
       'ui class' => 'RulesDataUIDecimal',
+      'token type' => 'rules_decimal',
     ),
-   'integer' => array(
+    'integer' => array(
       'label' => t('integer'),
       'class' => 'RulesIntegerWrapper',
       'parent' => 'decimal',
       'ui class' => 'RulesDataUIInteger',
+      'token type' => 'rules_integer',
     ),
-   'date' => array(
+    'date' => array(
       'label' => t('date'),
       'ui class' => 'RulesDataUIDate',
+      'token type' => 'rules_date',
     ),
-   'duration' => array(
+    'duration' => array(
       'label' => t('duration'),
       'parent' => 'integer',
       'ui class' => 'RulesDataUIDuration',
+      'token type' => 'rules_duration',
     ),
-   'boolean' => array(
+    'boolean' => array(
       'label' => t('truth value'),
       'ui class' => 'RulesDataUIBoolean',
+      'token type' => 'rules_boolean',
     ),
-   'uri' => array(
+    'uri' => array(
       'label' => t('URI'),
       'parent' => 'text',
       // Clean inserted tokens with "rawurlencode".
       'cleaning callback' => 'rawurlencode',
       'ui class' => 'RulesDataUIURI',
+      'token type' => 'rules_uri',
     ),
-   'list' => array(
+    'list' => array(
       'label' => t('list', array(), array('context' => 'data_types')),
       'wrap' => TRUE,
       'group' => t('List', array(), array('context' => 'data_types')),
     ),
-   'list<text>' => array(
+    'list<text>' => array(
       'label' => t('list of text'),
       'ui class' => 'RulesDataUIListText',
       'wrap' => TRUE,
       'group' => t('List', array(), array('context' => 'data_types')),
     ),
-   'list<integer>' => array(
+    'list<integer>' => array(
       'label' => t('list of integer'),
       'ui class' => 'RulesDataUIListInteger',
       'wrap' => TRUE,
@@ -94,7 +102,7 @@ function rules_rules_core_data_info() {
       'wrap' => TRUE,
       'group' => t('List', array(), array('context' => 'data_types')),
     ),
-   'entity' => array(
+    'entity' => array(
       'label' => t('any entity'),
       'group' => t('Entity'),
       'is wrapped' => TRUE,
diff --git a/profiles/commons/modules/contrib/rules/modules/system.eval.inc b/profiles/commons/modules/contrib/rules/modules/system.eval.inc
index a56bbe9..a15f217 100644
--- a/profiles/commons/modules/contrib/rules/modules/system.eval.inc
+++ b/profiles/commons/modules/contrib/rules/modules/system.eval.inc
@@ -180,6 +180,9 @@ class RulesTokenEvaluator extends RulesDataInputEvaluator {
       else {
         $replacements += token_generate($var_name, $tokens, array(), $options);
       }
+      // Remove tokens if no replacement value is found. As token_replace() does
+      // if 'clear' is set.
+      $replacements += array_fill_keys($tokens, '');
     }
 
     // Optionally clean the list of replacement values.
@@ -200,6 +203,15 @@ class RulesTokenEvaluator extends RulesDataInputEvaluator {
     return str_replace($tokens, $values, $text);
   }
 
+  /**
+   * Create documentation about the available replacement patterns.
+   *
+   * @param array $var_info
+   *   Array with the available variables.
+   *
+   * @return array
+   *   Renderable array with the replacement pattern documentation.
+   */
   public static function help($var_info) {
     $render = array(
       '#type' => 'fieldset',
@@ -223,7 +235,11 @@ class RulesTokenEvaluator extends RulesDataInputEvaluator {
         );
         foreach ($token_info['tokens'][$token_type] as $token => $info) {
           $token = '[' . str_replace('_', '-', $name) . ':' . $token . ']';
-          $render[$name]['#rows'][$token] = array(check_plain($token), check_plain($info['name']), check_plain($info['description']));
+          $render[$name]['#rows'][$token] = array(
+            check_plain($token),
+            check_plain($info['name']),
+            check_plain($info['description']),
+          );
         }
       }
     }
diff --git a/profiles/commons/modules/contrib/rules/rules.api.php b/profiles/commons/modules/contrib/rules/rules.api.php
index c797fc2..86b670c 100644
--- a/profiles/commons/modules/contrib/rules/rules.api.php
+++ b/profiles/commons/modules/contrib/rules/rules.api.php
@@ -414,8 +414,9 @@ function hook_rules_data_info() {
  *     components (see below).
  *   - class: The implementation class. Has to extend the RulesPlugin class.
  *   - embeddable: A container class in which elements of those plugin may be
- *     embedded or FALSE to disallow embedding. Common classes that are used
- *     here are RulesConditionContainer and RulesActionContainer.
+ *     embedded via the UI or FALSE to disallow embedding it via the UI. This
+ *     has no implications on the API level though. Common classes that are
+ *     used here are RulesConditionContainer and RulesActionContainer.
  *   - component: If set to TRUE, the rules admin UI will list elements of those
  *     plugin in the components UI and allows the creation of new components
  *     based upon this plugin. Optional.
diff --git a/profiles/commons/modules/contrib/rules/rules.info b/profiles/commons/modules/contrib/rules/rules.info
index 524783e..e8e3a59 100644
--- a/profiles/commons/modules/contrib/rules/rules.info
+++ b/profiles/commons/modules/contrib/rules/rules.info
@@ -19,9 +19,9 @@ files[] = ui/ui.plugins.inc
 dependencies[] = entity_token
 dependencies[] = entity
 
-; Information added by drupal.org packaging script on 2012-08-03
-version = "7.x-2.2"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.3"
 core = "7.x"
 project = "rules"
-datestamp = "1343980733"
+datestamp = "1364401818"
 
diff --git a/profiles/commons/modules/contrib/rules/rules.install b/profiles/commons/modules/contrib/rules/rules.install
index ce72c81..f49c78e 100644
--- a/profiles/commons/modules/contrib/rules/rules.install
+++ b/profiles/commons/modules/contrib/rules/rules.install
@@ -128,7 +128,8 @@ function rules_schema() {
     ),
     'primary key' => array('id', 'event'),
     'foreign keys' => array(
-      'id' => array('rules_config' => 'id'),
+      'table' => 'rules_config',
+      'columns' => array('id' => 'id'),
     ),
   );
   $schema['rules_tags'] = array(
@@ -148,7 +149,8 @@ function rules_schema() {
     ),
     'primary key' => array('id', 'tag'),
     'foreign keys' => array(
-      'id' => array('rules_config' => 'id'),
+      'table' => 'rules_config',
+      'columns' => array('id' => 'id'),
     ),
   );
   $schema['rules_dependencies'] = array(
@@ -171,7 +173,8 @@ function rules_schema() {
       'module' => array('module'),
     ),
     'foreign keys' => array(
-      'id' => array('rules_config' => 'id'),
+      'table' => 'rules_config',
+      'columns' => array('id' => 'id'),
     ),
   );
   $schema['cache_rules'] = drupal_get_schema_unprocessed('system', 'cache');
@@ -269,7 +272,8 @@ function rules_update_7200() {
     ),
     'primary key' => array('id', 'event'),
     'foreign keys' => array(
-      'id' => array('rules_config' => 'id'),
+      'table' => 'rules_config',
+      'columns' => array('id' => 'id'),
     ),
   );
   db_create_table('rules_config', $schema['rules_config']);
@@ -353,7 +357,8 @@ function rules_update_7204() {
       ),
       'primary key' => array('id', 'tag'),
       'foreign keys' => array(
-        'id' => array('rules_config' => 'id'),
+        'table' => 'rules_config',
+        'columns' => array('id' => 'id'),
       ),
     );
     db_create_table('rules_tags', $schema['rules_tags']);
@@ -385,7 +390,8 @@ function rules_update_7205() {
         'module' => array('module'),
       ),
       'foreign keys' => array(
-        'id' => array('rules_config' => 'id'),
+        'table' => 'rules_config',
+        'columns' => array('id' => 'id'),
       ),
     );
     db_create_table('rules_dependencies', $schema['rules_dependencies']);
diff --git a/profiles/commons/modules/contrib/rules/rules.module b/profiles/commons/modules/contrib/rules/rules.module
index 3a983aa..daa0faa 100644
--- a/profiles/commons/modules/contrib/rules/rules.module
+++ b/profiles/commons/modules/contrib/rules/rules.module
@@ -1406,3 +1406,45 @@ function rules_help($path, $arg) {
     return render($output);
   }
 }
+
+/**
+ * Implements hook_token_info().
+ */
+function rules_token_info() {
+  $cache = rules_get_cache();
+  $data_info = $cache['data_info'];
+
+  $types = array('text', 'integer', 'uri', 'token', 'decimal', 'date', 'duration');
+
+  foreach ($types as $type) {
+    $token_type = $data_info[$type]['token type'];
+
+    $token_info['types'][$token_type] = array(
+      'name' => $data_info[$type]['label'],
+      'description' => t('Tokens related to %label Rules variables.', array('%label' => $data_info[$type]['label'])),
+      'needs-data' => $token_type,
+    );
+    $token_info['tokens'][$token_type]['value'] = array(
+      'name' => t("Value"),
+      'description' => t('The value of the variable.'),
+    );
+  }
+  return $token_info;
+}
+
+/**
+ * Implements hook_tokens().
+ */
+function rules_tokens($type, $tokens, $data, $options = array()) {
+  // Handle replacements of primitive variable types.
+  if (substr($type, 0, 6) == 'rules_' && !empty($data[$type])) {
+    // Leverage entity tokens token processor by passing on as struct.
+    $info['property info']['value'] = array(
+      'type' => substr($type, 6),
+      'label' => '',
+    );
+    // Entity tokens uses metadata wrappers as values for 'struct' types.
+    $wrapper = entity_metadata_wrapper('struct', array('value' => $data[$type]), $info);
+    return entity_token_tokens('struct', $tokens, array('struct' => $wrapper), $options);
+  }
+}
diff --git a/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info b/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
index c16e8a9..90ecfe6 100644
--- a/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
+++ b/profiles/commons/modules/contrib/rules/rules_admin/rules_admin.info
@@ -6,9 +6,9 @@ files[] = rules_admin.module
 files[] = rules_admin.inc
 dependencies[] = rules
 
-; Information added by drupal.org packaging script on 2012-08-03
-version = "7.x-2.2"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.3"
 core = "7.x"
 project = "rules"
-datestamp = "1343980733"
+datestamp = "1364401818"
 
diff --git a/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info b/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
index e2c34df..41014df 100644
--- a/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
+++ b/profiles/commons/modules/contrib/rules/rules_i18n/rules_i18n.info
@@ -7,9 +7,9 @@ core = 7.x
 files[] = rules_i18n.i18n.inc
 files[] = rules_i18n.rules.inc
 files[] = rules_i18n.test
-; Information added by drupal.org packaging script on 2012-08-03
-version = "7.x-2.2"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.3"
 core = "7.x"
 project = "rules"
-datestamp = "1343980733"
+datestamp = "1364401818"
 
diff --git a/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info b/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
index fb83852..cfdfbfb 100644
--- a/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
+++ b/profiles/commons/modules/contrib/rules/rules_scheduler/rules_scheduler.info
@@ -12,9 +12,9 @@ files[] = includes/rules_scheduler.views_default.inc
 files[] = includes/rules_scheduler.views.inc
 files[] = includes/rules_scheduler_views_filter.inc
 
-; Information added by drupal.org packaging script on 2012-08-03
-version = "7.x-2.2"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.3"
 core = "7.x"
 project = "rules"
-datestamp = "1343980733"
+datestamp = "1364401818"
 
diff --git a/profiles/commons/modules/contrib/rules/tests/rules.test b/profiles/commons/modules/contrib/rules/tests/rules.test
index 1b3246c..0bddc2e 100644
--- a/profiles/commons/modules/contrib/rules/tests/rules.test
+++ b/profiles/commons/modules/contrib/rules/tests/rules.test
@@ -1455,6 +1455,57 @@ class RulesIntegrationTestCase extends DrupalWebTestCase {
   function testEntityIntegration() {
     global $user;
 
+    $page = $this->drupalCreateNode(array('type' => 'page'));
+    $article = $this->drupalCreateNode(array('type' => 'article'));
+
+    $result = rules_condition('entity_field_access')
+      ->execute(entity_metadata_wrapper('node', $article), 'field_tags');
+    $this->assertTrue($result);
+
+    // Test entiy_is_of_bundle condition.
+    $result = rules_condition('entity_is_of_bundle', array(
+      'type' => 'node',
+      'bundle' => array('article'),
+    ))->execute(entity_metadata_wrapper('node', $page));
+    $this->assertFalse($result, 'Entity is of bundle condition has not been met.');
+    $result = rules_condition('entity_is_of_bundle', array(
+      'type' => 'node',
+      'bundle' => array('article'),
+    ))->execute(entity_metadata_wrapper('node', $article));
+    $this->assertTrue($result, 'Entity is of bundle condition has been met.');
+
+    // Also test a full rule so the integrity check must work.
+    $term_wrapped = entity_property_values_create_entity('taxonomy_term', array(
+      'name' => $this->randomName(),
+      'vocabulary' => 1,
+    ))->save();
+    $rule = rule(array(
+      'node' => array('type' => 'node'),
+    ));
+    $rule->condition('entity_is_of_bundle', array(
+      'entity:select' => 'node',
+      'bundle' => array('article'),
+    ));
+    $rule->action('data_set', array('data:select' => 'node:field_tags', 'value' => array($term_wrapped->getIdentifier())));
+    $rule->integrityCheck();
+    $rule->execute($article);
+    $this->assertEqual($term_wrapped->getIdentifier(), $article->field_tags[LANGUAGE_NONE][0]['tid'], 'Entity is of bundle condition has been met.');
+
+    // Test again using an entity variable.
+    $article = $this->drupalCreateNode(array('type' => 'article'));
+    $rule = rule(array(
+      'entity' => array('type' => 'entity'),
+    ));
+    $rule->condition('entity_is_of_bundle', array(
+      'entity:select' => 'entity',
+      'type' => 'node',
+      'bundle' => array('article'),
+    ));
+    $rule->action('data_set', array('data:select' => 'entity:field_tags', 'value' => array($term_wrapped->getIdentifier())));
+    $rule->integrityCheck();
+    $rule->execute(entity_metadata_wrapper('node', $article));
+    $this->assertEqual($term_wrapped->getIdentifier(), $article->field_tags[LANGUAGE_NONE][0]['tid'], 'Entity is of bundle condition has been met.');
+
     // Test CRUD actions.
     $action = rules_action('entity_create', array(
       'type' => 'node',
@@ -1883,8 +1934,11 @@ class RulesIntegrationTestCase extends DrupalWebTestCase {
     // Test sending mail to all users of a role. First make sure there is a
     // custom role and a user for it.
     $user = $this->drupalCreateUser(array('administer nodes'));
-    $roles = array_keys($user->roles);
-    rules_action('mail_to_users_of_role', $settings + array('roles' => $roles))->execute();
+    $roles = $user->roles;
+    // Remove the authenticate role so we only use the new role created by
+    // drupalCreateUser().
+    unset($roles[DRUPAL_AUTHENTICATED_RID]);
+    rules_action('mail_to_users_of_role', $settings + array('roles' => array_keys($roles)))->execute();
     $this->assertMail('to', $user->mail, 'Mail to users of a role has been sent.');
 
     // Test reacting on new log entries and make sure the log entry is usable.
diff --git a/profiles/commons/modules/contrib/rules/tests/rules_test.info b/profiles/commons/modules/contrib/rules/tests/rules_test.info
index bc451fc..6d149ee 100644
--- a/profiles/commons/modules/contrib/rules/tests/rules_test.info
+++ b/profiles/commons/modules/contrib/rules/tests/rules_test.info
@@ -6,9 +6,9 @@ files[] = rules_test.rules.inc
 files[] = rules_test.rules_defaults.inc
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2012-08-03
-version = "7.x-2.2"
+; Information added by drupal.org packaging script on 2013-03-27
+version = "7.x-2.3"
 core = "7.x"
 project = "rules"
-datestamp = "1343980733"
+datestamp = "1364401818"
 
diff --git a/profiles/commons/modules/contrib/rules/ui/ui.controller.inc b/profiles/commons/modules/contrib/rules/ui/ui.controller.inc
index a0abce1..dd80a29 100644
--- a/profiles/commons/modules/contrib/rules/ui/ui.controller.inc
+++ b/profiles/commons/modules/contrib/rules/ui/ui.controller.inc
@@ -275,8 +275,8 @@ class RulesUIController {
 
     // Add operations depending on the options and the exportable status.
     if (!$config->hasStatus(ENTITY_FIXED)) {
-      $row[] =  l(t('edit'), RulesPluginUI::path($name));
-      $row[] =  l(t('translate'), RulesPluginUI::path($name, 'translate'));
+      $row[] =  l(t('edit'), RulesPluginUI::path($name), array('attributes' => array('class' => array('edit', 'action'))));
+      $row[] =  l(t('translate'), RulesPluginUI::path($name, 'translate'), array('attributes' => array('class' => array('translate', 'action'))));
     }
     else {
       $row[] = '';
@@ -286,30 +286,31 @@ class RulesUIController {
     if (!$options['hide status op']) {
       // Add either an enable or disable link.
       $text = $config->active ? t('disable') : t('enable');
-      $link_path = RulesPluginUI::path($name, $config->active ? 'disable' : 'enable');
-      $row[] = $config->hasStatus(ENTITY_FIXED) ? '' : l($text, $link_path, array('query' => drupal_get_destination()));
+      $active_class = $config->active ? 'disable' : 'enable';
+      $link_path = RulesPluginUI::path($name, $active_class);
+      $row[] = $config->hasStatus(ENTITY_FIXED) ? '' : l($text, $link_path, array('attributes' => array('class' => array($active_class, 'action')), 'query' => drupal_get_destination()));
     }
-    $row[] = l(t('clone'), RulesPluginUI::path($name, 'clone'));
+    $row[] = l(t('clone'), RulesPluginUI::path($name, 'clone'), array('attributes' => array('class' => array('clone', 'action'))));
 
     // Add execute link for for components.
     if ($options['show execution op']) {
-      $row[] = ($config instanceof RulesTriggerableInterface) ? '' : l(t('execute'), RulesPluginUI::path($name, 'execute'), array('query' => drupal_get_destination()));
+      $row[] = ($config instanceof RulesTriggerableInterface) ? '' : l(t('execute'), RulesPluginUI::path($name, 'execute'), array('attributes' => array('class' => array('execute', 'action')), 'query' => drupal_get_destination()));
       if (module_exists('rules_scheduler')) {
         // Add schedule link for action components only.
-        $row[] = $config instanceof RulesActionInterface ? l(t('schedule'), RulesPluginUI::path($name, 'schedule'), array('query' => drupal_get_destination())) : '';
+        $row[] = $config instanceof RulesActionInterface ? l(t('schedule'), RulesPluginUI::path($name, 'schedule'), array('attributes' => array('class' => array('schedule', 'action')), 'query' => drupal_get_destination())) : '';
       }
     }
 
     if (!$config->hasStatus(ENTITY_IN_CODE) && !$config->hasStatus(ENTITY_FIXED)) {
-      $row[] = l(t('delete'), RulesPluginUI::path($name, 'delete'), array('query' => drupal_get_destination()));
+      $row[] = l(t('delete'), RulesPluginUI::path($name, 'delete'), array('attributes' => array('class' => array('delete', 'action')), 'query' => drupal_get_destination()));
     }
     elseif ($config->hasStatus(ENTITY_OVERRIDDEN) && !$config->hasStatus(ENTITY_FIXED)) {
-      $row[] = l(t('revert'), RulesPluginUI::path($name, 'revert'), array('query' => drupal_get_destination()));
+      $row[] = l(t('revert'), RulesPluginUI::path($name, 'revert'), array('attributes' => array('class' => array('revert', 'action')), 'query' => drupal_get_destination()));
     }
     else {
       $row[] = '';
     }
-    $row[] = l(t('export'), RulesPluginUI::path($name, 'export'));
+    $row[] = l(t('export'), RulesPluginUI::path($name, 'export'), array('attributes' => array('class' => array('export', 'action'))));
     return $row;
   }
 }
diff --git a/profiles/commons/modules/contrib/rules/ui/ui.core.inc b/profiles/commons/modules/contrib/rules/ui/ui.core.inc
index 6af9541..b72ede0 100644
--- a/profiles/commons/modules/contrib/rules/ui/ui.core.inc
+++ b/profiles/commons/modules/contrib/rules/ui/ui.core.inc
@@ -1087,7 +1087,7 @@ class RulesContainerPluginUI extends RulesPluginUI {
           '#theme' => 'rules_content_group',
           '#caption' => t('Tags'),
           'tags' => array(
-            '#markup' => implode(', ', $this->element->tags),
+            '#markup' => check_plain(drupal_implode_tags($this->element->tags)),
           ),
         );
       }
diff --git a/profiles/commons/modules/contrib/rules/ui/ui.data.inc b/profiles/commons/modules/contrib/rules/ui/ui.data.inc
index fdefc65..41e2d66 100755
--- a/profiles/commons/modules/contrib/rules/ui/ui.data.inc
+++ b/profiles/commons/modules/contrib/rules/ui/ui.data.inc
@@ -87,11 +87,11 @@ class RulesDataUI {
     $form['types_help']['#text'] = format_plural(count($type_labels), 'Select data of the type %types.', 'Select data of the types %types.', array('%types' => implode(', ', $type_labels)));
 
     if (!empty($info['translatable'])) {
-      if ($info['custom translation language']) {
-        $text = t('If a multilingual data source (i.e. a translatable field) is given, the argument is translated to the configured language.');
+      if (empty($info['custom translation language'])) {
+        $text = t('If a multilingual data source (i.e. a translatable field) is given, the argument is translated to the current interface language.');
       }
       else {
-        $text = t('If a multilingual data source (i.e. a translatable field) is given, the argument is translated to the current interface language.');
+        $text = t('If a multilingual data source (i.e. a translatable field) is given, the argument is translated to the configured language.');
       }
       $form['translation'] = array(
         '#theme' => 'rules_settings_help',
diff --git a/profiles/commons/modules/contrib/rules/ui/ui.forms.inc b/profiles/commons/modules/contrib/rules/ui/ui.forms.inc
index 95ddf3e..1439304 100644
--- a/profiles/commons/modules/contrib/rules/ui/ui.forms.inc
+++ b/profiles/commons/modules/contrib/rules/ui/ui.forms.inc
@@ -616,7 +616,7 @@ function rules_ui_form_data_selection_auto_completion($parameter, $form_build_id
         else {
           $text = check_plain($selector) . ' (' . check_plain($info['label']) . ')';
         }
-        $matches[$selector] = "<div" . drupal_attributes($attributes) . ">$text</div";
+        $matches[$selector] = "<div" . drupal_attributes($attributes) . ">$text</div>";
       }
     }
   }
diff --git a/profiles/commons/modules/contrib/strongarm/strongarm.info b/profiles/commons/modules/contrib/strongarm/strongarm.info
index bd14630..0bb52c5 100644
--- a/profiles/commons/modules/contrib/strongarm/strongarm.info
+++ b/profiles/commons/modules/contrib/strongarm/strongarm.info
@@ -7,9 +7,10 @@ files[] = strongarm.admin.inc
 files[] = strongarm.install
 files[] = strongarm.module
 
-; Information added by drupal.org packaging script on 2012-08-30
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.0+2-dev"
 core = "7.x"
 project = "strongarm"
-datestamp = "1346288395"
+datestamp = "1364431820"
 
diff --git a/profiles/commons/modules/contrib/timeago/PATCHES.txt b/profiles/commons/modules/contrib/timeago/PATCHES.txt
index 9797a14..f55cfd0 100644
--- a/profiles/commons/modules/contrib/timeago/PATCHES.txt
+++ b/profiles/commons/modules/contrib/timeago/PATCHES.txt
@@ -1,4 +1,5 @@
 The following patches have been applied to this project:
 - http://drupal.org/files/1427226-timeago-date-type.patch
+- http://drupal.org/files/timeago-libraries-a.patch
 
 This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/timeago/timeago.info b/profiles/commons/modules/contrib/timeago/timeago.info
index cc1d2ac..1c3d0da 100644
--- a/profiles/commons/modules/contrib/timeago/timeago.info
+++ b/profiles/commons/modules/contrib/timeago/timeago.info
@@ -6,9 +6,10 @@ configure = admin/config/user-interface/timeago
 files[] = timeago.install
 files[] = timeago.module
 
-; Information added by drupal.org packaging script on 2013-01-12
+
+; Information added by drush on 2013-03-28
 version = "7.x-2.1+6-dev"
 core = "7.x"
 project = "timeago"
-datestamp = "1357955762"
+datestamp = "1364431820"
 
diff --git a/profiles/commons/modules/contrib/timeago/timeago.module b/profiles/commons/modules/contrib/timeago/timeago.module
index 1e135ef..4b5d296 100644
--- a/profiles/commons/modules/contrib/timeago/timeago.module
+++ b/profiles/commons/modules/contrib/timeago/timeago.module
@@ -354,8 +354,6 @@ function timeago_add_js() {
   if (module_exists('libraries') && function_exists('libraries_load')) {
     $library_path = libraries_get_path('timeago');
     libraries_load('timeago');
-    $path = drupal_get_path('module', 'timeago') . '/timeago.js';
-    drupal_add_js($path);
   }
   else {
     $library_path = drupal_get_path('module', 'timeago');
diff --git a/profiles/commons/modules/contrib/title/CHANGELOG.txt b/profiles/commons/modules/contrib/title/CHANGELOG.txt
index 323225e..3ccce43 100644
--- a/profiles/commons/modules/contrib/title/CHANGELOG.txt
+++ b/profiles/commons/modules/contrib/title/CHANGELOG.txt
@@ -3,6 +3,20 @@ Title 7.x-1.x, xxxx-xx-xx
 -------------------------
 
 
+Title 7.x-1.0-alpha7, 2013-03-18
+--------------------------------
+#1919640 by peximo: Fixed Empty tag shown when the title field is displayed.
+#1869438 by jsacksick: Fixed hook_field_attach_create_bundle() implementation
+  isn't correct.
+#1280962 by mvc: Fixed Better description of field replacement dialogue.
+#1900282: Fixed wrong files[] directive in the title_test module.
+#1898618 by muka: Fixed Handle case when title property is not set (avoiding
+  error).
+#1885356 by peximo: Fixed Empty HTML class in Linked and wrapped format.
+#1865604 by GalG, plach: Fixed Title module overrides label callback (prevents
+  term label localization).
+
+
 Title 7.x-1.0-alpha5, 2012-12-18
 --------------------------------
 #1869228 by plach: Updated system dependencies.
diff --git a/profiles/commons/modules/contrib/title/tests/title.test b/profiles/commons/modules/contrib/title/tests/title.test
index b58635e..e88eb52 100644
--- a/profiles/commons/modules/contrib/title/tests/title.test
+++ b/profiles/commons/modules/contrib/title/tests/title.test
@@ -162,18 +162,25 @@ class TitleAdminSettingsTestCase extends DrupalWebTestCase {
 
   function setUp() {
     parent::setUp('field_test', 'title', 'title_test');
+    $admin_user = $this->drupalCreateUser(array('administer site configuration', 'administer taxonomy'));
+    $this->drupalLogin($admin_user);
   }
 
   /**
    * Check for automated title_field attachment.
    */
   function testAutomatedFieldAttachement() {
-    $admin_user = $this->drupalCreateUser(array('administer site configuration', 'administer taxonomy'));
-    $this->drupalLogin($admin_user);
+    $this->assertAutomatedFieldAttachement(TRUE);
+    $this->assertAutomatedFieldAttachement(FALSE);
+  }
 
+  /**
+   * Check that the fields are replaced or skipped depdening on the given value.
+   */
+  function assertAutomatedFieldAttachement($enabled) {
     $edit = array(
-      'title_taxonomy_term[auto_attach][name]' => TRUE,
-      'title_taxonomy_term[auto_attach][description]' => TRUE,
+      'title_taxonomy_term[auto_attach][name]' => $enabled,
+      'title_taxonomy_term[auto_attach][description]' => $enabled,
     );
     $this->drupalPost('admin/config/content/title', $edit, t('Save configuration'));
 
@@ -187,8 +194,8 @@ class TitleAdminSettingsTestCase extends DrupalWebTestCase {
     $entity_type = 'taxonomy_term';
     $bundle = $edit['machine_name'];
     field_info_cache_clear();
-    $this->assertTrue(title_field_replacement_enabled($entity_type, $bundle, 'name'), 'Name field automatically attached.');
-    $this->assertTrue(title_field_replacement_enabled($entity_type, $bundle, 'description', 'Description field automatically attached.'));
+    $this->assertTrue(title_field_replacement_enabled($entity_type, $bundle, 'name') == $enabled, 'Name field correctly processed.');
+    $this->assertTrue(title_field_replacement_enabled($entity_type, $bundle, 'description') == $enabled, 'Description field correctly processed.');
   }
 }
 
diff --git a/profiles/commons/modules/contrib/title/tests/title_test.info b/profiles/commons/modules/contrib/title/tests/title_test.info
index bdfa5a8..45846d3 100644
--- a/profiles/commons/modules/contrib/title/tests/title_test.info
+++ b/profiles/commons/modules/contrib/title/tests/title_test.info
@@ -6,11 +6,10 @@ hidden = TRUE
 dependencies[] = title
 dependencies[] = entity
 dependencies[] = entity_translation
-files[] = title_test.module
 
-; Information added by drupal.org packaging script on 2012-12-18
-version = "7.x-1.0-alpha5"
+; Information added by drupal.org packaging script on 2013-03-18
+version = "7.x-1.0-alpha7"
 core = "7.x"
 project = "title"
-datestamp = "1355827149"
+datestamp = "1363626024"
 
diff --git a/profiles/commons/modules/contrib/title/title.admin.inc b/profiles/commons/modules/contrib/title/title.admin.inc
index 743a46c..9cb0065 100644
--- a/profiles/commons/modules/contrib/title/title.admin.inc
+++ b/profiles/commons/modules/contrib/title/title.admin.inc
@@ -22,7 +22,7 @@ function title_form_field_ui_overview(&$form, &$form_state) {
           '#type' => 'link',
           '#title' => t('replace'),
           '#href' => $admin_path . '/fields/replace/' . $field_name,
-          '#options' => array('attributes' => array('title' => t('Replace %field with a field instance.', array('%field' => $field_name)))),
+          '#options' => array('attributes' => array('title' => t('Replace %field with a customizable field instance that can be translated.', array('%field' => $field_name)))),
         );
       }
       else {
@@ -48,8 +48,8 @@ function title_field_replacement_form($form, $form_state, $entity_type, $bundle,
 
   $form['enabled'] = array(
     '#type' => 'checkbox',
-    '#title' => t('Replace %field with a field instance.', array('%field' => $field_name)),
-    '#description' => t('If this is enabled the %field legacy field will be replaced with a regular field and will disappear from the <em>Manage fields</em> page. It will get back if the replacing field instance is deleted.', array('%field' => $field_name)),
+    '#title' => t('Replace %field with a field instance', array('%field' => $field_name)),
+    '#description' => t('If this is enabled the %field will be replaced with a customizable field that can be translated.', array('%field' => $field_name)),
     '#default_value' => $enabled,
     '#disabled' => $enabled,
   );
diff --git a/profiles/commons/modules/contrib/title/title.core.inc b/profiles/commons/modules/contrib/title/title.core.inc
index ef8a2a0..d75e656 100644
--- a/profiles/commons/modules/contrib/title/title.core.inc
+++ b/profiles/commons/modules/contrib/title/title.core.inc
@@ -39,7 +39,7 @@ function title_entity_info() {
         'field' => $field,
         'instance' => array(
           'label' => t('Title'),
-          'description' => t('A field replacing node title.'),
+          'description' => '',
         ) + $instance,
       ),
     ),
@@ -53,7 +53,7 @@ function title_entity_info() {
           'field' => $field,
           'instance' => array(
             'label' => t('Name'),
-            'description' => t('A field replacing taxonomy term name.'),
+            'description' => '',
           ) + $instance,
           'preprocess_key' => 'term_name',
         ),
@@ -64,7 +64,7 @@ function title_entity_info() {
           'instance' => array(
             'required' => FALSE,
             'label' => t('Description'),
-            'description' => t('A field replacing taxonomy term description.'),
+            'description' => '',
             'settings' => array(
               'text_processing' => 1,
             ),
@@ -87,7 +87,7 @@ function title_entity_info() {
           'field' => $field,
           'instance' => array(
             'label' => t('Subject'),
-            'description' => t('A field replacing comment subject.'),
+            'description' => '',
           ) + $instance,
           'preprocess_key' => 'title',
         ),
diff --git a/profiles/commons/modules/contrib/title/title.field.inc b/profiles/commons/modules/contrib/title/title.field.inc
index 15590cf..d94905b 100644
--- a/profiles/commons/modules/contrib/title/title.field.inc
+++ b/profiles/commons/modules/contrib/title/title.field.inc
@@ -104,18 +104,21 @@ function title_field_formatter_view($entity_type, $entity, $field, $instance, $l
     $output = l($output, $uri['path'], array('html' => TRUE));
   }
 
-  $wrap_tag = isset($settings['title_style']) ? $settings['title_style'] : '_none';
+  $wrap_tag = empty($settings['title_style']) ? '_none' : $settings['title_style'];
 
   if ($wrap_tag != '_none') {
-    $output = theme('html_tag', array(
+    $element = array(
       'element' => array(
         '#tag' => $wrap_tag,
-        '#attributes' => array(
-          'class' => $settings['title_class'],
-        ),
         '#value' => $output,
       ),
-    ));
+    );
+
+    if (!empty($settings['title_class'])) {
+      $element['#attributes'] = array('class' => $settings['title_class']);
+    }
+
+    $output = theme('html_tag', $element);
   }
 
   $element = array(
diff --git a/profiles/commons/modules/contrib/title/title.info b/profiles/commons/modules/contrib/title/title.info
index af6ca38..a331e8f 100644
--- a/profiles/commons/modules/contrib/title/title.info
+++ b/profiles/commons/modules/contrib/title/title.info
@@ -3,15 +3,15 @@ description = Replaces entity legacy fields with regular fields.
 core = 7.x
 package = Fields
 configure = admin/config/content/title
-dependencies[] = system (> 7.14)
+dependencies[] = system (>7.14)
 
 files[] = title.module
 files[] = views/views_handler_title_field.inc
 files[] = tests/title.test
 
-; Information added by drupal.org packaging script on 2012-12-18
-version = "7.x-1.0-alpha5"
+; Information added by drupal.org packaging script on 2013-03-18
+version = "7.x-1.0-alpha7"
 core = "7.x"
 project = "title"
-datestamp = "1355827149"
+datestamp = "1363626024"
 
diff --git a/profiles/commons/modules/contrib/title/title.module b/profiles/commons/modules/contrib/title/title.module
index ef106e9..06b6b3a 100644
--- a/profiles/commons/modules/contrib/title/title.module
+++ b/profiles/commons/modules/contrib/title/title.module
@@ -69,6 +69,10 @@ function title_entity_info_alter(&$info) {
 
         // Support add explicit support for entity_label().
         if (isset($entity_info['entity keys']['label']) && $entity_info['entity keys']['label'] == $legacy_field) {
+          // Store the original label callback for compatibility reasons.
+          if (isset($info[$entity_type]['label callback'])) {
+            $info[$entity_type]['label fallback']['title'] = $info[$entity_type]['label callback'];
+          }
           $info[$entity_type]['label callback'] = 'title_entity_label';
           $fr_info += array('preprocess_key' => $info[$entity_type]['entity keys']['label']);
         }
@@ -118,12 +122,17 @@ function title_entity_label($entity, $type, $langcode = NULL) {
   $info = $entity_info['field replacement'][$legacy_field];
   list(, , $bundle) = entity_extract_ids($type, $entity);
 
+  // If field replacement is enabled we use the replacing field value.
   if (title_field_replacement_enabled($type, $bundle, $legacy_field)) {
     $langcode = field_language($type, $entity, $info['field']['field_name'], $langcode);
     return $info['callbacks']['sync_get']($type, $entity, $legacy_field, $info, $langcode);
   }
+  // Otherwise if we have a fallback defined we use the original label callback.
+  elseif (isset($entity_info['label fallback']['title']) && function_exists($entity_info['label fallback']['title'])) {
+    return $entity_info['label fallback']['title']($entity, $type, $langcode);
+  }
   else {
-    return $entity->{$legacy_field};
+    return (property_exists($entity, $legacy_field)) ? $entity->{$legacy_field} : NULL;
   }
 }
 
@@ -234,7 +243,6 @@ function title_field_replacement_enabled($entity_type, $bundle, $legacy_field) {
  */
 function title_field_replacement_toggle($entity_type, $bundle, $legacy_field) {
   $info = title_field_replacement_info($entity_type, $legacy_field);
-
   if (!$info) {
     return;
   }
@@ -820,24 +828,26 @@ function title_field_attach_create_bundle($entity_type, $bundle) {
 
   $options = variable_get('title_' . $entity_type, array());
 
-  foreach (array_keys($entity_info['field replacement']) as $field_name) {
-    if (!isset($options['auto_attach'][$field_name])) {
+  foreach (array_keys($entity_info['field replacement']) as $legacy_field) {
+    if (empty($options['auto_attach'][$legacy_field])) {
       continue;
     }
 
     // Do not continue if the replacement field already exists.
+    $field_name = $entity_info['field replacement'][$legacy_field]['field']['field_name'];
     if (field_info_instance($entity_type, $field_name, $bundle)) {
       continue;
     }
 
-    title_field_replacement_toggle($entity_type, $bundle, $field_name);
+    title_field_replacement_toggle($entity_type, $bundle, $legacy_field);
 
     $instance = field_info_instance($entity_type, $field_name, $bundle);
-    $params = array(
-      '@entity_label' => drupal_strtolower($entity_info['label']),
-      '%field_name' => t($entity_info['field replacement'][$field_name]['instance']['label']),
-     );
-
-    drupal_set_message(t('The @entity_label %field_name field was automatically replaced.', $params));
+    if ($instance) {
+      $params = array(
+        '@entity_label' => drupal_strtolower($entity_info['label']),
+        '%field_name' => $instance['label'],
+      );
+      drupal_set_message(t('The @entity_label %field_name field was automatically replaced.', $params));
+    }
   }
 }
diff --git a/profiles/commons/modules/contrib/views/handlers/views_handler_area_text.inc b/profiles/commons/modules/contrib/views/handlers/views_handler_area_text.inc
index d772786..edb282f 100644
--- a/profiles/commons/modules/contrib/views/handlers/views_handler_area_text.inc
+++ b/profiles/commons/modules/contrib/views/handlers/views_handler_area_text.inc
@@ -56,7 +56,7 @@ class views_handler_area_text extends views_handler_area {
         if (!empty($options[$type])) {
           $items = array();
           foreach ($options[$type] as $key => $value) {
-            $items[] = $key . ' == ' . $value;
+            $items[] = $key . ' == ' . check_plain($value);
           }
           $output .= theme('item_list',
             array(
diff --git a/profiles/commons/modules/contrib/views/handlers/views_handler_field.inc b/profiles/commons/modules/contrib/views/handlers/views_handler_field.inc
index b657bd6..65210d9 100644
--- a/profiles/commons/modules/contrib/views/handlers/views_handler_field.inc
+++ b/profiles/commons/modules/contrib/views/handlers/views_handler_field.inc
@@ -814,7 +814,7 @@ If you would like to have the characters \'[\' and \']\' please use the html ent
           if (!empty($options[$type])) {
             $items = array();
             foreach ($options[$type] as $key => $value) {
-              $items[] = $key . ' == ' . $value;
+              $items[] = $key . ' == ' . check_plain($value);
             }
             $output .= theme('item_list',
               array(
diff --git a/profiles/commons/modules/contrib/views/handlers/views_handler_field_boolean.inc b/profiles/commons/modules/contrib/views/handlers/views_handler_field_boolean.inc
index 52e02bf..8acfb32 100644
--- a/profiles/commons/modules/contrib/views/handlers/views_handler_field_boolean.inc
+++ b/profiles/commons/modules/contrib/views/handlers/views_handler_field_boolean.inc
@@ -25,6 +25,8 @@ class views_handler_field_boolean extends views_handler_field {
   function option_definition() {
     $options = parent::option_definition();
     $options['type'] = array('default' => 'yes-no');
+    $options['type_custom_true'] = array('default' => '', 'translatable' => TRUE);
+    $options['type_custom_false'] = array('default' => '', 'translatable' => TRUE);
     $options['not'] = array('definition bool' => 'reverse');
 
     return $options;
@@ -42,7 +44,8 @@ class views_handler_field_boolean extends views_handler_field {
       'unicode-yes-no' => array('', ''),
     );
     $output_formats = isset($this->definition['output formats']) ? $this->definition['output formats'] : array();
-    $this->formats = array_merge($default_formats, $output_formats);
+    $custom_format = array('custom' => array(t('Custom')));
+    $this->formats = array_merge($default_formats, $output_formats, $custom_format);
   }
 
   function options_form(&$form, &$form_state) {
@@ -56,6 +59,29 @@ class views_handler_field_boolean extends views_handler_field {
       '#options' => $options,
       '#default_value' => $this->options['type'],
     );
+
+    $form['type_custom_true'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Custom output for TRUE'),
+      '#default_value' => $this->options['type_custom_true'],
+      '#states' => array(
+        'visible' => array(
+          'select[name="options[type]"]' => array('value' => 'custom'),
+        ),
+      ),
+    );
+
+    $form['type_custom_false'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Custom output for FALSE'),
+      '#default_value' => $this->options['type_custom_false'],
+      '#states' => array(
+        'visible' => array(
+          'select[name="options[type]"]' => array('value' => 'custom'),
+        ),
+      ),
+    );
+
     $form['not'] = array(
       '#type' => 'checkbox',
       '#title' => t('Reverse'),
@@ -71,7 +97,10 @@ class views_handler_field_boolean extends views_handler_field {
       $value = !$value;
     }
 
-    if (isset($this->formats[$this->options['type']])) {
+    if ($this->options['type'] == 'custom') {
+      return $value ? filter_xss_admin($this->options['type_custom_true']) : filter_xss_admin($this->options['type_custom_false']);
+    }
+    else if (isset($this->formats[$this->options['type']])) {
       return $value ? $this->formats[$this->options['type']][0] : $this->formats[$this->options['type']][1];
     }
     else {
diff --git a/profiles/commons/modules/contrib/views/handlers/views_handler_filter_numeric.inc b/profiles/commons/modules/contrib/views/handlers/views_handler_filter_numeric.inc
index 982abd8..03384f6 100644
--- a/profiles/commons/modules/contrib/views/handlers/views_handler_filter_numeric.inc
+++ b/profiles/commons/modules/contrib/views/handlers/views_handler_filter_numeric.inc
@@ -258,7 +258,7 @@ class views_handler_filter_numeric extends views_handler_filter {
   }
 
   function op_regex($field) {
-    $this->query->add_where($this->options['group'], $field, $this->value, 'RLIKE');
+    $this->query->add_where($this->options['group'], $field, $this->value['value'], 'RLIKE');
   }
 
   function admin_summary() {
diff --git a/profiles/commons/modules/contrib/views/includes/admin.inc b/profiles/commons/modules/contrib/views/includes/admin.inc
index e87aad7..160a61a 100644
--- a/profiles/commons/modules/contrib/views/includes/admin.inc
+++ b/profiles/commons/modules/contrib/views/includes/admin.inc
@@ -835,10 +835,10 @@ function theme_views_ui_view_info($variables) {
   }
 
   $output = '';
-  $output .= '<div class="views-ui-view-title">' . $title . "</div>\n";
+  $output .= '<div class="views-ui-view-title">' . check_plain($title) . "</div>\n";
   $output .= '<div class="views-ui-view-displays">' . $displays . "</div>\n";
   $output .= '<div class="views-ui-view-storage">' . $type . "</div>\n";
-  $output .= '<div class="views-ui-view-base">' . t('Type') . ': ' . $variables['base']. "</div>\n";
+  $output .= '<div class="views-ui-view-base">' . t('Type') . ': ' . check_plain($variables['base']). "</div>\n";
   return $output;
 }
 
@@ -2214,7 +2214,7 @@ function views_ui_edit_form_get_bucket($type, $view, $display) {
   switch ($type) {
     case 'filter':
       $rearrange_url = "admin/structure/views/nojs/rearrange-$type/$view->name/$display->id/$type";
-      $rearrange_text = t('and/or, rearrange');
+      $rearrange_text = t('And/Or, Rearrange');
       // TODO: Add another class to have another symbol for filter rearrange.
       $class = 'icon compact rearrange';
       break;
@@ -2233,7 +2233,7 @@ function views_ui_edit_form_get_bucket($type, $view, $display) {
 
     default:
       $rearrange_url = "admin/structure/views/nojs/rearrange/$view->name/$display->id/$type";
-      $rearrange_text = t('rearrange');
+      $rearrange_text = t('Rearrange');
       $class = 'icon compact rearrange';
   }
 
@@ -2241,16 +2241,16 @@ function views_ui_edit_form_get_bucket($type, $view, $display) {
   $actions = array();
   $count_handlers = count($display->handler->get_handlers($type));
   $actions['add'] = array(
-    'title' => t('add'),
+    'title' => t('Add'),
     'href' => "admin/structure/views/nojs/add-item/$view->name/$display->id/$type",
-    'attributes'=> array('class' => array('icon compact add', 'views-ajax-link'), 'title' => t('add'), 'id' => 'views-add-' . $type),
+    'attributes'=> array('class' => array('icon compact add', 'views-ajax-link'), 'title' => t('Add'), 'id' => 'views-add-' . $type),
     'html' => TRUE,
   );
   if ($count_handlers > 0) {
     $actions['rearrange'] = array(
       'title' => $rearrange_text,
       'href' => $rearrange_url,
-      'attributes' => array('class' => array($class, 'views-ajax-link'), 'title' => $rearrange_text, 'id' => 'views-rearrange-' . $type),
+      'attributes' => array('class' => array($class, 'views-ajax-link'), 'title' => t('Rearrange'), 'id' => 'views-rearrange-' . $type),
       'html' => TRUE,
     );
   }
@@ -3038,7 +3038,7 @@ function views_ui_reorder_displays_form($form, &$form_state) {
 
   foreach ($view->display as $display) {
     $form[$display->id] = array(
-      'title'  => array('#markup' => $display->display_title),
+      'title'  => array('#markup' => check_plain($display->display_title)),
       'weight' => array(
         '#type' => 'weight',
         '#value' => $display->position,
@@ -4122,8 +4122,8 @@ function views_ui_add_item_form($form, &$form_state) {
         $zebra_class = ($zebra % 2) ? 'odd' : 'even';
         $form['options']['name'][$key] = array(
           '#type' => 'checkbox',
-          '#title' => t('!group: !field', array('!group' => $option['group'], '!field' => $option['title'])),
-          '#description' => $option['help'],
+          '#title' => t('!group: !field', array('!group' => check_plain($option['group']), '!field' => check_plain($option['title']))),
+          '#description' => filter_xss_admin($option['help']),
           '#return_value' => $key,
           '#prefix' => "<div class='$zebra_class filterable-option'>",
           '#suffix' => '</div>',
@@ -5047,7 +5047,7 @@ function views_ui_autocomplete_tag($string = '') {
   $views = views_get_all_views();
   foreach ($views as $view) {
     if (!empty($view->tag) && strpos($view->tag, $string) === 0) {
-      $matches[$view->tag] = $view->tag;
+      $matches[$view->tag] = check_plain($view->tag);
       if (count($matches) >= 10) {
         break;
       }
@@ -5267,7 +5267,7 @@ function theme_views_ui_style_plugin_table($variables) {
   $rows = array();
   foreach (element_children($form['columns']) as $id) {
     $row = array();
-    $row[] = drupal_render($form['info'][$id]['name']);
+    $row[] = check_plain(drupal_render($form['info'][$id]['name']));
     $row[] = drupal_render($form['columns'][$id]);
     $row[] = drupal_render($form['info'][$id]['align']);
     $row[] = drupal_render($form['info'][$id]['separator']);
diff --git a/profiles/commons/modules/contrib/views/includes/cache.inc b/profiles/commons/modules/contrib/views/includes/cache.inc
index b019c34..59c1733 100644
--- a/profiles/commons/modules/contrib/views/includes/cache.inc
+++ b/profiles/commons/modules/contrib/views/includes/cache.inc
@@ -28,9 +28,11 @@ function _views_fetch_data($table = NULL, $move = TRUE, $reset = FALSE) {
         $cache[$table] = $data->data;
       }
       else {
-        // No cache entry, rebuild.
-        $cache = _views_fetch_data_build();
-        $fully_loaded = TRUE;
+        if (!$fully_loaded) {
+          // No cache entry, rebuild.
+          $cache = _views_fetch_data_build();
+          $fully_loaded = TRUE;
+        }
       }
     }
     if (isset($cache[$table])) {
diff --git a/profiles/commons/modules/contrib/views/js/ajax_view.js b/profiles/commons/modules/contrib/views/js/ajax_view.js
index 2a4012f..e3bc821 100644
--- a/profiles/commons/modules/contrib/views/js/ajax_view.js
+++ b/profiles/commons/modules/contrib/views/js/ajax_view.js
@@ -69,7 +69,7 @@ Drupal.views.ajaxView = function(settings) {
 };
 
 Drupal.views.ajaxView.prototype.attachExposedFormAjax = function() {
-  var button = $('input[type=submit], input[type=image]', this.$exposed_form);
+  var button = $('input[type=submit], button[type=submit], input[type=image]', this.$exposed_form);
   button = button[0];
 
   this.exposedFormAjax = new Drupal.ajax($(button).attr('id'), button, this.element_settings);
diff --git a/profiles/commons/modules/contrib/views/js/views-admin.js b/profiles/commons/modules/contrib/views/js/views-admin.js
index 1eb3897..e945429 100644
--- a/profiles/commons/modules/contrib/views/js/views-admin.js
+++ b/profiles/commons/modules/contrib/views/js/views-admin.js
@@ -209,7 +209,7 @@ Drupal.viewsUi.addItemForm.prototype.handleCheck = function (event) {
  */
 Drupal.viewsUi.addItemForm.prototype.refreshCheckedItems = function() {
   // Perhaps we should precache the text div, too.
-  this.$selected_div.find('.views-selected-options').html(this.checkedItems.join(', '));
+  this.$selected_div.find('.views-selected-options').html(Drupal.checkPlain(this.checkedItems.join(', ')));
   Drupal.viewsUi.resizeModal('', true);
 }
 
diff --git a/profiles/commons/modules/contrib/views/modules/aggregator/views_handler_argument_aggregator_iid.inc b/profiles/commons/modules/contrib/views/modules/aggregator/views_handler_argument_aggregator_iid.inc
index d959b04..4c7824e 100644
--- a/profiles/commons/modules/contrib/views/modules/aggregator/views_handler_argument_aggregator_iid.inc
+++ b/profiles/commons/modules/contrib/views/modules/aggregator/views_handler_argument_aggregator_iid.inc
@@ -18,9 +18,9 @@ class views_handler_argument_aggregator_iid extends views_handler_argument_numer
     $titles = array();
     $placeholders = implode(', ', array_fill(0, sizeof($this->value), '%d'));
 
-    $result = db_select('aggregator_item')
+    $result = db_select('aggregator_item', 'ai')
       ->condition('iid', $this->value, 'IN')
-      ->fields(array('title'))
+      ->fields('ai', array('title'))
       ->execute();
     foreach ($result as $term) {
       $titles[] = check_plain($term->title);
diff --git a/profiles/commons/modules/contrib/views/modules/taxonomy/views_plugin_argument_validate_taxonomy_term.inc b/profiles/commons/modules/contrib/views/modules/taxonomy/views_plugin_argument_validate_taxonomy_term.inc
index 3a88199..ba1a0e7 100644
--- a/profiles/commons/modules/contrib/views/modules/taxonomy/views_plugin_argument_validate_taxonomy_term.inc
+++ b/profiles/commons/modules/contrib/views/modules/taxonomy/views_plugin_argument_validate_taxonomy_term.inc
@@ -103,7 +103,8 @@ class views_plugin_argument_validate_taxonomy_term extends views_plugin_argument
         if (!$term) {
           return FALSE;
         }
-        $this->argument->validated_title = check_plain($term->name);
+        $term = taxonomy_term_load($term->tid);
+        $this->argument->validated_title = check_plain(entity_label('taxonomy_term', $term));
         return empty($vocabularies) || !empty($vocabularies[$term->machine_name]);
 
       case 'tids':
@@ -151,8 +152,8 @@ class views_plugin_argument_validate_taxonomy_term extends views_plugin_argument
               $validated_cache[$term->tid] = FALSE;
               return FALSE;
             }
-
-            $titles[] = $validated_cache[$term->tid] = check_plain($term->name);
+            $term = taxonomy_term_load($term->tid);
+            $titles[] = $validated_cache[$term->tid] = check_plain(entity_label('taxonomy_term', $term));
             unset($test[$term->tid]);
           }
         }
@@ -185,7 +186,8 @@ class views_plugin_argument_validate_taxonomy_term extends views_plugin_argument
           if ($type == 'convert') {
             $this->argument->argument = $term->tid;
           }
-          $this->argument->validated_title = check_plain($term->name);
+          $term = taxonomy_term_load($term->tid);
+          $this->argument->validated_title = check_plain(entity_label('taxonomy_term', $term));
           return TRUE;
         }
         return FALSE;
diff --git a/profiles/commons/modules/contrib/views/plugins/views_plugin_style_jump_menu.inc b/profiles/commons/modules/contrib/views/plugins/views_plugin_style_jump_menu.inc
index a07567c..16b0aef 100644
--- a/profiles/commons/modules/contrib/views/plugins/views_plugin_style_jump_menu.inc
+++ b/profiles/commons/modules/contrib/views/plugins/views_plugin_style_jump_menu.inc
@@ -19,6 +19,7 @@ class views_plugin_style_jump_menu extends views_plugin_style {
     $options['text'] = array('default' => 'Go', 'translatable' => TRUE);
     $options['label'] = array('default' => '', 'translatable' => TRUE);
     $options['choose'] = array('default' => '- Choose -', 'translatable' => TRUE);
+    $options['inline'] = array('default' => TRUE, 'bool' => TRUE);
     $options['default_value'] = array('default' => FALSE, 'bool' => TRUE);
 
     return $options;
@@ -83,6 +84,12 @@ class views_plugin_style_jump_menu extends views_plugin_style {
       '#description' => t('The text that will appear as the selected option in the jump menu.'),
     );
 
+    $form['inline'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Set this field to display inline'),
+      '#default_value' => !empty($this->options['inline']),
+    );
+
     $form['default_value'] = array(
       '#type' => 'checkbox',
       '#title' => t('Select the current contextual filter value'),
@@ -145,6 +152,7 @@ class views_plugin_style_jump_menu extends views_plugin_style {
       'button' => $this->options['text'],
       'title' => $this->options['label'],
       'choose' => $this->options['choose'],
+      'inline' => $this->options['inline'],
       'default_value' => $default_value,
     );
 
diff --git a/profiles/commons/modules/contrib/views/plugins/views_plugin_style_summary_jump_menu.inc b/profiles/commons/modules/contrib/views/plugins/views_plugin_style_summary_jump_menu.inc
index d5100df..a16a84b 100644
--- a/profiles/commons/modules/contrib/views/plugins/views_plugin_style_summary_jump_menu.inc
+++ b/profiles/commons/modules/contrib/views/plugins/views_plugin_style_summary_jump_menu.inc
@@ -20,6 +20,7 @@ class views_plugin_style_summary_jump_menu extends views_plugin_style {
     $options['text'] = array('default' => 'Go', 'translatable' => TRUE);
     $options['label'] = array('default' => '', 'translatable' => TRUE);
     $options['choose'] = array('default' => '- Choose -', 'translatable' => TRUE);
+    $options['inline'] = array('default' => TRUE, 'bool' => TRUE);
     $options['default_value'] = array('default' => FALSE, 'bool' => TRUE);
 
     return $options;
@@ -78,6 +79,12 @@ class views_plugin_style_summary_jump_menu extends views_plugin_style {
       '#description' => t('The text that will appear as the selected option in the jump menu.'),
     );
 
+    $form['inline'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Set this field to display inline'),
+      '#default_value' => !empty($this->options['inline']),
+    );
+
     $form['default_value'] = array(
       '#type' => 'checkbox',
       '#title' => t('Select the current contextual filter value'),
@@ -129,6 +136,7 @@ class views_plugin_style_summary_jump_menu extends views_plugin_style {
       'button' => $this->options['text'],
       'title' => $this->options['label'],
       'choose' => $this->options['choose'],
+      'inline' => $this->options['inline'],
       'default_value' => $default_value,
     );
 
diff --git a/profiles/commons/modules/contrib/views/tests/handlers/views_handler_field_boolean.test b/profiles/commons/modules/contrib/views/tests/handlers/views_handler_field_boolean.test
index 92ec7a5..286b942 100644
--- a/profiles/commons/modules/contrib/views/tests/handlers/views_handler_field_boolean.test
+++ b/profiles/commons/modules/contrib/views/tests/handlers/views_handler_field_boolean.test
@@ -66,11 +66,43 @@ class ViewsHandlerFieldBooleanTest extends ViewsSqlTest {
     $this->assertEqual('', $view->field['age']->advanced_render($view->result[0]));
     $this->assertEqual('', $view->field['age']->advanced_render($view->result[1]));
 
-    // Set a custom output format.
+    // Set a custom output format programmatically.
     $view->field['age']->formats['test'] = array(t('Test-True'), t('Test-False'));
     $view->field['age']->options['type'] = 'test';
     $this->assertEqual(t('Test-False'), $view->field['age']->advanced_render($view->result[0]));
     $this->assertEqual(t('Test-True'), $view->field['age']->advanced_render($view->result[1]));
 
+    // Set a custom output format through the UI using plain-text inputs.
+    $view->field['age']->options['type'] = 'custom';
+    $values = array(
+      'false' => 'Nay',
+      'true' => 'Yay',
+    );
+    $view->field['age']->options['type_custom_false'] = $values['false'];
+    $view->field['age']->options['type_custom_true'] = $values['true'];
+    $this->assertEqual($values['false'], $view->field['age']->advanced_render($view->result[0]));
+    $this->assertEqual($values['true'], $view->field['age']->advanced_render($view->result[1]));
+
+    // Set a custom output format through the UI using valid HTML inputs.
+    $view->field['age']->options['type'] = 'custom';
+    $values = array(
+      'false' => '<div class="bar">Nay</div>',
+      'true' => '<div class="foo">Yay</div>',
+    );
+    $view->field['age']->options['type_custom_false'] = $values['false'];
+    $view->field['age']->options['type_custom_true'] = $values['true'];
+    $this->assertEqual($values['false'], $view->field['age']->advanced_render($view->result[0]));
+    $this->assertEqual($values['true'], $view->field['age']->advanced_render($view->result[1]));
+
+    // Set a custom output format through the UI using unsafe inputs.
+    $view->field['age']->options['type'] = 'custom';
+    $values = array(
+      'false' => '<script>alert("Nay");</script>',
+      'true' => '<script>alert("Yay");</script>',
+    );
+    $view->field['age']->options['type_custom_false'] = $values['false'];
+    $view->field['age']->options['type_custom_true'] = $values['true'];
+    $this->assertNotEqual($values['false'], $view->field['age']->advanced_render($view->result[0]));
+    $this->assertNotEqual($values['true'], $view->field['age']->advanced_render($view->result[1]));
   }
 }
diff --git a/profiles/commons/modules/contrib/views/tests/views_test.info b/profiles/commons/modules/contrib/views/tests/views_test.info
index 2b98e0a..444ccc9 100644
--- a/profiles/commons/modules/contrib/views/tests/views_test.info
+++ b/profiles/commons/modules/contrib/views/tests/views_test.info
@@ -5,9 +5,9 @@ core = 7.x
 dependencies[] = views
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.x-3.5+42-dev"
+; Information added by drupal.org packaging script on 2013-03-20
+version = "7.x-3.6"
 core = "7.x"
 project = "views"
-datestamp = "1361328740"
+datestamp = "1363810217"
 
diff --git a/profiles/commons/modules/contrib/views/views.info b/profiles/commons/modules/contrib/views/views.info
index 5df22b5..ceb1aee 100644
--- a/profiles/commons/modules/contrib/views/views.info
+++ b/profiles/commons/modules/contrib/views/views.info
@@ -312,9 +312,9 @@ files[] = tests/views_cache.test
 files[] = tests/views_view.test
 files[] = tests/views_ui.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.x-3.5+42-dev"
+; Information added by drupal.org packaging script on 2013-03-20
+version = "7.x-3.6"
 core = "7.x"
 project = "views"
-datestamp = "1361328740"
+datestamp = "1363810217"
 
diff --git a/profiles/commons/modules/contrib/views/views_ui.info b/profiles/commons/modules/contrib/views/views_ui.info
index 7a08408..b746aa4 100644
--- a/profiles/commons/modules/contrib/views/views_ui.info
+++ b/profiles/commons/modules/contrib/views/views_ui.info
@@ -7,9 +7,9 @@ dependencies[] = views
 files[] = views_ui.module
 files[] = plugins/views_wizard/views_ui_base_views_wizard.class.php
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.x-3.5+42-dev"
+; Information added by drupal.org packaging script on 2013-03-20
+version = "7.x-3.6"
 core = "7.x"
 project = "views"
-datestamp = "1361328740"
+datestamp = "1363810217"
 
diff --git a/profiles/commons/modules/contrib/views/views_ui.module b/profiles/commons/modules/contrib/views/views_ui.module
index 8182714..5366f77 100644
--- a/profiles/commons/modules/contrib/views/views_ui.module
+++ b/profiles/commons/modules/contrib/views/views_ui.module
@@ -845,7 +845,8 @@ function _views_ui_get_displays_list($view) {
 
 function views_ui_library_alter(&$libraries, $module) {
   if ($module == 'system' && isset($libraries['ui.dialog'])) {
-    if (version_compare($libraries['ui.dialog']['version'], '1.7.2', '>=')) {
+    // Only apply the fix, if we don't have an up to date jQueryUI version.
+    if (version_compare($libraries['ui.dialog']['version'], '1.7.2', '>=') && version_compare($libraries['ui.dialog']['version'], '1.10.0', '<')) {
       $libraries['ui.dialog']['js'][drupal_get_path('module', 'views') . '/js/jquery.ui.dialog.patch.js'] = array();
     }
   }
diff --git a/profiles/commons/modules/contrib/votingapi/views/votingapi.views.inc b/profiles/commons/modules/contrib/votingapi/views/votingapi.views.inc
index 859e018..c9add95 100644
--- a/profiles/commons/modules/contrib/votingapi/views/votingapi.views.inc
+++ b/profiles/commons/modules/contrib/votingapi/views/votingapi.views.inc
@@ -13,7 +13,7 @@
 
 
 /**
- * Implementation of hook_views_handlers().
+ * Implements of hook_views_handlers().
  */
 function votingapi_views_handlers() {
   return array(
@@ -36,7 +36,7 @@ function votingapi_views_handlers() {
 
 
 /**
- * Implementation of hook_views_data().
+ * Implements of hook_views_data().
  */
 function votingapi_views_data() {
   // Basic table information.
@@ -273,30 +273,24 @@ function votingapi_views_data_alter(&$views_data) {
   // Add relationship handlers for both tables, for any base tables currently
   // available to Views.
 
-  $default_relationships = module_invoke_all('votingapi_relationships');
-
-  $default_relationships[] = array(
-    'description' => t('nodes'),
-    'entity_type' => 'node',
-    'base_table' => 'node',
-    'entity_id_column' => 'nid',
-    'pseudo_vote' => 'votingapi_vote',    // for legacy compatability w/RC1.
-    'pseudo_cache' => 'votingapi_cache',  // for legacy compatability w/RC1.
-  );
-  $default_relationships[] = array(
-    'description' => t('comments'),
-    'entity_type' => 'comment',
-    'base_table' => 'comment',
-    'entity_id_column' => 'cid',
-    'pseudo_vote' => 'votingapi_vote',    // for legacy compatability w/RC1.
-    'pseudo_cache' => 'votingapi_cache',  // for legacy compatability w/RC1.
-  );
+  //Get all entity types in the system and register as relationship.
+  $entity_types = entity_get_info();
+  foreach($entity_types as $key => $entity_type) {
+    $default_relationships[] = array(
+      'description' => $entity_type['label'],
+      'entity_type' => $key,
+      'base_table' => $entity_type['base table'],
+      'entity_id_column' => $entity_type['entity keys']['id'],
+      'pseudo_vote' => 'votingapi_vote',    // for legacy compatability w/RC1.
+      'pseudo_cache' => 'votingapi_cache',  // for legacy compatability w/RC1.
+    );
+  }
 
   foreach ($default_relationships as $data) {
-    $pseudo = str_replace(array(' ','-','.'), '_', $data['entity_type'] . '_' . $data['entity_id_column']);
-    $pseudo_vote = empty($data['pseudo_vote']) ? 'vapi_'. $pseudo : $data['pseudo_vote'];
-    $pseudo_cache = empty($data['pseudo_cache']) ? 'vapic_'. $pseudo : $data['pseudo_cache'];
-    
+    $pseudo = str_replace(array(' ', '-', '.'), '_', $data['entity_type'] . '_' . $data['entity_id_column']);
+    $pseudo_vote = empty($data['pseudo_vote']) ? 'vapi_' . $pseudo : $data['pseudo_vote'];
+    $pseudo_cache = empty($data['pseudo_cache']) ? 'vapic_' . $pseudo : $data['pseudo_cache'];
+
     $views_data[$data['base_table']][$pseudo_vote]['relationship'] = array(
       'title' => 'Votes',
       'help' => 'Votes cast by users on ' . $data['description'] . '.',
@@ -333,12 +327,12 @@ function votingapi_views_data_alter(&$views_data) {
 
 
 function _votingapi_views_sql_safe_entity_type($string) {
-  return str_replace(array(' ','-','.'), '_', $string);
+  return str_replace(array(' ', '-', '.'), '_', $string);
 }
 
 
 /**
- * Implementation of hook_views_analyze().
+ * Implements of hook_views_analyze().
  *
  * Warns admins if a VotingAPI relationship has been defined, but filters on the
  * relationship haven't been set.
diff --git a/profiles/commons/modules/contrib/votingapi/views/votingapi.views_default.inc b/profiles/commons/modules/contrib/votingapi/views/votingapi.views_default.inc
index a2bc296..172f87e 100644
--- a/profiles/commons/modules/contrib/votingapi/views/votingapi.views_default.inc
+++ b/profiles/commons/modules/contrib/votingapi/views/votingapi.views_default.inc
@@ -7,7 +7,7 @@
 
 function votingapi_views_default_views() {
   $views = array();
-    
+
   $view = new view;
   $view->name = 'top_content';
   $view->description = 'Top rated content';
diff --git a/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_field_value.inc b/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_field_value.inc
index 62d1cea..0296ff9 100644
--- a/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_field_value.inc
+++ b/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_field_value.inc
@@ -45,7 +45,7 @@ class votingapi_views_handler_field_value extends views_handler_field_numeric {
   function click_sort($order) {
     $this->query->add_orderby(NULL, "COALESCE($this->table_alias.$this->field, 0)", $order, $this->table_alias . '_' . $this->field . '_coalesced');
   }
-  
+
   function render($values) {
     $value = $values->{$this->field_alias};
     $function = $this->options['appearance'];
diff --git a/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_relationship.inc b/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_relationship.inc
index 29af5aa..af189f6 100644
--- a/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_relationship.inc
+++ b/profiles/commons/modules/contrib/votingapi/views/votingapi_views_handler_relationship.inc
@@ -53,7 +53,7 @@ class votingapi_views_handler_relationship extends views_handler_relationship {
     $options['value_types'][''] = t('No filtering');
     $options['tags'][''] = t('No filtering');
     $options['functions'][''] = t('No filtering');
-    foreach(votingapi_metadata() as $bin => $bin_data) {
+    foreach (votingapi_metadata() as $bin => $bin_data) {
       foreach ($bin_data as $key => $data) {
         $options[$bin][$key] = $data['name'];
       }
@@ -131,7 +131,7 @@ class votingapi_views_handler_relationship extends views_handler_relationship {
             'value' => $value,
             'numeric' => FALSE
           );
-          $alias .= '_'. str_replace(array(' ','-','.'), '_', $value);
+          $alias .= '_' . str_replace(array(' ', '-', '.'), '_', $value);
         }
       }
     }
diff --git a/profiles/commons/modules/contrib/votingapi/votingapi.admin.inc b/profiles/commons/modules/contrib/votingapi/votingapi.admin.inc
index 5aa6d41..7cae7d7 100644
--- a/profiles/commons/modules/contrib/votingapi/votingapi.admin.inc
+++ b/profiles/commons/modules/contrib/votingapi/votingapi.admin.inc
@@ -19,6 +19,14 @@ function votingapi_settings_form($form_state) {
     '#options' => $period
   );
 
+  $form['votingapi_user_window'] = array(
+    '#type' => 'select',
+    '#title' => t('Registered user vote rollover'),
+    '#description' => t('The amount of time that must pass before two registered user votes from the same user ID are considered unique. Setting this to \'never\' will eliminate most double-voting for registered users.'),
+    '#default_value' => variable_get('votingapi_user_window', -1),
+    '#options' => $period
+  );
+
   $form['votingapi_calculation_schedule'] = array(
     '#type' => 'radios',
     '#title' => t('Vote tallying'),
diff --git a/profiles/commons/modules/contrib/votingapi/votingapi.drush.inc b/profiles/commons/modules/contrib/votingapi/votingapi.drush.inc
index 85a6066..800fa98 100644
--- a/profiles/commons/modules/contrib/votingapi/votingapi.drush.inc
+++ b/profiles/commons/modules/contrib/votingapi/votingapi.drush.inc
@@ -7,7 +7,7 @@
  */
 
 /**
- * Implementation of hook_drush_help().
+ * Implements of hook_drush_help().
  */
 function votingapi_drush_help($section) {
   switch ($section) {
@@ -21,7 +21,7 @@ function votingapi_drush_help($section) {
 }
 
 /**
- * Implementation of hook_drush_command().
+ * Implements of hook_drush_command().
  */
 function votingapi_drush_command() {
   $items['generate-votes'] = array(
@@ -80,7 +80,7 @@ function votingapi_generate_votes($entity_type = 'node', $vote_type = 'percent',
   module_load_include('inc', 'devel_generate');
   $options += array(
     'age' => 36000,
-    'types' => $roles = drush_get_option('types') ? explode(',', drush_get_option('types')) : array(),
+    'types' => array(),
     'kill' => FALSE,
   );
 
@@ -100,7 +100,7 @@ function votingapi_generate_votes($entity_type = 'node', $vote_type = 'percent',
 
   $query = db_select($entity_type, 'e')->fields('e', array($entity_id_column));
   if ($entity_type == 'node' && !empty($options['types'])) {
-    $query->condition('e.type', $node_types, 'IN');
+    $query->condition('e.type', $options['types'], 'IN');
   }
   $results = $query->execute()->fetchAll(PDO::FETCH_ASSOC);
 
@@ -126,7 +126,7 @@ function _votingapi_cast_votes($etype, $eid, $timestamp = 0, $uids = array(), $s
           'entity_type' => $etype,
           'entity_id' => $eid,
           'value_type' => 'percent',
-          'timestamp' => REQUEST_TIME - rand(0, REQUEST_TIME - $timestamp),
+          'timestamp' => REQUEST_TIME - mt_rand(0, $timestamp),
           'value' => mt_rand(1, 5) * 20,
           'tag' => $tags[mt_rand(0, 30)],
         );
@@ -138,7 +138,7 @@ function _votingapi_cast_votes($etype, $eid, $timestamp = 0, $uids = array(), $s
             'entity_type' => $etype,
             'entity_id' => $eid,
             'value_type' => 'points',
-            'timestamp' => REQUEST_TIME - rand(0, REQUEST_TIME - $timestamp),
+            'timestamp' => REQUEST_TIME - mt_rand(0, $timestamp),
             'value' => rand(0, 1) ? 1 : -1,
           );
         }
diff --git a/profiles/commons/modules/contrib/votingapi/votingapi.info b/profiles/commons/modules/contrib/votingapi/votingapi.info
index 7cbf10a..b375f56 100644
--- a/profiles/commons/modules/contrib/votingapi/votingapi.info
+++ b/profiles/commons/modules/contrib/votingapi/votingapi.info
@@ -4,22 +4,15 @@ package = Voting
 core = 7.x
 configure = admin/config/search/votingapi
 
-files[] = votingapi.module
-files[] = votingapi.admin.inc
-files[] = votingapi.drush.inc
-files[] = votingapi.install
-
 files[] = tests/votingapi.test
 
-files[] = views/votingapi.views.inc
-files[] = views/votingapi.views_default.inc
 files[] = views/votingapi_views_handler_field_value.inc
 files[] = views/votingapi_views_handler_sort_nullable.inc
 files[] = views/votingapi_views_handler_relationship.inc
 
-; Information added by drupal.org packaging script on 2012-11-07
-version = "7.x-2.10"
+; Information added by drupal.org packaging script on 2013-03-22
+version = "7.x-2.11"
 core = "7.x"
 project = "votingapi"
-datestamp = "1352273826"
+datestamp = "1363989617"
 
diff --git a/profiles/commons/modules/contrib/votingapi/votingapi.install b/profiles/commons/modules/contrib/votingapi/votingapi.install
index 7a01065..9407e2a 100644
--- a/profiles/commons/modules/contrib/votingapi/votingapi.install
+++ b/profiles/commons/modules/contrib/votingapi/votingapi.install
@@ -99,11 +99,42 @@ function votingapi_update_7202() {
  * Reduces confusion about 'content types' versus 'node types'.
  */
 function votingapi_update_7201() {
-  db_change_field('votingapi_vote', 'content_type', 'entity_type', array('type' => 'varchar', 'length' => 64));
-  db_change_field('votingapi_vote', 'content_id', 'entity_id', array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE, 'default' => 0));
+  $index['votingapi_vote'] = array(
+    'content_uid'       => array('entity_type', 'entity_id', 'uid'),
+    'content_uid_2'     => array('entity_type', 'uid'),
+    'content_source'    => array('entity_type', 'entity_id', 'vote_source'),
+    'content_value_tag' => array('entity_type', 'entity_id', 'value_type', 'tag'),
+  );
+  $index['votingapi_cache'] = array(
+    'content'                => array('entity_type', 'entity_id'),
+    'content_function'       => array('entity_type', 'entity_id', 'function'),
+    'content_tag_func'       => array('entity_type', 'entity_id', 'tag', 'function'),
+    'content_vtype_tag'      => array('entity_type', 'entity_id', 'value_type', 'tag'),
+    'content_vtype_tag_func' => array('entity_type', 'entity_id', 'value_type', 'tag', 'function'),
+  );
+  // Remove all existing indexes.
+  foreach ($index as $table => $data) {
+    foreach ($data as $index_name => $columns) {
+      if (db_index_exists($table, $index_name)) {
+        db_drop_index($table, $index_name);
+      }
+    }
+  }
 
-  db_change_field('votingapi_cache', 'content_type', 'entity_type', array('type' => 'varchar', 'length' => 64));
-  db_change_field('votingapi_cache', 'content_id', 'entity_id', array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE, 'default' => 0));
+  // Change fields
+  foreach (array('votingapi_vote', 'votingapi_cache') as $table) {
+    db_change_field($table, 'content_type', 'entity_type', array('type' => 'varchar', 'length' => 64, 'not null' => TRUE, 'default' => 'node'));
+    db_change_field($table, 'content_id', 'entity_id', array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE, 'default' => 0));
+    db_change_field($table, 'value_type', 'value_type', array('type' => 'varchar', 'length' => 64, 'not null' => TRUE, 'default' => 'percent'));
+    db_change_field($table, 'tag', 'tag', array('type' => 'varchar', 'length' => 64, 'not null' => TRUE, 'default' => 'vote'));
+  }
+
+  // Recreate the indexes.
+  foreach ($index as $table => $data) {
+    foreach ($data as $index_name => $columns) {
+      db_add_index($table, $index_name, $columns);
+    }
+  }
 
   return t('Updated VotingAPI table structure.');
 }
@@ -117,6 +148,7 @@ function votingapi_uninstall() {
   $variables = array(
     'votingapi_last_cron',
     'votingapi_anonymous_window',
+    'votingapi_user_window',
     'votingapi_calculation_schedule',
   );
   foreach ($variables as $variable) {
diff --git a/profiles/commons/modules/contrib/votingapi/votingapi.module b/profiles/commons/modules/contrib/votingapi/votingapi.module
index 40204ff..e0c5125 100644
--- a/profiles/commons/modules/contrib/votingapi/votingapi.module
+++ b/profiles/commons/modules/contrib/votingapi/votingapi.module
@@ -11,7 +11,7 @@
  */
 
 /**
- * Implementation of hook_menu().
+ * Implements of hook_menu().
  */
 function votingapi_menu() {
   $items = array();
@@ -52,7 +52,7 @@ function votingapi_permission() {
 }
 
 /**
- * Implementation of hook_views_api().
+ * Implements of hook_views_api().
  */
 function votingapi_views_api() {
   return array(
@@ -62,7 +62,7 @@ function votingapi_views_api() {
 }
 
 /**
- * Implementation of hook_cron().
+ * Implements of hook_cron().
  *
  * Allows db-intensive recalculations to be deferred until cron-time.
  */
@@ -136,8 +136,7 @@ function votingapi_set_votes(&$votes, $criteria = NULL) {
     // If the calling function didn't explicitly set criteria for vote deletion,
     // build up the delete queries here.
     foreach ($votes as $vote) {
-      $tmp = votingapi_current_user_identifier();
-      $tmp += $vote;
+      $tmp = $vote + votingapi_current_user_identifier();
       if (isset($tmp['value'])) {
         unset($tmp['value']);
       }
@@ -190,21 +189,21 @@ function votingapi_current_user_identifier() {
 }
 
 /**
- * Implementation of hook_votingapi_storage_add_vote().
+ * Implements of hook_votingapi_storage_add_vote().
  */
 function votingapi_votingapi_storage_add_vote(&$vote) {
   drupal_write_record('votingapi_vote', $vote);
 }
 
 /**
- * Implementation of hook_votingapi_storage_delete_votes().
+ * Implements of hook_votingapi_storage_delete_votes().
  */
 function votingapi_votingapi_storage_delete_votes($votes, $vids) {
   db_delete('votingapi_vote')->condition('vote_id', $vids, 'IN')->execute();
 }
 
 /**
- * Implementation of hook_votingapi_storage_select_votes().
+ * Implements of hook_votingapi_storage_select_votes().
  */
 function votingapi_votingapi_storage_select_votes($criteria, $limit) {
   $query = db_select('votingapi_vote')->fields('votingapi_vote');
@@ -349,9 +348,16 @@ function votingapi_delete_results($vote_results = array()) {
  *   An array of votes matching the criteria.
  */
 function votingapi_select_votes($criteria = array(), $limit = 0) {
-  $anon_window = variable_get('votingapi_anonymous_window', 86400);
-  if (!empty($criteria['vote_source']) && $anon_window >= 0) {
-    $criteria['timestamp'] = REQUEST_TIME - $anon_window;
+  $window = -1;
+  if (empty($criteria['uid']) || $criteria['uid'] == 0) {
+    if (!empty($criteria['vote_source'])) {
+      $window = variable_get('votingapi_anonymous_window', 86400);
+    }
+  } else {
+    $window = variable_get('votingapi_user_window', -1);
+  }
+  if ($window >= 0) {
+    $criteria['timestamp'] = REQUEST_TIME - $window;
   }
   $function = variable_get('votingapi_storage_module', 'votingapi') . '_votingapi_storage_select_votes';
   return $function($criteria, $limit);
@@ -552,7 +558,7 @@ function votingapi_votingapi_storage_standard_results($entity_type, $entity_id)
  */
 function votingapi_select_single_vote_value($criteria = array()) {
   if ($results = votingapi_select_votes($criteria, 1)) {
-     return $results[0]['value'];
+    return $results[0]['value'];
   }
 }
 
@@ -561,7 +567,7 @@ function votingapi_select_single_vote_value($criteria = array()) {
  */
 function votingapi_select_single_result_value($criteria = array()) {
   if ($results = votingapi_select_results($criteria, 1)) {
-     return $results[0]['value'];
+    return $results[0]['value'];
   }
 }
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
old mode 100644
new mode 100755
index 8026282..2a533b6
--- a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
@@ -348,9 +348,10 @@
   ; Custom CSS
   settings[custom_css] = ''
 
-; Information added by drupal.org packaging script on 2013-02-24
+
+; Information added by drush on 2013-03-28
 version = "7.x-3.1+55-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1361666049"
+datestamp = "1364431817"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
old mode 100644
new mode 100755
index 3ac85b0..f10a092
--- a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
@@ -374,9 +374,10 @@
 ;----------// Custom CSS
   settings[custom_css] = ''
 
-; Information added by drupal.org packaging script on 2013-02-24
+
+; Information added by drush on 2013-03-28
 version = "7.x-3.1+55-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1361666049"
+datestamp = "1364431817"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
old mode 100644
new mode 100755
index 5394959..8b4f7a3
--- a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
@@ -453,9 +453,10 @@
   ; Custom CSS
   settings[custom_css] = ''
 
-; Information added by drupal.org packaging script on 2013-02-24
+
+; Information added by drush on 2013-03-28
 version = "7.x-3.1+55-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1361666049"
+datestamp = "1364431817"
 
diff --git a/profiles/minimal/minimal.info b/profiles/minimal/minimal.info
index 0153599..01a4558 100644
--- a/profiles/minimal/minimal.info
+++ b/profiles/minimal/minimal.info
@@ -6,8 +6,8 @@ hidden = TRUE
 dependencies[] = block
 dependencies[] = dblog
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/profiles/standard/standard.info b/profiles/standard/standard.info
index ddd0a56..254f475 100644
--- a/profiles/standard/standard.info
+++ b/profiles/standard/standard.info
@@ -25,8 +25,8 @@ dependencies[] = field_ui
 dependencies[] = file
 dependencies[] = rdf
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index 2703107..55bd3ff 100644
--- a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 files[] = drupal_system_listing_compatible_test.test
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index 3fb12b5..81fb29a 100644
--- a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -8,8 +8,8 @@ version = VERSION
 core = 6.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/profiles/testing/testing.info b/profiles/testing/testing.info
index 77ac5ef..76b7e8a 100644
--- a/profiles/testing/testing.info
+++ b/profiles/testing/testing.info
@@ -4,8 +4,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/themes/bartik/bartik.info b/themes/bartik/bartik.info
index bf0d33d..0e0c6d8 100644
--- a/themes/bartik/bartik.info
+++ b/themes/bartik/bartik.info
@@ -34,8 +34,8 @@ regions[footer] = Footer
 settings[shortcut_module_link] = 0
 
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/themes/garland/garland.info b/themes/garland/garland.info
index 38dad5a..adc546f 100644
--- a/themes/garland/garland.info
+++ b/themes/garland/garland.info
@@ -7,8 +7,8 @@ stylesheets[all][] = style.css
 stylesheets[print][] = print.css
 settings[garland_width] = fluid
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/themes/seven/seven.info b/themes/seven/seven.info
index 99194dd..76e4a19 100644
--- a/themes/seven/seven.info
+++ b/themes/seven/seven.info
@@ -13,8 +13,8 @@ regions[page_bottom] = Page bottom
 regions[sidebar_first] = First sidebar
 regions_hidden[] = sidebar_first
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
diff --git a/themes/stark/stark.info b/themes/stark/stark.info
index 2402152..3ad46b8 100644
--- a/themes/stark/stark.info
+++ b/themes/stark/stark.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 stylesheets[all][] = layout.css
 
-; Information added by drupal.org packaging script on 2013-02-20
-version = "7.20"
+; Information added by drupal.org packaging script on 2013-03-07
+version = "7.21"
 project = "drupal"
-datestamp = "1361393684"
+datestamp = "1362616996"
 
